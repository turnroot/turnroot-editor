(()=>{"use strict";var e,t,i,s,l={402:(e,t,i)=>{i.d(t,{A:()=>s});const s=new(i(675).Yw)({name:"EditorWindow",panels:[{type:"top",size:30,resizable:!1,content:"top",html:'<div style="padding: 10px;">Top</div>'},{type:"main",content:"main",html:'<div style="padding: 10px;">Main</div>'},{type:"bottom",size:30,resizable:!1,content:"bottom",html:'<div style="padding: 10px;">Bottom</div>'},{type:"left",size:200,resizable:!0,content:"left",html:'<div style="padding: 10px;">Left</div>'},{type:"right",size:200,resizable:!0,content:"right",html:'<div style="padding: 10px;">Right</div>'},{type:"preview",size:200,resizable:!0,content:"preview",html:'<div style="padding: 10px;">Preview</div>'}]})},688:(e,t,i)=>{i.d(t,{A:()=>ci});var s=i(675);let l=[{field:"hp",type:"int",html:{label:"HP",attr:"",column:1}},{field:"str",type:"int",html:{label:"Strength",attr:"",column:1}},{field:"mag",type:"int",html:{label:"Magic",attr:"",column:1}},{field:"skl",type:"int",html:{label:"Skill",attr:"",column:1}},{field:"spd",type:"int",html:{label:"Speed",attr:"",column:1}},{field:"def",type:"int",html:{label:"Defense",attr:"",column:1}},{field:"res",type:"int",html:{label:"Resistance",attr:"",column:1}},{field:"mov",type:"int",html:{label:"Movement",attr:"",column:1}}];window.statsUseExtraStatWeight&&(l.push({field:"weight",type:"int",html:{label:"Weight",attr:"",column:1}}),l.push({field:"con",type:"int",html:{label:"Constitution",attr:"",column:1}})),window.statsUseExtraStatCharm&&l.push({field:"cha",type:"int",html:{label:"Charisma",attr:"",column:1}}),window.statsUseExtraStatLuck&&l.push({field:"lck",type:"int",html:{label:"Luck",attr:"",column:1}}),window.statsUseExtraStatAuthority&&l.push({field:"authority",type:"int",html:{label:"Authority",attr:"",column:1}}),window.turnrootEditorLogs.push(`${new Date}||info||Global stats loaded`);const o=l;let n=[];o.forEach((e=>{n.push(e.field)}));let a=0;const r={Avatar:{show:["orientation","canSSupport","canHaveChildren","height","birthdayDay","birthdayMonth","age","useAccentColors","growth-rates","base-stats-header"],hide:["canRecruit","isUnique","randomize-base-stats"],disable:["canSSupport"],enable:[],toolbarShow:["unit-editor-bottom-toolbar-relationship"]},NPC:{hide:["orientation","canSSupport","canHaveChildren","canRecruit","growth-rates","accentColor1","accentColor2","base-stats-header","randomize-base-stats","useAccentColors","height","birthdayDay","birthdayMonth","age"],show:["isUnique"],enable:[],disable:[],toolbarShow:[]},Friend:{show:["orientation","canSSupport","canHaveChildren","canRecruit","growth-rates","useAccentColors","base-stats-header","height","birthdayDay","birthdayMonth","randomize-base-stats","age","isUnique"],enable:["canSSupport"],hide:[],disable:[],toolbarShow:["unit-editor-bottom-toolbar-relationship","unit-editor-bottom-toolbar-behavior"]},Enemy:{hide:["canSSupport","orientation","canHaveChildren","growth-rates","height","birthdayDay","birthdayMonth","age"],enable:[],disable:[],show:["canRecruit","useAccentColors","randomize-base-stats","isUnique"],toolbarShow:["unit-editor-bottom-toolbar-behavior"]}};function d(e,t){["show","hide","enable","disable"].forEach((i=>{(t[i]||[]).forEach((t=>e[i](t)))})),o.forEach(((i,s)=>{e[t.hide.includes(i.field)?"hide":"show"](i.field)}));let i=s.GB["unit-editor-bottom-toolbar"];i.hide("unit-editor-bottom-toolbar-relationship"),i.hide("unit-editor-bottom-toolbar-behavior"),i.show("unit-editor-bottom-toolbar-basic"),t.toolbarShow.forEach((e=>i.show(e))),i.refresh()}const h=(e,t,i=!1)=>{let l=t.detail.field,o=t.detail.value;if(window.allUnits&&window.allUnits.forEach((e=>{"avatar"===e.which&&a++})),"name"===l){if(0===o.current.length)return o.current=o.previous,window.unitEditorBasicFields.record.name=o.previous,window.unitEditorBasicFields.refresh(),(0,s.mJ)("Name cannot be empty");window.UnitEditorLeftSidebar&&window.UnitEditorLeftSidebar.nodes.forEach((t=>{t.id===e.record.id&&(t.text=o.current+" "+e.record.id),window.UnitEditorLeftSidebar.refresh()}))}else if("useAccentColors"===l)!0===o.current?(e.show("accentColor1"),e.show("accentColor2")):(e.hide("accentColor1"),e.hide("accentColor2"));else if(n.includes(l)&&"mov"!==l){let t=s.GB["unit-editor-basic-fields"].get("base-stats-balance").el,i=0;n.forEach((t=>{i+=e.getValue(t)}));let l=function(e,t,i,s,l){return 180*(e-t)/(i-t)+0}(i,5.8*n.length,9.1*n.length)-90;t.querySelector(".balanceMeterNeedle").style.transform=`rotate(${l}deg)`,t.querySelector(".balanceMeterNeedle").style.opacity="1"}else if("canRecruit"===l)!0===o.current&&!1===e.get("isUnique").el.checked&&(e.setValue("isUnique",!0),e.record.isUnique=!0,(0,s.mJ)('A recruitable unit must be unique. The "isUnique" checkbox has been checked.'),e.show("randomize-base-stats"));else if("isUnique"===l&&!1===o.current&&!0===e.get("canRecruit").el.checked)!0===e.get("canRecruit").el.checked&&(e.setValue("canRecruit",!1),e.record.canRecruit=!1,(0,s.mJ)('A recruitable unit must be unique. The "canRecruit" checkbox has been unchecked.'),e.hide("randomize-base-stats"));else if("isUnique"===l)!0===o.current?e.hide("randomize-base-stats"):e.show("randomize-base-stats");else if("subtype"===l){if(e.lock("",!0),i)return d(e,r[o.current]),"Enemy"===o.current&&!0===e.record.canRecruit&&s.GB["unit-editor-bottom-toolbar"].show("unit-editor-bottom-toolbar-relationship"),void e.unlock();"Avatar"===o.current&&a>0?e.message({body:'<div class="w2ui-centered">You already have an Avatar unit. You cannot create another.</div>',width:400,height:200,actions:{OK(){e.setValue("subtype",o.previous),e.unlock(),e.message()}}}):e.message({body:'<div class="w2ui-centered">Do you want to change the subtype? This will significantly alter your unit.</div>',width:400,height:200,actions:{Yes(){"Avatar"===o.previous&&"Avatar"!==o.current&&a--,d(e,r[o.current]),e.unlock(),e.message()},No(){e.setValue("subtype",o.previous),e.record.subtype=o.previous,e.unlock(),e.message(),e.refresh()}}})}window.updateQueue("Person","updatePerson",e.record)};window.w2popup=s.yN;let c={},u={};const p=e=>{Object.keys(c).forEach((t=>{u[t]=0,e.record["baseStatsGrowthAmount"+t]=u[t]})),document.querySelectorAll(".baseStatGrowthNumberInput").forEach((e=>{e.value=0}))},m=(e,t,i)=>{u[e]=parseInt(t),i.record["baseStatsGrowthAmount"+e]=u[e]},g=(e,t)=>{c={...e},Object.keys(e).forEach((e=>{u[e]="hp"===e?100:0,t.record["baseStatsGrowthAmount"+e]=u[e]})),window.UnitEditorBaseStatGrowthChange=m,window.UnitEditorBaseStatGrowthReset=p,window.UnitEditorBaseStatGrowthPopup=g;let i=`\n    <h2>Set Stat Growths</h2>\n    <p>Set the growths for each stat. Each growth is the % chance that the stat will increase on level up- for example, a growth of 50 on a base stat Strength would mean a 50% chance that Strength will increase on level up.</p>\n    <table>\n        <tr>\n            <th>Stat</th>\n            <th>Original</th>\n            <th>Growth</th>\n        </tr>\n        ${Object.keys(e).map((t=>`\n            <tr>\n                <td>${t}</td>\n                <td>${e[t]}</td>\n                <td><input type="number" class="w2ui-input baseStatGrowthNumberInput" min="0" max="100" value="${u[t]}" onchange="window.UnitEditorBaseStatGrowthChange('${t}', this.value, window.unitEditorBasicFields)"></td>\n            </tr>\n            `)).join("")}\n        </table>\n    `;s.yN.open({body:i,width:700,height:540,showMax:!1,showClose:!1,modal:!1,actions:["Ok","Reset"]}).ok((e=>{s.yN.close()})).reset((e=>{p(t)}))},f=g;window.w2popup=s.yN;let b={},y={};const v=e=>{Object.keys(b).forEach((t=>{y[t]=0,e.record["baseStatsRandomizedAmount"+t]=y[t]})),document.querySelectorAll(".baseStatRandomizerNumberInput").forEach((e=>{e.value=0}))};window.UnitEditorBaseStatRandomizerChangeVariance=(e,t,i)=>{y[e]=parseInt(t),i.record["baseStatsRandomizedAmount"+e]=y[e]},window.UnitEditorBaseStatRandomizerDisableStatRandomization=(e,t)=>{t.record["baseStatsRandomizedEnabled"+e]=!t.record["baseStatsRandomizedEnabled"+e]},window.UnitEditorBaseStatRandomizerResetVariances=v;let x=((e,t,i,s)=>{let l=document.createElement("div");l.innerHTML='\n<div class="balanceMeterCircle">\n<div class="balanceMeterNeedle"></div>\n</div>\n</div>\n</div>\n';let o=document.createElement("style");o.innerHTML="\n.balanceMeterCircle {\n    height: 90px;\n    width: 180px;\n    background-size: 100% 100%;\n    background-position: 0px 0px;\n    background-color: var(--slider-0);\n    border-radius: 999rem 999rem 0rem 0rem;\n    mask-image: radial-gradient(circle at 50% 100%, transparent 40%, black 40%);\n    position:relative;\n}\n.balanceMeterNeedle{\n    height:100%;\n    position:absolute;\n    width:6px;\n    background-color:var(--node-title);\n    z-index:1492;\n    left:calc(50% - 3px);\n    transform-origin:bottom;\n    transition:all .25s ease-out;\n}\n",l.appendChild(o),l.querySelector(".balanceMeterNeedle").style.transform="rotate(0deg)",l.querySelector(".balanceMeterNeedle").style.opacity="0";let n=document.createElement("h3");n.innerText="Edit base stats to see balance";let a=document.createElement("p");return a.style.maxWidth="40ch",n.style.maxWidth="40ch",a.innerHTML="<small>Compares your base stat total against two existing-game examples.<br/>The left side is a bit lower than the avatar's base stats in <em>Fire Emblem: Awakening</em>, and the right side is a bit higher than the avatar's base stats in <em>Fire Emblem: Three Houses</em>. Most units should probably fall somewhere in between.<br/><br/>Mov is not included in the total</small>",l.appendChild(n),l.appendChild(a),l})(0,o.length);window.UnitEditorGlobalStats=o,window.unitEditorHandleStatsGrowthPopup=(e,t)=>{let i={};e.forEach((e=>{i[e.field]=t.record[e.field]})),f(i,t)},window.handleBaseStatRandomizerPopup=(e,t)=>{let i={};e.forEach((e=>{i[e.field]=t.record[e.field]})),((e,t)=>{b={...e},Object.keys(e).forEach((e=>{y[e]=0,t.record["baseStatsRandomizedEnabled"+e]=!0,t.record["baseStatsRandomizedAmount"+e]=y[e]}));let i=`\n    <h2>Randomize Base Stats</h2>\n    <p>When a non-unique unit is spawned, set the random variance for the base stats. Each variance is the min/max the stat could be increased by- for example, a variance of 3 on a base stat HP at 25 would mean a random spawn could have between 22-28 HP.</p>\n    <table>\n        <tr>\n            <th>Stat</th>\n            <th>Original</th>\n            <th>Randomized</th>\n            <th>Enabled</th>\n        </tr>\n        ${Object.keys(e).map((t=>`\n            <tr>\n                <td>${t}</td>\n                <td>${e[t]}</td>\n                <td><input type="number" class="w2ui-input baseStatRandomizerNumberInput" min="0" max="${Math.floor(e[t]/2)}" value="${y[t]}" onchange="UnitEditorBaseStatRandomizerChangeVariance('${t}', this.value, window.unitEditorBasicFields)"></td>\n                <td><input type="checkbox" checked onchange="UnitEditorBaseStatRandomizerDisableStatRandomization('${t}', window.unitEditorBasicFields)"></td>\n            </tr>\n            `)).join("")}\n        </table>\n    `;s.yN.open({body:i,width:700,height:550,showMax:!1,showClose:!1,modal:!1,actions:["Ok","Reset"]}).ok((e=>{s.yN.close()})).reset((e=>{v(t)}))})(i,t)};let k={name:"unit-editor-basic-fields",record:{id:"",name:"New Unit",fullName:"New Unit",title:"",pronouns:"they/them/their/theirs",subtype:"Avatar",notes:"",age:18,canSSupport:!0,canHaveChildren:!0,height:168,birthdayDay:1,birthdayMonth:1,shortBio:"",useAccentColors:!1},fields:[{field:"",type:"html",html:{html:"<h2>Basic Info</h2>",column:0}},{field:"id",type:"text",html:{label:"ID",attr:"readonly",column:0},hidden:!0},{field:"name",type:"text",html:{label:"Familiar name",attr:"",column:0}},{field:"fullName",type:"text",html:{label:"Full name",attr:"",column:0}},{field:"title",type:"text",html:{label:"Title",attr:"",column:0}},{type:"html",html:{html:'<small>A unit can have a title, familiar name, and full name. A unit could have "sir" as the title, "Fernand" as the familiar name, and "Sir Fernand van Ageer" as the full name. <strong>Many units, like "Rogue" or "Thief", will only need a familiar name.</strong></small>'}},{field:"pronouns",type:"select",html:{label:"Pronouns",attr:"",column:0},options:{items:["he/him/his/his","she/her/her/hers","they/them/their/theirs"]}},{field:"subtype",type:"radio",html:{label:"Subtype",attr:'style="max-width:200px;"',column:0},options:{items:["Avatar","NPC","Friend","Enemy"]}},{field:"age",type:"int",options:{min:0},html:{label:"Age",column:0}},{field:"canSSupport",type:"checkbox",disabled:!1,html:{label:"Can S-Support",column:0}},{field:"canHaveChildren",type:"checkbox",html:{label:"Can have children",column:0}},{field:"isUnique",type:"checkbox",hidden:!0,html:{label:"Unique (only one of this unit can exist in the game)",column:0}},{field:"canRecruit",type:"checkbox",hidden:!0,html:{label:"Can be recruited to join player's team",column:0}},{field:"height",type:"int",options:{min:32,max:214},html:{label:"Height (cm)",column:0}},{field:"base-stats-header",type:"html",html:{class:"no-label",html:"<h2>Base Stats</h2>",column:1}},{field:"birthdayDay",type:"int",options:{min:1,max:31},html:{label:"Birthday Day",column:0}},{field:"birthdayMonth",type:"int",options:{min:1,max:12},html:{label:"Birthday Month",column:0}}]};o.forEach(((e,t)=>{"hp"===e.field?(k.fields.push({field:e.field,type:"int",options:{min:1,value:20},html:{label:e.html.label,attr:'style="width:2rem"',column:1}}),k.record[e.field]=20):(k.fields.push({field:e.field,type:"int",options:{min:0,value:5},html:{label:e.html.label,attr:'style="width:2rem"',column:1}}),k.record[e.field]=5)})),k.fields.push({type:"html",field:"base-stats-balance",html:{class:"no-label",html:x.innerHTML,column:1,attr:'style="width:100%;margin-top:.5rem"'}}),k.fields.push({type:"html",field:"growth-rates",class:"no-label",html:{class:"no-label",html:"<button id='growth-rates-button' onclick='window.unitEditorHandleStatsGrowthPopup(window.UnitEditorGlobalStats, window.unitEditorBasicFields)' class='w2ui-btn'>Growth Rates</button>",column:1,attr:'style="width:100%;margin-top:.5rem"'}}),k.fields.push({type:"html",field:"randomize-base-stats",class:"no-label",hidden:!0,html:{class:"no-label",html:"<button id='randomize-base-stats-button' onclick='window.handleBaseStatRandomizerPopup(window.UnitEditorGlobalStats, window.unitEditorBasicFields)' class='w2ui-btn'>Randomize Base Stats</button><br/><small>Non-unique units can have randomized base stats.</small>",column:1,attr:'style="width:100%;margin-top:.5rem"'}}),k.fields.push({type:"textarea",field:"notes",html:{label:"Notes",attr:"",column:2}}),k.fields.push({type:"text",field:"shortBio",html:{label:"Short Bio",attr:"",column:2}}),k.fields.push({type:"html",html:{html:"<em><small>Color class sprites with unique unit colors</small></em>",column:2,attr:'style="width:100%;margin-top:.5rem"'}}),k.fields.push({type:"checkbox",field:"useAccentColors",html:{label:"Use accent colors",attr:"",column:2}}),window.UpdateaccentColor1=e=>{window.unitEditorBasicFields.record.accentColor1=e.target.value;try{window.unitEditorBasicFields.get("accentColor1").el.querySelector("input").value=e.target.value}catch(e){console.log(e)}},window.UpdateaccentColor2=e=>{window.unitEditorBasicFields.record.accentColor2=e.target.value;try{window.unitEditorBasicFields.get("accentColor2").el.querySelector("input").value=e.target.value}catch(e){console.log(e)}},k.fields.push({type:"html",field:"accentColor1",hidden:!0,html:{label:"Accent color 1",attr:"",column:2,html:'<input type="color" onchange="window.UpdateaccentColor1(event)">'}}),k.fields.push({type:"html",field:"accentColor2",hidden:!0,html:{label:"Accent color 2",attr:"",column:2,html:'<input type="color" onchange="window.UpdateaccentColor2(event)">'}});let C=new s.sk(k);C.on("change",(e=>{h(C,e)})),C.on("refresh",(e=>{try{C.get("accentColor1").el.querySelector("input").value=C.record.accentColor1,C.get("accentColor2").el.querySelector("input").value=C.record.accentColor2}catch(e){console.log(e)}})),C.updateGlobals=()=>{window.unitsCanHaveChildren?C.fields.find((e=>"canHaveChildren"===e.field)).hidden=!1:C.fields.find((e=>"canHaveChildren"===e.field)).hidden=!0,C.refresh()},window.unitEditorBasicFields=C,C.updateGlobals();const _=C,E=(e,t)=>{let i=document.createElement("div");return e.forEach(((e,s)=>{let l=document.createElement("div");l.style.display="flex",l.style.gap="1rem";let o=document.createElement("h3");o.innerText=e.fieldLabel,l.appendChild(o);let n=document.createElement("div");n.className="w2ui-field",l.appendChild(n),e.fieldOptions.forEach(((i,s)=>{let l=document.createElement("label");l.className="w2ui-box-label",l.style.paddingLeft=".5rem",l.style.gap=".25rem";let o=document.createElement("input");o.type="radio",o.name=e.fieldLabel+t,o.id=i,o.setAttribute("data-value",i),o.setAttribute("data-index",s),o.style.maxWidth="12.5rem",l.appendChild(o),i===e.fieldValue&&(o.checked=!0,o.setAttribute("checked",""));let a=document.createElement("span");a.innerText=i,l.appendChild(a),n.appendChild(l)})),i.appendChild(l)})),i};let S=e=>e.charAt(0).toUpperCase()+e.slice(1);const T=async e=>{if(window.currentUnit=e,!window.currentUnit||void 0===window.currentUnit)return void console.log("no unit to update");console.log("updating current unit record ",e.id),e.useAccentColors&&(window.unitEditorBasicFields.show("accentColor1"),window.unitEditorBasicFields.show("accentColor2")),window.unitEditorBasicFields.record.fullName=e.fullName,window.unitEditorBasicFields.record.title=e.title,window.unitEditorBasicFields.record.name=e.name,window.unitEditorBasicFields.record.id=e.id,window.unitEditorBasicFields.record.subtype=S(e.which),h(window.unitEditorBasicFields,{detail:{field:"subtype",value:{current:S(e.which)}}},!0),window.unitEditorBasicFields.record.pronouns=e.pronouns.singular+"/"+e.pronouns.possessive+"/"+e.pronouns.object+"/"+e.pronouns.possessives,window.unitEditorBasicFields.record.age=e.age,window.unitEditorBasicFields.record.height=e.height,window.unitEditorBasicFields.record.canSSupport=e.canSSupport,window.unitEditorBasicFields.record.canHaveChildren=e.canHaveChildren,window.unitEditorBasicFields.record.isUnique=e.isUnique,window.unitEditorBasicFields.record.canRecruit=e.isRecruitable,window.unitEditorBasicFields.record.birthdayDay=e.birthdayDay,window.unitEditorBasicFields.record.birthdayMonth=e.birthdayMonth,window.unitEditorBasicFields.record.notes=e.Notes,window.unitEditorBasicFields.record.shortBio=e.shortDescription,window.unitEditorBasicFields.record.useAccentColors=e.useAccentColors,window.unitEditorBasicFields.record.accentColor1=e.accentColor1,window.unitEditorBasicFields.record.accentColor2=e.accentColor2,window.unitEditorBasicFields.refresh(),window.unitEditorRelationshipFields.record=e.MaxSupports?e.MaxSupports:{};let t=[],i=window.allUnits;if(i=i.filter((e=>e.id!==window.currentUnit.id&&!("enemy"===e.which&&!e.isRecruitable)&&"npc"!==e.which)),i.forEach((e=>{let i={};i.fieldLabel=e.name+" "+e.id,i.fieldOptions=e.canSSupport?["D","C","B","A","S"]:["D","C","B","A"],i.fieldValue="D",window.unitEditorRelationshipFields.record["max-Support-"+e.id]="D",t.push(i)})),0===t.length)window.unitEditorRelationshipFields.fields[2].html.html="<p>This unit cannot support any other units - make sure you've created other supportable units</p>",window.unitEditorRelationshipFields.fields[4].html.html="<p>This unit cannot support any other units - make sure you've created other supportable units</p>";else{let e=E(t,"Max-support").innerHTML;window.unitEditorRelationshipFields.fields[2].html.html=e,window.unitEditorRelationshipFields.fields[2].field="dynamicRadios-Max-support";let s=[];i.forEach((e=>{let t={};t.fieldLabel=e.name+" "+e.id,t.fieldOptions=["Slow","Neutral","Fast"],t.fieldValue="Neutral",window.unitEditorRelationshipFields.record["support-Speed-"+e.id]="Neutral",s.push(t)}));let l=E(s,"Support-speed").innerHTML;window.unitEditorRelationshipFields.fields[4].html.html=l,window.unitEditorRelationshipFields.fields[4].field="dynamicRadios-Support-speed"}window.currentUnit.canHaveChildren&&window.unitsCanHaveChildren?(window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-header").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-inheritances").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-child-header").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-child").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-child-below").hidden=!1):(window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-header").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-inheritances").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-child-header").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-child-below").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-child").hidden=!0),window.combatAdjutants?(window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-header").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-does").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-none-level-support").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-d-level-support").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-c-level-support").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-b-level-support").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-a-level-support").hidden=!1,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-s-level-support").hidden=!1):(window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-header").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-does").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-none-level-support").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-d-level-support").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-c-level-support").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-b-level-support").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-a-level-support").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-chance-s-level-support").hidden=!0),window.combatPairUp?window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-pairup-header").hidden=!1:window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-pairup-header").hidden=!0,window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-adjutant-does").options.items=[window.combatAdjutantAttack?"Attack":null,window.combatAdjutantGuard?"Guard":null,window.combatAdjutantHeal?"Heal":null].filter((e=>null!==e)),window.unitEditorRelationshipFields.get("unit-editor-relationship-fields-parenting-child").options.items=i.map((e=>({id:e.id,text:e.name+" "+e.id}))),window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-adjutant-does"]="Attack",window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-adjutant-chance-none-level-support"]=2,window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-adjutant-chance-d-level-support"]=4,window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-adjutant-chance-c-level-support"]=6,window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-adjutant-chance-b-level-support"]=8,window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-adjutant-chance-a-level-support"]=10,window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-adjutant-chance-s-level-support"]=12,window.unitEditorRelationshipFields.formHTML=window.unitEditorRelationshipFields.generateHTML(),window.unitEditorRelationshipFields.render(),window.unitEditorRelationshipFields.record["unit-editor-relationship-fields-parenting-inheritances"]=["Eye color","Hair color","Skin color","Height"],window.unitEditorRelationshipFields.on("change",(e=>{window.unitEditorRelationshipFields.record[e.detail.originalEvent.target.name]=e.detail.originalEvent.target.getAttribute("data-value")}))};let $=new s.kf({name:"UnitEditorLeft",flatButton:!1,nodes:[]});window.UnitEditorLeftSidebar=$,$.on("click",(function(e){e.done((()=>{let t=$.get(e.target);window.currentUnit=window.allUnits.find((e=>e.id===t.id)),s.GB["unit-editor-bottom-toolbar"].click("unit-editor-bottom-toolbar-basic"),T(window.currentUnit),t.selected=!0,$.nodes.forEach((e=>{e.id!==t.id&&(e.selected=!1)})),$.refresh()}))}));const A=$;let j=new Date,M=!1;const O=async()=>{console.log("getting all units");let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queue:[{model:"Person",method:"getPeople"}]})},t=new Date;if(t-j<1e4&&!0===M)return window.allUnits?window.allUnits:[];let i=await fetch("http://localhost:26068/data",e).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));return i.ok?(j=t,M=!0,i.json()):[]};window.UnitEditorCreateNewUnit=async(e,t)=>{console.log("creating new unit"),console.log(e);let i={};i.which=e,"avatar"===e&&(i.canSSupport=!0,i.canHaveChildren=!0),i.name=t,i.queue=[{model:"Person",method:"createPerson"}],console.log(i);let s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)},l=await fetch("http://localhost:26068/data",s).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));if(l.ok){let e=await l.json();return console.log(e),e}return w2alert("Error: invalid response from schemas server")},window.UnitEditorDeleteUnit=async e=>{console.log("deleting unit");let t={};t.id=e,t.queue=[{model:"Person",method:"deletePerson"}],console.log(t);let i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},s=await fetch("http://localhost:26068/data",i).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));if(s.ok){let e=await s.json();return console.log(e),e}return w2alert("Error: invalid response from schemas server")};let I=[],D=new s.Hs({name:"UnitEditorTopMenu",tooltip:"bottom",items:[{type:"button",id:"new-unit",text:"New unit",class:"w2ui-btn accent",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"button",id:"unit-checklist",text:"Unit checklist",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>'},{type:"spacer"},{type:"button",id:"delete-unit",text:"Delete unit",class:"w2ui-btn slider1",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>'}]});D.on("click",(function(e){e.done((async()=>{if(window.turnrootEditorLogs.push(`${new Date}||info||Unit toolbar button clicked: ${JSON.stringify(e.target)}`),"new-unit"===e.detail.item.id)(0,s.iX)({title:"Create new unit",label:0===window.allUnits.length?'Enter the familiar name for your first unit. This unit will be the "avatar", or customizable player character. The player will be allowed to change this name if they want- this is just a default.':"Enter the familiar name of the new unit"}).ok((async e=>{if(""===e.detail.value)e.preventDefault();else{window.allUnits=await O();let t="avatar";window.allUnits.length>0&&(t="enemy"),await window.UnitEditorCreateNewUnit(t,e.detail.value).then((e=>(window.UnitEditor.html("main",window.unitEditorBasicFields),window.allUnits.push(e),window.currentUnit=e,T(e),window.allUnits.forEach((e=>{I.push({id:e.id,text:e.name+" "+e.id})})),I.forEach((t=>{t.id===e.id&&(t.selected=!0)})),window.allUnitsNodes=I,window.UnitEditorLeftSidebar.remove(),window.UnitEditorLeftSidebar.nodes=window.allUnitsNodes,window.UnitEditor.refresh(),window.UnitEditorLeftSidebar.refresh(),(0,s.mJ)("New unit created")))).catch((e=>{console.error(e)}))}}));else if("delete-unit"===e.detail.item.id){if(0===window.allUnits.length)return(0,s.mJ)("No units to delete");let e=window.currentUnit;(0,s.mW)({title:"Delete unit",body:`Are you sure you want to delete ${e.name}?`,width:300,height:200}).yes((async()=>{T(window.currentUnit),console.log(e,e.id),await window.UnitEditorDeleteUnit(e.id).then((()=>{let t=window.allUnits.findIndex((t=>t.id===e.id));return window.allUnits.splice(t,1),window.UnitEditorLeftSidebar.remove(),window.UnitEditorLeftSidebar.nodes=window.allUnits.map((e=>({id:e.id,text:e.name+" "+e.id}))),window.UnitEditorLeftSidebar.refresh(),window.currentUnit=window.allUnits[0],window.UnitEditor.html("main",window.unitEditorBasicFields),(0,s.mJ)("Unit deleted")})).catch((t=>(console.log(e),console.error(t),(0,s.mJ)("Error deleting unit"))))}))}}))}));const R=D;let z=new s.sk({name:"unit-editor-relationship-fields",fields:[{field:"",type:"html",html:{html:"<h1>Relationships</h1>"}},{field:"",type:"html",html:{html:"<h2>Max supports</h2>",column:0}},{field:"html",type:"html",html:{html:"",column:0}},{field:"",type:"html",html:{html:'<h2 style="margin-top:2.8rem;">Support speed</h2>',column:1}},{field:"html",type:"html",html:{html:"",column:1}},{field:"unit-editor-relationship-fields-parenting-header",type:"html",html:{html:'<h2 style="margin-top:3.4rem;">Parenting</h2><br/><h3>Passed-down traits</h3></br><p>Child units can inherit traits from their parents. If both parents have a traits checked, the child will have either one or the other or a mix<sup aria-label="There\'s a 40% chance of getting the trait from parent 1, 40% from parent 2, and 20% chance of a 50/50 mix. Yes, we know that\'s not how genetics work." data-balloon-pos="up" data-balloon-length="large"><highlight>*</highlight></sup>. If just one parent has a trait checked. the child will have their trait. If neither has a trait checked, the child will use their default trait.</br></br></p>',column:0,class:"no-label"}},{type:"checks",field:"unit-editor-relationship-fields-parenting-inheritances",html:{label:"",column:0,class:"check-row"},options:{items:["Eye color","Hair color","Skin color","Height"]}},{type:"html",field:"unit-editor-relationship-fields-parenting-child-header",html:{html:'<h3 style = "margin-top:6.8rem">Child Unit</h3>',column:1,class:"no-label"}},{type:"select",field:"unit-editor-relationship-fields-parenting-child",html:{class:"no-label",column:1}},{type:"html",field:"unit-editor-relationship-fields-parenting-child-below",html:{html:'<p><highlight>Important!</highlight> If two units with a set child unit S support and have a child, their child will be one of the two selected randomly.<sup aria-label="In traditional TTRPG games the child unit is always set on the mother. Turnroot allows same-sex couples to have children, which makes guaranteed child units impossible. " data-balloon-length="large" data-balloon-pos="up"><highlight>why?</highlight></sup> You should set a unique child unit on each parent and not worry about it. Just be aware that not all child units may be spawned in-game. Alternatively, you can have two children per couple so all child units are spawned.</p>',column:1,class:"no-label"}},{type:"html",field:"unit-editor-relationship-fields-adjutant-header",html:{html:'<h2 style="margin-top:2.8rem;">Adjutant</h2><br/><p>If this unit is assigned as an adjutant, it will:</p>',column:0,class:"no-label"}},{type:"radio",field:"unit-editor-relationship-fields-adjutant-does",options:{items:["Guard","Attack","Heal"]},html:{column:0}},{type:"number",field:"unit-editor-relationship-fields-adjutant-chance-none-level-support",html:{label:"% Chance at no support",column:0}},{type:"number",field:"unit-editor-relationship-fields-adjutant-chance-d-level-support",html:{label:"% Chance at D-level support",column:0}},{type:"number",field:"unit-editor-relationship-fields-adjutant-chance-c-level-support",html:{label:"% Chance at C-level support",column:0}},{type:"number",field:"unit-editor-relationship-fields-adjutant-chance-b-level-support",html:{label:"% Chance at B-level support",column:0}},{type:"number",field:"unit-editor-relationship-fields-adjutant-chance-a-level-support",html:{label:"% Chance at A-level support",column:0}},{type:"number",field:"unit-editor-relationship-fields-adjutant-chance-s-level-support",html:{label:"% Chance at S-level support",column:0}},{type:"html",field:"unit-editor-relationship-fields-pairup-header",html:{html:'<h2 style="margin-top:2.8rem;">Pair-up</h2>',column:1,class:"no-label"}}],record:{}});window.unitEditorRelationshipFields=z;const F=z;let N,L=[];if(N=window.useExperienceSublevels?{items:["E","E+","D","D+","C","C+","B","B+","A","A+","S"]}:{items:["E","D","C","B","A","S"]},window.statsAptitudesUseRiding&&L.push({field:"riding",type:"select",options:N,html:{label:"Riding",attr:"",column:0}}),window.statsAptitudesUseFlying&&L.push({field:"flying",type:"select",options:N,html:{label:"Flying",attr:"",column:0}}),window.statsAptitudesUseAuthority&&L.push({field:"authority",type:"select",options:N,html:{label:"Authority",attr:"",column:0}}),window.statsAptitudesUseArmor&&L.push({field:"armor",type:"select",options:N,html:{label:"Armor",attr:"",column:0}}),window.globalWeaponTypes)for(let e of globalWeaponTypes)L.push({field:e.type,type:"select",options:N,html:{label:e.html.label,attr:"",column:0}});window.turnrootEditorLogs.push(`${new Date}||info||Global experiences loaded`);const B=L;let H={name:"unit-editor-friend-fields",record:{},fields:[{type:"html",html:{html:"<div><h2>Uniques</h2><small>Set classes, items, and skills only this unit (or their children, if inheritance is on), can have. Personal skills and classes are set here.</br></br>If there are no classes, items, or skills available to select, you can create them by clicking Skills, Items, or Classes on the left sidebar.</small></div>"}},{type:"html",html:{html:"<h3>Unique skills</h3>"}},{field:"unique-skills",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Skill 1","Skill 2","Skill 3","Skill 4","Skill 5"]}},{type:"html",html:{html:"<h3>Unique classes</h3>"}},{field:"unique-classes",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Class 1","Class 2","Class 3","Class 4","Class 5"]}},{type:"html",html:{html:"<h3>Unique items</h3>"}},{field:"unique-items",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Item 1","Item 2","Item 3","Item 4","Item 5"]}},{type:"html",html:{html:"<h2>Base aptitudes</h2>",column:0}}]};H.fields.push({type:"html",html:{html:window.useExperienceAptitudes?"<small>Set this unit's starting aptitudes, as well as their affinity for them (positive, negative, or neutral).</br>A positive affinity means this unit will learn it faster, a negative means slower.</small>":"<small>Set this unit's starting aptitudes.</small>",column:0}}),B.forEach(((e,t)=>{e.field="friend-base-aptitudes-"+e.field.toLowerCase(),e.html.group=e.field,e.html.class="group-flex",H.fields.push(e),H.fields.push({type:"html",field:e.field+"-affinity-friend",html:{class:"no-label",attr:'style="width:max-content"',column:0,html:`<div style = "display:flex;align-items:center;flex-wrap:wrap;width:100%;"><p style = "margin-right:.25rem;">Affinity:</p><input type = "radio" name = "${e.field+"-affinity-radio"}" class="w2ui-input"><label style = "font-size:1.5rem;margin-right:.5rem;">-</label></input><input name = "${e.field+"-affinity-radio"}" type = "radio" class="w2ui-input" checked><label style = "font-size:1rem;margin-right:.5rem;">None</label></input><input name = "${e.field+"-affinity-radio"}" type = "radio" class="w2ui-input"><label style = "font-size:1.5rem;margin-right:.5rem;">+</label></input></div>`}}),H.record[e.field+"-affinity-friend"]="None",H.record[e.field]="E"}));let U=new s.sk(H);U.updateGlobals=()=>{let e;window.useExperienceAptitudes?(e=U.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!1))):(e=U.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!0))),U.refresh()},U.updateGlobals(),U.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.currentUnit[i]=s.current})(e)}));const P=U;let W;localStorage.getItem("hairColors")?W=JSON.parse(localStorage.getItem("hairColors")):(W=["rgb(39, 31, 86)","rgb(218, 145, 32)","rgb(139, 69, 19)","rgb(84, 42, 2)","rgb(171, 33, 0)","rgb(34, 223, 154)","rgb(34, 162, 231)","rgb(255, 192, 208)","rgb(255, 222, 176)","rgb(255, 105, 180)"],localStorage.setItem("hairColors",JSON.stringify(W))),window.setDefaultHairColor=e=>{e.preventDefault(),document.querySelector("#unit-editor-avatar-hair-colors").querySelectorAll(".hidden-until-hover-wrapper").forEach((e=>e.style.border="")),e.target.style.border="2px solid var(--accent)",window.unitEditorAvatarDefaultHairColor=e.target.style.backgroundColor},window.unitEditorAvatarRemoveHairColor=e=>{e.preventDefault();let t=e.target.style.backgroundColor;W=W.filter((e=>e!==t)),window.turnrootEditorLogs.push(`${new Date}||info||Removed hair color: ${t}`);let i='<div id = "unit-editor-avatar-hair-colors">';for(let e of W)i+=`<div class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultHairColor(event)" onclick="unitEditorAvatarRemoveHairColor(event)"></div>`;i+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddHairColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-hair-colors").innerHTML=i,localStorage.setItem("hairColors",JSON.stringify(W))},window.unitEditorAvatarAddHairColor=e=>{let t=(i=e.target.previousElementSibling.value,`rgb(${parseInt(i.substring(1,3),16)}, ${parseInt(i.substring(3,5),16)}, ${parseInt(i.substring(5,7),16)})`);var i;W.push(t),window.turnrootEditorLogs.push(`${new Date}||info||Added hair color: ${t}`);let s='<div id = "unit-editor-avatar-hair-colors">';for(let e of W)s+=`<div id="unit-editor-avatar-hair-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultHairColor(event)" onclick="unitEditorAvatarRemoveHairColor(event)"></div>`;s+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddHairColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-hair-colors").innerHTML=s,localStorage.setItem("hairColors",JSON.stringify(W))};let G='<div id = "unit-editor-avatar-hair-colors">';for(let e of W)G+=`<div id="unit-editor-avatar-hair-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"  oncontextmenu="setDefaultHairColor(event)" onclick="unitEditorAvatarRemoveHairColor(event)"></div>`;G+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddHairColor(event)">Add color</button></div></div>';const q=G;let V;localStorage.getItem("eyeColors")?V=JSON.parse(localStorage.getItem("eyeColors")):(V=["rgb(104, 52, 2)","rgb(124, 183, 74)","rgb(34, 132, 181)","rgb(130, 150, 210)"],localStorage.setItem("eyeColors",JSON.stringify(V))),window.setDefaultEyeColor=e=>{e.preventDefault(),document.querySelector("#unit-editor-avatar-eye-colors").querySelectorAll(".hidden-until-hover-wrapper").forEach((e=>e.style.border="")),e.target.style.border="2px solid var(--accent)",window.unitEditorAvatarDefaultEyeColor=e.target.style.backgroundColor},window.unitEditorAvatarRemoveEyeColor=e=>{e.preventDefault();let t=e.target.style.backgroundColor;V=V.filter((e=>e!==t)),window.turnrootEditorLogs.push(`${new Date}||info||Removed eye color: ${t}`);let i='<div id = "unit-editor-avatar-eye-colors">';for(let e of V)i+=`<div class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultEyeColor(event)" onclick="unitEditorAvatarRemoveEyeColor(event)"></div>`;i+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddEyeColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-eye-colors").innerHTML=i,localStorage.setItem("eyeColors",JSON.stringify(V))},window.unitEditorAvatarAddEyeColor=e=>{let t=(i=e.target.previousElementSibling.value,`rgb(${parseInt(i.substring(1,3),16)}, ${parseInt(i.substring(3,5),16)}, ${parseInt(i.substring(5,7),16)})`);var i;V.push(t),window.turnrootEditorLogs.push(`${new Date}||info||Added eye color: ${t}`);let s='<div id = "unit-editor-avatar-eye-colors">';for(let e of V)s+=`<div id="unit-editor-avatar-eye-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultEyeColor(event)" onclick="unitEditorAvatarRemoveEyeColor(event)"></div>`;s+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddEyeColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-eye-colors").innerHTML=s,localStorage.setItem("eyeColors",JSON.stringify(V))};let Y='<div id = "unit-editor-avatar-eye-colors">';for(let e of V)Y+=`<div id="unit-editor-avatar-eye-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"  oncontextmenu="setDefaultEyeColor(event)" onclick="unitEditorAvatarRemoveEyeColor(event)"></div>`;Y+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddEyeColor(event)">Add color</button></div></div>';const X=Y;let J={name:"unit-editor-avatar-fields",record:{},fields:[{type:"html",html:{html:"<div><h2>Uniques</h2><small>Set classes, items, and skills only this unit (or their children, if inheritance is on), can have. Personal skills and classes are set here.</br></br>If there are no classes, items, or skills available to select, you can create them by clicking Skills, Items, or Classes on the left sidebar.</small></div>"}},{type:"html",html:{html:"<h3>Unique skills</h3>"}},{field:"unique-skills",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Skill 1","Skill 2","Skill 3","Skill 4","Skill 5"]}},{type:"html",html:{html:"<h3>Unique classes</h3>"}},{field:"unique-classes",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Class 1","Class 2","Class 3","Class 4","Class 5"]}},{type:"html",html:{html:"<h3>Unique items</h3>"}},{field:"unique-items",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Item 1","Item 2","Item 3","Item 4","Item 5"]}},{type:"html",html:{html:"<h2>Base aptitudes</h2>",column:0}},{type:"html",html:{html:"<div><h2>Appearance</h2><small>Set the options that the player will have to customize their avatar's appearance. Right-click to set the default. Click to delete.</small></div>",column:1}},{type:"html",html:{html:`<div><h3>Hair colors</h3><small>Default: <span style = "width:2remheight:1rembackground-color:${window.unitEditorAvatarDefaultHairColor}display:inline-blockborder-radius:.25rem"</small></div>`,column:1}},{type:"html",field:"hair-colors",html:{class:"no-label",attr:'style="width:12rem"',column:1,html:q}},{type:"html",html:{html:`<div><h3>Eye colors</h3><small>Default: <span style = "width:2remheight:1rembackground-color:${window.unitEditorAvatarDefaultEyeColor}display:inline-blockborder-radius:.25rem"</small></div>`,column:1}},{type:"html",field:"eye-colors",html:{class:"no-label",attr:'style="width:12rem"',column:1,html:X}}]};J.fields.push({type:"html",html:{html:window.useExperienceAptitudes?"<small>Set this unit's starting aptitudes, as well as their affinity for them (positive, negative, or neutral).</br>A positive affinity means this unit will learn it faster, a negative means slower.</small>":"<small>Set this unit's starting aptitudes.</small>",column:0}}),B.forEach(((e,t)=>{e.field="avatar-base-aptitudes-"+e.field.toLowerCase(),e.html.group=e.field,e.html.class="group-flex",J.fields.push(e),J.fields.push({type:"radio",field:e.field+"starting-affinity",options:{items:["None","-","+"]},html:{column:0}}),J.record[e.field]="E",J.record[e.field+"starting-affinity"]="None"}));let K=new s.sk(J);K.updateGlobals=()=>{let e;window.useExperienceAptitudes?(e=K.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!1))):(e=K.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!0))),window.useExperienceSublevels?B.forEach(((e,t)=>{if(e.options){e.options.items=["E","E+","D","D+","C","C+","B","B+","A","A+","S"];let t=K.fields.filter((t=>t.field?.includes(e.field.toLowerCase())))[0];t=K.get(t.field),t.options.items=["E","E+","D","D+","C","C+","B","B+","A","A+","S"]}})):B.forEach(((e,t)=>{if(e.options){e.options.items=["E","D","C","B","A","S"];let t=K.fields.filter((t=>t.field?.includes(e.field.toLowerCase())))[0];t=K.get(t.field),t.options.items=["E","D","C","B","A","S"]}})),K.refresh()},window.UnitEditorAvatarFields=K,K.updateGlobals(),K.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.currentUnit[i]=s.current})(e)}));const Q=K;let Z=new s.sk({name:"unit-editor-enemy-fields",record:{},fields:[{type:"html",html:{html:"<div><h2>Uniques</h2><small>Set classes, items, and skills only this unit can have. Personal skills and classes are set here.</br></br>If there are no classes, items, or skills available to select, you can create them by clicking Skills, Items, or Classes on the left sidebar.</small></div>"}},{type:"html",html:{html:"<h3>Unique skills</h3>"}},{field:"enemy-unique-skills",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Skill 1","Skill 2","Skill 3","Skill 4","Skill 5"]}},{type:"html",html:{html:"<h3>Unique classes</h3>"}},{field:"enemy-unique-classes",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Class 1","Class 2","Class 3","Class 4","Class 5"]}},{type:"html",html:{html:"<h3>Unique items</h3>"}},{field:"enemy-unique-items",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{max:3,items:["Item 1","Item 2","Item 3","Item 4","Item 5"]}}]});Z.updateGlobals=()=>{window.turnrootEditorLogs.push(`${new Date}||info||Updating Enemy form globals`),Z.refresh()},Z.updateGlobals(),Z.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.currentUnit[i]=s})(e)}));const ee=Z;let te=new s.sk({name:"unit-editor-npc-fields",record:{},fields:[]});te.updateGlobals=()=>{window.turnrootEditorLogs.push(`${new Date}||info||Updating NPC form globals`),te.refresh()},te.updateGlobals(),te.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.currentUnit[i]=s.current})(e)}));const ie=te;let se=null;document.onmouseup=e=>{se&&(se.dragging=!1,se.thumb.style.width="1.25rem",se.thumb.style.height="1.25rem",se=null)},document.onmousemove=e=>{if(se?.dragging){e.preventDefault(),se.thumb.style.width="1.4rem",se.thumb.style.height="1.4rem";let t=se.track.getBoundingClientRect(),i=(e.clientX-t.left)/t.width*100;i<10&&(i=10),i>100&&(i=100);let s=Math.ceil(1.1*i-10-1),l=`color-mix(in oklab,var(--slider-0) ${s}%,var(--slider-1))`;se.thumb.style.right=100-i+"%",se.thumb.style.backgroundColor=l,se.onchange(s)}};const le=class{constructor(e,t="h",i=50){this.value=i,this.container=e,this.hv=t,this.onchange=e=>e,this.sliderDiv=document.createElement("div"),this.sliderDiv.style.width="100%",this.sliderDiv.style.height="min-content",this.container.appendChild(this.sliderDiv),this.thumb=void 0,this.track=void 0,this.coloredRange(),this.dragging=!1}setValue(e){this.value=parseInt(e),this.thumb.style.right=100-this.value+"%";let t=`color-mix(in oklab,var(--slider-0) ${Math.ceil(1.1*this.value-10-1)}%,var(--slider-1))`;this.thumb.style.backgroundColor=t}coloredRange(){let e=document.createElement("div");"h"===this.hv?(e.style.width="100%",e.style.height="1.5rem"):(e.style.width="1.5rem",e.style.height="100%"),e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";let t=document.createElement("div");this.track=t,"h"===this.hv?(t.style.width="90%",t.style.height="3px"):(t.style.width="3px",t.style.height="90%"),t.style.backgroundColor="color-mix(in srgb,var(--window-background) 60%,var(--window-background-alt))",t.style.position="relative",e.appendChild(t);let i=document.createElement("div");this.thumb=i,i.className="no-transition",i.style.width="1.25rem",i.style.height="1.25rem",i.style.borderRadius=".25rem",i.style.position="relative",i.style.right=`${this.value}%`,i.style.backgroundColor="var(--slider-0)",i.onmousedown=e=>{e.preventDefault(),se=this,se.thumb=i,se.sliderDiv=this.sliderDiv,se.track=t,this.dragging=!0,i.style.width="1.4rem",i.style.height="1.4rem"},this.sliderDiv.onmousedown=e=>{e.preventDefault(),se=this,se.dragging=!0,se.thumb=i;let s=i.getBoundingClientRect(),l=!1;if(e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom&&(l=!0),!l){se.sliderDiv=this.sliderDiv,se.track=t;let s=""+(100-(e.clientX-t.getBoundingClientRect().left)/t.getBoundingClientRect().width*100-12);s<10&&(s=10),s>100&&(s=100);let l=Math.ceil(1.1*s-10-1);l>100&&(l=100);let o=`color-mix(in oklab,var(--slider-0) ${l}%,var(--slider-1))`;i.style.backgroundColor=o,se.thumb.style.right=`${s}%`}},e.appendChild(i),this.sliderDiv.appendChild(e)}};let oe=document.createElement("div");oe.style.width="100%",oe.style.height="100%",oe.style.padding="1rem";let ne=document.createElement("div");ne.style.maxWidth="100ch",ne.style.lineHeight="1.5rem",ne.innerHTML="\n    <div><h2>How does all this work?</h2>\n    <em>As noted above, you should generally not worry about specific rules and just load a preset, then tweak the sliders.</em> \n    <h3>Sliders</h3>\n    The sliders control the priority of a rule. The higher the priority, the more likely that rule is to occur.\n    <h3>Customizing rules</h3>\n    You can customize any rule with the dropdowns. For example, you could change Move towards nearest foe (Mindless) to Move towards nearest foe (Lone Wolf) by selecting 'Lone Wolf' from the dropdown.<br/><br/>\n    The Priority and Target columns are customizable- the rule columns are set in stone. You can disable rules, but not add or change them. <br/><br/>",oe.appendChild(ne);let ae=[],re=[];oe.innerHTML="<div><h2>Behavior</h2>\n<p>Units that move on their own have their behaviors controlled by these sliders, which in turn influence the priority of the rules below. The presets will cover most common cases- for specific units, you can tweak things as needed. Generally, you just need to load a preset.<br/><br/>For special behaviors, see the Specials tab.</p></div>\n";let de=document.createElement("div");de.style.display="flex",de.style.flexWrap="wrap",de.style.justifyContent="center",de.style.gap=".25rem",de.style.marginBottom="1rem",de.style.width="100%";let he=document.createElement("button");he.innerHTML="Foot Soldier",he.className="w2ui-btn";let ce=document.createElement("button");ce.innerHTML="Mindless Creature",ce.className="w2ui-btn";let ue=document.createElement("button");ue.innerHTML="Cautious Healer",ue.className="w2ui-btn";let pe=document.createElement("button");pe.innerHTML="Sniper",pe.className="w2ui-btn";let me=document.createElement("button");me.innerHTML="Steadfast Tank",me.className="w2ui-btn";let ge=document.createElement("button");ge.innerHTML="Independent Assassin",ge.className="w2ui-btn";let fe=document.createElement("button");fe.innerHTML="Vengeful Demon",fe.className="w2ui-btn";let we=document.createElement("button");we.innerHTML="Weak Coward",we.className="w2ui-btn";let be=document.createElement("button");be.innerHTML="Looter",be.className="w2ui-btn";let ye=[he,ce,ue,pe,me,ge,fe,we,be],ve=[{left:"Move towards",center:"nearest foe",right:"Mindless"},{left:"Move towards",center:"disadvantaged foe",right:"Strategic"},{left:"Move towards",center:"last attacked foe",right:"Team Player"},{left:"Move towards",center:"safety",right:"Coward"},{left:"Move towards",center:"cover",right:"Coward"},{left:"Move towards",center:"hurt ally (can heal or rally)",right:"Selfless"},{left:"Move towards",center:"nearest objective tile",right:"Strategic"},{left:"Move towards",center:"chest (if can open)",right:"Greedy"},{left:"Move towards",center:"door (if can open)",right:"Lone Wolf"},{left:"Move towards",center:"fortress",right:"Strategic"},{left:"Move towards",center:"emplacement",right:"Lone Wolf"},{left:"Move towards",center:"minimize receiving attack count",right:"Team Player"},{left:"Move towards",center:"team leader",right:"Team Player"},{left:"Move towards",center:"furthest distance",right:"Lone Wolf"},{left:"Move towards",center:"player avatar",right:"Hero"}],xe={Default:["Move towards nearest foe","Move towards last attacked foe","Move towards disadvantaged foe","Move towards nearest objective tile","Move towards team leader"],MindlessCreature:["Move towards nearest foe","Move towards last attacked foe","Move towards nearest objective tile","Move towards furthest distance"],CautiousHealer:["Move towards disadvantaged foe","Move towards minimize receiving attack count","Move towards safety","Move towards hurt ally (can heal or rally)","move towards fortress","Move towards cover"],Sniper:["Move towards disadvantaged foe","Move towards last attacked foe","Move towards furthest distance","Move towards minimize receiving attack count","move towards emplacement","Move towards safety","Move towards cover"],SteadfastTank:["Move towards nearest foe","Move towards last attacked foe","Move towards fortress","Move towards player avatar","Move towards disadvantaged foe","Move towards team leader","Move towards nearest objective tile"],IndependentAssassin:["Move towards disadvantaged foe","Move towards last attacked foe","Move towards furthest distance","Move towards minimize receiving attack count","Move towards safety","Move towards cover","Move towards player avatar"],WeakCoward:["Move towards safety","Move towards cover","Move towards hurt ally (can heal or rally)","Move towards nearest objective tile","Move towards team leader","Move towards minimize receiving attack count"],Looter:["Move towards chest (if can open)","Move towards door (if can open)","Move towards safety","Move towards disadvantaged foe","Move towards nearest objective tile","minimize receiving attack count"],VengefulDemon:["Move towards last attacked foe","Move towards disadvantaged foe","Move towards nearest foe","Move towards player avatar"]},ke={Default:{"unitEditorBehavior.TeamPlayer":20,"unitEditorBehavior.Hero":40,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":55,list:[20,40,50,55]},MindlessCreature:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":50,"unitEditorBehavior.Strategic":90,"unitEditorBehavior.Selfless":50,list:[90,50,90,50]},CautiousHealer:{"unitEditorBehavior.TeamPlayer":20,"unitEditorBehavior.Hero":30,"unitEditorBehavior.Strategic":20,"unitEditorBehavior.Selfless":10,list:[20,30,20,10]},Sniper:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":70,"unitEditorBehavior.Strategic":10,"unitEditorBehavior.Selfless":80,list:[90,70,10,80]},SteadfastTank:{"unitEditorBehavior.TeamPlayer":10,"unitEditorBehavior.Hero":10,"unitEditorBehavior.Strategic":60,"unitEditorBehavior.Selfless":50,list:[10,10,60,50]},IndependentAssassin:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":90,"unitEditorBehavior.Strategic":10,"unitEditorBehavior.Selfless":90,list:[90,90,10,90]},WeakCoward:{"unitEditorBehavior.TeamPlayer":30,"unitEditorBehavior.Hero":90,"unitEditorBehavior.Strategic":40,"unitEditorBehavior.Selfless":70,list:[30,90,40,70]},Looter:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":50,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":90,list:[90,50,50,90]},VengefulDemon:{"unitEditorBehavior.TeamPlayer":70,"unitEditorBehavior.Hero":10,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":30,list:[70,10,50,30]}};const Ce=e=>{Ae.innerHTML="",ae.forEach(((t,i)=>{let s=ke[e].list[i];t.setValue(s)}));let t=xe[e],i=document.createElement("div"),s=document.createElement("div"),l=document.createElement("div");je(i,Me),je(s,Me),je(l,Me),i.style.backgroundColor="var(--button-alt-text)",s.style.backgroundColor="var(--button-alt-text)",l.style.backgroundColor="var(--button-alt-text)",i.style.color="var(--window-background-alt)",s.style.color="var(--window-background-alt)",i.innerHTML="<strong>Rule</strong>",s.innerHTML="<strong>Target</strong>",l.innerHTML="<strong>Priority</strong>",Ae.appendChild(i),Ae.appendChild(s),Ae.appendChild(l),ve.forEach((e=>{if(t.includes(e.left+" "+e.center)){let t=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div");t.innerHTML=e.left,i.innerHTML=e.center,s.innerHTML=`\n            <select id="unitEditorBehaviorRule${e.left.replace(" ","")+e.center.replace(" ","")}" name="unitEditorBehaviorRule${e.left.replace(" ","")+e.center.replace(" ","")}" class="w2ui-input " tabindex="1" style = "width:100%;height:100%;margin:0;font-size:1rem;border-radius:0;" onchange='window.unitEditorBehaviorUpdateWindow()'>\n            <option value="Team Player" ${"Team Player"===e.right?"selected":""}>Team Player</option>\n            <option value="Lone Wolf" ${"Lone Wolf"===e.right?"selected":""}>Lone Wolf</option>\n            <option value="Hero" ${"Hero"===e.right?"selected":""}>Hero</option>\n            <option value="Coward" ${"Coward"===e.right?"selected":""}>Coward</option>\n            <option value="Strategic" ${"Strategic"===e.right?"selected":""}>Strategic</option>\n            <option value="Mindless" ${"Mindless"===e.right?"selected":""}>Mindless</option>\n            <option value="Selfless" ${"Selfless"===e.right?"selected":""}>Selfless</option>\n            <option value="Greedy" ${"Greedy"===e.right?"selected":""}>Greedy</option>\n            </select>`,je(t,Me),je(i,Me),je(s,Me,!1),s.style.margin="0",s.style.padding="0px!important",t.style.backgroundColor="var(--node-text)",i.style.backgroundColor="var(--node-title)",Ae.appendChild(t),Ae.appendChild(i),Ae.appendChild(s)}}))};he.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),he.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("Default"),window.unitEditorBehaviorUpdateWindow(ke.Default)},ce.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),ce.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("MindlessCreature"),window.unitEditorBehaviorUpdateWindow(ke.MindlessCreature)},ue.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),ue.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("CautiousHealer"),window.unitEditorBehaviorUpdateWindow(ke.CautiousHealer)},pe.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),pe.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("Sniper"),window.unitEditorBehaviorUpdateWindow(ke.Sniper)},me.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),me.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("SteadfastTank"),window.unitEditorBehaviorUpdateWindow(ke.SteadfastTank)},ge.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),ge.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("IndependentAssassin"),window.unitEditorBehaviorUpdateWindow(ke.IndependentAssassin)},we.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),we.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("WeakCoward"),window.unitEditorBehaviorUpdateWindow(ke.WeakCoward)},fe.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),fe.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("VengefulDemon"),window.unitEditorBehaviorUpdateWindow(ke.VengefulDemon)},be.onclick=()=>{ye.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),be.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Ce("Looter"),window.unitEditorBehaviorUpdateWindow(ke.Looter)},ye.forEach((e=>{de.appendChild(e)})),oe.appendChild(de);let _e,Ee,Se,Te,$e={"unitEditorBehavior.TeamPlayer":50,"unitEditorBehavior.Hero":50,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":50,list:[50,50,50,50]};[{left:"Team Player",right:"Lone Wolf"},{left:"Hero",right:"Coward"},{left:"Strategic",right:"Mindless"},{left:"Selfless",right:"Greedy"}].forEach((e=>{Ee=document.createElement("p"),Ee.innerHTML=e.left,Ee.style.width="12%",Se=document.createElement("p"),Se.innerHTML=e.right,Se.style.width="12%",Te=document.createElement("div"),Te.style.flexGrow=2,_e=new le(Te),_e.onchange=t=>{$e[`unitEditorBehavior.${e.left.replace(" ","")}`]=t,Re()},re.push([Ee,Te,Se]),ae.push(_e)})),re.forEach((e=>{let t=document.createElement("div");t.innerHTML="",t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.appendChild(e[0]),t.appendChild(e[1]),t.appendChild(e[2]),oe.appendChild(t)}));let Ae=document.createElement("div");function je(e,t,i=!0){Object.keys(t).forEach((s=>{i||"padding"!==s?e.style[s]=t[s]:e.style.padding="0"}))}Ae.id="unitEditorBehaviorRules",Ae.style.width="100%",Ae.style.display="grid",Ae.style.gridTemplateColumns="1fr 1fr 1fr";let Me={padding:".5rem",border:"1px solid var(--window-background)",height:"2.5rem",color:"var(--window-background-alt)"},Oe=document.createElement("div"),Ie=document.createElement("div"),De=document.createElement("div");je(Oe,Me),je(Ie,Me),je(De,Me),Oe.style.backgroundColor="var(--button-alt-text)",Ie.style.backgroundColor="var(--button-alt-text)",De.style.backgroundColor="var(--button-alt-text)",Oe.style.color="var(--window-background-alt)",Ie.style.color="var(--window-background-alt)",Oe.innerHTML="<strong>Rule</strong>",Ie.innerHTML="<strong>Target</strong>",De.innerHTML="<strong>Priority</strong>",Ae.appendChild(Oe),Ae.appendChild(Ie),Ae.appendChild(De);const Re=(e=null)=>{e||(e=$e),window.unitEditorBehaviorTeamPlayer=e["unitEditorBehavior.TeamPlayer"],window.unitEditorBehaviorHero=e["unitEditorBehavior.Hero"],window.unitEditorBehaviorStrategic=e["unitEditorBehavior.Strategic"],window.unitEditorBehaviorSelfless=e["unitEditorBehavior.Selfless"],e.list=[window.unitEditorBehaviorTeamPlayer,window.unitEditorBehaviorHero,window.unitEditorBehaviorStrategic,window.unitEditorBehaviorSelfless];let t=Ae.children;for(let e=3;e<t.length;e+=3){let i=[t[e],t[e+1],t[e+2]],s=i[2].children[0].value;i[2].children[0].style.backgroundColor="Team Player"===s||"Lone Wolf"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorTeamPlayer}%,var(--slider-1))`:"Hero"===s||"Coward"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorHero}%,var(--slider-1))`:"Strategic"===s||"Mindless"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorStrategic}%,var(--slider-1))`:"Selfless"===s||"Greedy"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorSelfless}%,var(--slider-1))`:"var(--node-text)"}};window.unitEditorBehaviorUpdateWindow=Re,ae.forEach(((e,t)=>{let i=$e.list[t];e.setValue(i)})),Re(),oe.appendChild(Ae),De.style.backgroundColor="var(--button-alt-text)";const ze=oe;let Fe=document.createElement("div");Fe.style.width="100%",Fe.style.height="100%",Fe.style.padding="1rem",Fe.innerHTML="<div><h2>Tile rules</h2>\nUnits that move on their own get their tile interaction rules from here. Exercise extreme caution here- you can very easily break your game with a single misclick here. There are no guardrails. Pick a preset and do not modify specifics unless you're confident in what you're doing! The default tile rules are correct for 99% of units, including riding and infantry units. You should use the \"Flier\" tile preset for all flying units.\n<h3>What are the presets?</h3>\n<ul>\n    <li><highlight>Default</highlight>: The default tile rules for most units.</li>\n    <li><highlight>Flier</highlight>: The tile rules for flying units.</li>\n    <li><highlight>Pirate</highlight>: Tile rules for units that are agile in water.</li>\n    <li><highlight>Beast</highlight>: Tile rules for units that are agile in forests and unaffected by fog or mist.</li>\n</ul>\nIf you're not sure which preset to use, use the Default preset. \n</div>\n";let Ne=document.createElement("div");Ne.style.display="flex",Ne.style.justifyContent="center",Ne.style.gap=".25rem",Ne.style.marginBottom="1rem",Ne.style.width="100%";let Le=document.createElement("button");Le.innerHTML="Default",Le.className="w2ui-btn";let Be=document.createElement("button");Be.innerHTML="Flier",Be.className="w2ui-btn";let He=document.createElement("button");He.innerHTML="Pirate",He.className="w2ui-btn";let Ue=document.createElement("button");Ue.innerHTML="Beast",Ue.className="w2ui-btn";let Pe=[Le,Be,He,Ue],We=[{left:"ground",right:["move","see"]},{left:"wall",right:["stop","see"]},{left:"cliff",right:["stop","blind"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["hurt immediately","hurt on turn start","move","see"]},{left:"fire",right:["hurt on turn start","move","see"]},{left:"sand",right:["move","slow*1","slow horse*2","see"]},{left:"stairs",right:["move","slow*.5","slow horse*1","see"]},{left:"ice",right:["move","slow*1.25","see"]},{left:"snow",right:["move","slow*2","blind*.5"]},{left:"shallow_water",right:["move","slow*1.5","slow horse*.5","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind","open"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see","arms"]},{left:"magic_emplacement",right:["move","see","arms"]},{left:"heal",right:["move","see","heal"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see","guard*1"]},{left:"avoid",right:["move","see","avoid*1"]},{left:"roof",right:["stop","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see","avoid*.5"]},{left:"bushes",right:["move","slow*.5","see","avoid*1"]},{left:"trees",right:["move","slow*1.5","see","avoid*1.5"]},{left:"boulder",right:["stop","see"]},{left:"fence",right:["stop","see"]},{left:"forest",right:["move","slow*1.5","slow horse*2","blind*.5","avoid*2","hidden"]},{left:"fog",right:["move","blind","stop if enemy","hidden"]},{left:"mist",right:["move","blind*.5","stop if enemy"]}],Ge=[{left:"ground",right:["move","see"]},{left:"wall",right:["move","see"]},{left:"cliff",right:["move","see"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["move","see"]},{left:"fire",right:["move","see"]},{left:"sand",right:["move","see"]},{left:"stairs",right:["move","see"]},{left:"ice",right:["move","see"]},{left:"snow",right:["move","blind*.5"]},{left:"shallow_water",right:["move","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see"]},{left:"magic_emplacement",right:["move","see"]},{left:"heal",right:["move","see"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see"]},{left:"avoid",right:["move","see"]},{left:"roof",right:["move","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see"]},{left:"bushes",right:["move","see"]},{left:"trees",right:["move","see"]},{left:"boulder",right:["move","see"]},{left:"fence",right:["move","see"]},{left:"forest",right:["move","see"]},{left:"fog",right:["move","blind","stop if enemy","hidden"]},{left:"mist",right:["move","blind*.5","stop if enemy"]}],qe=[{left:"ground",right:["move","see"]},{left:"wall",right:["stop","see"]},{left:"cliff",right:["stop","blind"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["hurt immediately","hurt on turn start","move","see"]},{left:"fire",right:["hurt on turn start","move","see"]},{left:"sand",right:["move","slow*1","slow horse*2","see"]},{left:"stairs",right:["move","slow*.5","slow horse*1","see"]},{left:"ice",right:["move","slow*1.25","see"]},{left:"snow",right:["move","slow*2","blind*.5"]},{left:"shallow_water",right:["move","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind","open"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see","arms"]},{left:"magic_emplacement",right:["move","see","arms"]},{left:"heal",right:["move","see","heal"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see","guard*1"]},{left:"avoid",right:["move","see","avoid*1"]},{left:"roof",right:["stop","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see","avoid*.5"]},{left:"bushes",right:["move","slow*.5","see","avoid*1"]},{left:"trees",right:["move","slow*1.5","see","avoid*1.5"]},{left:"boulder",right:["stop","see"]},{left:"fence",right:["stop","see"]},{left:"forest",right:["move","slow*1.5","slow horse*2","blind*.5","avoid*2","hidden"]},{left:"fog",right:["move","blind","stop if enemy","hidden"]},{left:"mist",right:["move","blind*.5","stop if enemy"]}],Ve=[{left:"ground",right:["move","see"]},{left:"wall",right:["stop","see"]},{left:"cliff",right:["stop","blind"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["hurt immediately","hurt on turn start","move","see"]},{left:"fire",right:["hurt on turn start","move","see"]},{left:"sand",right:["move","slow*1","slow horse*2","see"]},{left:"stairs",right:["move","slow*.5","slow horse*1","see"]},{left:"ice",right:["move","slow*1.25","see"]},{left:"snow",right:["move","slow*2","see"]},{left:"shallow_water",right:["move","slow*1.5","slow horse*.5","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind","open"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see","arms"]},{left:"magic_emplacement",right:["move","see","arms"]},{left:"heal",right:["move","see","heal"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see","guard*1"]},{left:"avoid",right:["move","see","avoid*1"]},{left:"roof",right:["stop","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see","avoid*.5"]},{left:"bushes",right:["move","see","avoid*1"]},{left:"trees",right:["move","see","avoid*1.5"]},{left:"boulder",right:["stop","see"]},{left:"fence",right:["stop","see"]},{left:"forest",right:["move","avoid*2","hidden"]},{left:"fog",right:["move","see","hidden"]},{left:"mist",right:["move","see","hidden"]}];Le.onclick=()=>{Pe.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),Le.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Qe(We)},Be.onclick=()=>{Pe.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),Be.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Qe(Ge)},He.onclick=()=>{Pe.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),He.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Qe(qe)},Ue.onclick=()=>{Pe.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),Ue.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Qe(Ve)},Ne.appendChild(Le),Ne.appendChild(Be),Ne.appendChild(He),Ne.appendChild(Ue),Fe.appendChild(Ne);let Ye=document.createElement("div");function Xe(e,t){Object.keys(t).forEach((i=>{e.style[i]=t[i]}))}Ye.id="unitEditorBehaviorRules",Ye.style.width="100%",Ye.style.display="grid",Ye.style.gridTemplateColumns="1fr 1fr";let Je={padding:".5rem",backgroundColor:"var(--list-background)",border:"1px solid var(--window-background)",height:"4rem",color:"var(--node-title)"},Ke=["move","see","stop","blind","hurt immediately","hurt on turn start","slow*1","slow horse*2","slow*.5","slow horse*1","slow*1.25","slow*2","blind*.5","slow*1.5","slow horse*.5","warp","use","heal","heal*1.5","guard*1.5","avoid*1","guard*1","avoid*.5","avoid*1.5","avoid*2","hidden","stop if enemy","arms","hidden","open"];const Qe=e=>{Ye.innerHTML="",e.forEach((e=>{let t=document.createElement("div");t.innerHTML=e.left,Xe(t,Je),Ye.appendChild(t);let i=document.createElement("div");Xe(i,Je),i.style.padding="0";let l=document.createElement("div");l.className="w2ui-field expand",l.style.backgroundColor="var(--node-title-background)",l.style.color="var(--node-title)";let o=document.createElement("input");o.id="unitEditorBehaviorTiles"+e.left.replace(" ",""),l.appendChild(o),new s.aG("enum",{items:Ke,selected:e.right,el:o,renderDrop:!1,renderMulti:!0,renderInline:!0,renderItems:!0}),i.appendChild(l),Ye.appendChild(i)}))};Fe.appendChild(Ye),Le.click();const Ze=Fe;let et=document.createElement("div");et.style.width="100%",et.style.height="100%",et.style.padding="1rem",et.innerHTML="<div><h2>Specials</h2>\nSpecials are a way to add unique behaviors to units.\n";let tt=document.createElement("div");function it(e,t){Object.keys(t).forEach((i=>{e.style[i]=t[i]}))}tt.style.width="100%",tt.style.display="grid",tt.style.gridTemplateColumns="6fr 9fr 1fr";let st={padding:".5rem",backgroundColor:"var(--list-background)",border:"1px solid var(--window-background)",height:"4rem",color:"var(--node-title)"};[{left:"Flees",right:"The unit will flee, avoid enemies, and refuse to attack or counterattack."},{left:"Invincible",right:"The unit is immune to all damage."},{left:"Here to steal",right:"The unit will only approach units with items to steal or chests."},{left:"Will not move",right:"The unit will not move from its starting position."},{left:"Will not attack first",right:"The unit will not attack first."},{left:"Can't be targeted",right:"The unit cannot be targeted by enemies."},{left:"Suicidal",right:"The unit will seek their own death."},{left:"Here for the objective",right:"The unit will only move towards objective tiles, ignoring enemies."},{left:"Protect the leader",right:"The unit will stay adjacent to the leader."},{left:"Will not move until attacked",right:"The unit will not move until attacked."},{left:"Will not move until enemy in range",right:"The unit will not move until an enemy is in range."},{left:"Ignores terrain",right:"The unit can move through any terrain."},{left:"Move through units",right:"The unit can move through other units."},{left:"Kill the avatar",right:"The unit will always attack the avatar."}].forEach((e=>{let t=document.createElement("div");t.innerHTML=e.left,it(t,st),tt.appendChild(t);let i=document.createElement("div");i.innerHTML=e.right,it(i,st),i.style.backgroundColor="var(--node-title)",i.style.color="var(--window-background-alt)",tt.appendChild(i);let s=document.createElement("div");s.innerHTML=`<input type="checkbox" class="w2ui-input" style="width:2rem;height:2rem;" id = "unitEditorBehaviorSpecials${e.left.replace(/ /g,"").replace(/'/g,"")}">`,it(s,st),s.style.backgroundColor="var(--node-title)",s.style.color="var(--window-background-alt)",tt.appendChild(s)})),et.appendChild(tt);const lt=et;let ot=new s.Hs({name:"unit-editor-behavior-container-bottom-toolbar",items:[{type:"radio",group:"1",id:"unit-editor-behavior-container-bottom-toolbar-sliders",text:"Sliders",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"unit-editor-behavior-container-bottom-toolbar-tiles",text:"Tiles",class:"panel-tabs"},{type:"radio",group:"1",id:"unit-editor-behavior-container-bottom-toolbar-specials",text:"Specials",class:"panel-tabs"}]});ot.on("click",(function(e){e.done((()=>{((e,t)=>{let i=s.GB["unit-editor-behavior-container"];"unit-editor-behavior-container-bottom-toolbar-sliders"===e.detail.item.id?i.html("main",ze):"unit-editor-behavior-container-bottom-toolbar-tiles"===e.detail.item.id?i.html("main",Ze):"unit-editor-behavior-container-bottom-toolbar-specials"===e.detail.item.id&&i.html("main",lt)})(e)}))}));const nt=new s.Yw({name:"unit-editor-behavior-container",panels:[{type:"main",content:"main",html:ze,style:"overflow-x: hidden"},{type:"bottom",size:30,resizable:!1,content:"bottom",style:"overflow-y: hidden;",html:ot}]});let at=new s.Hs({name:"unit-editor-bottom-toolbar",items:[{type:"radio",group:"1",id:"unit-editor-bottom-toolbar-basic",text:"Basic Info",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"unit-editor-bottom-toolbar-subtype",text:"Subtype",class:"panel-tabs"},{type:"radio",group:"1",id:"unit-editor-bottom-toolbar-behavior",text:"Behavior",class:"panel-tabs",hidden:!0},{type:"radio",group:"1",id:"unit-editor-bottom-toolbar-relationship",text:"Relationships",class:"panel-tabs",hidden:!1}]});at.on("click",(function(e){e.done((()=>{((e,t)=>{T(window.currentUnit);let i=s.GB.UnitEditor;if("unit-editor-bottom-toolbar-basic"===e.detail.item.id)i.html("main",_),window.UnitEditorActiveTab="basic";else if("unit-editor-bottom-toolbar-subtype"===e.detail.item.id){window.UnitEditorActiveTab="subtype";let e=s.GB["unit-editor-basic-fields"].record.subtype;"Friend"===e?i.html("main",P):"Avatar"===e?i.html("main",Q):"Enemy"===e?i.html("main",ee):"NPC"===e&&i.html("main",ie)}else"unit-editor-bottom-toolbar-behavior"===e.detail.item.id?(i.html("main",nt),window.UnitEditorActiveTab="behavior"):"unit-editor-bottom-toolbar-relationship"===e.detail.item.id&&(i.html("main",F),window.UnitEditorActiveTab="relationship")})(e)}))}));const rt=at;let dt=new s.Yw({name:"UnitEditor",panels:[{type:"top",size:30,resizable:!1,content:"top",html:R,style:"overflow-y: hidden;"},{type:"main",content:"main",html:_},{type:"left",size:200,resizable:!0,content:"left",html:A},{type:"bottom",size:30,resizable:!1,content:"bottom",html:rt,style:"overflow-y: hidden;"}]});dt.on("render",(async function(e){dt.html("main",'<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:150%"><h2>Loading units...</h2></div>'),window.allUnits=await O(),window.allUnits.length>0?(window.currentUnit=window.allUnits[0],T(window.currentUnit),dt.html("main",_),A.nodes=window.allUnits.map((e=>({id:e.id,text:e.name+" "+e.id}))),A.nodes[0].selected=!0,A.refresh(),window.UnitEditorActiveTab="basic"):dt.html("main",'<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:150%"><h2>No units</h2><p>Create a new unit to get started</p><img src = "http://localhost:26068/style/img/nu.png" style="position: fixed;width: 256px;left: 17%;top: 33%;"></div>')}));const ht=dt,ct=new s.Yw({name:"ClassEditor",panels:[{type:"top",size:30,resizable:!1,content:"top",html:'<div style="padding: 10px;">Top</div>'},{type:"main",content:"main",html:'<div style="padding: 10px;">Main Class Editor</div>'}]});window.w2popup=s.yN;let ut={};window.GameEditorWeaponTypesAddType=()=>{let e=document.getElementById("weapon-types-table"),t=document.createElement("tr");t.id=Math.floor(1e5*Math.random()),t.innerHTML=`\n    <td><input type = "text" class = "w2ui-input" value="" id = "global-weapon-type-${t.id}-name" onchange = "GameEditorWeaponTypesUpdateType(${w.id})"></td>\n    <td><input type = "text" class = "w2ui-input" value="" id = "global-weapon-type-${t.id}-icon"></td>\n    <td>\n        <div>\n            <input type = "checkbox" id = "global-weapon-type-${t.id}-range-1" onchange = "GameEditorWeaponTypesUpdateType(${w.id})">\n            <label for = "global-weapon-type-${t.id}-range-1">1</label>\n            <input type = "checkbox" id = "global-weapon-type-${t.id}-range-2" onchange = "GameEditorWeaponTypesUpdateType(${w.id})">\n            <label for = "global-weapon-type-${t.id}-range-2">2</label>\n            <input type = "checkbox" id = "global-weapon-type-${t.id}-range-3" onchange = "GameEditorWeaponTypesUpdateType(${w.id})">\n            <label for = "global-weapon-type-${t.id}-range-3">3</label>\n            <input type = "checkbox" id = "global-weapon-type-${t.id}-range-4" onchange = "GameEditorWeaponTypesUpdateType(${w.id})">\n            <label for = "global-weapon-type-${t.id}-range-4">4</label>\n            <input type = "checkbox" id = "global-weapon-type-${t.id}-range-5" onchange = "GameEditorWeaponTypesUpdateType(${w.id})">\n            <label for = "global-weapon-type-${t.id}-range-5">5</label>\n        </div>\n    </td>\n    <td>\n        <select id = "global-weapon-type-${t.id}-default-range" class = "w2ui-input" onchange = "GameEditorWeaponTypesUpdateType(${w.id})">\n        <option value = "1">1</option>\n        <option value = "2">2</option>\n        <option value = "3">3</option>\n        <option value = "4">4</option>\n        <option value = "5">5</option>\n        </select>\n    </td>\n    <td>\n        <button class = "w2ui-btn accent" onclick = "GameEditorWeaponTypesDeleteType(${t.id})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>\n    </td>\n    `,e.appendChild(t)},window.GameEditorWeaponTypesDeleteType=e=>{if(!window.globalWeaponTypes)return;let t=window.globalWeaponsTypes[0];t.types=t.types.filter((t=>t.id!==e)),globalWeaponsTypes=window.weaponTypes,localStorage.setItem("globalWeaponsTypes",JSON.stringify(t)),document.getElementById(e).remove()},window.GameEditorWeaponTypesUpdateType=e=>{let t=e.id,i=document.getElementById(`global-weapon-type-${t}-name`).value,s=t,l=i.toLowerCase().replace(/ /g,"-"),o=[];for(let e=1;e<=5;e++)document.getElementById(`global-weapon-type-${t}-range-${e}`).checked?o.push(e):o=o.filter((t=>t!==e));let n=document.getElementById(`global-weapon-type-${t}-default-range`).value;if(!window.globalWeaponTypes)return;let a=window.globalWeaponsTypes[0];a.types=a.types.map((e=>(e.id===s&&(e.id=l,e.name=i,e.ranges=o,e.defaultRange=n),e))),window.globalWeaponsTypes=a,localStorage.setItem("globalWeaponsTypes",JSON.stringify(a))};window.GameEditorWeaponTypesPopup=()=>{let e=window.globalWeaponsTypes[0];ut=[JSON.parse(JSON.stringify(e))];let t='<div style = "overflow-y:auto;height:350px;"><table id = "weapon-types-table">',i="<tbody>";e.types.forEach((e=>{i+=`\n    <tr id = "${e.id}">\n    <td><input type = "text" class = "w2ui-input" value=${e.name} id = "global-weapon-type-${e.id}-name" onchange = "GameEditorWeaponTypesUpdateType(${e.id})"></td>\n    <td>${""===e.icon?"no icon":e.icon}</td>\n    <td>\n        <div>\n            <input type = "checkbox" onchange = "GameEditorWeaponTypesUpdateType(${e.id})" id = "global-weapon-type-${e.id}-range-1" ${e.ranges.includes(1)?"checked":""}>\n            <label for = "global-weapon-type-${e.id}-range-1">1</label>\n            <input type = "checkbox" onchange = "GameEditorWeaponTypesUpdateType(${e.id})" id = "global-weapon-type-${e.id}-range-2" ${e.ranges.includes(2)?"checked":""}>\n            <label for = "global-weapon-type-${e.id}-range-2">2</label>\n            <input type = "checkbox" onchange = "GameEditorWeaponTypesUpdateType(${e.id})" id = "global-weapon-type-${e.id}-range-3" ${e.ranges.includes(3)?"checked":""}>\n            <label for = "global-weapon-type-${e.id}-range-3">3</label>\n            <input type = "checkbox"  onchange = "GameEditorWeaponTypesUpdateType(${e.id})" id = "global-weapon-type-${e.id}-range-4" ${e.ranges.includes(4)?"checked":""}>\n            <label for = "global-weapon-type-${e.id}-range-4">4</label>\n            <input type = "checkbox" onchange = "GameEditorWeaponTypesUpdateType(${e.id})" id = "global-weapon-type-${e.id}-range-5" ${e.ranges.includes(5)?"checked":""}>\n            <label for = "global-weapon-type-${e.id}-range-5">5</label>\n        </div>\n    </td>\n    <td>\n        <select id = "global-weapon-type-${e.id}-default-range" class = "w2ui-input" onchange = "GameEditorWeaponTypesUpdateType(${e.id})">\n            <option value = "1" ${1===e.defaultRange?"selected":""}>1</option>\n            <option value = "2" ${2===e.defaultRange?"selected":""}>2</option>\n            <option value = "3" ${3===e.defaultRange?"selected":""}>3</option>\n            <option value = "4" ${4===e.defaultRange?"selected":""}>4</option>\n            <option value = "5" ${5===e.defaultRange?"selected":""}>5</option>\n        </select>\n    </td>\n    <td>\n        <button class = "w2ui-btn accent" onclick = "GameEditorWeaponTypesDeleteType(${e.id})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>\n    </td>\n    </tr>\n    `})),t+='<thead style = "font-weight:bold;margin-bottom:.5rem;text-align:center;"><tr><td>Name</td><td>Icon</td><td>Ranges</td><td>Default</td><td>Delete</td></tr>',t+="</thead>",t+=i,t+='</tbody></table><button class = "w2ui-btn" style = "margin-top:1rem;margin-bottom:1rem;" onclick = "GameEditorWeaponTypesAddType()">Add type</button></div>',s.yN.open({title:"Weapon Types",body:t,height:480,width:700,actions:["Ok","Cancel"]}).ok((e=>{document.getElementById("weapon-types-table").querySelectorAll("tr").forEach((e=>{""!==e.id&&e.id&&GameEditorWeaponTypesUpdateType(e)}));let t={...globalWeaponsTypes[0]};t.id=globalWeaponsTypes[0].id,window.updateQueue("globalWeaponsTypes","update",t),s.yN.close()})).cancel((e=>{globalWeaponsTypes=ut,s.yN.close()}))};const pt=(e,t,i,s)=>{let l=document.createElement("div"),o=e,n=document.createElement("div");n.className="Triangle-outerTriangle";let a=document.createElement("div");a.className="Triangle-innerTriangle";let r=document.createElement("select");r.multiple=!0,r.className="Triangle-box1";let d=document.createElement("select");d.className="Triangle-box2",d.multiple=!0;let h=document.createElement("select");h.className="Triangle-box3",h.multiple=!0;let c=document.createElement("div");c.className="Triangle-box4";let u=document.createElement("div");u.className="Triangle-box5";let p=document.createElement("div");p.className="Triangle-box6",c.innerHTML='<svg style = "transform:rotate(58deg)" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-move-right"><path d="M18 8L22 12L18 16"/><path d="M2 12H22"/></svg>',u.innerHTML='<svg style = "transform:rotate(-238deg)" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-move-left"><path d="M6 8L2 12L6 16"/><path d="M2 12H22"/></svg>',p.innerHTML='<svg style = "transform:rotate(180deg)" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-move-right"><path d="M18 8L22 12L18 16"/><path d="M2 12H22"/></svg>';let m={topCorner:r,leftCorner:d,rightCorner:h};Object.keys(m).forEach((e=>{let t=s.find((t=>t.el===e));if(!t)return;m[e].id=t.id,t.options.forEach((i=>{let s=document.createElement("option");s.value=i.id,s.innerText=i.text,s.selected=t.selected.includes(i.id),m[e].appendChild(s)}));let i=()=>{t.options=Array.from(m[e].children).map((e=>({id:e.value,text:e.innerText,selected:e.selected}))),t.selected=t.options.filter((e=>e.selected)).map((e=>e.id))};i(),m[e].onclick=()=>{i()}}));let g=document.createElement("style"),f=`\n    .Triangle-innerTriangle,.Triangle-outerTriangle{width:0;height:0;border-style:solid;transform:rotate(0deg)}.Triangle-outerTriangle{border-width:0 calc(50px*${o}) calc(75px*${o});border-color:transparent transparent ${i}}.Triangle-innerTriangle{position:relative;margin-left:calc(-46px*${o});top:calc(3px*${o});border-width:0 calc(46px*${o}) calc(70px*${o});border-color:transparent transparent ${t}}.Triangle-box1,.Triangle-box2,.Triangle-box3,.Triangle-box4,.Triangle-box5,.Triangle-box6{position:absolute;width:min-content;padding:1rem}.Triangle-box1{top:0;left:calc(50%);transform:translateX(-50%)}.Triangle-box2,.Triangle-box3{top:calc(75px*${o});transform:translateY(-50%)}.Triangle-box2{left:calc(${o}*-50px)}.Triangle-box3{right:calc(${o}*-50px)}.Triangle-box4{right:calc(${o}*-27px);top:calc(37.5px*${o});transform:translateY(-50%) translateX(50%)}.Triangle-box5,.Triangle-box6{transform:translateY(-50%) translateX(-50%)}.Triangle-box5{left:calc(${o}*-27px);top:calc(37.5px*${o})}.Triangle-box6{top:calc(75px*${o})}`;return g.innerText=f,l.appendChild(g),n.appendChild(a),n.appendChild(r),n.appendChild(d),n.appendChild(h),n.appendChild(c),n.appendChild(u),n.appendChild(p),l.appendChild(n),{html:l,fields:s}};window.w2popup=s.yN;window.GameEditorWeaponTrianglesPopup=()=>{globalWeaponsTypes&&0!==globalWeaponsTypes.length&&globalWeaponsTypes[0].types||(localStorage.clear(),window.location.reload());let e=document.createElement("div");e.style.height="100%",e.style.width="100%";let t=new s.Yw({name:"GameEditorWeaponMagicTrianglesPopupLayout",panels:[{type:"main",content:"main",toolbar:{items:[{type:"radio",group:"1",id:"game-editor-weapon-magic-triangles-popup-weapons",text:"Weapons",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"game-editor-weapon-magic-triangles-popup-magic",text:"Magic",class:"panel-tabs"}],onClick(e){console.log(e.target)}}}],style:"height:100%"}),i=[{id:"GameEditorWeaponTriangleFieldsTopCorner",el:"topCorner",type:"select",options:globalWeaponsTypes[0].types.map((e=>({id:e.id,text:e.name}))),selected:GameEditorWeaponTriangleFieldsTopCorner&&GameEditorWeaponTriangleFieldsTopCorner.length>0?GameEditorWeaponTriangleFieldsTopCorner:[]},{id:"GameEditorWeaponTriangleFieldsLeftCorner",el:"leftCorner",type:"select",options:globalWeaponsTypes[0].types.map((e=>({id:e.id,text:e.name}))),selected:GameEditorWeaponTriangleFieldsLeftCorner&&GameEditorWeaponTriangleFieldsLeftCorner?GameEditorWeaponTriangleFieldsLeftCorner:[]},{id:"GameEditorWeaponTriangleFieldsRightCorner",el:"rightCorner",type:"select",options:globalWeaponsTypes[0].types.map((e=>({id:e.id,text:e.name}))),selected:GameEditorWeaponTriangleFieldsRightCorner&&GameEditorWeaponTriangleFieldsRightCorner.length>0?GameEditorWeaponTriangleFieldsRightCorner:[]}],l=[{id:"GameEditorMagicTriangleFieldsTopCorner",el:"topCorner",type:"select",options:globalMagicTypes[0].types.map((e=>({id:e.id,text:e.name}))),selected:GameEditorMagicTriangleFieldsTopCorner&&GameEditorMagicTriangleFieldsTopCorner.length>0?GameEditorMagicTriangleFieldsTopCorner:[]},{id:"GameEditorMagicTriangleFieldsLeftCorner",el:"leftCorner",type:"select",options:globalMagicTypes[0].types.map((e=>({id:e.id,text:e.name}))),selected:GameEditorMagicTriangleFieldsLeftCorner&&GameEditorMagicTriangleFieldsLeftCorner?GameEditorMagicTriangleFieldsLeftCorner:[]},{id:"GameEditorMagicTriangleFieldsRightCorner",el:"rightCorner",type:"select",options:globalMagicTypes[0].types.map((e=>({id:e.id,text:e.name}))),selected:GameEditorMagicTriangleFieldsRightCorner&&GameEditorMagicTriangleFieldsRightCorner.length>0?GameEditorMagicTriangleFieldsRightCorner:[]}],o=pt(3.5,"var(--window-background)","var(--window-background-alt)",i),n=pt(3.5,"var(--window-background)","var(--window-background-alt)",l),a=o.html;t.html("main",a),t.render(e),window.GameEditorWeaponMagicTrianglesPopupLayout=t;let r=o.fields;GameEditorWeaponMagicTrianglesPopupLayout.panels[0].toolbar.items[0].onClick=()=>{let i=o.html;t.html("main",i),t.render(e),r=o.fields,t.refresh()},GameEditorWeaponMagicTrianglesPopupLayout.panels[0].toolbar.items[1].onClick=()=>{let i=n.html;t.html("main",i),t.render(e),r=n.fields,t.refresh()},s.yN.open({title:"Weapon/magic triangles",body:e,actions:["Ok","Cancel"],height:500,width:500}).ok((e=>{console.log(r),r.some((e=>0===e.selected.length))?(0,s.mJ)("All corners must have at least one type selected."):3===new Set(r.flatMap((e=>e.selected))).size?(s.yN.close(),r.forEach((e=>{window[e.id]=e.options.filter((e=>e.selected)).map((e=>e.id)),e.selected=e.options.filter((e=>e.selected)).map((e=>e.id)),console.log(e.selected)}))):(0,s.mJ)("All corners must have different types selected")})).cancel((e=>{s.yN.close()})).then((()=>{GameEditorWeaponMagicTrianglesPopupLayout.panels[0].toolbar.refresh()}))},window.w2popup=s.yN;let mt={};window.GameEditorMagicTypesAddType=()=>{let e=document.getElementById("magic-types-table"),t=document.createElement("tr");t.id=Math.floor(1e5*Math.random()),t.innerHTML=`\n    <td><input type = "text" class = "w2ui-input" value="" id = "global-magic-type-${t.id}-name" onchange = "GameEditorMagicTypesUpdateType(${w.id})"></td>\n    <td><input type = "text" class = "w2ui-input" value="" id = "global-magic-type-${t.id}-icon"></td>\n    <td>\n        <button class = "w2ui-btn accent" onclick = "GameEditorMagicTypesDeleteType(${t.id})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>\n    </td>\n    `,e.appendChild(t)},window.GameEditorMagicTypesDeleteType=e=>{if(!window.globalMagicTypes)return;let t=window.globalMagicTypes[0];t.types=t.types.filter((t=>t.id!==e)),globalMagicTypes=[t],document.getElementById(e).remove()},window.GameEditorMagicTypesUpdateType=e=>{let t=e.id,i=document.getElementById(`global-magic-type-${t}-name`).value,s=t,l=i.toLowerCase().replace(/ /g,"-");if(!window.globalMagicTypes)return;let o=window.globalMagicTypes[0];o.types=o.types.map((e=>(e.id===s&&(e.id=l,e.name=i),e))),window.globalMagicTypes=[o]};window.GameEditorMagicTypesPopup=()=>{let e=window.globalMagicTypes[0];mt=[JSON.parse(JSON.stringify(e))];let t='<div style = "overflow-y:auto;height:350px;"><table id = "magic-types-table">',i="<tbody>";e.types.forEach((e=>{i+=`\n    <tr id = "${e.id}">\n    <td><input type = "text" class = "w2ui-input" value=${e.name} id = "global-magic-type-${e.id}-name" onchange = "GameEditorMagicTypesUpdateType(${e.id})"></td>\n    <td>${""===e.icon?"no icon":e.icon}</td>\n    <td>\n        <button class = "w2ui-btn accent" onclick = "GameEditorMagicTypesDeleteType(${e.id})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>\n    </td>\n    </tr>\n    `})),t+='<thead style = "font-weight:bold;margin-bottom:.5rem;text-align:center;"><tr><td>Name</td><td>Icon</td><td>Delete</td></tr>',t+="</thead>",t+=i,t+='</tbody></table><button class = "w2ui-btn" style = "margin-top:1rem;margin-bottom:1rem;" onclick = "GameEditorMagicTypesAddType()">Add type</button></div>',s.yN.open({title:"Magic Types",body:t,height:400,width:400,actions:["Ok","Cancel"]}).ok((e=>{document.getElementById("magic-types-table").querySelectorAll("tr").forEach((e=>{""!==e.id&&e.id&&GameEditorMagicTypesUpdateType(e)}));let t={...globalMagicTypes[0]};t.id=globalMagicTypes[0].id,window.updateQueue("globalMagicTypes","update",t),s.yN.close()})).cancel((e=>{globalMagicTypes=mt,s.yN.close()}))};var gt=i(947);const ft={unitsCanHaveChildren:"Units can have children",useExperienceSublevels:"Use experience sublevels",useExperienceAptitudes:"Use experience aptitudes",combatCombatArts:"Combat arts",combatWeaponTriangle:"Weapon triangle",combatExpandedWeaponTriangle:"Expanded weapon triangle",combatMagicTriangle:"Magic triangle",combatBattalions:"Battalions",combatBattalionEndurance:"Battalion endurance",combatPairUp:"Pair up",combatAdjutants:"Adjutants",combatAdjutantHeal:"Adjutant heal",combatAdjutantGuard:"Adjutant guard",combatAdjutantAttack:"Adjutant attack",statsUseExtraStatWeight:"Use extra stat weight",statsExtraStatWeightAffectsMovement:"Extra stat weight affects movement",statsUseExtraStatLuck:"Use extra stat luck",combatSeparateCritAvoid:"Separate crit avoid",statsUseExtraStatAuthority:"Use extra stat authority",statsUseExtraStatCharm:"Use extra stat charm",statsAptitudesUseRiding:"Aptitudes use riding",statsAptitudesUseFlying:"Aptitudes use flying",statsAptitudesUseAuthority:"Aptitudes use authority",statsAptitudesUseArmor:"Aptitudes use armor",combatCombatArtLimit:"Combat art limit",combatWeaponTriangleAdvantage:"Weapon triangle advantage",combatWeaponTriangleDisadvantage:"Weapon triangle disadvantage",combatMagicTriangleAdvantage:"Magic triangle advantage",combatMagicTriangleDisadvantage:"Magic triangle disadvantage",combatBattalionLimit:"Battalion limit",unitEditorAvatarDefaultHairColor:"Avatar default hair color",unitEditorAvatarDefaultEyeColor:"Avatar default eye color",combatTriangleMapping:"Combat triangle mapping",combatMagicTriangleMapping:"Combat magic triangle mapping",globalWeaponsTypes:"Global weapons types",combatTriangleTypes:"Combat triangle types",combatNeutralTypes:"Combat neutral types",combatMagicTriangleTypes:"Combat magic triangle types",combatNeutralMagicTypes:"Combat neutral magic types",aptitudeGoals:"(Friendly/avatar) units have aptitude goals",UseWeatherOnLevels:"Use weather on levels",unitEditorAvatarDefaultSkinColor:"Avatar default skin color",unitEditorAvatarDefaultHairStyle:"Avatar default hair style"},wt={useExperienceSublevels:"Use experience sublevels",useExperienceAptitudes:"Use experience aptitudes",combatCombatArts:"Combat arts",combatWeaponTriangle:"Weapon triangle",combatExpandedWeaponTriangle:"Expanded weapon triangle",combatMagicTriangle:"Magic triangle",combatBattalions:"Battalions",combatBattalionEndurance:"Battalion endurance",combatPairUp:"Pair up",combatAdjutants:"Adjutants",statsExtraStatWeightAffectsMovement:"Extra stat weight affects movement",combatSeparateCritAvoid:"Separate crit avoid",combatWeaponTriangleAdvantage:"Weapon triangle advantage",combatWeaponTriangleDisadvantage:"Weapon triangle disadvantage",combatMagicTriangleAdvantage:"Magic triangle advantage",combatMagicTriangleDisadvantage:"Magic triangle disadvantage",combatTriangleMapping:"Combat triangle mapping",combatMagicTriangleMapping:"Combat magic triangle mapping",globalWeaponsTypes:"Global weapons types",combatTriangleTypes:"Combat triangle types",combatNeutralTypes:"Combat neutral types",combatMagicTriangleTypes:"Combat magic triangle types",combatNeutralMagicTypes:"Combat neutral magic types",UseWeatherOnLevels:"Use weather on levels"};let bt={name:"game-editor-global-fields",record:{},fields:[{type:"html",html:{html:'<h3 style = "margin-top:2rem;padding-top:.5rem;">General</h3>'}}]};bt.fields.push({field:"UseWeatherOnLevels",type:"checkbox",attr:'style="width:100%"',html:{text:wt.UseWeatherOnLevels?ft.UseWeatherOnLevels+'<sup><highlight class="tooltip" aria-label="'+wt.UseWeatherOnLevels+'" data-balloon-pos="up">?</highlight></sup>':ft.UseWeatherOnLevels,class:"no-label",style:"width:100%;",column:0}}),bt.record.UseWeatherOnLevels=window.UseWeatherOnLevels;let yt={useExperienceAptitudes:"Combat",combatAdjutantAttack:"Unit stats",statsUseExtraStatCharm:"Aptitudes"},vt={combatBattalionLimit:"Avatar defaults"},xt={unitEditorAvatarDefaultHairStyle:"Weapons"};gt.S4.forEach((e=>{bt.fields.push({field:e,type:"checkbox",attr:'style="width:100%"',html:{text:wt[e]?ft[e]+'<sup><highlight class="tooltip" aria-label="'+wt[e]+'" data-balloon-pos="up">?</highlight></sup>':ft[e],class:"no-label",style:"width:100%;",column:0}}),bt.record[e]=window[e],yt[e]&&bt.fields.push({type:"html",html:{html:`<h3 style = "margin-top:2rem;padding-top:.5rem;">${yt[e]}</h3>`,class:"no-label",column:0}})})),bt.fields.push({type:"html",html:{html:'<h3 style = "margin-top:2rem;padding-top:.5rem;">Combat</h3>',class:"no-label",column:1}}),gt.mp.forEach((e=>{bt.fields.push({field:e,type:"int",html:{text:wt[e]?ft[e]+'<sup><highlight class="tooltip" aria-label="'+wt[e]+'" data-balloon-pos="up">?</highlight></sup>':ft[e],class:"no-label",column:1}}),bt.record[e]=window[e],vt[e]&&bt.fields.push({type:"html",html:{html:`<h3 style = "margin-top:2rem;padding-top:.5rem;">${vt[e]}</h3>`,class:"no-label",column:1}})})),gt.P$.forEach((e=>{bt.fields.push({field:e,type:"text",html:{text:wt[e]?ft[e]+'<sup><highlight class="tooltip" aria-label="'+wt[e]+'" data-balloon-pos="up">?</highlight></sup>':ft[e],class:"no-label",column:1}}),bt.record[e]=window[e],xt[e]&&bt.fields.push({type:"html",html:{html:`<h3 style = "margin-top:2rem;padding-top:.5rem;">${xt[e]}</h3>`,class:"no-label",column:1}})})),bt.fields.push({type:"html",html:{html:'<button class="w2ui-btn accent big" onclick="window.GameEditorWeaponTypesPopup()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-swords"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" x2="9" y1="14" y2="18"/><line x1="7" x2="4" y1="17" y2="20"/><line x1="3" x2="5" y1="19" y2="21"/></svg>Weapon types</button>',column:1}}),bt.fields.push({type:"html",html:{html:'<button class="w2ui-btn accent big" onclick="window.GameEditorMagicTypesPopup()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/><path d="M20 3v4"/><path d="M22 5h-4"/><path d="M4 17v2"/><path d="M5 18H3"/></svg>Magic types</button>',column:1}}),bt.fields.push({field:"weaponTrianglesButton",type:"html",html:{html:'<button class="w2ui-btn accent big" onclick="window.GameEditorWeaponTrianglesPopup()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle"><path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/></svg>Weapon/magic triangles</button>',class:"no-label",column:1},hidden:!1});let kt=new s.sk(bt);window.GameEditorGlobalFields=kt,kt.on("change",(function(e){((e,t)=>{"combatAdjutants"===e.detail.field&&!0===e.detail.value.current&&!0===t.record.combatPairUp?((0,s.mJ)("You cannot have combat adjutants and pair up. Pair up has been disabled."),t.record.combatPairUp=!1,t.record.combatAdjutantHeal=!0,t.record.combatAdjutantAttack=!0,t.record.combatAdjutantGuard=!0,t.refresh()):"combatPairUp"===e.detail.field&&!0===e.detail.value.current&&!0===t.record.combatAdjutants?((0,s.mJ)("You cannot have combat adjutants and pair up. Combat adjutants have been disabled."),t.record.combatAdjutants=!1,t.record.combatAdjutantHeal=!1,t.record.combatAdjutantAttack=!1,t.record.combatAdjutantGuard=!1,t.refresh()):"combatWeaponTriangle"===e.detail.field&&(!0===e.detail.value.current?(t.show("combatExpandedWeaponTriangle"),t.show("combatMagicTriangle"),t.show("weaponTrianglesButton")):(t.hide("combatExpandedWeaponTriangle"),t.hide("combatMagicTriangle"),t.hide("weaponTrianglesButton"))),window[e.detail.field]=e.detail.value.current,(0,gt.iH)(),window.updateQueue("generalSettings","update",t.record),window.updateQueue("CombatExtras","update",t.record)})(e,kt)}));const Ct=kt;window.newUserOnboardingGameDetails="true"===sessionStorage.getItem("newUserOnboardingGameDetails"),sessionStorage.getItem("newUserOnboardingGameDetails")||(sessionStorage.setItem("newUserOnboardingGameDetails",!0),window.newUserOnboardingGameDetails=!0),window.gameEditorGameDetailsFinishInitialAndNext=()=>{let e=s.GB.GameEditor,t=s.GB["game-editor-bottom-toolbar"];t.show("game-editor-bottom-toolbar-game-settings"),t.show("game-editor-bottom-toolbar-assets"),t.show("game-editor-bottom-toolbar-build-and-export"),t.click("game-editor-bottom-toolbar-game-settings");let i=s.GB.EditorWindowStatusBar;i.set("status-bar-project-status",{text:"game details saved"}),setTimeout((()=>{i.set("status-bar-project-status",{text:""}),i.hide("status-bar-project-status")}),5e3),e.html("main",Ct);let l=s.GB.EditorWindowSidebar;l.get("sidebar-editors-list").nodes.forEach((e=>{l.enable(e.id)})),window.newUserOnboardingGameDetails&&((0,s.mJ)('<p>You can now access the other editors in the left sidebar, as well as more advanced game settings. Please see <a href = "https://docs.turnroot.com/getting-started/your-first-hour-in-the-turnroot-editor" style = "display:inline;color:var(--accent)">your first hour</a> for a guided tour on what to do next and where everything is.</p> <div style = "height:2rem;"/>',"<h3>Game details saved</h3>"),window.newUserOnboardingGameDetails=!1,sessionStorage.setItem("newUserOnboardingGameDetails",!1))};let _t=new s.sk({name:"gameEditorRequiredGameDetails",record:{gameDifficulty:["Normal","Easy","Hard"],gameMode:["Casual","Classic"],gameAuthorDisplayName:"Game Creator: your username\nGame Artist: a username\nGame Musician: another username\nGame Designer: yet another username\nGame Tester: a fifth username\n"},fields:[{type:"html",html:{html:"<h2>Basic Game Details</h2><p>You must fill out these fields before any other editors are available.</p>",style:"text-align:left;font-size:150%;overflow:hidden;margin:auto;margin-bottom:2rem;"}},{field:"gameName",type:"text",required:!0,html:{label:"Game Name",attr:'style="width: 100%;font-size:150%;"',class:"emphasized-field full-width-field"}},{field:"gameSubtitle",type:"text",required:!0,html:{label:"Game Subtitle",attr:'style="width: 100%;font-size:150%;"',class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<p style = "width:100%;max-width:100%!important;">The game subtitle is for long, multi-part titles<sup aria-label="Say you wanted to name your game something like Icy Shield: Lineage of the Evil War - Heirs of Photonic Rays.  \'Heirs of Photonic Rays\' would be your subtitle" data-balloon-length="large" data-balloon-pos="up"><highlight>?</highlight></sup>. A subtitle is optional.</p>',class:"full-width-field"}},{field:"gameDescription",type:"text",required:!0,html:{label:"Description",attr:'style="width: 100%;"',class:"emphasized-field full-width-field"}},{field:"gameAuthorDisplayName",type:"textarea",required:!0,html:{label:"Game Creator Credits",attr:'style="width: 100%;"',class:"emphasized-field full-width-field"}},{type:"html",html:{html:"<p style = \"width:100%;max-width:100%!important;\">Put one credit per line. If you're not sure of all credits yet, that's fine, just list yourself. You can edit this later.</small>",class:"full-width-field"}},{type:"file",field:"gameIcon",required:!1,html:{label:"Game Icon",class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<p style = "width:100%;max-width:100%!important;">The game icon should be a square image, at least 200px on each side. If you don\'t provide one, a default will be used. You can replace this later.</p>',class:"full-width-field"}},{type:"checks",field:"gameDifficulty",required:!0,options:{items:["Beginner","Easy","Normal","Hard","Insane","Maddening"]},html:{label:"Game Difficulties",class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<p style = "width:100%;max-width:100%!important;"><highlight>Important!</highlight> When working on units or other game components, you will have the option to change things by difficulty (i.e., add reinforcements to a level on Hard or above), but the base stats, growth rates, etc, you will be setting are for Normal difficulty.<sup aria-label="You can set scalars that impact these stats for different difficulty levels- just bear in mind that if, for example, you\'re using stats on a wiki for an existing game as a guide, you should use the Normal stats." data-balloon-length="large" data-balloon-pos="up"><highlight>so...?</highlight></sup></p>'}},{type:"checks",field:"gameMode",required:!0,options:{items:["Casual","Classic","Casual (Lose Items)","Casual (Stat Penalty)"]},html:{label:"Game Modes",class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<ul><li>Casual: "dead" units retreat and rejoin you in the next battle</li><li>Classic: dead units are gone forever</li><li>Casual (Lose Items): "dead" units retreat and rejoin, but lose their inventory at time of death</li><li>Casual (Stat Penalty): "dead" units retreat and rejoin, but come back with lowered stats.</li></ul>',class:"full-width-field"}},{type:"html",html:{html:'<div><p>When you\'re happy with the settings above, click Next to move on to more advanced game settings. Clicking Next will also unlock the other editors.</p><button class="w2ui-btn" onclick="window.gameEditorGameDetailsFinishInitialAndNext()" style="width:100%;font-size:150%;">Next</button></div>'}}]});_t.on("change",(function(e){((e,t)=>{console.log(e),window[e.detail.field]=e.detail.value.current,(0,gt.iH)(),window.updateQueue("gameDetails","update",t.record)})(e,_t)})),window.GameEditorRequiredGameDetails=_t;const Et=_t;let St=new s.Hs({name:"game-editor-bottom-toolbar",items:[{type:"radio",group:"1",id:"game-editor-bottom-toolbar-game-details",text:"Game details",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"game-editor-bottom-toolbar-game-settings",text:"Game settings",class:"panel-tabs",hidden:!0},{type:"radio",group:"1",id:"game-editor-bottom-toolbar-assets",text:"Assets",class:"panel-tabs",hidden:!0},{type:"radio",group:"1",id:"game-editor-bottom-toolbar-build-and-export",text:"Build and export",class:"panel-tabs",hidden:!0}]});St.on("click",(function(e){e.done((()=>{((e,t)=>{window.turnrootEditorLogs.push(`${new Date}||info||GameEditor bottom toolbar button clicked: ${e.detail.item.id}`);let i=s.GB.GameEditor;"game-editor-bottom-toolbar-game-details"===e.detail.item.id?i.html("main",Et):"game-editor-bottom-toolbar-game-settings"===e.detail.item.id&&i.html("main",Ct)})(e)}))})),St.on("render",(function(e){!1===window.newUserOnboardingGameDetails&&(St.show("game-editor-bottom-toolbar-game-settings"),St.show("game-editor-bottom-toolbar-assets"),St.show("game-editor-bottom-toolbar-build-and-export"))}));const Tt=St;let $t=new s.Yw({name:"GameEditor",panels:[{type:"main",content:"main",html:Et},{type:"bottom",size:30,resizable:!1,content:"bottom",html:Tt,style:"overflow-y: hidden;"}]});$t.on("render",(async function(e){window.globalWeaponsTypes&&0!==window.globalWeaponsTypes.length&&window.globalWeaponsTypes[0].types||(window.globalWeaponsTypes=await(async()=>{console.log("getting all weapon types");let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queue:[{model:"globalWeaponsTypes",method:"get"}]})},t=await fetch("http://localhost:26068/data",e).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));return t.ok?t.json():[]})()),window.globalMagicTypes&&0!==window.globalMagicTypes.length&&window.globalMagicTypes[0].types||(window.globalMagicTypes=await(async()=>{console.log("getting all magic types");let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queue:[{model:"globalMagicTypes",method:"get"}]})},t=await fetch("http://localhost:26068/data",e).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));return t.ok?t.json():[]})()),window.globalGameDetails?(window.GameEditorRequiredGameDetails.record=window.globalGameDetails[0],window.GameEditorRequiredGameDetails.refresh()):(window.globalGameDetails=await(async()=>{console.log("getting game details");let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queue:[{model:"gameDetails",method:"get"}]})},t=await fetch("http://localhost:26068/data",e).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));return t.ok?t.json():[]})(),window.GameEditorRequiredGameDetails.record=window.globalGameDetails[0],window.GameEditorRequiredGameDetails.refresh()),window.globalGeneralSettings||(window.globalGeneralSettings=await(async()=>{console.log("getting game general settings");let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queue:[{model:"generalSettings",method:"get"}]})},t=await fetch("http://localhost:26068/data",e).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));return t.ok?t.json():[]})(),window.globalGeneralSettings.forEach((e=>{window[e.setting]=e.value,window.GameEditorGlobalFields.record[e.setting]=e.value})),window.GameEditorGlobalFields.refresh())}));const At=$t;let jt=new s.sk({name:"object-editor-basic-fields",record:{subtype:"Weapon",id:""},fields:[{type:"html",html:{html:'<hr style = "margin-top:.5rem;margin-bottom:.5rem;"/>'}},{type:"text",field:"name",html:{label:"Name"}},{type:"text",field:"flavorText",html:{label:"Flavor Text"}},{type:"html",html:{html:'<button id = "IconPicker-button" onclick = "window.showObjectEditorBasicFieldsIconPicker(event)" class = "w2ui-btn" style = "width:100%;margin-top:1rem;">Select Icon</button>\n                <script>\n                    window.showObjectEditorBasicFieldsIconPicker = async (event) => {\n                        window.IconPicker.coords = {x: event.clientX, y: event.clientY - 200}\n                        window.IconPicker.show()\n                        let result = await window.IconPicker.icon()\n                        window.objectEditorBasicFields.record.icon = result\n                        let iconButton = document.getElementById(\'IconPicker-button\')\n                        iconButton.innerText = \'Icon Selected: \' + result.name\n                        return result\n                    }\n                <\/script>\n                '}}]});jt.on("change",(e=>{((e,t,i=!1)=>{let s=t.detail.field,l=t.detail.value.current;window.currentObject[s]=l,e.record[s]=l,e.refresh(),window.updateQueue("Object","updateSubtype",e.record)})(jt,e)})),jt.updateGlobals=()=>{jt.refresh()},window.objectEditorBasicFields=jt,jt.updateGlobals();const Mt=jt;let Ot=e=>e.charAt(0).toUpperCase()+e.slice(1);const It=async e=>{window.currentObject=e,window.currentObject&&void 0!==window.currentObject?(console.log("updating current object record ",e.id),window.objectEditorBasicFields.record.name=window.currentObject.name,window.objectEditorBasicFields.record.subtype=window.currentObject.subtype,window.objectEditorBasicFields.record.flavorText=window.currentObject.flavorText,window.objectEditorUsageFields.record.hasUses=window.currentObject.hasUses,window.objectEditorUsageFields.record.maxUses=window.currentObject.maxUses,window.objectEditorUsageFields.record.minAptitude=window.currentObject.minAptitude,window.objectEditorUsageFields.record.weaponType=window.currentObject.weaponType,window.objectEditorUsageFields.record.magicType=window.currentObject.magicType,window.objectEditorUsageFields.record.scope=window.currentObject.scope,window.objectEditorUsageFields.record.replenishUsesAfterBattleAmount=window.currentObject.replenishUsesAfterBattleAmount,window.objectEditorUsageFields.record.lowerRange=window.currentObject.lowerRange,window.objectEditorUsageFields.record.upperRange=window.currentObject.upperRange,window.objectEditorUsageFields.record.rangeAdjustedByStat=window.currentObject.rangeAdjustedByStat,window.objectEditorUsageFields.record.rangeAdjustedByStatName=window.currentObject.rangeAdjustedByStatName,window.objectEditorUsageFields.record.rangeAdjustedByDivisor=window.currentObject.rangeAdjustedByDivisor,window.objectEditorValueFields.record.buyable=window.currentObject.buyable,window.objectEditorValueFields.record.sellable=window.currentObject.sellable,window.objectEditorValueFields.record.buyPrice=window.currentObject.buyPrice,window.objectEditorValueFields.record.sellPrice=window.currentObject.sellPrice,window.objectEditorValueFields.record.sellPriceDeductedPerUse=window.currentObject.sellPriceDeductedPerUse,"Gift"===window.currentObject.subtype?window.objectEditorValueFields.hide("sellPriceDeductedPerUse"):window.objectEditorValueFields.show("sellPriceDeductedPerUse"),"Weapon"===window.currentObject.subtype?(window.objectEditorUsageFields.hide("magicType"),window.objectEditorUsageFields.hide("magicTypeDescription"),window.objectEditorUsageFields.show("weaponType"),window.objectEditorUsageFields.show("weaponTypeDescription"),window.objectEditorUsageFields.show("hasUses"),window.objectEditorUsageFields.show("minAptitude"),window.objectEditorUsageFields.hide("scope"),window.objectEditorUsageFields.show("replenishUsesAfterBattleAmount"),window.objectEditorUsageFields.hide("scopeDescription"),window.objectEditorUsageFields.show("replenishUsesAfterBattleAmountDescription"),window.objectEditorUsageFields.show("lowerRange"),window.objectEditorUsageFields.show("upperRange"),window.objectEditorUsageFields.show("rangeAdjustedByDivisor"),window.objectEditorUsageFields.show("rangeAdjustedByStatName"),window.objectEditorUsageFields.show("rangeAdjustedByStat"),window.objectEditorUsageFields.record.hasUses?window.objectEditorUsageFields.show("maxUses"):window.objectEditorUsageFields.hide("maxUses"),window.objectEditorUsageFields.record.minAptitude=window.currentObject.minAptitude,window.objectEditorUsageFields.record.weaponType=Ot(window.currentObject.weaponType),window.objectEditorUsageFields.get("weaponType").options.items=window.globalWeaponsTypes[0].types.map((e=>e.name))):"Magic"===window.currentObject.subtype?(window.objectEditorUsageFields.hide("weaponType"),window.objectEditorUsageFields.show("magicType"),window.objectEditorUsageFields.show("hasUses"),window.objectEditorUsageFields.show("minAptitude"),window.objectEditorUsageFields.hide("scope"),window.objectEditorUsageFields.show("replenishUsesAfterBattleAmount"),window.objectEditorUsageFields.hide("scopeDescription"),window.objectEditorUsageFields.show("replenishUsesAfterBattleAmountDescription"),window.objectEditorUsageFields.show("lowerRange"),window.objectEditorUsageFields.show("upperRange"),window.objectEditorUsageFields.show("rangeAdjustedByDivisor"),window.objectEditorUsageFields.show("rangeAdjustedByStatName"),window.objectEditorUsageFields.show("rangeAdjustedByStat"),window.objectEditorUsageFields.record.hasUses?window.objectEditorUsageFields.show("maxUses"):window.objectEditorUsageFields.hide("maxUses"),window.objectEditorUsageFields.hide("weaponTypeDescription"),window.objectEditorUsageFields.show("magicTypeDescription"),window.objectEditorUsageFields.record.minAptitude=window.currentObject.minAptitude,window.objectEditorUsageFields.record.magicType=Ot(window.currentObject.magicType),window.objectEditorUsageFields.get("magicType").options.items=window.globalMagicTypes[0].types.map((e=>e.name))):(window.objectEditorUsageFields.hide("weaponType"),window.objectEditorUsageFields.hide("magicType"),window.objectEditorUsageFields.hide("weaponTypeDescription"),window.objectEditorUsageFields.hide("magicTypeDescription"),window.objectEditorUsageFields.hide("minAptitude"),window.objectEditorUsageFields.show("scope"),window.objectEditorUsageFields.show("scopeDescription"),window.objectEditorUsageFields.hide("lowerRange"),window.objectEditorUsageFields.hide("upperRange"),window.objectEditorUsageFields.hide("rangeAdjustedByDivisor"),window.objectEditorUsageFields.hide("rangeAdjustedByStatName"),window.objectEditorUsageFields.hide("rangeAdjustedByStat"),window.objectEditorUsageFields.record.hasUses?(window.objectEditorUsageFields.show("replenishUsesAfterBattleAmount"),window.objectEditorUsageFields.show("replenishUsesAfterBattleAmountDescription")):(window.objectEditorUsageFields.hide("replenishUsesAfterBattleAmount"),window.objectEditorUsageFields.hide("replenishUsesAfterBattleAmountDescription"))),"Consumable"===window.currentObject.subtype&&(window.objectEditorUsageFields.hide("hasUses"),window.objectEditorUsageFields.record.hasUses=!0,window.objectEditorUsageFields.show("maxUses")),window.currentObject.rangeAdjustedByStat?(window.objectEditorUsageFields.show("rangeAdjustedByStatName"),window.objectEditorUsageFields.show("rangeAdjustedByDivisor"),window.objectEditorUsageFields.hide("lowerRange"),window.objectEditorUsageFields.hide("upperRange")):(window.objectEditorUsageFields.hide("rangeAdjustedByStatName"),window.objectEditorUsageFields.hide("rangeAdjustedByDivisor"),window.objectEditorUsageFields.show("lowerRange"),window.objectEditorUsageFields.show("upperRange")),window.objectEditorBasicFields.refresh()):console.log("no object to update")};let Dt=new s.kf({name:"ObjectEditorLeft",flatButton:!1,nodes:[{id:"weapons",text:"Weapons",expanded:!0,group:!0,groupShowHide:!0,nodes:[]},{id:"magic",text:"Magic",expanded:!0,group:!0,groupShowHide:!0,nodes:[]},{id:"consumables",text:"Consumables",expanded:!0,group:!0,groupShowHide:!0,nodes:[]},{id:"equipables",text:"Equipables",expanded:!0,group:!0,groupShowHide:!0,nodes:[]},{id:"gifts",text:"Gifts",expanded:!0,group:!0,groupShowHide:!0,nodes:[]}]});window.ObjectEditorLeftSidebar=Dt,Dt.on("click",(function(e){e.done((()=>{let t=Dt.get(e.target);switch(window.currentObject=window.allObjects.all.find((e=>e.id===t.id)),console.log("current object",window.currentObject,window.allObjects),s.GB["object-editor-bottom-toolbar"].click("object-editor-bottom-toolbar-basic"),It(window.currentObject),window.currentObject.subtype){case"Consumable":case"Equipable":case"Magic":window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-basic"),window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-usage"),window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-value"),window.ObjectEditorBottomToolbar.hide("object-editor-bottom-toolbar-forgerepair"),window.ObjectEditorBottomToolbar.hide("object-editor-bottom-toolbar-gift");break;case"Gift":window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-basic"),window.ObjectEditorBottomToolbar.hide("object-editor-bottom-toolbar-usage"),window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-value"),window.ObjectEditorBottomToolbar.hide("object-editor-bottom-toolbar-forgerepair"),window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-gift");break;case"Weapon":window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-basic"),window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-usage"),window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-value"),window.ObjectEditorBottomToolbar.show("object-editor-bottom-toolbar-forgerepair"),window.ObjectEditorBottomToolbar.hide("object-editor-bottom-toolbar-gift")}window.objectEditorBasicFields.record.id=window.currentObject.id,t.selected=!0,Dt.nodes.forEach((e=>{e.id!==t.id&&(e.selected=!1)})),Dt.refresh()}))}));const Rt=Dt;let zt=new Date,Ft=!1;const Nt=async()=>{console.log("getting all objects");let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queue:[{model:"Object",method:"getObjects"}]})},t=new Date;if(t-zt<1e4&&!0===Ft)return window.allObjects?window.allObjects:{objectWeapons:[],objectConsumables:[],objectEquipables:[],objectGifts:[],all:[]};let i=await fetch("http://localhost:26068/data",e).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));if(!i.ok)return{objectWeapons:[],objectConsumables:[],objectEquipables:[],objectGifts:[],objectMagic:[],all:[]};{let e=await i.json(),s={all:e,objectWeapons:[],objectConsumables:[],objectEquipables:[],objectGifts:[],objectMagic:[]};zt=t,Ft=!0,console.log(s);try{return e.forEach((e=>{"Weapon"===e.subtype?s.objectWeapons.push(e):"Consumable"===e.subtype?s.objectConsumables.push(e):"Equipable"===e.subtype?s.objectEquipables.push(e):"Gift"===e.subtype?s.objectGifts.push(e):"Magic"===e.subtype&&s.objectMagic.push(e)})),s}catch(e){return console.error(e),{objectWeapons:[],objectConsumables:[],objectEquipables:[],objectGifts:[],objectMagic:[],all:[]}}}},Lt=e=>{console.log("updating sidebar",e);try{e.remove(),e.nodes=[{id:"weapons",text:"Weapons",expanded:!0,group:!0,groupShowHide:!0,nodes:window.allObjects.objectWeapons.map((e=>({id:e.id,text:e.name+" ("+e.id+")"})))},{id:"magic",text:"Magic",expanded:!0,group:!0,groupShowHide:!0,nodes:window.allObjects.objectMagic.map((e=>({id:e.id,text:e.name+" ("+e.id+")"})))},{id:"consumables",text:"Consumables",expanded:!0,group:!0,groupShowHide:!0,nodes:window.allObjects.objectConsumables.map((e=>({id:e.id,text:e.name+" ("+e.id+")"})))},{id:"equipables",text:"Equipables",expanded:!0,group:!0,groupShowHide:!0,nodes:window.allObjects.objectEquipables.map((e=>({id:e.id,text:e.name+" ("+e.id+")"})))},{id:"gifts",text:"Gifts",expanded:!0,group:!0,groupShowHide:!0,nodes:window.allObjects.objectGifts.map((e=>({id:e.id,text:e.name+" ("+e.id+")"})))}],console.log(e.nodes)}catch(e){console.error(e)}};window.ObjectEditorCreateNewObject=async(e,t)=>{console.log("creating new object");let i={};i.name=e,i.subtype=t,i.queue=[{model:"Object",method:"create"}],console.log(i);let s={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)},l=await fetch("http://localhost:26068/data",s).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));if(l.ok){let e=await l.json();return console.log(e),e}return w2alert("Error: invalid response from schemas server")},window.ObjectEditorDeleteObject=async e=>{console.log("deleting object");let t={};t.queue=[{model:"Object",method:"delete",id:e}],console.log(t);let i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},s=await fetch("http://localhost:26068/data",i).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));if(s.ok){let e=await s.json();return console.log(e),e}return w2alert("Error: invalid response from schemas server")};let Bt=new s.Hs({name:"ObjectEditorTopMenu",tooltip:"bottom",items:[{type:"button",id:"new-object-weapon",text:"New Weapon",class:"w2ui-btn accent",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"button",id:"new-object-magic",text:"New Magic",class:"w2ui-btn accent",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"button",id:"new-object-equipable",text:"New Equipable",class:"w2ui-btn accent",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"button",id:"new-object-gift",text:"New Gift",class:"w2ui-btn accent",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"button",id:"new-object-consumable",text:"New Consumable",class:"w2ui-btn accent",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"label",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>',id:"types-help",tooltip:"Click to read about the different object types"},{type:"spacer"},{type:"button",id:"delete-object",text:"Delete object",class:"w2ui-btn slider1",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>'}]});Bt.on("click",(function(e){e.done((async()=>{if("types-help"===e.detail.item.id)s.yN.open({title:"Object types",body:'<div style = "overflow-y:auto;height:100%;">\n                <h4 style = "margin-top:.5rem">Weapon</h4>\n                <p>Weapons are objects units use during combat to Attack. The most self-explanatory item type.</p>\n                <h4 style = "margin-top:.5rem">Magic</h4>\n                <p>Magic objects are used during combat to Heal, Attack, Assist, or Warp. Even if your game has a skill-based magic system, where magic does not have a set number of uses, it\'s still considered an object.</p>\n                <h4 style = "margin-top:.5rem">Consumable</h4>\n                <p>Consumables are objects that can be Used once or a certain number of times, then disappear. They can be used during combat or outside of combat. This includes objects like healing potions, cooking ingredients, class change seals, edible stat growth items, etc.</p>\n                <h4 style = "margin-top:.5rem">Equipable</h4>\n                <p>Equipables are objects that can be Equipped to a unit to provide stat boosts, skills, or other effects. This includes objects like shields, magic staffs, rings, etc. Equipables do not have uses and are not actively Used- they provide passive benefits.</p>\n                <h4 style = "margin-top:.5rem">Gift</h4>\n                <p>Gifts are objects that can be given to other units. This includes objects like flowers, food, lost items, etc. <highlight>Note:</highlight> if you\'ve disabled gift options globally in your game settings, you cannot make an object a gift.</p>\n                </div>\n                ',width:"700",height:"600",actions:["Ok"]}).ok((()=>{s.yN.close()}));else if("delete-object"===e.detail.item.id){if(0===window.allObjects.length)return(0,s.mJ)("No objects to delete");let e=window.currentObject;(0,s.mW)({title:"Delete object",body:`Are you sure you want to delete ${e.name}?`,width:300,height:200}).yes((async()=>{It(window.currentObject),"Weapon"===window.currentObject.subtype?window.allObjects.objectWeapons=window.allObjects.objectWeapons.filter((t=>t.id!==e.id)):"Consumable"===window.currentObject.subtype?window.allObjects.objectConsumables=window.allObjects.objectConsumables.filter((t=>t.id!==e.id)):"Equipable"===window.currentObject.subtype?window.allObjects.objectEquipables=window.allObjects.objectEquipables.filter((t=>t.id!==e.id)):"Gift"===window.currentObject.subtype&&(window.allObjects.objectGifts=window.allObjects.objectGifts.filter((t=>t.id!==e.id))),window.allObjects.all=window.allObjects.all.filter((t=>t.id!==e.id)),Lt(window.ObjectEditorLeftSidebar),window.ObjectEditor.refresh(),window.ObjectEditorLeftSidebar.refresh(),await window.ObjectEditorDeleteObject(e.id).catch((e=>(0,s.mJ)("Error deleting object")))}))}else{let i=(t=e.detail.item.id.split("-")[2]).charAt(0).toUpperCase()+t.slice(1);console.log(i),(0,s.iX)({title:"Create new object",label:"Enter the name of your object. This name will be used to identify the object in the editor. It doesn't have to be unique."}).ok((async e=>{""===e.detail.value?e.preventDefault():(Nt().then((e=>{window.allObjects=e})),await window.ObjectEditorCreateNewObject(e.detail.value,i).then((e=>(window.ObjectEditor.html("main",window.objectEditorBasicFields),"Weapon"===e.subtype?window.allObjects.objectWeapons.push(e):"Consumable"===e.subtype?window.allObjects.objectConsumables.push(e):"Equipable"===e.subtype?window.allObjects.objectEquipables.push(e):"Gift"===e.subtype?window.allObjects.objectGifts.push(e):"Magic"===e.subtype&&window.allObjects.objectMagic.push(e),window.allObjects.all.push(e),window.currentObject=e,It(e),Lt(window.ObjectEditorLeftSidebar),window.ObjectEditor.refresh(),window.ObjectEditorLeftSidebar.refresh(),(0,s.mJ)("New object created")))).catch((e=>{console.error(e)})))}))}var t}))}));const Ht=Bt,Ut=(e,t,i=!1)=>{let s=t.detail.field,l=t.detail.value.current;window.objectEditorBasicFields.record.subtype,window.currentObject[s]=l,e.record[s]=l,"upperRange"===s?l<window.currentObject.lowerRange&&(w2alert("Upper range must be greater than lower range"),window.currentObject.upperRange=window.currentObject.lowerRange,window.objectEditorUsageFields.record.upperRange=window.currentObject.lowerRange,window.objectEditorUsageFields.refresh()):"lowerRange"===s?l>window.currentObject.upperRange&&(w2alert("Lower range must be less than upper range"),window.currentObject.lowerRange=window.currentObject.upperRange,window.objectEditorUsageFields.record.lowerRange=window.currentObject.upperRange,window.objectEditorUsageFields.refresh()):"rangeAdjustedByStat"===s&&(l?(window.objectEditorUsageFields.show("rangeAdjustedByStatName"),window.objectEditorUsageFields.show("rangeAdjustedByDivisor"),window.objectEditorUsageFields.hide("lowerRange"),window.objectEditorUsageFields.hide("upperRange")):(window.objectEditorUsageFields.hide("rangeAdjustedByStatName"),window.objectEditorUsageFields.hide("rangeAdjustedByDivisor"),window.objectEditorUsageFields.show("lowerRange"),window.objectEditorUsageFields.show("upperRange"))),window.updateQueue("Object","updateObject",window.currentObject)};let Pt={name:"object-editor-usage-fields",record:{},fields:[{type:"html",html:{html:"<h2>Uses</h2>",column:0}},{type:"checkbox",field:"hasUses",checked:!0,html:{label:"Has uses (durability)",class:"emphasized-field",column:0}},{type:"number",field:"maxUses",html:{label:"Max uses (durability)",column:0}},{type:"html",html:{html:"<h2>Types</h2>",column:1}},{field:"minAptitude",type:"select",options:{items:["E","D","C","B","A","S"]},html:{label:"Minimum Aptitude",attr:'style="width: 100%;"',column:1}},{type:"html",field:"minAptitudeDescription",html:{class:"no-label",html:"<small>A unit must have this level or higher of aptitude with the weapon type to use this weapon.</small>",column:1}},{field:"weaponType",type:"select",options:{items:window.globalWeaponsTypes[0].types.map((e=>e.name))},html:{label:"Weapon Type",column:1}},{field:"magicType",type:"select",hidden:!0,options:{items:window.globalMagicTypes[0].types.map((e=>e.name))},html:{label:"Magic Type",column:1}},{type:"html",field:"weaponTypeDescription",html:{class:"no-label",html:'<small>The type of weapon this item is.<sup aria-label="You can set weapon types in the Project editor." data-balloon-pos="up"><highlight>What if the types are wrong?</highlight></sup></small>',column:1}},{type:"html",field:"magicTypeDescription",html:{class:"no-label",html:'<small>The type of magic this item is.<sup aria-label="You can set magic types in the Project editor." data-balloon-pos="up"><highlight>What if the types are wrong?</highlight></sup></small>',column:1}},{type:"html",html:{html:"<h2>Specifics</h2>",column:0}},{field:"scope",type:"select",options:{items:["combat","map","both"]},html:{label:"Scope",class:"full-width",column:0,attr:'style="width: 100%;"'}},{type:"html",field:"scopeDescription",html:{html:"<small>Some items can be used in or out of combat, some can be used in one or the other. If you're unsure, leave it at 'both'.</small>",column:0}},{field:"replenishUsesAfterBattleAmount",type:"select",options:{items:["none","full","half","quarter"]},html:{label:"Replenish uses after battle",column:0}},{type:"html",field:"replenishUsesAfterBattleAmountDescription",html:{class:"no-label",html:'<small>If applicable, you can set an item to regenerate uses after battle. None is standard behavior- uses are not regenerated. Full regenerates the item to full max uses. Half/quarter regenerates half/quarter the used uses per battle.<sup data-balloon-length="large" data-balloon-pos="bottom" aria-label = "I.e., a weapon with 20 uses that lost 8 durability during battle (12/20) would regenerate 4 durability (16/20) with half or 2 (14/20) with quarter. If you wanted magic to regenerate fully after each battle, you\'d set Full for your magic objects."><highlight>?</highlight></sup></small>',column:0}},{type:"html",field:"combatHeading",html:{html:"<h2>Combat</h2>",class:"no-label"}},{field:"rangeAdjustedByStat",type:"checkbox",html:{label:'Range set by a stat<sup aria-label="For example, if you want your long-distance Heal magic to have a range of Mag/4, you would turn this on." data-balloon-pos="right" data-ballooon-size="large"><highlight>?</highlight></sup>',class:"emphasized-field",column:0}},{field:"rangeAdjustedByStatName",type:"select",options:{items:["Magic","Strength","Defense","Speed","Resistance","HP"]},hidden:!0,html:{label:" Which stat? ",column:0}},{field:"rangeAdjustedByDivisor",type:"select",hidden:!0,options:{items:[1,2,3,4,5]},html:{label:"Upper range is stat divided by ",column:0}},{type:"select",options:{items:[1,2]},field:"lowerRange",html:{label:"Range: from ",text:"%attach1%",column:0}},{type:"select",options:{items:[1,2,3,4,5,6,7,8,9,10]},field:"upperRange",html:{anchor:"%attach1%",label:"to ",column:0}},{type:"html",field:"effectsHeader",html:{html:"<h2>Effects</h2>",class:"no-label",column:1}}]},Wt=new s.sk(Pt);Wt.on("change",(e=>{Ut(Wt,e)})),Wt.updateGlobals=()=>{Wt.refresh()},window.objectEditorUsageFields=Wt,Wt.updateGlobals();const Gt=Wt;let qt=new s.sk({name:"object-editor-value-fields",record:{buyable:!0,sellable:!0,buyPrice:100,sellPrice:75,sellPriceDeductedPerUse:2},fields:[{type:"html",html:{html:"<h2>Buy/Sell</h2>"}},{type:"checkbox",field:"buyable",checked:!0,class:"emphasized-field",html:{label:"Can be bought",text:"%attach2%"}},{type:"checkbox",field:"sellable",checked:!0,class:"emphasized-field",html:{label:" Can be sold ",anchor:"%attach2%"}},{type:"number",field:"buyPrice",html:{label:"Buy price"}},{type:"number",field:"sellPrice",html:{label:"Sell price (un-used)"}},{type:"number",field:"sellPriceDeductedPerUse",html:{label:"Sell price deducted per use"}},{type:"html",html:{html:"<small>When a player sells this item, it will sell for: <code> un-used sell price - (sell price deducted per use X uses)</code>, or, if that value is less than 1, it will sell for 1.</small>"}},{type:"html",field:"sellPriceDemo",html:{class:"no-label",html:'<h3>Test sell price</h3><div id = "sellPriceDemo">\n                <input type = "range" id = "sellPriceDemoSlider">\n                <p id = "sellPriceDemoUses">Uses remaining: 0</p>\n                <p>Sell price: 0</p>\n                <small><em>You must move the slider to update the above values</em></small>\n                </div>'}}]});qt.on("change",(e=>{Ut(qt,e)})),qt.on("render:after",(e=>{if("Gift"!==window.currentObject.subtype&&"Equipable"!==window.currentObject.subtype){window.currentObject.maxUses||(window.currentObject.maxUses=25);let e=document.getElementById("sellPriceDemo");console.log(e);let t=e.querySelector("#sellPriceDemoSlider");t.min=0,t.max=window.currentObject.maxUses,t.value=window.currentObject.maxUses,t.step=1,t.oninput=()=>{e.querySelector("#sellPriceDemoUses").innerText="Uses remaining: "+t.value;let i=window.currentObject.sellPrice-window.currentObject.sellPriceDeductedPerUse*(window.currentObject.maxUses-t.value)<1?1:window.currentObject.sellPrice-window.currentObject.sellPriceDeductedPerUse*(window.currentObject.maxUses-t.value);e.querySelector("p:last-of-type").innerText="Sell price: "+i}}})),qt.updateGlobals=()=>{qt.refresh()},window.objectEditorValueFields=qt,qt.updateGlobals();const Vt=qt;let Yt=new s.sk({name:"object-editor-forgerepair-fields",record:{},fields:[]});Yt.on("change",(e=>{Ut(Yt,e)})),Yt.updateGlobals=()=>{Yt.refresh()},window.objectEditorForgeRepairFields=Yt,Yt.updateGlobals();const Xt=Yt;let Jt=new s.sk({name:"object-editor-gift-fields",record:{},fields:[]});Jt.on("change",(e=>{Ut(Jt,e)})),Jt.updateGlobals=()=>{Jt.refresh()},window.objectEditorGiftFields=Jt,Jt.updateGlobals();const Kt=Jt;let Qt=new s.Hs({name:"object-editor-bottom-toolbar",items:[{type:"radio",group:"1",id:"object-editor-bottom-toolbar-basic",text:"Basic Info",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"object-editor-bottom-toolbar-usage",text:"Details",class:"panel-tabs"},{type:"radio",group:"1",id:"object-editor-bottom-toolbar-value",text:"Value",class:"panel-tabs"},{type:"radio",group:"1",id:"object-editor-bottom-toolbar-forgerepair",text:"Forge/Repair",class:"panel-tabs"},{type:"radio",group:"1",id:"object-editor-bottom-toolbar-gift",text:"Gift",class:"panel-tabs",hidden:!0}]});Qt.on("click",(function(e){e.done((()=>{((e,t)=>{It(window.currentObject);let i=s.GB.ObjectEditor;"object-editor-bottom-toolbar-basic"===e.detail.item.id?(i.html("main",Mt),window.ObjectEditorActiveTab="basic"):"object-editor-bottom-toolbar-usage"===e.detail.item.id?(i.html("main",Gt),window.ObjectEditorActiveTab="usage"):"object-editor-bottom-toolbar-value"===e.detail.item.id?(i.html("main",Vt),window.ObjectEditorActiveTab="value"):"object-editor-bottom-toolbar-forgerepair"===e.detail.item.id?(i.html("main",Xt),window.ObjectEditorActiveTab="forgerepair"):"object-editor-bottom-toolbar-gift"===e.detail.item.id&&(i.html("main",Kt),window.ObjectEditorActiveTab="gift")})(e)}))})),window.ObjectEditorBottomToolbar=Qt;const Zt=Qt;let ei=new s.Yw({name:"ObjectEditor",panels:[{type:"top",size:30,resizable:!1,content:"top",html:Ht,style:"overflow-y: hidden;"},{type:"main",content:"main",html:Mt},{type:"left",size:200,resizable:!0,content:"left",html:Rt},{type:"bottom",size:30,resizable:!1,content:"bottom",html:Zt,style:"overflow-y: hidden;"}]});ei.on("render",(async function(e){if(ei.html("main",'<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:150%"><h2>Loading objects...</h2></div>'),window.allObjects=await Nt(),window.allObjects.all.length>0){window.currentObject=window.allObjects.all[0],It(window.currentObject),ei.html("main",Mt),Mt.record.id=window.currentObject.id,Lt(Rt);let e=[Rt.nodes[0],Rt.nodes[1],Rt.nodes[2],Rt.nodes[3]],t=!1;e.forEach((e=>{e.nodes[0]&&!t&&(e.nodes[0].selected=!0,t=!0)}));try{Rt.render()}catch(e){console.log(e)}window.ObjectEditorActiveTab="basic"}else ei.html("main",'<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:150%"><h2>No objects</h2><p>Create a new object to get started</p><img src = "http://localhost:26068/style/img/nu.png" style="position: fixed;width: 256px;left: 17%;top: 33%;"></div>')}));const ti=ei;let ii=new s.sk({name:"icon-editor-editor",record:{},fields:[]});ii.on("change",(e=>{((e,t)=>{let i=e.detail.field,s=e.detail.value;window.currentUnit[i]=s})(ii)})),ii.updateGlobals=()=>{ii.refresh()},window.iconEditorEditor=ii,ii.updateGlobals();const si=ii,li=async e=>{window.currentIcon=e,window.currentIcon&&void 0!==window.currentIcon?(console.log("updating current icon record ",e.id),window.iconEditorEditor.refresh()):console.log("no icon to update")};window.IconEditorCreateNewIcon=async e=>{console.log("creating new icon");let t={};t.name=e,t.queue=[{model:"Icon",method:"create"}];let i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},s=await fetch("http://localhost:26068/data",i).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));if(s.ok){let e=await s.json();return console.log(e),e}return w2alert("Error: invalid response from schemas server")},window.IconEditorDeleteIcon=async e=>{console.log("deleting object");let t={};console.log(t);let i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},s=await fetch("http://localhost:26068/data",i).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));if(s.ok){let e=await s.json();return console.log(e),e}return w2alert("Error: invalid response from schemas server")};let oi=new s.Hs({name:"IconEditorTopMenu",tooltip:"bottom",items:[{type:"button",id:"new-icon",text:"New icon",class:"w2ui-btn accent",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"spacer"},{type:"button",id:"delete-icon",text:"Delete icon",class:"w2ui-btn slider1",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>'}]});oi.on("click",(function(e){e.done((async()=>{if("new-icon"===e.detail.item.id)await window.IconEditorCreateNewIcon(e.detail.value).then((e=>(window.IconEditor.html("main",window.iconEditorEditor),window.currentIcon=e,li(e),(0,s.mJ)("New icon created")))).catch((e=>{console.error(e)}));else if("delete-icon"===e.detail.item.id){if(0===window.allIcons.length)return(0,s.mJ)("No icons to delete");let e=window.currentIcon;(0,s.mW)({title:"Delete icon",body:`Are you sure you want to delete ${e.name}?`,width:300,height:200}).yes((async()=>{li(window.currentIcon),await window.IconEditorDeleteIcon(e.id).then((()=>(0,s.mJ)("Icon deleted"))).catch((e=>(0,s.mJ)("Error deleting icon")))}))}}))}));const ni=oi;var ai=i(229);let ri=new s.Yw({name:"IconEditor",panels:[{type:"top",size:30,resizable:!1,content:"top",html:ni,style:"overflow-y: hidden;"},{type:"main",content:"main",html:si}]});ri.on("render",(async function(e){ri.html("main",'<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:150%"><h2>Loading icons...</h2></div>'),window.allIcons=await(0,ai.A)(),window.allIcons.length>0?(window.currentIcon=window.allIcons[0],li(window.currentIcon),ri.html("main",si),si.record.id=window.currentIcon.id):ri.html("main",'<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:150%"><h2>No icons</h2><p>Create a new icon to get started</p><img src = "http://localhost:26068/style/img/nu.png" style="position: fixed;width: 256px;left: 17%;top: 33%;"></div>')}));const di=ri;window.UnitEditor=ht,window.ClassEditor=ct,window.GameEditor=At,window.ObjectEditor=ti,window.IconEditor=di;let hi=new s.kf({name:"EditorWindowSidebar",flatButton:!0,icon:{text:e=>"sidebar-editors-unit-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>':"sidebar-editors-class-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-drama"><path d="M10 11h.01"/><path d="M14 6h.01"/><path d="M18 6h.01"/><path d="M6.5 13.1h.01"/><path d="M22 5c0 9-4 12-6 12s-6-3-6-12c0-2 2-3 6-3s6 1 6 3"/><path d="M17.4 9.9c-.8.8-2 .8-2.8 0"/><path d="M10.1 7.1C9 7.2 7.7 7.7 6 8.6c-3.5 2-4.7 3.9-3.7 5.6 4.5 7.8 9.5 8.4 11.2 7.4.9-.5 1.9-2.1 1.9-4.7"/><path d="M9.1 16.5c.3-1.1 1.4-1.7 2.4-1.4"/></svg>':"sidebar-editors-game-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>':"sidebar-editors-object-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sword"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></svg>':"sidebar-editors-level-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-grid-3x3"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>':"sidebar-editors-map-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map"><path d="M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z"/><path d="M15 5.764v15"/><path d="M9 3.236v15"/></svg>':"sidebar-editors-skill-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>':"sidebar-editors-battalion-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-component"><path d="M5.5 8.5 9 12l-3.5 3.5L2 12l3.5-3.5Z"/><path d="m12 2 3.5 3.5L12 9 8.5 5.5 12 2Z"/><path d="M18.5 8.5 22 12l-3.5 3.5L15 12l3.5-3.5Z"/><path d="m12 15 3.5 3.5L12 22l-3.5-3.5L12 15Z"/></svg>':"sidebar-editors-combatarts-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-target-arrow"><path d="M19 2v3h3"/><path d="M13.4 10.6 22 2"/><circle cx="12" cy="12" r="2"/><path d="M12.3 6H12a6 6 0 1 0 6 6v-.3"/><path d="M15 2.5A9.93 9.93 0 1 0 21.5 9"/><path d="M5.3 19.4 4 22"/><path d="M18.7 19.4 20 22"/></svg>':"sidebar-editors-shop-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-store"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12a2 2 0 0 1-2-2V7"/></svg>':"sidebar-editors-cutscenes-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-video"><path d="m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5"/><rect x="2" y="6" width="14" height="12" rx="2"/></svg>':"sidebar-editors-gameflow-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-workflow"><rect width="8" height="8" x="3" y="3" rx="2"/><path d="M7 11v4a2 2 0 0 0 2 2h4"/><rect width="8" height="8" x="13" y="13" rx="2"/></svg>':"sidebar-editors-dialogue-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-messages-square"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2z"/><path d="M18 9h2a2 2 0 0 1 2 2v11l-4-4h-6a2 2 0 0 1-2-2v-1"/></svg>':"sidebar-editors-menus-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-menu"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 8h10"/><path d="M7 12h10"/><path d="M7 16h10"/></svg>':"sidebar-editors-activities-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bath-bubble"><path d="M15 3h.01"/><circle cx="11.5" cy="6.5" r=".5"/><circle cx="16.5" cy="7.5" r=".5"/><path d="M2 12h6"/><path d="M13 15H8v-3c0-.6.4-1 1-1h3c.6 0 1 .4 1 1Z"/><path d="M13 12h9"/><path d="M4 12v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5"/><path d="M7 19v2"/><path d="M17 19v2"/></svg>':"sidebar-editors-portraits-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-user"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="10" r="3"/><path d="M7 21v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></svg>':"sidebar-editors-icons-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-dot"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg>':"sidebar-editors-visual-effects-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>':"sidebar-editors-music-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg>':"sidebar-editors-sound-effects-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-drum"><path d="m2 2 8 8"/><path d="m22 2-8 8"/><ellipse cx="12" cy="9" rx="10" ry="5"/><path d="M7 13.4v7.9"/><path d="M12 14v8"/><path d="M17 13.4v7.9"/><path d="M2 9v8a10 5 0 0 0 20 0V9"/></svg>':"sidebar-editors-animations-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-person-standing"><circle cx="12" cy="5" r="1"/><path d="m9 20 3-6 3 6"/><path d="m6 8 6 2 6-2"/><path d="M12 10v4"/></svg>':"sidebar-editors-sprites-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pac-man-ghost"><path d="M9 10h.01"/><path d="M15 10h.01"/><path d="M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z"/></svg>':"sidebar-editors-tiles-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trees-forest"><path d="m9 5 3-3 3 3"/><path d="m9 10 3-3 3 3"/><path d="M12 12V2"/><path d="m2 15 3-3 3 3"/><path d="m2 20 3-3 3 3"/><path d="M5 22V12"/><path d="m16 15 3-3 3 3"/><path d="m16 20 3-3 3 3"/><path d="M19 22V12"/></svg>':"sidebar-editors-models-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>':"sidebar-editors-filters-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/><path d="M20 3v4"/><path d="M22 5h-4"/><path d="M4 17v2"/><path d="M5 18H3"/></svg>':void 0},nodes:[{id:"sidebar-editors-list",text:"Simple Editors",expanded:!0,group:!0,groupShowHide:!0,nodes:[{id:"sidebar-editors-game-editor",text:"Project"},{id:"sidebar-editors-unit-editor",text:"Units",disabled:!0},{id:"sidebar-editors-class-editor",text:"Classes",disabled:!0},{id:"sidebar-editors-object-editor",text:"Objects",disabled:!0},{id:"sidebar-editors-skill-editor",text:"Skills",disabled:!0},{id:"sidebar-editors-battalion-editor",text:"Battalions",disabled:!0},{id:"sidebar-editors-combatarts-editor",text:"Combat Arts",disabled:!0}]},{id:"sidebar-map-editors-list",text:"Map Editors",expanded:!1,group:!0,groupShowHide:!0,nodes:[{id:"sidebar-editors-level-editor",text:"Battlefields",disabled:!0},{id:"sidebar-editors-map-editor",text:"World Map",disabled:!0},{id:"sidebar-editors-shop-editor",text:"Shops",disabled:!0}]},{id:"sidebar-editors-flow-list",text:"Flow Editors",expanded:!1,group:!0,groupShowHide:!0,nodes:[{id:"sidebar-editors-cutscenes-editor",text:"Cutscenes",disabled:!0},{id:"sidebar-editors-gameflow-editor",text:"Game Flow",disabled:!0},{id:"sidebar-editors-dialogue-editor",text:"Dialogue",disabled:!0},{id:"sidebar-editors-menus-editor",text:"Menus",disabled:!0},{id:"sidebar-editors-activities-editor",text:"Activities",disabled:!0}]},{id:"sidebar-editors-visuals-list",text:"Image Creators",expanded:!1,group:!0,groupShowHide:!0,nodes:[{id:"sidebar-editors-portraits-editor",text:"Portraits",disabled:!0},{id:"sidebar-editors-icons-editor",text:"Icons",disabled:!0}]},{id:"sidebar-editors-presentation-list",text:"Presentation",expanded:!1,group:!0,groupShowHide:!0,nodes:[{id:"sidebar-editors-visual-effects-editor",text:"Visual Effects",disabled:!0},{id:"sidebar-editors-music-editor",text:"Music",disabled:!0},{id:"sidebar-editors-sound-effects-editor",text:"Sound Effects",disabled:!0},{id:"sidebar-editors-animations-editor",text:"Animations",disabled:!0},{id:"sidebar-editors-sprites-editor",text:"Sprites",disabled:!0},{id:"sidebar-editors-tiles-editor",text:"Tiles",disabled:!0},{id:"sidebar-editors-models-editor",text:"Models",disabled:!0},{id:"sidebar-editors-filters-editor",text:"Filters",disabled:!0}]}],onFlat(e){s.GB.EditorWindowLayout.sizeTo("left",e.detail.goFlat?"4rem":"12%",!0)}});hi.on("render",(function(e){if(!1===window.newUserOnboardingGameDetails&&(hi.enable("sidebar-editors-unit-editor"),hi.enable("sidebar-editors-class-editor"),hi.enable("sidebar-editors-object-editor"),hi.enable("sidebar-editors-level-editor"),hi.enable("sidebar-editors-map-editor"),hi.enable("sidebar-editors-skill-editor"),hi.enable("sidebar-editors-cutscenes-editor"),hi.enable("sidebar-editors-gameflow-editor"),hi.enable("sidebar-editors-dialogue-editor"),hi.enable("sidebar-editors-shop-editor"),hi.enable("sidebar-editors-menus-editor"),hi.enable("sidebar-editors-activities-editor"),hi.enable("sidebar-editors-sound-effects-editor"),hi.enable("sidebar-editors-music-editor"),hi.enable("sidebar-editors-portraits-editor"),hi.enable("sidebar-editors-icons-editor"),hi.enable("sidebar-editors-visual-effects-editor"),hi.enable("sidebar-editors-filters-editor"),hi.enable("sidebar-editors-animations-editor"),hi.enable("sidebar-editors-sprites-editor"),hi.enable("sidebar-editors-tiles-editor"),hi.enable("sidebar-editors-models-editor"),hi.enable("sidebar-editors-battalion-editor"),hi.enable("sidebar-editors-combatarts-editor")),combatCombatArts||hi.disable("sidebar-editors-combatarts-editor"),combatBattalions||hi.disable("sidebar-editors-battalion-editor"),sessionStorage.getItem("startupView")){let e=sessionStorage.getItem("startupView");"default-editor-unit-editor"===e?hi.click("sidebar-editors-unit-editor"):"default-editor-class-editor"===e?hi.click("sidebar-editors-class-editor"):"default-editor-object-editor"===e?hi.click("sidebar-editors-object-editor"):hi.click("sidebar-editors-game-editor")}})),hi.on("click",(function(e){if(e.object.disabled)return;let t=s.GB.EditorWindowLayout;"sidebar-editors-unit-editor"===e.target?(s.GB["unit-editor-bottom-toolbar"].click("unit-editor-bottom-toolbar-basic"),t.html("main",ht).removed(),window.activeEditor="unit-editor"):"sidebar-editors-class-editor"===e.target?(s.GB["unit-editor-bottom-toolbar"].click("class-editor-bottom-toolbar-basic"),t.html("main",ct).removed(),window.activeEditor="class-editor"):"sidebar-editors-game-editor"===e.target?(s.GB["unit-editor-bottom-toolbar"].click("game-editor-bottom-toolbar-game-settings"),t.html("main",At).removed(),window.activeEditor="game-editor"):"sidebar-editors-object-editor"===e.target?(s.GB["unit-editor-bottom-toolbar"].click("object-editor-bottom-toolbar-basic"),t.html("main",ti).removed(),window.activeEditor="object-editor"):"sidebar-editors-icons-editor"===e.target&&(t.html("main",di).removed(),window.activeEditor="icon-editor")})),window.goFlat=function(){hi.goFlat()};const ci=hi},715:(e,t,i)=>{i.d(t,{A:()=>o});var s=i(675);let l=new s.Hs({name:"EditorWindowStatusBar",tooltip:"top",items:[{type:"label",id:"status-bar-project-status",text:"Required project settings missing",class:"status-bar"},{type:"break"},{type:"label",id:"status-bar-autosave-status",class:"status-bar",icon:'<div style="margin-top:-.5rem; margin-right:.25rem;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-check"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></svg></div>'},{type:"spacer"},{type:"label",id:"status-bar-turnroot-version",class:"status-bar",text:"Turnroot Editor v0.0.9 Weekly"},{type:"spacer"},{type:"label",id:"status-bar-report-issue",class:"status-bar report-issue",text:"Report an issue",style:"margin:0!important;padding:0!important;"}]});l.on("render",(function(e){!1===window.newUserOnboardingGameDetails&&l.hide("status-bar-project-status")})),l.on("click",(function(e){e.done((()=>{window.turnrootEditorLogs.push(`${new Date}||info||Status bar button clicked: ${JSON.stringify(e.target)}`),"status-bar-report-issue"===e.target?window.open("https://community.turnroot.com/c/turnroot-editor/editor-support/6","_blank"):"status-bar-project-status"===e.target&&s.GB.EditorWindowSidebar.click("sidebar-editors-game-editor")}))}));const o=l},80:(e,t,i)=>{i.d(t,{A:()=>d});var s=i(675);let l=["settings:default-editor-welcome-message","settings:default-editor-unit-editor"];const o=(e,t)=>{if(l.includes(e.target)){let i=e.target.split(":")[1];sessionStorage.setItem("startupView",i),t.get("settings").get("default-editor").items.forEach((e=>{e.id===i?e.style="background-color: var(--window-background-alt);":e.style=""}))}else if("collapseSidebar"===e.detail.item.id)window.goFlat();else if("forums"===e.detail.item.id)window.open("https://community.turnroot.com","_blank");else if("help"===e.detail.item.id)window.open("https://docs.turnroot.com","_blank");else if("show-status-bar"===e.detail.item.id){s.GB.EditorWindowStatusBar;let t=s.GB.EditorWindowLayout;e.detail.item.checked?(t.show("bottom"),t.sizeTo("bottom","24",!0)):(t.hide("bottom"),t.sizeTo("bottom","0",!0))}e.detail.subItem&&("font-family-fira-sans"===e.detail.subItem.id?(window.sessionStorage.setItem("font-family","Fira Sans"),document.documentElement.style.setProperty("--font-family","Fira Sans"),t.get("settings").get("font-family").items.forEach((e=>{"font-family-fira-sans"===e.id?e.style="background-color: var(--window-background-alt);":e.style=""}))):"font-family-lexend"===e.detail.subItem.id?(window.sessionStorage.setItem("font-family","Lexend"),document.documentElement.style.setProperty("--font-family","Lexend"),t.get("settings").get("font-family").items.forEach((e=>{"font-family-lexend"===e.id?e.style="background-color: var(--window-background-alt);":e.style=""}))):"font-family-clean-sans"===e.detail.subItem.id?(window.sessionStorage.setItem("font-family","Clear Sans"),document.documentElement.style.setProperty("--font-family","Clear Sans"),t.get("settings").get("font-family").items.forEach((e=>{"font-family-clean-sans"===e.id?e.style="background-color: var(--window-background-alt);":e.style=""}))):"font-family-figtree"===e.detail.subItem.id?(window.sessionStorage.setItem("font-family","Figtree"),document.documentElement.style.setProperty("--font-family","Figtree"),t.get("settings").get("font-family").items.forEach((e=>{"font-family-figtree"===e.id?e.style="background-color: var(--window-background-alt);":e.style=""}))):"font-family-hyperlegible"===e.detail.subItem.id?(window.sessionStorage.setItem("font-family","Hyperlegible"),document.documentElement.style.setProperty("--font-family","Hyperlegible"),t.get("settings").get("font-family").items.forEach((e=>{"font-family-hyperlegible"===e.id?e.style="background-color: var(--window-background-alt);":e.style=""}))):t.get("settings").get("themes").items.map((e=>e.id)).includes(e.detail.subItem.id)&&((e=>{const t=document.querySelector("#main");t.classList.remove("ocean_waves","turnroot","charcoal","charcoal_blue","charcoal_green","chocolate","midnight_spark","snowdrift","tokyo_night","pink_dream","forest_mist","sunset_glow","pine_coast"),t.classList.add(e),t.dataset.theme=e,window.MainEditorWindow.refresh(),window.EditorWindowSidebar.refresh(),sessionStorage.setItem("theme",e)})(e.detail.subItem.id),t.get("settings").get("themes").items.forEach((t=>{t.id===e.detail.subItem.id?t.style="background-color: var(--window-background-alt);":t.style=""}))))};let n=sessionStorage.getItem("startupView")?sessionStorage.getItem("startupView"):"welcome-message",a=new s.Hs({name:"EditorWindowTopMenu",tooltip:"bottom",items:[{type:"menu",id:"settings",text:"Settings",items:[{type:"menu",id:"themes",text:"Themes",items:[{text:"Ocean Waves",id:"ocean_waves"},{text:"Turnroot",id:"turnroot"},{text:"Charcoal",id:"charcoal"},{text:"Charcoal Blue",id:"charcoal_blue"},{text:"Charcoal Green",id:"charcoal_green"},{text:"Chocolate",id:"chocolate"},{text:"Snowdrift",id:"snowdrift"},{text:"Tokyo Night",id:"tokyo_night"},{text:"Pink Dream",id:"pink_dream"},{text:"Sunset Glow",id:"sunset_glow"},{text:"Pine Coast",id:"pine_coast"}]},{type:"menu-radio",id:"default-editor",text:"Startup view",items:[{text:"Welcome message",id:"default-editor-welcome-message",style:"background-color: var(--window-background-alt);",checked:"welcome-message"===n,hidden:"welcome-message"!==n},{text:"Unit Editor",id:"default-editor-unit-editor",checked:"default-editor-unit-editor"===n},{text:"Class Editor",checked:"default-editor-class-editor"===n,id:"default-editor-class-editor"}]},{type:"menu-radio",id:"font-family",text:"Font",items:[{text:"Fira Sans",id:"font-family-fira-sans",style:"background-color: var(--window-background-alt);",checked:"Fira Sans"===sessionStorage.getItem("font-family")},{text:"Lexend",id:"font-family-lexend",checked:"Lexend"===sessionStorage.getItem("font-family")},{text:"Clean Sans",checked:"Clear Sans"===sessionStorage.getItem("font-family"),id:"font-family-clean-sans"},{text:"Figtree",id:"font-family-figtree",checked:"Figtree"===sessionStorage.getItem("font-family")},{text:"Hyperlegible",id:"font-family-hyperlegible",checked:"Hyperlegible"===sessionStorage.getItem("font-family")}]}]},{type:"check",id:"collapseSidebar",text:"Collapse sidebar",class:"w2ui-tb-check"},{type:"check",id:"show-status-bar",text:"Status bar",checked:!0,class:"w2ui-tb-check"},{type:"spacer"},{type:"menu",id:"import-menu",text:"Import assets",tooltip:"Import graphics, models, music, sound effects, tilesets, or other assets",items:[{text:"Import from file",id:"import-file"}]},{type:"button",id:"check-build",text:"Check for issues",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bug-play"><path d="M12.765 21.522a.5.5 0 0 1-.765-.424v-8.196a.5.5 0 0 1 .765-.424l5.878 3.674a1 1 0 0 1 0 1.696z"/><path d="M14.12 3.88 16 2"/><path d="M18 11a4 4 0 0 0-4-4h-4a4 4 0 0 0-4 4v3a6.1 6.1 0 0 0 2 4.5"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M6 13H2"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="m8 2 1.88 1.88"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/></svg></div>'},{type:"spacer"},{type:"button",id:"account",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>'},{type:"break"},{type:"button",id:"help",text:"Help",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg></div>'},{type:"button",id:"forums",text:"Forums",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-speech"><path d="M8.8 20v-4.1l1.9.2a2.3 2.3 0 0 0 2.164-2.1V8.3A5.37 5.37 0 0 0 2 8.25c0 2.8.656 3.054 1 4.55a5.77 5.77 0 0 1 .029 2.758L2 20"/><path d="M19.8 17.8a7.5 7.5 0 0 0 .003-10.603"/><path d="M17 15a3.5 3.5 0 0 0-.025-4.975"/></svg></div>'}]});a.on("click",(function(e){e.done((()=>{o(e,a)}))}));let r=sessionStorage.getItem("theme");r&&a.get("settings:themes").items.forEach((e=>{e.id===r?(main.classList.remove("ocean_waves","turnroot","charcoal","charcoal_blue","charcoal_green","chocolate","midnight_spark","forest_mist","snowdrift","tokyo_night","pink_dream","sunset_glow","pine_coast"),main.classList.add(r),main.dataset.theme=r,e.style="background-color: var(--window-background-alt);"):e.style=""}));const d=a},830:(e,t,i)=>{i.d(t,{A:()=>s});const s='\n<div style = "width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center;">\n    <div style = "display:flex;justify-content:center;align-items:center;flex-direction:column;width:70ch">\n    <h1>Welcome to the Turnroot Editor!</h1>\n    <p style = "text-align:justify">Check out the <a href = "" style = "text-decoration:none;font-weight:bold;color:var(--slider-0);">Getting Started</a> guide to get familiar with Turnroot. Choose an editor from the sidebar to dismiss this message. If this is your first time starting Turnroot, start with the Project editor.<br/><br/>Please do yourself a favor and keep the <a href = "" style = "text-decoration:none;font-weight:bold;color:var(--slider-0);">Docs</a> open, there\'s a lot to take in and it may be overwhelming without help. Use the docs, I beg you, I wrote them just for you!</p>\n    <small><em>Your next step? Change the default homepage in the Settings menu so you never see this again ;)</em></small>\n</div>\n</div>\n'},972:(e,t,i)=>{i.d(t,{A:()=>s});const s=class{constructor(e,t){this.coords=e,this.icons=t,this.images=[],this.selectedIcon=null,this.iconPromise=new Promise((e=>{this.resolveIcon=e}))}show(){let e=document.createElement("div");e.id="IconPicker-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex="9998",e.style.display="block",document.body.appendChild(e),e.addEventListener("click",(()=>{this.close()}));let t=document.createElement("div");t.id="IconPicker-display",t.style.width="340px",t.style.height="500px",t.style.position="fixed",t.style.zIndex="9999",t.style.top=this.coords.y+"px",t.style.left=this.coords.x+"px",t.style.backgroundColor="var(--node-title-background)",t.style.overflowX="hidden",t.style.overflowY="auto",t.style.borderRadius="5px";let i=document.createElement("input");i.className="w2ui-input",i.type="text",i.placeholder="Search icons",i.style.marginBottom="10px",i.style.width="calc(100% - 20px)",i.style.margin="10px",i.style.borderRadius="5px",i.style.color="var(--node-title)",t.appendChild(i);let s=document.createElement("div");s.style.display="grid",s.style.gridTemplateColumns="repeat(3, 1fr)",s.style.gap="10px",s.style.padding="10px",t.appendChild(s);let l=document.createElement("button");l.style.width="100px",l.style.border="none",l.style.borderRadius="5px",l.style.fontSize="4rem",l.style.fontWeight="bold",l.style.appearance="none",l.style.cursor="pointer",l.style.outline="none",l.style.height="100px",l.style.backgroundColor="var(--accent)",l.style.color="white",l.innerText="+",l.style.transition="filter .2s",l.ariaLabel="Create new icon",l.setAttribute("data-balloon-pos","right"),l.addEventListener("mouseenter",(()=>{l.style.filter="brightness(.9)"})),l.addEventListener("mouseleave",(()=>{l.style.filter="unset"})),l.addEventListener("click",(()=>{this.close(),!1===window.EditorWindowSidebar.get("sidebar-editors-visuals-list").expanded&&(window.EditorWindowSidebar.get("sidebar-editors-visuals-list").expanded=!0,window.EditorWindowSidebar.refresh()),window.EditorWindowSidebar.click("sidebar-editors-icons-editor")})),s.appendChild(l);for(let e of this.icons){let t=document.createElement("img");t.src=e.src,t.alt=e.name,t.style.width="100px",t.style.height="100px",this.images.push(t),s.appendChild(t),t.addEventListener("click",(()=>{this.selectedIcon=e,this.close(),this.resolveIcon(e)}))}i.addEventListener("input",(()=>{let e=i.value.toLowerCase();if(""===e)for(let e of this.images)s.contains(e)||s.appendChild(e);for(let t of this.images)t.alt.replace(/\s+/g,"").toLowerCase().includes(e.replace(/\s+/g,""))?s.contains(t)||s.appendChild(t):s.removeChild(t)})),document.body.appendChild(t)}close(){let e=document.getElementById("IconPicker-display");if(e){e.remove();let t=document.getElementById("IconPicker-overlay");t&&t.remove()}}icon(){return this.iconPromise}}},71:(e,t,i)=>{i.d(t,{C$:()=>s,df:()=>l,oU:()=>d});const s=()=>{window.editsQueue={saved_at:Date.now(),queue:[]}},l=(e,t,i)=>{const s=i.id;let l=window.editsQueue.queue.find((e=>e.body.id===s));l?l.body=i:window.editsQueue.queue.push({model:e,method:t,body:i})},o='<div style="margin-top:-.5rem; margin-right:.25rem;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-check"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></svg></div>',n='<div style="margin-top:-.5rem; margin-right:.25rem;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-up"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 12v6"/><path d="m15 15-3-3-3 3"/></svg></div>';let a,r;const d=async()=>{let e=window.editsQueue.saved_at;if(a=Date.now(),a-e<12e3){try{window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:n,text:"Saving changes"})}catch(e){console.error(e),window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:o,text:"Changes saved"})}return void setTimeout((()=>{window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:o,text:"Changes saved"})}),500)}window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:n,text:"Saving changes"});let t={actions:window.editsQueue.queue||[]},i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},s=await fetch("/queue",i).catch((e=>console.error(e)));try{let e=await s.json();if(e||console.error("Error: invalid response, not JSON"),"success"===e.status){window.editsQueue.saved_at=Date.now(),window.editsQueue.queue=[],r=Date.now();let e=r-a;e<300&&setTimeout((()=>{window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:o,text:"Changes saved"})}),300-e)}else console.error("Error: invalid response "+e);return console.log("Data saved to schema server"),window.UnitEditor.refresh(),e}catch(e){return"Error: invalid response "+e}}},229:(e,t,i)=>{i.d(t,{A:()=>o});let s=new Date,l=!1;const o=async()=>{console.log("getting all icons");let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queue:[{model:"Icon",method:"get"}]})},t=new Date;if(t-s<1e4&&!0===l)return window.allIcons?window.allIcons:[];let i=await fetch("http://localhost:26068/data",e).catch((e=>(console.error(e),w2alert("Error: invalid response from schemas server"))));return i.ok?(s=t,l=!0,i.json()):(console.error(i),[])}},947:(e,t,i)=>{i.d(t,{S4:()=>o,mp:()=>n,P$:()=>a,iH:()=>d});const s={unitsCanHaveChildren:!0,useExperienceSublevels:!1,useExperienceAptitudes:!0,unitEditorAvatarDefaultHairColor:"rgb(39, 31, 86)",unitEditorAvatarDefaultEyeColor:"rgb(34, 132, 181)",unitEditorAvatarDefaultSkinColor:"rgb(255, 232, 207)",unitEditorAvatarDefaultHairStyle:0,combatCombatArts:!1,combatCombatArtLimit:3,combatWeaponTriangle:!0,combatTriangleTypes:["Sword","Lance","Axe","Bow","Gauntlet","Dagger"],combatNeutralTypes:[],combatTriangleMapping:{},combatExpandedWeaponTriangle:!1,combatWeaponTriangleAdvantage:20,combatWeaponTriangleDisadvantage:-20,combatMagicTriangle:!1,combatMagicTriangleAdvantage:20,combatMagicTriangleDisadvantage:-20,combatMagicTriangleTypes:[],combatNeutralMagicTypes:[],combatMagicTriangleMapping:{},combatBattalions:!0,combatBattalionLimit:1,combatBattalionEndurance:!0,combatPairUp:!1,combatAdjutants:!0,combatAdjutantHeal:!0,combatAdjutantGuard:!0,combatAdjutantAttack:!0,aptitudeGoals:!1,statsUseExtraStatWeight:!1,statsExtraStatWeightAffectsMovement:!1,statsUseExtraStatLuck:!0,combatSeparateCritAvoid:!1,statsUseExtraStatAuthority:!1,statsUseExtraStatCharm:!0,statsAptitudesUseRiding:!0,statsAptitudesUseFlying:!0,statsAptitudesUseAuthority:!1,statsAptitudesUseArmor:!1,globalMagicTypes:[],globalWeaponsTypes:[],GameEditorWeaponTriangleFieldsTopCorner:[],GameEditorWeaponTriangleFieldsLeftCorner:[],GameEditorWeaponTriangleFieldsRightCorner:[],GameEditorMagicTriangleFieldsTopCorner:[],GameEditorMagicTriangleFieldsLeftCorner:[],GameEditorMagicTriangleFieldsRightCorner:[],UseWeatherOnLevels:!1};var l=i(675);const o=["unitsCanHaveChildren","useExperienceSublevels","useExperienceAptitudes","combatCombatArts","combatWeaponTriangle","combatExpandedWeaponTriangle","combatMagicTriangle","combatBattalions","combatBattalionEndurance","combatPairUp","combatAdjutants","combatAdjutantHeal","combatAdjutantGuard","combatAdjutantAttack","aptitudeGoals","statsUseExtraStatWeight","statsExtraStatWeightAffectsMovement","statsUseExtraStatLuck","combatSeparateCritAvoid","statsUseExtraStatAuthority","statsUseExtraStatCharm","statsAptitudesUseRiding","statsAptitudesUseFlying","statsAptitudesUseAuthority","statsAptitudesUseArmor"],n=["combatCombatArtLimit","combatWeaponTriangleAdvantage","combatWeaponTriangleDisadvantage","combatMagicTriangleAdvantage","combatMagicTriangleDisadvantage","combatBattalionLimit"],a=["unitEditorAvatarDefaultHairColor","unitEditorAvatarDefaultEyeColor","unitEditorAvatarDefaultSkinColor","unitEditorAvatarDefaultHairStyle"],r=["unit-editor-basic-fields","unit-editor-friend-fields","unit-editor-avatar-fields","unit-editor-enemy-fields","unit-editor-npc-fields"];o.forEach((e=>{Object.defineProperty(window,e,{get:function(){return"true"===localStorage.getItem(e)},set:function(t){localStorage.setItem(e,t)}}),localStorage.getItem(e)||(window[e]=s[e])})),n.forEach((e=>{Object.defineProperty(window,e,{get:function(){const t=localStorage.getItem(e);return t?parseInt(t,10):null},set:function(t){localStorage.setItem(e,t)}}),localStorage.getItem(e)||(window[e]=s[e])})),a.forEach((e=>{Object.defineProperty(window,e,{get:function(){return localStorage.getItem(e)},set:function(t){localStorage.setItem(e,t)}}),localStorage.getItem(e)||(window[e]=s[e])})),["GameEditorWeaponTriangleFieldsTopCorner","GameEditorWeaponTriangleFieldsLeftCorner","GameEditorWeaponTriangleFieldsRightCorner","GameEditorMagicTriangleFieldsLeftCorner","GameEditorMagicTriangleFieldsRightCorner","GameEditorMagicTriangleFieldsTopCorner","UseWeatherOnLevels"].forEach((e=>{Object.defineProperty(window,e,{get:function(){return localStorage.getItem(e)},set:function(t){localStorage.setItem(e,t)}})})),["combatTriangleMapping","combatMagicTriangleMapping","globalWeaponsTypes","globalMagicTypes"].forEach((e=>{Object.defineProperty(window,e,{get:function(){return JSON.parse(localStorage.getItem(e))},set:function(t){localStorage.setItem(e,JSON.stringify(t))}}),localStorage.getItem(e)||(window[e]=s[e])})),["combatTriangleTypes","combatNeutralTypes","combatMagicTriangleTypes","combatNeutralMagicTypes"].forEach((e=>{Object.defineProperty(window,e,{get:function(){return localStorage.getItem(e).split(",")},set:function(t){localStorage.setItem(e,t.join(","))}}),localStorage.getItem(e)||(window[e]=s[e])}));const d=()=>{r.forEach((e=>{l.GB[e]?l.GB[e].updateGlobals():window.turnrootEditorLogs.push(`${new Date}||error||Form ${e} not found`)}))}},675:(e,t,i)=>{i.d(t,{A$:()=>_,GB:()=>r,Hs:()=>y,P:()=>a,Yw:()=>C,aG:()=>S,iX:()=>u,kf:()=>v,mJ:()=>h,mW:()=>c,sk:()=>E,yN:()=>p});class s{constructor(e,t){Object.assign(this,{type:t.type??null,detail:t,owner:e,target:t.target??null,phase:t.phase??"before",object:t.object??null,execute:null,isStopped:!1,isCancelled:!1,onComplete:null,listeners:[]}),delete t.type,delete t.target,delete t.object,this.complete=new Promise(((e,t)=>{this._resolve=e,this._reject=t})),this.complete.catch((()=>{}))}finish(e){e&&d.extend(this.detail,e),this.phase="after",this.owner.trigger.call(this.owner,this)}done(e){this.listeners.push(e)}preventDefault(){this._reject(),this.isCancelled=!0}stopPropagation(){this.isStopped=!0}}class l{constructor(e){if(this.activeEvents=[],this.listeners=[],void 0!==e){if(!d.checkName(e))return;r[e]=this}this.debug=!1}on(e,t){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach((e=>{var i,s,l,o="string"==typeof e?e:e.type+":"+e.execute+"."+e.scope;"string"==typeof e&&([s,i]=e.split("."),[s,l]=s.replace(":complete",":after").replace(":done",":after").split(":"),e={type:s,execute:l??"before",scope:i}),(e=d.extend({type:null,execute:"before",onComplete:null},e)).type?t?(Array.isArray(this.listeners)||(this.listeners=[]),this.listeners.push({name:o,edata:e,handler:t}),this.debug&&console.log("w2base: add event",{name:o,edata:e,handler:t})):console.log("ERROR: You must specify event handler function when calling .on() method of "+this.name):console.log("ERROR: You must specify event type when calling .on() method of "+this.name)})),this}off(e,t){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach((e=>{var i,s,l,o="string"==typeof e?e:e.type+":"+e.execute+"."+e.scope;if("string"==typeof e&&([s,i]=e.split("."),[s,l]=s.replace(":complete",":after").replace(":done",":after").split(":"),e={type:s||"*",execute:l||"",scope:i||""}),(e=d.extend({type:null,execute:null,onComplete:null},e)).type||e.scope){t=t||null;let i=0;this.listeners=this.listeners.filter((t=>"*"!==e.type&&e.type!==t.edata.type||""!==e.execute&&e.execute!==t.edata.execute||""!==e.scope&&e.scope!==t.edata.scope||null!=e.handler&&e.handler!==t.edata.handler||(i++,!1))),this.debug&&console.log(`w2base: remove event (${i})`,{name:o,edata:e,handler:t})}else console.log("ERROR: You must specify event type when calling .off() method of "+this.name)})),this}trigger(e,t){if(1==arguments.length?t="string"==typeof e?{type:e,target:this}:e:(t.type=e,t.target=t.target??this),d.isPlainObject(t)&&"after"==t.phase){if(!(t=this.activeEvents.find((e=>e.type==t.type&&e.target==t.target))))return void console.log(`ERROR: Cannot find even handler for "${t.type}" on "${t.target}".`);console.log("NOTICE: This syntax \"edata.trigger({ phase: 'after' })\" is outdated. Use edata.finish() instead.")}else t instanceof s||(t=new s(this,t),this.activeEvents.push(t));let i,l,o;Array.isArray(this.listeners)||(this.listeners=[]),this.debug&&console.log(`w2base: trigger "${t.type}:${t.phase}"`,t);for(let e=this.listeners.length-1;0<=e;e--){let s=this.listeners[e];if(!(null==s||s.edata.type!==t.type&&"*"!==s.edata.type||s.edata.target!==t.target&&null!=s.edata.target||s.edata.execute!==t.phase&&"*"!==s.edata.execute&&"*"!==s.edata.phase)&&(Object.keys(s.edata).forEach((e=>{null==t[e]&&null!=s.edata[e]&&(t[e]=s.edata[e])})),i=[],o=new RegExp(/\((.*?)\)/).exec(String(s.handler).split("=>")[0]),2===(i=o?o[1].split(/\s*,\s*/):i).length?(s.handler.call(this,t.target,t),this.debug&&console.log(" - call (old)",s.handler)):(s.handler.call(this,t),this.debug&&console.log(" - call",s.handler)),!0===t.isStopped||!0===t.stop))return t}if(e="on"+t.type.substr(0,1).toUpperCase()+t.type.substr(1),!("before"===t.phase&&"function"==typeof this[e]&&(l=this[e],i=[],o=new RegExp(/\((.*?)\)/).exec(String(l).split("=>")[0]),2===(i=o?o[1].split(/\s*,\s*/):i).length?(l.call(this,t.target,t),this.debug&&console.log(" - call: on[Event] (old)",l)):(l.call(this,t),this.debug&&console.log(" - call: on[Event]",l)),!0===t.isStopped||!0===t.stop)||null!=t.object&&"before"===t.phase&&"function"==typeof t.object[e]&&(l=t.object[e],i=[],o=new RegExp(/\((.*?)\)/).exec(String(l).split("=>")[0]),2===(i=o?o[1].split(/\s*,\s*/):i).length?(l.call(this,t.target,t),this.debug&&console.log(" - call: edata.object (old)",l)):(l.call(this,t),this.debug&&console.log(" - call: edata.object",l)),!0===t.isStopped||!0===t.stop)||"after"!==t.phase)){"function"==typeof t.onComplete&&t.onComplete.call(this,t);for(let e=0;e<t.listeners.length;e++)"function"==typeof t.listeners[e]&&(t.listeners[e].call(this,t),this.debug)&&console.log(" - call: done",l);t._resolve(t),this.debug&&console.log(`w2base: trigger "${t.type}:${t.phase}"`,t),-1!==(e=this.activeEvents.indexOf(t))&&this.activeEvents.splice(e,1)}return t}render(e){}unmount(){var e=this.trigger("unmount",{target:this.name});if(!e.isCancelled){let t=[];this.box instanceof HTMLElement&&this.box.classList.forEach((e=>{e.startsWith("w2ui-")&&t.push(e)})),a(this.box).off().removeClass(t).removeAttr("name").html(""),this.box=null,e.finish()}}}const o={locale:"en-US",dateFormat:"m/d/yyyy",timeFormat:"hh:mi pm",datetimeFormat:"m/d/yyyy|hh:mi pm",currencyPrefix:"$",currencySuffix:"",currencyPrecision:2,groupSymbol:",",decimalSymbol:".",shortmonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fullmonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortdays:["M","T","W","T","F","S","S"],fulldays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],weekStarts:"S",phrases:{"${count} letters or more...":"---","Add new record":"---","Add New":"---","Advanced Search":"---",after:"---","AJAX error. See console for more details.":"---","All Fields":"---",All:"---",Any:"---","Are you sure you want to delete ${count} ${records}?":"---","Attach files by dragging and dropping or Click to Select":"---",before:"---","begins with":"---",begins:"---",between:"---",buffered:"---",Cancel:"---",Close:"---",Column:"---",Confirmation:"---",contains:"---",Copied:"---","Copy to clipboard":"---","Current Date & Time":"---","Delete selected records":"---",Delete:"---",'Do you want to delete search item "${item}"?':"---","Edit selected record":"---",Edit:"---","Empty list":"---","ends with":"---",ends:"---","Field should be at least ${count} characters.":"---",Hide:"---",in:"---","is not":"---",is:"---","less than":"---","Line #":"---","Load ${count} more...":"---","Loading...":"---","Maximum number of files is ${count}":"---","Maximum total size is ${count}":"---",Modified:"---","more than":"---","Multiple Fields":"---",Name:"---","No items found":"---","No matches":"---",No:"---",none:"---","Not a float":"---","Not a hex number":"---","Not a valid date":"---","Not a valid email":"---","Not alpha-numeric":"---","Not an integer":"---","Not in money format":"---","not in":"---",Notification:"---",of:"---",Ok:"---",Opacity:"---","Record ID":"---",record:"---",records:"---","Refreshing...":"---","Reload data in the list":"---",Remove:"---","Remove This Field":"---","Request aborted.":"---","Required field":"---",Reset:"---","Restore Default State":"---","Returned data is not in valid JSON format.":"---","Save changed records":"---","Save Grid State":"---",Save:"---","Saved Searches":"---","Saving...":"---","Search took ${count} seconds":"---",Search:"---","Select Hour":"---","Select Minute":"---",selected:"---","Server Response ${count} seconds":"---","Show/hide columns":"---",Show:"---",Size:"---",Skip:"---","Sorting took ${count} seconds":"---","Type to search...":"---",Type:"---",Yes:"---",Yesterday:"---","Your remote data source record count has changed, reloading from the first record.":"---"}};class n{static version=.8;constructor(e,t){this.context=t??document;let i=[];if(Array.isArray(e))i=e;else if(e instanceof Node||e instanceof Window)i=[e];else if(e instanceof n)i=e.nodes;else if("string"==typeof e){if("function"!=typeof this.context.querySelector)throw new Error("Invalid context");i=Array.from(this.context.querySelectorAll(e))}else if(null==e)i=[];else{if(t=Array.from(e??[]),"object"!=typeof e||!Array.isArray(t))throw new Error(`Invalid selector "${e}"`);i=t}this.nodes=i,this.length=i.length,this.each(((e,t)=>{this[t]=e}))}static _fragment(e){let t=document.createElement("template");return t.innerHTML=e,t.content.childNodes.forEach((e=>{var i=n._scriptConvert(e);i!=e&&t.content.replaceChild(i,e)})),t.content}static _scriptConvert(e){let t=e=>{var t=e.ownerDocument.createElement("script"),i=(t.text=e.text,e.attributes);for(let e=0;e<i.length;e++)t.setAttribute(i[e].name,i[e].value);return t};return(e="SCRIPT"==e.tagName?t(e):e).querySelectorAll&&e.querySelectorAll("script").forEach((e=>{e.parentNode.replaceChild(t(e),e)})),e}static _fixProp(e){return{cellpadding:"cellPadding",cellspacing:"cellSpacing",class:"className",colspan:"colSpan",contenteditable:"contentEditable",for:"htmlFor",frameborder:"frameBorder",maxlength:"maxLength",readonly:"readOnly",rowspan:"rowSpan",tabindex:"tabIndex",usemap:"useMap"}[e]||e}_insert(e,t){let i=[],s=this.length;if(!(s<1)){let l=this;if("string"==typeof t)this.each((s=>{var l=n._fragment(t);i.push(...l.childNodes),s[e](l)}));else if(t instanceof n){let l=1==s;t.each((t=>{this.each((s=>{var o=l?t:t.cloneNode(!0);i.push(o),s[e](o),n._scriptConvert(o)}))})),l||t.remove()}else{if(!(t instanceof Node))throw new Error(`Incorrect argument for "${e}(html)". It expects one string argument.`);this.each((l=>{var o=1===s?t:n._fragment(t.outerHTML);i.push(...1===s?[t]:o.childNodes),l[e](o)})),1<s&&t.remove()}return l="replaceWith"==e?new n(i,this.context):l}}_save(e,t,i){e._mQuery=e._mQuery??{},Array.isArray(i)?(e._mQuery[t]=e._mQuery[t]??[],e._mQuery[t].push(...i)):null!=i?e._mQuery[t]=i:delete e._mQuery[t]}get(e){return this[e=e<0?this.length+e:e]||(null!=e?null:this.nodes)}eq(e){let t=[this[e=e<0?this.length+e:e]];return null==t[0]&&(t=[]),new n(t,this.context)}then(e){return null!=(e=e(this))?e:this}find(e){let t=[];return this.each((i=>{0<(i=Array.from(i.querySelectorAll(e))).length&&t.push(...i)})),new n(t,this.context)}filter(e){let t=[];return this.each((i=>{(i===e||"string"==typeof e&&i.matches&&i.matches(e)||"function"==typeof e&&e(i))&&t.push(i)})),new n(t,this.context)}next(){let e=[];return this.each((t=>{(t=t.nextElementSibling)&&e.push(t)})),new n(e,this.context)}prev(){let e=[];return this.each((t=>{(t=t.previousElementSibling)&&e.push(t)})),new n(e,this.context)}shadow(e){let t=[];this.each((e=>{e.shadowRoot&&t.push(e.shadowRoot)}));var i=new n(t,this.context);return e?i.find(e):i}closest(e){let t=[];return this.each((i=>{(i=i.closest(e))&&t.push(i)})),new n(t,this.context)}host(e){let t=[],i=e=>e.parentNode?i(e.parentNode):e,s=l=>{l=i(l),t.push(l.host||l),l.host&&e&&s(l.host)};return this.each((e=>{s(e)})),new n(t,this.context)}parent(e){return this.parents(e,!0)}parents(e,t){let i=[],s=e=>{if(-1==i.indexOf(e)&&i.push(e),!t&&e.parentNode)return s(e.parentNode)};this.each((e=>{e.parentNode&&s(e.parentNode)}));var l=new n(i,this.context);return e?l.filter(e):l}add(e){return e=e instanceof n?e.nodes:Array.isArray(e)?e:[e],new n(this.nodes.concat(e),this.context)}each(e){return this.nodes.forEach(((t,i)=>{e(t,i,this)})),this}append(e){return this._insert("append",e)}prepend(e){return this._insert("prepend",e)}after(e){return this._insert("after",e)}before(e){return this._insert("before",e)}replace(e){return this._insert("replaceWith",e)}remove(){return this.each((e=>{e.remove()})),this}css(e,t){let i=e;var s,l=arguments.length;return 0===l||1===l&&"string"==typeof e?this[0]?(l=this[0].style,"string"==typeof e?(s=l.getPropertyPriority(e),l.getPropertyValue(e)+(s?"!"+s:"")):Object.fromEntries(this[0].style.cssText.split(";").filter((e=>!!e)).map((e=>e.split(":").map((e=>e.trim())))))):void 0:("object"!=typeof e&&((i={})[e]=t),this.each(((e,t)=>{Object.keys(i).forEach((t=>{var s=String(i[t]).toLowerCase().includes("!important")?"important":"";e.style.setProperty(t,String(i[t]).replace(/\!important/i,""),s)}))})),this)}addClass(e){return this.toggleClass(e,!0),this}removeClass(e){return this.toggleClass(e,!1),this}toggleClass(e,t){return"string"==typeof e&&(e=e.split(/[,\s]+/)),this.each((i=>{let s=e;(s=null==s&&!1===t?Array.from(i.classList):s).forEach((e=>{if(""!==e){let s=null!=t?t?"add":"remove":"toggle";i.classList[s](e)}}))})),this}hasClass(e){if(null==(e="string"==typeof e?e.split(/[,\s]+/):e)&&0<this.length)return Array.from(this[0].classList);let t=!1;return this.each((i=>{t=t||e.every((e=>Array.from(i.classList??[]).includes(e)))})),t}on(e,t,i){let s;return"function"==typeof t&&(i=t,t=void 0),t?.delegate&&(s=t.delegate,delete t.delegate),(e=e.split(/[,\s]+/)).forEach((e=>{let[l,o]=String(e).toLowerCase().split(".");if(s){let e=i;i=t=>{var i=a(t.target).parents(s);0<i.length?t.delegate=i[0]:t.delegate=t.target,(t.target.matches(s)||0<i.length)&&e(t)}}this.each((e=>{this._save(e,"events",[{event:l,scope:o,callback:i,options:t}]),e.addEventListener(l,i,t)}))})),this}off(e,t,i){return"function"==typeof t&&(i=t,t=void 0),(e=(e??"").split(/[,\s]+/)).forEach((e=>{let[t,s]=String(e).toLowerCase().split(".");this.each((e=>{if(Array.isArray(e._mQuery?.events))for(let o=e._mQuery.events.length-1;0<=o;o--){var l=e._mQuery.events[o];null==s||""===s?l.event!=t&&""!==t||l.callback!=i&&null!=i||(e.removeEventListener(l.event,l.callback,l.options),e._mQuery.events.splice(o,1)):l.event!=t&&""!==t||l.scope!=s||(e.removeEventListener(l.event,l.callback,l.options),e._mQuery.events.splice(o,1))}}))})),this}trigger(e,t){let i;return i=e instanceof Event||e instanceof CustomEvent?e:new(["click","dblclick","mousedown","mouseup","mousemove"].includes(e)?MouseEvent:["keydown","keyup","keypress"].includes(e)?KeyboardEvent:Event)(e,t),this.each((e=>{e.dispatchEvent(i)})),this}attr(e,t){if(void 0===t&&"string"==typeof e)return this[0]?this[0].getAttribute(e):void 0;{let i={};return"object"==typeof e?i=e:i[e]=t,this.each((e=>{Object.entries(i).forEach((([t,i])=>{e.setAttribute(t,i)}))})),this}}removeAttr(){return this.each((e=>{Array.from(arguments).forEach((t=>{e.removeAttribute(t)}))})),this}prop(e,t){if(void 0===t&&"string"==typeof e)return this[0]?this[0][e]:void 0;{let i={};return"object"==typeof e?i=e:i[e]=t,this.each((e=>{Object.entries(i).forEach((([t,i])=>{t=n._fixProp(t),e[t]=i,"innerHTML"==t&&n._scriptConvert(e)}))})),this}}removeProp(){return this.each((e=>{Array.from(arguments).forEach((t=>{delete e[n._fixProp(t)]}))})),this}data(e,t){if(e instanceof Object)Object.entries(e).forEach((e=>{this.data(e[0],e[1])}));else{if(e&&-1!=e.indexOf("-")&&console.error(`Key "${e}" contains "-" (dash). Dashes are not allowed in property names. Use camelCase instead.`),!(arguments.length<2))return this.each((i=>{null!=t?i.dataset[e]=t instanceof Object?JSON.stringify(t):t:delete i.dataset[e]})),this;if(this[0]){let t=Object.assign({},this[0].dataset);return Object.keys(t).forEach((e=>{if(t[e].startsWith("[")||t[e].startsWith("{"))try{t[e]=JSON.parse(t[e])}catch(e){}})),e?t[e]:t}}}removeData(e){return"string"==typeof e&&(e=e.split(/[,\s]+/)),this.each((t=>{e.forEach((e=>{delete t.dataset[e]}))})),this}show(){return this.toggle(!0)}hide(){return this.toggle(!1)}toggle(e){return this.each((t=>{var i,s=t.style.display,l=getComputedStyle(t).display,o="none"==s||"none"==l;!o||null!=e&&!0!==e||(i=t instanceof HTMLTableRowElement?"table-row":t instanceof HTMLTableCellElement?"table-cell":"block",t.style.display=t._mQuery?.prevDisplay??(s==l&&"none"!=l?"":i),this._save(t,"prevDisplay",null)),o||null!=e&&!1!==e||("none"!=l&&this._save(t,"prevDisplay",l),t.style.setProperty("display","none"))}))}empty(){return this.html("")}html(e){return e instanceof HTMLElement?this.empty().append(e):this.prop("innerHTML",e)}text(e){return this.prop("textContent",e)}val(e){return this.prop("value",e)}change(){return this.trigger("change")}click(){return this.trigger("click")}}let a=function(e,t){if("function"!=typeof e)return new n(e,t);"complete"==document.readyState?e():window.addEventListener("load",e)},r=(a.html=e=>(e=n._fragment(e),a(e.children,e)),a.version=n.version,{});var d=new class{constructor(){this.version="2.0.x",this.tmp={},this.settings=this.extend({},{dataType:"HTTPJSON",dateStartYear:1950,dateEndYear:2030,macButtonOrder:!1,warnNoPhrase:!1},o,{phrases:null}),this.i18nCompare=Intl.Collator().compare,this.hasLocalStorage=function(){var e="w2ui_test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}(),this.isMac=/Mac/i.test(navigator.platform),this.isMobile=/(iphone|ipod|mobile|android)/i.test(navigator.userAgent),this.isIOS=/(iphone|ipod|ipad)/i.test(navigator.platform),this.isAndroid=/(android)/i.test(navigator.userAgent),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isFirefox=/(Firefox)/i.test(navigator.userAgent),this.formatters={number:(e,t)=>(20<parseInt(t)&&(t=20),parseInt(t)<0&&(t=0),null==e||""===e?"":d.formatNumber(parseFloat(e),t,!0)),float:(e,t)=>d.formatters.number(e,t),int:(e,t)=>d.formatters.number(e,0),money:(e,t)=>null==e||""===e?"":(e=d.formatNumber(Number(e),d.settings.currencyPrecision),(d.settings.currencyPrefix||"")+e+(d.settings.currencySuffix||"")),currency:(e,t)=>d.formatters.money(e,t),percent:(e,t)=>null==e||""===e?"":d.formatNumber(e,t||1)+"%",size:(e,t)=>null==e||""===e?"":d.formatSize(parseInt(e)),date(e,t){if(""===t&&(t=d.settings.dateFormat),null==e||0===e||""===e)return"";let i=d.isDateTime(e,t,!0);return'<span title="'+(i=!1===i?d.isDate(e,t,!0):i)+'">'+d.formatDate(i,t)+"</span>"},datetime(e,t){if(""===t&&(t=d.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=d.isDateTime(e,t,!0);return'<span title="'+(i=!1===i?d.isDate(e,t,!0):i)+'">'+d.formatDateTime(i,t)+"</span>"},time(e,t){if(""===t&&(t=d.settings.timeFormat),null==e||0===e||""===e)return"";let i=d.isDateTime(e,t="h24"===(t="h12"===t?"hh:mi pm":t)?"h24:mi":t,!0);return'<span title="'+(i=!1===i?d.isDate(e,t,!0):i)+'">'+d.formatTime(e,t)+"</span>"},timestamp(e,t){if(""===t&&(t=d.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=d.isDateTime(e,t,!0);return(i=!1===i?d.isDate(e,t,!0):i).toString?i.toString():""},gmt(e,t){if(""===t&&(t=d.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=d.isDateTime(e,t,!0);return(i=!1===i?d.isDate(e,t,!0):i).toUTCString?i.toUTCString():""},age(e,t){if(null==e||0===e||""===e)return"";let i=d.isDateTime(e,null,!0);return'<span title="'+(i=!1===i?d.isDate(e,null,!0):i)+'">'+d.age(e)+(t?" "+t:"")+"</span>"},interval:(e,t)=>null==e||0===e||""===e?"":d.interval(e)+(t?" "+t:""),toggle:(e,t)=>e?d.lang("Yes"):"",password(e,t){let i="";if(e)for(let t=0;t<e.length;t++)i+="*";return i}}}isBin(e){return/^[0-1]+$/.test(e)}isInt(e){return/^[-+]?[0-9]+$/.test(e)}isFloat(e){return("number"==typeof(e="string"==typeof e?e.replace(this.settings.groupSymbol,"").replace(this.settings.decimalSymbol,"."):e)||"string"==typeof e&&""!==e)&&!isNaN(Number(e))}isMoney(e){var t,i;return"object"!=typeof e&&""!==e&&(!!this.isFloat(e)||(t=this.settings,i=new RegExp("^"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[-+]?"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[0-9]*[\\"+t.decimalSymbol+"]?[0-9]+"+(t.currencySuffix?"\\"+t.currencySuffix+"?":"")+"$","i"),"string"==typeof e&&(e=e.replace(new RegExp(t.groupSymbol,"g"),"")),i.test(e)))}isHex(e){return/^(0x)?[0-9a-fA-F]+$/.test(e)}isAlphaNumeric(e){return/^[a-zA-Z0-9_-]+$/.test(e)}isEmail(e){return/^[a-zA-Z0-9._%\-+]+@[а-яА-Яa-zA-Z0-9.-]+\.[а-яА-Яa-zA-Z]+$/.test(e)}isIpAddress(e){return new RegExp("^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$").test(e)}isDate(e,t,i){if(!e)return!1;var s="Invalid Date";let l,o,n;if(null==t&&(t=this.settings.dateFormat),"function"==typeof e.getFullYear)n=e.getFullYear(),l=e.getMonth()+1,o=e.getDate();else if(parseInt(e)==e&&0<parseInt(e))n=(e=new Date(parseInt(e))).getFullYear(),l=e.getMonth()+1,o=e.getDate();else{if(e=String(e),new RegExp("mon","ig").test(t)){t=t.replace(/month/gi,"m").replace(/mon/gi,"m").replace(/dd/gi,"d").replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase(),e=e.replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase();for(let t=0,i=this.settings.fullmonths.length;t<i;t++){var a=this.settings.fullmonths[t];e=e.replace(new RegExp(a,"ig"),parseInt(t)+1).replace(new RegExp(a.substr(0,3),"ig"),parseInt(t)+1)}}var r=e.replace(/-/g,"/").replace(/\./g,"/").toLowerCase().split("/");"mm/dd/yyyy"===(t=t.replace(/-/g,"/").replace(/\./g,"/").toLowerCase())&&(l=r[0],o=r[1],n=r[2]),"m/d/yyyy"===t&&(l=r[0],o=r[1],n=r[2]),"dd/mm/yyyy"===t&&(l=r[1],o=r[0],n=r[2]),"d/m/yyyy"===t&&(l=r[1],o=r[0],n=r[2]),"yyyy/dd/mm"===t&&(l=r[2],o=r[1],n=r[0]),"yyyy/d/m"===t&&(l=r[2],o=r[1],n=r[0]),"yyyy/mm/dd"===t&&(l=r[1],o=r[2],n=r[0]),"yyyy/m/d"===t&&(l=r[1],o=r[2],n=r[0]),"mm/dd/yy"===t&&(l=r[0],o=r[1],n=r[2]),"m/d/yy"===t&&(l=r[0],o=r[1],n=parseInt(r[2])+1900),"dd/mm/yy"===t&&(l=r[1],o=r[0],n=parseInt(r[2])+1900),"d/m/yy"===t&&(l=r[1],o=r[0],n=parseInt(r[2])+1900),"yy/dd/mm"===t&&(l=r[2],o=r[1],n=parseInt(r[0])+1900),"yy/d/m"===t&&(l=r[2],o=r[1],n=parseInt(r[0])+1900),"yy/mm/dd"===t&&(l=r[1],o=r[2],n=parseInt(r[0])+1900),"yy/m/d"===t&&(l=r[1],o=r[2],n=parseInt(r[0])+1900)}return!!this.isInt(n)&&!!this.isInt(l)&&!!this.isInt(o)&&(n=+n,l=+l,o=+o,(s=new Date(n,l-1,o)).setFullYear(n),null!=l)&&"Invalid Date"!==String(s)&&s.getMonth()+1===l&&s.getDate()===o&&s.getFullYear()===n&&(!0!==i||s)}isTime(e,t){if(null==e)return!1;let i,s,l;s=0<=(e=(e=String(e)).toUpperCase()).indexOf("AM");var o=(l=0<=e.indexOf("PM"))||s;i=o?12:24,e=(e=e.replace("AM","").replace("PM","").trim()).split(":");let n=parseInt(e[0]||0),a=parseInt(e[1]||0),r=parseInt(e[2]||0);return(o&&1===e.length||2===e.length||3===e.length)&&!(""===e[0]||n<0||n>i||!this.isInt(e[0])||2<e[0].length||1<e.length&&(""===e[1]||a<0||59<a||!this.isInt(e[1])||2!==e[1].length)||2<e.length&&(""===e[2]||r<0||59<r||!this.isInt(e[2])||2!==e[2].length)||!(o||i!==n||0===a&&0===r)||o&&1===e.length&&0===n)&&(!0!==t||(l&&12!==n&&(n+=12),s&&12===n&&(n+=12),{hours:n,minutes:a,seconds:r}))}isDateTime(e,t,i){var s;return"function"==typeof e.getFullYear?!0!==i||e:(s=parseInt(e))===e?!(s<0)&&(!0!==i||new Date(s)):(s=String(e).indexOf(" "))<0?!(String(e).indexOf("T")<0||"Invalid Date"==String(new Date(e)))&&(!0!==i||new Date(e)):(t=(t=null==t?this.settings.datetimeFormat:t).split("|"),e=[e.substr(0,s),e.substr(s).trim()],t[0]=t[0].trim(),t[1]&&(t[1]=t[1].trim()),s=this.isDate(e[0],t[0],!0),t=this.isTime(e[1],!0),!1!==s&&!1!==t&&(!0!==i||(s.setHours(t.hours),s.setMinutes(t.minutes),s.setSeconds(t.seconds),s)))}age(e){let t;if(""===e||null==e)return"";if(t="function"==typeof e.getFullYear?e:parseInt(e)==e&&0<parseInt(e)?new Date(parseInt(e)):new Date(e),"Invalid Date"===String(t))return"";let i="",s="";return(e=((new Date).getTime()-t.getTime())/1e3)<0?(i=0,s="sec"):e<60?(i=Math.floor(e),s="sec",e<0&&(i=0,s="sec")):e<3600?(i=Math.floor(e/60),s="min"):e<86400?(i=Math.floor(e/60/60),s="hour"):e<2592e3?(i=Math.floor(e/24/60/60),s="day"):e<31536e3?(i=Math.floor(e/30/24/60/60*10)/10,s="month"):e<126144e3?(i=Math.floor(e/365/24/60/60*10)/10,s="year"):126144e3<=e&&(i=Math.floor(e/365.25/24/60/60*10)/10,s="year"),i+" "+s+(1<i?"s":"")}interval(e){return e<100?"< 0.01 sec":e<1e3?Math.floor(e/10)/100+" sec":e<1e4?Math.floor(e/100)/10+" sec":e<6e4?Math.floor(e/1e3)+" secs":e<36e5?Math.floor(e/6e4)+" mins":e<864e5?Math.floor(e/36e5*10)/10+" hours":e<2628e6?Math.floor(e/864e5*10)/10+" days":e<31536e6?Math.floor(e/2628e6*10)/10+" months":Math.floor(e/31536e5)/10+" years"}date(e){if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let t=new Date(e);if(this.isInt(e)&&(t=new Date(Number(e))),"Invalid Date"===String(t))return"";e=this.settings.shortmonths;var i=new Date,s=((l=new Date).setTime(l.getTime()-864e5),e[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear()),l=(i=e[i.getMonth()]+" "+i.getDate()+", "+i.getFullYear(),e=e[l.getMonth()]+" "+l.getDate()+", "+l.getFullYear(),t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+" "+(12<=t.getHours()?"pm":"am"));let o=s==i?l:s;return'<span title="'+s+" "+(t.getHours()-(12<t.getHours()?12:0))+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+":"+(t.getSeconds()<10?"0":"")+t.getSeconds()+" "+(12<=t.getHours()?"pm":"am")+'">'+(o=s==e?this.lang("Yesterday"):o)+"</span>"}formatSize(e){var t;return this.isFloat(e)&&""!==e?0===(e=parseFloat(e))?0:(t=parseInt(Math.floor(Math.log(e)/Math.log(1024))),(Math.floor(e/Math.pow(1024,t)*10)/10).toFixed(0===t?0:1)+" "+(["Bt","KB","MB","GB","TB","PB","EB","ZB"][t]||"??")):""}formatNumber(e,t,i){return null==e||""===e||"object"==typeof e?"":(i={minimumFractionDigits:parseInt(t),maximumFractionDigits:parseInt(t),useGrouping:!!i},(null==t||t<0)&&(i.minimumFractionDigits=0,i.maximumFractionDigits=20),parseFloat(e).toLocaleString(this.settings.locale,i))}formatDate(e,t){if(t=t||this.settings.dateFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);var s,l;return this.isInt(e)&&(i=new Date(Number(e))),"Invalid Date"===String(i)?"":(e=i.getFullYear(),s=i.getMonth(),l=i.getDate(),t.toLowerCase().replace("month",this.settings.fullmonths[s]).replace("mon",this.settings.shortmonths[s]).replace(/yyyy/g,("000"+e).slice(-4)).replace(/yyy/g,("000"+e).slice(-4)).replace(/yy/g,("0"+e).slice(-2)).replace(/(^|[^a-z$])y/g,"$1"+e).replace(/mm/g,("0"+(s+1)).slice(-2)).replace(/dd/g,("0"+l).slice(-2)).replace(/th/g,1==l?"st":"th").replace(/th/g,2==l?"nd":"th").replace(/th/g,3==l?"rd":"th").replace(/(^|[^a-z$])m/g,"$1"+(s+1)).replace(/(^|[^a-z$])d/g,"$1"+l))}formatTime(e,t){if(t=t||this.settings.timeFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),this.isTime(e)&&(e=this.isTime(e,!0),(i=new Date).setHours(e.hours),i.setMinutes(e.minutes)),"Invalid Date"===String(i))return"";"h12"==t&&(t="hh:mi pm");let s="am",l=i.getHours();e=i.getHours();let o=i.getMinutes(),n=i.getSeconds();return o<10&&(o="0"+o),n<10&&(n="0"+n),-1===t.indexOf("am")&&-1===t.indexOf("pm")||(12<=l&&(s="pm"),12<l&&(l-=12),0===l&&(l=12)),t.toLowerCase().replace("am",s).replace("pm",s).replace("hhh",l<10?"0"+l:l).replace("hh24",e<10?"0"+e:e).replace("h24",e).replace("hh",l).replace("mm",o).replace("mi",o).replace("ss",n).replace(/(^|[^a-z$])h/g,"$1"+l).replace(/(^|[^a-z$])m/g,"$1"+o).replace(/(^|[^a-z$])s/g,"$1"+n)}formatDateTime(e,t){let i;return""===e||null==e||"object"==typeof e&&!e.getMonth?"":("string"!=typeof t?i=[this.settings.dateFormat,this.settings.timeFormat]:((i=t.split("|"))[0]=i[0].trim(),i[1]=1<i.length?i[1].trim():this.settings.timeFormat),"h12"===i[1]&&(i[1]="h:m pm"),"h24"===i[1]&&(i[1]="h24:m"),this.formatDate(e,i[0])+" "+this.formatTime(e,i[1]))}stripSpaces(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/(?:\r\n|\r|\n)/g," ").replace(/\s\s+/g," ").trim();break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.stripSpaces(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.stripSpaces(e[t])})))}return e}stripTags(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/<(?:[^>=]|='[^']*'|="[^"]*"|=[^'"][^\s>]*)*>/gi,"");break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.stripTags(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.stripTags(e[t])})))}return e}encodeTags(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.encodeTags(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.encodeTags(e[t])})))}return e}decodeTags(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&");break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.decodeTags(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.decodeTags(e[t])})))}return e}escapeId(e){return""===e||null==e?"":(e+"").replace(/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,((e,t)=>t?"\0"===e?"�":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e))}unescapeId(e){return""===e||null==e?"":e.replace(/\\[\da-fA-F]{1,6}[\x20\t\r\n\f]?|\\([^\r\n\f])/g,((e,t)=>(e="0x"+e.slice(1)-65536,t||(e<0?String.fromCharCode(65536+e):String.fromCharCode(e>>10|55296,1023&e|56320)))))}base64encode(e){return btoa(e)}base64decode(e){return atob(e)}async sha256(e){return e=(new TextEncoder).encode(e),crypto.subtle.digest("SHA-256",e).then((e=>Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("")))}transition(e,t,i,s){return new Promise(((l,o)=>{var n=getComputedStyle(e);let r=parseInt(n.width),d=parseInt(n.height);if(e&&t){switch(e.parentNode.style.cssText+="perspective: 900px; overflow: hidden;",e.style.cssText+="; position: absolute; z-index: 1019; backface-visibility: hidden",t.style.cssText+="; position: absolute; z-index: 1020; backface-visibility: hidden",i){case"slide-left":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d("+r+"px, 0, 0)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(-"+r+"px, 0, 0)"}),1);break;case"slide-right":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(-"+r+"px, 0, 0)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0px, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d("+r+"px, 0, 0)"}),1);break;case"slide-down":e.style.cssText+="overflow: hidden; z-index: 1; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; z-index: 0; transform: translate3d(0, 0, 0)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(0, "+d+"px, 0)"}),1);break;case"slide-up":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, "+d+"px, 0)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)"}),1);break;case"flip-left":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(-180deg)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateY(180deg)"}),1);break;case"flip-right":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(180deg)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateY(-180deg)"}),1);break;case"flip-down":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(180deg)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateX(-180deg)"}),1);break;case"flip-up":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(-180deg)",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateX(180deg)"}),1);break;case"pop-in":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(.8); opacity: 0;",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: scale(1); opacity: 1;",e.style.cssText+="transition: 0.5s;"}),1);break;case"pop-out":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(1); opacity: 1;",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); opacity: 0;",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; opacity: 1;",e.style.cssText+="transition: 0.5s; transform: scale(1.7); opacity: 0;"}),1);break;default:e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; translate3d(0, 0, 0); opacity: 0;",a(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; opacity: 1;",e.style.cssText+="transition: 0.5s"}),1)}setTimeout((()=>{"slide-down"===i&&(a(e).css("z-index","1019"),a(t).css("z-index","1020")),t&&a(t).css({opacity:"1"}).css({transition:"",transform:""}),e&&a(e).css({opacity:"1"}).css({transition:"",transform:""}),"function"==typeof s&&s(),l()}),500)}else console.log("ERROR: Cannot do transition when one of the divs is null")}))}lock(e,t={}){if(null!=e){"string"==typeof t&&(t={msg:t}),arguments[2]&&(t.spinner=arguments[2]),t=this.extend({spinner:!1},t),e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),t.msg||0===t.msg||(t.msg=""),this.unlock(e);var i=a(e).get(0),s=i.scrollWidth;let l=`height: ${i.scrollHeight}px; width: ${s}px`,o=("BODY"==i.tagName&&(l="position: fixed; right: 0; bottom: 0;"),a(e).prepend(`<div class="w2ui-lock" style="${l}"></div><div class="w2ui-lock-msg"></div>`),a(e).find(".w2ui-lock"));s=a(e).find(".w2ui-lock-msg"),t.msg||s.css({"background-color":"transparent","background-image":"none",border:"0px","box-shadow":"none"}),!0===t.spinner&&(t.msg=`<div class="w2ui-spinner" ${t.msg?"":'style="width: 35px; height: 35px"'}></div>`+t.msg),t.msg?s.html(t.msg).css("display","block"):s.remove(),null!=t.opacity&&o.css("opacity",t.opacity),o.css({display:"block"}),t.bgColor&&o.css({"background-color":t.bgColor});let n=(i=getComputedStyle(o.get(0))).opacity??.15;o.on("mousedown",(function(){"function"==typeof t.onClick?t.onClick():o.css({transition:".2s",opacity:1.5*n})})).on("mouseup",(function(){"function"!=typeof t.onClick&&o.css({transition:".2s",opacity:n})})).on("mousewheel",(function(e){e&&(e.stopPropagation(),e.preventDefault())}))}}unlock(e,t){var i;null!=e&&(clearTimeout(e._prevUnlock),e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),this.isInt(t)&&0<t?(a(e).find(".w2ui-lock").css({transition:t/1e3+"s",opacity:0}),i=a(e).get(0),clearTimeout(i._prevUnlock),i._prevUnlock=setTimeout((()=>{a(e).find(".w2ui-lock").remove()}),t)):a(e).find(".w2ui-lock").remove(),a(e).find(".w2ui-lock-msg").remove())}message(e,t){let i,s,o;var n=()=>{var i=a(e?.box).find(".w2ui-message");0!=i.length&&"function"==typeof(t=i.get(0)._msg_options||{})?.close&&t.close()};let r=t=>{var i,s=t.box._msg_prevFocus;a(e.box).find(".w2ui-message").length<=1?e.owner?e.owner.unlock(e.param,150):this.unlock(e.box,150):a(e.box).find(`#w2ui-message-${e.owner?.name}-`+(t.msgIndex-1)).css("z-index",1500),s?0<(i=a(s).closest(".w2ui-message")).length?i.get(0)._msg_options.setFocus(s):s.focus():"function"==typeof e.owner?.focus&&e.owner.focus(),a(t.box).remove(),0===t.msgIndex&&(g.css("z-index",t.tmp.zIndex),a(e.box).css("overflow",t.tmp.overflow)),t.trigger&&o.finish()};if("object"!=typeof(t="string"!=typeof t&&"number"!=typeof t?t:{width:String(t).length<300?350:550,height:String(t).length<300?170:250,text:String(t)}))return void n();null!=t.text&&(t.body=`<div class="w2ui-centered w2ui-msg-text">${t.text}</div>`),null==t.width&&(t.width=350),null==t.height&&(t.height=170),null==t.hideOn&&(t.hideOn=["esc"]),null==t.on&&(u=t,t=new l,d.extend(t,u)),t.on("open",(e=>{d.bindEvents(a(t.box).find(".w2ui-eaction"),t),a(e.detail.box).find("button, input, textarea, [name=hidden-first]").off(".message").on("keydown.message",(function(e){27==e.keyCode&&t.hideOn.includes("esc")&&(t.cancelAction?t.action(t.cancelAction):t.close())})),setTimeout((()=>t.setFocus(t.focus)),300)})),t.off(".prom");let h={self:t,action:e=>(t.on("action.prom",e),h),close:e=>(t.on("close.prom",e),h),open:e=>(t.on("open.prom",e),h),then:e=>(t.on("open:after.prom",e),h)},c=(null==t.actions&&null==t.buttons&&null==t.html&&(t.actions={Ok(e){e.detail.self.close()}}),t.off(".buttons"),null!=t.actions&&(t.buttons="",Object.keys(t.actions).forEach((e=>{var i=t.actions[e];let s=e;"function"==typeof i&&(t.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}","event"]' name="${e}">${e}</button>`),"object"==typeof i&&(t.buttons+=`<button class="w2ui-btn w2ui-eaction ${i.class||""}" name="${e}" data-click='["action","${e}","event"]'\n                        style="${i.style??""}" ${i.attrs??""}>${i.text||e}</button>`,s=Array.isArray(t.actions)?i.text:e),"string"==typeof i&&(t.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${i}" data-click='["action","${i}","event"]'>${i}</button>`,s=i),"string"==typeof s&&(s=s[0].toLowerCase()+s.substr(1).replace(/\s+/g,"")),h[s]=function(e){return t.on("action.buttons",(t=>{t.detail.action[0].toLowerCase()+t.detail.action.substr(1).replace(/\s+/g,"")==s&&e(t)})),h}}))),Array("html","body","buttons").forEach((e=>{t[e]=String(t[e]??"").trim()})),""===t.body&&""===t.buttons||(t.html=`\n                <div class="w2ui-message-body">${t.body||""}</div>\n                <div class="w2ui-message-buttons">${t.buttons||""}</div>\n            `),getComputedStyle(a(e.box).get(0)));var u=parseFloat(c.width),p=parseFloat(c.height);let m=0,g=(0<a(e.after).length&&(c=getComputedStyle(a(e.after).get(0)),m=parseInt("none"!=c.display?parseInt(c.height):0)),t.width>u&&(t.width=u-10),t.height>p-m&&(t.height=p-10-m),t.originalWidth=t.width,t.originalHeight=t.height,parseInt(t.width)<0&&(t.width=u+t.width),parseInt(t.width)<10&&(t.width=10),parseInt(t.height)<0&&(t.height=p+t.height-m),parseInt(t.height)<10&&(t.height=10),t.originalHeight<0&&(t.height=p+t.originalHeight-m),t.originalWidth<0&&(t.width=u+2*t.originalWidth),a(e.box).find(e.after));return t.tmp||(t.tmp={zIndex:g.css("z-index"),overflow:c.overflow}),""===t.html&&""===t.body&&""===t.buttons?n():(t.msgIndex=a(e.box).find(".w2ui-message").length,0===t.msgIndex&&"function"==typeof this.lock&&(a(e.box).css("overflow","hidden"),e.owner?e.owner.lock(e.param):this.lock(e.box)),a(e.box).find(".w2ui-message").css("z-index",1390),g.css("z-index",1501),p=`\n                <div id="w2ui-message-${e.owner?.name}-${t.msgIndex}" class="w2ui-message" data-mousedown="stop"\n                    style="z-index: 1500; left: ${(u-t.width)/2}px; top: ${m}px;\n                        width: ${t.width}px; height: ${t.height}px; transform: translateY(-${t.height}px)"\n                    ${t.hideOn.includes("click")?e.param?`data-click='["message", "${e.param}"]`:'data-click="message"':""}>\n                    <span name="hidden-first" tabindex="0" style="position: absolute; top: 0; outline: none"></span>\n                    ${t.html}\n                    <span name="hidden-last" tabindex="0" style="position: absolute; top: 0; outline: none"></span>\n                </div>`,0<a(e.after).length?a(e.box).find(e.after).after(p):a(e.box).prepend(p),t.box=a(e.box).find(`#w2ui-message-${e.owner?.name}-`+t.msgIndex)[0],d.bindEvents(t.box,this),a(t.box).addClass("animating"),(t.box._msg_options=t).box._msg_prevFocus=document.activeElement,setTimeout((()=>{!0===(o=t.trigger("open",{target:this.name,box:t.box,self:t})).isCancelled?(a(e.box).find(`#w2ui-message-${e.owner?.name}-`+t.msgIndex).remove(),0===t.msgIndex&&(g.css("z-index",t.tmp.zIndex),a(e.box).css("overflow",t.tmp.overflow))):a(t.box).css({transition:"0.3s",transform:"translateY(0px)"})}),0),s=setTimeout((()=>{a(e.box).find(`#w2ui-message-${e.owner?.name}-`+t.msgIndex).removeClass("animating").css({transition:"0s"}),o.finish()}),300)),t.action=(e,i)=>{let s=t.actions[e];s instanceof Object&&s.onClick&&(s=s.onClick),!0!==(e=t.trigger("action",{target:this.name,action:e,self:t,originalEvent:i,value:t.input?t.input.value:null})).isCancelled&&("function"==typeof s&&s(e),e.finish())},t.close=()=>{!0!==(o=t.trigger("close",{target:"self",box:t.box,self:t})).isCancelled&&(clearTimeout(s),a(t.box).hasClass("animating")?(clearTimeout(i),r(t)):(a(t.box).addClass("w2ui-closing animating").css({transition:"0.15s",transform:"translateY(-"+t.height+"px)"}),0!==t.msgIndex&&a(e.box).find(`#w2ui-message-${e.owner?.name}-`+(t.msgIndex-1)).css("z-index",1499),i=setTimeout((()=>{r(t)}),150)))},t.setFocus=t=>{var i=a(e.box).find(".w2ui-message").length-1;let s=a(e.box).find(`#w2ui-message-${e.owner?.name}-`+i),l="input, button, select, textarea, [contentEditable], .w2ui-input";(null!=t?isNaN(t)?s.find(l).filter(t).get(0):s.find(l).get(t):s.find("[name=hidden-first]").get(0))?.focus(),a(e.box).find(".w2ui-message").find(l+",[name=hidden-first],[name=hidden-last]").off(".keep-focus"),a(s).find(l+",[name=hidden-first],[name=hidden-last]").on("blur.keep-focus",(function(e){setTimeout((()=>{var e=document.activeElement,t=0<a(s).find(l).filter(e).length,i=a(e).attr("name");!t&&e&&e!==document.body&&a(s).find(l).get(0)?.focus(),"hidden-last"==i&&a(s).find(l).get(0)?.focus(),"hidden-first"==i&&a(s).find(l).get(-1)?.focus()}),1)}))},h}notify(e,t){return new Promise((i=>{if("object"==typeof e&&(e=(t=e).text),(t=t||{}).where=t.where??document.body,t.timeout=t.timeout??15e3,"function"==typeof this.tmp.notify_resolve&&(this.tmp.notify_resolve(),a(this.tmp.notify_where).find("#w2ui-notify").remove()),this.tmp.notify_resolve=i,this.tmp.notify_where=t.where,clearTimeout(this.tmp.notify_timer),e){if("object"==typeof t.actions){let i={};Object.keys(t.actions).forEach((e=>{i[e]=`<a class="w2ui-notify-link" value="${e}">${e}</a>`})),e=this.execTemplate(e,i)}var s=`\n                    <div id="w2ui-notify">\n                        <div class="${t.class} ${t.error?"w2ui-notify-error":""}">\n                            ${e}\n                            <span class="w2ui-notify-close w2ui-icon-cross"></span>\n                        </div>\n                    </div>`;a(t.where).append(s),a(t.where).find("#w2ui-notify").find(".w2ui-notify-close").on("click",(e=>{a(t.where).find("#w2ui-notify").remove(),i()})),t.actions&&a(t.where).find("#w2ui-notify .w2ui-notify-link").on("click",(e=>{e=a(e.target).attr("value"),t.actions[e](),a(t.where).find("#w2ui-notify").remove(),i()})),0<t.timeout&&(this.tmp.notify_timer=setTimeout((()=>{a(t.where).find("#w2ui-notify").remove(),i()}),t.timeout))}}))}confirm(e,t){return d.normButtons(t="string"==typeof t?{text:t}:t,{yes:"Yes",no:"No"}),(e=d.message(e,t))&&e.action((e=>{e.detail.self.close()})),e}normButtons(e,t){e.actions=e.actions??{};var i=Object.keys(t);return i.forEach((i=>{var s=e["btn_"+i];s&&(t[i]={text:d.lang(s.text??t[i]??""),class:s.class??"",style:s.style??"",attrs:s.attrs??""},delete e["btn_"+i]),Array("text","class","style","attrs").forEach((s=>{e[i+"_"+s]&&("string"==typeof t[i]&&(t[i]={text:t[i]}),t[i][s]=e[i+"_"+s],delete e[i+"_"+s])}))})),i.includes("yes")&&i.includes("no")&&(d.settings.macButtonOrder?d.extend(e.actions,{no:t.no,yes:t.yes}):d.extend(e.actions,{yes:t.yes,no:t.no})),i.includes("ok")&&i.includes("cancel")&&(d.settings.macButtonOrder?d.extend(e.actions,{cancel:t.cancel,ok:t.ok}):d.extend(e.actions,{ok:t.ok,cancel:t.cancel})),e}getSize(e,t){let i=0;if(0<(e=a(e)).length){e=e[0];var s=getComputedStyle(e);switch(t){case"width":i=parseFloat(s.width),"auto"===s.width&&(i=0);break;case"height":i=parseFloat(s.height),"auto"===s.height&&(i=0);break;default:i=parseFloat(s[t]??0)||0}}return i}getStrWidth(e,t,i){let s=a("body > #_tmp_width");return 0===s.length&&(a("body").append('<div id="_tmp_width" style="position: absolute; top: -9000px;"></div>'),s=a("body > #_tmp_width")),s.html(i?e:this.encodeTags(e)).attr("style","position: absolute; top: -9000px; "+(t||"")),s[0].clientWidth}execTemplate(e,t){return"string"==typeof e&&t&&"object"==typeof t?e.replace(/\${([^}]+)?}/g,(function(e,i){return t[i]||i})):e}marker(e,t,i={onlyFirst:!1,wholeWord:!1}){Array.isArray(t)||(t=null!=t&&""!==t?[t]:[]);let s=i.wholeWord;a(e).each((e=>{for(var l=e,o=/\<span class=\"w2ui\-marker\"\>((.|\n|\r)*)\<\/span\>/gi;-1!==l.innerHTML.indexOf('<span class="w2ui-marker"');)l.innerHTML=l.innerHTML.replace(o,"$1");t.forEach((t=>{t=(t="string"!=typeof t?String(t):t).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/>/g,"&lt;"),t=new RegExp((s?"\\b":"")+t+(s?"\\b":"")+"(?!([^<]+)?>)","i"+(i.onlyFirst?"":"g")),e.innerHTML=e.innerHTML.replace(t,(e=>'<span class="w2ui-marker">'+e+"</span>"))}))}))}lang(e,t){if(!e||null==this.settings.phrases||"string"!=typeof e||"<=>=".includes(e))return this.execTemplate(e,t);let i=this.settings.phrases[e];return null==i?(i=e,this.settings.warnNoPhrase&&(this.settings.missing||(this.settings.missing={}),this.settings.missing[e]="---",this.settings.phrases[e]="---",console.log(`Missing translation for "%c${e}%c", see %c w2utils.settings.phrases %c with value "---"`,"color: orange","","color: #999",""))):"---"!==i||this.settings.warnNoPhrase||(i=e),"---"===i&&(i=`<span ${this.tooltip(e)}>---</span>`),this.execTemplate(i,t)}locale(e,t,i){return new Promise(((s,l)=>{if(Array.isArray(e)){this.settings.phrases={};let t=[],i={};e.forEach(((i,s)=>{5===i.length&&(i="locale/"+i.toLowerCase()+".json",e[s]=i),t.push(this.locale(i,!0,!1))})),Promise.allSettled(t).then((t=>{t.forEach((e=>{e.value&&(i[e.value.file]=e.value.data)})),e.forEach((e=>{this.settings=this.extend({},this.settings,i[e])})),s()}))}else(e=e||"en-us")instanceof Object?this.settings=this.extend({},this.settings,o,e):(5===e.length&&(e="locale/"+e.toLowerCase()+".json"),fetch(e,{method:"GET"}).then((e=>e.json())).then((l=>{!0!==i&&(this.settings=t?this.extend({},this.settings,l):this.extend({},this.settings,o,{phrases:{}},l)),s({file:e,data:l})})).catch((t=>{console.log("ERROR: Cannot load locale "+e),l(t)})))}))}scrollBarSize(){return this.tmp.scrollBarSize||(a("body").append('\n            <div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">\n                <div style="height: 120px">1</div>\n            </div>\n        '),this.tmp.scrollBarSize=100-a("#_scrollbar_width > div")[0].clientWidth,a("#_scrollbar_width").remove()),this.tmp.scrollBarSize}checkName(e){return null==e?(console.log('ERROR: Property "name" is required but not supplied.'),!1):null!=r[e]?(console.log(`ERROR: Object named "${e}" is already registered as w2ui.${e}.`),!1):!!this.isAlphaNumeric(e)||(console.log('ERROR: Property "name" has to be alpha-numeric (a-z, 0-9, dash and underscore).'),!1)}checkUniqueId(e,t,i,s){Array.isArray(t)||(t=[t]);let l=!0;return t.forEach((o=>{o.id===e&&(console.log(`ERROR: The item id="${e}" is not unique within the ${i} "${s}".`,t),l=!1)})),l}encodeParams(e,t=""){let i="";return Object.keys(e).forEach((s=>{""!=i&&(i+="&"),"object"==typeof e[s]?i+=this.encodeParams(e[s],t+s+(t?"]":"")+"["):i+=""+t+s+(t?"]":"")+"="+e[s]})),i}parseRoute(e){let t=[];return e=e.replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,((e,i,s,l,o,n)=>(t.push({name:l,optional:!!n}),i=i||"",(n?"":i)+"(?:"+(n?i:"")+(s||"")+(o||(s?"([^/.]+?)":"([^/]+?)"))+")"+(n||"")))).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),{path:new RegExp("^"+e+"$","i"),keys:t}}getCursorPosition(e){if(null==e)return null;let t=0;var i,s=e.ownerDocument||e.document,l=s.defaultView||s.parentWindow;let o;return["INPUT","TEXTAREA"].includes(e.tagName)?t=e.selectionStart:l.getSelection?0<(o=l.getSelection()).rangeCount&&((i=(l=o.getRangeAt(0)).cloneRange()).selectNodeContents(e),i.setEnd(l.endContainer,l.endOffset),t=i.toString().length):(o=s.selection)&&"Control"!==o.type&&(l=o.createRange(),(i=s.body.createTextRange()).moveToElementText(e),i.setEndPoint("EndToEnd",l),t=i.text.length),t}setCursorPosition(e,t,i){if(null!=e){var s=document.createRange();let l,o=window.getSelection();if(["INPUT","TEXTAREA"].includes(e.tagName))e.setSelectionRange(t,i??t);else{for(let i=0;i<e.childNodes.length;i++){let s=a(e.childNodes[i]).text();if(t<=(s=e.childNodes[i].tagName?(s=a(e.childNodes[i]).html()).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&nbsp;/g," "):s).length){(l=(l=e.childNodes[i]).childNodes&&0<l.childNodes.length?l.childNodes[0]:l).childNodes&&0<l.childNodes.length&&(l=l.childNodes[0]);break}t-=s.length}null!=l&&(t>l.length&&(t=l.length),s.setStart(l,t),i?s.setEnd(l,i):s.collapse(!0),o.removeAllRanges(),o.addRange(s))}}}parseColor(e){if("string"!=typeof e)return null;let t={};if(3===(e="#"===(e=e.trim().toUpperCase())[0]?e.substr(1):e).length)t={r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:1};else if(6===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:1};else if(8===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:Math.round(parseInt(e.substr(6,2),16)/255*100)/100};else if(4<e.length&&"RGB("===e.substr(0,4)){var i=e.replace("RGB","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:1}}else{if(!(5<e.length&&"RGBA("===e.substr(0,5)))return null;i=e.replace("RGBA","").replace(/\(/g,"").replace(/\)/g,"").split(","),t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:parseFloat(i[3])}}return t}colorContrast(e,t){return e=i(e),t=i(t),((Math.max(e,t)+.05)/(Math.min(e,t)+.05)).toFixed(2);function i(e){var{r:e,g:t,b:i}=d.parseColor(e)??{r:0,g:0,b:0},t=t/255,i=i/255;return.2126*((e/=255)<=.03928?e/12.92:Math.pow((.055+e)/1.055,2.2))+.7152*(t<=.03928?t/12.92:Math.pow((.055+t)/1.055,2.2))+.0722*(i<=.03928?i/12.92:Math.pow((.055+i)/1.055,2.2))}}hsv2rgb(e,t,i,s){let l,o,n,a,r,d,h,c;switch(1===arguments.length&&(t=e.s,i=e.v,s=e.a,e=e.h),d=(i/=100)*(1-(t/=100)),h=i*(1-(r=6*(e/=360)-(a=Math.floor(6*e)))*t),c=i*(1-(1-r)*t),a%6){case 0:l=i,o=c,n=d;break;case 1:l=h,o=i,n=d;break;case 2:l=d,o=i,n=c;break;case 3:l=d,o=h,n=i;break;case 4:l=c,o=d,n=i;break;case 5:l=i,o=d,n=h}return{r:Math.round(255*l),g:Math.round(255*o),b:Math.round(255*n),a:null!=s?s:1}}rgb2hsv(e,t,i,s){1===arguments.length&&(t=e.g,i=e.b,s=e.a,e=e.r);let l,o=Math.max(e,t,i),n=Math.min(e,t,i),a=o-n,r=0===o?0:a/o,d=o/255;switch(o){case n:l=0;break;case e:l=t-i+a*(t<i?6:0),l/=6*a;break;case t:l=i-e+2*a,l/=6*a;break;case i:l=e-t+4*a,l/=6*a}return{h:Math.round(360*l),s:Math.round(100*r),v:Math.round(100*d),a:null!=s?s:1}}tooltip(e,t){let i="mouseenter",s="mouseleave";return t=(t="object"==typeof e?e:t)||{},"string"==typeof e&&(t.html=e),t.showOn&&(i=t.showOn,delete t.showOn),t.hideOn&&(s=t.hideOn,delete t.hideOn),t.name||(t.name="no-name"),` on${i}="w2tooltip.show(this, JSON.parse(w2utils.base64decode('${this.base64encode(JSON.stringify(t))}')))" on${s}="w2tooltip.hide('${t.name}')"`}isPlainObject(e){return null!=e&&"[object Object]"===Object.prototype.toString.call(e)&&(void 0===e.constructor||null===(e=Object.getPrototypeOf(e))||e===Object.prototype)}clone(e,t){let i;return t=Object.assign({functions:!0,elements:!0,events:!0,exclude:[]},t??{}),Array.isArray(e)?(i=Array.from(e)).forEach(((e,s)=>{i[s]=this.clone(e,t)})):this.isPlainObject(e)?(i={},Object.assign(i,e),t.exclude&&t.exclude.forEach((e=>{delete i[e]})),Object.keys(i).forEach((e=>{i[e]=this.clone(i[e],t),void 0===i[e]&&delete i[e]}))):e instanceof Function&&!t.functions||e instanceof Node&&!t.elements||e instanceof Event&&!t.events||(i=e),i}extend(e,t){if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Arrays can be extended with arrays only");e.splice(0,e.length),t.forEach((t=>{e.push(this.clone(t))}))}else{if(e instanceof Node||e instanceof Event)throw new Error("HTML elmenents and events cannot be extended");if(e&&"object"==typeof e&&null!=t){if("object"!=typeof t)throw new Error("Object can be extended with other objects only.");Object.keys(t).forEach((i=>{var s;null!=e[i]&&"object"==typeof e[i]&&null!=t[i]&&"object"==typeof t[i]?(s=this.clone(t[i]),e[i]instanceof Node||e[i]instanceof Event?e[i]=s:(Array.isArray(e[i])&&this.isPlainObject(s)&&(e[i]={}),this.extend(e[i],s))):e[i]=this.clone(t[i])}))}else if(null!=t)throw new Error("Object is not extendable, only {} or [] can be extended.")}if(2<arguments.length)for(let t=2;t<arguments.length;t++)this.extend(e,arguments[t]);return e}naturalCompare(e,t){let i,s,l=1,o=0,n=0,a=String.alphabet;function r(e,t,s){if(s){for(i=t;(s=r(e,i))<76&&65<s;)++i;return+e.slice(t-1,i)}return-1<(s=a&&a.indexOf(e.charAt(t)))?s+76:(s=e.charCodeAt(t)||0)<45||127<s?s:s<46?65:s<48?s-1:s<58?s+18:s<65?s-11:s<91?s+11:s<97?s-37:s<123?s+5:s-63}if((e+="")!=(t+=""))for(;l;)if(s=r(e,o++),l=r(t,n++),s<76&&l<76&&66<s&&66<l&&(s=r(e,o,o),l=r(t,n,o=i),n=i),s!=l)return s<l?-1:1;return 0}normMenu(e,t){return Array.isArray(e)?(e.forEach(((t,i)=>{"string"==typeof t||"number"==typeof t?e[i]={id:t,text:String(t)}:null!=t?(null!=t.caption&&null==t.text&&(t.text=t.caption),null!=t.text&&null==t.id&&(t.id=t.text),null==t.text&&null!=t.id&&(t.text=t.id)):e[i]={id:null,text:"null"}})),e):"function"==typeof e?(t=e.call(this,e,t),d.normMenu.call(this,t)):"object"==typeof e?Object.keys(e).map((t=>({id:t,text:e[t]}))):void 0}prepareParams(e,t,i){i=i??d.settings.dataType;let s=t.body;switch(i){case"HTTPJSON":s={request:s},["PUT","DELETE"].includes(t.method)&&(t.method="POST"),l();break;case"HTTP":["PUT","DELETE"].includes(t.method)&&(t.method="POST"),l();break;case"RESTFULL":["PUT","DELETE"].includes(t.method)?t.headers["Content-Type"]="application/json":l();break;case"JSON":"GET"==t.method?(s={request:s},l()):(t.headers["Content-Type"]="application/json",t.method="POST")}return t.body="string"==typeof t.body?t.body:JSON.stringify(t.body),t;function l(){Object.keys(s).forEach((t=>{let i=s[t];"object"==typeof i&&(i=JSON.stringify(i)),e.searchParams.append(t,i)})),delete t.body}}bindEvents(e,t){0!=e.length&&(e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),a(e).each((e=>{let i=a(e).data();Object.keys(i).forEach((s=>{if(-1!=["click","dblclick","mouseenter","mouseleave","mouseover","mouseout","mousedown","mousemove","mouseup","contextmenu","focus","focusin","focusout","blur","input","change","keydown","keyup","keypress"].indexOf(String(s).toLowerCase())){let l=i[s],o=(l="string"==typeof l?l.split("|").map((e=>{"null"===(e="undefined"===(e="false"!==(e="true"===e||e)&&e)?void 0:e)&&(e=null);var t=["'",'"',"`"];return"string"==typeof(e=parseFloat(e)==e?parseFloat(e):e)&&t.includes(e[0])&&t.includes(e[e.length-1])?e.substring(1,e.length-1):e})):l)[0];l=l.slice(1),a(e).off(s+".w2utils-bind").on(s+".w2utils-bind",(function(e){switch(o){case"alert":alert(l[0]);break;case"stop":e.stopPropagation();break;case"prevent":e.preventDefault();break;case"stopPrevent":return e.stopPropagation(),e.preventDefault(),!1;default:if(null==t[o])throw new Error(`Cannot dispatch event as the method "${o}" does not exist.`);t[o].apply(t,l.map(((t,i)=>{switch(String(t).toLowerCase()){case"event":return e;case"this":return this;default:return t}})))}}))}}))})))}debounce(e,t=250){let i;return(...s)=>{clearTimeout(i),i=setTimeout((()=>{e(...s)}),t)}}};function h(e,t,i){let s;return t={title:d.lang(t??"Notification"),body:`<div class="w2ui-centered w2ui-msg-text">${e}</div>`,showClose:!1,actions:{ok:"Ok"},cancelAction:"ok"},(s=0<a("#w2ui-popup").length&&"closing"!=p.status?p.message(t):p.open(t)).ok((e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i()})),s}function c(e,t,i){let s,l=e;return(l=["string","number"].includes(typeof l)?{msg:l}:l).msg&&(l.body=`<div class="w2ui-centered w2ui-msg-text">${l.msg}</div>`,delete l.msg),"function"==typeof t&&null==i&&(i=t,t=void 0),d.extend(l,{title:d.lang(t??l.title??"Confirmation"),showClose:!1,modal:!0,cancelAction:"no"}),null==i&&null!=l.callBack&&(i=l.callBack),d.normButtons(l,{yes:"Yes",no:"No"}),(s=0<a("#w2ui-popup").length&&"closing"!=p.status?p.message(l):p.open(l)).self.off(".confirm").on("action:after.confirm",(e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i(e.detail.action)})),s}function u(e,t,i){let s,l=e;return(l=["string","number"].includes(typeof l)?{label:l}:l).label&&(l.focus=1,l.body=l.textarea?`<div class="w2ui-prompt textarea">\n                 <div>${l.label}</div>\n                 <textarea id="w2prompt" class="w2ui-input" ${l.attrs??""}\n                    data-keydown="keydown|event" data-keyup="change|event">${l.value??""}</textarea>\n               </div>`:`<div class="w2ui-prompt w2ui-centered">\n                 <label>${l.label}</label>\n                 <input id="w2prompt" class="w2ui-input" ${l.attrs??""}\n                    data-keydown="keydown|event" data-keyup="change|event" value="${l.value??""}">\n               </div>`),d.extend(l,{title:d.lang(t??l.title??"Notification"),showClose:!1,modal:!0,cancelAction:"cancel"}),d.normButtons(l,{ok:"Ok",cancel:"Cancel"}),(s=0<a("#w2ui-popup").length&&"closing"!=p.status?p.message(l):p.open(l)).self.box?s.self.input=a(s.self.box).find("#w2prompt").get(0):s.self.input=a("#w2ui-popup .w2ui-popup-body #w2prompt").get(0),null!==l.value&&s.self.input.select(),s.change=function(e){return s.self.on("change",e),this},s.self.off(".prompt").on("open:after.prompt",(e=>{e=e.detail.box||a("#w2ui-popup .w2ui-popup-body").get(0),d.bindEvents(a(e).find("#w2prompt"),{keydown(e){27==e.keyCode&&e.stopPropagation()},change(e){var t=s.self.trigger("change",{target:"prompt",originalEvent:e});!0!==t.isCancelled&&(13==e.keyCode&&(e.ctrlKey||e.metaKey||"TEXTAREA"!=e.target.tagName)&&s.self.action("Ok",e),27==e.keyCode&&s.self.action("Cancel",e),t.finish())}}),a(e).find(".w2ui-eaction").trigger("keyup")})).on("action:after.prompt",(e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i(e.detail.action)})),s}let p=new class extends l{constructor(){super(),this.defaults={title:"",text:"",body:"",buttons:"",width:450,height:250,focus:null,actions:null,style:"",speed:.3,blockPage:!0,modal:!1,maximized:!1,keyboard:!0,showClose:!0,showMax:!1,resizable:!1,transition:null,openMaximized:!1,moved:!1},this.name="popup",this.status="closed",this.onOpen=null,this.onClose=null,this.onMax=null,this.onMin=null,this.onToggle=null,this.onKeydown=null,this.onAction=null,this.onMove=null,this.tmp={},this.handleResize=e=>{this.options.moved||this.center(void 0,void 0,!0)}}open(e){let t=this;"closing"!=this.status&&!a("#w2ui-popup").hasClass("animating")||this.close(!0);var i=this.options;let s,l,o;null!=(e=["string","number"].includes(typeof e)?d.extend({title:"Notification",body:`<div class="w2ui-centered">${e}</div>`,actions:{Ok(){t.close()}},cancelAction:"ok"},arguments[1]??{}):e).text&&(e.body=`<div class="w2ui-centered w2ui-msg-text">${e.text}</div>`),e=Object.assign({},this.defaults,i,{title:"",body:""},e,{maximized:!1}),this.options=e,0===a("#w2ui-popup").length&&(this.off("*"),Object.keys(this).forEach((e=>{e.startsWith("on")&&"on"!=e&&(this[e]=null)}))),Object.keys(e).forEach((t=>{t.startsWith("on")&&"on"!=t&&e[t]&&(this[t]=e[t])})),e.width=parseInt(e.width),e.height=parseInt(e.height);var{top:n,left:r}=this.center();let h={self:this,action:e=>(t.on("action.prom",e),h),close:e=>(t.on("close.prom",e),h),then:e=>(t.on("open:after.prom",e),h)},c=(null==e.actions||e.buttons||(e.buttons="",Object.keys(e.actions).forEach((i=>{var s=e.actions[i];let l=i;"function"==typeof s&&(e.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${i}" data-click='["action","${i}","event"]'>${i}</button>`),"object"==typeof s&&(e.buttons+=`<button class="w2ui-btn w2ui-eaction ${s.class||""}" name="${i}" data-click='["action","${i}","event"]'\n                        style="${s.style}" ${s.attrs}>${s.text||i}</button>`,l=Array.isArray(e.actions)?s.text:i),"string"==typeof s&&(l=s[0].toLowerCase()+s.substr(1).replace(/\s+/g,""),e.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${i}" data-click='["action","${l}","event"]'>${s}</button>`),"string"==typeof l&&(l=l[0].toLowerCase()+l.substr(1).replace(/\s+/g,"")),h[l]=function(e){return t.on("action.buttons",(t=>{t.detail.action[0].toLowerCase()+t.detail.action.substr(1).replace(/\s+/g,"")==l&&e(t)})),h}}))),"");if(e.showClose&&(c+='<div class="w2ui-popup-button w2ui-popup-close">\n                        <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>\n                    </div>'),e.showMax&&(c+='<div class="w2ui-popup-button w2ui-popup-max">\n                        <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>\n                    </div>'),0===a("#w2ui-popup").length){if(!0===(s=this.trigger("open",{target:"popup",present:!1})).isCancelled)return;this.status="opening",e.blockPage&&d.lock(document.body,{opacity:.3,onClick:e.modal?null:()=>{this.close()}}),r=`\n                left: ${r}px;\n                top: ${n}px;\n                width: ${parseInt(e.width)}px;\n                height: ${parseInt(e.height)}px;\n                transition: ${e.speed}s\n            `,l=`<div id="w2ui-popup" class="w2ui-popup w2ui-anim-open animating ${e.blockPage?"":"w2ui-non-blocking"}" style="${d.stripSpaces(r)}"></div>`,a("body").append(l),a("#w2ui-popup")[0]._w2popup={self:this,created:new Promise((e=>{this._promCreated=e})),opened:new Promise((e=>{this._promOpened=e})),closing:new Promise((e=>{this._promClosing=e})),closed:new Promise((e=>{this._promClosed=e}))},r=(e.title?"":"top: 0px !important;")+" "+(e.buttons?"":"bottom: 0px !important;"),l=`\n                <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>\n                <div class="w2ui-popup-title-btns">${c}</div>\n                <div class="w2ui-popup-title" style="${e.title?"":"display: none"}"></div>\n                <div class="w2ui-box" style="${r}">\n                    <div class="w2ui-popup-body ${!e.title||" w2ui-popup-no-title"}\n                        ${!e.buttons||" w2ui-popup-no-buttons"}" style="${e.style}">\n                    </div>\n                </div>\n                <div class="w2ui-popup-buttons" style="${e.buttons?"":"display: none"}"></div>\n                <div class="w2ui-popup-resizer resize-point resize-icon"></div>\n                <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>\n            `,a("#w2ui-popup").html(l),e.title&&a("#w2ui-popup .w2ui-popup-title").append(d.lang(e.title)),e.buttons&&a("#w2ui-popup .w2ui-popup-buttons").append(e.buttons),e.body&&a("#w2ui-popup .w2ui-popup-body").append(e.body),setTimeout((()=>{a("#w2ui-popup").css("transition",e.speed+"s").removeClass("w2ui-anim-open"),d.bindEvents("#w2ui-popup .w2ui-eaction",this),a("#w2ui-popup").find(".w2ui-popup-body").show(),this._promCreated()}),1),clearTimeout(this._timer),this._timer=setTimeout((()=>{this.status="open",t.setFocus(e.focus),s.finish(),this._promOpened(),a("#w2ui-popup").removeClass("animating")}),1e3*e.speed)}else{if(!0===(s=this.trigger("open",{target:"popup",present:!0})).isCancelled)return;this.status="opening",null!=i&&(i.maximized||i.width==e.width&&i.height==e.height||this.resize(e.width,e.height),e.prevSize=e.width+"px:"+e.height+"px",e.maximized=i.maximized),n=a("#w2ui-popup .w2ui-box").get(0).cloneNode(!0),a(n).removeClass("w2ui-box").addClass("w2ui-box-temp").find(".w2ui-popup-body").empty().append(e.body),a("#w2ui-popup .w2ui-box").after(n),e.buttons?(a("#w2ui-popup .w2ui-popup-buttons").show().html("").append(e.buttons),a("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-buttons"),a("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","")):(a("#w2ui-popup .w2ui-popup-buttons").hide().html(""),a("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-buttons"),a("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","0px")),e.title?(a("#w2ui-popup .w2ui-popup-title").show().html(d.lang(e.title)),a("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-title"),a("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","")):(a("#w2ui-popup .w2ui-popup-title").hide().html(""),a("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-title"),a("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","0px")),c?a("#w2ui-popup .w2ui-popup-title-btns").show().html(c):a("#w2ui-popup .w2ui-popup-title-btns").hide();let l=a("#w2ui-popup .w2ui-box")[0],o=a("#w2ui-popup .w2ui-box-temp")[0];a("#w2ui-popup").addClass("animating"),d.transition(l,o,e.transition,(()=>{a(l).remove(),a(o).removeClass("w2ui-box-temp").addClass("w2ui-box");var i=a(o).find(".w2ui-popup-body");1==i.length&&(i[0].style.cssText=e.style,i.show()),t.setFocus(e.focus),a("#w2ui-popup").removeClass("animating")})),this.status="open",s.finish(),d.bindEvents("#w2ui-popup .w2ui-eaction",this),a("#w2ui-popup").find(".w2ui-popup-body").show()}return e.openMaximized&&this.max(),e._last_focus=document.activeElement,e.keyboard&&a(document.body).off(".w2popup").on("keydown.w2popup",(e=>{this.keydown(e)})),a(window).on("resize",this.handleResize),o={changing:!1,mvMove:function(e){1==o.changing&&(e=e||window.event,o.div_x=e.screenX-o.x,o.div_y=e.screenY-o.y,!0!==(e=t.trigger("move",{target:"popup",div_x:o.div_x,div_y:o.div_y,originalEvent:e})).isCancelled)&&("moving"==t.status?(a("#w2ui-popup").css({transition:"none",transform:"translate3d("+o.div_x+"px, "+o.div_y+"px, 0px)"}),t.options.moved=!0):a("#w2ui-popup").css({transition:"none",width:o.width+o.div_x+"px",height:o.height+o.div_y+"px"}),e.finish())},mvStop:function(e){1!=o.changing||(e=e||window.event,o.div_x=e.screenX-o.x,o.div_y=e.screenY-o.y,"moving"==t.status?a("#w2ui-popup").css({left:o.pos_x+o.div_x+"px",top:o.pos_y+o.div_y+"px"}).css({transition:"none",transform:"translate3d(0px, 0px, 0px)"}):(a("#w2ui-popup").css({transition:"none",width:o.width+o.div_x+"px",height:o.height+o.div_y+"px"}),t.resizeMessages()),o.changing=!1,t.status="open",a(document.body).off(".w2ui-popup"),o.isLocked)||t.unlock()}},a("#w2ui-popup .w2ui-popup-title").off("mousedown").on("mousedown",(function(e){t.options.maximized||u(e)})),e.resizable?(a("#w2ui-popup .w2ui-popup-resizer").show(),a("#w2ui-popup .w2ui-popup-resizer").off("mousedown").on("mousedown",(e=>{u(e,!0)}))):a("#w2ui-popup .w2ui-popup-resizer").hide(),h;function u(e,i){e=e||window.event,t.status=i?"resizing":"moving",i=a("#w2ui-popup").get(0).getBoundingClientRect(),Object.assign(o,{changing:!0,isLocked:1==a("#w2ui-popup > .w2ui-lock").length,x:e.screenX,y:e.screenY,pos_x:i.x,pos_y:i.y,width:i.width,height:i.height}),o.isLocked||t.lock({opacity:0}),a(document.body).on("mousemove.w2ui-popup",o.mvMove).on("mouseup.w2ui-popup",o.mvStop),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault()}}load(e){return new Promise(((t,i)=>{if(null==(e="string"==typeof e?{url:e}:e).url)console.log("ERROR: The url is not defined."),i("The url is not defined");else{this.status="loading";let[i,s]=String(e.url).split("#");i&&fetch(i).then((e=>e.text())).then((i=>{t(this.template(i,s,e))}))}}))}template(e,t,i={}){let s;try{s=a(e)}catch(t){s=a.html(e)}return t&&(s=s.filter("#"+t)),Object.assign(i,{width:parseInt(a(s).css("width")),height:parseInt(a(s).css("height")),title:a(s).find("[rel=title]").html(),body:a(s).find("[rel=body]").html(),buttons:a(s).find("[rel=buttons]").html(),style:a(s).find("[rel=body]").get(0).style.cssText}),this.open(i)}action(e,t){let i=this.options.actions[e];i instanceof Object&&i.onClick&&(i=i.onClick),!0!==(e=this.trigger("action",{action:e,target:"popup",self:this,originalEvent:t,value:this.input?this.input.value:null})).isCancelled&&("function"==typeof i&&i.call(this,t),e.finish())}keydown(e){var t;this.options&&!this.options.keyboard||!0!==(t=this.trigger("keydown",{target:"popup",originalEvent:e})).isCancelled&&(27===e.keyCode&&(e.preventDefault(),0==a("#w2ui-popup .w2ui-message").length)&&(this.options.cancelAction?this.action(this.options.cancelAction):this.close()),t.finish())}close(e){let t=this.trigger("close",{target:"popup"});var i;!0!==t.isCancelled&&(i=()=>{a("#w2ui-popup").remove(),this.options._last_focus&&0<this.options._last_focus.length&&this.options._last_focus.focus(),this.status="closed",this.options={},t.finish(),this._promClosed()},0!==a("#w2ui-popup").length)&&"closed"!=this.status&&("opening"==this.status&&(e=!0),"closing"==this.status&&!0===e?(i(),clearTimeout(this.tmp.closingTimer),d.unlock(document.body,0)):(this.status="closing",a("#w2ui-popup").css("transition",this.options.speed+"s").addClass("w2ui-anim-close animating"),d.unlock(document.body,300),this._promClosing(),e?i():this.tmp.closingTimer=setTimeout(i,1e3*this.options.speed),this.options.keyboard&&a(document.body).off("keydown",this.keydown),a(window).off("resize",this.handleResize)))}toggle(){let e=this.trigger("toggle",{target:"popup"});!0!==e.isCancelled&&(!0===this.options.maximized?this.min():this.max(),setTimeout((()=>{e.finish()}),1e3*this.options.speed+50))}max(){if(!0!==this.options.maximized){let t=this.trigger("max",{target:"popup"});var e;!0!==t.isCancelled&&(this.status="resizing",e=a("#w2ui-popup").get(0).getBoundingClientRect(),this.options.prevSize=e.width+":"+e.height,this.resize(1e4,1e4,(()=>{this.status="open",this.options.maximized=!0,t.finish()})))}}min(){if(!0===this.options.maximized){var e=this.options.prevSize.split(":");let t=this.trigger("min",{target:"popup"});!0!==t.isCancelled&&(this.status="resizing",this.options.maximized=!1,this.resize(parseInt(e[0]),parseInt(e[1]),(()=>{this.status="open",this.options.prevSize=null,t.finish()})))}}clear(){a("#w2ui-popup .w2ui-popup-title").html(""),a("#w2ui-popup .w2ui-popup-body").html(""),a("#w2ui-popup .w2ui-popup-buttons").html("")}reset(){this.open(this.defaults)}message(e){return d.message({owner:this,box:a("#w2ui-popup").get(0),after:".w2ui-popup-title"},e)}confirm(e){return d.confirm({owner:this,box:a("#w2ui-popup"),after:".w2ui-popup-title"},e)}setFocus(e){let t=a("#w2ui-popup"),i="input, button, select, textarea, [contentEditable], [tabindex], .w2ui-input";null!=e?(isNaN(e)?t.find(i).filter(e).get(0):t.find(i).get(e))?.focus():(e=t.find("[name=hidden-first]").get(0))&&e.focus(),a(t).find(i).off(".keep-focus").on("blur.keep-focus",(function(e){setTimeout((()=>{var e=document.activeElement,s=0<a(t).find(i).filter(e).length,l=a(e).attr("name");!s&&e&&e!==document.body&&a(t).find(i).get(0)?.focus(),"hidden-last"==l&&a(t).find(i).get(1)?.focus(),"hidden-first"==l&&a(t).find(i).get(-2)?.focus()}),1)}))}lock(e,t){var i=Array.from(arguments);i.unshift(a("#w2ui-popup")),d.lock(...i)}unlock(e){d.unlock(a("#w2ui-popup"),e)}center(e,t,i){let s,l;l=null==window.innerHeight?(s=parseInt(document.documentElement.offsetWidth),parseInt(document.documentElement.offsetHeight)):(s=parseInt(window.innerWidth),parseInt(window.innerHeight)),e=parseInt(e??this.options.width),t=parseInt(t??this.options.height),!0===this.options.maximized&&(e=s,t=l),s-10<e&&(e=s-10),l-10<t&&(t=l-10);var o=(l-t)/3,n=(s-e)/2;return i&&(a("#w2ui-popup").css({transition:"none",top:o+"px",left:n+"px",width:e+"px",height:t+"px"}),this.resizeMessages()),{top:o,left:n,width:e,height:t}}resize(e,t,i){let s=this;null==this.options.speed&&(this.options.speed=0);var{top:e,left:t,width:l,height:o}=this.center(e,t),n=this.options.speed;a("#w2ui-popup").css({transition:n+`s width, ${n}s height, ${n}s left, ${n}s top`,top:e+"px",left:t+"px",width:l+"px",height:o+"px"});let r=setInterval((()=>{s.resizeMessages()}),10);setTimeout((()=>{clearInterval(r),s.resizeMessages(),"function"==typeof i&&i()}),1e3*this.options.speed+50)}resizeMessages(){a("#w2ui-popup .w2ui-message").each((e=>{var t=e._msg_options,i=a("#w2ui-popup"),s=(parseInt(t.width)<10&&(t.width=10),parseInt(t.height)<10&&(t.height=10),i[0].getBoundingClientRect()),l=(i=parseInt(i.find(".w2ui-popup-title")[0].clientHeight),parseInt(s.width));s=parseInt(s.height),t.width=t.originalWidth,t.width>l-10&&(t.width=l-10),t.height=t.originalHeight,t.height>s-i-5&&(t.height=s-i-5),t.originalHeight<0&&(t.height=s+t.originalHeight-i),t.originalWidth<0&&(t.width=l+2*t.originalWidth),a(e).css({left:(l-t.width)/2+"px",width:t.width+"px",height:t.height+"px"})}))}};class m{static active={};constructor(){this.defaults={name:null,html:"",style:"",class:"",position:"top|bottom",align:"",anchor:null,contextMenu:!1,anchorClass:"",anchorStyle:"",autoShow:!1,autoShowOn:null,autoHideOn:null,arrowSize:8,screenMargin:2,autoResize:!0,margin:1,offsetX:0,offsetY:0,maxWidth:null,maxHeight:null,watchScroll:null,watchResize:null,hideOn:null,onThen:null,onShow:null,onHide:null,onUpdate:null,onMove:null}}static observeRemove=new MutationObserver((e=>{let t=0;Object.keys(m.active).forEach((e=>{(e=m.active[e]).displayed&&(e.anchor&&e.anchor.isConnected?t++:e.hide())})),0===t&&m.observeRemove.disconnect()}));trigger(e,t){var i;if(2==arguments.length&&(i=e,(e=t).type=i),e.overlay)return e.overlay.trigger(e);console.log("ERROR: cannot find overlay where to trigger events")}get(e){return 0==arguments.length?Object.keys(m.active):!0===e?m.active:m.active[e.replace(/[\s\.#]/g,"_")]}attach(e,t){let i,s,o=this;if(0!=arguments.length){1==arguments.length&&e instanceof Object?e=(i=e).anchor:2===arguments.length&&"string"==typeof t?t=(i={anchor:e,html:t}).html:2===arguments.length&&null!=t&&"object"==typeof t&&(t=(i=t).html),i=d.extend({},this.defaults,i||{}),!(t=!t&&i.text?i.text:t)&&i.html&&(t=i.html),delete i.anchor;let n=i.name||e?.id;e!=document&&null!=e||(e=document.body),i.contextMenu&&(e=document.body,n=n??"context-menu"),n||(n="noname-"+Object.keys(m.active).length,console.log("NOTICE: name property is not defined for tooltip, could lead to too many instances")),n=n.replace(/[\s\.#]/g,"_"),m.active[n]?((s=m.active[n]).prevOptions=s.options,s.options=i,s.anchor=e,s.prevOptions.html==s.options.html&&s.prevOptions.class==s.options.class&&s.prevOptions.style==s.options.style||(s.needsUpdate=!0),i=s.options,Object.keys(s).forEach((e=>{var t=s[e];e.startsWith("on")&&"function"==typeof t&&delete s[e]}))):(s=new l,Object.assign(s,{id:"w2overlay-"+n,name:n,options:i,anchor:e,self:o,displayed:!1,tmp:{observeResize:new ResizeObserver((()=>{this.resize(s.name)}))},hide(){o.hide(n)}}),m.active[n]=s),Object.keys(s.options).forEach((e=>{var t=s.options[e];e.startsWith("on")&&"function"==typeof t&&(s[e]=t,delete s.options[e])})),!0===i.autoShow&&(i.autoShowOn=i.autoShowOn??"mouseenter",i.autoHideOn=i.autoHideOn??"mouseleave",i.autoShow=!1,i._keep=!0),i.autoShowOn&&(t="autoShow-"+s.name,a(e).off("."+t).on(i.autoShowOn+"."+t,(e=>{o.show(s.name),e.stopPropagation()})),delete i.autoShowOn,i._keep=!0),i.autoHideOn&&(t="autoHide-"+s.name,a(e).off("."+t).on(i.autoHideOn+"."+t,(e=>{o.hide(s.name),e.stopPropagation()})),delete i.autoHideOn,i._keep=!0),s.off(".attach");let r={overlay:s,then:e=>(s.on("show:after.attach",(t=>{e(t)})),r),show:e=>(s.on("show.attach",(t=>{e(t)})),r),hide:e=>(s.on("hide.attach",(t=>{e(t)})),r),update:e=>(s.on("update.attach",(t=>{e(t)})),r),move:e=>(s.on("move.attach",(t=>{e(t)})),r)};return r}}update(e,t){var i=m.active[e];i?(i.needsUpdate=!0,i.options.html=t,this.show(e)):console.log(`Tooltip "${e}" is not displayed. Cannot update it.`)}show(e){if(e instanceof HTMLElement||e instanceof Object){let t=e,i=(e instanceof HTMLElement&&((t=arguments[1]||{}).anchor=e),this.attach(t));return i.overlay.tmp.hidden=!1,a(i.overlay.anchor).off(".autoShow-"+i.overlay.name).off(".autoHide-"+i.overlay.name),setTimeout((()=>{i.overlay.tmp.hidden||(this.show(i.overlay.name),this.initControls&&this.initControls(i.overlay))}),1),i}let t,i=this,s=m.active[e.replace(/[\s\.#]/g,"_")];if(s){let n=s.options;if(!s||s.displayed&&!s.needsUpdate)this.resize(s?.name);else{var l=n.position.split("|");l=["top","bottom"].includes(l[0]);let r="both"==n.align&&l?"":"white-space: nowrap;";if(n.maxWidth&&d.getStrWidth(n.html,"")>n.maxWidth&&(r="width: "+n.maxWidth+"px; white-space: inherit; overflow: auto;"),r+=" max-height: "+(n.maxHeight||window.innerHeight-4)+"px;",""!==n.html&&null!=n.html){if(s.box){if(!0===(t=this.trigger("update",{target:e,overlay:s})).isCancelled)return void(s.prevOptions&&(s.options=s.prevOptions,delete s.prevOptions));a(s.box).find(".w2ui-overlay-body").attr("style",(n.style||"")+"; "+r).removeClass().addClass("w2ui-overlay-body "+n.class).html(n.html)}else{if(!0===(t=this.trigger("show",{target:e,overlay:s})).isCancelled)return;a("body").append(`<div id="${s.id}" name="${e}" style="display: none; pointer-events: none" class="w2ui-overlay"\n                        data-click="stop" data-focusin="stop">\n                    <style></style>\n                    <div class="w2ui-overlay-body ${n.class}" style="${n.style||""}; ${r}">\n                        ${n.html}\n                    </div>\n                </div>`),s.box=a("#"+d.escapeId(s.id))[0],s.displayed=!0,(l=a(s.anchor).data("tooltipName")??[]).push(e),a(s.anchor).data("tooltipName",l),d.bindEvents(s.box,{}),s.tmp.originalCSS="",0<a(s.anchor).length&&(s.tmp.originalCSS=a(s.anchor)[0].style.cssText)}this.resize(s.name),n.anchorStyle&&(s.anchor.style.cssText+=";"+n.anchorStyle),!n.anchorClass||"w2ui-focus"==n.anchorClass&&s.anchor==document.body||a(s.anchor).addClass(n.anchorClass),"string"==typeof n.hideOn&&(n.hideOn=[n.hideOn]),Array.isArray(n.hideOn)||(n.hideOn=[]),Object.assign(s.tmp,{scrollLeft:document.body.scrollLeft,scrollTop:document.body.scrollTop});{let e=e=>{i.hide(s.name)},t=a(s.anchor),l="tooltip-"+s.name;a("html").off("."+l),n.hideOn.includes("doc-click")&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&t.off(`.${l}-doc`).on(`click.${l}-doc`,(e=>{e.stopPropagation()})),a("html").on("click."+l,e)),n.hideOn.includes("focus-change")&&a("html").on("focusin."+l,(e=>{document.activeElement!=s.anchor&&i.hide(s.name)})),["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&(t.off("."+l),n.hideOn.forEach((i=>{-1==["doc-click","focus-change"].indexOf(i)&&t.on(i+"."+l,{once:!0},e)})))}{var o=document.body;let e="tooltip-"+s.name,t=o;"BODY"==o.tagName&&(t=o.ownerDocument),a(t).off("."+e).on("scroll."+e,(e=>{Object.assign(s.tmp,{scrollLeft:o.scrollLeft,scrollTop:o.scrollTop}),i.resize(s.name)}))}return a(s.box).show(),s.tmp.observeResize.observe(s.box),m.observeRemove.observe(document.body,{subtree:!0,childList:!0}),a(s.box).css("opacity",1).find(".w2ui-overlay-body").html(n.html),setTimeout((()=>{a(s.box).css({"pointer-events":"auto"}).data("ready","yes")}),100),delete s.needsUpdate,s.box.overlay=s,t&&t.finish(),{overlay:s}}i.hide(e)}}}hide(e){let t;if(0==arguments.length)Object.keys(m.active).forEach((e=>{this.hide(e)}));else if(e instanceof HTMLElement)(a(e).data("tooltipName")??[]).forEach((e=>{this.hide(e)}));else if("string"==typeof e&&(e=e.replace(/[\s\.#]/g,"_"),t=m.active[e]),t?.tmp&&(t.tmp.hidden=!0),t&&t.box){var i=this.trigger("hide",{target:e,overlay:t});if(!0!==i.isCancelled){t.options._keep||delete m.active[e],e="tooltip-"+t.name,t.tmp.observeResize?.disconnect(),t.options.watchScroll&&a(t.options.watchScroll).off(".w2scroll-"+t.name);let l=0;Object.keys(m.active).forEach((e=>{m.active[e].displayed&&l++})),0==l&&m.observeRemove.disconnect(),a("html").off("."+e),a(document).off("."+e),t.box?.remove(),t.box=null,t.displayed=!1;var s=a(t.anchor).data("tooltipName")??[];-1!=s.indexOf(t.name)&&s.splice(s.indexOf(t.name),1),0==s.length?a(t.anchor).removeData("tooltipName"):a(t.anchor).data("tooltipName",s),t.options.anchorStyle&&(t.anchor.style.cssText=t.tmp.originalCSS),a(t.anchor).off("."+e).removeClass(t.options.anchorClass),t.options.url&&(t.options.items.splice(0),t.tmp.remote.hasMore=!0,t.tmp.remote.search=null),i.finish()}}}resize(e){if(0==arguments.length)Object.keys(m.active).forEach((e=>{(e=m.active[e]).displayed&&this.resize(e.name)}));else{var t=m.active[e.replace(/[\s\.#]/g,"_")];let s=this.getPosition(t.name);var i=s.left+"x"+s.top;let l;t.tmp.lastPos!=i&&(l=this.trigger("move",{target:e,overlay:t,pos:s})),a(t.box).css({left:s.left+"px",top:s.top+"px"}).then((e=>{null!=s.width&&e.css("width",s.width+"px").find(".w2ui-overlay-body").css("width","100%"),null!=s.height&&e.css("height",s.height+"px").find(".w2ui-overlay-body").css("height","100%")})).find(".w2ui-overlay-body").removeClass("w2ui-arrow-right w2ui-arrow-left w2ui-arrow-top w2ui-arrow-bottom").addClass(s.arrow.class).closest(".w2ui-overlay").find("style").text(s.arrow.style),t.tmp.lastPos!=i&&l&&(t.tmp.lastPos=i,l.finish())}}getPosition(e){let t=m.active[e.replace(/[\s\.#]/g,"_")];if(t&&t.box){let u=t.options;(t.tmp.resizedY||t.tmp.resizedX)&&a(t.box).css({width:"",height:"",scroll:"auto"}),e=d.scrollBarSize();var i=!(document.body.scrollWidth==document.body.clientWidth),s=!(document.body.scrollHeight==document.body.clientHeight);let p={width:window.innerWidth-(s?e:0),height:window.innerHeight-(i?e:0)};var l,o="auto"==u.position?"top|bottom|right|left".split("|"):Array.isArray(u.position)?u.position:u.position.split("|");let m=["top","bottom"].includes(o[0]),g=t.box.getBoundingClientRect(),f=t.anchor?.getBoundingClientRect?.();if(t.anchor==document.body){let e=u.originalEvent;for(;e?.originalEvent;)e=e.originalEvent;var{x:n,y:r,width:h,height:c}=e??{x:u.x,y:u.y,width:0,height:10};f={left:n-(u.contextMenu?4:0),top:r-(u.contextMenu?4:0),width:h??0,height:c??10,arrow:u.contextMenu?"none":null}}let w=u.arrowSize,b=("none"==f.arrow&&(w=0),{top:f.top-w,bottom:p.height-w-(f.top+f.height)-(i?e:0)-2,left:f.left,right:p.width-(f.left+f.width)+(s?e:0)});g.width<22&&(g.width=22),g.height<14&&(g.height=14);let y,v,x,k,C="",_={offset:0,class:"",style:`#${t.id} { --tip-size: ${w}px; }`},E={left:0,top:0},S={posX:"",x:0,posY:"",y:0};switch(o.forEach((e=>{["top","bottom"].includes(e)&&(!C&&g.height+w/1.893<b[e]&&(C=e),b[e]>S.y)&&Object.assign(S,{posY:e,y:b[e]}),["left","right"].includes(e)&&(!C&&g.width+w/1.893<b[e]&&(C=e),b[e]>S.x)&&Object.assign(S,{posX:e,x:b[e]})})),C=C||(m?S.posY:S.posX),u.autoResize&&(["top","bottom"].includes(C)&&(g.height>b[C]?(k=b[C],t.tmp.resizedY=!0):t.tmp.resizedY=!1),["left","right"].includes(C))&&(g.width>b[C]?(x=b[C],t.tmp.resizedX=!0):t.tmp.resizedX=!1),n=C,_.class=f.arrow||"w2ui-arrow-"+n,n){case"top":y=f.left+(f.width-(x??g.width))/2,v=f.top-(k??g.height)-w/1.5+1;break;case"bottom":y=f.left+(f.width-(x??g.width))/2,v=f.top+f.height+w/1.25+1;break;case"left":y=f.left-(x??g.width)-w/1.2-1,v=f.top+(f.height-(k??g.height))/2;break;case"right":y=f.left+f.width+w/1.2+1,v=f.top+(f.height-(k??g.height))/2}m&&("left"==u.align&&(E.left=f.left-y,y=f.left),"right"==u.align&&(E.left=f.left+f.width-(x??g.width)-y,y=f.left+f.width-(x??g.width)),["top","bottom"].includes(C)&&u.align.startsWith("both")&&(l=u.align.split(":")[1]??50,f.width>=l)&&(y=f.left,x=f.width),"top"==u.align&&(E.top=f.top-v,v=f.top),"bottom"==u.align&&(E.top=f.top+f.height-(k??g.height)-v,v=f.top+f.height-(k??g.height)),["left","right"].includes(C)&&u.align.startsWith("both")&&(l=u.align.split(":")[1]??50,f.height>=l)&&(v=f.top,k=f.height)),v+=parseFloat(u.offsetY*("top"==C?-1:1)),y+=parseFloat(u.offsetX*("left"==C?-1:1));{let e;(["left","right"].includes(u.align)&&f.width<(x??g.width)||["top","bottom"].includes(u.align)&&f.height<(k??g.height))&&(e=!0),r="right"==C?w:u.screenMargin,h="bottom"==C?w:u.screenMargin,c=p.width-(x??g.width)-("left"==C?w:u.screenMargin),i=p.height-(k??g.height)-("top"==C?w:u.screenMargin)+3,(["top","bottom"].includes(C)||u.autoResize)&&(y<r&&(e=!0,E.left-=y,y=r),y>c)&&(e=!0,E.left-=y-c,y+=c-y),(["left","right"].includes(C)||u.autoResize)&&(v<h&&(e=!0,E.top-=v,v=h),v>i)&&(e=!0,E.top-=v-i,v+=i-v),e&&(r=m?"left":"top",c=m?"width":"height",_.offset=-E[r],h=g[c]/2-w,Math.abs(_.offset)>h+w&&(_.class=""),Math.abs(_.offset)>h&&(_.offset=_.offset<0?-h:h),_.style=d.stripSpaces(`#${t.id} .w2ui-overlay-body:after,\n                            #${t.id} .w2ui-overlay-body:before {\n                                --tip-size: ${w}px;\n                                margin-${r}: ${_.offset}px;\n                            }`))}return s="top"==C?-u.margin:"bottom"==C?u.margin:0,e="left"==C?-u.margin:"right"==C?u.margin:0,v=Math.floor(100*(v+parseFloat(s)))/100,{left:y=Math.floor(100*(y+parseFloat(e)))/100,top:v,arrow:_,adjust:E,width:x,height:k,pos:C}}}}let g=new m,f=new class extends m{constructor(){super(),this.defaults=d.extend({},this.defaults,{type:"normal",items:[],index:null,render:null,spinner:!1,msgNoItems:d.lang("No items found"),topHTML:"",menuStyle:"",filter:!1,markSearch:!1,prefilter:!1,match:"contains",search:!1,altRows:!1,arrowSize:10,align:"left",position:"bottom|top",class:"w2ui-white",anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change","select"],onSelect:null,onSubMenu:null,onRemove:null})}attach(e,t){let i;1==arguments.length&&e instanceof Object?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e),t=i.hideOn,i=d.extend({},this.defaults,i||{}),t&&(i.hideOn=t),i.style+="; padding: 0;",null==i.items&&(i.items=[]),i.cacheMax<=0&&console.log(`The option "cacheMax" is ${i.cacheMax} but should be more than 0`),i.items=d.normMenu(i.items),i.html=this.getMenuHTML(i);let s=super.attach(i),l=s.overlay;return l.on("show:after.attach, update:after.attach",(e=>{if(s.overlay?.box){let e="";l.selected=null,["INPUT","TEXTAREA"].includes(l.anchor.tagName)&&(e=l.anchor.value,l.selected=l.anchor.dataset.selectedIndex);var t=a(s.overlay.box).find(".w2ui-eaction");d.bindEvents(t,this),this.applyFilter(l.name,null,e).then((e=>{m.active[l.name].displayed&&(l.tmp.searchCount=e.count,l.tmp.search=e.search,i.prefilter&&this.refreshSearch(l.name),this.initControls(s.overlay),this.refreshIndex(l.name,!0))}))}})),l.next=()=>{var e,t=this.getActiveChain(l.name);null==l.selected||0==l.selected?.length?l.selected=t[0]:(-1==(e=t.indexOf(l.selected))&&(l.selected=t[0]),e<t.length-1&&(l.selected=t[e+1])),this.refreshIndex(l.name)},l.prev=()=>{var e,t=this.getActiveChain(l.name);null==l.selected||0==l.selected?.length?l.selected=t[t.length-1]:(-1==(e=t.indexOf(l.selected))&&(l.selected=t[t.length-1]),0<e&&(l.selected=t[e-1])),this.refreshIndex(l.name)},l.click=()=>{$(l.box).find(".w2ui-selected").click()},l.on("hide:after.attach",(e=>{g.hide(l.name+"-tooltip")})),s.select=e=>(l.on("select.attach",(t=>{e(t)})),s),s.remove=e=>(l.on("remove.attach",(t=>{e(t)})),s),s.subMenu=e=>(l.on("subMenu.attach",(t=>{e(t)})),s),s}update(e,t){var i,s=m.active[e];s?((i=s.options).items!=t&&(i.items=t),t=this.getMenuHTML(i),i.html!=t&&(i.html=t,s.needsUpdate=!0,this.show(e))):console.log(`Tooltip "${e}" is not displayed. Cannot update it.`)}initControls(e){let t="mousedown",i="click";d.isMobile&&(t="touchstart",i="touchend"),a(e.box).find(".w2ui-menu:not(.w2ui-sub-menu)").off(".w2menu").on("contextmenu.w2menu",(e=>{e.preventDefault()})).on(t+".w2menu",{delegate:".w2ui-menu-item"},(t=>{var i=t.delegate.dataset;this.menuDown(e,t,i.index,i.parents)})).on(i+".w2menu",{delegate:".w2ui-menu-item"},(t=>{var i=t.delegate.dataset;this.menuClick(e,t,parseInt(i.index),i.parents)})).find(".w2ui-menu-item").off(".w2menu").on("mouseEnter.w2menu",(t=>{var i=t.target.dataset,s=e.options.items[i.index]?.tooltip;(s&&g.show({name:e.name+"-tooltip",anchor:t.target,html:s,position:"right|left",hideOn:["doc-click"]}),s=a(t.target).closest(".w2ui-menu").get(0))._evt&&s._evt.target!=t.target&&this.closeSubMenu(s._evt),"yes"==i.hassubmenu&&(i={index:parseInt(i.index),parents:""!==s.dataset.parents?s.dataset.parents.split("-").map((e=>parseInt(e))):[],target:t.target,originalEvent:t,overlay:e},s._evt=i,this.openSubMenu(i))})).on("mouseLeave.w2menu",(t=>{g.hide(e.name+"-tooltip")})).find(".menu-help").off(".w2menu").on("mouseEnter.w2menu",(t=>{var i=t.target.parentNode.parentNode.dataset;i=e.options.items[i.index]?.help,i&&g.show({name:e.name+"-help-tp",anchor:t.target,html:i,position:"right|left",hideOn:["doc-click"]})})).on("mouseLeave.w2menu",(t=>{g.hide(e.name+"-help-tp")})),["INPUT","TEXTAREA"].includes(e.anchor.tagName)&&a(e.anchor).off(".w2menu").on("input.w2menu",(e=>{})).on("keyup.w2menu",(t=>{t._searchType="filter",this.keyUp(e,t)})),e.options.search&&a(e.box).find("#menu-search").off(".w2menu").on("keyup.w2menu",(t=>{t._searchType="search",this.keyUp(e,t)}))}getCurrent(e,t){var i=(e=m.active[e.replace(/[\s\.#]/g,"_")]).options;let s=(t||(e.selected??"")).split("-");t=s.length-1,e=s[t];var l=s.slice(0,s.length-1).join("-");e=d.isInt(e)?parseInt(e):0;let o=i.items;return s.forEach(((e,t)=>{t<s.length-1&&(o=o[e].items)})),{last:t,index:e,items:o,item:o[e],parents:l}}getMenuHTML(e){if(e.spinner)return`\n            <div class="w2ui-menu">\n                <div class="w2ui-no-items">\n                    <div class="w2ui-spinner"></div>\n                    ${d.lang("Loading...")}\n                </div>\n            </div>`;let t=e.parents??[],i=e.items,s=(Array.isArray(i)||(i=[]),0),l=null,o="",n=(e.search&&(o+='\n                <div class="w2ui-menu-search">\n                    <span class="w2ui-icon w2ui-icon-search"></span>\n                    <input id="menu-search" class="w2ui-input" type="text"/>\n                </div>',i.forEach((e=>e.hidden=!1))),e.topHTML&&(o+=`<div class="w2ui-menu-top">${e.topHTML}</div>`),`\n            ${o}\n            <div class="w2ui-menu" style="${e.menuStyle}" data-parents="${t.join("-")}">\n        `);if(i.forEach(((o,a)=>{l=o.icon;var r=(0<t.length?t.join("-")+"-":"")+a;if(null==l&&(l=null),-1==["radio","check"].indexOf(e.type)||Array.isArray(o.items)||!1===o.group||(l=!0===o.checked?"w2ui-icon-check":"w2ui-icon-empty"),!0!==o.hidden){let t=o.text,i="";if("function"==typeof(t="function"==typeof e.render?e.render(o,e):t)&&(t=t(o,e)),l&&("<"!==String(l).slice(0,1)&&(l=`<span class="w2ui-icon ${l}"></span>`),i=`<div class="menu-icon">${l}</span></div>`),null==o.removable&&null!=o.remove&&(o.removable=o.remove),"break"!==o.type&&null!=t&&""!==t&&"--"!=String(t).substr(0,2)){var h=["w2ui-menu-item"];1==e.altRows&&h.push(s%2==0?"w2ui-even":"w2ui-odd");let l=1,c=(""===i&&l++,null==o.count&&null==o.hotkey&&!0!==o.removable&&null==o.items&&l++,null==o.tooltip&&null!=o.hint&&(o.tooltip=o.hint),"");!0===o.removable?c='<span class="menu-remove">x</span>':null!=o.items?(h.push("has-sub-menu"),c='<span style="background-color: transparent; border: transparent; box-shadow: none;"></span>'):(null!=o.count&&(c+="<span>"+o.count+"</span>"),null!=o.hotkey&&(c+='<span class="menu-hotkey">'+o.hotkey+"</span>"),null!=o.help&&(c+='<span class="menu-help">?</span>')),!0===o.disabled&&h.push("w2ui-disabled"),!0===o._noSearchInside&&h.push("w2ui-no-search-inside"),n+=`\n                        <div index="${r}" class="${h.join(" ")}" style="${o.style||""}"\n                            data-index="${a}" data-hasSubmenu="${null!=o.items?"yes":""}">\n                                <div style="width: ${parseInt(o.indent??0)}px"></div>\n                                ${i}\n                                <div class="menu-text" colspan="${l}">${d.lang(t)}</div>\n                                <div class="menu-extra">${c}</div>\n                        </div>`,s++}else h=(t??"").replace(/^-+/g,""),n+=`\n                        <div index="${r}" class="w2ui-menu-divider ${""!=h?"has-text":""}">\n                            <div class="line"></div>\n                            ${h?`<div class="text">${h}</div>`:""}\n                        </div>`}i[a]=o})),0===s&&e.msgNoItems){var a=m.active[e.name.replace(/[\s\.#]/g,"_")]?.tmp.remote;let t=e.msgNoItems;e.url&&(t=0==s&&!1===a?.hasMore?e.msgNoItems:e.msgSearch),n+=`\n                <div class="w2ui-no-items">\n                    ${d.lang(t)}\n                </div>`}return n+="</div>"}openSubMenu(e){var t=a(e.originalEvent.target).get(0);let i=e.overlay;var s;let l=[];"function"==typeof(s=(s=i.options.items)[e.index]).items?l=s.items(s):Array.isArray(s.items)&&(l=s.items),(s=f.get(i.name+"-submenu"))&&s.hide(),a(e.target).addClass("expanded"),f.show({name:i.name+"-submenu",anchor:t,items:l,class:i.options.class,offsetX:-7,arrowSize:0,parentOverlay:i,parents:[...e.parents,e.index],position:"right|left",hideOn:["doc-click"]}).hide((t=>{a(e.target).removeClass("expanded")})).select((e=>{var t=e.detail.overlay.options.parents;let s=i;for(;s.options.parentOverlay;)s=s.options.parentOverlay;this.menuClick(s,e.detail.originalEvent,parseInt(e.detail.index),t)})),setTimeout((()=>{a("#w2overlay-"+i.name+"-submenu").on("mouseenter",(e=>{e.target._keepSubOpen=!0})).on("mouseleave",(e=>{e.target._keepSubOpen=!1}))}),10)}closeSubMenu(e){var t=e.overlay;!0!==e.target._keepSubOpen&&(e=f.get(t.name+"-submenu"))&&e.hide()}refreshIndex(e,t){var i,s;(e=m.active[e.replace(/[\s\.#]/g,"_")])&&(e.displayed||this.show(e.name),i=a(e.box).find(".w2ui-overlay-body").get(0),s=a(e.box).find(".w2ui-menu-search, .w2ui-menu-top").get(0),a(e.box).find(".w2ui-menu-item.w2ui-selected").removeClass("w2ui-selected"),e=a(e.box).find(`.w2ui-menu-item[index="${e.selected}"]`).addClass("w2ui-selected").get(0))&&(e.offsetTop+e.clientHeight>i.clientHeight+i.scrollTop&&e.scrollIntoView({behavior:t?"instant":"smooth",block:t?"center":"start",inline:t?"center":"start"}),e.offsetTop<i.scrollTop+(s?s.clientHeight:0))&&e.scrollIntoView({behavior:t?"instant":"smooth",block:t?"center":"end",inline:t?"center":"end"})}refreshSearch(e){let t=m.active[e.replace(/[\s\.#]/g,"_")];t&&(t.displayed||this.show(t.name),a(t.box).find(".w2ui-no-items").hide(),a(t.box).find(".w2ui-menu-item, .w2ui-menu-divider").each((i=>{var s;this.getCurrent(e,i.getAttribute("index")).item?.hidden?a(i).hide():(s=t.tmp?.search,t.options.markSearch&&d.marker(i,s,{onlyFirst:"begins"==t.options.match}),a(i).show())})),a(t.box).find(".w2ui-sub-menu").each((t=>{var i=a(t).find(".w2ui-menu-item").get().some((e=>"none"!=e.style.display));this.getCurrent(e,t.dataset.parent).item.expanded&&(i?a(t).parent().show():a(t).parent().hide())})),0!=t.tmp.searchCount&&0!=t.options?.items?.length||(0==a(t.box).find(".w2ui-no-items").length&&a(t.box).find(".w2ui-menu:not(.w2ui-sub-menu)").append(`\n                    <div class="w2ui-no-items">\n                        ${d.lang(t.options.msgNoItems)}\n                    </div>`),a(t.box).find(".w2ui-no-items").show()))}applyFilter(e,t,i,s){let l=0;var o=m.active[e.replace(/[\s\.#]/g,"_")];let n,r,h=o.options;var c=new Promise(((e,t)=>{n=e,r=t}));null==i&&(i=["INPUT","TEXTAREA"].includes(o.anchor.tagName)?o.anchor.value:"");let u=[];h.selected&&(Array.isArray(h.selected)?u=h.selected.map((e=>e?.id??e)):h.selected?.id&&(u=[h.selected.id])),o.tmp.activeChain=null;var p,g=o.tmp.remote??{hasMore:!0,emptySet:!1,search:null,cached:-1};if(0==g.hasMore&&(p=g.hasMore_search.length,i.substr(0,p)!=g.hasMore_search)&&(g.hasMore=!0),null==t&&h.url&&g.hasMore&&g.search!==i){let t=!0,l=d.lang("Loading...");i.length<h.minLength&&!0!==g.emptySet&&(l=d.lang("${count} letters or more...",{count:h.minLength}),t=!1,""===i&&(l=d.lang(h.msgSearch)),0<h.items?.length)&&(this.update(e,[]),this.applyFilter(e,null,i)),a(o.box).find(".w2ui-no-items").html(l),g.search=i,h.items=[],o.tmp.remote=g,t&&this.request(o,i,s).then((t=>{this.update(e,t),this.applyFilter(e,null,i).then((e=>{n(e)}))})).catch((e=>{console.log("Server Request error",e)}))}else{let s;null==t&&!0===(s=this.trigger("search",{search:i,overlay:o,prom:c,resolve:n,reject:r})).isCancelled||(null==t&&(t=o.options.items),!1===h.filter?n({count:-1,search:i}):(t.forEach((t=>{let s="",o="";-1!==["is","begins","begins with"].indexOf(h.match)&&(s="^"),-1!==["is","ends","ends with"].indexOf(h.match)&&(o="$");try{new RegExp(s+i+o,"i").test(t.text)||"..."===t.text?t.hidden=!1:t.hidden=!0}catch(s){}h.hideSelected&&u.includes(t.id)&&(t.hidden=!0),Array.isArray(t.items)&&0<t.items.length&&(delete t._noSearchInside,this.applyFilter(e,t.items,i).then((e=>{0<(e=e.count)&&(l+=e,t.hidden&&(t._noSearchInside=!0),i&&(t.expanded=!0),t.hidden=!1)}))),!0!==t.hidden&&l++})),n({count:l,search:i}),s?.finish()))}return c}request(e,t,i){let s,l,o=e.options,n=e.tmp.remote;return(0===o.items.length&&0!==n.cached||n.cached==o.cacheMax&&t.length>n.search.length||t.length>=n.search.length&&t.substr(0,n.search.length)!==n.search||t.length<n.search.length)&&(n.controller&&n.controller.abort(),n.loading=!0,clearTimeout(n.timeout),n.timeout=setTimeout((()=>{var i=o.url;let a={search:t,max:o.cacheMax};Object.assign(a,o.postData);var r,h=this.trigger("request",{search:t,overlay:e,url:i,postData:a,httpMethod:o.method??"GET",httpHeaders:{}});!0!==h.isCancelled&&(i=new URL(h.detail.url,location),r=d.prepareParams(i,{method:h.detail.httpMethod,headers:h.detail.httpHeaders,body:h.detail.postData}),n.controller=new AbortController,r.signal=n.controller.signal,fetch(i,r).then((e=>e.json())).then((i=>{n.controller=null;var l=e.trigger("load",{search:a.search,overlay:e,data:i});!0!==l.isCancelled&&("string"==typeof(i=l.detail.data)&&(i=JSON.parse(i)),null==(i=Array.isArray(i)?{records:i}:i).records&&null!=i.items&&(i.records=i.items,delete i.items),i.error||null!=i.records||(i.records=[]),Array.isArray(i.records)?(i.records.length>=o.cacheMax?(i.records.splice(o.cacheMax,i.records.length),n.hasMore=!0):(n.hasMore=!1,n.hasMore_search=t),null==o.recId&&null!=o.recid&&(o.recId=o.recid),(o.recId||o.recText)&&i.records.forEach((e=>{"string"==typeof o.recId&&(e.id=e[o.recId]),"function"==typeof o.recId&&(e.id=o.recId(e)),"string"==typeof o.recText&&(e.text=e[o.recText]),"function"==typeof o.recText&&(e.text=o.recText(e))})),n.loading=!1,n.search=t,n.cached=0==i.records.length?-1:i.records.length,n.lastError="",n.emptySet=""===t&&0===i.records.length,l.finish(),s(d.normMenu(i.records))):console.error("ERROR: server did not return proper data structure","\n"," - it should return",{records:[{id:1,text:"item"}]},"\n"," - or just an array ",[{id:1,text:"item"}],"\n"," - or if errorr ",{error:!0,message:"error message"}))})).catch((i=>{var s=this.trigger("error",{overlay:e,search:t,error:i});!0!==s.isCancelled&&("AbortError"!==i?.name&&console.error("ERROR: Server communication failed.","\n"," - it should return",{records:[{id:1,text:"item"}]},"\n"," - or just an array ",[{id:1,text:"item"}],"\n"," - or if errorr ",{error:!0,message:"error message"}),n.loading=!1,n.search="",n.cached=-1,n.emptySet=!0,n.lastError=s.detail.error||"Server communication failed",o.items=[],s.finish(),l())})),h.finish())}),i?o.debounce??350:0)),new Promise(((e,t)=>{s=e,l=t}))}getActiveChain(e,t,i=[],s=[],l){var o=m.active[e.replace(/[\s\.#]/g,"_")];return null!=o.tmp.activeChain?o.tmp.activeChain:((t=null==t?o.options.items:t).forEach(((t,l)=>{t.hidden||t.disabled||t?.text?.startsWith("--")||(s.push(i.concat([l]).join("-")),Array.isArray(t.items)&&0<t.items.length&&t.expanded&&(i.push(l),this.getActiveChain(e,t.items,i,s,!0),i.pop()))})),null==l&&(o.tmp.activeChain=s),s)}menuDown(e,t,i,s){var l=e.options;let o=l.items;var n=a(t.delegate).find(".w2ui-icon");let r=a(t.target).closest(".w2ui-menu:not(.w2ui-sub-menu)"),d=("string"==typeof s&&""!==s&&s.split("-").forEach((e=>{o=o[e].items})),(o="function"==typeof o?o({overlay:e,index:i,parents:s,event:t}):o)[i]);if(null!=d&&!d.disabled){let e=(t,i)=>{t.forEach(((s,l)=>{s.id!=d.id&&(s.group===d.group&&s.checked&&(r.find(`.w2ui-menu-item[index="${(i?i+"-":"")+l}"] .w2ui-icon`).removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),t[l].checked=!1),Array.isArray(s.items))&&e(s.items,l)}))};"check"!==l.type&&"radio"!==l.type||!1===d.group||a(t.target).hasClass("menu-remove")||a(t.target).hasClass("menu-help")||a(t.target).closest(".w2ui-menu-item").hasClass("has-sub-menu")||(d.checked="radio"==l.type||!d.checked,d.checked?("radio"===l.type&&a(t.target).closest(".w2ui-menu").find(".w2ui-icon").removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),"check"===l.type&&null!=d.group&&e(l.items),n.removeClass("w2ui-icon-empty").addClass("w2ui-icon-check")):"check"===l.type&&n.removeClass("w2ui-icon-check").addClass("w2ui-icon-empty")),a(t.target).hasClass("menu-remove")||a(t.target).hasClass("menu-help")||(r.find(".w2ui-menu-item").removeClass("w2ui-selected"),a(t.delegate).hasClass("has-sub-menu"))||a(t.delegate).addClass("w2ui-selected")}}menuClick(e,t,i,s){var l=e.options;let o=l.items;var n=a(t.delegate).closest(".w2ui-menu-item");let r=!l.hideOn.includes("select");(t.shiftKey||t.metaKey||t.ctrlKey)&&(r=!0),"string"==typeof s&&""!==s?s=s.split("-"):Array.isArray(s)||(s=null),s&&s.forEach((e=>{o=o[e].items}));var d=(o="function"==typeof o?o({overlay:e,index:i,parents:s,event:t}):o)[i];if(d&&(!d.disabled||a(t.target).hasClass("menu-remove"))){let o;if(a(t.target).hasClass("menu-remove")){if(!0===(o=this.trigger("remove",{originalEvent:t,target:e.name,overlay:e,item:d,index:i,parents:s,el:n[0]})).isCancelled)return;r=!l.hideOn.includes("item-remove"),n.remove()}else if(n.hasClass("has-sub-menu")){if(!0===(o=this.trigger("subMenu",{originalEvent:t,target:e.name,overlay:e,item:d,index:i,parents:s,el:n[0]})).isCancelled)return;r=!0}else{if(l=this.findChecked(l.items),e.selected=parseInt(n.attr("index")),!0===(o=this.trigger("select",{originalEvent:t,target:e.name,overlay:e,item:d,index:i,parents:s,selected:l,keepOpen:r,el:n[0]})).isCancelled)return;null!=d.keepOpen&&(r=d.keepOpen),["INPUT","TEXTAREA"].includes(e.anchor.tagName)&&(e.anchor.dataset.selected=d.id,e.anchor.dataset.selectedIndex=e.selected)}r||this.hide(e.name),o.finish()}}findChecked(e){let t=[];return e.forEach((e=>{e.checked&&t.push(e),Array.isArray(e.items)&&(t=t.concat(this.findChecked(e.items)))})),t}keyUp(e,t){var i=e.options,s=t.target.value;let l=!0,o=!1;switch(t.keyCode){case 46:case 8:""!==s||e.displayed||(l=!1);break;case 13:if(!e.displayed||!e.selected)return;var{index:n,parents:r}=this.getCurrent(e.name);t.delegate=a(e.box).find(".w2ui-selected").get(0),this.menuClick(e,t,parseInt(n),r),l=!1;break;case 27:l=!1,e.displayed?this.hide(e.name):(n=e.anchor,["INPUT","TEXTAREA"].includes(n.tagName)&&(n.value="",delete n.dataset.selected,delete n.dataset.selectedIndex));break;case 37:{if(!e.displayed)return;let{item:s,index:n,parents:r}=this.getCurrent(e.name);r&&(s=i.items[r],n=parseInt(r),r="",o=!0),Array.isArray(s?.items)&&0<s.items.length&&s.expanded&&(t.delegate=a(e.box).find(`.w2ui-menu-item[index="${n}"]`).get(0),e.selected=n,this.menuClick(e,t,parseInt(n),r)),l=!1;break}case 39:if(!e.displayed)return;var{item:r,index:n,parents:d}=this.getCurrent(e.name);Array.isArray(r?.items)&&0<r.items.length&&!r.expanded&&(t.delegate=a(e.box).find(".w2ui-selected").get(0),this.menuClick(e,t,parseInt(n),d)),l=!1;break;case 38:e.displayed&&(e.prev(),l=!1,t.preventDefault());break;case 40:e.displayed&&(e.next(),l=!1,t.preventDefault())}l&&e.displayed&&(i.filter&&"filter"==t._searchType||i.search&&"search"==t._searchType)&&this.applyFilter(e.name,null,s,!0).then((t=>{e.tmp.searchCount=t.count,e.tmp.search=t.search,0!==t.count&&this.getActiveChain(e.name).includes(e.selected)||(e.selected=null),this.refreshSearch(e.name)})),o&&this.refreshIndex(e.name)}},w=new class extends m{constructor(){super(),this.palette=[["000000","333333","555555","777777","888888","999999","AAAAAA","CCCCCC","DDDDDD","EEEEEE","F7F7F7","FFFFFF"],["FF011B","FF9838","FFC300","FFFD59","86FF14","14FF7A","2EFFFC","2693FF","006CE7","9B24F4","FF21F5","FF0099"],["FFEAEA","FCEFE1","FCF4DC","FFFECF","EBFFD9","D9FFE9","E0FFFF","E8F4FF","ECF4FC","EAE6F4","FFF5FE","FCF0F7"],["F4CCCC","FCE5CD","FFF1C2","FFFDA1","D5FCB1","B5F7D0","BFFFFF","D6ECFF","CFE2F3","D9D1E9","FFE3FD","FFD9F0"],["EA9899","F9CB9C","FFE48C","F7F56F","B9F77E","84F0B1","83F7F7","B5DAFF","9FC5E8","B4A7D6","FAB9F6","FFADDE"],["E06666","F6B26B","DEB737","E0DE51","8FDB48","52D189","4EDEDB","76ACE3","6FA8DC","8E7CC3","E07EDA","F26DBD"],["CC0814","E69138","AB8816","B5B20E","6BAB30","27A85F","1BA8A6","3C81C7","3D85C6","674EA7","A14F9D","BF4990"],["99050C","B45F17","80650E","737103","395E14","10783D","13615E","094785","0A5394","351C75","780172","782C5A"]],this.defaults=d.extend({},this.defaults,{advanced:!1,transparent:!0,position:"top|bottom",class:"w2ui-white",color:"",updateInput:!0,arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null,onLiveUpdate:null})}attach(e,t){let i;1==arguments.length&&e instanceof Object?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e),t=i.hideOn,i=d.extend({},this.defaults,i||{}),t&&(i.hideOn=t),i.style+="; padding: 0;",i.transparent&&"333333"==this.palette[0][1]&&(this.palette[0].splice(1,1),this.palette[0].push("TRANSPARENT")),i.transparent||"333333"==this.palette[0][1]||(this.palette[0].splice(1,0,"333333"),this.palette[0].pop()),i.color&&(i.color=String(i.color).toUpperCase()),"string"==typeof i.color&&"#"===i.color.substr(0,1)&&(i.color=i.color.substr(1)),this.index=[-1,-1];let s=super.attach(i),l=s.overlay;return l.options.html=this.getColorHTML(l.name,i),l.on("show.attach",(e=>{var t=(e=e.detail.overlay).anchor,i=e.options;["INPUT","TEXTAREA"].includes(t.tagName)&&!i.color&&t.value&&(e.tmp.initColor=t.value),delete e.newColor})),l.on("show:after.attach",(e=>{var t;s.overlay?.box&&(t=a(s.overlay.box).find(".w2ui-eaction"),d.bindEvents(t,this),this.initControls(s.overlay))})),l.on("update:after.attach",(e=>{var t;s.overlay?.box&&(t=a(s.overlay.box).find(".w2ui-eaction"),d.bindEvents(t,this),this.initControls(s.overlay))})),l.on("hide.attach",(e=>{var t=(e=e.detail.overlay).anchor,i=e.newColor??e.options.color??"";""!==i&&(["INPUT","TEXTAREA"].includes(t.tagName)&&t.value!=i&&e.options.updateInput&&(t.value=i),!0!==(t=this.trigger("select",{color:i,target:e.name,overlay:e})).isCancelled)&&t.finish()})),s.liveUpdate=e=>(l.on("liveUpdate.attach",(t=>{e(t)})),s),s.select=e=>(l.on("select.attach",(t=>{e(t)})),s),s}select(e,t){let i;this.index=[-1,-1],"string"!=typeof t&&(i=t.target,this.index=a(i).attr("index").split(":"),t=a(i).closest(".w2ui-overlay").attr("name"));var s=this.get(t);!0!==(t=this.trigger("liveUpdate",{color:e,target:t,overlay:s,param:arguments[1]})).isCancelled&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&s.options.updateInput&&a(s.anchor).val(e),s.newColor=e,a(s.box).find(".w2ui-color.w2ui-selected").removeClass("w2ui-selected"),i&&a(i).addClass("w2ui-selected"),t.finish())}nextColor(e){var t=this.palette;switch(e){case"up":this.index[0]--;break;case"down":this.index[0]++;break;case"right":this.index[1]++;break;case"left":this.index[1]--}return this.index[0]<0&&(this.index[0]=0),this.index[0]>t.length-2&&(this.index[0]=t.length-2),this.index[1]<0&&(this.index[1]=0),this.index[1]>t[0].length-1&&(this.index[1]=t[0].length-1),t[this.index[0]][this.index[1]]}tabClick(e,t){"string"!=typeof t&&(t=a(t.target).closest(".w2ui-overlay").attr("name")),t=this.get(t);var i=a(t.box).find(`.w2ui-color-tab:nth-child(${e})`);a(t.box).find(".w2ui-color-tab").removeClass("w2ui-selected"),a(i).addClass("w2ui-selected"),a(t.box).find(".w2ui-tab-content").hide().closest(".w2ui-colors").find(".tab-"+e).show()}getColorHTML(e,t){let i='\n            <div class="w2ui-colors">\n                <div class="w2ui-tab-content tab-1">';for(let l=0;l<this.palette.length;l++){i+='<div class="w2ui-color-row">';for(let o=0;o<this.palette[l].length;o++){var s=this.palette[l][o];let n="FFFFFF"===s?"; border: 1px solid #efefef":"";i+=`\n                    <div class="w2ui-color w2ui-eaction ${"TRANSPARENT"===s?"w2ui-no-color":""} ${t.color==s?"w2ui-selected":""}"\n                        style="background-color: #${s+n};" name="${s}" index="${l}:${o}"\n                        data-mousedown="select|'${s}'|event" data-mouseup="hide|${e}">&nbsp;\n                    </div>`}i+="</div>",l<2&&(i+='<div style="height: 8px"></div>')}return(i=(i+="</div>")+`\n            <div class="w2ui-tab-content tab-2" style="display: none">\n                <div class="color-info">\n                    <div class="color-preview-bg"><div class="color-preview"></div><div class="color-original"></div></div>\n                    <div class="color-part">\n                        <span>H</span> <input class="w2ui-input" name="h" maxlength="3" max="360" tabindex="101">\n                        <span>R</span> <input class="w2ui-input" name="r" maxlength="3" max="255" tabindex="104">\n                    </div>\n                    <div class="color-part">\n                        <span>S</span> <input class="w2ui-input" name="s" maxlength="3" max="100" tabindex="102">\n                        <span>G</span> <input class="w2ui-input" name="g" maxlength="3" max="255" tabindex="105">\n                    </div>\n                    <div class="color-part">\n                        <span>V</span> <input class="w2ui-input" name="v" maxlength="3" max="100" tabindex="103">\n                        <span>B</span> <input class="w2ui-input" name="b" maxlength="3" max="255" tabindex="106">\n                    </div>\n                    <div class="color-part opacity">\n                        <span>${d.lang("Opacity")}</span>\n                        <input class="w2ui-input" name="a" maxlength="5" max="1" tabindex="107">\n                    </div>\n                </div>\n                <div class="palette" name="palette">\n                    <div class="palette-bg"></div>\n                    <div class="value1 move-x move-y"></div>\n                </div>\n                <div class="rainbow" name="rainbow">\n                    <div class="value2 move-x"></div>\n                </div>\n                <div class="alpha" name="alpha">\n                    <div class="alpha-bg"></div>\n                    <div class="value2 move-x"></div>\n                </div>\n            </div>`)+`\n            <div class="w2ui-color-tabs">\n                <div class="w2ui-color-tab w2ui-selected w2ui-eaction" data-click="tabClick|1|event|this"><span class="w2ui-icon w2ui-icon-colors"></span></div>\n                <div class="w2ui-color-tab w2ui-eaction" data-click="tabClick|2|event|this"><span class="w2ui-icon w2ui-icon-settings"></span></div>\n                <div style="padding: 5px; width: 100%; text-align: right;">\n                    ${"string"==typeof t.html?t.html:""}\n                </div>\n            </div>`}initControls(e){let t,i=this;var s=e.options,l=s.color||e.tmp.initColor;let o=d.parseColor(l),n=(null==o&&(o={r:140,g:150,b:160,a:1}),d.rgb2hsv(o));!0===s.advanced&&this.tabClick(2,e.name),c(n,!0,l??""),a(e.box).off(".w2color").on("contextmenu.w2color",(e=>{e.preventDefault()})).find("input").off(".w2color").on("change.w2color",(e=>{e=a(e.target);let t=parseFloat(e.val());var i=parseFloat(e.attr("max"));isNaN(t)&&(t=0,e.val(0)),1<i&&(t=parseInt(t)),0<i&&t>i&&(e.val(i),t=i),t<0&&(e.val(0),t=0),i=e.attr("name"),e={},-1!==["r","g","b","a"].indexOf(i)?(o[i]=t,n=d.rgb2hsv(o)):-1!==["h","s","v"].indexOf(i)&&(e[i]=t),c(e,!0)})),a(e.box).find(".color-original").off(".w2color").on("click.w2color",(e=>{null!=(e=d.parseColor(a(e.target).css("background-color")))&&(o=e,c(n=d.rgb2hsv(o),!0))})),s=(d.isMobile?"touchstart":"mousedown")+".w2color";let r=(d.isMobile?"touchend":"mouseup")+".w2color",h=(d.isMobile?"touchmove":"mousemove")+".w2color";function c(t,s,l){null!=t.h&&(n.h=t.h),null!=t.s&&(n.s=t.s),null!=t.v&&(n.v=t.v),null!=t.a&&(o.a=t.a,n.a=t.a);let r="rgba("+(o=d.hsv2rgb(n)).r+","+o.g+","+o.b+","+o.a+")",h=[Number(o.r).toString(16).toUpperCase(),Number(o.g).toString(16).toUpperCase(),Number(o.b).toString(16).toUpperCase(),Math.round(255*Number(o.a)).toString(16).toUpperCase()];var c,p;h.forEach(((e,t)=>{1===e.length&&(h[t]="0"+e)})),r=h[0]+h[1]+h[2]+h[3],1===o.a&&(r=h[0]+h[1]+h[2]),a(e.box).find(".color-preview").css("background-color","#"+r),a(e.box).find("input").each((e=>{e.name&&(null!=o[e.name]&&(e.value=o[e.name]),null!=n[e.name]&&(e.value=n[e.name]),"a"===e.name)&&(e.value=o.a)})),null!=l?(t=e.tmp.initColor||r,a(e.box).find(".color-original").css("background-color","#"+t),a(e.box).find(".w2ui-color.w2ui-selected").removeClass("w2ui-selected"),a(e.box).find(`.w2ui-colors [name="${t}"], .w2ui-colors [name="${l}"]`).addClass("w2ui-selected"),8==r.length&&i.tabClick(2,e.name)):i.select(r,e.name),s&&(t=a(e.box).find(".palette .value1"),l=a(e.box).find(".rainbow .value2"),s=a(e.box).find(".alpha .value2"),t[0]&&l[0]&&s[0]&&(c=parseInt(t[0].clientWidth)/2,p=parseInt(l[0].clientWidth)/2,t.css({left:150*n.s/100-c+"px",top:125*(100-n.v)/100-c+"px"}),l.css("left",n.h/2.4-p+"px"),s.css("left",150*o.a-p+"px")),u())}function u(){var t=`${(t=d.hsv2rgb(n.h,100,100)).r},${t.g},`+t.b;a(e.box).find(".palette").css("background-image",`linear-gradient(90deg, rgba(${t},0) 0%, rgba(${t},1) 100%)`)}function p(e){a("html").off(".w2color")}function m(e){var i=t.el,s=e.pageX-t.x;e=e.pageY-t.y;let l=t.left+s,o=t.top+e;l<-(s=parseInt(i.prop("clientWidth"))/2)&&(l=-s),o<-s&&(o=-s),l>t.width-s&&(l=t.width-s),o>t.height-s&&(o=t.height-s),i.hasClass("move-x")&&i.css({left:l+"px"}),i.hasClass("move-y")&&i.css({top:o+"px"}),e=a(i.get(0).parentNode).attr("name");var n=parseInt(i.css("left"))+s;i=parseInt(i.css("top"))+s,"palette"===e&&c({s:Math.round(n/t.width*100),v:Math.round(100-i/t.height*100)}),"rainbow"===e&&(c({h:Math.round(2.4*n)}),u()),"alpha"===e&&c({a:parseFloat(Number(n/150).toFixed(2))})}a(e.box).find(".palette, .rainbow, .alpha").off(".w2color").on(s+".w2color",(function(e){var i=a(this).find(".value1, .value2"),s=parseInt(i.prop("clientWidth"))/2;i.hasClass("move-x")&&i.css({left:e.offsetX-s+"px"}),i.hasClass("move-y")&&i.css({top:e.offsetY-s+"px"}),t={el:i,x:e.pageX,y:e.pageY,width:i.prop("parentNode").clientWidth,height:i.prop("parentNode").clientHeight,left:parseInt(i.css("left")),top:parseInt(i.css("top"))},m(e),a("html").off(".w2color").on(h,m).on(r,p)}))}},b=new class extends m{constructor(){super();var e=new Date;this.daysCount=[31,28,31,30,31,30,31,31,30,31,30,31],this.today=e.getFullYear()+"/"+(Number(e.getMonth())+1)+"/"+e.getDate(),this.defaults=d.extend({},this.defaults,{position:"top|bottom",class:"w2ui-calendar",type:"date",value:"",format:"",start:null,end:null,btnNow:!1,blockDates:[],blockWeekdays:[],colored:{},arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null})}attach(e,t){let i;1==arguments.length&&e instanceof Object?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e),t=i.hideOn,i=d.extend({},this.defaults,i||{}),t&&(i.hideOn=t),i.format||(e=d.settings.dateFormat,t=d.settings.timeFormat,"date"==i.type?i.format=e:"time"==i.type?i.format=t:i.format=e+"|"+t),e="time"==i.type?this.getHourHTML(i):this.getMonthHTML(i),i.style+="; padding: 0;",i.html=e.html;let s=super.attach(i),l=s.overlay;return Object.assign(l.tmp,e),l.on("show.attach",(e=>{var t=(e=e.detail.overlay).anchor,i=e.options;["INPUT","TEXTAREA"].includes(t.tagName)&&!i.value&&t.value&&(e.tmp.initValue=t.value),delete e.newValue,delete e.newDate})),l.on("show:after.attach",(e=>{s.overlay?.box&&this.initControls(s.overlay)})),l.on("update:after.attach",(e=>{s.overlay?.box&&this.initControls(s.overlay)})),l.on("hide.attach",(e=>{var t=(e=e.detail.overlay).anchor;null!=e.newValue&&(e.newDate&&(e.newValue=e.newDate+" "+e.newValue),["INPUT","TEXTAREA"].includes(t.tagName)&&t.value!=e.newValue&&(t.value=e.newValue),!0!==(t=this.trigger("select",{date:e.newValue,target:e.name,overlay:e})).isCancelled)&&t.finish()})),s.select=e=>(l.on("select.attach",(t=>{e(t)})),s),s}initControls(e){let t=e.options,i=i=>{let{month:s,year:l}=e.tmp;12<(s+=i)&&(s=1,l++),s<1&&(s=12,l--),i=this.getMonthHTML(t,s,l),Object.assign(e.tmp,i),a(e.box).find(".w2ui-overlay-body").html(i.html),this.initControls(e)},s=(i,s)=>{a(i.target).parent().find(".w2ui-jump-month, .w2ui-jump-year").removeClass("w2ui-selected"),a(i.target).addClass("w2ui-selected"),i=new Date;let{jumpMonth:l,jumpYear:o}=e.tmp;(l=s&&(null==o&&(o=i.getFullYear()),null==l)?i.getMonth()+1:l)&&o&&(s=this.getMonthHTML(t,l,o),Object.assign(e.tmp,s),a(e.box).find(".w2ui-overlay-body").html(s.html),e.tmp.jump=!1,this.initControls(e))};a(e.box).find(".w2ui-cal-title").off(".calendar").on("click.calendar",(i=>{var s,l;Object.assign(e.tmp,{jumpYear:null,jumpMonth:null}),e.tmp.jump?(({month:s,year:l}=e.tmp),s=this.getMonthHTML(t,s,l),a(e.box).find(".w2ui-overlay-body").html(s.html),e.tmp.jump=!1):(a(e.box).find(".w2ui-overlay-body .w2ui-cal-days").replace(this.getYearHTML()),(l=a(e.box).find(`[name="${e.tmp.year}"]`).get(0))&&l.scrollIntoView(!0),e.tmp.jump=!0),this.initControls(e),i.stopPropagation()})).find(".w2ui-cal-previous").off(".calendar").on("click.calendar",(e=>{i(-1),e.stopPropagation()})).parent().find(".w2ui-cal-next").off(".calendar").on("click.calendar",(e=>{i(1),e.stopPropagation()})),a(e.box).find(".w2ui-cal-now").off(".calendar").on("click.calendar",(i=>{"datetime"==t.type?e.newDate?e.newValue=d.formatTime(new Date,t.format.split("|")[1]):e.newValue=d.formatDateTime(new Date,t.format):"date"==t.type?e.newValue=d.formatDate(new Date,t.format):"time"==t.type&&(e.newValue=d.formatTime(new Date,t.format)),this.hide(e.name)})),a(e.box).off(".calendar").on("contextmenu.calendar",(e=>{e.preventDefault()})).on("click.calendar",{delegate:".w2ui-day.w2ui-date"},(i=>{"datetime"==t.type?(e.newDate=a(i.target).attr("date"),a(e.box).find(".w2ui-overlay-body").html(this.getHourHTML(e.options).html),this.initControls(e)):(e.newValue=a(i.target).attr("date"),this.hide(e.name))})).on("click.calendar",{delegate:".w2ui-jump-month"},(t=>{e.tmp.jumpMonth=parseInt(a(t.target).attr("name")),s(t)})).on("dblclick.calendar",{delegate:".w2ui-jump-month"},(t=>{e.tmp.jumpMonth=parseInt(a(t.target).attr("name")),s(t,!0)})).on("click.calendar",{delegate:".w2ui-jump-year"},(t=>{e.tmp.jumpYear=parseInt(a(t.target).attr("name")),s(t)})).on("dblclick.calendar",{delegate:".w2ui-jump-year"},(t=>{e.tmp.jumpYear=parseInt(a(t.target).attr("name")),s(t,!0)})).on("click.calendar",{delegate:".w2ui-time.hour"},(i=>{i=a(i.target).attr("hour");let s=this.str2min(t.value)%60;e.tmp.initValue&&!t.value&&(s=this.str2min(e.tmp.initValue)%60),t.noMinutes?(e.newValue=this.min2str(60*i,t.format),this.hide(e.name)):(e.newValue=i+":"+s,i=this.getMinHTML(i,t).html,a(e.box).find(".w2ui-overlay-body").html(i),this.initControls(e))})).on("click.calendar",{delegate:".w2ui-time.min"},(i=>{i=60*Math.floor(this.str2min(e.newValue)/60)+parseInt(a(i.target).attr("min")),e.newValue=this.min2str(i,t.format),this.hide(e.name)}))}getMonthHTML(e,t,i){var s=d.settings.fulldays.slice(),l=d.settings.shortdays.slice();"M"!==d.settings.weekStarts&&(s.unshift(s.pop()),l.unshift(l.pop()));let o=new Date;s="datetime"===e.type?d.isDateTime(e.value,e.format,!0):d.isDate(e.value,e.format,!0);var n=d.formatDate(s);null!=t&&null!=i||(i=(s||o).getFullYear(),t=s?s.getMonth()+1:o.getMonth()+1),12<t&&(t-=12,i++),(t<1||0===t)&&(t+=12,i--),i/4==Math.floor(i/4)?this.daysCount[1]=29:this.daysCount[1]=28,e.current=t+"/"+i;let a=(o=new Date(i,t-1,1)).getDay(),r="";var h=d.settings.weekStarts;for(let e=0;e<l.length;e++)r+=`<div class="w2ui-day w2ui-weekday ${"M"==h&&5==e||"M"!=h&&6==e?"w2ui-sunday":""} ${"M"==h&&6==e||"M"!=h&&0==e?"w2ui-saturday":""}">${l[e]}</div>`;let c=`\n            <div class="w2ui-cal-title">\n                <div class="w2ui-cal-previous">\n                    <div></div>\n                </div>\n                <div class="w2ui-cal-next">\n                    <div></div>\n                </div>\n                ${d.settings.fullmonths[t-1]}, ${i}\n                <span class="arrow-down"></span>\n            </div>\n            <div class="w2ui-cal-days">\n                ${r}\n        `,u=new Date(i+`/${t}/1`);s=(u=new Date(u.getTime()+432e5)).getDay(),"M"==d.settings.weekStarts&&a--;let p=6,m=0;0<s?u=new Date(u.getTime()-864e5*a):(p+=a,m+=a,p<0&&(p=6+p+1),m<0&&(m=6+m+1));for(let i=0;i<42;i++){var g=[],f=`${u.getFullYear()}/${u.getMonth()+1}/`+u.getDate(),w=(u.getDay()===p&&g.push("w2ui-saturday"),u.getDay()===m&&g.push("w2ui-sunday"),u.getMonth()+1!==t&&g.push("outside"),f==this.today&&g.push("w2ui-today"),u.getDate());let i,s,l="",o="";s="datetime"===e.type?(i=d.formatDateTime(f,e.format),d.formatDate(f,d.settings.dateFormat)):i=d.formatDate(f,e.format),e.colored&&void 0!==e.colored[s]&&(o="background-color: "+(f=e.colored[s].split("|"))[0]+";",l="color: "+f[1]+";"),c+=`<div class="w2ui-day ${this.inRange(i,e,!0)?"w2ui-date "+(s==n?"w2ui-selected":""):"w2ui-blocked"} ${g.join(" ")}"\n                       style="${l+o}" date="${s}" data-date="${u.getTime()}">\n                            ${w}\n                    </div>`,u=new Date(u.getTime()+864e5)}return c+="</div>",e.btnNow&&(c+=`<div class="w2ui-cal-now">${s=d.lang("Today"+("datetime"==e.type?" & Now":""))}</div>`),{html:c,month:t,year:i}}getYearHTML(){let e="",t="";for(let t=0;t<d.settings.fullmonths.length;t++)e+=`<div class="w2ui-jump-month" name="${t+1}">${d.settings.shortmonths[t]}</div>`;for(let e=d.settings.dateStartYear;e<=d.settings.dateEndYear;e++)t+=`<div class="w2ui-jump-year" name="${e}">${e}</div>`;return`<div class="w2ui-cal-jump">\n            <div id="w2ui-jump-month">${e}</div>\n            <div id="w2ui-jump-year">${t}</div>\n        </div>`}getHourHTML(e){(e=e??{}).format||(e.format=d.settings.timeFormat);var t=-1<e.format.indexOf("h24"),i=e.value||(e.anchor?e.anchor.value:""),s=[];for(let n=0;n<24;n++){let a=(12<=n&&!t?n-12:n)+":00"+(t?"":n<12?" am":" pm"),r=(12!=n||t||(a="12:00 pm"),s[Math.floor(n/8)]||(s[Math.floor(n/8)]=""),this.min2str(this.str2min(a))),h=this.min2str(this.str2min(a)+59);"datetime"===e.type&&(o=d.isDateTime(i,e.format,!0),l=e.format.split("|")[0].trim(),r=d.formatDate(o,l)+" "+r,h=d.formatDate(o,l)+" "+h);var l,o=this.inRange(r,e)||this.inRange(h,e);s[Math.floor(n/8)]+=`<span hour="${n}"\n                class="hour ${o?"w2ui-time ":"w2ui-blocked"}">${a}</span>`}return{html:`<div class="w2ui-calendar">\n            <div class="w2ui-time-title">${d.lang("Select Hour")}</div>\n            <div class="w2ui-cal-time">\n                <div class="w2ui-cal-column">${s[0]}</div>\n                <div class="w2ui-cal-column">${s[1]}</div>\n                <div class="w2ui-cal-column">${s[2]}</div>\n            </div>\n            ${e.btnNow?`<div class="w2ui-cal-now">${d.lang("Now")}</div>`:""}\n        </div>`}}getMinHTML(e,t){null==e&&(e=0),(t=t??{}).format||(t.format=d.settings.timeFormat);var i=-1<t.format.indexOf("h24"),s=t.value||(t.anchor?t.anchor.value:""),l=[];for(let h=0;h<60;h+=5){var o=(12<e&&!i?e-12:e)+":"+(h<10?0:"")+h+" "+(i?"":e<12?"am":"pm");let c=o;var n,a,r=h<20?0:h<40?1:2;l[r]||(l[r]=""),"datetime"===t.type&&(n=d.isDateTime(s,t.format,!0),a=t.format.split("|")[0].trim(),c=d.formatDate(n,a)+" "+c),l[r]+=`<span min="${h}" class="min ${this.inRange(c,t)?"w2ui-time ":"w2ui-blocked"}">${o}</span>`}return{html:`<div class="w2ui-calendar">\n            <div class="w2ui-time-title">${d.lang("Select Minute")}</div>\n            <div class="w2ui-cal-time">\n                <div class="w2ui-cal-column">${l[0]}</div>\n                <div class="w2ui-cal-column">${l[1]}</div>\n                <div class="w2ui-cal-column">${l[2]}</div>\n            </div>\n            ${t.btnNow?`<div class="w2ui-cal-now">${d.lang("Now")}</div>`:""}\n        </div>`}}inRange(e,t,i){let s=!1;if("date"===t.type){var l=d.isDate(e,t.format,!0);if(l){if(t.start||t.end){var o="string"==typeof t.start?t.start:a(t.start).val(),n="string"==typeof t.end?t.end:a(t.end).val();let e=d.isDate(o,t.format,!0),i=d.isDate(n,t.format,!0);o=new Date(l),e=e||o,i=i||o,o>=e&&o<=i&&(s=!0)}else s=!0;Array.isArray(t.blockDates)&&t.blockDates.includes(e)&&(s=!1),Array.isArray(t.blockWeekdays)&&t.blockWeekdays.includes(l.getDay())&&(s=!1)}}else if("time"===t.type)if(t.start||t.end){n=this.str2min(e);let i=this.str2min(t.start),l=this.str2min(t.end);i=i||n,l=l||n,n>=i&&n<=l&&(s=!0)}else s=!0;else"datetime"===t.type&&(o=d.isDateTime(e,t.format,!0))&&(l=t.format.split("|").map((e=>e.trim())),i?(n=d.formatDate(o,l[0]),e=d.extend({},t,{type:"date",format:l[0]}),this.inRange(n,e)&&(s=!0)):(i=d.formatTime(o,l[1]),n={type:"time",format:l[1],start:t.startTime,end:t.endTime},this.inRange(i,n)&&(s=!0)));return s}str2min(e){var t;return"string"!=typeof e||2!==(t=e.split(":")).length?null:(t[0]=parseInt(t[0]),t[1]=parseInt(t[1]),-1!==e.indexOf("pm")&&12!==t[0]&&(t[0]+=12),e.includes("am")&&12==t[0]&&(t[0]=0),60*t[0]+t[1])}min2str(e,t){1440<=e&&(e%=1440),e<0&&(e=1440+e);var i=Math.floor(e/60);return e=(e%60<10?"0":"")+e%60,-1!==(t=t||d.settings.timeFormat).indexOf("h24")?i+":"+e:(i<=12?i:i-12)+":"+e+" "+(12<=i?"pm":"am")}};class y extends l{constructor(e){super(e.name),this.box=null,this.name=null,this.routeData={},this.items=[],this.right="",this.tooltip="top|left",this.onClick=null,this.onChange=null,this.onMouseDown=null,this.onMouseUp=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.item_template={id:null,type:"button",text:null,html:"",tooltip:null,count:null,hidden:!1,disabled:!1,checked:!1,icon:null,route:null,arrow:null,style:null,group:null,items:null,selected:null,color:null,backColor:null,overlay:{anchorClass:""},onClick:null,onRefresh:null},this.last={badge:{},pendingRefresh:{}},this._refresh=({effected:e,resize:t,refreshTooltip:i})=>{var s=this.last.pendingRefresh;s.ids??=[],s.ids.push(...e),Object.assign(s,{resize:t,refreshTooltip:i}),this._refreshDebounced()},this._refreshDebounced=d.debounce((()=>{let e=this.last.pendingRefresh;new Set(e.ids).forEach((t=>{this.refresh(t),e.hideTooltip&&this.tooltipHide(t)})),e.resize&&this.resize(),this.last.pendingRefresh={}}),15);var t=e.items;delete e.items,Object.assign(this,e),Array.isArray(t)&&this.add(t,!0),e.items=t,"string"==typeof this.box&&(this.box=a(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){this.insert(null,e,t)}insert(e,t,i){(t=Array.isArray(t)?t:[t]).forEach(((t,s,l)=>{"string"==typeof t&&(t=l[s]={id:t,text:t});var o,n=["button","check","radio","drop","menu","menu-radio","menu-check","color","text-color","html","label","input","group","break","spacer","new-line"];if(n.includes(String(t.type)))if(null!=t.id||["break","spacer","new-line"].includes(t.type)){if(null==t.type)console.log('ERROR: The parameter "type" is required but not supplied.',t);else if(d.checkUniqueId(t.id,this.items,"toolbar",this.name)){let n=d.extend({},this.item_template,t);"group"==n.type&&Array.isArray(n.items)&&n.items.forEach(((e,t)=>{n.items[t]=d.extend({},this.item_template,n.items[t])})),"menu-check"==n.type?(Array.isArray(n.selected)||(n.selected=[]),Array.isArray(n.items)&&n.items.forEach((e=>{(e="string"==typeof e?l[s]={id:e,text:e}:e).checked&&!n.selected.includes(e.id)&&n.selected.push(e.id),!e.checked&&n.selected.includes(e.id)&&(e.checked=!0),null==e.checked&&(e.checked=!1)}))):"menu-radio"==n.type&&Array.isArray(n.items)&&n.items.forEach(((e,t,i)=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&null==n.selected?n.selected=e.id:e.checked=!1,e.checked||n.selected!=e.id||(e.checked=!0),null==e.checked&&(e.checked=!1)})),null==e?this.items.push(n):(o=this.get(e,!0),this.items=this.items.slice(0,o).concat([n],this.items.slice(o))),n.line=n.line??1,!0!==i&&this.refresh(n.id)}}else console.log('ERROR: The parameter "id" is required but not supplied.',t);else console.log('ERROR: The parameter "type" should be one of the following:',n,`, but ${t.type} is supplied.`,t)})),!0!==i&&this.resize()}remove(){let e=0;return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&-1==String(t).indexOf(":")&&(e++,a(this.box).find("#tb_"+this.name+"_item_"+d.escapeId(i.id)).remove(),null!=(t=this.get(i.id,!0)))&&this.items.splice(t,1)})),this.resize(),e}set(e,t){var i=this.get(e);return null!=i&&(Object.assign(i,t),this.refresh(String(e).split(":")[0]),!0)}get(e,t,i){if(0===arguments.length){var s=[];for(let e=0;e<this.items.length;e++){var l=this.items[e];if(null!=l.id&&s.push(l.id),"group"==l.type)for(let e=0;e<l.items.length;e++)null!=l.items[e].id&&s.push(l.items[e].id)}return s}var o=String(e).split(":");null==i&&(i=this.items);for(let s=0;s<i.length;s++){var n=i[s];if(["menu","menu-radio","menu-check"].includes(n.type)&&2==o.length&&n.id==o[0]){let e=n.items;"function"==typeof e&&(e=e(this));for(let i=0;i<e.length;i++){var a=e[i];if(a.id==o[1]||null==a.id&&a.text==o[1])return 1==t?i:a;if(Array.isArray(a.items))for(let e=0;e<a.items.length;e++)if(a.items[e].id==o[1]||null==a.items[e].id&&a.items[e].text==o[1])return 1==t?i:a.items[e]}}else{if(n.id==o[0])return 1==t?s:n;if("group"==n.type&&null!=(n=this.get(e,t,n.items)))return n}}return null}setCount(e,t,i,s){var l=a(this.box).find(`#tb_${this.name}_item_${d.escapeId(e)} .w2ui-tb-count > span`);0<l.length?(l.removeClass().addClass(i??"").text(t).get(0).style.cssText=s??"",this.last.badge[e]={className:i??"",style:s??""},this.get(e).count=t):(this.set(e,{count:t}),this.setCount(...arguments))}show(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&(i.hidden=!1,e.push(String(t).split(":")[0]),"group"==i.type)&&i.items.forEach((e=>this.show(e.id)))})),this._refresh({effected:e,resize:!0}),e}hide(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&(i.hidden=!0,e.push(String(t).split(":")[0]),"group"==i.type)&&i.items.forEach((e=>this.hide(e.id)))})),this._refresh({effected:e,hideTooltip:!0,resize:!0}),e}enable(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&("group"==i.type?i.items.forEach((e=>this.enable(e.id))):(i.disabled=!1,e.push(String(t).split(":")[0])))})),this._refresh({effected:e}),e}disable(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&("group"==i.type?i.items.forEach((e=>this.disable(e.id))):(i.disabled=!0,e.push(String(t).split(":")[0])))})),this._refresh({effected:e,hideTooltip:!0}),e}check(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&-1==String(t).indexOf(":")&&("group"==i.type?i.items.forEach((e=>this.check(e.id))):(i.checked=!0,e.push(String(t).split(":")[0])))})),this._refresh({effected:e}),e}uncheck(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&-1==String(t).indexOf(":")&&(["menu","menu-radio","menu-check","drop","color","text-color"].includes(i.type)&&i.checked&&g.hide(this.name+"-drop"),"group"==i.type?i.items.forEach((e=>this.uncheck(e.id))):(i.checked=!1,e.push(String(t).split(":")[0])))})),this._refresh({effected:e}),e}click(e,t){var i=String(e).split(":");let s=this.get(i[0]),l=s&&s.items?d.normMenu.call(this,s.items,s):[];if(1<i.length)(i=this.get(e))&&!i.disabled&&this.menuClick({name:this.name,item:s,subItem:i,originalEvent:t});else if(s&&!s.disabled&&!0!==(i=this.trigger("click",{target:null!=e?e:this.name,item:s,object:s,originalEvent:t})).isCancelled){l=s&&s.items?d.normMenu.call(this,s.items,s):[];let h="#tb_"+this.name+"_item_"+d.escapeId(s.id);if(a(this.box).find(h).removeClass("down"),"radio"==s.type){for(let e=0;e<this.items.length;e++){var o=this.items[e];if("group"==o.type)for(let e=0;e<o.items.length;e++){var n=o.items[e];null!=n&&n.id!=s.id&&"radio"===n.type&&n.group==s.group&&n.checked&&(n.checked=!1,this.refresh(n.id))}null!=o&&o.id!=s.id&&"radio"===o.type&&o.group==s.group&&o.checked&&(o.checked=!1,this.refresh(o.id))}s.checked=!0,a(this.box).find(h).addClass("checked")}if(["menu","menu-radio","menu-check","drop","color","text-color"].includes(s.type)){if(this.tooltipHide(e),s.checked)return void g.hide(this.name+"-drop");t=g.get(this.name+"-drop"),t?.displayed&&t.hide(),t?.listeners?.splice(0),setTimeout((()=>{var e=(e,t)=>{let i=this;return function(){i.set(e,{checked:!1})}},t=a(this.box).find("#tb_"+this.name+"_item_"+d.escapeId(s.id));if(d.isPlainObject(s.overlay)||(s.overlay={}),"drop"==s.type&&g.show(d.extend({html:s.html,class:"w2ui-white",hideOn:["doc-click"]},s.overlay,{anchor:t[0],name:this.name+"-drop",data:{item:s,btn:h}})).hide(e(s.id)),["menu","menu-radio","menu-check"].includes(s.type)){let i="normal";"menu-radio"==s.type&&(i="radio",l.forEach((e=>{s.selected==e.id?e.checked=!0:e.checked=!1}))),"menu-check"==s.type&&(i="check",l.forEach((e=>{Array.isArray(s.selected)&&s.selected.includes(e.id)?e.checked=!0:e.checked=!1}))),f.show(d.extend({items:l,align:s.text?"left":"none"},s.overlay,{type:i,name:this.name+"-drop",anchor:t[0],data:{item:s,btn:h}})).hide(e(s.id)).remove((e=>{this.menuClick({name:this.name,remove:!0,item:s,subItem:e.detail.item,originalEvent:e})})).select((e=>{this.menuClick({name:this.name,item:s,subItem:e.detail.item,originalEvent:e})}))}["color","text-color"].includes(s.type)&&w.show(d.extend({color:s.color},s.overlay,{anchor:t[0],name:this.name+"-drop",data:{item:s,btn:h}})).hide(e(s.id)).select((e=>{null!=e.detail.color&&this.colorClick({name:this.name,item:s,color:e.detail.color})}))}),0)}if(["check","menu","menu-radio","menu-check","drop","color","text-color"].includes(s.type)&&(s.checked=!s.checked,s.checked?a(this.box).find(h).addClass("checked"):a(this.box).find(h).removeClass("checked")),s.route){let e=String("/"+s.route).replace(/\/{2,}/g,"/");var r=d.parseRoute(e);if(0<r.keys.length)for(let t=0;t<r.keys.length;t++)e=e.replace(new RegExp(":"+r.keys[t].name,"g"),this.routeData[r.keys[t].name]);setTimeout((()=>{window.location.hash=e}),1)}this.tooltipShow(e),i.finish()}}scroll(e,t,i){return new Promise(((s,l)=>{var o=a(this.box).find(`.w2ui-tb-line:nth-child(${t}) .w2ui-scroll-wrapper`),n=o.get(0).scrollLeft,r=o.find(".w2ui-tb-right").get(0),d=o.parent().get(0).getBoundingClientRect().width,h=n+parseInt(r.offsetLeft)+parseInt(r.clientWidth);switch(e){case"left":(scroll=n-d+50)<=0&&(scroll=0),o.get(0).scrollTo({top:0,left:scroll,behavior:i?"atuo":"smooth"});break;case"right":(scroll=n+d-50)>=h-d&&(scroll=h-d),o.get(0).scrollTo({top:0,left:scroll,behavior:i?"atuo":"smooth"})}setTimeout((()=>{this.resize(),s()}),i?0:600)}))}render(e){var t=Date.now(),i=("string"==typeof e&&(e=a(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==i.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.box)){Array.isArray(this.right)||(this.right=[this.right]);let e="",l=0;for(let t=0;t<this.items.length;t++){var s=this.items[t];null!=s&&(null==s.id&&(s.id="item_"+t),null!=s.caption&&console.log("NOTICE: toolbar item.caption property is deprecated, please use item.text. Item -> ",s),null!=s.hint&&console.log("NOTICE: toolbar item.hint property is deprecated, please use item.tooltip. Item -> ",s),0!==t&&"new-line"!=s.type||(l++,e+=`\n                    <div class="w2ui-tb-line">\n                        <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">\n                            <div class="w2ui-tb-right">${this.right[l-1]??""}</div>\n                        </div>\n                        <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll", "left", "${l}"]'></div>\n                        <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll", "right", "${l}"]'></div>\n                    </div>\n                `),s.line=l)}return a(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-toolbar").html(e),0<a(this.box).length&&(a(this.box)[0].style.cssText+=this.style),d.bindEvents(a(this.box).find(".w2ui-tb-line .w2ui-eaction"),this),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),this.refresh(),this.resize(),i.finish(),Date.now()-t}}refresh(e){var t=Date.now(),i=this.trigger("refresh",{target:null!=e?e:this.name,item:this.get(e)});if(!0!==i.isCancelled){let r;if(null==e)for(let e=0;e<this.items.length;e++){var s=this.items[e];null==s.id&&(s.id="item_"+e),this.refresh(s.id)}else{var l=this.get(e);if(null==l)return!1;if("function"!=typeof l.onRefresh||!0!==(r=this.trigger("refresh",{target:e,item:l,object:l})).isCancelled){var o=`#tb_${this.name}_item_`+d.escapeId(l.id);let s=a(this.box).find(o);var n=this.getItemHTML(l);if(this.tooltipHide(e),"spacer"==l.type&&a(this.box).find(`.w2ui-tb-line:nth-child(${l.line??1})`).find(".w2ui-tb-right").css("width","auto"),0===s.length){e=parseInt(this.get(e,!0))+1;let t=a(this.box).find(`#tb_${this.name}_item_`+d.escapeId(this.items[e]?this.items[e].id:""));0==t.length?t=a(this.box).find(".w2ui-tb-line:nth-child("+l.line).find(".w2ui-tb-right").before(n):t.after(n),d.bindEvents(a(this.box).find(o+`, ${o} .w2ui-eaction`),this)}else{a(this.box).find(o).replace(a.html(n));let e=a(this.box).find(o),t=(d.bindEvents(e,this),d.bindEvents(e.find(".w2ui-eaction"),this),g.get(!0));Object.keys(t).forEach((i=>{t[i].anchor==s.get(0)&&(t[i].anchor=e.get(0))}))}if(["menu","menu-radio","menu-check"].includes(l.type)&&l.checked){let t=Array.isArray(l.selected)?l.selected:[l.selected];(e="function"==typeof l.items?l.items(l):[...l.items]).forEach((e=>{t.includes(e.id)?e.checked=!0:e.checked=!1})),f.update(this.name+"-drop",e)}return"function"==typeof l.onRefresh&&r.finish(),i.finish(),Date.now()-t}}}}resize(){var e=Date.now(),t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled)return a(this.box).find(".w2ui-tb-line").each((e=>{var t=((e=a(e)).find(".w2ui-scroll-left, .w2ui-scroll-right").hide(),e.find(".w2ui-scroll-wrapper").get(0)),i=e.find(".w2ui-tb-right"),s=e.get(0).getBoundingClientRect().width;s<(i=0<i.length?i[0].offsetLeft+i[0].clientWidth:0)&&(0<t.scrollLeft&&e.find(".w2ui-scroll-left").show(),s<i-t.scrollLeft)&&e.find(".w2ui-scroll-right").show()})),t.finish(),Date.now()-e}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<a(this.box).find(".w2ui-scroll-wrapper").length&&this.unmount(),delete r[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}getItemHTML(e){let t="",i=(null!=e.caption&&null==e.text&&(e.text=e.caption),null==e.text&&(e.text=""),null==e.tooltip&&null!=e.hint&&(e.tooltip=e.hint),null==e.tooltip&&(e.tooltip=""),"function"==typeof e.get||!Array.isArray(e.items)&&"function"!=typeof e.items||(e.get=function(t){let i=e.items;return(i="function"==typeof i?e.items(e):i).find((e=>e.id==t))}),""),s="function"==typeof e.text?e.text.call(this,e):e.text;e.icon&&(i=e.icon,"function"==typeof e.icon&&(i=e.icon.call(this,e)),i=`<div class="w2ui-tb-icon">${i="<"!==String(i).slice(0,1)?`<span class="${i}" ${e.icon_style?`style="${e.icon_style}"`:""}></span>`:i}</div>`);var l=["w2ui-tb-button","w2ui-eaction"];switch(e.checked&&l.push("checked"),e.disabled&&l.push("disabled"),e.hidden&&l.push("hidden"),i||l.push("no-icon"),e.type){case"color":case"text-color":if("string"==typeof e.color&&("#"==e.color.slice(0,1)&&(e.color=e.color.slice(1)),[3,6,8].includes(e.color.length))&&(e.color="#"+e.color),"color"==e.type&&(s=`<span class="w2ui-tb-color-box" style="background-color: ${null!=e.color?e.color:"#fff"}"></span>\n                           `+(e.text?`<div style="margin-left: 17px;">${d.lang(e.text)}</div>`:"")),"text-color"==e.type){var o=null!=e.color?e.color:"#444";let t=e.backColor;!0===e.backColor&&(t="#fff",d.colorContrast("#fff",o)<2)&&(t="#555"),s=`<span style="color: ${o}">${e.text?d.lang(e.text):e.backColor?`<b style="background-color: ${t??"transparent"}; padding: 2px 5px; border-radius: 3px;">Ab</b>`:"<b>Ab</b>"}</span>`}case"menu":case"menu-check":case"menu-radio":case"button":case"check":case"radio":case"label":case"drop":o=!0===e.arrow||!1!==e.arrow&&["menu","menu-radio","menu-check","drop","color","text-color"].includes(e.type),t=`\n                    <div id="tb_${this.name}_item_${e.id}" class="${l.join(" ")} ${e.class||""}"\n                        style="${e.hidden?"display: none":""} ${"label"==e.type?e.style??"":""}"\n                        ${e.disabled?"":`data-click='["click","${e.id}", "event"]'\n                               data-mouseenter='["mouseAction", "event", "this", "Enter", "${e.id}"]'\n                               data-mouseleave='["mouseAction", "event", "this", "Leave", "${e.id}"]'\n                               data-mousedown='["mouseAction", "event", "this", "Down", "${e.id}"]'\n                               data-mouseup='["mouseAction", "event", "this", "Up", "${e.id}"]'`}\n                    >\n                        ${i}\n                        ${""!=s&&null!=s||null!=e.count||o?`<div class="w2ui-tb-text" style="${"label"!=e.type?e.style??"":""}; ${s?"":"padding-left: 0; margin-left: 23px;"}">\n                                    ${d.lang(s)}\n                                    ${null!=e.count?d.stripSpaces(`\n                                            <span class="w2ui-tb-count">\n                                                <span class="${this.last.badge[e.id]?this.last.badge[e.id].className??"":""}"\n                                                        style="${this.last.badge[e.id]?this.last.badge[e.id].style??"":""}">${e.count}</span>\n                                            </span>`):""}\n                                    ${o?`<span class="w2ui-tb-down" ${s||e.count?"":'style="margin-left: -3px"'}><span></span></span>`:""}\n                                </div>`:""}\n                    </div>\n                `;break;case"break":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-break"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}">\n                            &#160;\n                        </div>`;break;case"spacer":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-spacer"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}">\n                        </div>`;break;case"html":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-html ${l.join(" ")}"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}">\n                            ${"function"==typeof e.html?e.html.call(this,e):e.html}\n                        </div>`;break;case"input":{var n;o=e.placeholder;let i=e.value;e.spinner&&"object"==typeof e.spinner&&(e.input??={},Object.assign(e.input,e.spinner,{spinner:!0})),null!=i&&""!==String(i).trim()&&e.input?.spinner&&(n=e.input?.step??1,n=e.input?.precision??String(n).split(".")[1]?.length??0,i=isNaN(i)?i:i.toFixed(n)),t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-input w2ui-eaction ${l.join(" ")}"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}"\n                        >\n                            <span class="w2ui-input-label">${e.text??""}</span>\n                            ${e.input?.spinner?`<span class="w2ui-spinner-dec w2ui-eaction" data-click='["spinner", "${e.id}", "dec", "event"]'> – </span>`:""}\n                            <input class="w2ui-toolbar-input w2ui-eaction ${e.input?.spinner?"w2ui-has-spinner":""}"\n                                ${o?`placeholder="${o}"`:""} style="${e.input?.style??""}"\n                                value="${i??""}${e.input?.suffix??""}" ${e.input?.attrs??""}\n                                data-input='["change", "${e.id}", "this", true]'\n                                data-change='["change", "${e.id}", "this"]'\n                                data-keydown='["spinner", "${e.id}", "key", "event"]'\n                                data-mouseenter='["mouseAction", "event", "this", "Enter", "${e.id}"]'\n                                data-mouseleave='["mouseAction", "event", "this", "Leave", "${e.id}"]'\n                            >\n                            ${e.input?.spinner?`<span class="w2ui-spinner-inc w2ui-eaction" data-click='["spinner", "${e.id}", "inc", "event"]'> + </span>`:""}\n                        </div>`;break}case"group":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-group"\n                    style="display: flex; ${e.hidden?"display: none":""}; ${e.style||""}">`,Array.isArray(e.items)?e.items.forEach((e=>{t+=this.getItemHTML(e)})):console.log("ERROR: toolbar group is empty"),t+="</div>"}return t}spinner(e,t,i){var s=this.get(e);let l=0;switch(t){case"inc":l=s.input?.step??1;break;case"dec":l=-(s.input?.step??1);break;case"key":if(s.input.spinner||null!=s.input.step){let e=1;switch((i.shiftKey||i.metaKey)&&(e=10),i.altKey&&(e=.1),i.key){case"ArrowUp":l=(s.input?.step??1)*e,i.preventDefault();break;case"ArrowDown":l=-(s.input?.step??1)*e,i.preventDefault()}}}0!==l&&this.change(e,parseFloat(s.value??0)+l)}change(e,t,i){var s=this.get(e),l=a(this.box).find("#tb_"+this.name+"_item_"+d.escapeId(e)).find("input.w2ui-toolbar-input"),o=(null==(t=t instanceof HTMLInputElement?t.value:t)&&(t=l.val()),!s.input.spinner&&null==s.input.min&&null==s.input.max&&null==s.input.step||(t=parseFloat(t)),null!=s.input?.suffix&&String(t).substr(-s.input.suffix.length)==s.input.suffix&&(t=String(t).substr(0,t.length-s.input.suffix.length)),null!=s.input?.min&&s.input.min>t&&(t=s.input.min),null!=s.input?.max&&s.input.max<t&&(t=s.input.max),s.input.step&&(isNaN(t)&&(t=s.input.min??0),o=s.input?.step??1,o=s.input.precision??String(o).split(".")[1]?.length??0,t=t.toFixed(o)),this.trigger(i?"input":"change",{target:e,id:e,value:t,item:s}));if(!o.isCancelled){s.value=t;let e="";null!=s.input?.suffix&&String(t).substr(-s.input.suffix.length)!=s.input.suffix&&(e=s.input.suffix),i||l.val(t+e),o.finish()}}tooltipShow(e){if(null!=this.tooltip){var t=a(this.box).find("#tb_"+this.name+"_item_"+d.escapeId(e)).get(0),i=(e=this.get(e),"string"==typeof this.tooltip?{position:this.tooltip}:this.tooltip);let s=e.tooltip;"function"==typeof s&&(s=s.call(this,e)),["menu","menu-radio","menu-check","drop","color","text-color"].includes(e.type)&&1==e.checked||g.show({anchor:t,name:this.name+"-tooltip",html:s,...i})}}tooltipHide(e){null!=this.tooltip&&g.hide(this.name+"-tooltip")}menuClick(e){if(e.item&&!e.item.disabled){var t=this.trigger(!0!==e.remove?"click":"remove",{target:e.item.id+":"+e.subItem.id,item:e.item,subItem:e.subItem,originalEvent:e.originalEvent});if(!0!==t.isCancelled){let l=e.subItem,o=this.get(e.item.id),n=o.items;if("function"==typeof n&&(n=o.items()),"menu"==o.type&&(o.selected=l.id),"menu-radio"==o.type&&(o.selected=l.id,Array.isArray(n)&&n.forEach((e=>{!0===e.checked&&delete e.checked,Array.isArray(e.items)&&e.items.forEach((e=>{!0===e.checked&&delete e.checked}))})),l.checked=!0),"menu-check"==o.type)if(Array.isArray(o.selected)||(o.selected=[]),null==l.group){var i=o.selected.indexOf(l.id);-1==i?(o.selected.push(l.id),l.checked=!0):(o.selected.splice(i,1),l.checked=!1)}else if(!1!==l.group){let e=[];i=o.selected.indexOf(l.id);let t=i=>{i.forEach((i=>{var s;i.group===l.group&&-1!=(s=o.selected.indexOf(i.id))&&(i.id!=l.id&&e.push(i.id),o.selected.splice(s,1)),Array.isArray(i.items)&&t(i.items)}))};t(n),-1==i&&(o.selected.push(l.id),l.checked=!0)}if("string"==typeof l.route){let e=""!==l.route?String("/"+l.route).replace(/\/{2,}/g,"/"):"";var s=d.parseRoute(e);if(0<s.keys.length)for(let t=0;t<s.keys.length;t++)null!=this.routeData[s.keys[t].name]&&(e=e.replace(new RegExp(":"+s.keys[t].name,"g"),this.routeData[s.keys[t].name]));setTimeout((()=>{window.location.hash=e}),1)}this.refresh(e.item.id),t.finish()}}}colorClick(e){var t;e.item&&!e.item.disabled&&!0!==(t=this.trigger("click",{target:e.item.id,item:e.item,color:e.color,final:!0})).isCancelled&&(e.item.color=e.color,this.refresh(e.item.id),t.finish())}mouseAction(e,t,i,s){var l=this.get(s);if(!0!==(e=this.trigger("mouse"+i,{target:s,item:l,object:l,originalEvent:e})).isCancelled&&!l.disabled&&!l.hidden){switch(i){case"Enter":["label","input"].includes(l.type)||a(t).addClass("over"),this.tooltipShow(s);break;case"Leave":["label","input"].includes(l.type)||a(t).removeClass("over down"),this.tooltipHide(s);break;case"Down":["label","input"].includes(l.type)||a(t).addClass("down");break;case"Up":["label","input"].includes(l.type)||a(t).removeClass("down")}e.finish()}}}class v extends l{constructor(e){super(e.name),this.name=null,this.box=null,this.sidebar=null,this.parent=null,this.nodes=[],this.menu=[],this.routeData={},this.selected=null,this.icon=null,this.style="",this.topHTML="",this.bottomHTML="",this.multi=!1,this.editable=!1,this.reorder=!1,this.flatButton=!1,this.keyboard=!0,this.flat=!1,this.hasFocus=!1,this.levelPadding=12,this.toggleAlign="right",this.skipRefresh=!1,this.tabIndex=null,this.handle={width:0,style:"",text:"",tooltip:""},this.badge=null,this.onClick=null,this.onSelect=null,this.onUnselect=null,this.onDblClick=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onContextMenu=null,this.onMenuClick=null,this.onExpand=null,this.onCollapse=null,this.onKeydown=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onFocus=null,this.onBlur=null,this.onFlat=null,this.onEdit=null,this.onRename=null,this.onReorder=null,this.onDragStart=null,this.onDragOver=null,this.node_template={id:null,text:"",order:null,count:null,icon:null,nodes:[],style:"",route:null,selected:!1,expanded:!1,hidden:!1,disabled:!1,group:!1,groupShowHide:!0,collapsible:!1,plus:!1,childOffset:0,onClick:null,onDblClick:null,onContextMenu:null,onExpand:null,onCollapse:null,parent:null,sidebar:null},this.last={badge:{},renaming:!1,move:null};var t=e.nodes;delete e.nodes,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.nodes=t,"string"==typeof this.box&&(this.box=a(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){return 1==arguments.length&&(t=arguments[0],e=this),"string"==typeof e&&(e=this.get(e)),this.insert(e=null!=e&&""!=e?e:this,null,t)}insert(e,t,i){let s,l,o,n,a;if(2==arguments.length&&"string"==typeof e)if(i=arguments[1],null!=(t=arguments[0])){if(null==(l=this.get(t)))return null!=(i=Array.isArray(i)?i:[i])[0].caption&&null==i[0].text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",i[0]),i[0].text=i[0].caption),s=i[0].text,console.log('ERROR: Cannot insert node "'+s+'" because cannot find node "'+t+'" to insert before.'),null;e=this.get(t).parent}else e=this;null!=(e="string"==typeof e?this.get(e):e)&&""!=e||(e=this),Array.isArray(i)||(i=[i]);for(let r=0;r<i.length;r++)if(null!=(n=i[r]).caption&&null==n.text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text"),n.text=n.caption),null==typeof n.id)s=n.text,console.log('ERROR: Cannot insert node "'+s+'" because it has no id.');else if(null!=this.get(this,n.id))console.log("ERROR: Cannot insert node with id="+n.id+" (text: "+n.text+") because another node with the same id already exists.");else{if((o=Object.assign({},this.node_template,n)).sidebar=this,o.parent=e,a=o.nodes||[],o.nodes=[],null==t)e.nodes.push(o);else{if(null==(l=this.get(e,t,!0)))return console.log('ERROR: Cannot insert node "'+n.text+'" because cannot find node "'+t+'" to insert before.'),null;e.nodes.splice(l,0,o)}0<a.length&&this.insert(o,null,a)}return this.skipRefresh||this.refresh(e.id),o}remove(){let e,t=0;return Array.from(arguments).forEach((i=>{null!=(e=this.get(i))&&(null!=this.selected&&(Array.isArray(this.selected)?this.selected.splice(this.selected.indexOf(e.id),1):this.selected===e.id&&(this.selected=null)),null!=(i=this.get(e.parent,i,!0)))&&(e.parent.nodes[i].selected&&e.sidebar.unselect(e.id),e.parent.nodes.splice(i,1),e.parent.collapsible=0<e.parent.nodes.length,t++)})),this.skipRefresh||(0<t&&1==arguments.length?this.refresh(e.parent.id):this.refresh()),t}set(e,t,i){if(2==arguments.length&&(i=t,t=e,e=this),null==(e="string"==typeof e?this.get(e):e).nodes)return null;for(let l=0;l<e.nodes.length;l++){var s;if(e.nodes[l].id===t)return s=this.update(t,i),0!=Object.keys(s).length&&(s=i.nodes,d.extend(e.nodes[l],i,null!=s?{nodes:[]}:{}),null!=s&&this.add(e.nodes[l],s),this.skipRefresh||this.refresh(t)),!0;if(this.set(e.nodes[l],t,i))return!0}return!1}get(e,t,i){if(0===arguments.length){var s=[],l=this.find({});for(let e=0;e<l.length;e++)null!=l[e].id&&s.push(l[e].id);return s}if((1==arguments.length||2==arguments.length&&!0===t)&&(i=t,t=e,e=this),null!=(e="string"==typeof e?this.get(e):e).nodes)for(let s=0;s<e.nodes.length;s++){if(e.nodes[s].id==t)return!0===i?s:e.nodes[s];var o=this.get(e.nodes[s],t,i);if(o||0===o)return o}return null}setCount(e,t,i={}){var s=a(this.box).find(`#node_${d.escapeId(e)} .w2ui-node-badge`);0<s.length?(s.removeClass().addClass("w2ui-node-badge "+(i.className??"w2ui-node-count")).text(t).get(0).style.cssText=i.style||"",this.last.badge[e]={className:i.className??"",style:i.style??""},this.get(e).count=t):(this.set(e,{count:t}),this.setCount(...arguments))}find(e,t,i){if(1==arguments.length&&(t=e,e=this),i=i||[],null!=(e="string"==typeof e?this.get(e):e).nodes)for(let l=0;l<e.nodes.length;l++){let o=!0;for(var s in t)e.nodes[l][s]!=t[s]&&(o=!1);o&&i.push(e.nodes[l]),0<e.nodes[l].nodes.length&&(i=this.find(e.nodes[l],t,i))}return i}sort(e,t){null==(e=e&&"object"==typeof e?e:{}).foldersFirst&&(e.foldersFirst=!0),null==e.caseSensitive&&(e.caseSensitive=!1),null==e.reverse&&(e.reverse=!1),(t=null==t?this.nodes:t).sort(((t,i)=>{var s=t.nodes&&0<t.nodes.length,l=i.nodes&&0<i.nodes.length;if(!1===e.foldersFirst||!s&&!l||s&&l){let s=t.text,l=i.text;return e.caseSensitive||(s=s.toLowerCase(),l=l.toLowerCase()),null!=t.order&&(s=t.order),null!=i.order&&(l=i.order),(1===(t=d.naturalCompare(s,l))||-1===t)&e.reverse?-t:t}return s&&!l?e.reverse?1:-1:!s&&l?e.reverse?-1:1:void 0})),t.forEach((t=>{t.nodes&&0<t.nodes.length&&this.sort(e,t.nodes)}))}each(e,t){(t=null==t?this.nodes:t).forEach((t=>{e.call(this,t),t.nodes&&0<t.nodes.length&&this.each(e,t.nodes)}))}search(e,t=null){let i=0,s=e.toLowerCase();return this.each((l=>{let o=!1;(o="function"==typeof t?t(e,l):!(-1===l.text.toLowerCase().indexOf(s)))?(i++,function e(t){t.parent&&(t.parent.hidden=!1,e(t.parent))}(l),l.hidden=!1):l.hidden=!0})),this.refresh(),i}show(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!1!==t.hidden&&(t.hidden=!1,e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}hide(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!0!==t.hidden&&(t.hidden=!0,e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}enable(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!1!==t.disabled&&(t.disabled=!1,e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}disable(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!0!==t.disabled&&(t.disabled=!0,t.selected&&this.unselect(t.id),e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}select(e){if(!Array.isArray(e)){var t=this.get(e);if(!t)return!1;var i=this.trigger("select",{target:e,id:e,node:t});if(!0!==i.isCancelled){if(!this.multi&&this.selected==e&&t.selected)return!1;var s=a(this.box).find("#node_"+d.escapeId(e));s.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),0<s.length&&(this.inView(e)||this.scrollIntoView(e)),t.selected=!0,this.multi?(Array.isArray(this.selected)||(this.selected=this.selected?[this.selected]:[]),this.selected.push(e)):this.selected=this.multi?[e]:e,i.finish()}return!0}[...e].forEach((e=>this.select(e)))}unselect(e){var t,i;if(0===arguments.length&&(e=this.selected),!Array.isArray(e))return!!(i=this.get(e))&&(!0!==(t=this.trigger("unselect",{target:e,id:e,node:i})).isCancelled&&(i.selected=!1,a(this.box).find("#node_"+d.escapeId(e)).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),"string"==typeof this.selected&&this.selected==e&&(this.selected=null),this.multi&&Array.isArray(this.selected)&&-1!=(i=this.selected.indexOf(e))&&this.selected.splice(i,1),t.finish()),!0);[...e].forEach((e=>this.unselect(e)))}toggle(e){var t=this.get(e);return null!=t&&(t.plus?(this.set(e,{plus:!1}),this.expand(e),void this.refresh(e)):0!==t.nodes.length&&!!t.collapsible&&(this.get(e).expanded?this.collapse(e):this.expand(e)))}collapse(e){var t,i=this.get(e);return null!=i&&(!0!==(t=this.trigger("collapse",{target:e,object:i,node:i})).isCancelled?(a(this.box).find("#node_"+d.escapeId(e)+"_sub").hide(),a(this.box).find("#node_"+d.escapeId(e)+" .w2ui-expanded").removeClass("w2ui-expanded").addClass("w2ui-collapsed"),i.expanded=!1,t.finish(),this.refresh(e),!0):void 0)}expand(e){var t=this.get(e),i=this.trigger("expand",{target:e,object:t,node:t});if(!0!==i.isCancelled)return a(this.box).find("#node_"+d.escapeId(e)+"_sub").show(),a(this.box).find("#node_"+d.escapeId(e)+" .w2ui-collapsed").removeClass("w2ui-collapsed").addClass("w2ui-expanded"),t.expanded=!0,i.finish(),this.refresh(e),!0}collapseAll(e){if(null==(e="string"==typeof(e=null==e?this:e)?this.get(e):e).nodes)return!1;for(let t=0;t<e.nodes.length;t++)!0===e.nodes[t].expanded&&(e.nodes[t].expanded=!1),e.nodes[t].nodes&&0<e.nodes[t].nodes.length&&this.collapseAll(e.nodes[t]);return this.refresh(e.id),!0}expandAll(e){if(null==(e="string"==typeof(e=null==e?this:e)?this.get(e):e).nodes)return!1;for(let t=0;t<e.nodes.length;t++)!1===e.nodes[t].expanded&&(e.nodes[t].expanded=!0),e.nodes[t].nodes&&0<e.nodes[t].nodes.length&&this.expandAll(e.nodes[t]);this.refresh(e.id)}expandParents(e){return null!=(e=this.get(e))&&(e.parent&&(e.parent.expanded||(e.parent.expanded=!0,this.refresh(e.parent.id)),this.expandParents(e.parent.id)),!0)}click(e,t){let i=this,s=this.get(e);if(null!=s)if(s.disabled||s.group)i.trigger("click",{target:e,originalEvent:t,node:s,object:s}).finish();else{let l=a(i.box).find("#node_"+d.escapeId(e));l.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),setTimeout((()=>{var o=i.trigger("click",{target:e,originalEvent:t,node:s,object:s});if(!0===o.isCancelled)l.removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected");else{if(this.multi){var n=t?.shiftKey??!1,a=(t?.ctrlKey||t?.metaKey)??!1;if("string"==typeof this.selected&&(this.selected=[this.selected]),a&&!n){if(this.selected?.includes(e))return void this.unselect(e);this.select(e)}else if(!a&&n){let t=this.getChain();var r=Math.min(this.selected.map((e=>t.indexOf(e)))),h=t.indexOf(e);for(let e=Math.min(r,h);e<t.length&&e<=Math.max(r,h);e++){var c=this.get(t[e]);this.selected.includes(t[e])||1==c.hidden||this.select(t[e])}}else a=this.selected?.filter((t=>t!=e&&this.selected.includes(t))),this.unselect(a),this.selected?.includes(e)||this.select(e)}else if(this.selected!==e&&(null!=this.selected&&this.unselect(this.selected),this.select(e),"string"==typeof s.route)){let e=""!==s.route?String("/"+s.route).replace(/\/{2,}/g,"/"):"";var u=d.parseRoute(e);if(0<u.keys.length)for(let t=0;t<u.keys.length;t++)null!=i.routeData[u.keys[t].name]&&(e=e.replace(new RegExp(":"+u.keys[t].name,"g"),i.routeData[u.keys[t].name]));setTimeout((()=>{window.location.hash=e}),1)}o.finish()}}),1)}}focus(e){let t=this;if(!0===(e=this.trigger("focus",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!0,a(this.box).find(".w2ui-sidebar-body").addClass("w2ui-focus"),setTimeout((()=>{var e=a(t.box).find("#sidebar_"+t.name+"_focus").get(0);document.activeElement!=e&&e.focus()}),10),e.finish()}blur(e){if(!0===(e=this.trigger("blur",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!1,a(this.box).find(".w2ui-sidebar-body").removeClass("w2ui-focus"),e.finish()}next(e,t){if(null==e)return null;var i=e.parent,s=this.get(e.id,!0);let l=null;return null!=(l=e.expanded&&0<e.nodes.length&&!0!==t?(t=e.nodes[0]).hidden||t.disabled||t.group?this.next(t):t:i&&s+1<i.nodes.length?i.nodes[s+1]:this.next(i,!0))&&(l.hidden||l.disabled||l.group)?this.next(l):l}prev(e){if(null==e)return null;var t=e.parent;e=this.get(e.id,!0);let i=e=>{var t;return e.expanded&&0<e.nodes.length?(t=e.nodes[e.nodes.length-1]).hidden||t.disabled||t.group?this.prev(t):i(t):e},s=0<e?i(t.nodes[e-1]):t;return null!=s&&(s.hidden||s.disabled||s.group)?this.prev(s):s}getChain(e,t={}){t.returnDisabled??=!1,t.returnGroups??=!1;let i=[];return(e=null==e?this.nodes:e).forEach((e=>{(!e.disabled&&!e.group||e.disabled&&t.returnDisabled||e.group&&t.returnGroups)&&i.push(e.id),Array.isArray(e.nodes)&&e.expanded&&i.push(...this.getChain(e.nodes,t))})),i}keydown(e){let t=this;var i=Array.isArray(this.selected)?this.selected[0]:this.selected;let s=t.get(i);if(!0===this.keyboard){if(s=s||this.nodes[0],27==e.keyCode){var l=this.last.move;if(l?.reorder&&l?.moved)return void l.restore()}!0!==(l=this.trigger("keydown",{target:this.name,originalEvent:e})).isCancelled&&(13!=e.keyCode&&32!=e.keyCode||(13!=e.keyCode||!this.editable||e.ctrlKey||e.metaKey?0<s.nodes.length&&this.toggle(i):this.edit(i)),37==e.keyCode&&(0<s.nodes.length&&s.expanded?this.collapse(i):(o(s.parent),s.parent.group||this.collapse(s.parent.id))),39==e.keyCode&&(0<s.nodes.length||s.plus)&&!s.expanded&&this.expand(i),38==e.keyCode&&(null==this.get(i)?o(this.nodes[0]||null):o(n(s,this.prev))),40==e.keyCode&&(null==this.get(i)?o(this.nodes[0]||null):o(n(s,this.next))),[13,32,37,38,39,40].includes(e.keyCode)&&(e.preventDefault&&e.preventDefault(),e.stopPropagation)&&e.stopPropagation(),l.finish())}function o(e,i){null==e||e.hidden||e.disabled||e.group||(t.click(e.id,i),t.inView(e.id))||t.scrollIntoView(e.id)}function n(e,i){for(e=i.call(t,e);null!=e&&(e.hidden||e.disabled)&&!e.group;)e=i(e);return e}}inView(e){var t;return!(!(e=a(this.box).find("#node_"+d.escapeId(e)).get(0))||(t=a(this.box).find(".w2ui-sidebar-body").get(0),e.offsetTop<t.scrollTop)||e.offsetTop+e.clientHeight>t.clientHeight+t.scrollTop)}scrollIntoView(e,t){return new Promise(((i,s)=>{null==e&&(e=Array.isArray(this.selected)?this.selected[0]:this.selected),null!=this.get(e)&&(a(this.box).find("#node_"+d.escapeId(e)).get(0).scrollIntoView({block:"center",inline:"center",behavior:t?"atuo":"smooth"}),setTimeout((()=>{this.resize(),i()}),t?0:500))}))}dblClick(e,t){var i=this.get(e);!0!==(t=this.trigger("dblClick",{target:e,originalEvent:t,object:i})).isCancelled&&(this.editable?this.edit(e):this.toggle(e),t.finish())}mouseDown(e,t){let i=this;if(this.reorder){this.last.move={x:t.screenX,y:t.screenY,divX:0,divY:0,reorder:!0,moved:!1};let o=this.last.move;var s,l=a(this.box).find(".w2ui-sidebar-body");o.ghost||(s=a(this.box).find("#node_"+d.escapeId(e)),o.offsetY=t.offsetY,o.target=e,o.pos={top:s.get(0).offsetTop-1,left:s.get(0).offsetLeft},t=a(s.find(".w2ui-node-data").get(0).cloneNode(!0)),o.node=s,o.nodeSub=s.next(),l.append('<div id="sidebar_'+this.name+'_ghost" class="w2ui-node w2ui-ghost"></div>'),a(this.box).find("#sidebar_"+this.name+"_ghost").append(t),o.ghost=a(this.box).find("#sidebar_"+this.name+"_ghost"),o.ghost.css({display:"none"}),o.restore=()=>{o.resetReorder(),this.refresh()},o.resetReorder=()=>{this.last.move=null,a(this.box).find(`#sidebar_${this.name}_ghost`).remove(),a(document).off(`.w2ui-${this.name}-reorder`)}),a(document).on(`mousemove.w2ui-${this.name}-reorder`,(function(e){if(e.target.tagName){var t=i.last.move;if(t.divX=e.screenX-t.x,t.divY=e.screenY-t.y,!(Math.abs(t.divX)<=1&&Math.abs(t.divY)<=1)){if(1==i.reorder&&t.reorder&&!t.moved){var s=i.trigger("dragStart",{target:t.target,moved:!0,node:i.get(t.target),mv:t,originalEvent:e});if(!0===s.isCancelled)return void t.restore();var l=t.node.get(0).getBoundingClientRect();t.moved=!0,t.node.html("").removeAttr("id","data-id").addClass("w2ui-reorder-empty").css({height:l.height+"px"}),"none"!==t.node.next().css("display")&&(l=t.node.next().get(0).getBoundingClientRect(),t.node.next().html('<div class="w2ui-reorder-empty-sub"></div>').css({height:l.height+"px"})),t.ghost.css({display:"block"}),s.finish()}var o;t.ghost.css({top:t.pos.top+t.divY+"px",left:0}),l=a(e.target).closest(".w2ui-node, .w2ui-node-group").attr("data-id"),a(e.target).hasClass("w2ui-sidebar-body")&&5<e.layerY&&!t.append?!0!==(s=i.trigger("dragOver",{target:t.target,append:!0,mv:t,originalEvent:e})).isCancelled&&(t.ghost.before(t.node),t.ghost.before(t.nodeSub),t.append=!0,t.moveBefore=null,s.finish()):null!=l&&l!=t.moveBefore&&(t.append=!1,t.moveBefore=l,!0!==(e=i.trigger("dragOver",{target:t.target,moveBefore:l,mv:t,originalEvent:e})).isCancelled)&&((o=a(i.box).find("#node_"+d.escapeId(l))).before(t.node),o.before(t.nodeSub),e.finish())}}})).on(`mouseup.w2ui-${this.name}-reorder`,(function(e){var t=i.last.move;if(t.resetReorder(),t.moved)if(null!=t.moveBefore&&t.target!=t.moveBefore||t.append)if(!0===(e=i.trigger("reorder",{target:t.target,moveBefore:t.moveBefore,append:t.append,originalEvent:e})).isCancelled)i.refresh();else{var s=(l=i.get(t.target)).parent.nodes.indexOf(l),l=l.parent.nodes.splice(s,1);if(t.append)i.nodes.push(...l),l.forEach((e=>e.parent=i));else{let e=i.get(t.moveBefore);s=e.parent.nodes.indexOf(e),l.forEach((t=>t.parent=e.parent)),e.parent.nodes.splice(s,0,...l)}i.refresh(),e.finish()}else i.refresh()}))}}edit(e){let t=this,i=a(this.box).find("#node_"+d.escapeId(e)),s=i.find(".w2ui-node-text");var l=this.trigger("edit",{target:e,el:i,textEl:s});if(!0!==l.isCancelled){this.last.renaming=!0,i.addClass("w2ui-editing"),s.addClass("w2ui-focus").css("pointer-events","all").attr("contenteditable",d.isFirefox?"true":"plaintext-only").on("blur.node-editing",(e=>{setTimeout(n,0)})).on("keydown.node-editing",(e=>{13==e.keyCode&&n(e),27==e.keyCode&&n(e,!0)})).get(0).focus();let o=s.text();return d.setCursorPosition(s[0],0,s.text().length),l.finish(),s.get(0);function n(l,n){var a=s.text();if(i.removeClass("w2ui-editing"),s.removeClass("w2ui-focus").css("pointer-events","none").removeAttr("contenteditable").off(".node-editing"),!n&&t.last.renaming&&o!==a){if(!0===(l=t.trigger("rename",{target:e,text_previous:o,text_new:a,originalEvent:l})).isCancelled)return s.text(o),t.last.renaming=!1,void t.focus();t.set(e,{text:a}),l.finish()}n&&t.set(e,{text:o}),t.last.renaming=!1,t.focus()}}}contextMenu(e,t){var i=this.get(e),s=(Array.isArray(this.selected)?this.selected.includes(e)||this.click(e):e!=this.selected&&this.click(e),this.trigger("contextMenu",{target:e,originalEvent:t,object:i,allowOnDisabled:!1}));!0===s.isCancelled||i.disabled&&!s.allowOnDisabled||(0<this.menu.length&&f.show({name:this.name+"_menu",anchor:document.body,items:this.menu,originalEvent:t}).select((i=>{this.menuClick(e,parseInt(i.detail.index),t)})),t.preventDefault&&t.preventDefault(),s.finish())}menuClick(e,t,i){!0!==(e=this.trigger("menuClick",{target:e,originalEvent:i,menuIndex:t,menuItem:this.menu[t]})).isCancelled&&e.finish()}goFlat(){var e=this.trigger("flat",{goFlat:!this.flat});!0!==e.isCancelled&&(this.flat=!this.flat,this.refresh(),e.finish())}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=a(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.box)){let l;return a(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-sidebar").html(`<div>\n                <div class="w2ui-sidebar-top"></div>\n                <input id="sidebar_${this.name}_focus" ${this.tabIndex?'tabindex="'+this.tabIndex+'"':""}\n                    style="position: absolute; top: 0; right: 0; width: 1px; z-index: -1; opacity: 0"\n                    ${d.isMobile?"readonly":""}/>\n                <div class="w2ui-sidebar-body"></div>\n                <div class="w2ui-sidebar-bottom"></div>\n            </div>`),e=a(this.box).get(0).getBoundingClientRect(),a(this.box).find(":scope > div").css({width:e.width+"px",height:e.height+"px"}),a(this.box).get(0).style.cssText+=this.style,a(this.box).find("#sidebar_"+this.name+"_focus").on("focus",(function(e){clearTimeout(l),i.hasFocus||i.focus(e)})).on("blur",(function(e){l=setTimeout((()=>{i.hasFocus&&i.blur(e)}),100)})).on("keydown",(function(e){r[i.name].keydown.call(r[i.name],e)})),a(this.box).off("mousedown").on("mousedown",(function(e){setTimeout((()=>{var t;-1==["INPUT","TEXTAREA","SELECT"].indexOf(e.target.tagName.toUpperCase())&&(t=a(i.box).find("#sidebar_"+i.name+"_focus"),document.activeElement!=t.get(0))&&0<t.length&&t.get(0).focus()}),1)})),e=`<div class="w2ui-flat w2ui-flat-${this.flat?"right":"left"}" ${0==this.flatButton?'style="display: none"':""}></div>`,""===this.topHTML&&!e||(a(this.box).find(".w2ui-sidebar-top").html(this.topHTML+e),a(this.box).find(".w2ui-sidebar-body").css("top",a(this.box).find(".w2ui-sidebar-top").get(0)?.clientHeight+"px"),a(this.box).find(".w2ui-flat").off("click").on("click",(e=>{this.goFlat()}))),""!==this.bottomHTML&&(a(this.box).find(".w2ui-sidebar-bottom").html(this.bottomHTML),a(this.box).find(".w2ui-sidebar-body").css("bottom",a(this.box).find(".w2ui-sidebar-bottom").get(0)?.clientHeight+"px")),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),s.finish(),this.refresh(),Date.now()-t}}update(e,t={}){let i;if(e=this.get(e)){var s=a(this.box).find("#node_"+d.escapeId(e.id));if(e.group)t.text&&(e.text=t.text,s.find(".w2ui-group-text").replace("function"==typeof e.text?e.text.call(this,e):'<span class="w2ui-group-text">'+e.text+"</span>"),delete t.text),t.class&&(e.class=t.class,i=s.data("level"),s.get(0).className="w2ui-node-group w2ui-level-"+i+(e.class?" "+e.class:""),delete t.class),t.style&&(e.style=t.style,s.get(0).nextElementSibling.style=e.style+";"+(!e.hidden&&e.expanded?"":"display: none;"),delete t.style);else{if(t.icon&&0<(l=s.find(".w2ui-node-image > span")).length&&(e.icon=t.icon,l[0].className="function"==typeof e.icon?e.icon.call(this,e):e.icon,delete t.icon),t.count){e.count=t.count;let n=e.count??this.badge.text;var l=this.badge.style,o=this.last.badge[e.id];"function"==typeof n&&(n=n.call(this,e,i)),s.find(".w2ui-node-badge").html(n).attr("style",l+"; "+(o?.style??"")),0<s.find(".w2ui-node-badge").length&&delete t.count}t.class&&0<s.length&&(e.class=t.class,i=s.data("level"),s[0].className="w2ui-node w2ui-level-"+i+(e.selected?" w2ui-selected":"")+(e.disabled?" w2ui-disabled":"")+(e.class?" "+e.class:""),delete t.class),t.text&&(e.text=t.text,s.find(".w2ui-node-text").html("function"==typeof e.text?e.text.call(this,e):e.text),delete t.text),t.style&&0<s.length&&(l=s.find(".w2ui-node-text"),e.style=t.style,l[0].style=e.style,delete t.style)}}return t}refresh(e,t){if(null!=this.box){var i=Date.now();let r=this;var s=this.trigger("refresh",{target:null!=e?e:this.name,nodeId:null!=e?e:null,fullRefresh:null==e});if(!0!==s.isCancelled){1==this.flatButton?a(this.box).find(".w2ui-sidebar-top .w2ui-flat").show().removeClass("w2ui-flat-left w2ui-flat-right").addClass(" w2ui-flat-"+(this.flat?"right":"left")):a(this.box).find(".w2ui-sidebar-top .w2ui-flat").hide(),a(this.box).find(":scope > div").removeClass("w2ui-sidebar-flat").addClass(this.flat?"w2ui-sidebar-flat":"").css({width:a(this.box).get(0)?.clientWidth+"px",height:a(this.box).get(0)?.clientHeight+"px"}),0<this.nodes.length&&null==this.nodes[0].parent&&(l=this.nodes,this.nodes=[],this.add(this,l));let h,c,u=this;if(null==e)h=this,c=".w2ui-sidebar-body";else{if(null==(h=this.get(e)))return;c="#node_"+d.escapeId(h.id)+"_sub"}var l="#node_"+d.escapeId(h.id);let p;h!==this&&(p=m(h),a(this.box).find(l).before('<div id="sidebar_'+this.name+'_tmp"></div>'),a(this.box).find(l).remove(),a(this.box).find(c).remove(),a(this.box).find("#sidebar_"+this.name+"_tmp").before(p),a(this.box).find("#sidebar_"+this.name+"_tmp").remove()),e=a(this.box).find(":scope > div").get(0);var o={top:e?.scrollTop,left:e?.scrollLeft};a(this.box).find(c).html("");for(let g=0;g<h.nodes.length;g++){var n=h.nodes[g];if(p=m(n),a(this.box).find(c).append(p),0!==n.nodes.length)this.refresh(n.id,!0);else{if(!0===(n=this.trigger("refresh",{target:n.id})).isCancelled)return;n.finish()}}return e&&(e.scrollTop=o.top,e.scrollLeft=o.left),t||(e=a(this.box).find(l+`, ${l} .w2ui-eaction, ${c} .w2ui-eaction`),d.bindEvents(e,this)),s.finish(),Date.now()-i;function m(e){let t="",i=e.icon,s=(null==i&&(i=u.icon),e.parent),l=0;for(;s&&null!=s.parent;)s=s.parent,l++;if(null!=e.caption&&null==e.text&&(e.text=e.caption),null!=e.caption&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",e),e.text=e.caption),Array.isArray(e.nodes)&&0<e.nodes.length&&(e.collapsible=!0),e.group){let i=d.lang("function"==typeof e.text?e.text.call(u,e,l):e.text);"<span"!=String(i).substr(0,5)&&(i=`<span class="w2ui-group-text">${i}</span>`),t=`\n                    <div id="node_${e.id}" data-id="${e.id}" data-level="${l}" style="${e.hidden?"display: none":""}"\n                        class="w2ui-node-group w2ui-level-${l} ${e.class||""} w2ui-eaction"\n                        data-click="toggle|${e.id}"\n                        data-contextmenu="contextMenu|${e.id}|event"\n                        data-mouseenter="showPlus|this|inherit"\n                        data-mouseleave="showPlus|this|transparent">\n                        ${e.groupShowHide&&e.collapsible?`<span>${!e.hidden&&e.expanded?d.lang("Hide"):d.lang("Show")}</span>`:"<span></span>"} ${i}\n                    </div>\n                    <div class="w2ui-node-sub" id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}">\n                </div>`,u.flat&&(t=`\n                        <div class="w2ui-node-group" id="node_${e.id}" data-id="${e.id}"><span>&#160;</span></div>\n                        <div id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}"></div>`)}else{e.selected&&!e.disabled&&(u.multi?(u.selected??=[],u.selected.includes(e.id)||u.selected.push(e.id)):u.selected=e.id);let s="";i&&(s=i instanceof Object?(o="function"==typeof i.text?i.text.call(u,e,l)??"":i.text,`\n                            <div class="w2ui-node-image w2ui-eaction" style="${u.icon.style??""}; pointer-events: all"\n                                data-mouseEnter="mouseAction|Enter|this|${e.id}|event|icon"\n                                data-mouseLeave="mouseAction|Leave|this|${e.id}|event|icon"\n                                data-click="mouseAction|click|this|${e.id}|event|icon">\n                                    ${o}\n                            </div>\n                        `):`\n                            <div class="w2ui-node-image">\n                                <span class="${"function"==typeof i?i.call(u,e,l):i}"></span>\n                            </div>`);let a="",h="";if(null!=r.badge||null!=e.count){let t=e.count??r.badge?.text;var o=r.badge?.style,n=u.last.badge[e.id];(t="function"==typeof t?t.call(r,e,l):t)&&(h=`\n                            <div class="w2ui-node-badge w2ui-eaction ${null!=e.count?"w2ui-node-count":""} ${n?.className??""}"\n                                style="${o??""};${n?.style??""}"\n                                data-mouseEnter="mouseAction|Enter|this|${e.id}|event|badge"\n                                data-mouseLeave="mouseAction|Leave|this|${e.id}|event|badge"\n                                data-click="mouseAction|click|this|${e.id}|event|badge"\n                            >\n                                ${t}\n                            </div>`)}o=["w2ui-node","w2ui-level-"+l,"w2ui-eaction"],e.selected&&o.push("w2ui-selected"),e.disabled&&o.push("w2ui-disabled"),e.class&&o.push(e.class),!0===e.collapsible&&(n=["w2ui-sb-toggle","w2ui-eaction",e.expanded?"w2ui-expanded":"w2ui-collapsed"],"left"==r.toggleAlign&&n.push("w2ui-left-toggle"),a=`<div class="${n.join(" ")}" data-click="toggle|${e.id}"><span></span></div>`,o.push("w2ui-has-children")),n=d.lang("function"==typeof e.text?e.text.call(u,e,l):e.text);let c=e.parent?.childOffset??0;0===l&&!0===e.collapsible&&"left"==r.toggleAlign&&(c+=12),t=`\n                    <div id="node_${e.id}" class="${o.join(" ")}" data-id="${e.id}" data-level="${l}"\n                        style="${e.hidden?"display: none;":""}"\n                        data-click="click|${e.id}|event"\n                        data-dblclick="dblClick|${e.id}|event"\n                        data-mouseDown="mouseDown|${e.id}|event"\n                        data-contextmenu="contextMenu|${e.id}|event"\n                        data-mouseEnter="mouseAction|Enter|this|${e.id}|event"\n                        data-mouseLeave="mouseAction|Leave|this|${e.id}|event"\n                    >\n                        ${u.handle.text?`<div class="w2ui-node-handle w2ui-eaction" style="width: ${u.handle.width}px; ${u.handle.style}"\n                                    data-mouseEnter="mouseAction|Enter|this|${e.id}|event|handle"\n                                    data-mouseLeave="mouseAction|Leave|this|${e.id}|event|handle"\n                                    data-click="mouseAction|click|this|${e.id}|event|handle"\n                                >\n                                   ${"function"==typeof u.handle.text?u.handle.text.call(u,e,l)??"":u.handle.text}\n                              </div>`:""}\n                      <div class="w2ui-node-data" style="margin-left: ${l*u.levelPadding+c+u.handle.width}px">\n                            ${a} ${s} ${h}\n                            <div class="w2ui-node-text ${s?"":"no-icon"}" style="${e.style||""}">${n}</div>\n                       </div>\n                    </div>\n                    <div class="w2ui-node-sub" id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}"></div>`,u.flat&&(t=`\n                        <div id="node_${e.id}" class="${o.join(" ")}" data-id="${e.id}" style="${e.hidden?"display: none;":""}"\n                            data-click="click|${e.id}|event"\n                            data-dblclick="dblClick|${e.id}|event"\n                            data-contextmenu="contextMenu|${e.id}|event"\n                            data-mouseEnter="mouseAction|Enter|this|${e.id}|event|tooltip"\n                            data-mouseLeave="mouseAction|Leave|this|${e.id}|event|tooltip"\n                        >\n                            <div class="w2ui-node-data w2ui-node-flat">${s}</div>\n                        </div>\n                        <div class="w2ui-node-sub" id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}"></div>`)}return t}}}}mouseAction(e,t,i,s,l){let o;if(i=this.get(i),null==l&&(o=this.trigger("mouse"+e,{target:i.id,node:i,originalEvent:s})),"tooltip"==l){let s=d.lang("function"==typeof i.text?i.text.call(this,i):i.text)+(i.count||0===i.count?' - <span class="w2ui-node-badge w2ui-node-count">'+i.count+"</span>":"");"Leave"==e&&(s=""),this.tooltip(t,s)}if("handle"==l)if("click"==e){var n=this.handle.onClick;"function"==typeof n&&n.call(this,i,s)}else{let l=this.handle.tooltip;"function"==typeof l&&(l=l.call(this,i,s)),"Leave"==e&&(l=""),this.otherTooltip(t,l)}if("icon"==l)if("click"==e)"function"==typeof(n=this.icon.onClick)&&n.call(this,i,s);else{let l=this.icon.tooltip;"function"==typeof l&&(l=l.call(this,i,s)),"Leave"==e&&(l=""),this.otherTooltip(t,l)}if("badge"==l)if("click"==e)n=this.badge?.onClick,"function"==typeof n&&n.call(this,i,s);else{let l=this.badge?.tooltip;"function"==typeof l&&(l=l.call(this,i,s)),"Leave"==e&&(l=""),this.otherTooltip(t,l)}o?.finish()}tooltip(e,t){e=a(e).find(".w2ui-node-data"),""!==t?g.show({anchor:e.get(0),name:this.name+"_tooltip",html:t,position:"right|left"}):g.hide(this.name+"_tooltip")}otherTooltip(e,t){""!==t?g.show({anchor:e,name:this.name+"_tooltip",html:t,position:"top|bottom"}):g.hide(this.name+"_tooltip")}showPlus(e,t){a(e).find("span:nth-child(1)").css("color",t)}resize(){var e,t=Date.now(),i=this.trigger("resize",{target:this.name});if(!0!==i.isCancelled)return null!=this.box&&(e=a(this.box).get(0).getBoundingClientRect(),a(this.box).css("overflow","hidden"),a(this.box).find(":scope > div").css({width:e.width+"px",height:e.height+"px"})),i.finish(),Date.now()-t}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<a(this.box).find(".w2ui-sidebar-body").length&&this.unmount(),delete r[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}lock(e,t){var i=Array.from(arguments);i.unshift(this.box),d.lock(...i)}unlock(e){d.unlock(this.box,e)}}class x extends l{constructor(e){super(e.name),this.box=null,this.name=null,this.active=null,this.reorder=!1,this.flow="down",this.tooltip="top|left",this.tabs=[],this.routeData={},this.last={},this.right="",this.style="",this.onClick=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onMouseDown=null,this.onMouseUp=null,this.onClose=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.tab_template={id:null,text:null,route:null,hidden:!1,disabled:!1,closable:!1,tooltip:null,style:"",onClick:null,onRefresh:null,onClose:null};var t=e.tabs;delete e.tabs,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.tabs=t,"string"==typeof this.box&&(this.box=a(this.box).get(0)),this.box&&this.render(this.box)}add(e){return this.insert(null,e)}insert(e,t){Array.isArray(t)||(t=[t]);let i=[];return t.forEach((t=>{var s,l;null==t.id?console.log(`ERROR: The parameter "id" is required but not supplied. (obj: ${this.name})`):d.checkUniqueId(t.id,this.tabs,"tabs",this.name)&&(t=Object.assign({},this.tab_template,t),null==e?(this.tabs.push(t),i.push(this.animateInsert(null,t))):(s=this.get(e,!0),l=this.tabs[s].id,this.tabs.splice(s,0,t),i.push(this.animateInsert(l,t))))})),Promise.all(i)}remove(){let e=0;return Array.from(arguments).forEach((t=>{(t=this.get(t))&&(e++,this.tabs.splice(this.get(t.id,!0),1),a(this.box).find(`#tabs_${this.name}_tab_`+d.escapeId(t.id)).remove())})),this.resize(),e}select(e){return this.active!=e&&null!=this.get(e)&&(this.active=e,this.refresh(),!0)}set(e,t){var i=this.get(e,!0);return null!=i&&(d.extend(this.tabs[i],t),this.refresh(e),!0)}get(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.tabs.length;e++)null!=this.tabs[e].id&&i.push(this.tabs[e].id);return i}for(let i=0;i<this.tabs.length;i++)if(this.tabs[i].id==e)return!0===t?i:this.tabs[i];return null}show(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!1!==t.hidden&&(t.hidden=!1,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e),this.resize()}))}),15),e}hide(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!0!==t.hidden&&(t.hidden=!0,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e),this.resize()}))}),15),e}enable(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!1!==t.disabled&&(t.disabled=!1,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e)}))}),15),e}disable(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!0!==t.disabled&&(t.disabled=!0,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e)}))}),15),e}dragMove(e){if(this.last.reordering){let n=this;var t=this.last.moving,i=this.tabs[t.index],s=r(t.index,1),l=r(t.index,-1);if(i=a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(i.id)),0<t.divX&&s){var o=a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(s.id));let h=parseInt(i.get(0).clientWidth),c=parseInt(o.get(0).clientWidth);if(h=h<c?Math.floor(h/3):Math.floor(c/3),c-=h,t.divX>c)return s=this.tabs.indexOf(s),this.tabs.splice(t.index,0,this.tabs.splice(s,1)[0]),t.$tab.before(o.get(0)),t.$tab.css("opacity",0),void Object.assign(this.last.moving,{index:s,divX:-h,x:e.pageX+h,left:t.left+t.divX+h})}if(t.divX<0&&l){o=a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(l.id));let u=parseInt(i.get(0).clientWidth),p=parseInt(o.get(0).clientWidth);u=u<p?Math.floor(u/3):Math.floor(p/3),p-=u,Math.abs(t.divX)>p&&(s=this.tabs.indexOf(l),this.tabs.splice(t.index,0,this.tabs.splice(s,1)[0]),o.before(t.$tab),t.$tab.css("opacity",0),Object.assign(t,{index:s,divX:u,x:e.pageX-u,left:t.left+t.divX-u}))}function r(e,t){e+=t;let i=n.tabs[e];return i&&i.hidden?r(e,t):i}}}mouseAction(e,t,i){var s=this.get(t),l=this.trigger("mouse"+e,{target:t,tab:s,object:s,originalEvent:i});if(!0!==l.isCancelled&&!s?.disabled&&!s?.hidden){switch(e){case"Enter":this.tooltipShow(t);break;case"Leave":this.tooltipHide(t);break;case"Down":this.initReorder(t,i)}l.finish()}}tooltipShow(e){var t=this.get(e);if(e=a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(e)).get(0),null!=this.tooltip&&!t?.disabled&&!this.last.reordering){var i=this.tooltip;let s=t?.tooltip;"function"==typeof s&&(s=s.call(this,t)),g.show({anchor:e,name:this.name+"_tooltip",html:s,position:i})}}tooltipHide(e){null!=this.tooltip&&g.hide(this.name+"_tooltip")}getTabHTML(e){if(e=this.get(e,!0),null==(e=this.tabs[e]))return!1;null==e.text&&null!=e.caption&&(e.text=e.caption),null==e.tooltip&&null!=e.hint&&(e.tooltip=e.hint),null!=e.caption&&console.log("NOTICE: tabs tab.caption property is deprecated, please use tab.text. Tab -> ",e),null!=e.hint&&console.log("NOTICE: tabs tab.hint property is deprecated, please use tab.tooltip. Tab -> ",e);let t=e.text,i=(null==(t="function"==typeof t?t.call(this,e):t)&&(t=""),""),s="";return e.hidden&&(s+="display: none;"),e.disabled&&(s+="opacity: 0.2;"),e.closable&&!e.disabled&&(i=`<div class="w2ui-tab-close w2ui-eaction ${this.active===e.id?"active":""}"\n                data-mousedown="stop" data-mouseup="clickClose|${e.id}|event">\n            </div>`),`\n            <div id="tabs_${this.name}_tab_${e.id}" style="${s} ${e.style}"\n                class="w2ui-tab w2ui-eaction ${this.active===e.id?"active":""} ${e.closable?"closable":""} ${e.class||""}"\n                data-mouseenter="mouseAction|Enter|${e.id}|event]"\n                data-mouseleave="mouseAction|Leave|${e.id}|event]"\n                data-mousedown="mouseAction|Down|${e.id}|event"\n                data-mouseup="mouseAction|Up|${e.id}|event"\n                data-click="click|${e.id}|event"\n               >\n                    ${d.lang(t)+i}\n            </div>`}refresh(e){var t=Date.now(),i=("up"==this.flow?a(this.box).addClass("w2ui-tabs-up"):a(this.box).removeClass("w2ui-tabs-up"),this.trigger("refresh",{target:null!=e?e:this.name,object:this.get(e)}));if(!0!==i.isCancelled){if(null==e)for(let e=0;e<this.tabs.length;e++)this.refresh(this.tabs[e].id);else{var s="#tabs_"+this.name+"_tab_"+d.escapeId(e),l=a(this.box).find(s);e=this.getTabHTML(e),0===l.length?a(this.box).find("#tabs_"+this.name+"_right").before(e):0==a(this.box).find(".tab-animate-insert").length&&l.replace(e),d.bindEvents(a(this.box).find(s+`, ${s} .w2ui-eaction`),this)}return a(this.box).find("#tabs_"+this.name+"_right").html(this.right),i.finish(),Date.now()-t}}render(e){var t=Date.now(),i=("string"==typeof e&&(e=a(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==i.isCancelled)return null!=e&&(this.unmount(),this.box=e),!!this.box&&(e=`\n            <div class="w2ui-tabs-line"></div>\n            <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">\n                <div id="tabs_${this.name}_right" class="w2ui-tabs-right">${this.right}</div>\n            </div>\n            <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll","left"]'></div>\n            <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll","right"]'></div>`,a(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-tabs").html(e),0<a(this.box).length&&(a(this.box)[0].style.cssText+=this.style),d.bindEvents(a(this.box).find(".w2ui-eaction"),this),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),i.finish(),this.refresh(),this.resize(),Date.now()-t)}initReorder(e,t){if(this.reorder){let i,s=this,l=a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(e)),o=this.get(e,!0),n=a(l.get(0).cloneNode(!0));n.attr("id","#tabs_"+this.name+"_tab_ghost"),this.last.moving={index:o,indexFrom:o,$tab:l,$ghost:n,divX:0,left:l.get(0).getBoundingClientRect().left,parentX:a(this.box).get(0).getBoundingClientRect().left,x:t.pageX,opacity:l.css("opacity")},a(document).off(".w2uiTabReorder").on("mousemove.w2uiTabReorder",(function(e){if(!s.last.reordering){if(!0===(i=s.trigger("reorder",{target:s.tabs[o].id,indexFrom:o,tab:s.tabs[o]})).isCancelled)return;g.hide(this.name+"_tooltip"),s.last.reordering=!0,n.addClass("moving"),n.css({"pointer-events":"none",position:"absolute",left:l.get(0).getBoundingClientRect().left}),l.css("opacity",0),a(s.box).find(".w2ui-scroll-wrapper").append(n.get(0)),a(s.box).find(".w2ui-tab-close").hide()}s.last.moving.divX=e.pageX-s.last.moving.x,n.css("left",s.last.moving.left-s.last.moving.parentX+s.last.moving.divX+"px"),s.dragMove(e)})).on("mouseup.w2uiTabReorder",(function(){a(document).off(".w2uiTabReorder"),n.css({transition:"0.1s",left:s.last.moving.$tab.get(0).getBoundingClientRect().left-s.last.moving.parentX}),a(s.box).find(".w2ui-tab-close").show(),n.remove(),l.css({opacity:s.last.moving.opacity}),s.last.reordering&&i.finish({indexTo:s.last.moving.index}),s.last.reordering=!1}))}}scroll(e,t){return new Promise(((i,s)=>{var l=a(this.box).find(".w2ui-scroll-wrapper"),o=l.get(0).scrollLeft,n=l.find(".w2ui-tabs-right").get(0),r=l.parent().get(0).getBoundingClientRect().width,d=o+parseInt(n.offsetLeft)+parseInt(n.clientWidth);switch(e){case"left":{let e=o-r+50;e<=0&&(e=0),l.get(0).scrollTo({top:0,left:e,behavior:t?"atuo":"smooth"});break}case"right":{let e=o+r-50;e>=d-r&&(e=d-r),l.get(0).scrollTo({top:0,left:e,behavior:t?"atuo":"smooth"});break}}setTimeout((()=>{this.resize(),i()}),t?0:350)}))}scrollIntoView(e,t){return new Promise(((i,s)=>{null==e&&(e=this.active),null!=this.get(e)&&(a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(e)).get(0).scrollIntoView({block:"start",inline:"center",behavior:t?"atuo":"smooth"}),setTimeout((()=>{this.resize(),i()}),t?0:500))}))}resize(){var e=Date.now();if(null!=this.box){var t,i,s,l,o=this.trigger("resize",{target:this.name});if(!0!==o.isCancelled)return null!=this.box&&((t=a(this.box)).find(".w2ui-scroll-left, .w2ui-scroll-right").hide(),i=t.find(".w2ui-scroll-wrapper").get(0),l=t.find(".w2ui-tabs-right"),(s=t.get(0).getBoundingClientRect().width)<(l=0<l.length?l[0].offsetLeft+l[0].clientWidth:0))&&(0<i.scrollLeft&&t.find(".w2ui-scroll-left").show(),s<l-i.scrollLeft)&&t.find(".w2ui-scroll-right").show(),o.finish(),Date.now()-e}}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<a(this.box).find("#tabs_"+this.name+"_right").length&&this.unmount(),delete r[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}click(e,t){var i=this.get(e);if(null==i||i.disabled||this.last.reordering)return!1;if(!0!==(e=this.trigger("click",{target:e,tab:i,object:i,originalEvent:t})).isCancelled){if(a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(this.active)).removeClass("active"),this.active=i.id,a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(this.active)).addClass("active"),"string"==typeof i.route){let e=""!==i.route?String("/"+i.route).replace(/\/{2,}/g,"/"):"";var s=d.parseRoute(e);if(0<s.keys.length)for(let t=0;t<s.keys.length;t++)null!=this.routeData[s.keys[t].name]&&(e=e.replace(new RegExp(":"+s.keys[t].name,"g"),this.routeData[s.keys[t].name]));setTimeout((()=>{window.location.hash=e}),1)}e.finish()}}clickClose(e,t){var i=this.get(e);if(null==i||i.disabled)return!1;let s=this.trigger("close",{target:e,object:i,tab:i,originalEvent:t});!0!==s.isCancelled&&(this.animateClose(e).then((()=>{this.remove(e),s.finish(),this.refresh()})),t)&&t.stopPropagation()}animateClose(e){return new Promise(((t,i)=>{var s=a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(e)),l=parseInt(s.get(0).clientWidth||0);let o=s.replace(`<div class="tab-animate-close" style="display: inline-block; flex-shrink: 0; width: ${l}px; transition: width 0.25s"></div>`);setTimeout((()=>{o.css({width:"0px"})}),1),setTimeout((()=>{o.remove(),this.resize(),t()}),500)}))}animateInsert(e,t){return new Promise(((i,s)=>{let l=a(this.box).find("#tabs_"+this.name+"_tab_"+d.escapeId(e)),o=a.html(this.getTabHTML(t.id));if(0==l.length)(l=a(this.box).find("#tabs_tabs_right")).before(o),this.resize();else{o.css({opacity:0}),a(this.box).find("#tabs_tabs_right").before(o.get(0));let e=a(this.box).find("#"+o.attr("id")).get(0)?.clientWidth??0,s=a.html('<div class="tab-animate-insert" style="flex-shrink: 0; width: 0; transition: width 0.25s"></div>');l.before(s),o.hide(),s.before(o[0]),setTimeout((()=>{s.css({width:e+"px"})}),1),setTimeout((()=>{s.remove(),o.css({opacity:1}).show(),this.refresh(t.id),this.resize(),i()}),500)}}))}}let k=["top","left","main","preview","right","bottom"];class C extends l{constructor(e){super(e.name),this.box=null,this.name=null,this.panels=[],this.last={},this.padding=1,this.resizer=4,this.style="",this.onShow=null,this.onHide=null,this.onResizing=null,this.onResizerClick=null,this.onRender=null,this.onRefresh=null,this.onChange=null,this.onResize=null,this.onDestroy=null,this.panel_template={type:null,title:"",size:100,minSize:20,maxSize:!1,hidden:!1,resizable:!1,overflow:"auto",style:"",html:"",tabs:null,toolbar:null,width:null,height:null,show:{toolbar:!1,tabs:!1},removed:null,onRefresh:null,onShow:null,onHide:null},Object.assign(this,e),Array.isArray(this.panels)||(this.panels=[]),this.panels.forEach(((e,t)=>{var i,s,l;this.panels[t]=d.extend({},this.panel_template,e),(d.isPlainObject(e.tabs)||Array.isArray(e.tabs))&&function(e,t,i){var s=e.get(t);if(null!=s&&null==i&&(i=s.tabs),null!=s&&null!=i){Array.isArray(i)&&(i={tabs:i});var l=e.name+"_"+t+"_tabs";r[l]&&r[l].destroy(),s.tabs=new x(d.extend({},i,{owner:e,name:e.name+"_"+t+"_tabs"})),s.show.tabs=!0}}(this,e.type),(d.isPlainObject(e.toolbar)||Array.isArray(e.toolbar))&&(t=this,e=e.type,i=void 0,null!=(s=t.get(e))&&null==i&&(i=s.toolbar),null!=s)&&null!=i&&(Array.isArray(i)&&(i={items:i}),l=t.name+"_"+e+"_toolbar",r[l]&&r[l].destroy(),s.toolbar=new y(d.extend({},i,{owner:t,name:t.name+"_"+e+"_toolbar"})),s.show.toolbar=!0)})),k.forEach((e=>{null==this.get(e)&&this.panels.push(d.extend({},this.panel_template,{type:e,hidden:"main"!==e,size:50}))})),"string"==typeof this.box&&(this.box=a(this.box).get(0)),this.box&&this.render(this.box)}html(e,t,i){let s=this.get(e);var l={panel:e,html:s.html,error:!1,cancelled:!1,removed(e){"function"==typeof e&&(s.removed=e)}};if("function"==typeof s.removed&&(s.removed({panel:e,html:s.html,html_new:t,transition:i||"none"}),s.removed=null),"css"==e)a(this.box).find("#layout_"+this.name+"_panel_css").html("<style>"+t+"</style>"),l.status=!0;else if(null==s)console.log("ERROR: incorrect panel name. Panel name can be main, left, right, top, bottom, preview or css"),l.error=!0;else if(null!=t){var o=this.trigger("change",{target:e,panel:s,html_new:t,transition:i});if(!0===o.isCancelled)l.cancelled=!0;else{let l="#layout_"+this.name+"_panel_"+s.type;var n=a(this.box).find(l+'> [data-role="panel-content"]');let r=0;if(0<n.length&&(a(this.box).find(l).get(0).scrollTop=0,r=a(n).css("top")),"function"==typeof s.html.unmount&&s.html.unmount(),n.addClass("w2ui-panel-content"),n.removeAttr("style"),this.resizeBoxes(e),""===s.html)s.html=t,this.refresh(e);else if(s.html=t,!s.hidden)if(null!=i&&""!==i){a(this.box).addClass("animating");let o=a(this.box).find(l+'> [data-role="panel-content"]'),n=(o.after('<div class="w2ui-panel-content new-panel" data-role="panel-content" style="'+o[0].style.cssText+'"></div>'),a(this.box).find(l+'> [data-role="panel-content"].new-panel'));o.css("top",r),n.css("top",r),"object"==typeof t?(t.box=n[0],t.render()):n.hide().html(t),d.transition(o[0],n[0],i,(()=>{o.remove(),n.removeClass("new-panel"),n.css("overflow",s.overflow),a(a(this.box).find(l+'> [data-role="panel-content"]').get(1)).remove(),a(this.box).removeClass("animating"),this.refresh(e)}))}else this.refresh(e);o.finish()}}return l}message(e,t){var i=this.get(e);let s=a(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow");return s.css("overflow","hidden"),(i=d.message({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t))&&i.self.on("close:after",(()=>{s.css("overflow",l)})),i}confirm(e,t){var i=this.get(e);let s=a(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow");return s.css("overflow","hidden"),(i=d.confirm({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t))&&i.self.on("close:after",(()=>{s.css("overflow",l)})),i}load(e,t,i){return new Promise(((s,l)=>{"css"!=e&&null==this.get(e)||null==t?l():fetch(t).then((e=>e.text())).then((t=>{this.resize(),s(this.html(e,t,i))}))}))}sizeTo(e,t,i){return null!=this.get(e)&&(a(this.box).find(":scope > div > .w2ui-panel").css("transition",!0!==i?".2s":"0s"),setTimeout((()=>{this.set(e,{size:t})}),1),setTimeout((()=>{a(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),this.resize()}),300),!0)}show(e,t){let i=this.trigger("show",{target:e,thisect:this.get(e),immediate:t});var s;if(!0!==i.isCancelled)return null!=(s=this.get(e))&&(!(s.hidden=!1)===t?(a(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"1"}),i.finish(),this.resize()):(a(this.box).addClass("animating"),a(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),a(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),setTimeout((()=>{this.resize()}),1),setTimeout((()=>{a(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"1"})}),250),setTimeout((()=>{a(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),a(this.box).removeClass("animating"),i.finish(),this.resize()}),300)),!0)}hide(e,t){let i=this.trigger("hide",{target:e,object:this.get(e),immediate:t});var s;if(!0!==i.isCancelled)return null!=(s=this.get(e))&&((s.hidden=!0)===t?(a(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),i.finish(),this.resize()):(a(this.box).addClass("animating"),a(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),a(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),setTimeout((()=>{this.resize()}),1),setTimeout((()=>{a(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),a(this.box).removeClass("animating"),i.finish(),this.resize()}),300)),!0)}toggle(e,t){var i=this.get(e);return null!=i&&(i.hidden?this.show(e,t):this.hide(e,t))}set(e,t){var i=this.get(e,!0);return null!=i&&(d.extend(this.panels[i],t),null==t.html&&null==t.resizable||this.refresh(e),this.resize(),!0)}get(e,t){for(let i=0;i<this.panels.length;i++)if(this.panels[i].type==e)return!0===t?i:this.panels[i];return null}el(e){return 1!=(e=a(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-content"]')).length?null:e[0]}hideToolbar(e){var t=this.get(e);t&&(t.show.toolbar=!1,a(this.box).find(`#layout_${this.name}_panel_${e} > [data-role="panel-toolbar"]`).hide(),this.resize())}showToolbar(e){var t=this.get(e);t&&(t.show.toolbar=!0,a(this.box).find(`#layout_${this.name}_panel_${e} > [data-role="panel-toolbar"]`).show(),this.resize())}toggleToolbar(e){var t=this.get(e);t&&(t.show.toolbar?this.hideToolbar(e):this.showToolbar(e))}assignToolbar(e,t){"string"==typeof t&&null!=r[t]&&(t=r[t]);var i=this.get(e),s=(i.toolbar=t,a(this.box).find(e+'> [data-role="panel-toolbar"]'));null!=i.toolbar?(s.attr("name")!=i.toolbar.name?i.toolbar.render(s.get(0)):null!=i.toolbar&&i.toolbar.refresh(),(t.owner=this).showToolbar(e),this.refresh(e)):(s.html(""),this.hideToolbar(e))}hideTabs(e){var t=this.get(e);t&&(t.show.tabs=!1,a(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-tabs"]').hide(),this.resize())}showTabs(e){var t=this.get(e);t&&(t.show.tabs=!0,a(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-tabs"]').show(),this.resize())}toggleTabs(e){var t=this.get(e);t&&(t.show.tabs?this.hideTabs(e):this.showTabs(e))}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=a(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled){if(null!=e&&(this.unmount(),this.box=e),!this.box)return!1;a(this.box).attr("name",this.name).addClass("w2ui-layout").html("<div></div>"),0<a(this.box).length&&(a(this.box)[0].style.cssText+=this.style);for(let e=0;e<k.length;e++){var l='<div id="layout_'+this.name+"_panel_"+k[e]+'" class="w2ui-panel">    <div class="w2ui-panel-title"></div>    <div class="w2ui-panel-tabs" data-role="panel-tabs"></div>    <div class="w2ui-panel-toolbar" data-role="panel-toolbar"></div>    <div class="w2ui-panel-content" data-role="panel-content"></div></div><div id="layout_'+this.name+"_resizer_"+k[e]+'" class="w2ui-resizer"></div>';a(this.box).find(":scope > div").append(l)}return a(this.box).find(":scope > div").append('<div id="layout_'+this.name+'_panel_css" style="position: absolute; top: 10000px;"></div>'),this.refresh(),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),s.finish(),setTimeout((()=>{i.last.events={resizeStart:o,mouseMove:r,mouseUp:n},this.resize()}),0),Date.now()-t}function o(e,t){i.box&&(t=t||window.event,a(document).off("mousemove",i.last.events.mouseMove).on("mousemove",i.last.events.mouseMove),a(document).off("mouseup",i.last.events.mouseUp).on("mouseup",i.last.events.mouseUp),i.last.resize={type:e,x:t.screenX,y:t.screenY,diff_x:0,diff_y:0,value:0},k.forEach((e=>{var t=a(i.el(e)).find(".w2ui-lock");0<t.length?t.data("locked","yes"):i.lock(e,{opacity:0})})),t=a(i.box).find("#layout_"+i.name+"_resizer_"+e).get(0),"left"!=e&&"right"!=e||(i.last.resize.value=parseInt(t.style.left)),"top"!=e&&"preview"!=e&&"bottom"!=e||(i.last.resize.value=parseInt(t.style.top)))}function n(e){if(i.box&&(e=e||window.event,a(document).off("mousemove",i.last.events.mouseMove),a(document).off("mouseup",i.last.events.mouseUp),null!=i.last.resize)){if(k.forEach((e=>{var t=a(i.el(e)).find(".w2ui-lock");"yes"==t.data("locked")?t.removeData("locked"):i.unlock(e)})),0!==i.last.diff_x||0!==i.last.resize.diff_y){var t=i.get("top"),s=i.get("bottom"),l=i.get(i.last.resize.type),o=(e=d.getSize(a(i.box),"width"),d.getSize(a(i.box),"height")),n=String(l.size);let r,h;switch(i.last.resize.type){case"top":r=parseInt(l.sizeCalculated)+i.last.resize.diff_y,h=0;break;case"bottom":r=parseInt(l.sizeCalculated)-i.last.resize.diff_y,h=0;break;case"preview":r=parseInt(l.sizeCalculated)-i.last.resize.diff_y,h=(t&&!t.hidden?t.sizeCalculated:0)+(s&&!s.hidden?s.sizeCalculated:0);break;case"left":r=parseInt(l.sizeCalculated)+i.last.resize.diff_x,h=0;break;case"right":r=parseInt(l.sizeCalculated)-i.last.resize.diff_x,h=0}"%"==n.substr(n.length-1)?l.size=Math.floor(100*r/("left"==l.type||"right"==l.type?e:o-h)*100)/100+"%":"-"==String(l.size).substr(0,1)?l.size=parseInt(l.size)-l.sizeCalculated+r:l.size=r,i.resize()}a(i.box).find("#layout_"+i.name+"_resizer_"+i.last.resize.type).removeClass("active"),delete i.last.resize}}function r(e){if(i.box&&(e=e||window.event,null!=i.last.resize)){var t=i.get(i.last.resize.type),s=i.last.resize,l=i.trigger("resizing",{target:i.name,object:t,originalEvent:e,panel:s?s.type:"all",diff_x:s?s.diff_x:0,diff_y:s?s.diff_y:0});if(!0!==l.isCancelled){var o=a(i.box).find("#layout_"+i.name+"_resizer_"+s.type);let r=e.screenX-s.x,d=e.screenY-s.y;var n=i.get("main");switch(o.hasClass("active")||o.addClass("active"),s.type){case"left":t.minSize-r>t.width&&(r=t.minSize-t.width),t.maxSize&&t.width+r>t.maxSize&&(r=t.maxSize-t.width),n.minSize+r>n.width&&(r=n.width-n.minSize);break;case"right":t.minSize+r>t.width&&(r=t.width-t.minSize),t.maxSize&&t.width-r>t.maxSize&&(r=t.width-t.maxSize),n.minSize-r>n.width&&(r=n.minSize-n.width);break;case"top":t.minSize-d>t.height&&(d=t.minSize-t.height),t.maxSize&&t.height+d>t.maxSize&&(d=t.maxSize-t.height),n.minSize+d>n.height&&(d=n.height-n.minSize);break;case"preview":case"bottom":t.minSize+d>t.height&&(d=t.height-t.minSize),t.maxSize&&t.height-d>t.maxSize&&(d=t.height-t.maxSize),n.minSize-d>n.height&&(d=n.minSize-n.height)}switch(s.diff_x=r,s.diff_y=d,s.type){case"top":case"preview":case"bottom":(s.diff_x=0)<o.length&&(o[0].style.top=s.value+s.diff_y+"px");break;case"left":case"right":(s.diff_y=0)<o.length&&(o[0].style.left=s.value+s.diff_x+"px")}l.finish()}}}}unmount(){super.unmount(),this.panels.forEach((e=>{e.tabs?.unmount?.(),e.toolbar?.unmount?.()})),this.last.observeResize?.disconnect()}destroy(){var e=this.trigger("destroy",{target:this.name});if(!0!==e.isCancelled)return null!=r[this.name]&&(this.panels.forEach((e=>{e.tabs?.destroy?.(),e.toolbar?.destroy?.()})),0<a(this.box).find("#layout_"+this.name+"_panel_main").length&&this.unmount(),delete r[this.name],e.finish(),this.last.events&&this.last.events.resize&&a(window).off("resize",this.last.events.resize),!0)}refresh(e){let t=this;null==e&&(e=null);var i=Date.now(),s=t.trigger("refresh",{target:null!=e?e:t.name,object:t.get(e)});if(!0!==s.isCancelled){if("string"==typeof e){let i=t.get(e);if(null==i)return;let s="#layout_"+t.name+"_panel_"+i.type;e="#layout_"+t.name+"_resizer_"+i.type,a(t.box).find(s).css({display:i.hidden?"none":"block"}),i.resizable?a(t.box).find(e).show():a(t.box).find(e).hide(),"object"==typeof i.html&&"function"==typeof i.html.render?(i.html.box=a(t.box).find(s+'> [data-role="panel-content"]')[0],setTimeout((()=>{0<a(t.box).find(s+'> [data-role="panel-content"]').length&&(a(t.box).find(s+'> [data-role="panel-content"]').removeClass().removeAttr("name").addClass("w2ui-panel-content").css("overflow",i.overflow)[0].style.cssText+=";"+i.style),i.html&&"function"==typeof i.html.render&&i.html.render()}),1)):0<a(t.box).find(s+'> [data-role="panel-content"]').length&&(a(t.box).find(s+'> [data-role="panel-content"]').removeClass().removeAttr("name").addClass("w2ui-panel-content").html(i.html).css("overflow",i.overflow)[0].style.cssText+=";"+i.style);let l=a(t.box).find(s+'> [data-role="panel-tabs"]');i.show.tabs?(l.attr("name")!=i.tabs.name&&null!=i.tabs?i.tabs.render(l.get(0)):i.tabs.refresh(),l.addClass("w2ui-panel-tabs")):l.html("").removeAttr("name").removeClass("w2ui-tabs").hide(),l=a(t.box).find(s+'> [data-role="panel-toolbar"]'),i.show.toolbar?(l.attr("name")!=i.toolbar.name&&null!=i.toolbar?i.toolbar.render(l.get(0)):i.toolbar.refresh(),l.addClass("w2ui-panel-toolbar")):l.html("").removeAttr("name").removeClass("w2ui-toolbar").hide(),l=a(t.box).find(s+"> .w2ui-panel-title"),i.title?l.html(i.title).show():l.html("").hide()}else{if(0===a(t.box).find("#layout_"+t.name+"_panel_main").length)return void t.render();t.resize();for(let e=0;e<this.panels.length;e++)t.refresh(this.panels[e].type)}return s.finish(),Date.now()-i}}resize(){if(!this.box)return!1;var e=Date.now();let t=this.last.resize;var i=this.trigger("resize",{target:this.name,panel:t?t.type:"all",diff_x:t?t.diff_x:0,diff_y:t?t.diff_y:0});if(!0!==i.isCancelled){this.padding<0&&(this.padding=0);var s=d.getSize(a(this.box),"width"),l=d.getSize(a(this.box),"height");let v=this;var o=this.get("main"),n=this.get("preview"),h=this.get("left"),c=this.get("right"),u=this.get("top"),p=this.get("bottom"),m=null!=n&&!0!==n.hidden,g=null!=h&&!0!==h.hidden,f=null!=c&&!0!==c.hidden,w=null!=u&&!0!==u.hidden,b=null!=p&&!0!==p.hidden;let x,C,_,E;for(let e=0;e<k.length;e++)if("main"!==k[e]&&(t=this.get(k[e]))){var y=String(t.size||0);if("%"==y.substr(y.length-1)){let e=l;"preview"==t.type&&(e=e-(u&&!u.hidden?u.sizeCalculated:0)-(p&&!p.hidden?p.sizeCalculated:0)),t.sizeCalculated=parseInt(("left"==t.type||"right"==t.type?s:e)*parseFloat(t.size)/100)}else t.sizeCalculated=parseInt(t.size);t.sizeCalculated=Math.max(t.sizeCalculated,parseInt(t.minSize))}return"-"==String(c.size).substr(0,1)&&(g&&"-"==String(h.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):c.sizeCalculated=s-(g?h.sizeCalculated:0)+parseInt(c.size)),"-"==String(h.size).substr(0,1)&&(f&&"-"==String(c.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):h.sizeCalculated=s-(f?c.sizeCalculated:0)+parseInt(h.size)),null!=u&&!0!==u.hidden?(x=0,C=0,_=s,E=u.sizeCalculated,a(this.box).find("#layout_"+this.name+"_panel_top").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px"}),u.width=_,u.height=E,u.resizable&&(C=u.sizeCalculated-(0===this.padding?this.resizer:0),E=this.resizer>this.padding?this.resizer:this.padding,a(this.box).find("#layout_"+this.name+"_resizer_top").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=v.trigger("resizerClick",{target:"top",originalEvent:e});if(!0!==t.isCancelled)return r[v.name].last.events.resizeStart("top",e),t.finish(),!1})))):(a(this.box).find("#layout_"+this.name+"_panel_top").hide(),a(this.box).find("#layout_"+this.name+"_resizer_top").hide()),null!=h&&!0!==h.hidden?(x=0,C=0+(w?u.sizeCalculated+this.padding:0),_=h.sizeCalculated,E=l-(w?u.sizeCalculated+this.padding:0)-(b?p.sizeCalculated+this.padding:0),a(this.box).find("#layout_"+this.name+"_panel_left").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px"}),h.width=_,h.height=E,h.resizable&&(x=h.sizeCalculated-(0===this.padding?this.resizer:0),_=this.resizer>this.padding?this.resizer:this.padding,a(this.box).find("#layout_"+this.name+"_resizer_left").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=v.trigger("resizerClick",{target:"left",originalEvent:e});if(!0!==t.isCancelled)return r[v.name].last.events.resizeStart("left",e),t.finish(),!1})))):(a(this.box).find("#layout_"+this.name+"_panel_left").hide(),a(this.box).find("#layout_"+this.name+"_resizer_left").hide()),null!=c&&!0!==c.hidden?(x=s-c.sizeCalculated,C=0+(w?u.sizeCalculated+this.padding:0),_=c.sizeCalculated,E=l-(w?u.sizeCalculated+this.padding:0)-(b?p.sizeCalculated+this.padding:0),a(this.box).find("#layout_"+this.name+"_panel_right").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px"}),c.width=_,c.height=E,c.resizable&&(x-=this.padding,_=this.resizer>this.padding?this.resizer:this.padding,a(this.box).find("#layout_"+this.name+"_resizer_right").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=v.trigger("resizerClick",{target:"right",originalEvent:e});if(!0!==t.isCancelled)return r[v.name].last.events.resizeStart("right",e),t.finish(),!1})))):(a(this.box).find("#layout_"+this.name+"_panel_right").hide(),a(this.box).find("#layout_"+this.name+"_resizer_right").hide()),null!=p&&!0!==p.hidden?(x=0,C=l-p.sizeCalculated,_=s,E=p.sizeCalculated,a(this.box).find("#layout_"+this.name+"_panel_bottom").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px"}),p.width=_,p.height=E,p.resizable&&(C-=0===this.padding?0:this.padding,E=this.resizer>this.padding?this.resizer:this.padding,a(this.box).find("#layout_"+this.name+"_resizer_bottom").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=v.trigger("resizerClick",{target:"bottom",originalEvent:e});if(!0!==t.isCancelled)return r[v.name].last.events.resizeStart("bottom",e),t.finish(),!1})))):(a(this.box).find("#layout_"+this.name+"_panel_bottom").hide(),a(this.box).find("#layout_"+this.name+"_resizer_bottom").hide()),x=0+(g?h.sizeCalculated+this.padding:0),C=0+(w?u.sizeCalculated+this.padding:0),_=s-(g?h.sizeCalculated+this.padding:0)-(f?c.sizeCalculated+this.padding:0),E=l-(w?u.sizeCalculated+this.padding:0)-(b?p.sizeCalculated+this.padding:0)-(m?n.sizeCalculated+this.padding:0),a(this.box).find("#layout_"+this.name+"_panel_main").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px"}),o.width=_,o.height=E,null!=n&&!0!==n.hidden?(x=0+(g?h.sizeCalculated+this.padding:0),C=l-(b?p.sizeCalculated+this.padding:0)-n.sizeCalculated,_=s-(g?h.sizeCalculated+this.padding:0)-(f?c.sizeCalculated+this.padding:0),E=n.sizeCalculated,a(this.box).find("#layout_"+this.name+"_panel_preview").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px"}),n.width=_,n.height=E,n.resizable&&(C-=0===this.padding?0:this.padding,E=this.resizer>this.padding?this.resizer:this.padding,a(this.box).find("#layout_"+this.name+"_resizer_preview").css({display:"block",left:x+"px",top:C+"px",width:_+"px",height:E+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=v.trigger("resizerClick",{target:"preview",originalEvent:e});if(!0!==t.isCancelled)return r[v.name].last.events.resizeStart("preview",e),t.finish(),!1})))):(a(this.box).find("#layout_"+this.name+"_panel_preview").hide(),a(this.box).find("#layout_"+this.name+"_resizer_preview").hide()),this.resizeBoxes(),i.finish(),Date.now()-e}}resizeBoxes(e){let t=k;(t=e||"string"!=typeof e?k:[e]).forEach(((e,t)=>{var i;t=this.get(k[t]),e=`#layout_${this.name}_panel_${e} > `;let s=0;t&&(t.title&&(i=a(this.box).find(e+".w2ui-panel-title").css({top:s+"px",display:"block"}),s+=d.getSize(i,"height")),t.show.tabs&&(i=a(this.box).find(e+'[data-role="panel-tabs"]').css({top:s+"px",display:"block"}),s+=d.getSize(i,"height")),t.show.toolbar)&&(i=a(this.box).find(e+'[data-role="panel-toolbar"]').css({top:s+"px",display:"block"}),s+=d.getSize(i,"height")),a(this.box).find(e+'[data-role="panel-content"]').css({display:"block",top:s+"px"})}))}lock(e,t,i){var s;-1==k.indexOf(e)?console.log("ERROR: First parameter needs to be the a valid panel name."):((s=Array.from(arguments))[0]="#layout_"+this.name+"_panel_"+e,d.lock(...s))}unlock(e,t){-1==k.indexOf(e)?console.log("ERROR: First parameter needs to be the a valid panel name."):(e="#layout_"+this.name+"_panel_"+e,d.unlock(e,t))}}class _ extends l{constructor(e){if(super(e.name),this.name=null,this.box=null,this.columns=[],this.columnGroups=[],this.records=[],this.summary=[],this.searches=[],this.toolbar={},this.ranges=[],this.contextMenu=[],this.searchMap={},this.searchData=[],this.sortMap={},this.sortData=[],this.savedSearches=[],this.defaultSearches=[],this.total=0,this.recid=null,this.last={field:"",label:"",logic:"AND",search:"",searchIds:[],selection:{indexes:[],columns:{}},saved_sel:null,multi:!1,fetch:{action:"",offset:null,start:0,response:0,options:null,controller:null,loaded:!1,hasMore:!1},vscroll:{scrollTop:0,scrollLeft:0,recIndStart:null,recIndEnd:null,colIndStart:0,colIndEnd:0,pull_more:!1,pull_refresh:!0,show_extra:0},sel_ind:null,sel_col:null,sel_type:null,sel_recid:null,idCache:{},move:null,cancelClick:null,inEditMode:!1,_edit:null,kbd_timer:null,marker_timer:null,click_time:null,click_recid:null,bubbleEl:null,colResizing:!1,tmp:null,copy_event:null,userSelect:"",columnDrag:!1,state:null,toolbar_height:0},this.header="",this.url="",this.limit=100,this.offset=0,this.postData={},this.routeData={},this.httpHeaders={},this.show={header:!1,toolbar:!1,footer:!1,columnMenu:!0,columnHeaders:!0,lineNumbers:!1,expandColumn:!1,selectColumn:!1,emptyRecords:!0,toolbarReload:!0,toolbarColumns:!1,toolbarSearch:!0,toolbarAdd:!1,toolbarEdit:!1,toolbarDelete:!1,toolbarSave:!1,searchAll:!0,searchLogic:!0,searchHiddenMsg:!1,searchSave:!0,statusRange:!0,statusBuffered:!1,statusRecordID:!0,statusSelection:!0,statusResponse:!0,statusSort:!1,statusSearch:!1,recordTitles:!1,selectionBorder:!0,selectionResizer:!0,skipRecords:!0,saveRestoreState:!0},this.stateId=null,this.hasFocus=!1,this.autoLoad=!0,this.fixedBody=!0,this.recordHeight=32,this.lineNumberWidth=34,this.keyboard=!0,this.selectType="row",this.liveSearch=!1,this.multiSearch=!0,this.multiSelect=!0,this.multiSort=!0,this.reorderColumns=!1,this.reorderRows=!1,this.showExtraOnSearch=0,this.markSearch=!0,this.columnTooltip="top|bottom",this.disableCVS=!1,this.nestedFields=!0,this.vs_start=150,this.vs_extra=5,this.style="",this.tabIndex=null,this.dataType=null,this.parser=null,this.advanceOnEdit=!0,this.useLocalStorage=!0,this.colTemplate={text:"",field:"",size:null,min:20,max:null,gridMinWidth:null,sizeCorrected:null,sizeCalculated:null,sizeOriginal:null,sizeType:null,hidden:!1,sortable:!1,sortMode:null,searchable:!1,resizable:!0,hideable:!0,autoResize:null,attr:"",style:"",render:null,title:null,tooltip:null,editable:{},frozen:!1,info:null,clipboardCopy:!1},this.stateColProps={text:!1,field:!0,size:!0,min:!1,max:!1,gridMinWidth:!1,sizeCorrected:!1,sizeCalculated:!0,sizeOriginal:!0,sizeType:!0,hidden:!0,sortable:!1,sortMode:!0,searchable:!1,resizable:!1,hideable:!1,autoResize:!1,attr:!1,style:!1,render:!1,title:!1,tooltip:!1,editable:!1,frozen:!0,info:!1,clipboardCopy:!1},this.msgDelete="Are you sure you want to delete ${count} ${records}?",this.msgNotJSON="Returned data is not in valid JSON format.",this.msgHTTPError="HTTP error. See console for more details.",this.msgServerError="Server error",this.msgRefresh="Refreshing...",this.msgNeedReload="Your remote data source record count has changed, reloading from the first record.",this.msgEmpty="",this.buttons={reload:{type:"button",id:"w2ui-reload",icon:"w2ui-icon-reload",tooltip:"Reload data in the list"},columns:{type:"menu-check",id:"w2ui-column-on-off",icon:"w2ui-icon-columns",tooltip:"Show/hide columns",overlay:{align:"none"}},search:{type:"html",id:"w2ui-search",html:'<div class="w2ui-icon w2ui-icon-search w2ui-search-down w2ui-action" data-click="searchShowFields"></div>'},add:{type:"button",id:"w2ui-add",text:"Add New",tooltip:"Add new record",icon:"w2ui-icon-plus"},edit:{type:"button",id:"w2ui-edit",text:"Edit",tooltip:"Edit selected record",icon:"w2ui-icon-pencil",batch:1,disabled:!0},delete:{type:"button",id:"w2ui-delete",text:"Delete",tooltip:"Delete selected records",icon:"w2ui-icon-cross",batch:!0,disabled:!0},save:{type:"button",id:"w2ui-save",text:"Save",tooltip:"Save changed records",icon:"w2ui-icon-check"}},this.operators={text:["is","begins","contains","ends"],number:["=","between",">","<",">=","<="],date:["is",{oper:"less",text:"before"},{oper:"more",text:"since"},"between"],list:["is"],hex:["is","between"],color:["is","begins","contains","ends"],enum:["in","not in"]},this.defaultOperator={text:"begins",number:"=",date:"is",list:"is",enum:"in",hex:"begins",color:"begins"},this.operatorsMap={text:"text",int:"number",float:"number",money:"number",currency:"number",percent:"number",hex:"hex",alphanumeric:"text",color:"color",date:"date",time:"date",datetime:"date",list:"list",combo:"text",enum:"enum",file:"enum",select:"list",radio:"list",checkbox:"list",toggle:"list"},this.onAdd=null,this.onEdit=null,this.onRequest=null,this.onLoad=null,this.onDelete=null,this.onSave=null,this.onSelect=null,this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onContextMenuClick=null,this.onColumnClick=null,this.onColumnDblClick=null,this.onColumnContextMenu=null,this.onColumnResize=null,this.onColumnAutoResize=null,this.onSort=null,this.onSearch=null,this.onSearchOpen=null,this.onChange=null,this.onRestore=null,this.onExpand=null,this.onCollapse=null,this.onError=null,this.onKeydown=null,this.onToolbar=null,this.onColumnOnOff=null,this.onCopy=null,this.onPaste=null,this.onSelectionExtend=null,this.onEditField=null,this.onRender=null,this.onRefresh=null,this.onReload=null,this.onResize=null,this.onDestroy=null,this.onStateSave=null,this.onStateRestore=null,this.onFocus=null,this.onBlur=null,this.onReorderRow=null,this.onSearchSave=null,this.onSearchRemove=null,this.onSearchSelect=null,this.onColumnSelect=null,this.onColumnDragStart=null,this.onColumnDragEnd=null,this.onResizerDblClick=null,this.onMouseEnter=null,this.onMouseLeave=null,d.extend(this,e),Array.isArray(this.records)){let e=[];this.records.forEach(((t,i)=>{null!=t[this.recid]&&(t.recid=t[this.recid]),null==t.recid&&console.log("ERROR: Cannot add records without recid. (obj: "+this.name+")"),!0===t.w2ui?.summary&&(this.summary.push(t),e.push(i))})),e.sort();for(let t=e.length-1;0<=t;t--)this.records.splice(e[t],1)}Array.isArray(this.columns)&&this.columns.forEach(((e,t)=>{if(e=d.extend({},this.colTemplate,e),null!=(t=(this.columns[t]=e).searchable)&&!1!==t&&null==this.getSearch(e.field))if(d.isPlainObject(t))this.addSearch(d.extend({field:e.field,label:e.text,type:"text"},t));else{let t=e.searchable,i="";!0===e.searchable&&(t="text",i='size="20"'),this.addSearch({field:e.field,label:e.text,type:t,attr:i})}})),Array.isArray(this.defaultSearches)&&this.defaultSearches.forEach(((e,t)=>{e.id="default-"+t,e.icon??="w2ui-icon-search"})),e=this.cache("searches"),Array.isArray(e)&&e.forEach((e=>{this.savedSearches.push({id:e.id??"none",text:e.text??"none",icon:"w2ui-icon-search",remove:!0,logic:e.logic??"AND",data:e.data??[]})})),this.initToolbar(),"string"==typeof this.box&&(this.box=a(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){Array.isArray(e)||(e=[e]);let i=0;for(let l=0;l<e.length;l++){var s=e[l];null!=s[this.recid]&&(s.recid=s[this.recid]),null==s.recid?console.log("ERROR: Cannot add record without recid. (obj: "+this.name+")"):(!0===s.w2ui?.summary?t?this.summary.unshift(s):this.summary.push(s):t?this.records.unshift(s):this.records.push(s),i++)}var l,o;return(this.url?.get??this.url)||(this.total=this.records.length,this.localSort(!1,!0),this.localSearch(),o=(l=this.records.length-e.length)+e.length,this.last.vscroll.recIndStart<=o&&this.last.vscroll.recIndEnd>=l)?this.refresh():a(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right .w2ui-total").html(d.formatNumber(this.total)),i}find(e,t,i){var s,l=[];let o=!1;for(s in e=null==e?{}:e)-1!=String(s).indexOf(".")&&(o=!0);var n=i?this.last.vscroll.recIndStart:0;let a=i?this.last.vscroll.recIndEnd+1:this.records.length;a>this.records.length&&(a=this.records.length);for(let i=n;i<a;i++){let s=!0;for(var r in e){let t=this.records[i][r];o&&-1!=String(r).indexOf(".")&&(t=this.parseField(this.records[i],r)),"not-null"==e[r]?null!=t&&""!==t||(s=!1):e[r]!=t&&(s=!1)}s&&!0!==t&&l.push(this.records[i].recid),s&&!0===t&&l.push(i)}return l}set(e,t,i){if("object"==typeof e&&null!==e&&(i=t,t=e,e=null),null==e){for(let e=0;e<this.records.length;e++)d.extend(this.records[e],t);!0!==i&&this.refresh()}else{var s=this.get(e,!0);if(null==s)return!1;this.records[s]?.recid!=e?d.extend(this.summary[s],t):d.extend(this.records[s],t),!0!==i&&this.refreshRow(e,s)}return!0}replace(e,t,i){var s=this.get(e,!0);return null!=s&&(this.records[s]?.recid!=e?this.summary[s]=t:this.records[s]=t,!0!==i&&this.refreshRow(e,s),!0)}get(e,t){if(Array.isArray(e)){var i=[];for(let l=0;l<e.length;l++){var s=this.get(e[l],t);null!==s&&i.push(s)}return i}{let i=this.last.idCache;i||(this.last.idCache=i={});var l=i[e];if("number"==typeof l){if(0<=l&&l<this.records.length&&this.records[l].recid==e)return!0===t?l:this.records[l];if(0<=(l=~l)&&l<this.summary.length&&this.summary[l].recid==e)return!0===t?l:this.summary[l];this.last.idCache=i={}}for(let s=0;s<this.records.length;s++)if(this.records[s].recid==e)return i[e]=s,!0===t?s:this.records[s];for(let s=0;s<this.summary.length;s++)if(this.summary[s].recid==e)return i[e]=~s,!0===t?s:this.summary[s];return null}}getFirst(e){if(0==this.records.length)return null;let t=this.records[0];var i=this.last.searchIds;return 0<this.searchData.length?Array.isArray(i)&&0<i.length?this.records[i[e||0]]:null:t}remove(){let e=0;for(let t=0;t<arguments.length;t++){for(let i=this.records.length-1;0<=i;i--)this.records[i].recid==arguments[t]&&(this.records.splice(i,1),e++);for(let i=this.summary.length-1;0<=i;i--)this.summary[i].recid==arguments[t]&&(this.summary.splice(i,1),e++)}return(this.url?.get??this.url)||(this.localSort(!1,!0),this.localSearch(),this.total=this.records.length),this.refresh(),e}addColumn(e,t){let i=0;1==arguments.length?(t=e,e=this.columns.length):null==(e="string"==typeof e?this.getColumn(e,!0):e)&&(e=this.columns.length),Array.isArray(t)||(t=[t]);for(let l=0;l<t.length;l++){var s=d.extend({},this.colTemplate,t[l]);if(this.columns.splice(e,0,s),t[l].searchable){let e=t[l].searchable,i="";!0===t[l].searchable&&(e="text",i='size="20"'),this.addSearch({field:t[l].field,label:t[l].text,type:e,attr:i})}e++,i++}return this.refresh(),i}removeColumn(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.columns.length-1;0<=i;i--)this.columns[i].field==arguments[t]&&(this.columns[i].searchable&&this.removeSearch(arguments[t]),this.columns.splice(i,1),e++);return this.refresh(),e}getColumn(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.columns.length;e++)i.push(this.columns[e].field);return i}for(let i=0;i<this.columns.length;i++)if(this.columns[i].field==e)return!0===t?i:this.columns[i];return null}updateColumn(e,t){let i=0;return(e=Array.isArray(e)?e:[e]).forEach((e=>{this.columns.forEach((s=>{if(s.field==e){let e=d.clone(t);Object.keys(e).forEach((t=>{"function"==typeof e[t]&&(e[t]=e[t](s)),s[t]!=e[t]&&i++})),d.extend(s,e)}}))})),0<i&&this.refresh(),i}toggleColumn(){return this.updateColumn(Array.from(arguments),{hidden:e=>!e.hidden})}showColumn(){return this.updateColumn(Array.from(arguments),{hidden:!1})}hideColumn(){return this.updateColumn(Array.from(arguments),{hidden:!0})}addSearch(e,t){let i=0;1==arguments.length?(t=e,e=this.searches.length):null==(e="string"==typeof e?this.getSearch(e,!0):e)&&(e=this.searches.length),Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++)this.searches.splice(e,0,t[s]),e++,i++;return this.searchClose(),i}removeSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&(this.searches.splice(i,1),e++);return this.searchClose(),e}getSearch(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.searches.length;e++)i.push(this.searches[e].field);return i}for(let i=0;i<this.searches.length;i++)if(this.searches[i].field==e)return!0===t?i:this.searches[i];return null}toggleSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&(this.searches[i].hidden=!this.searches[i].hidden,e++);return this.searchClose(),e}showSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&!1!==this.searches[i].hidden&&(this.searches[i].hidden=!1,e++);return this.searchClose(),e}hideSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&!0!==this.searches[i].hidden&&(this.searches[i].hidden=!0,e++);return this.searchClose(),e}getSearchData(e){for(let t=0;t<this.searchData.length;t++)if(this.searchData[t].field==e)return this.searchData[t];return null}localSort(e,t){let i=this;if(this.url?.get??this.url)return console.log("ERROR: grid.localSort can only be used on local data source, grid.url should be empty."),0;if(0===Object.keys(this.sortData).length){let e=this.last.originalSort;return e&&this.records.sort(((t,i)=>(t=e.indexOf(t.recid),e.indexOf(i.recid)<t?1:-1))),0}let s=Date.now();this.selectionSave(),this.prepareData(),t||this.reset();for(let e=0;e<this.sortData.length;e++){var l=this.getColumn(this.sortData[e].field);if(!l)return;"string"==typeof l.render&&(-1!=["date","age"].indexOf(l.render.split(":")[0])&&(this.sortData[e].field_=l.field+"_"),-1!=["time"].indexOf(l.render.split(":")[0]))&&(this.sortData[e].field_=l.field+"_")}for(let e=0;e<i.records.length;e++){var o=i.records[e];null!=o.w2ui?.parent_recid&&(o.w2ui._path=a(o))}this.records.sort(((e,t)=>{if(!(e.w2ui&&null!=e.w2ui.parent_recid||t.w2ui&&null!=t.w2ui.parent_recid))return r(e,t);var i=a(e),s=a(t);for(let e=0;e<Math.min(i.length,s.length);e++){var l=r(i[e],s[e]);if(0!==l)return l}return i.length>s.length?1:i.length<s.length?-1:(console.log("ERROR: two paths should not be equal."),0)}));for(let e=0;e<i.records.length;e++){var n=i.records[e];null!=n.w2ui?.parent_recid&&(n.w2ui._path=null)}return this.selectionRestore(t),s=Date.now()-s,!0!==e&&this.show.statusSort&&setTimeout((()=>{this.status(d.lang("Sorting took ${count} seconds",{count:s/1e3}))}),10),s;function a(e){var t;return e.w2ui&&null!=e.w2ui.parent_recid?e.w2ui._path||((t=i.get(e.w2ui.parent_recid))?a(t).concat(e):(console.log("ERROR: no parent record: "+e.w2ui.parent_recid),[e])):[e]}function r(e,t){if(e===t)return 0;for(let o=0;o<i.sortData.length;o++){var s=i.sortData[o].field,l=i.sortData[o].field_||s;let n=e[l],a=t[l];if(-1!=String(s).indexOf(".")&&(n=i.parseField(e,l),a=i.parseField(t,l)),(l=i.getColumn(s))&&0<Object.keys(l.editable).length&&(d.isPlainObject(n)&&n.text&&(n=n.text),d.isPlainObject(a))&&a.text&&(a=a.text),0!==(s=h(n,a,0,i.sortData[o].direction,l.sortMode||"default")))return s}return h(e.recid,t.recid,0,"asc")}function h(e,t,i,s,l){if(e===t)return 0;if((null==e||""===e)&&null!=t&&""!==t)return 1;if(null!=e&&""!==e&&(null==t||""===t))return-1;if(s="asc"===s.toLowerCase()?1:-1,typeof e!=typeof t)return typeof t<typeof e?s:-s;if(e.constructor.name!=t.constructor.name)return e.constructor.name>t.constructor.name?s:-s;e&&"object"==typeof e&&(e=e.valueOf()),t&&"object"==typeof t&&(t=t.valueOf());var o={}.toString;switch(e&&"object"==typeof e&&e.toString!=o&&(e=String(e)),t&&"object"==typeof t&&t.toString!=o&&(t=String(t)),"string"==typeof e&&(e=e.toLowerCase().trim()),"string"==typeof t&&(t=t.toLowerCase().trim()),l){case"natural":l=d.naturalCompare;break;case"i18n":l=d.i18nCompare}return"function"==typeof l?l(e,t)*s:t<e?s:e<t?-s:0}}localSearch(e){let t=this;var i=this.url?.get??this.url;if(!i){let l=Date.now(),o={}.toString,n={};if(this.total=this.records.length,this.last.searchIds=[],this.prepareData(),0<this.searchData.length&&!i){for(let e=this.total=0;e<this.records.length;e++){var s=this.records[e];if(function e(i){let s,l,n,a,r=0,h=!1;for(let e=0;e<t.searchData.length;e++){let c=t.searchData[e],u=t.getSearch(c.field);if(null!=c){null==u&&(u={field:c.field,type:c.type});let e=t.parseField(i,u.field);switch(s=null==e||"object"==typeof e&&e.toString==o?"":String(e).toLowerCase(),null!=c.value&&(Array.isArray(c.value)?(l=c.value[0],n=c.value[1]):l=String(c.value).toLowerCase()),c.operator){case"=":case"is":t.parseField(i,u.field)==c.value?r++:"date"==u.type?(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.formatDate(a,"yyyy-mm-dd"),l=d.formatDate(d.isDate(l,d.settings.dateFormat,!0),"yyyy-mm-dd"),s==l&&r++):"time"==u.type?(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.formatTime(a,"hh24:mi"),l=d.formatTime(l,"hh24:mi"),s==l&&r++):"datetime"==u.type&&(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.formatDateTime(a,"yyyy-mm-dd|hh24:mm:ss"),l=d.formatDateTime(d.isDateTime(l,d.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),s==l)&&r++;break;case"between":-1!=["int","float","money","currency","percent"].indexOf(u.type)?parseFloat(t.parseField(i,u.field))>=parseFloat(l)&&parseFloat(t.parseField(i,u.field))<=parseFloat(n)&&r++:"date"==u.type?(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.isDate(a,d.settings.dateFormat,!0),l=d.isDate(l,d.settings.dateFormat,!0),null!=(n=d.isDate(n,d.settings.dateFormat,!0))&&(n=new Date(n.getTime()+864e5)),s>=l&&s<n&&r++):"time"==u.type?(s=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),l=d.isTime(l,!0),n=d.isTime(n,!0),l=(new Date).setHours(l.hours,l.minutes,l.seconds||0,0),n=(new Date).setHours(n.hours,n.minutes,n.seconds||0,0),s>=l&&s<n&&r++):"datetime"==u.type&&(s=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),l=d.isDateTime(l,d.settings.datetimeFormat,!0),n=(n=d.isDateTime(n,d.settings.datetimeFormat,!0))&&new Date(n.getTime()+864e5),s>=l)&&s<n&&r++;break;case"<=":h=!0;case"<":case"less":-1!=["int","float","money","currency","percent"].indexOf(u.type)?(s=parseFloat(t.parseField(i,u.field)),l=parseFloat(c.value),(s<l||h&&s===l)&&r++):"date"==u.type?(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.isDate(a,d.settings.dateFormat,!0),l=d.isDate(l,d.settings.dateFormat,!0),(s<l||h&&s===l)&&r++):"time"==u.type?(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.formatTime(a,"hh24:mi"),l=d.formatTime(l,"hh24:mi"),(s<l||h&&s===l)&&r++):"datetime"==u.type&&(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.formatDateTime(a,"yyyy-mm-dd|hh24:mm:ss"),l=d.formatDateTime(d.isDateTime(l,d.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),s.length==l.length)&&(s<l||h&&s===l)&&r++;break;case">=":h=!0;case">":case"more":-1!=["int","float","money","currency","percent"].indexOf(u.type)?(s=parseFloat(t.parseField(i,u.field)),l=parseFloat(c.value),(s>l||h&&s===l)&&r++):"date"==u.type?(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.isDate(a,d.settings.dateFormat,!0),l=d.isDate(l,d.settings.dateFormat,!0),(s>l||h&&s===l)&&r++):"time"==u.type?(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.formatTime(a,"hh24:mi"),l=d.formatTime(l,"hh24:mi"),(s>l||h&&s===l)&&r++):"datetime"==u.type&&(a=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=d.formatDateTime(a,"yyyy-mm-dd|hh24:mm:ss"),l=d.formatDateTime(d.isDateTime(l,d.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),s.length==l.length)&&(s>l||h&&s===l)&&r++;break;case"in":a=c.value,(-1!==(a=c.svalue?c.svalue:a).indexOf(d.isFloat(e)?parseFloat(e):e)||-1!==a.indexOf(s)&&""!==s)&&r++;break;case"not in":a=c.value,-1!==(a=c.svalue?c.svalue:a).indexOf(d.isFloat(e)?parseFloat(e):e)||-1!==a.indexOf(s)&&""!==s||r++;break;case"begins":case"begins with":0===s.indexOf(l)&&r++;break;case"contains":0<=s.indexOf(l)&&r++;break;case"null":null==t.parseField(i,u.field)&&r++;break;case"not null":null!=t.parseField(i,u.field)&&r++;break;case"ends":case"ends with":let o=s.lastIndexOf(l);-1!==o&&o==s.length-l.length&&r++}}}if("OR"==t.last.logic&&0!==r||"AND"==t.last.logic&&r==t.searchData.length)return!0;if(i.w2ui?.children&&!0!==i.w2ui?.expanded)for(let t=0;t<i.w2ui.children.length;t++)if(e(i.w2ui.children[t]))return!0;return!1}(s))if(s?.w2ui&&function e(i){let s=t.get(i,!0);if(null==s||null==i||n[i]||t.last.searchIds.includes(s))return;n[i]=!0;let l=t.records[s];l?.w2ui&&e(l.w2ui.parent_recid),t.last.searchIds.push(s)}(s.w2ui.parent_recid),0<this.showExtraOnSearch){let t=this.showExtraOnSearch,i=this.showExtraOnSearch;if(e<t&&(t=e),e+i>this.records.length&&(i=this.records.length-e),0<t)for(let i=e-t;i<e;i++)this.last.searchIds.indexOf(i)<0&&this.last.searchIds.push(i);if(this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e),0<i)for(let t=e+1;t<=e+i;t++)this.last.searchIds.indexOf(t)<0&&this.last.searchIds.push(t)}else this.last.searchIds.push(e)}this.total=this.last.searchIds.length}return l=Date.now()-l,!0!==e&&this.show.statusSearch&&setTimeout((()=>{this.status(d.lang("Search took ${count} seconds",{count:l/1e3}))}),10),l}console.log("ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.")}getRangeData(e,t){var i=this.get(e[0].recid,!0),s=this.get(e[1].recid,!0),l=e[0].column,o=e[1].column,n=[];if(l==o)for(let e=i;e<=s;e++){var a=this.records[e],r=a[this.columns[l].field]||null;n.push(!0!==t?r:{data:r,column:l,index:e,record:a})}else if(i==s){var d=this.records[i];for(let e=l;e<=o;e++){var h=d[this.columns[e].field]||null;n.push(!0!==t?h:{data:h,column:e,index:i,record:d})}}else for(let e=i;e<=s;e++){var c=this.records[e];n.push([]);for(let i=l;i<=o;i++){var u=c[this.columns[i].field];!0!==t?n[n.length-1].push(u):n[n.length-1].push({data:u,column:i,index:e,record:c})}}return n}addRange(e){let t,i,s=0;if("row"!=this.selectType){Array.isArray(e)||(e=[e]);for(let o=0;o<e.length;o++){if("object"!=typeof e[o]&&(e[o]={name:"selection"}),"selection"==e[o].name){if(!1===this.show.selectionBorder)continue;var l=this.getSelection();if(0===l.length){this.removeRange("selection");continue}t=l[0],i=l[l.length-1]}else t=e[o].range[0],i=e[o].range[1];if(t){l={name:e[o].name,range:[{recid:t.recid,column:t.column},{recid:i.recid,column:i.column}],style:e[o].style||"",class:e[o].class};let n=!1;for(let t=0;t<this.ranges.length;t++)if(this.ranges[t].name==e[o].name){n=t;break}!1!==n?this.ranges[n]=l:this.ranges.push(l),s++}}this.refreshRanges()}return s}removeRange(){let e=0;for(let i=0;i<arguments.length;i++){var t=arguments[i];a(this.box).find("#grid_"+this.name+"_"+t).remove(),a(this.box).find("#grid_"+this.name+"_f"+t).remove();for(let i=this.ranges.length-1;0<=i;i--)this.ranges[i].name==t&&(this.ranges.splice(i,1),e++)}return e}refreshRanges(){if(0!==this.ranges.length){let p,m=this;var e=Date.now(),t=a(this.box).find(`#grid_${this.name}_frecords`),i=a(this.box).find(`#grid_${this.name}_records`);for(let v=0;v<this.ranges.length;v++){var s=this.ranges[v],l=s.range[0],o=s.range[1];null==l.index&&(l.index=this.get(l.recid,!0)),null==o.index&&(o.index=this.get(o.recid,!0));let x=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(l.recid)+' td[col="'+l.column+'"]'),k=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(o.recid)+' td[col="'+o.column+'"]'),C=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(l.recid)+' td[col="'+l.column+'"]'),_=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(o.recid)+' td[col="'+o.column+'"]'),E=o.column;l.column<this.last.vscroll.colIndStart&&o.column>this.last.vscroll.colIndStart&&(x=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(l.recid)+' td[col="start"]')),l.column<this.last.vscroll.colIndEnd&&o.column>this.last.vscroll.colIndEnd&&(k=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(o.recid)+' td[col="end"]'),E='"end"');var n,r=parseInt(a(this.box).find("#grid_"+this.name+"_rec_top").next().attr("index")),h=parseInt(a(this.box).find("#grid_"+this.name+"_rec_bottom").prev().attr("index")),c=parseInt(a(this.box).find("#grid_"+this.name+"_frec_top").next().attr("index")),u=parseInt(a(this.box).find("#grid_"+this.name+"_frec_bottom").prev().attr("index"));0===x.length&&l.index<r&&o.index>r&&(x=a(this.box).find("#grid_"+this.name+"_rec_top").next().find('td[col="'+l.column+'"]')),0===k.length&&o.index>h&&l.index<h&&(k=a(this.box).find("#grid_"+this.name+"_rec_bottom").prev().find('td[col="'+E+'"]')),0===C.length&&l.index<c&&o.index>c&&(C=a(this.box).find("#grid_"+this.name+"_frec_top").next().find('td[col="'+l.column+'"]')),0===_.length&&o.index>u&&l.index<u&&(_=a(this.box).find("#grid_"+this.name+"_frec_bottom").prev().find('td[col="'+o.column+'"]')),h=(r=a(this.box).find("#grid_"+this.name+"_editable").find(".w2ui-input")).attr("index"),c=this.records[h]?.recid,u=r.attr("column"),"selection"==s.name&&s.range[0].recid==c&&s.range[0].column==u||(p=a(this.box).find("#grid_"+this.name+"_f"+s.name),(0<C.length||0<_.length)&&(0===p.length?(t.append('<div id="grid_'+this.name+"_f"+s.name+'" class="w2ui-selection" style="'+s.style+'">'+("selection"==s.name&&this.show.selectionResizer?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),p=a(this.box).find("#grid_"+this.name+"_f"+s.name)):(p.attr("style",s.style),p.find(".w2ui-selection-resizer").show()),0===_.length&&(0===(_=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(o.recid)+" td:last-child")).length&&(_=a(this.box).find("#grid_"+this.name+"_frec_bottom td:first-child")),p.css("border-right","0px"),p.find(".w2ui-selection-resizer").hide()),null!=l.recid)&&null!=o.recid&&0<C.length&&0<_.length?(h=getComputedStyle(_[0]),r=C.prop("offsetTop")-C.prop("scrollTop"),c=C.prop("offsetLeft")+C.prop("scrollLeft"),u=_.prop("offsetTop")-_.prop("scrollTop"),n=_.prop("offsetLeft")+_.prop("scrollLeft"),p.show().css({top:(0<r?r:0)+"px",left:(0<c?c:0)+"px",width:n-c+parseFloat(h.width)-1+"px",height:u-r+parseFloat(h.height)-1+"px"})):p.hide(),p=a(this.box).find("#grid_"+this.name+"_"+s.name),(0<x.length||0<k.length)&&(0===p.length?(i.append(`\n                        <div id="grid_${this.name}_${s.name}" class="w2ui-selection ${s.class??""}" style="${s.style}">\n                            ${"selection"==s.name&&this.show.selectionResizer?`<div id="grid_${this.name}_resizer" class="w2ui-selection-resizer"></div>`:""}\n                        </div>\n                    `),p=a(this.box).find("#grid_"+this.name+"_"+s.name)):p.attr("style",s.style),0===x.length&&0===(x=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(l.recid)+" td:first-child")).length&&(x=a(this.box).find("#grid_"+this.name+"_rec_top td:first-child")),0!==_.length&&p.css("border-left","0px"),null!=l.recid)&&null!=o.recid&&0<x.length&&0<k.length?(n=getComputedStyle(k[0]),c=x.prop("offsetTop")-x.prop("scrollTop"),u=x.prop("offsetLeft")+x.prop("scrollLeft"),r=k.prop("offsetTop")-k.prop("scrollTop"),h=k.prop("offsetLeft")+k.prop("scrollLeft"),p.show().css({top:(0<c?c:0)+"px",left:(0<u?u:0)+"px",width:h-u+parseFloat(n.width)-1+"px",height:r-c+parseFloat(n.height)-1+"px"})):p.hide())}a(this.box).find(".w2ui-selection-resizer").off(".resizer").on("mousedown.resizer",(function(e){var t=(i=m.getSelection())[0],i=i[i.length-1];m.last.move={type:"expand",x:e.screenX,y:e.screenY,divX:0,divY:0,index:t.index,recid:t.recid,column:t.column,name:w[t.column]+(t.index+1)+":"+w[i.column]+(i.index+1),originalRange:[d.clone(t),d.clone(i)],newRange:[d.clone(t),d.clone(i)]},f.originalName=m.last.move.name,f.originalRange=m.last.move.originalRange,a("body").off(".w2ui-"+m.name).on("mousemove.w2ui-"+m.name,b).on("mouseup.w2ui-"+m.name,y),e.preventDefault()})).on("dblclick.resizer",(e=>{!0!==(e=this.trigger("resizerDblClick",{target:this.name,originalEvent:e})).isCancelled&&e.finish()}));let g,f={target:this.name,originalRange:null,newRange:null},w="abcdefghijklmnopqrstuvwxyz";return Date.now()-e;function b(e){var t=m.last.move;if(t&&"expand"==t.type){t.divX=e.screenX-t.x,t.divY=e.screenY-t.y;let i,s,l,o=e.target;"TD"!=o.tagName.toUpperCase()&&(o=a(o).closest("td")[0]),null!=(l=null!=a(o).attr("col")?parseInt(a(o).attr("col")):l)&&(o=a(o).closest("tr")[0],s=parseInt(a(o).attr("index")),i=m.records[s]?.recid,t.newRange[1].recid!=i||t.newRange[1].column!=l)&&(e=d.clone(t.newRange),t.newRange=[{recid:t.recid,index:t.index,column:t.column},{recid:i,index:s,column:l}],f.newName=w[t.column]+(t.index+1)+":"+w[l]+(s+1),f.newRange=d.clone(t.newRange),!0===(g=m.trigger("selectionExtend",f)).isCancelled?(t.newRange=e,f.newRange=e):m.addRange({name:"selection-expand",range:t.newRange,class:"w2ui-selection-expand"}))}}function y(e){m.removeRange("selection-expand"),a("body").off(".w2ui-"+m.name),"expand"==m.last.move?.type&&g.finish&&g.finish(),delete m.last.move}}}select(){if(0===arguments.length)return 0;let e=0;var t=this.last.selection;this.multiSelect||this.selectNone(!0);let i=Array.from(arguments);Array.isArray(i[0])&&(i=i[0]);var s={target:this.name};if(1==i.length?(s.multiple=!1,d.isPlainObject(i[0])?s.clicked={recid:i[0].recid,column:i[0].column}:s.recid=i[0]):(s.multiple=!0,s.clicked={recids:i}),0!=this.compareSelection(i).select.length){if(!0===(s=this.trigger("select",s)).isCancelled)return 0;if("row"==this.selectType)for(let s=0;s<i.length;s++){var l="object"==typeof i[s]?i[s].recid:i[s],o=this.get(l,!0);if(null!=o){let i=null,s=null;(0!==this.searchData.length||o+1>=this.last.vscroll.recIndStart&&o+1<=this.last.vscroll.recIndEnd)&&(i=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(l)),s=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(l))),"row"==this.selectType&&-1==t.indexes.indexOf(o)&&(t.indexes.push(o),i&&s&&(i.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),s.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),i.find(".w2ui-grid-select-check").prop("checked",!0)),e++)}}else{var n={};for(let e=0;e<i.length;e++){var r="object"==typeof i[e]?i[e].recid:i[e],h="object"==typeof i[e]?i[e].column:null;if(n[r]=n[r]||[],Array.isArray(h))n[r]=h;else if(d.isInt(h))n[r].push(h);else for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||n[r].push(parseInt(e))}var c,u=[];for(c in n){var p=this.get(c,!0);if(null!=p){let i=null,s=null;p+1>=this.last.vscroll.recIndStart&&p+1<=this.last.vscroll.recIndEnd&&(i=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(c)),s=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(c)));var m=t.columns[p]||[];-1==t.indexes.indexOf(p)&&t.indexes.push(p);for(let e=0;e<n[c].length;e++)-1==m.indexOf(n[c][e])&&m.push(n[c][e]);m.sort(((e,t)=>e-t));for(let t=0;t<n[c].length;t++){var g=n[c][t];-1==u.indexOf(g)&&u.push(g),i&&(i.find("#grid_"+this.name+"_data_"+p+"_"+g).addClass("w2ui-selected"),i.find(".w2ui-col-number").addClass("w2ui-row-selected"),i.find(".w2ui-grid-select-check").prop("checked",!0)),s&&(s.find("#grid_"+this.name+"_data_"+p+"_"+g).addClass("w2ui-selected"),s.find(".w2ui-col-number").addClass("w2ui-row-selected"),s.find(".w2ui-grid-select-check").prop("checked",!0)),e++}t.columns[p]=m}}for(let e=0;e<u.length;e++)a(this.box).find("#grid_"+this.name+"_column_"+u[e]+" .w2ui-col-header").addClass("w2ui-col-selected")}t.indexes.sort(((e,t)=>e-t));var f=0<this.records.length&&t.indexes.length==this.records.length,w=0<t.indexes.length&&0!==this.searchData.length&&t.indexes.length==this.last.searchIds.length;return f||w?a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(t,f),s.finish(),e}}unselect(){let e=0;var t=this.last.selection;let i=Array.from(arguments);Array.isArray(i[0])&&(i=i[0]);var s={target:this.name};if(1==i.length?(s.multiple=!1,d.isPlainObject(i[0])?s.clicked={recid:i[0].recid,column:i[0].column}:s.clicked={recid:i[0]}):(s.multiple=!0,s.recids=i),0!=this.compareSelection(i).unselect.length){if(!0===(s=this.trigger("select",s)).isCancelled)return 0;for(let s=0;s<i.length;s++){var l="object"==typeof i[s]?i[s].recid:i[s];if(null!=(o=this.get(l))){var o=this.get(o.recid,!0),n=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(l)),r=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(l));if("row"==this.selectType)-1!=t.indexes.indexOf(o)&&(t.indexes.splice(t.indexes.indexOf(o),1),n.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),r.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),0!=n.length&&(n[0].style.cssText="height: "+this.recordHeight+"px; "+n.attr("custom_style"),r[0].style.cssText="height: "+this.recordHeight+"px; "+r.attr("custom_style")),n.find(".w2ui-grid-select-check").prop("checked",!1),e++);else{var h=i[s].column;if(!d.isInt(h)){var c=[];for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||c.push({recid:l,column:e});return this.unselect(c)}if(r=t.columns[o],Array.isArray(r)&&-1!=r.indexOf(h)){r.splice(r.indexOf(h),1),a(this.box).find(`#grid_${this.name}_rec_${d.escapeId(l)} > td[col="${h}"]`).removeClass("w2ui-selected w2ui-inactive"),a(this.box).find(`#grid_${this.name}_frec_${d.escapeId(l)} > td[col="${h}"]`).removeClass("w2ui-selected w2ui-inactive");let i=!1,s=!1;var u=this.getSelection();for(let e=0;e<u.length;e++)u[e].column==h&&(i=!0),u[e].recid==l&&(s=!0);i||a(this.box).find(`.w2ui-grid-columns td[col="${h}"] .w2ui-col-header, .w2ui-grid-fcolumns td[col="${h}"] .w2ui-col-header`).removeClass("w2ui-col-selected"),s||a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(l)).find(".w2ui-col-number").removeClass("w2ui-row-selected"),e++,0===r.length&&(delete t.columns[o],t.indexes.splice(t.indexes.indexOf(o),1),n.find(".w2ui-grid-select-check").prop("checked",!1))}}}}var p=0<this.records.length&&t.indexes.length==this.records.length,m=0<t.indexes.length&&0!==this.searchData.length&&t.indexes.length==this.last.searchIds.length;return p||m?a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(t,p),s.finish(),e}}compareSelection(e){var t=this.getSelection(),i=[],s=[];if("row"==this.selectType){e.forEach(((t,i)=>{"object"==typeof t&&(e[i]=t.recid)}));for(let s=0;s<e.length;s++)t.includes(e[s])||i.push(e[s]);for(let i=0;i<e.length;i++)t.includes(e[i])&&s.push(e[i])}else{for(let s=0;s<e.length;s++){let l=!1;for(let i=0;i<t.length;i++)e[s].recid==t[i].recid&&e[s].column==t[i].column&&(l=!0);l||i.push({recid:e[s].recid,column:e[s].column})}for(let i=0;i<t.length;i++){let l=!1;for(let s=0;s<e.length;s++)e[s].recid==t[i].recid&&e[s].column==t[i].column&&(l=!0);l||s.push({recid:t[i].recid,column:t[i].column})}}return{select:i,unselect:s}}selectAll(){var e=Date.now();if(!1!==this.multiSelect){var t=this.url?.get??this.url;let s=d.clone(this.last.selection);var i=[];for(let e=0;e<this.columns.length;e++)i.push(e);if(s.indexes=[],t||0===this.searchData.length){let e=this.records.length;0==this.searchData.length||t||(e=this.last.searchIds.length);for(let t=0;t<e;t++)s.indexes.push(t),"row"!=this.selectType&&(s.columns[t]=i.slice())}else for(let e=0;e<this.last.searchIds.length;e++)s.indexes.push(this.last.searchIds[e]),"row"!=this.selectType&&(s.columns[this.last.searchIds[e]]=i.slice());if(!0!==(t=this.trigger("select",{target:this.name,multiple:!0,all:!0,clicked:s})).isCancelled)return this.last.selection=s,"row"==this.selectType?(a(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),a(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected")):(a(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").addClass("w2ui-col-selected"),a(this.box).find(".w2ui-grid-records tr .w2ui-col-number").addClass("w2ui-row-selected"),a(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected"),a(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").addClass("w2ui-row-selected"),a(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected")),a(this.box).find("input.w2ui-grid-select-check").prop("checked",!0),s=this.getSelection(!0),this.addRange("selection"),a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0),this.status(),this.updateToolbar({indexes:s},!0),t.finish(),Date.now()-e}}selectNone(e){var t,i=Date.now();let s;if(e||!0!==(s=this.trigger("select",{target:this.name,clicked:[]})).isCancelled)return t=this.last.selection,"row"==this.selectType?(a(this.box).find(".w2ui-grid-records tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),a(this.box).find(".w2ui-grid-frecords tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected")):(a(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").removeClass("w2ui-col-selected"),a(this.box).find(".w2ui-grid-records tr .w2ui-col-number").removeClass("w2ui-row-selected"),a(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").removeClass("w2ui-row-selected"),a(this.box).find(".w2ui-grid-data.w2ui-selected").removeClass("w2ui-selected w2ui-inactive")),a(this.box).find("input.w2ui-grid-select-check").prop("checked",!1),t.indexes=[],t.columns={},this.removeRange("selection"),a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.updateToolbar(t,!1),e||s.finish(),Date.now()-i}updateToolbar(e){let t=this,i=e&&e.indexes?e.indexes.length:0;function s(s,l){if(null!=s.batch){let o=!1;!0===s.batch?0<i&&(o=!0):"number"==typeof s.batch?i===s.batch&&(o=!0):"function"==typeof s.batch&&(o=s.batch({cnt:i,sel:e})),o?t.toolbar.enable(l+s.id):t.toolbar.disable(l+s.id)}}this.toolbar.render&&(this.toolbar.items.forEach((e=>{s(e,""),Array.isArray(e.items)&&e.items.forEach((t=>{s(t,e.id+":")}))})),this.show.toolbarSave)&&(0<this.getChanges().length?this.toolbar.enable("w2ui-save"):this.toolbar.disable("w2ui-save"))}getSelection(e){var t=[],i=this.last.selection;if("row"==this.selectType)for(let s=0;s<i.indexes.length;s++)this.records[i.indexes[s]]&&t.push(!0===e?i.indexes[s]:this.records[i.indexes[s]].recid);else for(let e=0;e<i.indexes.length;e++){var s=i.columns[i.indexes[e]];if(this.records[i.indexes[e]])for(let l=0;l<s.length;l++)t.push({recid:this.records[i.indexes[e]].recid,index:parseInt(i.indexes[e]),column:s[l]})}return t}search(e,t){var i=this.url?.get??this.url,s=[];let l=this.last.multi,o=this.last.logic,n=this.last.field,r=this.last.search,h=!1;var c=a(`#w2overlay-${this.name}-search-overlay`);""===t&&(t=null);for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(s.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),h=!0);if(0===arguments.length&&0===c.length&&(t=this.multiSearch?(e=this.searchData,this.last.logic):(e=this.last.field,this.last.search)),0===arguments.length&&0!==c.length){this.focus(),o=c.find(`#grid_${this.name}_logic`).val(),r="";for(let e=0;e<this.searches.length;e++){var u=this.searches[e],p=c.find("#grid_"+this.name+"_operator_"+e).val(),m=c.find("#grid_"+this.name+"_field_"+e),g=c.find("#grid_"+this.name+"_field2_"+e);let t=m.val(),o=g.val(),n=null,a=null;if(-1!=["int","float","money","currency","percent"].indexOf(u.type)&&(f=m[0]._w2field,g=g[0]._w2field,f&&(t=f.clean(t)),g)&&(o=g.clean(o)),-1!=["list","enum"].indexOf(u.type)||-1!=["in","not in"].indexOf(p))if(t=m[0]._w2field.selected||{},Array.isArray(t)){n=[];for(let e=0;e<t.length;e++)n.push(d.isFloat(t[e].id)?parseFloat(t[e].id):String(t[e].id).toLowerCase()),delete t[e].hidden;0===Object.keys(t).length&&(t="")}else a=t.text||"",t=t.id||"";if(""!==t&&null!=t||null!=o&&""!==o){var f={field:u.field,type:u.type,operator:p};"between"==p?d.extend(f,{value:[t,o]}):"in"==p&&"string"==typeof t||"not in"==p&&"string"==typeof t?d.extend(f,{value:t.split(",")}):d.extend(f,{value:t}),n&&d.extend(f,{svalue:n}),a&&d.extend(f,{text:a});try{"date"==u.type&&"between"==p&&(f.value[0]=t,f.value[1]=o),"date"==u.type&&"is"==p&&(f.value=t)}catch(i){}s.push(f),l=!0}}}if("string"==typeof e&&(1==arguments.length&&(t=e,e="all"),n=e,r=t,l=!1,o=h?"AND":"OR",null!=t))if("all"==e.toLowerCase()){if(0<this.searches.length)for(let e=0;e<this.searches.length;e++){var w,b=this.searches[e];if(("text"==b.type||"alphanumeric"==b.type&&d.isAlphaNumeric(t)||"int"==b.type&&d.isInt(t)||"float"==b.type&&d.isFloat(t)||"percent"==b.type&&d.isFloat(t)||("hex"==b.type||"color"==b.type)&&d.isHex(t)||"currency"==b.type&&d.isMoney(t)||"money"==b.type&&d.isMoney(t)||"date"==b.type&&d.isDate(t)||"time"==b.type&&d.isTime(t)||"datetime"==b.type&&d.isDateTime(t)||"datetime"==b.type&&d.isDate(t)||"enum"==b.type&&d.isAlphaNumeric(t)||"list"==b.type&&d.isAlphaNumeric(t))&&(w=this.defaultOperator[this.operatorsMap[b.type]],w={field:b.field,type:b.type,operator:null!=b.operator?b.operator:w,value:t},""!=String(t).trim())&&s.push(w),-1!=["int","float","money","currency","percent"].indexOf(b.type)&&2==String(t).trim().split("-").length&&(w=String(t).trim().split("-"),y={field:b.field,type:b.type,operator:null!=b.operator?b.operator:"between",value:[w[0],w[1]]},s.push(y)),-1!=["list","enum"].indexOf(b.type)){var y,v=[];null==b.options&&(b.options={}),Array.isArray(b.options.items)||(b.options.items=[]);for(let e=0;e<b.options.items;e++){var x=b.options.items[e];try{var k=new RegExp(t,"i");k.test(x)&&v.push(e),x.text&&k.test(x.text)&&v.push(x.id)}catch(i){}}0<v.length&&(y={field:b.field,type:b.type,operator:null!=b.operator?b.operator:"in",value:v},s.push(y))}}else for(let e=0;e<this.columns.length;e++){var C={field:this.columns[e].field,type:"text",operator:this.defaultOperator.text,value:t};s.push(C)}0==s.length&&(_={field:"All",type:"text",operator:this.defaultOperator.text,value:t},s.push(_))}else{var _=c.find("#grid_"+this.name+"_search_all");let i=this.getSearch(e);if((i=null==i?{field:e,type:"text"}:i).field==e&&(this.last.label=i.label),""!==t){let e=this.defaultOperator[this.operatorsMap[i.type]],l=t;if(-1!=["date","time","datetime"].indexOf(i.type)&&(e="is"),-1!=["list","enum"].indexOf(i.type)&&(e="is",l=(_=_._w2field.get())&&0<Object.keys(_).length?_.id:""),"int"==i.type&&""!==t&&(e="is",-1!=String(t).indexOf("-")&&2==(_=t.split("-")).length&&(e="between",l=[parseInt(_[0]),parseInt(_[1])]),-1!=String(t).indexOf(","))){var E=t.split(",");e="in",l=[];for(let e=0;e<E.length;e++)l.push(E[e])}null!=i.operator&&(e=i.operator),_={field:i.field,type:i.type,operator:e,value:l},s.push(_)}}if(Array.isArray(e)){let i="AND";"string"==typeof t&&"OR"!=(i=t.toUpperCase())&&"AND"!=i&&(i="AND"),r="",l=!0,o=i;for(let t=0;t<e.length;t++){var S=e[t];"number"==typeof S.value&&null==S.operator&&(S.operator=this.defaultOperator.number),"string"==typeof S.value&&null==S.operator&&(S.operator=this.defaultOperator.text),Array.isArray(S.value)&&null==S.operator&&(S.operator=this.defaultOperator.enum),d.isDate(S.value)&&null==S.operator&&(S.operator=this.defaultOperator.date),s.push(S)}}!0!==(_=this.trigger("search",{target:this.name,multi:0===arguments.length,searchField:e||"multi",searchValue:e?t:"multi",searchData:s,searchLogic:o})).isCancelled&&(this.searchData=_.detail.searchData,this.last.field=n,this.last.search=r,this.last.multi=l,this.last.logic=_.detail.searchLogic,this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),i?(this.last.fetch.offset=0,this.reload()):(this.localSearch(),this.refresh()),_.finish())}searchOpen(){if(this.box&&0!==this.searches.length){let e=this.trigger("searchOpen",{target:this.name});if(!0!==e.isCancelled){let t=a(this.toolbar.box).find(".w2ui-grid-search-input .w2ui-search-drop");t.addClass("checked"),g.show({name:this.name+"-search-overlay",anchor:a(this.box).find("#grid_"+this.name+"_search_all").get(0),position:"bottom|top",html:this.getSearchesHTML(),align:"left",arrowSize:12,class:"w2ui-grid-search-advanced",hideOn:["doc-click"]}).then((t=>{this.initSearches(),this.last.search_opened=!0;let i=a(`#w2overlay-${this.name}-search-overlay`);i.data("gridName",this.name).off(".grid-search").on("click.grid-search",(()=>{i.find("input, select").each((e=>{(e=a(e).data("tooltipName"))&&e.forEach((e=>{g.hide(e)}))}))})),d.bindEvents(i.find("select, input, button"),this);var s=a(`#w2overlay-${this.name}-search-overlay *[rel=search]`);0<s.length&&s[0].focus(),e.finish()})).hide((e=>{t.removeClass("checked"),this.last.search_opened=!1}))}}}searchClose(){g.hide(this.name+"-search-overlay")}searchFieldTooltip(e,t,i){e=this.searches[e];var s=this.searchData[t];let l=s.operator,o=("less"==(l="more"==l&&"date"==s.type?"since":l)&&"date"==s.type&&(l="before"),""),n=s.value;Array.isArray(s.value)?(s.value.forEach((e=>{o+=`<span class="value">${e.text||e}</span>`})),"date"==s.type&&(o="",s.value.forEach((e=>{o+=`<span class="value">${d.formatDate(e)}</span>`})))):"date"==s.type&&(n=d.formatDateTime(n)),g.hide(this.name+"-search-props"),g.show({name:this.name+"-search-props",anchor:i,class:"w2ui-white",hideOn:"doc-click",html:`\n                <div class="w2ui-grid-search-single">\n                    <span class="field">${e.label}</span>\n                    <span class="operator">${d.lang(l)}</span>\n                    ${Array.isArray(s.value)?""+o:`<span class="value">${n}</span>`}\n                    <div class="buttons">\n                        <button id="remove" class="w2ui-btn">${d.lang("Remove This Field")}</button>\n                    </div>\n                </div>`}).then((e=>{a(e.detail.overlay.box).find("#remove").on("click",(()=>{this.searchData.splice(""+t,1),this.reload(),this.localSearch(),g.hide(this.name+"-search-props")}))}))}searchSuggest(e,t,i){clearTimeout(this.last.kbd_timer),clearTimeout(this.last.overlay_timer),this.searchShowFields(!0),this.searchClose(),!0===t?g.hide(this.name+"-search-suggest"):0<a(`#w2overlay-${this.name}-search-suggest`).length||(e?(t=a(this.box).find(`#grid_${this.name}_search_all`).get(0),e=[...this.defaultSearches??[],...0<this.defaultSearches?.length&&0<this.savedSearches?.length?["--"]:[],...this.savedSearches??[]],Array.isArray(e)&&0<e.length&&f.show({name:this.name+"-search-suggest",anchor:t,align:"both",items:e,hideOn:["doc-click","sleect","remove"],render(e){let t=e.text;return e.isDefault?`<b>${t}</b>`:t}}).select((e=>{var t=this.trigger("searchSelect",{target:this.name,index:e.detail.index,item:e.detail.item});!0===t.isCancelled?e.preventDefault():(e.detail.overlay.hide(),this.last.logic=e.detail.item.logic||"AND",this.last.search="",this.last.label="[Multiple Fields]",this.searchData=d.clone(e.detail.item.data),this.searchSelected=d.clone(e.detail.item,{exclude:["icon","remove"]}),this.reload(),t.finish())})).remove((e=>{let t=e.detail.item,i=this.trigger("searchRemove",{target:this.name,index:e.detail.index,item:t});!0===i.isCancelled?e.preventDefault():(e.detail.overlay.hide(),this.confirm(d.lang('Do you want to delete search "${item}"?',{item:t.text})).yes((e=>{var s=this.savedSearches.findIndex((e=>e.id==t.id));-1!==s&&this.savedSearches.splice(s,1),this.cacheSave("searches",this.savedSearches.map((e=>d.clone(e,{exclude:["remove","icon"]})))),e.detail.self.close(),i.finish()})).no((e=>{e.detail.self.close()})))}))):this.last.overlay_timer=setTimeout((()=>{this.searchSuggest(!0)}),100))}searchSave(){let e="",t=(this.searchSelected&&(e=this.searchSelected.text),this.savedSearches.findIndex((e=>e.id==this.searchSelected?.id))),i=this.trigger("searchSave",{target:this.name,saveLocalStorage:!0});!0!==i.isCancelled&&this.message({width:350,height:150,body:`<div class="w2ui-grid-save-search">\n                        <span>${d.lang(-1!=t?"Update Search":"Save New Search")}</span>\n                        <input class="search-name w2ui-input" placeholder="${d.lang("Search name")}">\n                   </div>`,buttons:`\n                <button id="grid-search-cancel" class="w2ui-btn">${d.lang("Cancel")}</button>\n                <button id="grid-search-save" class="w2ui-btn w2ui-btn-blue" ${""==String(e).trim()?"disabled":""}>${d.lang("Save")}</button>\n            `}).open((async s=>{a(s.detail.box).find("input, button").eq(0).val(e),await s.complete,a(s.detail.box).find("#grid-search-cancel").on("click",(()=>{this.message()})),a(s.detail.box).find("#grid-search-save").on("click",(()=>{var e=a(s.detail.box).find(".w2ui-message .search-name").val();this.searchSelected&&-1!=t?Object.assign(this.savedSearches[t],{id:e,text:e,logic:this.last.logic,data:d.clone(this.searchData)}):this.savedSearches.push({id:e,text:e,icon:"w2ui-icon-search",remove:!0,logic:this.last.logic,data:this.searchData}),this.cacheSave("searches",this.savedSearches.map((e=>d.clone(e,{exclude:["remove","icon"]})))),this.message(),(this.searchSelected?(this.searchSelected.text=e,a(this.box).find(`#grid_${this.name}_search_name .name-text`)):(this.searchSelected={text:e,logic:this.last.logic,data:d.clone(this.searchData)},a(s.detail.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),a(s.detail.box).find(`#grid_${this.name}_search_name`).show().find(".name-text"))).html(e),i.finish({name:e})})),a(s.detail.box).find("input, button").off(".message").on("keydown.message",(e=>{var t=String(a(s.detail.box).find(".w2ui-message-body input").val()).trim();13==e.keyCode&&""!=t&&a(s.detail.box).find("#grid-search-save").trigger("click"),27==e.keyCode&&this.message()})).eq(0).on("input.message",(e=>{var t=a(s.detail.box).closest(".w2ui-message").find("#grid-search-save");""===String(a(s.detail.box).val()).trim()?t.prop("disabled",!0):t.prop("disabled",!1)})).get(0).focus()}))}cache(e){if(d.hasLocalStorage&&this.useLocalStorage)try{var t=JSON.parse(localStorage.w2ui||"{}");return t[this.stateId||this.name]??={},t[this.stateId||this.name][e]}catch(e){}return null}cacheSave(e,t){if(d.hasLocalStorage&&this.useLocalStorage)try{var i=JSON.parse(localStorage.w2ui||"{}");return i[this.stateId||this.name]??={},i[this.stateId||this.name][e]=t,localStorage.w2ui=JSON.stringify(i),!0}catch(e){delete localStorage.w2ui}return!1}searchReset(e){var t=[];let i=!1;for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(t.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),i=!0);var s=this.trigger("search",{reset:!0,target:this.name,searchData:t});if(!0!==s.isCancelled){var l=a(this.box).find("#grid_"+this.name+"_search_all");if(this.searchData=s.detail.searchData,this.searchSelected=null,this.last.search="",this.last.logic=i?"AND":"OR",l.next().hide(),0<this.searches.length)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields",l.next().show();else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}this.last.multi=!1,this.last.fetch.offset=0,this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),l=l.val("").get(0),l?._w2field&&l._w2field.reset(),e||this.reload(),s.finish()}}searchShowFields(e){if(!0===e)g.hide(this.name+"-search-fields");else{var t=[];for(let e=-1;e<this.searches.length;e++){let s=this.searches[e];var i=s?s.field:null;i=this.getColumn(i);let l=!1,o=null;if(1==this.show.searchHiddenMsg&&-1!=e&&(null==i||!0===i.hidden&&!1!==i.hideable)&&(l=!0,o=d.lang("This column "+(null==i?"does not exist":"is hidden"))),-1==e){if(!this.multiSearch||!this.show.searchAll)continue;s={field:"all",label:"All Fields"}}else{if(null!=i&&!1===i.hideable)continue;if(!0===s.hidden&&(o=d.lang("This column is hidden"),!1===s.simple))continue}null==s.label&&null!=s.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",s),s.label=s.caption),t.push({id:s.field,text:d.lang(s.label),search:s,tooltip:o,disabled:l,checked:s.field==this.last.field})}f.show({type:"radio",name:this.name+"-search-fields",anchor:a(this.box).find("#grid_"+this.name+"_search_name").parent().find(".w2ui-search-down").get(0),items:t,align:"none",hideOn:["doc-click","select"]}).select((e=>{this.searchInitInput(e.detail.item.search.field)}))}}searchInitInput(e,t){let i;var s=a(this.box).find("#grid_"+this.name+"_search_all");if("all"==e)i={field:"all",label:d.lang("All Fields")};else if(null==(i=this.getSearch(e)))return;""!=this.last.search?(this.last.label=i.label,this.search(i.field,this.last.search)):(this.last.field=i.field,this.last.label=i.label),s.attr("placeholder",d.lang("Search")+" "+d.lang(i.label||i.caption||i.field,!0)),this.searchSelected?(a(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),a(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.text)):(a(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),a(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html(""))}clear(e){this.total=0,this.records=[],this.summary=[],this.last.fetch.offset=0,this.last.idCache={},this.last.selection={indexes:[],columns:{}},this.reset(!0),e||this.refresh()}reset(e){this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.vscroll.recIndStart=null,this.last.vscroll.recIndEnd=null,a(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),e||this.refresh()}skip(e,t){this.url?.get??this.url?(this.offset=parseInt(e),this.offset>this.total&&(this.offset=this.total-this.limit),(this.offset<0||!d.isInt(this.offset))&&(this.offset=0),this.clear(!0),this.reload(t)):console.log("ERROR: grid.skip() can only be called when you have remote data source.")}load(e,t){return null==e?(console.log('ERROR: You need to provide url argument when calling .load() method of "'+this.name+'" object.'),new Promise(((e,t)=>{t()}))):(this.clear(!0),this.request("load",{},e,t))}reload(e){let t=this;var i=this.url?.get??this.url;return t.selectionSave(),i?this.load(i,(()=>{t.selectionRestore(),"function"==typeof e&&e()})):(this.reset(!0),this.localSearch(),this.selectionRestore(),"function"==typeof e&&e({status:"success"}),new Promise((e=>{e()})))}request(e,t,i,s){let l,o,n=this;var a=new Promise(((e,t)=>{l=e,o=t}));if(null==t&&(t={}),!(i=i||this.url))return new Promise(((e,t)=>{t()}));let r;d.isInt(this.offset)||(this.offset=0),d.isInt(this.last.fetch.offset)||(this.last.fetch.offset=0);var h={limit:this.limit,offset:parseInt(this.offset)+parseInt(this.last.fetch.offset),searchLogic:this.last.logic,search:this.searchData.map((e=>(e=d.clone(e),this.searchMap&&this.searchMap[e.field]&&(e.field=this.searchMap[e.field]),e))),sort:this.sortData.map((e=>(e=d.clone(e),this.sortMap&&this.sortMap[e.field]&&(e.field=this.sortMap[e.field]),e)))};if(0===this.searchData.length&&(delete h.search,delete h.searchLogic),0===this.sortData.length&&delete h.sort,d.extend(h,this.postData),d.extend(h,t),"delete"!=e&&"save"!=e||(delete h.limit,delete h.offset,"delete"==(h.action=e)&&(h[this.recid||"recid"]=this.getSelection())),"load"==e){if(!0===(r=this.trigger("request",{target:this.name,url:i,postData:h,httpMethod:"GET",httpHeaders:this.httpHeaders})).isCancelled)return new Promise(((e,t)=>{t()}))}else r={detail:{url:i,postData:h,httpMethod:"save"==e?"PUT":"DELETE",httpHeaders:this.httpHeaders}};if(0===this.last.fetch.offset&&this.lock(d.lang(this.msgRefresh),!0),this.last.fetch.controller)try{this.last.fetch.controller.abort()}catch(t){}switch(i=r.detail.url,e){case"save":i?.save&&(i=i.save);break;case"delete":i?.remove&&(i=i.remove);break;default:i=i?.get??i}if(0<Object.keys(this.routeData).length){var c=d.parseRoute(i);if(0<c.keys.length)for(let e=0;e<c.keys.length;e++)null!=this.routeData[c.keys[e].name]&&(i=i.replace(new RegExp(":"+c.keys[e].name,"g"),this.routeData[c.keys[e].name]))}return i=new URL(i,location),t=d.prepareParams(i,{method:r.detail.httpMethod,headers:r.detail.httpHeaders,body:r.detail.postData},this.dataType),Object.assign(this.last.fetch,{action:e,options:t,controller:new AbortController,start:Date.now(),loaded:!1}),t.signal=this.last.fetch.controller.signal,fetch(i,t).catch(u).then((t=>{null!=t&&(200!=t?.status?u(t??{}):(n.unlock(),t.json().catch(u).then((t=>{this.requestComplete(t,e,s,l,o)}))))})),"load"==e&&r.finish(),a;function u(t){var i;"AbortError"!==t?.name&&(n.unlock(),!0!==(i=n.trigger("error",{response:t,lastFetch:n.last.fetch})).isCancelled)&&(t.status&&200!=t.status?t.json().then((e=>{n.error(t.status+": "+e.message??t.statusText)})).catch((()=>{n.error(t.status+": "+t.statusText)})):(console.log("ERROR: Server communication failed.","\n   EXPECTED:",{total:5,records:[{recid:1,field:"value"}]},"\n         OR:",{error:!0,message:"error message"}),n.requestComplete({error:!0,message:d.lang(this.msgHTTPError),response:t},e,s,l,o)),i.finish())}}requestComplete(e,t,i,s,l){let o=e.error??!1,n=(null==e.error&&"error"===e.status&&(o=!0),this.last.fetch.response=(Date.now()-this.last.fetch.start)/1e3,setTimeout((()=>{this.show.statusResponse&&this.status(d.lang("Server Response ${count} seconds",{count:this.last.fetch.response}))}),10),this.last.vscroll.pull_more=!1,this.last.vscroll.pull_refresh=!0,"load");"save"==this.last.fetch.action&&(n="save"),"delete"==this.last.fetch.action&&(n="delete");var r=this.trigger(n,{target:this.name,error:o,data:e,lastFetch:this.last.fetch});if(!0===r.isCancelled)l();else{if(o)this.error(d.lang(e.message??this.msgServerError)),l(e);else if("function"==typeof this.parser?"object"!=typeof(e=this.parser(e))&&console.log("ERROR: Your parser did not return proper object"):null==e?e={error:!0,message:d.lang(this.msgNotJSON)}:Array.isArray(e)&&(e={error:o,records:e,total:e.length}),"load"==t){if(null==e.total&&(e.total=-1),null==e.records&&(e.records=[]),e.records.length==this.limit?(l=this.records.length+e.records.length,this.last.fetch.hasMore=l!=this.total):(this.last.fetch.hasMore=!1,this.total=this.offset+this.last.fetch.offset+e.records.length),this.last.fetch.hasMore||a(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").hide(),0===this.last.fetch.offset)this.records=[],this.summary=[];else if(-1!=e.total&&parseInt(e.total)!=parseInt(this.total)){let e=this;return this.message(d.lang(this.msgNeedReload)).ok((()=>{delete e.last.fetch.offset,e.reload()})),new Promise((e=>{e()}))}d.isInt(e.total)&&(this.total=parseInt(e.total)),e.records&&e.records.forEach((e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.records.length),(!0===e.w2ui?.summary?this.summary:this.records).push(e)})),e.summary&&(this.summary=[],e.summary.forEach((e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.summary.length),this.summary.push(e)})))}else if("delete"==t)return this.reset(),this.reload();(this.url?.get??this.url)||(this.localSort(),this.localSearch()),this.total=parseInt(this.total),0===this.last.fetch.offset?this.refresh():(this.scroll(),this.resize()),"function"==typeof i&&i(e),s(e),r.finish(),this.last.fetch.loaded=!0}}error(e){var t=this.trigger("error",{target:this.name,message:e});!0!==t.isCancelled&&(this.message(e),t.finish())}getChanges(e){var t=[];void 0===e&&(e=this.records);for(let l=0;l<e.length;l++){var i,s=e[l];s?.w2ui&&(null!=s.w2ui.changes&&((i={})[this.recid||"recid"]=s.recid,t.push(d.extend(i,s.w2ui.changes))),!0!==s.w2ui.expanded)&&s.w2ui.children&&s.w2ui.children.length&&t.push(...this.getChanges(s.w2ui.children))}return t}mergeChanges(){var e=this.getChanges();for(let s=0;s<e.length;s++){var t,i=this.get(e[s][this.recid||"recid"]);for(t in e[s])if(!("recid"==t||this.recid&&t==this.recid)){"object"==typeof e[s][t]&&(e[s][t]=e[s][t].text);try{!function e(t,i,s){let l=i.split(".");1==l.length?t[i]=s:(t=t[l[0]],l.shift(),e(t,l.join("."),s))}(i,t,e[s][t])}catch(e){console.log("ERROR: Cannot merge. ",e.message||"",e)}i.w2ui&&delete i.w2ui.changes}}this.refresh()}save(e){var t=this.getChanges(),i=this.url?.save??this.url;let s=this.trigger("save",{target:this.name,changes:t});!0!==s.isCancelled&&(i?this.request("save",{changes:s.detail.changes},null,(t=>{t.error||this.mergeChanges(),s.finish(),"function"==typeof e&&e(t)})):(this.mergeChanges(),s.finish()))}editField(e,t,i,s){let l=this;if(!0===this.last.inEditMode)s&&13==s.keyCode?(({index:o,column:n,value:r}=this.last._edit),this.editChange({type:"custom",value:r},o,n,s),this.editDone(o,n,s)):0<(r=a(this.box).find("div.w2ui-edit-box .w2ui-input")).length&&("DIV"==r.get(0).tagName?(r.text(r.text()+i),d.setCursorPosition(r.get(0),r.text().length)):(r.val(r.val()+i),d.setCursorPosition(r.get(0),r.val().length)));else{let h=this.get(e,!0),c=this.getCellEditable(h,t);if(c&&!["checkbox","check"].includes(c.type)){let u=this.records[h],p=this.columns[t];var o=!0===p.frozen?"_f":"_";if(-1!=["enum","file"].indexOf(c.type))console.log('ERROR: input types "enum" and "file" are not supported in inline editing.');else{var n=this.trigger("editField",{target:this.name,recid:e,column:t,value:i,index:h,originalEvent:s});if(!0!==n.isCancelled){i=n.detail.value,this.last.inEditMode=!0,this.last.editColumn=t,this.last._edit={value:i,index:h,column:t,recid:e},this.selectNone(!0),this.select({recid:e,column:t});var r=a(this.box).find("#grid_"+this.name+o+"rec_"+d.escapeId(e));let m=r.find('[col="'+t+'"] > div'),f=(this.last._edit.tr=r,this.last._edit.div=m,a(this.box).find("div.w2ui-edit-box").remove(),"row"!=this.selectType&&(a(this.box).find("#grid_"+this.name+o+"selection").attr("id","grid_"+this.name+"_editable").removeClass("w2ui-selection").addClass("w2ui-edit-box").prepend('<div style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;"></div>').find(".w2ui-selection-resizer").remove(),m=a(this.box).find("#grid_"+this.name+"_editable > div:first-child")),c.attr=c.attr??"",c.text=c.text??"",c.style=c.style??"",c.items=c.items??[],null!=u.w2ui?.changes?.[p.field]?d.stripTags(u.w2ui.changes[p.field]):d.stripTags(l.parseField(u,p.field))),w="object"!=typeof(f=null==f?"":f)?f:"",b=(null!=n.detail.prevValue&&(w=n.detail.prevValue),null!=i&&(f=i),null!=p.style?p.style+";":"");"string"==typeof p.render&&["number","int","float","money","percent","size"].includes(p.render.split(":")[0])&&(b+="text-align: right;"),0<c.items.length&&!d.isPlainObject(c.items[0])&&(c.items=d.normMenu(c.items));let y,v=["date","time","datetime","color","list","combo"];function x(e){try{var t=getComputedStyle(e),i="DIV"==e.tagName.toUpperCase()?e.innerText:e.value,s=a(l.box).find("#grid_"+l.name+"_editable").get(0),o=`font-family: ${t["font-family"]}; font-size: ${t["font-size"]}; white-space: no-wrap;`,n=d.getStrWidth(i,o);n+20>s.clientWidth&&a(s).css("width",n+20+"px")}catch(e){}}o=`font-family: ${(s=getComputedStyle(r.find('[col="'+t+'"] > div').get(0)))["font-family"]}; font-size: ${s["font-size"]};`,"div"===c.type?(m.addClass("w2ui-editable").html(d.stripSpaces(`<div id="grid_${this.name}_edit_${e}_${t}" class="w2ui-input w2ui-focus"\n                        contenteditable autocorrect="off" autocomplete="off" spellcheck="false"\n                        style="${o+b+c.style}"\n                        field="${p.field}" recid="${e}" column="${t}" ${c.attr}>\n                    </div>`+c.text)),(y=m.find("div.w2ui-input").get(0)).innerText="object"!=typeof f?f:"",null!=i?d.setCursorPosition(y,y.innerText.length):d.setCursorPosition(y,0,y.innerText.length)):(m.addClass("w2ui-editable").html(d.stripSpaces(`<input id="grid_${this.name}_edit_${e}_${t}" class="w2ui-input"\n                        autocorrect="off" autocomplete="off" spellcheck="false" type="text"\n                        style="${o+b+c.style}"\n                        field="${p.field}" recid="${e}" column="${t}" ${c.attr}>`+c.text)),y=m.find("input").get(0),"number"==c.type&&(f=d.formatNumber(f)),"date"==c.type&&(f=d.formatDate(d.isDate(f,c.format,!0)||new Date,c.format)),y.value="object"!=typeof f?f:"",r=e=>{var t=this.last._edit?.escKey;let i=!1;var s=a(y).data("tooltipName");s&&null!=g.get(s[0])?.selected&&(i=!0),!this.last.inEditMode||t||!v.includes(c.type)||e.detail.overlay.anchor?.id!=this.last._edit.input?.id&&"list"!=c.type||(this.editChange(),this.editDone(void 0,void 0,{keyCode:i?13:0}))},new S(d.extend({},c,{el:y,selected:f,onSelect:r,onHide:r})),null==i&&y&&y.select()),Object.assign(this.last._edit,{input:y,edit:c}),a(y).off(".w2ui-editable").on("blur.w2ui-editable",(e=>{var i;this.last.inEditMode&&(i=this.last._edit.edit.type,a(y).data("tooltipName")&&v.includes(i)||!0===e.target._keepOpen?delete e.target._keepOpen:(this.editChange(y,h,t,e),this.editDone()))})).on("mousedown.w2ui-editable",(e=>{e.stopPropagation()})).on("click.w2ui-editable",(e=>{x.call(y,e)})).on("paste.w2ui-editable",(e=>{e.preventDefault(),e=e.clipboardData.getData("text/plain"),document.execCommand("insertHTML",!1,e)})).on("keyup.w2ui-editable",(e=>{x.call(y,e)})).on("keydown.w2ui-editable",(i=>{switch(i.keyCode){case 8:"list"!=c.type||y._w2field||i.preventDefault();break;case 9:case 13:i.preventDefault();break;case 27:var s=a(y).data("tooltipName");if(s&&0<s.length)return this.last._edit.escKey=!0,g.hide(s[0]),void i.preventDefault();i.stopPropagation()}setTimeout((()=>{switch(i.keyCode){case 9:var s=i.shiftKey?l.prevCell(h,t,!0):l.nextCell(h,t,!0);null!=s&&(o=l.records[s.index].recid,this.editChange(y,h,t,i),this.editDone(h,t,i),"row"!=l.selectType?(l.selectNone(!0),l.select({recid:o,column:s.colIndex})):l.editField(o,s.colIndex,null,i),i.preventDefault)&&i.preventDefault();break;case 13:{let e=!1;var o=a(y).data("tooltipName");o&&null!=g.get(o[0]).selected&&(e=!0),o&&e||!0===y._keepOpen?delete y._keepOpen:(this.editChange(y,h,t,i),this.editDone(h,t,i));break}case 27:{this.last._edit.escKey=!1;let s=l.parseField(u,p.field);null!=u.w2ui?.changes?.[p.field]&&(s=u.w2ui.changes[p.field]),null!=y._prevValue&&(s=y._prevValue),"DIV"==y.tagName?y.innerText=null!=s?s:"":y.value=null!=s?s:"",this.editDone(h,t,i),setTimeout((()=>{l.select({recid:e,column:t})}),1);break}}x(y)}),1)})),y&&(y._prevValue=w),"list"!=c.type&&setTimeout((()=>{this.last.inEditMode&&y&&(y.focus(),clearTimeout(this.last.kbd_timer),(y.resize=x)(y))}),50),n.finish({input:y})}}}}}editChange(e,t,i,s){e=e??this.last._edit.input,t=t??this.last._edit.index,i=i??this.last._edit.column,s=s??{};var l=(t<0?this.summary:this.records)[t=t<0?-t-1:t],o=this.columns[i];let n="DIV"==e?.tagName?e.innerText:e.value;var a=e._w2field,r=(a&&(null!=(n="list"==a.type?a.selected:n)&&0!==Object.keys(n).length||(n=""),d.isPlainObject(n)||(n=a.clean(n))),"checkbox"==e.type&&(!1===l.w2ui?.editable&&(e.checked=!e.checked),n=e.checked),this.parseField(l,o.field)),h=l.w2ui?.changes&&l.w2ui.changes.hasOwnProperty(o.field)?l.w2ui.changes[o.field]:r;let c={target:this.name,input:e,recid:l.recid,index:t,column:i,originalEvent:s,value:{new:n,previous:h,original:r}},u=(null!=s.target?._prevValue&&(c.value.previous=s.target._prevValue),0);for(;u<20;){if(u++,"object"!=typeof(n=c.value.new)&&String(r)!=String(n)||"object"==typeof n&&n&&n.id!=r&&("object"!=typeof r||null==r||n.id!=r.id)){if(!0!==(c=this.trigger("change",c)).isCancelled){if(n!==c.detail.value.new)continue;(""!==c.detail.value.new&&null!=c.detail.value.new||""!==h&&null!=h)&&(l.w2ui=l.w2ui??{},l.w2ui.changes=l.w2ui.changes??{},l.w2ui.changes[o.field]=c.detail.value.new),c.finish()}}else if(!0!==(c=this.trigger("restore",c)).isCancelled){if(n!==c.detail.value.new)continue;l.w2ui?.changes&&(delete l.w2ui.changes[o.field],0===Object.keys(l.w2ui.changes).length)&&delete l.w2ui.changes,c.finish()}break}}editDone(e,t,i){if(e=e??this.last._edit.index,t=t??this.last._edit.column,i=i??{},this.advanceOnEdit&&13==i.keyCode){let s=i.shiftKey?this.prevRow(e,t,1):this.nextRow(e,t,1);null==s&&(s=e),setTimeout((()=>{"row"!=this.selectType?(this.selectNone(!0),this.select({recid:this.records[s].recid,column:t})):this.editField(this.records[s].recid,t,null,i)}),1)}var s=e<0,l=a(this.last._edit?.tr).find('[col="'+t+'"]'),o=this.records[e],n=this.columns[t];this.last.inEditMode=!1,this.last._edit=null,s||(null!=o.w2ui?.changes?.[n.field]?l.addClass("w2ui-changed"):l.removeClass("w2ui-changed"),l.replace(this.getCellHTML(e,t,s))),a(this.box).find("div.w2ui-edit-box").remove(),this.updateToolbar(),setTimeout((()=>{var e=a(this.box).find(`#grid_${this.name}_focus`).get(0);document.activeElement===e||this.last.inEditMode||e.focus()}),10)}delete(e){var t=this.trigger("delete",{target:this.name,force:e});if(e&&this.message(),!0!==t.isCancelled){e=t.detail.force;var i=this.getSelection();if(0!==i.length)if(""==this.msgDelete||e){if("object"!=typeof this.url?this.url:this.url.remove)this.request("delete");else if("object"!=typeof i[0])this.selectNone(),this.remove.apply(this,i);else{for(let e=0;e<i.length;e++){var s=this.columns[i[e].column].field,l=this.get(i[e].recid,!0),o=this.records[l];null!=l&&"recid"!=s&&(this.records[l][s]="",o.w2ui?.changes)&&delete o.w2ui.changes[s]}this.update()}t.finish()}else this.confirm({text:d.lang(this.msgDelete,{count:i.length,records:d.lang(1==i.length?"record":"records")}),width:380,height:170,yes_text:d.lang("Delete"),yes_class:"w2ui-btn-red",no_text:d.lang("Cancel")}).yes((e=>{e.detail.self.close(),this.delete(!0)})).no((e=>{e.detail.self.close()}))}}click(e,t){var i=Date.now();let s=null;if(!(1==this.last.cancelClick||t&&t.altKey))if("object"==typeof e&&null!==e&&(s=e.column,e=e.recid),null==t&&(t={}),i-parseInt(this.last.click_time)<350&&this.last.click_recid==e&&"click"==t.type)this.dblClick(e,t);else{if(this.last.bubbleEl&&(this.last.bubbleEl=null),this.last.click_time=i,i=this.last.click_recid,this.last.click_recid=e,null==s&&t.target){let e=t.target;"TD"!=e.tagName&&(e=a(e).closest("td")[0]),null!=a(e).attr("col")&&(s=parseInt(a(e).attr("col")))}var l=this.trigger("click",{target:this.name,recid:e,column:s,originalEvent:t});if(!0!==l.isCancelled){var o=this.getSelection(),n=(a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.get(e,!0)),r=[];let c,u,p,m;if(this.last.sel_ind=n,this.last.sel_col=s,this.last.sel_recid=e,this.last.sel_type="click",t.shiftKey&&0<o.length&&this.multiSelect){if(o[0].recid){c=this.get(o[0].recid,!0),u=this.get(e,!0),m=s>o[0].column?(p=o[0].column,s):(p=s,o[0].column);for(let e=p;e<=m;e++)r.push(e)}else c=this.get(i,!0),u=this.get(e,!0);var d=[],h=(c>u&&(i=c,c=u,u=i),this.url?.get?this.url.get:this.url);for(let e=c;e<=u;e++)if(!(0<this.searchData.length)||h||this.last.searchIds.includes(e))if("row"==this.selectType)d.push(this.records[e].recid);else for(let t=0;t<r.length;t++)d.push({recid:this.records[e].recid,column:r[t]});this.select(d)}else{let l=-1!=(i=this.last.selection).indexes.indexOf(n),r=!1;a(t.target).closest("td").hasClass("w2ui-col-select")&&(r=!0),(t.ctrlKey||t.shiftKey||t.metaKey||r)&&this.multiSelect||this.showSelectColumn?!0===(l="row"==this.selectType&&l)?this.unselect({recid:e,column:s}):this.select({recid:e,column:s}):!0===(l=!("row"!=this.selectType&&!i.columns[n]?.includes(s))&&l)&&1==o.length?this.unselect({recid:e,column:s}):(this.selectNone(!0),this.select({recid:e,column:s}))}this.status(),this.initResize(),l.finish()}}}columnClick(e,t){if(!0!==this.last.colResizing){let o=this.trigger("columnClick",{target:this.name,field:e,originalEvent:t});if(!0!==o.isCancelled){if("row"==this.selectType)(i=this.getColumn(e))&&i.sortable&&this.sort(e,null,!(!t||!(t.ctrlKey||t.metaKey||t.shiftKey))),"line-number"==o.detail.field&&(this.getSelection().length>=this.records.length?this.selectNone():this.selectAll());else if(t.altKey&&(i=this.getColumn(e))&&i.sortable&&this.sort(e,null,!(!t||!(t.ctrlKey||t.metaKey||t.shiftKey))),"line-number"==o.detail.field)this.getSelection().length>=this.records.length?this.selectNone():this.selectAll();else{t.shiftKey||t.metaKey||t.ctrlKey||this.selectNone(!0);var i=this.getSelection(),s=(e=this.getColumn(o.detail.field,!0),[]),l=[];if(0!=i.length&&t.shiftKey){let t=e,s=i[0].column;t>s&&(t=i[0].column,s=e);for(let e=t;e<=s;e++)l.push(e)}else l.push(e);if(!0!==(o=this.trigger("columnSelect",{target:this.name,columns:l})).isCancelled){for(let e=0;e<this.records.length;e++)s.push({recid:this.records[e].recid,column:l});this.select(s)}o.finish()}o.finish()}}}columnDblClick(e,t){!0!==(e=this.trigger("columnDblClick",{target:this.name,field:e,originalEvent:t})).isCancelled&&e.finish()}columnContextMenu(e,t){!0!==(e=this.trigger("columnContextMenu",{target:this.name,field:e,originalEvent:t})).isCancelled&&(this.show.columnMenu&&(f.show({type:"check",contextMenu:!0,originalEvent:t,items:this.initColumnOnOff()}).then((()=>{a("#w2overlay-context-menu .w2ui-grid-skip").off(".w2ui-grid").on("click.w2ui-grid",(e=>{e.stopPropagation()})).on("keypress",(e=>{13==e.keyCode&&(this.skip(e.target.value),this.toolbar.click("w2ui-column-on-off"))}))})).select((e=>{var t=e.detail.item.id;["w2ui-stateSave","w2ui-stateReset"].includes(t)?this[t.substring(5)]():"w2ui-skip"!=t&&this.columnOnOff(e,e.detail.item.id),clearTimeout(this.last.kbd_timer)})),clearTimeout(this.last.kbd_timer)),t.preventDefault(),e.finish())}columnAutoSize(e){if(0==arguments.length)this.columns.forEach(((e,t)=>this.columnAutoSize(t)));else{var t=this.columns[e],i=a(`#grid_${this.name}_column_${e} .w2ui-col-header`)[0];if(!1===t.autoResize||!0===t.hidden||!i)return!0;var s=getComputedStyle(i);let l=d.getStrWidth(i.innerHTML,`font-family: ${s.fontFamily}; font-size: `+s.fontSize,!0)+parseFloat(s.paddingLeft)+parseFloat(s.paddingRight)+4;a(this.box).find(`.w2ui-grid-records td[col="${e}"] > div`,this.box).each((e=>{var t=getComputedStyle(e);e=d.getStrWidth(e.innerHTML,`font-family: ${t.fontFamily}; font-size: `+t.fontSize,!0)+parseFloat(t.paddingLeft)+parseFloat(t.paddingRight)+4,l<e&&(l=e)})),!0!==(i=this.trigger("columnAutoResize",{maxWidth:l,originalEvent:event,target:this.name,column:t})).isCancelled&&(0<l&&(null==t.sizeOriginal&&(t.sizeOriginal=t.size),t.size=Math.min(Math.abs(l),t.max||1/0)+"px",this.resizeRecords(),this.resizeRecords(),this.scroll()),i.finish())}}columnAutoSizeAll(){this.columns.forEach(((e,t)=>this.columnAutoSize(t)))}focus(e){if(!0===(e=this.trigger("focus",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!0,a(this.box).removeClass("w2ui-inactive").find(".w2ui-inactive").removeClass("w2ui-inactive"),setTimeout((()=>{var e=a(this.box).find(`#grid_${this.name}_focus`).get(0);e&&document.activeElement!=e&&e.focus()}),10),e.finish()}blur(e){if(!0===(e=this.trigger("blur",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!1,a(this.box).addClass("w2ui-inactive").find(".w2ui-selected").addClass("w2ui-inactive"),a(this.box).find(".w2ui-selection").addClass("w2ui-inactive"),e.finish()}keydown(e){let t=this,i="object"!=typeof this.url?this.url:this.url.get;if(!0===t.keyboard){var s=t.trigger("keydown",{target:t.name,originalEvent:e});if(!0!==s.isCancelled)if(0<a(this.box).find(".w2ui-message").length)27==e.keyCode&&this.message();else{let r=!1,h=a(t.box).find("#grid_"+t.name+"_records"),c=t.getSelection(),u=(0===c.length&&(r=!0),c[0]||null),p=[],m=c[c.length-1];if("object"==typeof u&&null!=u){u=c[0].recid,p=[];let E=0;for(;c[E]&&c[E].recid==u;)p.push(c[E].column),E++;m=c[c.length-1].recid}let g=t.get(u,!0),f=t.get(m,!0),w=a(t.box).find(`#grid_${t.name}_rec_`+(null!=g?d.escapeId(t.records[g].recid):"none"));var l,o=Math.floor(h[0].clientHeight/t.recordHeight);let b=!1,y=e.keyCode,v=e.shiftKey;switch(y){case 8:case 46:t.delete(),b=!0,e.stopPropagation();break;case 27:t.last.move?.type?(delete t.last.move,t.removeRange("selection-preview"),t.removeRange("selection-expand")):t.selectNone(),b=!0;break;case 65:(e.metaKey||e.ctrlKey)&&(t.selectAll(),b=!0);break;case 13:if("row"==this.selectType&&!0===t.show.expandColumn){if(w.length<=0)break;t.toggle(u,e),b=!0}else{for(let S=0;S<this.columns.length;S++)if(this.getCellEditable(g,S)){p.push(parseInt(S));break}0<(p="row"==this.selectType&&this.last._edit&&this.last._edit.column?[this.last._edit.column]:p).length&&(t.editField(u,p[0]??this.last.editColumn,null,e),b=!0)}break;case 37:!function(){if(r)C();else{if("row"==t.selectType){if(w.length<=0)return;var i=t.records[g].w2ui||{};!i||null==i.parent_recid||Array.isArray(i.children)&&0!==i.children.length&&i.expanded?t.collapse(u,e):(t.unselect(u),t.collapse(i.parent_recid,e),t.select(i.parent_recid))}else{let i=t.prevCell(g,p[0]);if(i=i?.index!=g?null:i?.colIndex,v||null!=i||(t.selectNone(!0),i=0),null!=i)if(v&&t.multiSelect){if(_())return;var s=[],l=[],o=[];if(0===p.indexOf(t.last.sel_col)&&1<p.length){for(let e=0;e<c.length;e++)-1==s.indexOf(c[e].recid)&&s.push(c[e].recid),o.push({recid:c[e].recid,column:p[p.length-1]});t.unselect(o),t.scrollIntoView(g,p[p.length-1],!0)}else{for(let e=0;e<c.length;e++)-1==s.indexOf(c[e].recid)&&s.push(c[e].recid),l.push({recid:c[e].recid,column:i});t.select(l),t.scrollIntoView(g,i,!0)}}else t.click({recid:u,column:i},e),t.scrollIntoView(g,i,!0);else v||t.selectNone(!0)}b=!0}}();break;case 39:!function(){if(r)C();else{if("row"==t.selectType){if(w.length<=0)return;t.expand(u,e)}else{let o=t.nextCell(g,p[p.length-1]);if(o=o.index!=g?null:o.colIndex,v||null!=o||(t.selectNone(!0),o=t.columns.length-1),null!=o)if(v&&39==y&&t.multiSelect){if(_())return;var i=[],s=[],l=[];if(p.indexOf(t.last.sel_col)==p.length-1&&1<p.length){for(let e=0;e<c.length;e++)-1==i.indexOf(c[e].recid)&&i.push(c[e].recid),l.push({recid:c[e].recid,column:p[0]});t.unselect(l),t.scrollIntoView(g,p[0],!0)}else{for(let e=0;e<c.length;e++)-1==i.indexOf(c[e].recid)&&i.push(c[e].recid),s.push({recid:c[e].recid,column:o});t.select(s),t.scrollIntoView(g,o,!0)}}else t.click({recid:u,column:o},e),t.scrollIntoView(g,o,!0);else v||t.selectNone(!0)}b=!0}}();break;case 33:x(o);break;case 34:k(o);break;case 35:k(-1);break;case 36:x(-1);break;case 38:x(e.metaKey||e.ctrlKey?-1:1);break;case 40:k(e.metaKey||e.ctrlKey?-1:1);break;case 17:case 91:r||d.isSafari&&(t.last.copy_event=t.copy(!1,e),(l=a(t.box).find("#grid_"+t.name+"_focus")).val(t.last.copy_event.detail.text),l[0].select());break;case 67:(e.metaKey||e.ctrlKey)&&(d.isSafari||(t.last.copy_event=t.copy(!1,e),(l=a(t.box).find("#grid_"+t.name+"_focus")).val(t.last.copy_event.detail.text),l[0].select()),t.copy(t.last.copy_event,e));break;case 88:r||(e.ctrlKey||e.metaKey)&&(d.isSafari||(t.last.copy_event=t.copy(!1,e),(l=a(t.box).find("#grid_"+t.name+"_focus")).val(t.last.copy_event.detail.text),l[0].select()),t.copy(t.last.copy_event,e))}var n=[32,187,189,192,219,220,221,186,222,188,190,191];for(let T=48;T<=111;T++)n.push(T);function x(s){if(r&&C(),!(w.length<=0)){let n=t.prevRow(g,"row"==t.selectType?0:c[0].column,s);if(null!=(n=v||null!=n?n:0==t.searchData.length||i?0:t.last.searchIds[0])){if(v&&t.multiSelect){if(_())return;if("row"==t.selectType)t.last.sel_ind>n&&t.last.sel_ind!=f?t.unselect(t.records[f].recid):t.select(t.records[n].recid);else if(t.last.sel_ind>n&&t.last.sel_ind!=f){n=f;var l=[];for(let e=0;e<p.length;e++)l.push({recid:t.records[n].recid,column:p[e]});t.unselect(l)}else{var o=[];for(let e=0;e<p.length;e++)o.push({recid:t.records[n].recid,column:p[e]});t.select(o)}}else t.selectNone(!0),t.click({recid:t.records[n].recid,column:p[0]},e);t.scrollIntoView(n,null,!0,1!=s),e.preventDefault&&e.preventDefault()}else v||t.selectNone(!0)}}function k(s){if(r&&C(),!(w.length<=0)){let n=t.nextRow(f,"row"==t.selectType?0:c[0].column,s);if(null!=(n=v||null!=n?n:0==t.searchData.length||i?t.records.length-1:t.last.searchIds[t.last.searchIds.length-1])){if(v&&t.multiSelect){if(_())return;if("row"==t.selectType)t.last.sel_ind<n&&t.last.sel_ind!=g?t.unselect(t.records[g].recid):t.select(t.records[n].recid);else if(t.last.sel_ind<n&&t.last.sel_ind!=g){n=g;var l=[];for(let e=0;e<p.length;e++)l.push({recid:t.records[n].recid,column:p[e]});t.unselect(l)}else{var o=[];for(let e=0;e<p.length;e++)o.push({recid:t.records[n].recid,column:p[e]});t.select(o)}}else t.selectNone(!0),t.click({recid:t.records[n].recid,column:p[0]},e);t.scrollIntoView(n,null,!0,1!=s),b=!0}else v||t.selectNone(!0)}}function C(){if(t.records&&0!==t.records.length){let e=Math.floor(h[0].scrollTop/t.recordHeight)+1;(!t.records[e]||e<2)&&(e=0),void 0!==t.records[e]&&t.select({recid:t.records[e].recid,column:0})}}function _(){if("click"==t.last.sel_type){if("row"==t.selectType)return t.last.sel_type="key",1<c.length&&(c.splice(c.indexOf(t.records[t.last.sel_ind].recid),1),t.unselect(c),1);if(t.last.sel_type="key",1<c.length){for(let e=0;e<c.length;e++)if(c[e].recid==t.last.sel_recid&&c[e].column==t.last.sel_col){c.splice(e,1);break}return t.unselect(c),1}}}-1==n.indexOf(y)||e.ctrlKey||e.metaKey||b||(0===p.length&&p.push(0),b=!1,setTimeout((()=>{var i=a(t.box).find("#grid_"+t.name+"_focus"),s=i.val();i.val(""),t.editField(u,p[0],s,e)}),1)),b&&e.preventDefault&&e.preventDefault(),s.finish()}}}scrollIntoView(e,t,i,s){let l=this.records.length;if(0!==(l=0==this.searchData.length||this.url?l:this.last.searchIds.length)){if(null==e){if(0===(o=this.getSelection()).length)return;d.isPlainObject(o[0])?(e=o[0].index,t=o[0].column):e=this.get(o[0],!0)}var o,n=(o=a(this.box).find(`#grid_${this.name}_records`))[0].clientWidth,r=o[0].clientHeight,h=o[0].scrollTop,c=o[0].scrollLeft,u=this.last.searchIds.length;if(0<u&&(e=this.last.searchIds.indexOf(e)),o.css({"scroll-behavior":i?"auto":"smooth"}),r<this.recordHeight*(0<u?u:l)&&0<o.length&&(u=(i=Math.floor(h/this.recordHeight))+Math.floor(r/this.recordHeight),e==i&&o.prop("scrollTop",h-r/1.3),e==u&&o.prop("scrollTop",h+r/1.3),(e<i||u<e)&&o.prop("scrollTop",(e-1)*this.recordHeight),!0===s)&&o.prop("scrollTop",e*this.recordHeight),null!=t){let e=0,i=0;h=d.scrollBarSize();for(let s=0;s<=t;s++){var p=this.columns[s];p.frozen||p.hidden||(e=i,i+=parseInt(p.sizeCalculated))}n<i-c?o.prop("scrollLeft",e-h):e<c&&o.prop("scrollLeft",i-n+2*h)}}}scrollToColumn(e){if(null!=e){let i=0,s=!1;for(let l=0;l<this.columns.length;l++){var t=this.columns[l];if(t.field==e){s=!0;break}t.frozen||t.hidden||(i+=t=parseInt(t.sizeCalculated||t.size))}s&&(this.last.vscroll.scrollLeft=i+1,this.scroll())}}dblClick(e,t){let i=null;if("object"==typeof e&&null!==e&&(i=e.column,e=e.recid),null==t&&(t={}),null==i&&t.target){let e=t.target;"TD"!=e.tagName.toUpperCase()&&(e=a(e).closest("td")[0]),i=parseInt(a(e).attr("col"))}var s=this.get(e,!0),l=this.records[s],o=this.trigger("dblClick",{target:this.name,recid:e,column:i,originalEvent:t});!0!==o.isCancelled&&(this.selectNone(!0),this.getCellEditable(s,i)?this.editField(e,i,null,t):(this.select({recid:e,column:i}),(this.show.expandColumn||l&&l.w2ui&&Array.isArray(l.w2ui.children))&&this.toggle(e)),o.finish())}showContextMenu(e,t,i){if("text"!=this.last.userSelect){null==(i=null==i?{offsetX:0,offsetY:0,target:a(this.box).find(`#grid_${this.name}_rec_`+e)[0]}:i).offsetX&&(i.offsetX=i.layerX-i.target.offsetLeft,i.offsetY=i.layerY-i.target.offsetTop);var s=this.getSelection();if("row"==this.selectType)-1==s.indexOf(e)&&this.click(e);else{let l=!1;for(let i=0;i<s.length;i++)s[i].recid!=e&&s[i].column!=t||(l=!0);l||null==e||this.click({recid:e,column:t}),l||null==t||this.columnClick(this.columns[t].field,i)}var l=this.trigger("contextMenu",{target:this.name,originalEvent:i,recid:e,column:t});!0!==l.isCancelled&&(0<this.contextMenu?.length&&f.show({contextMenu:!0,originalEvent:i,items:this.contextMenu}).select((i=>{clearTimeout(this.last.kbd_timer),this.contextMenuClick(e,t,i)})),i.preventDefault(),clearTimeout(this.last.kbd_timer),l.finish())}}contextMenuClick(e,t,i){!0!==(e=this.trigger("contextMenuClick",{target:this.name,recid:e,column:t,originalEvent:i.detail.originalEvent,menuEvent:i,menuIndex:i.detail.index,menuItem:i.detail.item})).isCancelled&&e.finish()}toggle(e){var t=this.get(e);if(null!=t)return t.w2ui=t.w2ui??{},!0===t.w2ui.expanded?this.collapse(e):this.expand(e)}expand(e,t){var i=this.get(e,!0);let s=this.records[i];s.w2ui=s.w2ui??{};var l=d.escapeId(e),o=s.w2ui.children;let n;if(Array.isArray(o)){if(!0===s.w2ui.expanded||0===o.length)return!1;if(!0===(n=this.trigger("expand",{target:this.name,recid:e})).isCancelled)return!1;s.w2ui.expanded=!0,o.forEach((e=>{e.w2ui=e.w2ui??{},e.w2ui.parent_recid=s.recid,null==e.w2ui.children&&(e.w2ui.children=[])})),this.records.splice.apply(this.records,[i+1,0].concat(o)),-1!==this.total&&(this.total+=o.length),("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(!0,!0),0<this.searchData.length&&this.localSearch(!0)),!0!==t&&this.refresh(),n.finish()}else{if(0<a(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if("none"==s.w2ui.expanded)return!1;if(a(this.box).find("#grid_"+this.name+"_rec_"+l).after(`<tr id="grid_${this.name}_rec_${e}_expanded_row" class="w2ui-expanded-row">\n                    <td colspan="100" class="w2ui-expanded2">\n                        <div id="grid_${this.name}_rec_${e}_expanded"></div>\n                    </td>\n                    <td class="w2ui-grid-data-last"></td>\n                </tr>`),a(this.box).find("#grid_"+this.name+"_frec_"+l).after(`<tr id="grid_${this.name}_frec_${e}_expanded_row" class="w2ui-expanded-row">\n                    ${this.show.lineNumbers?'<td class="w2ui-col-number"></td>':""}\n                    <td class="w2ui-grid-data w2ui-expanded1" colspan="100">\n                       <div id="grid_${this.name}_frec_${e}_expanded"></div>\n                    </td>\n                </tr>`),!0===(n=this.trigger("expand",{target:this.name,recid:e,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"})).isCancelled)return a(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").remove(),a(this.box).find("#grid_"+this.name+"_frec_"+l+"_expanded_row").remove(),!1;i=a(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded"),o=a(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded"),t=i.find(":scope div:first-child")[0]?.clientHeight??50,i[0].clientHeight<t&&i.css({height:t+"px"}),o[0].clientHeight<t&&o.css({height:t+"px"}),a(this.box).find("#grid_"+this.name+"_rec_"+l).attr("expanded","yes").addClass("w2ui-expanded"),a(this.box).find("#grid_"+this.name+"_frec_"+l).attr("expanded","yes").addClass("w2ui-expanded"),a(this.box).find("#grid_"+this.name+"_cell_"+this.get(e,!0)+"_expand div").html("-"),s.w2ui.expanded=!0,n.finish(),this.resizeRecords()}return!0}collapse(e,t){var i=this.get(e,!0);let s=this.records[i],l=(s.w2ui=s.w2ui||{},d.escapeId(e));var o=s.w2ui.children;let n;if(Array.isArray(o)){if(!0!==s.w2ui.expanded)return!1;if(!0===(n=this.trigger("collapse",{target:this.name,recid:e})).isCancelled)return!1;!function e(t){t.w2ui.expanded=!1;for(let i=0;i<t.w2ui.children.length;i++){let s=t.w2ui.children[i];s.w2ui.expanded&&e(s)}}(s);var r=[];for(let e=s;null!=e;e=this.get(e.w2ui.parent_recid))r.push(e.w2ui.parent_recid);let l=o=i+1;for(;!(this.records.length<=l+1||null==this.records[l+1].w2ui||0<=r.indexOf(this.records[l+1].w2ui.parent_recid));)l++;this.records.splice(o,l-o+1),-1!==this.total&&(this.total-=l-o+1),("object"!=typeof this.url?this.url:this.url.get)||0<this.searchData.length&&this.localSearch(!0),!0!==t&&this.refresh(),n.finish()}else{if(0===a(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if(!0===(n=this.trigger("collapse",{target:this.name,recid:e,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"})).isCancelled)return!1;a(this.box).find("#grid_"+this.name+"_rec_"+l).removeAttr("expanded").removeClass("w2ui-expanded"),a(this.box).find("#grid_"+this.name+"_frec_"+l).removeAttr("expanded").removeClass("w2ui-expanded"),a(this.box).find("#grid_"+this.name+"_cell_"+this.get(e,!0)+"_expand div").html("+"),a(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded").css("height","0px"),a(this.box).find("#grid_"+this.name+"_frec_"+l+"_expanded").css("height","0px"),setTimeout((()=>{a(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").remove(),a(this.box).find("#grid_"+this.name+"_frec_"+l+"_expanded_row").remove(),s.w2ui.expanded=!1,n.finish(),this.resizeRecords()}),300)}return!0}sort(e,t,i){var s=this.trigger("sort",{target:this.name,field:e,direction:t,multiField:i});if(!0!==s.isCancelled){if(null!=e){let s=this.sortData.length;for(let t=0;t<this.sortData.length;t++)if(this.sortData[t].field==e){s=t;break}if(null==t)if(null==(t=this.sortData[s]?.direction))null==this.last.originalSort&&(this.last.originalSort=this.records.map((e=>e.recid))),t="asc";else switch(t.toLowerCase()){case"asc":t="desc";break;case"desc":t="";break;default:t="asc"}1!=i&&(this.sortData=[],s=0),""===t?this.sortData.splice(s,1):(this.sortData[s]??={},Object.assign(this.sortData[s],{field:e,direction:t}))}else this.sortData=[];("object"!=typeof this.url?this.url:this.url.get)?(s.finish({direction:t}),this.last.fetch.offset=0,this.reload()):(this.localSort(!1,!0),0<this.searchData.length&&this.localSearch(!0),this.last.vscroll.scrollTop=0,a(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),s.finish({direction:t}),this.refresh())}}copy(e,t){if(d.isPlainObject(e))return e.finish(),e.text;var i=this.getSelection();if(0===i.length)return"";let s,l="";if("object"==typeof i[0]){let e=i[0].column,t=i[0].column;var o=[];for(let s=0;s<i.length;s++)i[s].column<e&&(e=i[s].column),i[s].column>t&&(t=i[s].column),-1==o.indexOf(i[s].index)&&o.push(i[s].index);o.sort(((e,t)=>e-t));for(let i=0;i<o.length;i++){var n=o[i];for(let i=e;i<=t;i++)!0!==this.columns[i].hidden&&(l+=this.getCellCopy(n,i)+"\t");l=l.substr(0,l.length-1),l+="\n"}}else{for(let e=0;e<this.columns.length;e++){var a=this.columns[e];if(!0!==a.hidden){let e=a.text||a.field;a.text&&a.text.length<3&&a.tooltip&&(e=a.tooltip),l+='"'+d.stripTags(e)+'"\t'}}l=l.substr(0,l.length-1),l+="\n";for(let e=0;e<i.length;e++){var r=this.get(i[e],!0);for(let e=0;e<this.columns.length;e++)!0!==this.columns[e].hidden&&(l+='"'+this.getCellCopy(r,e)+'"\t');l=l.substr(0,l.length-1),l+="\n"}}return l=l.substr(0,l.length-1),null==e?!0===(s=this.trigger("copy",{target:this.name,text:l,cut:88==t.keyCode,originalEvent:t})).isCancelled?"":(l=s.detail.text,s.finish(),l):!1===e?!0===(s=this.trigger("copy",{target:this.name,text:l,cut:88==t.keyCode,originalEvent:t})).isCancelled?"":(l=s.detail.text,s):void 0}getCellCopy(e,t){return d.stripTags(this.getCellHTML(e,t))}paste(e,t){var i=this.getSelection();let s=this.get(i[0].recid,!0);var l,o,n,a=i[0].column;if(!0!==(t=this.trigger("paste",{target:this.name,text:e,index:s,column:a,originalEvent:t})).isCancelled){if(e=t.detail.text,"row"==this.selectType||0===i.length)console.log("ERROR: You can paste only if grid.selectType = 'cell' and when at least one cell selected.");else{if("object"!=typeof e){var r=[];e=e.split("\n");for(let t=0;t<e.length;t++){var d=e[t].split("\t");let i=0;var h=this.records[s],c=[];if(null!=h){for(let e=0;e<d.length;e++)this.columns[a+i]&&(l=h,o=this.columns[a+i].field,n=d[e],l.w2ui=l.w2ui??{},l.w2ui.changes=l.w2ui.changes||{},l.w2ui.changes[o]=n,c.push(a+i),i++);for(let e=0;e<c.length;e++)r.push({recid:h.recid,column:c[e]});s++}}this.selectNone(!0),this.select(r)}else this.selectNone(!0),this.select([{recid:this.records[s],column:a}]);this.refresh()}t.finish()}}resize(){var e=Date.now();if(this.box&&a(this.box).attr("name")==this.name){var t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled)return null!=this.box&&(this.resizeBoxes(),this.resizeRecords()),t.finish(),Date.now()-e}}update({cells:e,fullCellRefresh:t,ignoreColumns:i}={}){var s=Date.now();let l=this;if(null==this.box)return 0;if(Array.isArray(e))for(let t=0;t<e.length;t++){var o=e[t].index,n=e[t].column;if(!(o<0))if(null==o||null==n)console.log("ERROR: Wrong argument for grid.update({ cells }), cells should be [{ index: X, column: Y }, ...]");else{var r=this.records[o]??{};r.w2ui=r.w2ui??{},r.w2ui._update=r.w2ui._update??{cells:[]};let e=r.w2ui._update.row1,t=r.w2ui._update.row2;null!=e&&e.isConnected&&null!=t&&t.isColSelected||(e=this.box.querySelector(`#grid_${this.name}_rec_`+d.escapeId(r.recid)),t=this.box.querySelector(`#grid_${this.name}_frec_`+d.escapeId(r.recid)),r.w2ui._update.row1=e,r.w2ui._update.row2=t),c(r,e,t,o,n)}}else for(let e=this.last.vscroll.recIndStart-1;e<=this.last.vscroll.recIndEnd;e++){let t=e;t=0<this.last.searchIds.length?this.last.searchIds[e]:e;var h=this.records[t];if(!(t<0||null==h)){h.w2ui=h.w2ui??{},h.w2ui._update=h.w2ui._update??{cells:[]};let e=h.w2ui._update.row1,i=h.w2ui._update.row2;null!=e&&e.isConnected&&null!=i&&i.isColSelected||(e=this.box.querySelector(`#grid_${this.name}_rec_`+d.escapeId(h.recid)),i=this.box.querySelector(`#grid_${this.name}_frec_`+d.escapeId(h.recid)),h.w2ui._update.row1=e,h.w2ui._update.row2=i);for(let s=0;s<this.columns.length;s++)c(h,e,i,t,s)}}return Date.now()-s;function c(e,s,o,n,r){var h=l.columns[r];if(!Array.isArray(i)||!i.includes(r)&&!i.includes(h.field)){let i=e.w2ui._update.cells[r];if(null!=i&&i.isConnected||(i=l.box.querySelector(`#grid_${l.name}_data_${n}_`+r),e.w2ui._update.cells[r]=i),null!=i){if(t)a(i).replace(l.getCellHTML(n,r,!1)),i=l.box.querySelector(`#grid_${l.name}_data_${n}_`+r),e.w2ui._update.cells[r]=i;else{var c=i.children[0],{value:n,style:u,className:p}=l.getCellValue(n,r,!1,!0);if(c.innerHTML!=n&&(c.innerHTML=n),""!=u&&i.style.cssText!=u&&(i.style.cssText=u),""!=p){let e=["w2ui-grid-data"],t=[];c=p.split(" ").filter((e=>!!e)),i.classList.forEach((i=>{e.includes(i)||t.push(i)})),i.classList.remove(...t),i.classList.add(...c)}}if(l.columns[r].style&&l.columns[r].style!=i.style.cssText&&(i.style.cssText=l.columns[r].style??""),null!=e.w2ui.class){if("string"==typeof e.w2ui.class){let t=["w2ui-odd","w2ui-even","w2ui-record"],i=[];n=e.w2ui.class.split(" ").filter((e=>!!e)),s&&o&&(s.classList.forEach((e=>{t.includes(e)||i.push(e)})),s.classList.remove(...i),s.classList.add(...n),o.classList.remove(...i),o.classList.add(...n))}if(d.isPlainObject(e.w2ui.class)&&"string"==typeof e.w2ui.class[h.field]){let t=["w2ui-grid-data"],s=[];u=e.w2ui.class[h.field].split(" ").filter((e=>!!e)),i.classList.forEach((e=>{t.includes(e)||s.push(e)})),i.classList.remove(...s),i.classList.add(...u)}}null!=e.w2ui.style&&(s&&o&&"string"==typeof e.w2ui.style&&s.style.cssText!==e.w2ui.style&&(s.style.cssText="height: "+l.recordHeight+"px;"+e.w2ui.style,s.setAttribute("custom_style",e.w2ui.style),o.style.cssText="height: "+l.recordHeight+"px;"+e.w2ui.style,o.setAttribute("custom_style",e.w2ui.style)),d.isPlainObject(e.w2ui.style))&&"string"==typeof e.w2ui.style[h.field]&&i.style.cssText!==e.w2ui.style[h.field]&&(i.style.cssText=e.w2ui.style[h.field])}}}}refreshCell(e,t){var i=this.get(e,!0),s=(t=this.getColumn(t,!0),e=!this.records[i]||this.records[i].recid!=e,a(this.box).find(`${e?".w2ui-grid-summary ":""}#grid_${this.name}_data_${i}_`+t));return 0!=s.length&&(s.replace(this.getCellHTML(i,t,e)),!0)}refreshRow(e,t=null){let i=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(e)),s=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(e));if(0<i.length){null==t&&(t=this.get(e,!0));var l=i.attr("line"),o=!this.records[t]||this.records[t].recid!=e,n="object"!=typeof this.url?this.url:this.url.get;if(0<this.searchData.length&&!n)for(let e=0;e<this.last.searchIds.length;e++)this.last.searchIds[e]==t&&(t=e);n=this.getRecordHTML(t,l,o),i.replace(n[0]),s.replace(n[1]);let r=this.records[t].w2ui?this.records[t].w2ui.style:"";return"string"==typeof r&&(i=a(this.box).find("#grid_"+this.name+"_frec_"+d.escapeId(e)),s=a(this.box).find("#grid_"+this.name+"_rec_"+d.escapeId(e)),i.attr("custom_style",r),s.attr("custom_style",r),i.hasClass("w2ui-selected")&&(r=r.replace("background-color","none")),i[0].style.cssText="height: "+this.recordHeight+"px;"+r,s[0].style.cssText="height: "+this.recordHeight+"px;"+r),o&&this.resize(),!0}return!1}refresh(){var e=Date.now(),t="object"!=typeof this.url?this.url:this.url.get;if(this.total<=0&&!t&&0===this.searchData.length&&(this.total=this.records.length),this.box&&!0!==(t=this.trigger("refresh",{target:this.name})).isCancelled){this.show.header?a(this.box).find(`#grid_${this.name}_header`).html(d.lang(this.header)+"&#160;").show():a(this.box).find(`#grid_${this.name}_header`).hide(),this.show.toolbar?a(this.box).find("#grid_"+this.name+"_toolbar").show():a(this.box).find("#grid_"+this.name+"_toolbar").hide(),this.searchClose();var i=a(this.box).find("#grid_"+this.name+"_search_all");!this.multiSearch&&"all"==this.last.field&&0<this.searches.length&&(this.last.field=this.searches[0].field,this.last.label=this.searches[0].label);for(let e=0;e<this.searches.length;e++)this.searches[e].field==this.last.field&&(this.last.label=this.searches[e].label);if(this.last.multi?i.attr("placeholder","["+d.lang("Multiple Fields")+"]"):i.attr("placeholder",d.lang("Search")+" "+d.lang(this.last.label,!0)),i.val()!=this.last.search){let e=this.last.search;(s=i._w2field)&&(e=s.format(e)),i.val(e)}this.refreshSearch(),this.refreshBody(),this.show.footer?a(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()).show():a(this.box).find(`#grid_${this.name}_footer`).hide();var s=this.last.selection,l=(i=0<this.records.length&&s.indexes.length==this.records.length,s=0<s.indexes.length&&0!==this.searchData.length&&s.indexes.length==this.last.searchIds.length,i||s?a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):a(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.find({"w2ui.expanded":!0},!0,!0));for(let e=0;e<l.length;e++){var o=this.records[l[e]].w2ui;o&&!Array.isArray(o.children)&&(o.expanded=!1)}return this.markSearch&&setTimeout((()=>{var e=[];for(let s=0;s<this.searchData.length;s++){var t=this.searchData[s],i=this.getSearch(t.field);i&&!i.hidden&&(i=this.getColumn(t.field,!0),e.push({field:t.field,search:t.value,col:i}))}0<e.length&&e.forEach((e=>{var t=a(this.box).find('td[col="'+e.col+'"]:not(.w2ui-head)');d.marker(t,e.search)}))}),50),this.updateToolbar(this.last.selection),t.finish(),this.resize(),this.addRange("selection"),setTimeout((()=>{this.resize(),this.scroll()}),1),this.reorderColumns&&!this.last.columnDrag?this.last.columnDrag=this.initColumnDrag():!this.reorderColumns&&this.last.columnDrag&&this.last.columnDrag.remove(),Date.now()-e}}refreshSearch(){if(this.multiSearch&&0<this.searchData.length){0==a(this.box).find(".w2ui-grid-searches").length&&a(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+35+"px").append(`<div id="grid_${this.name}_searches" class="w2ui-grid-searches"></div>`);let e=`\n                <span id="grid_${this.name}_search_logic" class="w2ui-grid-search-logic"></span>\n                <div class="grid-search-line"></div>`;this.searchData.forEach(((t,i)=>{var s=this.getSearch(t.field,!0),l=this.searches[s];let o;if(o="enum"==l?.type&&Array.isArray(t.value)?`<span class="grid-search-count">${t.value.length}</span>`:"list"==l?.type&&t.text&&t.text!==t.value?": "+t.text:": "+t.value,l&&"date"==l.type)if("between"==t.operator){let e=t.value[0],i=t.value[1];Number(e)===e&&(e=d.formatDate(e)),Number(i)===i&&(i=d.formatDate(i)),o=`: ${e} - `+i}else{let e=t.value,i=(Number(e)==e&&(e=d.formatDate(e)),t.operator);"more:"==(i="less"==(i="more"==i?"since":i)?"before":i).substr(0,5)&&(i="since"),o=`: ${i} `+e}e+=`<span class="w2ui-action" data-click="searchFieldTooltip|${s}|${i}|this">\n                    ${l?l.label??l.field:t.field}\n                    ${o}\n                    <span class="icon-chevron-down"></span>\n                </span>`})),e+=`\n                ${this.show.searchSave?`<div class="grid-search-line"></div>\n                       <button class="w2ui-btn grid-search-btn" data-click="searchSave">${d.lang("Save")}</button>\n                      `:""}\n                <button class="w2ui-btn grid-search-btn btn-remove"\n                    data-click="searchReset">X</button>\n            `,a(this.box).find(`#grid_${this.name}_searches`).html(e),a(this.box).find(`#grid_${this.name}_search_logic`).html(d.lang("AND"==this.last.logic?"All":"Any"))}else a(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+"px").find(".w2ui-grid-searches").remove();this.searchSelected?(a(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),a(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.text)):(a(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),a(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html("")),d.bindEvents(a(this.box).find(`#grid_${this.name}_searches .w2ui-action, #grid_${this.name}_searches button`),this)}refreshBody(){this.scroll();var e=this.getRecordsHTML(),t=this.getColumnsHTML();e='<div id="grid_'+this.name+'_frecords" class="w2ui-grid-frecords" style="margin-bottom: '+(d.scrollBarSize()-1)+'px;">'+e[0]+'</div><div id="grid_'+this.name+'_records" class="w2ui-grid-records">'+e[1]+'</div><div id="grid_'+this.name+'_scroll1" class="w2ui-grid-scroll1" style="height: '+d.scrollBarSize()+'px"></div><div id="grid_'+this.name+'_fcolumns" class="w2ui-grid-fcolumns">    <table><tbody>'+t[0]+'</tbody></table></div><div id="grid_'+this.name+'_columns" class="w2ui-grid-columns">    <table><tbody>'+t[1]+"</tbody></table></div>"+`<div class="w2ui-intersection-marker" style="display: none; height: ${this.recordHeight-5}px">\n               <div class="top-marker"></div>\n               <div class="bottom-marker"></div>\n            </div>`;let i=a(this.box).find(`#grid_${this.name}_body`,this.box).html(e);t=a(this.box).find(`#grid_${this.name}_records`,this.box),e=a(this.box).find(`#grid_${this.name}_frecords`,this.box),"row"==this.selectType&&(t.on("mouseover mouseout",{delegate:"tr"},(e=>{var t=a(e.delegate).attr("index");t=this.records[t]?.recid,a(this.box).find(`#grid_${this.name}_frec_`+d.escapeId(t)).toggleClass("w2ui-record-hover","mouseover"==e.type)})),e.on("mouseover mouseout",{delegate:"tr"},(e=>{var t=a(e.delegate).attr("index");t=this.records[t]?.recid,a(this.box).find(`#grid_${this.name}_rec_`+d.escapeId(t)).toggleClass("w2ui-record-hover","mouseover"==e.type)}))),d.isMobile?t.append(e).on("click",{delegate:"tr"},(e=>{var t=a(e.delegate).attr("index");t=this.records[t]?.recid,this.dblClick(t,e)})):t.add(e).on("click",{delegate:"tr"},(e=>{var t=a(e.delegate).attr("index");t=this.records[t]?.recid,"-none-"!=t&&this.click(t,e)})).on("contextmenu",{delegate:"tr"},(e=>{var t=a(e.delegate).attr("index"),i=(t=this.records[t]?.recid,(i=a(e.target).closest("td")).attr("col")?parseInt(i.attr("col")):null);this.showContextMenu(t,i,e)})).on("mouseover",{delegate:"tr"},(e=>{this.last.rec_out=!1;let t=a(e.delegate).attr("index"),i=this.records[t]?.recid;t!==this.last.rec_over&&(this.last.rec_over=t,setTimeout((()=>{delete this.last.rec_out,this.trigger("mouseEnter",{target:this.name,originalEvent:e,index:t,recid:i}).finish()})))})).on("mouseout",{delegate:"tr"},(e=>{let t=a(e.delegate).attr("index"),i=this.records[t]?.recid;this.last.rec_out=!0,setTimeout((()=>{let s=()=>{this.trigger("mouseLeave",{target:this.name,originalEvent:e,index:t,recid:i}).finish()};t!==this.last.rec_over&&s(),setTimeout((()=>{this.last.rec_out&&(delete this.last.rec_out,delete this.last.rec_over,s())}))}))})),i.data("scroll",{lastDelta:0,lastTime:0}).find(".w2ui-grid-frecords").on("mousewheel DOMMouseScroll ",(e=>{e.preventDefault();var t=i.data("scroll"),s=i.find(".w2ui-grid-records"),l=(e=null!=typeof e.wheelDelta?-e.wheelDelta:e.detail||e.deltaY,s.prop("scrollTop"));t.lastDelta+=e,e=Math.round(t.lastDelta),i.data("scroll",t),s.get(0).scroll({top:l+e,behavior:"smooth"})})),t.off(".body-global").on("scroll.body-global",{delegate:".w2ui-grid-records"},(e=>{this.scroll(e)})),a(this.box).find(".w2ui-grid-body").off(".body-global").on("click.body-global dblclick.body-global contextmenu.body-global",{delegate:"td.w2ui-head"},(e=>{var t=a(e.delegate).attr("col"),i=this.columns[t]??{field:t};switch(e.type){case"click":this.columnClick(i.field,e);break;case"dblclick":this.columnDblClick(i.field,e);break;case"contextmenu":this.columnContextMenu(i.field,e)}})).on("mouseover.body-global",{delegate:".w2ui-col-header"},(e=>{let t=a(e.delegate).parent().attr("col");this.columnTooltipShow(t,e),a(e.delegate).off(".tooltip").on("mouseleave.tooltip",(()=>{this.columnTooltipHide(t,e)}))})).on("click.body-global",{delegate:"input.w2ui-select-all"},(e=>{e.delegate.checked?this.selectAll():this.selectNone(),e.stopPropagation(),clearTimeout(this.last.kbd_timer)})).on("click.body-global",{delegate:".w2ui-show-children, .w2ui-col-expand"},(e=>{e.stopPropagation(),e=a(e.target).parents("tr").attr("index"),this.toggle(this.records[e].recid)})).on("click.body-global mouseover.body-global",{delegate:".w2ui-info"},(e=>{var t=a(e.delegate).closest("td"),i=t.parent(),s=this.columns[t.attr("col")],l=i.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");["mouseenter","mouseover"].includes(s.info?.showOn?.toLowerCase())&&"mouseover"==e.type?this.showBubble(i.attr("index"),t.attr("col"),l).then((()=>{a(e.delegate).off(".tooltip").on("mouseleave.tooltip",(()=>{g.hide(this.name+"-bubble")}))})):"click"==e.type&&(g.hide(this.name+"-bubble"),this.showBubble(i.attr("index"),t.attr("col"),l))})).on("mouseover.body-global",{delegate:".w2ui-clipboard-copy"},(e=>{if(!e.delegate._tooltipShow){let i=a(e.delegate).parent(),s=i.parent();var t=this.columns[i.attr("col")];let l=s.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");g.show({name:this.name+"-bubble",anchor:e.delegate,html:d.lang("string"==typeof t.clipboardCopy?t.clipboardCopy:"Copy to clipboard"),position:"top|bottom",offsetY:-2}).hide((t=>{e.delegate._tooltipShow=!1,a(e.delegate).off(".tooltip")})),a(e.delegate).off(".tooltip").on("mouseleave.tooltip",(e=>{g.hide(this.name+"-bubble")})).on("click.tooltip",(e=>{e.stopPropagation(),g.update(this.name+"-bubble",d.lang("Copied")),this.clipboardCopy(s.attr("index"),i.attr("col"),l)})),e.delegate._tooltipShow=!0}})).on("click.body-global",{delegate:".w2ui-editable-checkbox"},(e=>{var t=a(e.delegate).data();this.editChange.call(this,e.delegate,t.changeind,t.colind,e),this.updateToolbar()})),0===this.records.length&&this.msgEmpty?a(this.box).find(`#grid_${this.name}_body`).append(`<div id="grid_${this.name}_empty_msg" class="w2ui-grid-empty-msg"><div>${d.lang(this.msgEmpty)}</div></div>`):0<a(this.box).find(`#grid_${this.name}_empty_msg`).length&&a(this.box).find(`#grid_${this.name}_empty_msg`).remove(),0<this.summary.length?(e=this.getSummaryHTML(),a(this.box).find(`#grid_${this.name}_fsummary`).html(e[0]).show(),a(this.box).find(`#grid_${this.name}_summary`).html(e[1]).show()):(a(this.box).find(`#grid_${this.name}_fsummary`).hide(),a(this.box).find(`#grid_${this.name}_summary`).hide())}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=a(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.box)){if(e="object"!=typeof this.url?this.url:this.url.get,this.reset(!0),!this.last.field)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields";else{let u=0;for(;u<this.searches.length&&(this.searches[u].hidden||!1===this.searches[u].simple);)u++;u>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[u].field,this.last.label=this.searches[u].label)}if(a(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-grid w2ui-inactive").html('<div class="w2ui-grid-box">    <div id="grid_'+this.name+'_header" class="w2ui-grid-header"></div>    <div id="grid_'+this.name+'_toolbar" class="w2ui-grid-toolbar"></div>    <div id="grid_'+this.name+'_body" class="w2ui-grid-body"></div>    <div id="grid_'+this.name+'_fsummary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_footer" class="w2ui-grid-footer"></div>    <textarea id="grid_'+this.name+'_focus" class="w2ui-grid-focus-input" '+(this.tabIndex?'tabindex="'+this.tabIndex+'"':"")+(d.isMobile?"readonly":"")+"></textarea></div>"),"row"!=this.selectType&&a(this.box).addClass("w2ui-ss"),0<a(this.box).length&&(a(this.box)[0].style.cssText+=this.style),null!=this.toolbar&&this.toolbar.render(a(this.box).find("#grid_"+this.name+"_toolbar")[0]),this.last.toolbar_height=a(this.box).find(`#grid_${this.name}_toolbar`).prop("offsetHeight"),this.last.field&&"all"!=this.last.field){let p=this.searchData;setTimeout((()=>{this.searchInitInput(this.last.field,1==p.length?p[0].value:null)}),1)}a(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()),this.last.state||(this.last.state=this.stateSave(!0)),this.stateRestore(),e&&(this.clear(),this.refresh());let l,o=!1;for(let m=0;m<this.searches.length;m++)if(this.searches[m].hidden){o=!0;break}return o?(this.searchReset(!1),e||setTimeout((()=>{this.searchReset()}),1)):this.reload(),a(this.box).find(`#grid_${this.name}_focus`).on("focus",(e=>{clearTimeout(this.last.kbd_timer),this.hasFocus||this.focus()})).on("blur",(e=>{clearTimeout(this.last.kbd_timer),this.last.kbd_timer=setTimeout((()=>{this.hasFocus&&this.blur()}),100)})).on("paste",(e=>{var t=e.clipboardData||null;if(t){let l=t.items,o=[];for(var i in l=2==l.length&&2==(l=2==l.length&&"file"==l[1].kind?[l[1]]:l).length&&"text/plain"==l[0].type&&"text/html"==l[1].type?[l[1]]:l)if("file"===(i=l[i]).kind){var s=i.getAsFile();o.push({kind:"file",data:s})}else if("string"===i.kind&&("text/plain"===i.type||"text/html"===i.type)){e.preventDefault();let s=t.getData("text/plain");-1!=s.indexOf("\r")&&-1==s.indexOf("\n")&&(s=s.replace(/\r/g,"\n")),o.push({kind:"text/html"==i.type?"html":"text",data:s})}1===o.length&&"file"!=o[0].kind&&(o=o[0].data),r[this.name].paste(o,e),e.preventDefault()}})).on("keydown",(function(e){r[i.name].keydown.call(r[i.name],e)})),a(this.box).off("mousedown.mouseStart").on("mousedown.mouseStart",(function(e){if(1==e.which&&("text"==i.last.userSelect&&(i.last.userSelect="",a(i.box).find(".w2ui-grid-body").css("user-select","none")),!("row"==i.selectType&&(a(e.target).parents().hasClass("w2ui-head")||a(e.target).hasClass("w2ui-head"))||i.last.move&&"expand"==i.last.move.type))){if(e.altKey)a(i.box).find(".w2ui-grid-body").css("user-select","text"),i.selectNone(),i.last.move={type:"text-select"},i.last.userSelect="text";else{let n=e.target;var t={x:e.offsetX-10,y:e.offsetY-10};let r=!1;for(;n&&(!n.classList||!n.classList.contains("w2ui-grid"));)n.tagName&&"TD"==n.tagName.toUpperCase()&&(r=!0),n.tagName&&"TR"!=n.tagName.toUpperCase()&&1==r&&(t.x+=n.offsetLeft,t.y+=n.offsetTop),n=n.parentNode;var s=a(e.target).parents("tr").attr("index");if(s=i.records[s]?.recid,"cell"==i.selectType&&!e.shiftKey){let t=parseInt(a(e.target).closest("td").attr("col")),l=t;isNaN(t)&&(t=0,l=i.columns.length-1),i.addRange({name:"selection-preview",range:[{recid:s,column:t},{recid:s,column:l}],class:"w2ui-selection-preview"})}i.last.move={x:e.screenX,y:e.screenY,divX:0,divY:0,focusX:t.x,focusY:t.y,recid:s,column:parseInt(("TD"==e.target.tagName.toUpperCase()?a(e.target):a(e.target).parents("td")).attr("col")),type:"select",ghost:!1,start:!0},null==i.last.move.recid&&0<i.records.length&&(i.last.move.type="select-column",s=parseInt(a(e.target).closest("td").attr("col")),l=i.records[0].recid,o=i.records[i.records.length-1].recid,i.addRange({name:"selection-preview",range:[{recid:l,column:s},{recid:o,column:s}],class:"w2ui-selection-preview"}));let d=e.target,h=a(i.box).find("#grid_"+i.name+"_focus");if(i.last.move){let e=i.last.move.focusX,t=i.last.move.focusY;var l=a(d).parents("table").parent();(l.hasClass("w2ui-grid-records")||l.hasClass("w2ui-grid-frecords")||l.hasClass("w2ui-grid-columns")||l.hasClass("w2ui-grid-fcolumns")||l.hasClass("w2ui-grid-summary"))&&(e=i.last.move.focusX-a(i.box).find("#grid_"+i.name+"_records").prop("scrollLeft"),t=i.last.move.focusY-a(i.box).find("#grid_"+i.name+"_records").prop("scrollTop")),(a(d).hasClass("w2ui-grid-footer")||0<a(d).parents("div.w2ui-grid-footer").length)&&(t=a(i.box).find("#grid_"+i.name+"_footer").get(0).offsetTop),l.hasClass("w2ui-scroll-wrapper")&&l.parent().hasClass("w2ui-toolbar")&&(e=i.last.move.focusX-l.prop("scrollLeft")),h.css({left:e-10,top:t})}setTimeout((()=>{i.last.inEditMode||(["INPUT","TEXTAREA","SELECT"].includes(d.tagName)?d.focus():h.get(0)!==document.active&&h.get(0)?.focus({preventScroll:!0}))}),50),i.multiSelect||i.reorderRows||"drag"!=i.last.move.type||delete i.last.move}if(1==i.reorderRows){let t=e.target;var o,r,d,c,u;"TD"!=t.tagName.toUpperCase()&&(t=a(t).parents("td")[0]),a(t).hasClass("w2ui-col-number")||a(t).hasClass("w2ui-col-order")?(i.selectNone(),i.last.move.reorder=!0,o=a(i.box).find(".w2ui-even.w2ui-empty-record").css("background-color"),s=a(i.box).find(".w2ui-odd.w2ui-empty-record").css("background-color"),a(i.box).find(".w2ui-even td").filter(":not(.w2ui-col-number)").css("background-color",o),a(i.box).find(".w2ui-odd td").filter(":not(.w2ui-col-number)").css("background-color",s),r=i.last.move,d=a(i.box).find(".w2ui-grid-records"),r.ghost||(u=(c=a(i.box).find(`#grid_${i.name}_rec_`+r.recid)).parents("table").find("tr:first-child").get(0).cloneNode(!0),r.offsetY=e.offsetY,r.from=r.recid,r.pos={top:c.get(0).offsetTop-1,left:c.get(0).offsetLeft},r.ghost=a(c.get(0).cloneNode(!0)),r.ghost.removeAttr("id"),r.ghost.find("td").css({"border-top":"1px solid silver","border-bottom":"1px solid silver"}),c.find("td").remove(),c.append(`<td colspan="1000"><div class="w2ui-reorder-empty" style="height: ${i.recordHeight-2}px"></div></td>`),d.append('<div id="grid_'+i.name+'_ghost_line" style="position: absolute; z-index: 999999; pointer-events: none; width: 100%;"></div>'),d.append('<table id="grid_'+i.name+'_ghost" style="position: absolute; z-index: 999998; opacity: 0.9; pointer-events: none;"></table>'),a(i.box).find("#grid_"+i.name+"_ghost").append(u).append(r.ghost)),a(i.box).find("#grid_"+i.name+"_ghost").css({top:r.pos.top+"px",left:r.pos.left+"px"})):i.last.move.reorder=!1}a(document).on("mousemove.w2ui-"+i.name,n).on("mouseup.w2ui-"+i.name,h),e.stopPropagation()}})),this.updateToolbar(),s.finish(),this.last.observeResize=new ResizeObserver((()=>{this.resize(),this.scroll()})),this.last.observeResize.observe(this.box),Date.now()-t;function n(e){if(e.target.tagName){var t=i.last.move;if(t&&["select","select-column"].includes(t.type)&&(t.divX=e.screenX-t.x,t.divY=e.screenY-t.y,!(Math.abs(t.divX)<=1&&Math.abs(t.divY)<=1)))if(i.last.cancelClick=!0,1==i.reorderRows&&i.last.move.reorder){var s=a(e.target).parents("tr").attr("index");let l=i.records[s]?.recid;(l="-none-"!=l&&null!=l?l:"bottom")!=t.from&&(s=a(i.box).find("#grid_"+i.name+"_rec_"+l),a(i.box).find(".insert-before"),s.addClass("insert-before"),t.lastY=e.screenY,t.to=l,s={top:s.get(0)?.offsetTop,left:s.get(0)?.offsetLeft},a(i.box).find("#grid_"+i.name+"_ghost_line").css({top:s.top+"px",left:t.pos.left+"px","border-top":"2px solid #769EFC"})),a(i.box).find("#grid_"+i.name+"_ghost").css({top:t.pos.top+t.divY+"px",left:t.pos.left+"px"})}else{"row"==i.selectType&&t.start&&t.recid&&(i.selectNone(),t.start=!1);var o=[];if(s=("TR"==e.target.tagName.toUpperCase()?a(e.target):a(e.target).parents("tr")).attr("index"),s=i.records[s]?.recid,null==s){if("row"!=i.selectType&&(!i.last.move||"select"!=i.last.move.type)){var n=parseInt(a(e.target).parents("td").attr("col"));if(isNaN(n))i.removeRange("column-selection"),a(i.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected"),a(i.box).find(".w2ui-col-number").removeClass("w2ui-row-selected"),delete t.colRange;else{let e=n+"-"+n;t.column<n&&(e=t.column+"-"+n);var r=[],d=(e=t.column>n?n+"-"+t.column:e).split("-");for(let e=parseInt(d[0]);e<=parseInt(d[1]);e++)r.push(e);t.colRange!=e&&"select-column"==t.type&&!0!==(l=i.trigger("columnSelect",{target:i.name,columns:r})).isCancelled&&(t.colRange=e,n=i.records[0].recid,c=i.records[i.records.length-1].recid,i.addRange({name:"selection-preview",range:[{recid:n,column:d[0]},{recid:c,column:d[1]}],class:"w2ui-selection-preview"}))}}}else{let l=i.get(t.recid,!0);if(!(null==l||i.records[l]&&i.records[l].recid!=t.recid)){let r=i.get(s,!0);if(null!=r){let d=parseInt(t.column),p=parseInt(("TD"==e.target.tagName.toUpperCase()?a(e.target):a(e.target).parents("td")).attr("col"));isNaN(d)&&isNaN(p)&&(d=0,p=i.columns.length-1),l>r&&(n=l,l=r,r=n);var h,c="ind1:"+l+",ind2;"+r+",col1:"+d+",col2:"+p;if(t.range!=c){t.range=c;for(let e=l;e<=r;e++)if(!(0<i.last.searchIds.length&&-1==i.last.searchIds.indexOf(e)))if("row"!=i.selectType){d>p&&(h=d,d=p,p=h);for(let t=d;t<=p;t++)i.columns[t].hidden||o.push({recid:i.records[e].recid,column:parseInt(t)})}else o.push(i.records[e].recid);if("row"!=i.selectType)s=o[0],e=o[o.length-1],i.addRange({name:"selection-preview",range:[{recid:s.recid,column:s.column},{recid:e.recid,column:e.column}],class:"w2ui-selection-preview"}),t.newRange=o;else if(i.multiSelect){var u=i.getSelection();for(let e=0;e<o.length;e++)-1==u.indexOf(o[e])&&i.select(o[e]);for(let e=0;e<u.length;e++)-1==o.indexOf(u[e])&&i.unselect(u[e])}}}}}}}}function h(e){var t=i.last.move;if(setTimeout((()=>{delete i.last.cancelClick}),1),!a(e.target).parents().hasClass(".w2ui-head")&&!a(e.target).hasClass(".w2ui-head")){if(i.removeRange("selection-preview"),t&&["select","select-column"].includes(t.type)){if(null!=t.colRange&&!0!==l.isCancelled){var s=t.colRange.split("-"),o=[];for(let e=0;e<i.records.length;e++){var n=[];for(let e=parseInt(s[0]);e<=parseInt(s[1]);e++)n.push(e);o.push({recid:i.records[e].recid,column:n})}l.finish(),i.selectNone(!0),i.select(o)}else null!=t.newRange&&(i.selectNone(!0),i.select(...t.newRange));if(1==i.reorderRows&&i.last.move.reorder)if(null!=t.to){if(!0===(e=i.trigger("reorderRow",{target:i.name,recid:t.from,moveBefore:t.to})).isCancelled)return c(),void delete i.last.move;var r=i.get(t.from,!0);let s=i.get(t.to,!0);"bottom"==t.to&&(s=i.records.length),t=i.records[r],null!=r&&null!=s&&(i.records.splice(r,1),r>s?i.records.splice(s,0,t):i.records.splice(s-1,0,t)),i.sortData=[],a(i.box).find(`#grid_${i.name}_columns .w2ui-col-header`).removeClass("w2ui-col-sorted"),c(),e.finish()}else c()}delete i.last.move,a(document).off(".w2ui-"+i.name)}}function c(){a(i.box).find(`#grid_${i.name}_ghost`).remove(),a(i.box).find(`#grid_${i.name}_ghost_line`).remove(),i.refresh(),delete i.last.move}}}unmount(){super.unmount(),this.toolbar?.unmount(),this.last.observeResize?.disconnect()}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(this.toolbar?.destroy?.(),0<a(this.box).find(`#grid_${this.name}_body`).length&&this.unmount(),delete r[this.name],e.finish())}initColumnOnOff(){var e,t=[{id:"line-numbers",text:"Line #",checked:this.show.lineNumbers}];for(let e=0;e<this.columns.length;e++){var i=this.columns[e];let s=this.columns[e].text;!1!==i.hideable&&(s=(s=!s&&this.columns[e].tooltip?this.columns[e].tooltip:s)||"- column "+(parseInt(e)+1)+" -",t.push({id:i.field,text:d.stripTags(s),checked:!i.hidden}))}(("object"!=typeof this.url?this.url:this.url.get)&&this.show.skipRecords||this.show.saveRestoreState)&&t.push({text:"--"}),this.show.skipRecords&&(e=d.lang("Skip")+`<input id="${this.name}_skip" type="text" class="w2ui-input w2ui-grid-skip" value="${this.offset}">`+d.lang("records"),t.push({id:"w2ui-skip",text:e,group:!1,icon:"w2ui-icon-empty"})),this.show.saveRestoreState&&t.push({id:"w2ui-stateSave",text:d.lang("Save Grid State"),icon:"w2ui-icon-empty",group:!1},{id:"w2ui-stateReset",text:d.lang("Restore Default State"),icon:"w2ui-icon-empty",group:!1});let s=[];return t.forEach((e=>{e.text=d.lang(e.text),e.checked&&s.push(e.id)})),this.toolbar.set("w2ui-column-on-off",{selected:s,items:t}),t}initColumnDrag(e){if(this.columnGroups&&this.columnGroups.length)throw"Draggable columns are not currently supported with column groups.";let t=this,i={pressed:!1,targetPos:null,columnHead:null},s=(e,t)=>{var i=["w2ui-col-number","w2ui-col-expand","w2ui-col-select"];!0!==t&&i.push("w2ui-head-last");for(let t=0;t<i.length;t++)if(a(e).closest(".w2ui-head").hasClass(i[t]))return!0;return!1};function l(e){var l,o,n,r;i.pressed&&i.columnHead&&(l=e.pageX,o=e.pageY,s(e.target,!0)||0!=a(e.target).closest("td").length&&(n=(n=a(e.target).closest("td")).hasClass("w2ui-head-last")?t.columns.length:parseInt(n.attr("col")),i.targetPos!=n)&&(r=a(t.box).find(".w2ui-grid-body").get(0).getBoundingClientRect(),e=a(e.target).closest("td").get(0).getBoundingClientRect(),a(t.box).find(".w2ui-intersection-marker").show().css({left:e.left-r.left+"px",height:e.height+"px"}),i.targetPos=n),r=l,e=o,a(i.ghost).css({left:r-10+"px",top:e-10+"px"}).show())}function o(e){if(i.pressed&&i.columnHead){i.pressed=!1;var s,l,o=()=>{var e=a(t.box).find(".w2ui-grid-ghost");a(t.box).find(".w2ui-intersection-marker").hide(),a(i.ghost).remove(),e.remove(),a(document).off(".colDrag"),i={}};if(e.pageX==i.initialX&&e.pageY==i.initialY)t.columnClick(t.columns[i.originalPos].field,e),o();else{if(!0===(e=t.trigger("columnDragEnd",{originalEvent:e,target:i.columnHead[0],dragData:i})).isCancelled)return!1;s=t.columns[i.originalPos],l=t.columns,i.originalPos!=i.targetPos&&null!=i.targetPos&&(l.splice(i.targetPos,0,d.clone(s)),l.splice(l.indexOf(s),1)),o(),t.refresh(),e.finish({targetColumn:NaN})}}}return a(t.box).off(".colDrag").on("mousedown.colDrag",(function(e){var n,r;if(!i.pressed&&0!==i.numberPreColumnsPresent&&0===e.button&&a(e.target).parents().hasClass("w2ui-head")&&!s(e.target)){if(i.pressed=!0,i.initialX=e.pageX,i.initialY=e.pageY,i.numberPreColumnsPresent=a(t.box).find(".w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select").length,i.columnHead=h=a(e.target).closest(".w2ui-head"),i.originalPos=r=parseInt(h.attr("col"),10),!0===(r=t.trigger("columnDragStart",{originalEvent:e,origColumnNumber:r,target:h[0]})).isCancelled)return!1;n=i.columns=a(t.box).find(".w2ui-head:not(.w2ui-head-last)"),a(document).on("mouseup.colDrag",o),a(document).on("mousemove.colDrag",l);var h=t.columns[i.originalPos];h=d.lang("function"==typeof h.text?h.text(h):h.text),i.ghost=a.html(`<span col="${i.originalPos}">${h}</span>`)[0],a(document.body).append(i.ghost),a(i.ghost).css({display:"none",left:e.pageX,top:e.pageY,opacity:1,margin:"3px 0 0 20px",padding:"3px","background-color":"white",position:"fixed","z-index":999999}).addClass(".w2ui-grid-ghost"),i.offsets=[];for(let e=0,t=n.length;e<t;e++){var c=n[e].getBoundingClientRect();i.offsets.push(c.left)}r.finish()}})),{remove(){a(t.box).off(".colDrag"),t.last.columnDrag=!1}}}columnOnOff(e,t){if(!0!==(e=this.trigger("columnOnOff",{target:this.name,field:t,originalEvent:e})).isCancelled){var i=this.find({"w2ui.expanded":!0},!0);for(let e=0;e<i.length;e++){var s=this.records[e].w2ui;s&&!Array.isArray(s.children)&&(this.records[e].w2ui.expanded=!1)}"line-numbers"==t?(this.show.lineNumbers=!this.show.lineNumbers,this.refresh()):(t=this.getColumn(t)).hidden?this.showColumn(t.field):this.hideColumn(t.field),e.finish()}}initToolbar(){if(null==this.toolbar.render){let t=this.toolbar.items||[];var e;this.toolbar.items=[],this.toolbar=new y(d.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.show.toolbarReload&&this.toolbar.items.push(d.extend({},this.buttons.reload)),this.show.toolbarColumns&&this.toolbar.items.push(d.extend({},this.buttons.columns)),this.show.toolbarSearch&&(e=`\n                <div class="w2ui-grid-search-input">\n                    ${this.buttons.search.html}\n                    <div id="grid_${this.name}_search_name" class="w2ui-grid-search-name">\n                        <span class="name-icon w2ui-icon-search"></span>\n                        <span class="name-text"></span>\n                        <span class="name-cross w2ui-action" data-click="searchReset">x</span>\n                    </div>\n                    <input type="text" id="grid_${this.name}_search_all" class="w2ui-search-all" tabindex="-1"\n                        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"\n                        placeholder="${d.lang(this.last.label,!0)}" value="${this.last.search}"\n                        data-focus="searchSuggest" data-click="stop"\n                    >\n                    <div class="w2ui-search-drop w2ui-action" data-click="searchOpen"\n                            style="${this.multiSearch?"":"display: none"}">\n                        <span class="w2ui-icon-drop"></span>\n                    </div>\n                </div>`,this.toolbar.items.push({id:"w2ui-search",type:"html",html:e,onRefresh:async e=>{await e.complete,e=a(this.box).find(`#grid_${this.name}_search_all`),d.bindEvents(a(this.box).find(`#grid_${this.name}_search_all, .w2ui-action`),this);let t=d.debounce((e=>{e=e.target.value,this.liveSearch&&this.last.liveText!=e&&(this.last.liveText=e,this.search(this.last.field,e))}),250);e.on("blur",(()=>{this.last.liveText=""})).on("keyup",(e=>{switch(e.keyCode){case 40:this.searchSuggest(!0);break;case 38:this.searchSuggest(!0,!0);break;case 13:this.search(this.last.field,e.target.value);break;default:t(e)}}))}})),Array.isArray(t)&&(e=t.map((e=>e.id)),this.show.toolbarAdd&&!e.includes(this.buttons.add.id)&&this.toolbar.items.push(d.extend({},this.buttons.add)),this.show.toolbarEdit&&!e.includes(this.buttons.edit.id)&&this.toolbar.items.push(d.extend({},this.buttons.edit)),this.show.toolbarDelete&&!e.includes(this.buttons.delete.id)&&this.toolbar.items.push(d.extend({},this.buttons.delete)),this.show.toolbarSave&&!e.includes(this.buttons.save.id)&&((this.show.toolbarAdd||this.show.toolbarDelete||this.show.toolbarEdit)&&this.toolbar.items.push({type:"break",id:"w2ui-break2"}),this.toolbar.items.push(d.extend({},this.buttons.save))),t=t.map((e=>this.buttons[e.name]?d.extend({},this.buttons[e.name],e):e))),this.toolbar.items.push(...t),this.toolbar.on("click",(e=>{var t=this.trigger("toolbar",{target:e.target,originalEvent:e});if(!0!==t.isCancelled){let s;switch(e.detail.item.id){case"w2ui-reload":if(!0===(s=this.trigger("reload",{target:this.name})).isCancelled)return!1;this.reload(),s.finish();break;case"w2ui-column-on-off":e.detail.subItem?(i=e.detail.subItem.id,["w2ui-stateSave","w2ui-stateReset"].includes(i)?this[i.substring(5)]():"w2ui-skip"!=i&&this.columnOnOff(e,e.detail.subItem.id)):(this.initColumnOnOff(),setTimeout((()=>{a(`#w2overlay-${this.name}_toolbar-drop .w2ui-grid-skip`).off(".w2ui-grid").on("click.w2ui-grid",(e=>{e.stopPropagation()})).on("keypress",(e=>{13==e.keyCode&&(this.skip(e.target.value),this.toolbar.click("w2ui-column-on-off"))}))}),100));break;case"w2ui-add":if(!0===(s=this.trigger("add",{target:this.name,recid:null})).isCancelled)return!1;s.finish();break;case"w2ui-edit":{var i=this.getSelection();let e=null;if(1==i.length&&(e=i[0]),!0===(s=this.trigger("edit",{target:this.name,recid:e})).isCancelled)return!1;s.finish();break}case"w2ui-delete":this.delete();break;case"w2ui-save":this.save()}t.finish()}})),this.toolbar.on("refresh",(e=>{if("w2ui-search"==e.target){let e=this.searchData;setTimeout((()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)}),1)}}))}}initResize(){let e=this;a(this.box).find(".w2ui-resizer").off(".grid-col-resize").on("click.grid-col-resize",(function(e){e.stopPropagation(),e.preventDefault()})).on("mousedown.grid-col-resize",(function(t){t=t||window.event,e.last.colResizing=!0,e.last.tmp={x:t.screenX,y:t.screenY,gx:t.screenX,gy:t.screenY,col:parseInt(a(this).attr("name"))},e.last.tmp.tds=a(e.box).find("#grid_"+e.name+'_body table tr:first-child td[col="'+e.last.tmp.col+'"]'),t.stopPropagation(),t.preventDefault();for(let t=0;t<e.columns.length;t++)e.columns[t].hidden||(null==e.columns[t].sizeOriginal&&(e.columns[t].sizeOriginal=e.columns[t].size),e.columns[t].size=e.columns[t].sizeCalculated);let i,s=e.trigger("columnResize",{target:e.name,resizeBy:0,originalEvent:t,column:e.last.tmp.col,field:e.columns[e.last.tmp.col].field});a(document).off(".grid-col-resize").on("mousemove.grid-col-resize",(function(t){var l,o;1==e.last.colResizing&&(t=t||window.event,!0!==(l=e.trigger("columnResizeMove",d.extend(s.detail,{resizeBy:t.screenX-e.last.tmp.gx,originalEvent:t}))).isCancelled)&&(e.last.tmp.x=t.screenX-e.last.tmp.x,e.last.tmp.y=t.screenY-e.last.tmp.y,o=parseInt(e.columns[e.last.tmp.col].size)+e.last.tmp.x+"px",e.columns[e.last.tmp.col].size=o,i&&clearTimeout(i),i=setTimeout((()=>{e.resizeRecords(),e.scroll()}),100),e.last.tmp.tds.css({width:o}),e.last.tmp.x=t.screenX,e.last.tmp.y=t.screenY,l.finish())})).on("mouseup.grid-col-resize",(function(t){a(document).off(".grid-col-resize"),e.resizeRecords(),e.scroll(),s.finish({originalEvent:t}),setTimeout((()=>{e.last.colResizing=!1}),1)}))})).on("dblclick.grid-col-resize",(function(t){var i=parseInt(a(this).attr("name"));e.columnAutoSize(i),t.stopPropagation(),t.preventDefault()})).each((e=>{var t=a(e).get(0).parentNode;a(e).css({height:t.clientHeight+"px","margin-left":t.clientWidth-3+"px"})}))}resizeBoxes(){var e=a(this.box).find(`#grid_${this.name}_header`),t=a(this.box).find(`#grid_${this.name}_toolbar`),i=a(this.box).find(`#grid_${this.name}_fsummary`),s=a(this.box).find(`#grid_${this.name}_summary`),l=a(this.box).find(`#grid_${this.name}_footer`),o=a(this.box).find(`#grid_${this.name}_body`);this.show.header&&e.css({top:"0px",left:"0px",right:"0px"}),this.show.toolbar&&t.css({top:0+(this.show.header?d.getSize(e,"height"):0)+"px",left:"0px",right:"0px"}),0<this.summary.length&&(i.css({bottom:0+(this.show.footer?d.getSize(l,"height"):0)+"px"}),s.css({bottom:0+(this.show.footer?d.getSize(l,"height"):0)+"px",right:"0px"})),this.show.footer&&l.css({bottom:"0px",left:"0px",right:"0px"}),o.css({top:0+(this.show.header?d.getSize(e,"height"):0)+(this.show.toolbar?d.getSize(t,"height"):0)+"px",bottom:0+(this.show.footer?d.getSize(l,"height"):0)+(0<this.summary.length?d.getSize(s,"height"):0)+"px",left:"0px",right:"0px"})}resizeRecords(){let e=this;a(this.box).find(".w2ui-empty-record").remove();var t,i=a(this.box),s=a(this.box).find(":scope > div.w2ui-grid-box"),l=a(this.box).find(`#grid_${this.name}_header`),o=a(this.box).find(`#grid_${this.name}_toolbar`),n=a(this.box).find(`#grid_${this.name}_summary`),r=a(this.box).find(`#grid_${this.name}_fsummary`),h=a(this.box).find(`#grid_${this.name}_footer`),c=a(this.box).find(`#grid_${this.name}_body`),u=a(this.box).find(`#grid_${this.name}_columns`),p=a(this.box).find(`#grid_${this.name}_fcolumns`),m=a(this.box).find(`#grid_${this.name}_records`),g=a(this.box).find(`#grid_${this.name}_frecords`),f=a(this.box).find(`#grid_${this.name}_scroll1`);let w=8*String(this.total).length+10,b=(w<34&&(w=34),null!=this.lineNumberWidth&&(w=this.lineNumberWidth),!1),y=!1,v=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(v+=parseInt(this.columns[e].sizeCalculated||this.columns[e].size));m[0]?.clientWidth<v&&(b=!0),c[0]?.clientHeight-(u[0]?.clientHeight??0)<(a(m).find(":scope > table")[0]?.clientHeight??0)+(b?d.scrollBarSize():0)&&(y=!0),this.fixedBody?(t=s[0]?.clientHeight-(this.show.header?d.getSize(l,"height"):0)-(this.show.toolbar?d.getSize(o,"height"):0)-("none"!=n.css("display")?d.getSize(n,"height"):0)-(this.show.footer?d.getSize(h,"height"):0),c.css("height",t+"px")):(l=(t=d.getSize(u,"height")+d.getSize(a(this.box).find("#grid_"+this.name+"_records table"),"height")+(b?d.scrollBarSize():0))+(this.show.header?d.getSize(l,"height"):0)+(this.show.toolbar?d.getSize(o,"height"):0)+("none"!=n.css("display")?d.getSize(n,"height"):0)+(this.show.footer?d.getSize(h,"height"):0),s.css("height",l+"px"),c.css("height",t+"px"),i.css("height",d.getSize(s,"height")+"px"));let x,k,C=this.records.length;if(o="object"!=typeof this.url?this.url:this.url.get,0==this.searchData.length||o||(C=this.last.searchIds.length),this.fixedBody||(y=!1),b||y?(u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",d.scrollBarSize()+"px").show(),m.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+d.getSize(u,"height")+"px","-webkit-overflow-scrolling":"touch","overflow-x":b?"auto":"hidden","overflow-y":y?"auto":"hidden"})):(u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").hide(),m.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+d.getSize(u,"height")+"px",overflow:"hidden"}),0<m.length&&(this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0)),b?(g.css("margin-bottom",d.scrollBarSize()+"px"),f.show()):(g.css("margin-bottom",0),f.hide()),g.css({overflow:"hidden",top:m.css("top")}),this.show.emptyRecords&&!y){let e=Math.floor((m[0]?.clientHeight??0)/this.recordHeight)-1,t=0;if((t=m[0]?m[0].scrollHeight-e*this.recordHeight:t)>=this.recordHeight&&(t-=this.recordHeight,e++),this.fixedBody){for(let t=C;t<e;t++)_(t,this.recordHeight,this);_(e,t,this)}}function _(e,t,i){let s="",l="";var o;s+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',l+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',i.show.lineNumbers&&(s+='<td class="w2ui-col-number"></td>'),i.show.selectColumn&&(s+='<td class="w2ui-grid-data w2ui-col-select"></td>'),i.show.expandColumn&&(s+='<td class="w2ui-grid-data w2ui-col-expand"></td>'),l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',i.reorderRows&&(l+='<td class="w2ui-grid-data w2ui-col-order" col="order"></td>');for(let e=0;e<i.columns.length;e++){var n=i.columns[e];(n.hidden||e<i.last.vscroll.colIndStart||e>i.last.vscroll.colIndEnd)&&!n.frozen||(o='<td class="w2ui-grid-data" '+(null!=n.attr?n.attr:"")+' col="'+e+'"></td>',n.frozen?s+=o:l+=o)}s+='<td class="w2ui-grid-data-last"></td> </tr>',l+='<td class="w2ui-grid-data-last" col="end"></td> </tr>',a(i.box).find("#grid_"+i.name+"_frecords > table").append(s),a(i.box).find("#grid_"+i.name+"_records > table").append(l)}if(0<c.length){let e=parseInt(c[0].clientWidth)-(y?d.scrollBarSize():0)-(this.show.lineNumbers?w:0)-(this.reorderRows?26:0)-(this.show.selectColumn?26:0)-(this.show.expandColumn?26:0)-1,t=(x=e,!1);for(let e=k=0;e<this.columns.length;e++){var E=this.columns[e];0<E.gridMinWidth&&(E.gridMinWidth>x&&!0!==E.hidden&&(E.hidden=!0,t=!0),E.gridMinWidth<x)&&!0===E.hidden&&(E.hidden=!1,t=!0)}if(!0===t)return void this.refresh();for(let t=0;t<this.columns.length;t++){var S=this.columns[t];S.hidden||("px"==String(S.size).substr(String(S.size).length-2).toLowerCase()?(e-=parseFloat(S.size),this.columns[t].sizeCalculated=S.size,this.columns[t].sizeType="px"):(k+=parseFloat(S.size),this.columns[t].sizeType="%",delete S.sizeCorrected))}if(100!=k&&0<k)for(let e=0;e<this.columns.length;e++){var T=this.columns[e];T.hidden||"%"==T.sizeType&&(T.sizeCorrected=Math.round(100*parseFloat(T.size)*100/k)/100+"%")}for(let t=0;t<this.columns.length;t++){var $=this.columns[t];$.hidden||"%"==$.sizeType&&(null!=this.columns[t].sizeCorrected?this.columns[t].sizeCalculated=Math.floor(e*parseFloat($.sizeCorrected)/100)-1+"px":this.columns[t].sizeCalculated=Math.floor(e*parseFloat($.size)/100)-1+"px")}}let A=0;for(let e=0;e<this.columns.length;e++){var j=this.columns[e];j.hidden||(null==j.min&&(j.min=20),parseInt(j.sizeCalculated)<parseInt(j.min)&&(j.sizeCalculated=j.min+"px"),parseInt(j.sizeCalculated)>parseInt(j.max)&&(j.sizeCalculated=j.max+"px"),A+=parseInt(j.sizeCalculated))}let M=parseInt(x)-parseInt(A);if(0<M&&0<k){let e=0;for(;;){var O=this.columns[e];if(null==O)e=0;else{if(!O.hidden&&"px"!=O.sizeType&&(O.sizeCalculated=parseInt(O.sizeCalculated)+1+"px",0==--M))break;e++}}}else 0<M&&u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",d.scrollBarSize()+"px").show();let I=1;this.show.lineNumbers&&(I+=w),this.show.selectColumn&&(I+=26),this.show.expandColumn&&(I+=26);for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||this.columns[e].frozen&&(I+=parseInt(this.columns[e].sizeCalculated));p.css("width",I+"px"),g.css("width",I+"px"),r.css("width",I+"px"),f.css("width",I+"px"),u.css("left",I+.5+"px"),m.css("left",I+"px"),n.css("left",I+"px"),u.find(":scope > table > tbody > tr:nth-child(1) td").add(p.find(":scope > table > tbody > tr:nth-child(1) td")).each((t=>{a(t).hasClass("w2ui-col-number")&&a(t).css("width",w+"px");var i=a(t).attr("col");if(null!=i){if("start"==i){let i=0;for(let t=0;t<e.last.vscroll.colIndStart;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));a(t).css("width",i+"px")}e.columns[i]&&a(t).css("width",e.columns[i].sizeCalculated)}if(a(t).hasClass("w2ui-head-last"))if(e.last.vscroll.colIndEnd+1<e.columns.length){let i=0;for(let t=e.last.vscroll.colIndEnd+1;t<e.columns.length;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));a(t).css("width",i+"px")}else a(t).css("width",d.scrollBarSize()+(0<M&&0===k?M:0)+"px")})),3==u.find(":scope > table > tbody > tr").length&&u.find(":scope > table > tbody > tr:nth-child(1) td").add(p.find(":scope > table > tbody > tr:nth-child(1) td")).html("").css({height:"0",border:"0",padding:"0",margin:"0"}),m.find(":scope > table > tbody > tr:nth-child(1) td").add(g.find(":scope > table > tbody > tr:nth-child(1) td")).each((t=>{a(t).hasClass("w2ui-col-number")&&a(t).css("width",w+"px");var i=a(t).attr("col");if(null!=i){if("start"==i){let i=0;for(let t=0;t<e.last.vscroll.colIndStart;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));a(t).css("width",i+"px")}e.columns[i]&&a(t).css("width",e.columns[i].sizeCalculated)}if(a(t).hasClass("w2ui-grid-data-last")&&0===a(t).parents(".w2ui-grid-frecords").length)if(e.last.vscroll.colIndEnd+1<e.columns.length){let i=0;for(let t=e.last.vscroll.colIndEnd+1;t<e.columns.length;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));a(t).css("width",i+"px")}else a(t).css("width",(0<M&&0===k?M:0)+"px")})),n.find(":scope > table > tbody > tr:nth-child(1) td").add(r.find(":scope > table > tbody > tr:nth-child(1) td")).each((t=>{a(t).hasClass("w2ui-col-number")&&a(t).css("width",w+"px");var i=a(t).attr("col");if(null!=i){if("start"==i){let i=0;for(let t=0;t<e.last.vscroll.colIndStart;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));a(t).css("width",i+"px")}e.columns[i]&&a(t).css("width",e.columns[i].sizeCalculated)}a(t).hasClass("w2ui-grid-data-last")&&0===a(t).parents(".w2ui-grid-frecords").length&&a(t).css("width",d.scrollBarSize()+(0<M&&0===k?M:0)+"px")})),this.initResize(),this.refreshRanges(),(this.last.vscroll.scrollTop||this.last.vscroll.scrollLeft)&&0<m.length&&(u.prop("scrollLeft",this.last.vscroll.scrollLeft),m.prop("scrollTop",this.last.vscroll.scrollTop),m.prop("scrollLeft",this.last.vscroll.scrollLeft)),u.css("will-change","scroll-position")}getSearchesHTML(){let e=`\n            <div class="search-title">\n                ${d.lang("Advanced Search")}\n                <span class="search-logic" style="${this.show.searchLogic?"":"display: none"}">\n                    <select id="grid_${this.name}_logic" class="w2ui-input">\n                        <option value="AND" ${"AND"==this.last.logic?"selected":""}>${d.lang("All")}</option>\n                        <option value="OR" ${"OR"==this.last.logic?"selected":""}>${d.lang("Any")}</option>\n                    </select>\n                </span>\n            </div>\n            <table cellspacing="0"><tbody>\n        `;for(let s=0;s<this.searches.length;s++){var t=this.searches[s];if(t.type=String(t.type).toLowerCase(),!t.hidden){null==t.attr&&(t.attr=""),null==t.text&&(t.text=""),null==t.style&&(t.style=""),null==t.type&&(t.type="text"),null==t.label&&null!=t.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",t),t.label=t.caption);var i=`<select id="grid_${this.name}_operator_${s}" class="w2ui-input" data-change="initOperator|${s}">\n                    ${this.getOperators(t.type,t.operators)}\n                </select>`;let l;switch(e+=`<tr>\n                        <td class="caption">${d.lang(t.label??t.field)||""}</td>\n                        <td class="operator">${i}</td>\n                        <td class="value">`,t.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":l="width: 250px;",-1!=["hex","color"].indexOf(t.type)&&(l="width: 90px;"),e+=`<input rel="search" type="text" id="grid_${this.name}_field_${s}" name="${t.field}"\n                               class="w2ui-input" style="${l+t.style}" ${t.attr}>`;break;case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":l="width: 90px;","datetime"==t.type&&(l="width: 140px;"),e+=`<input id="grid_${this.name}_field_${s}" name="${t.field}" ${t.attr} rel="search" type="text"\n                                class="w2ui-input" style="${l+t.style}">\n                            <span id="grid_${this.name}_range_${s}" style="display: none">&#160;-&#160;&#160;\n                                <input rel="search" type="text" class="w2ui-input" style="${l+t.style}" id="grid_${this.name}_field2_${s}" name="${t.field}" ${t.attr}>\n                            </span>`;break;case"select":e+=`<select rel="search" class="w2ui-input" style="${t.style}" id="grid_${this.name}_field_${s}"\n                                name="${t.field}" ${t.attr}></select>`}e+=t.text+"    </td></tr>"}}return e+`<tr>\n            <td colspan="2" class="actions">\n                <button type="button" class="w2ui-btn close-btn" data-click="searchClose">${d.lang("Close")}</button>\n            </td>\n            <td class="actions">\n                <button type="button" class="w2ui-btn" data-click="searchReset">${d.lang("Reset")}</button>\n                <button type="button" class="w2ui-btn w2ui-btn-blue" data-click="search">${d.lang("Search")}</button>\n            </td>\n        </tr></tbody></table>`}getOperators(e,t){let i=this.operators[this.operatorsMap[e]]||[],s=(null!=t&&Array.isArray(t)&&(i=t),"");return i.forEach((e=>{let t=e,i=e;Array.isArray(e)?(t=e[1],i=e[0]):d.isPlainObject(e)&&(t=e.text,i=e.oper),null==t&&(t=e),s+=`<option name="11" value="${i}">${d.lang(t)}</option>\n`})),s}initOperator(e){let t;var i=this.searches[e],s=this.getSearchData(i.field),l=a(`#w2overlay-${this.name}-search-overlay`),o=l.find(`#grid_${this.name}_range_`+e);let n=l.find(`#grid_${this.name}_field_`+e),r=l.find(`#grid_${this.name}_field2_`+e);var h=l.find(`#grid_${this.name}_operator_`+e).val();switch(n.show(),o.hide(),h){case"between":o.css("display","inline");break;case"null":case"not null":n.hide(),n.val(h),n.trigger("change")}switch(i.type){case"text":case"alphanumeric":var c=n[0]._w2field;c&&c.reset();break;case"int":case"float":case"hex":case"color":case"money":case"currency":case"percent":case"date":case"time":case"datetime":n[0]._w2field||(new S(i.type,{el:n[0],...i.options}),new S(i.type,{el:r[0],...i.options}),setTimeout((()=>{n.trigger("keydown"),r.trigger("keydown")}),1));break;case"list":case"combo":case"enum":t=i.options,"list"==i.type&&(t.selected={}),"enum"==i.type&&(t.selected=[]),s&&(t.selected=s.value),n[0]._w2field||(c=new S(i.type,{el:n[0],...t}),s&&null!=s.text&&c.set({id:s.value,text:s.text}));break;case"select":t='<option value="">--</option>';for(let e=0;e<i.options.items.length;e++){var u=i.options.items[e];if(d.isPlainObject(i.options.items[e])){let e=u.id,i=u.text;null==e&&null!=u.value&&(e=u.value),null==i&&null!=u.text&&(i=u.text),null==e&&(e=""),t+='<option value="'+e+'">'+i+"</option>"}else t+='<option value="'+u+'">'+u+"</option>"}n.html(t)}}initSearches(){var e=a(`#w2overlay-${this.name}-search-overlay`);for(let l=0;l<this.searches.length;l++){var t=this.searches[l],i=this.getSearchData(t.field);t.type=String(t.type).toLowerCase(),"object"!=typeof t.options&&(t.options={});let o=t.operator,n=[...this.operators[this.operatorsMap[t.type]]];t.operators&&(n=t.operators),d.isPlainObject(o)&&(o=o.oper),n.forEach(((e,t)=>{d.isPlainObject(e)&&(n[t]=e.oper)})),i&&i.operator&&(o=i.operator),t=this.defaultOperator[this.operatorsMap[t.type]],-1==n.indexOf(o)&&(o=t),e.find(`#grid_${this.name}_operator_`+l).val(o),this.initOperator(l),t=e.find(`#grid_${this.name}_field_`+l);var s=e.find(`#grid_${this.name}_field2_`+l);null!=i&&(Array.isArray(i.value)?["in","not in"].includes(i.operator)?t[0]._w2field.set(i.value):(t.val(i.value[0]).trigger("change"),s.val(i.value[1]).trigger("change")):null!=i.value&&t.val(i.value).trigger("change"))}e.find(".w2ui-grid-search-advanced *[rel=search]").on("keypress",(e=>{13==e.keyCode&&(this.search(),g.hide(this.name+"-search-overlay"))}))}getColumnsHTML(){let e=this,t="",i="";var s,l,o;return this.show.columnHeaders&&(i=0<this.columnGroups.length?(o=n(!0),s=function(){let t="<tr>",i="<tr>",s="",l=e.columnGroups.length-1;null==e.columnGroups[l].text&&null!=e.columnGroups[l].caption&&(console.log("NOTICE: grid columnGroup.caption property is deprecated, please use columnGroup.text. Group -> ",e.columnGroups[l]),e.columnGroups[l].text=e.columnGroups[l].caption),""!=e.columnGroups[e.columnGroups.length-1].text&&e.columnGroups.push({text:""}),e.show.lineNumbers&&(t+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>&#160;</div></td>'),e.show.selectColumn&&(t+='<td class="w2ui-head w2ui-col-select" col="select">    <div style="height: 25px">&#160;</div></td>'),e.show.expandColumn&&(t+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div style="height: 25px">&#160;</div></td>');let o=0;i+=`<td id="grid_${e.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`,e.reorderRows&&(i+='<td class="w2ui-head w2ui-col-order" col="order">    <div style="height: 25px">&#160;</div></td>');for(let l=0;l<e.columnGroups.length;l++){var n=e.columnGroups[l],a=e.columns[o]||{};null!=n.colspan&&(n.span=n.colspan),null!=n.span&&n.span==parseInt(n.span)||(n.span=1),null==a.text&&null!=a.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column ->",a),a.text=a.caption);let h=0;for(let t=o;t<o+n.span;t++)e.columns[t]&&!e.columns[t].hidden&&h++;if(!((h=l==e.columnGroups.length-1?100:h)<=0)){if(!0===n.main){let t="";for(let i=0;i<e.sortData.length;i++)e.sortData[i].field==a.field&&("asc"===(e.sortData[i].direction||"").toLowerCase()&&(t="w2ui-sort-up"),"desc"===(e.sortData[i].direction||"").toLowerCase())&&(t="w2ui-sort-down");let i="";!1!==a.resizable&&(i=`<div class="w2ui-resizer" name="${o}"></div>`);var r=d.lang("function"==typeof a.text?a.text(a):a.text);s=`<td id="grid_${e.name}_column_${o}" class="w2ui-head ${t}" col="${o}"     rowspan="2" colspan="${h}">`+i+`    <div class="w2ui-col-group w2ui-col-header ${t?"w2ui-col-sorted":""}">`+`        <div class="${t}"></div>`+(r||"&#160;")+"    </div></td>"}else r=d.lang("function"==typeof n.text?n.text(n):n.text),s=`<td id="grid_${e.name}_column_${o}" class="w2ui-head" col="${o}" colspan="${h}">    <div class="w2ui-col-group" style="${n.style??""}">${r||"&#160;"}</div></td>`;a&&a.frozen?t+=s:i+=s}o+=n.span}return t+="<td></td></tr>",i+=`<td id="grid_${e.name}_column_end" class="w2ui-head" col="end"></td></tr>`,[t,i]}(),l=n(!1),t=o[0]+s[0]+l[0],o[1]+s[1]+l[1]):(t=(o=n(!0))[0],o[1])),[t,i];function n(t){let i,s="<tr>",l="<tr>",o=(e.show.lineNumbers&&(s+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>#</div></td>'),e.show.selectColumn&&(s+=`<td class="w2ui-head w2ui-col-select" col="select">    <div>        <input type="checkbox" id="grid_${e.name}_check_all" class="w2ui-select-all" tabindex="-1"            style="${0==e.multiSelect?"display: none;":""}"        >    </div></td>`),e.show.expandColumn&&(s+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div>&#160;</div></td>'),0),n=0;l+=`<td id="grid_${e.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`,e.reorderRows&&(l+='<td class="w2ui-head w2ui-col-order" col="order">    <div>&#160;</div></td>');for(let d=0;d<e.columns.length;d++){var a,r=e.columns[d];null==r.text&&null!=r.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column -> ",r),r.text=r.caption),null==r.size&&(r.size="100%"),d==n&&(i=e.columnGroups[o++]||{},n+=i.span),(d<e.last.vscroll.colIndStart||d>e.last.vscroll.colIndEnd)&&!r.frozen||r.hidden||!0===i.main&&!t||(a=e.getColumnCellHTML(d),r&&r.frozen?s+=a:l+=a)}return s+='<td class="w2ui-head w2ui-head-last"><div>&#160;</div></td>',l+='<td class="w2ui-head w2ui-head-last" col="end"><div>&#160;</div></td>',s+="</tr>",l+="</tr>",[s,l]}}getColumnCellHTML(e){var t=this.columns[e];if(null==t)return"";var i=!this.reorderColumns||this.columnGroups&&this.columnGroups.length?"":" w2ui-col-reorderable ";let s="";for(let e=0;e<this.sortData.length;e++)this.sortData[e].field==t.field&&("asc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-up"),"desc"===(this.sortData[e].direction||"").toLowerCase())&&(s="w2ui-sort-down");var l,o=this.last.selection.columns;let n=!1;for(l in o)for(let t=0;t<o[l].length;t++)o[l][t]==e&&(n=!0);var a=d.lang("function"==typeof t.text?t.text(t):t.text);return'<td id="grid_'+this.name+"_column_"+e+'" col="'+e+'" class="w2ui-head '+s+i+'">'+(!1!==t.resizable?'<div class="w2ui-resizer" name="'+e+'"></div>':"")+'    <div class="w2ui-col-header '+(s?"w2ui-col-sorted":"")+" "+(n?"w2ui-col-selected":"")+'">        <div class="'+s+'"></div>'+(a||"&#160;")+"    </div></td>"}columnTooltipShow(e,t){var i=a(this.box).find("#grid_"+this.name+"_column_"+e),s=(e=this.columns[e],this.columnTooltip);g.show({name:this.name+"-column-tooltip",anchor:i.get(0),html:e?.tooltip,position:s})}columnTooltipHide(e,t){g.hide(this.name+"-column-tooltip")}getRecordsHTML(){let e=this.records.length;var t="object"!=typeof this.url?this.url:this.url.get;(e=0==this.searchData.length||t?e:this.last.searchIds.length)>this.vs_start?this.last.vscroll.show_extra=this.vs_extra:this.last.vscroll.show_extra=this.vs_start,t=a(this.box).find(`#grid_${this.name}_records`);let i=Math.floor((t.get(0)?.clientHeight||0)/this.recordHeight)+this.last.vscroll.show_extra+1;i<this.vs_start&&(i=this.vs_start),(!this.fixedBody||i>e)&&(i=e);var s=this.getRecordHTML(-1,0);let l="<table><tbody>"+s[0],o="<table><tbody>"+s[1];l+='<tr id="grid_'+this.name+'_frec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>',o+='<tr id="grid_'+this.name+'_rec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>';for(let e=0;e<i;e++)l+=(s=this.getRecordHTML(e,e+1))[0],o+=s[1];return t=(e-i)*this.recordHeight,l+='<tr id="grid_'+this.name+'_frec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_frec_more" style="display: none; ">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',o+='<tr id="grid_'+this.name+'_rec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_rec_more" style="display: none">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',this.last.vscroll.recIndStart=0,this.last.vscroll.recIndEnd=i,[l,o]}getSummaryHTML(){if(0!==this.summary.length){var e=this.getRecordHTML(-1,0);let t="<table><tbody>"+e[0],i="<table><tbody>"+e[1];for(let s=0;s<this.summary.length;s++)t+=(e=this.getRecordHTML(s,s+1,!0))[0],i+=e[1];return t+="</tbody></table>",i+="</tbody></table>",[t,i]}}scroll(e){let t=this;var i="object"!=typeof this.url?this.url:this.url.get,s=a(this.box).find(`#grid_${this.name}_records`),l=a(this.box).find(`#grid_${this.name}_frecords`);e&&(x=e.target.scrollTop,e=e.target.scrollLeft,this.last.vscroll.scrollTop=x,this.last.vscroll.scrollLeft=e,u=a(this.box).find(`#grid_${this.name}_columns`)[0],p=a(this.box).find(`#grid_${this.name}_summary`)[0],u&&(u.scrollLeft=e),p&&(p.scrollLeft=e),l[0])&&(l[0].scrollTop=x),this.last.bubbleEl&&(g.hide(this.name+"-bubble"),this.last.bubbleEl=null);let o=null,n=null;if(this.disableCVS||0<this.columnGroups.length)o=0,n=this.columns.length-1;else{var r,h=s.prop("clientWidth");let e=0;for(let t=0;t<this.columns.length;t++)this.columns[t].frozen||this.columns[t].hidden||(e+(r=parseInt(this.columns[t].sizeCalculated||this.columns[t].size))+30>this.last.vscroll.scrollLeft&&null==o&&(o=t),e+r-30>this.last.vscroll.scrollLeft+h&&null==n&&(n=t),e+=r);null==n&&(n=this.columns.length-1)}if(null!=o&&(o<0&&(o=0),n<0&&(n=0),o==n&&(0<o?o--:n++),o!=this.last.vscroll.colIndStart||n!=this.last.vscroll.colIndEnd)){var c=a(this.box),u=Math.abs(o-this.last.vscroll.colIndStart),p=Math.abs(n-this.last.vscroll.colIndEnd);if(u<5&&p<5){var m=c.find(`.w2ui-grid-columns #grid_${this.name}_column_start`),f=c.find(".w2ui-grid-columns .w2ui-head-last"),w=c.find(`#grid_${this.name}_records .w2ui-grid-data-spacer`),b=c.find(`#grid_${this.name}_records .w2ui-grid-data-last`),y=c.find(`#grid_${this.name}_summary .w2ui-grid-data-spacer`),v=c.find(`#grid_${this.name}_summary .w2ui-grid-data-last`);if(o>this.last.vscroll.colIndStart)for(let e=this.last.vscroll.colIndStart;e<o;e++)c.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),c.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),c.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(n<this.last.vscroll.colIndEnd)for(let e=this.last.vscroll.colIndEnd;e>n;e--)c.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),c.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),c.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(o<this.last.vscroll.colIndStart)for(let e=this.last.vscroll.colIndStart-1;e>=o;e--)this.columns[e]&&(this.columns[e].frozen||this.columns[e].hidden)||(m.after(this.getColumnCellHTML(e)),w.each((t=>{var i=a(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),e,!1)),a(t).after(s)})),y.each((t=>{var i=a(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),e,!0)),a(t).after(s)})));if(n>this.last.vscroll.colIndEnd)for(let e=this.last.vscroll.colIndEnd+1;e<=n;e++)this.columns[e]&&(this.columns[e].frozen||this.columns[e].hidden)||(f.before(this.getColumnCellHTML(e)),b.each((t=>{var i=a(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),e,!1)),a(t).before(s)})),v.each((t=>{var i=a(t).parent().attr("index")||-1;i=this.getCellHTML(parseInt(i),e,!0),a(t).before(i)})));this.last.vscroll.colIndStart=o,this.last.vscroll.colIndEnd=n}else{this.last.vscroll.colIndStart=o,this.last.vscroll.colIndEnd=n,e=this.getColumnsHTML();var x=this.getRecordsHTML();u=this.getSummaryHTML(),p=c.find(`#grid_${this.name}_columns`);let t=c.find(`#grid_${this.name}_records`);var k=c.find(`#grid_${this.name}_frecords`);let i=c.find(`#grid_${this.name}_summary`);p.find("tbody").html(e[1]),k.html(x[0]),t.prepend(x[1]),null!=u&&i.html(u[1]),setTimeout((()=>{t.find(":scope > table").filter(":not(table:first-child)").remove(),i[0]&&(i[0].scrollLeft=this.last.vscroll.scrollLeft)}),1)}this.resizeRecords()}let C=this.records.length;if(C>this.total&&-1!==this.total&&(C=this.total),0!==(C=0==this.searchData.length||i?C:this.last.searchIds.length)&&0!==s.length&&0!==s.prop("clientHeight")){C>this.vs_start?this.last.vscroll.show_extra=this.vs_extra:this.last.vscroll.show_extra=this.vs_start;let o=Math.round(s.prop("scrollTop")/this.recordHeight+1),n=o+(Math.round(s.prop("clientHeight")/this.recordHeight)-1);if(o>C&&(o=C),n>=C-1&&(n=C),a(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right").html((this.show.statusRange?d.formatNumber(this.offset+o)+"-"+d.formatNumber(this.offset+n)+(-1!=this.total?" "+d.lang("of")+' <span class="w2ui-total">'+d.formatNumber(this.total)+"</span>":""):"")+(i&&this.show.statusBuffered?" ("+d.lang("buffered")+' <span class="w2ui-buffered">'+d.formatNumber(C)+"</span>"+(0<this.offset?', skip <span class="w2ui-skip">'+d.formatNumber(this.offset):"")+"</span>)":"")),i||this.fixedBody&&!(-1!=this.total&&this.total<=this.vs_start)){let i=Math.floor(s.prop("scrollTop")/this.recordHeight)-this.last.vscroll.show_extra,o=i+Math.floor(s.prop("clientHeight")/this.recordHeight)+2*this.last.vscroll.show_extra+1;i<1&&(i=1),o>this.total&&-1!=this.total&&(o=this.total);var _=s.find("#grid_"+this.name+"_rec_top"),E=s.find("#grid_"+this.name+"_rec_bottom"),S=l.find("#grid_"+this.name+"_frec_top"),T=l.find("#grid_"+this.name+"_frec_bottom");let n,r,h,c,u;if(-1!=String(_.next().prop("id")).indexOf("_expanded_row")&&(_.next().remove(),S.next().remove()),this.total>o&&-1!=String(E.prev().prop("id")).indexOf("_expanded_row")&&(E.prev().remove(),T.prev().remove()),p=parseInt(_.next().attr("line")),e=parseInt(E.prev().attr("line")),p<=i||1==p||this.last.vscroll.pull_refresh){if(o<=e+this.last.vscroll.show_extra-2&&o!=this.total)return;for(this.last.vscroll.pull_refresh=!1;r=l.find("#grid_"+this.name+"_frec_top").next(),"bottom"!=(h=s.find("#grid_"+this.name+"_rec_top").next()).attr("line")&&parseInt(h.attr("line"))<i;)r.remove(),h.remove();n=s.find("#grid_"+this.name+"_rec_bottom").prev(),"top"==(c=n.attr("line"))&&(c=i);for(let e=parseInt(c)+1;e<=o;e++)this.records[e-1]&&((h=this.records[e-1].w2ui)&&!Array.isArray(h.children)&&(h.expanded=!1),u=this.getRecordHTML(e-1,e),E.before(u[1]),T.before(u[0]))}else{if(i>=p-this.last.vscroll.show_extra+2&&1<i)return;for(;r=l.find("#grid_"+this.name+"_frec_bottom").prev(),"top"!=(h=s.find("#grid_"+this.name+"_rec_bottom").prev()).attr("line")&&parseInt(h.attr("line"))>o;)r.remove(),h.remove();n=s.find("#grid_"+this.name+"_rec_top").next(),"bottom"==(c=n.attr("line"))&&(c=o);for(let e=parseInt(c)-1;e>=i;e--)this.records[e-1]&&((h=this.records[e-1].w2ui)&&!Array.isArray(h.children)&&(h.expanded=!1),u=this.getRecordHTML(e-1,e),_.after(u[1]),S.after(u[0]))}t.markSearch&&(clearTimeout(t.last.marker_timer),t.last.marker_timer=setTimeout((()=>{var e=[];for(let l=0;l<t.searchData.length;l++){var i=t.searchData[l],s=t.getSearch(i.field);s&&!s.hidden&&(s=t.getColumn(i.field,!0),e.push({field:i.field,search:i.value,col:s}))}0<e.length&&e.forEach((e=>{var i=a(t.box).find('td[col="'+e.col+'"]:not(.w2ui-head)');d.marker(i,e.search)}))}),50)),setTimeout((()=>{this.refreshRanges()}),0),k=(i-1)*this.recordHeight;let m=(C-o)*this.recordHeight;m<0&&(m=0),_.css("height",k+"px"),S.css("height",k+"px"),E.css("height",m+"px"),T.css("height",m+"px"),this.last.vscroll.recIndStart=i,this.last.vscroll.recIndEnd=o,Math.floor(s.prop("scrollTop")/this.recordHeight)+Math.floor(s.prop("clientHeight")/this.recordHeight)+10>C&&!0!==this.last.vscroll.pull_more&&(C<this.total-this.offset||-1==this.total&&this.last.fetch.hasMore)&&(!0===this.autoLoad&&(this.last.vscroll.pull_more=!0,this.last.fetch.offset+=this.limit,this.request("load")),a(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").show().eq(1).off(".load-more").on("click.load-more",(function(){a(this).find("td").html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>'),t.last.vscroll.pull_more=!0,t.last.fetch.offset+=t.limit,t.request("load")})).find("td").html(t.autoLoad?'<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>':'<div style="padding-top: 15px">'+d.lang("Load ${count} more...",{count:t.limit})+"</div>"))}}}getRecordHTML(e,t,i){let s="",l="";var o=this.last.selection;let n;if(-1==e){s+='<tr line="0">',l+='<tr line="0">',this.show.lineNumbers&&(s+='<td class="w2ui-col-number" style="height: 0px"></td>'),this.show.selectColumn&&(s+='<td class="w2ui-col-select" style="height: 0px"></td>'),this.show.expandColumn&&(s+='<td class="w2ui-col-expand" style="height: 0px"></td>'),l+='<td class="w2ui-grid-data w2ui-grid-data-spacer" col="start" style="height: 0px; width: 0px"></td>',this.reorderRows&&(l+='<td class="w2ui-col-order" style="height: 0px"></td>');for(let e=0;e<this.columns.length;e++){var a=this.columns[e],r='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px;"></td>';a.frozen&&!a.hidden?s+=r:a.hidden||e<this.last.vscroll.colIndStart||e>this.last.vscroll.colIndEnd||(l+=r)}s+='<td class="w2ui-grid-data-last" style="height: 0px"></td>',l+='<td class="w2ui-grid-data-last" col="end" style="height: 0px"></td>'}else{var d="object"!=typeof this.url?this.url:this.url.get;if(!0!==i){if(0<this.searchData.length&&!d){if(e>=this.last.searchIds.length)return"";e=this.last.searchIds[e]}else if(e>=this.records.length)return"";n=this.records[e]}else{if(e>=this.summary.length)return"";n=this.summary[e]}if(!n)return"";null==n.recid&&null!=this.recid&&null!=(d=this.parseField(n,this.recid))&&(n.recid=d);let a=!1,r=(-1!=o.indexes.indexOf(e)&&(a=!0),n.w2ui?n.w2ui.style:""),m=(null!=r&&"string"==typeof r||(r=""),n.w2ui?n.w2ui.class:"");if(null!=m&&"string"==typeof m||(m=""),s+='<tr id="grid_'+this.name+"_frec_"+n.recid+'" recid="'+n.recid+'" line="'+t+'" index="'+e+'"  class="'+(t%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+m+(a&&"row"==this.selectType?" w2ui-selected":"")+(n.w2ui&&!1===n.w2ui.editable?" w2ui-no-edit":"")+(n.w2ui&&!0===n.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(a||""==r?r.replace("background-color","none"):r)+'" '+(""!=r?'custom_style="'+r+'"':"")+">",l+='<tr id="grid_'+this.name+"_rec_"+n.recid+'" recid="'+n.recid+'" line="'+t+'" index="'+e+'"  class="'+(t%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+m+(a&&"row"==this.selectType?" w2ui-selected":"")+(n.w2ui&&!1===n.w2ui.editable?" w2ui-no-edit":"")+(n.w2ui&&!0===n.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(a||""==r?r.replace("background-color","none"):r)+'" '+(""!=r?'custom_style="'+r+'"':"")+">",this.show.lineNumbers&&(s+='<td id="grid_'+this.name+"_cell_"+e+"_number"+(i?"_s":"")+'"    class="w2ui-col-number '+(a?" w2ui-row-selected":"")+'"'+(this.reorderRows?' style="cursor: move"':"")+">"+(!0!==i?this.getLineHTML(t,n):"")+"</td>"),this.show.selectColumn&&(s+='<td id="grid_'+this.name+"_cell_"+e+"_select"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-select">'+(!0===i||n.w2ui&&!0===n.w2ui.hideCheckBox?"":'    <div>        <input class="w2ui-grid-select-check" type="checkbox" tabindex="-1" '+(a?'checked="checked"':"")+' style="pointer-events: none"/>    </div>')+"</td>"),this.show.expandColumn){let t="";t=!0===n.w2ui?.expanded?"-":"+","none"!=n.w2ui?.expanded&&Array.isArray(n.w2ui?.children)&&n.w2ui?.children.length||(t="+"),"spinner"==n.w2ui?.expanded&&(t='<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>'),s+='<td id="grid_'+this.name+"_cell_"+e+"_expand"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-expand">'+(!0!==i?`<div>${t}</div>`:"")+"</td>"}l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',this.reorderRows&&(l+='<td id="grid_'+this.name+"_cell_"+e+"_order"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-order" col="order">'+(!0!==i?'<div title="Drag to reorder">&nbsp;</div>':"")+"</td>");let g=0,f=0;for(;;){let t=1;var h,c=this.columns[g];if(null==c)break;if(c.hidden)g++,0<f&&f--;else if(0<f){if(g++,null==this.columns[g])break;n.w2ui.colspan[this.columns[g-1].field]=0,f--}else{if(n.w2ui&&(p=n.w2ui.colspan,h=this.columns[g].field,p)&&0===p[h]&&delete p[h],!(g<this.last.vscroll.colIndStart||g>this.last.vscroll.colIndEnd)||c.frozen){if(n.w2ui&&"object"==typeof n.w2ui.colspan){var u=parseInt(n.w2ui.colspan[c.field])||null;if(1<u){let e=0;for(let t=g;t<g+u&&!(t>=this.columns.length);t++)this.columns[t].hidden&&e++;t=u-e,f=u-1}}var p=this.getCellHTML(e,g,i,t);c.frozen?s+=p:l+=p}g++}}s+='<td class="w2ui-grid-data-last"></td>',l+='<td class="w2ui-grid-data-last" col="end"></td>'}return s+="</tr>",l+="</tr>",[s,l]}getLineHTML(e){return"<div>"+e+"</div>"}getCellHTML(e,t,i,s){let l=this,o=this.columns[t];if(null==o)return"";let n=(!0!==i?this.records:this.summary)[e],{value:a,style:r,className:h,attr:c,divAttr:u}=this.getCellValue(e,t,i,!0);var p=-1!==e?this.getCellEditable(e,t):"";let m="max-height: "+parseInt(this.recordHeight)+"px;"+(o.clipboardCopy?"margin-right: 20px":"");var g=!i&&n?.w2ui?.changes&&null!=n.w2ui.changes[o.field],f=this.last.selection;let w=!1,b="";if(-1!=f.indexes.indexOf(e)&&(w=!0),null==s&&(s=n?.w2ui?.colspan&&n.w2ui.colspan[o.field]?n.w2ui.colspan[o.field]:1),0===t&&Array.isArray(n?.w2ui?.children)){let e=0,t=this.get(n.w2ui.parent_recid,!0);for(;null!=t;){e++;var y=this.records[t].w2ui;if(null==y||null==y.parent_recid)break;t=this.get(y.parent_recid,!0)}if(n.w2ui.parent_recid)for(let t=0;t<e;t++)b+='<span class="w2ui-show-children w2ui-icon-empty"></span>';var v=0<n.w2ui.children.length?n.w2ui.expanded?"w2ui-icon-collapse":"w2ui-icon-expand":"w2ui-icon-empty";b+=`<span class="w2ui-show-children ${v}"></span>`}if(!0===o.info&&(o.info={}),null!=o.info){let s="w2ui-icon-info",l=("function"==typeof o.info.icon?s=o.info.icon(n,{self:this,index:e,colIndex:t,summary:!!i}):"object"==typeof o.info.icon?s=o.info.icon[this.parseField(n,o.field)]||"":"string"==typeof o.info.icon&&(s=o.info.icon),o.info.style||"");"function"==typeof o.info.style?l=o.info.style(n,{self:this,index:e,colIndex:t,summary:!!i}):"object"==typeof o.info.style?l=o.info.style[this.parseField(n,o.field)]||"":"string"==typeof o.info.style&&(l=o.info.style),b+=`<span class="w2ui-info ${s}" style="${l}"></span>`}let x,k=a,C=(p&&-1!=["checkbox","check"].indexOf(p.type)&&(m+="text-align: center;",k=`<input tabindex="-1" type="checkbox" class="w2ui-editable-checkbox"\n                            data-changeInd="${i?-(e+1):e}" data-colInd="${t}" ${k?'checked="checked"':""}>`,b=""),null==(k=`<div style="${m}" ${function(s){let a;return l.show.recordTitles&&(null!=o.title?("function"==typeof o.title&&(a=o.title.call(l,n,{self:this,index:e,colIndex:t,summary:!!i})),"string"==typeof o.title&&(a=o.title)):a=d.stripTags(String(s).replace(/"/g,"''"))),null!=a?'title="'+String(a)+'"':""}(k)} ${u}>${b}${String(k)}</div>`)&&(k=""),"string"==typeof o.render&&(v=o.render.toLowerCase().split(":"),-1!=["number","int","float","money","currency","percent","size"].indexOf(v[0]))&&(r+="text-align: right;"),n?.w2ui&&("object"==typeof n.w2ui.style&&("string"==typeof n.w2ui.style[t]&&(r+=n.w2ui.style[t]+";"),"string"==typeof n.w2ui.style[o.field])&&(r+=n.w2ui.style[o.field]+";"),"object"==typeof n.w2ui.class)&&("string"==typeof n.w2ui.class[t]&&(h+=n.w2ui.class[t]+" "),"string"==typeof n.w2ui.class[o.field])&&(h+=n.w2ui.class[o.field]+" "),!1);return w&&f.columns[e]?.includes(t)&&(C=!0),o.clipboardCopy&&(x='<span class="w2ui-clipboard-copy w2ui-icon-paste"></span>'),k='<td class="w2ui-grid-data'+(C?" w2ui-selected":"")+" "+h+(g?" w2ui-changed":"")+'"    id="grid_'+this.name+"_data_"+e+"_"+t+'" col="'+t+'"    style="'+r+(null!=o.style?o.style:"")+'" '+(null!=o.attr?o.attr:"")+c+(1<s?'colspan="'+s+'"':"")+">"+k+(x&&d.stripTags(k)?x:"")+"</td>",-1===e&&!0===i?'<td class="w2ui-grid-data" col="'+t+'" style="height: 0px; '+r+'" '+(1<s?'colspan="'+s+'"':"")+"></td>":k}clipboardCopy(e,t,i){var s=(i?this.summary:this.records)[e],l=this.columns[t];let o=l?this.parseField(s,l.field):"";"function"==typeof l.clipboardCopy&&(o=l.clipboardCopy(s,{self:this,index:e,colIndex:t,summary:!!i})),a(this.box).find("#grid_"+this.name+"_focus").text(o).get(0).select(),document.execCommand("copy")}showBubble(e,t,i){var s=this.columns[t].info;if(s){let p="";var l=this.records[e],o=a(this.box).find(`${i?".w2ui-grid-summary":""} #grid_${this.name}_data_${e}_${t} .w2ui-info`);if(this.last.bubbleEl&&g.hide(this.name+"-bubble"),this.last.bubbleEl=o,null==s.fields){s.fields=[];for(let e=0;e<this.columns.length;e++){var n=this.columns[e];s.fields.push(n.field+("string"==typeof n.render?":"+n.render:""))}}let m=s.fields;if("function"==typeof m&&(m=m(l,{self:this,index:e,colIndex:t,summary:!!i})),"function"==typeof s.render)p=s.render(l,{self:this,index:e,colIndex:t,summary:!!i});else if(Array.isArray(m)){p='<table cellpadding="0" cellspacing="0">';for(let e=0;e<m.length;e++){var r=String(m[e]).split(":");if(""==r[0]||"-"==r[0]||"--"==r[0]||"---"==r[0])p+='<tr><td colspan=2><div style="border-top: '+(""==r[0]?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';else{let e=this.getColumn(r[0]),t=(e=null==e?{field:r[0],caption:r[0]}:e)?this.parseField(l,e.field):"";1<r.length&&(d.formatters[r[1]]?t=d.formatters[r[1]](t,r[2]||null,l):console.log('ERROR: w2utils.formatters["'+r[1]+'"] does not exists.')),(!0===s.showEmpty||null!=t&&""!=t)&&(null!=s.maxLength&&"string"==typeof t&&t.length>s.maxLength&&(t=t.substr(0,s.maxLength)+"..."),p+="<tr><td>"+e.text+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}}p+="</table>"}else if(d.isPlainObject(m)){for(var h in p='<table cellpadding="0" cellspacing="0">',m){var c=m[h];if(""==c||"-"==c||"--"==c||"---"==c)p+='<tr><td colspan=2><div style="border-top: '+(""==c?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';else{var u=String(c).split(":");let o=this.getColumn(u[0]),n=(o=null==o?{field:u[0],caption:u[0]}:o)?this.parseField(l,o.field):"";1<u.length&&(d.formatters[u[1]]?n=d.formatters[u[1]](n,u[2]||null,l):console.log('ERROR: w2utils.formatters["'+u[1]+'"] does not exists.')),"function"==typeof c&&(n=c(l,{self:this,index:e,colIndex:t,summary:!!i})),(!0===s.showEmpty||null!=n&&""!=n)&&(null!=s.maxLength&&"string"==typeof n&&n.length>s.maxLength&&(n=n.substr(0,s.maxLength)+"..."),p+="<tr><td>"+h+"</td><td>"+((0===n?"0":n)||"")+"</td></tr>")}}p+="</table>"}return g.show(d.extend({name:this.name+"-bubble",html:p,anchor:o.get(0),position:"top|bottom",class:"w2ui-info-bubble",style:"",hideOn:["doc-click"]},s.options??{})).hide((()=>[this.last.bubbleEl=null]))}}getCellEditable(e,t){var i=this.columns[t],s=this.records[e];if(!s||!i)return null;let l=s.w2ui?s.w2ui.editable:null;return!1===l?null:(null!=l&&!0!==l||"function"==typeof(l=0<Object.keys(i.editable??{}).length?i.editable:null)&&(i=this.getCellValue(e,t,!1),l=l.call(this,s,{self:this,value:i,index:e,colIndex:t})),l)}getCellValue(e,t,i,s){var l=this.columns[t],o=(!0!==i?this.records:this.summary)[e];let n=this.parseField(o,l.field),a="",r="",h="",c="";if(null!=o?.w2ui?.changes?.[l.field]&&(n=o.w2ui.changes[l.field]),null!=l.render&&-1!==e){if("function"==typeof l.render&&null!=o){let d;try{d=l.render.call(this,o,{self:this,value:n,index:e,colIndex:t,summary:!!i})}catch(s){throw new Error(`Render function for column "${l.field}" in grid "${this.name}": -- `+s.message)}null!=d&&"object"==typeof d&&"function"!=typeof d?(null!=d.id&&null!=d.text?n=d.text:"string"==typeof d.html?n=(d.html||"").trim():(n="",console.log("ERROR: render function should return a primitive or an object of the following structure.",{html:"",attr:"",style:"",class:"",divAttr:""})),h=d.attr??"",r=d.style??"",a=d.class??"",c=d.divAttr??""):n=String(d||"").trim()}if("object"==typeof l.render&&null!=(e=l.render[n])&&""!==e&&(n=e),"string"==typeof l.render){i=[],-1==(t=l.render.toLowerCase().indexOf(":"))?(i[0]=l.render.toLowerCase(),i[1]=""):(i[0]=l.render.toLowerCase().substr(0,t),i[1]=l.render.toLowerCase().substr(t+1));let e=d.formatters[i[0]];l.options&&!1===l.options.autoFormat&&(e=null),n="function"==typeof e?e(n,i[1],o):""}}return null==n&&(n=""),s?{value:n,attr:h,style:r,className:a,divAttr:c}:n}getFooterHTML(){return'<div>    <div class="w2ui-footer-left"></div>    <div class="w2ui-footer-right"></div>    <div class="w2ui-footer-center"></div></div>'}status(e){if(null!=e)a(this.box).find(`#grid_${this.name}_footer`).find(".w2ui-footer-left").html(e);else{let t="";if(0<(e=this.getSelection()).length&&(this.show.statusSelection&&1<e.length&&(t=String(e.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+d.settings.groupSymbol)+" "+d.lang("selected")),this.show.statusRecordID)&&1==e.length){let i=e[0];"object"==typeof i&&(i=i.recid+", "+d.lang("Column")+": "+i.column),t=d.lang("Record ID")+": "+i+" "}a(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-left").html(t)}}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),setTimeout((()=>{a(this.box).find("#grid_"+this.name+"_empty_msg").remove(),d.lock(...i)}),10)}unlock(e){setTimeout((()=>{a(this.box).find(".w2ui-message").hasClass("w2ui-closing")||d.unlock(this.box,e)}),25)}stateSave(e){var t={columns:[],show:d.clone(this.show),last:{search:this.last.search,multi:this.last.multi,logic:this.last.logic,label:this.last.label,field:this.last.field,scrollTop:this.last.vscroll.scrollTop,scrollLeft:this.last.vscroll.scrollLeft},sortData:[],searchData:[]};let i;for(let e=0;e<this.columns.length;e++){let s=this.columns[e],l={};Object.keys(this.stateColProps).forEach(((e,t)=>{this.stateColProps[e]&&(i=void 0!==s[e]?s[e]:this.colTemplate[e]||null,l[e]=i)})),t.columns.push(l)}for(let e=0;e<this.sortData.length;e++)t.sortData.push(d.clone(this.sortData[e]));for(let e=0;e<this.searchData.length;e++)t.searchData.push(d.clone(this.searchData[e]));var s=this.trigger("stateSave",{target:this.name,state:t});if(!0!==s.isCancelled)return!0!==e&&this.cacheSave("state",t),s.finish(),t}stateRestore(e){let t="object"!=typeof this.url?this.url:this.url.get;e=e||this.cache("state");var i=this.trigger("stateRestore",{target:this.name,state:e});if(!0!==i.isCancelled){if(d.isPlainObject(e)){d.extend(this.show,e.show??{}),d.extend(this.last,e.last??{});let i=this.last.vscroll.scrollTop,o=this.last.vscroll.scrollLeft;for(let t=0;t<e.columns?.length;t++){var s=e.columns[t],l=this.getColumn(s.field,!0);null!==l&&(d.extend(this.columns[l],s),t!==l)&&this.columns.splice(t,0,this.columns.splice(l,1)[0])}this.sortData.splice(0,this.sortData.length);for(let t=0;t<e.sortData?.length;t++)this.sortData.push(e.sortData[t]);this.searchData.splice(0,this.searchData.length);for(let t=0;t<e.searchData?.length;t++)this.searchData.push(e.searchData[t]);setTimeout((()=>{t||(0<this.sortData.length&&this.localSort(),0<this.searchData.length&&this.localSearch()),this.last.vscroll.scrollTop=i,this.last.vscroll.scrollLeft=o,this.refresh()}),1),console.log(`INFO (w2ui): state restored for "${this.name}"`)}return i.finish(),!0}}stateReset(){this.stateRestore(this.last.state),this.cacheSave("state",null)}parseField(e,t){if(this.nestedFields){let s="";try{s=e;var i=String(t).split(".");for(let e=0;e<i.length;e++)s=s[i[e]]}catch(e){s=""}return s}return e?e[t]:""}prepareData(){let e=this;for(let t=0;t<this.records.length;t++)!function t(i){for(let t=0;t<e.columns.length;t++){let s=e.columns[t];if(null!=i[s.field]&&"string"==typeof s.render){if(-1!=["number","int","float","money","currency","percent"].indexOf(s.render.split(":")[0])&&"number"!=typeof i[s.field]&&(i[s.field]=parseFloat(i[s.field])),-1!=["date","age"].indexOf(s.render.split(":")[0])&&!i[s.field+"_"]){let e=i[s.field];d.isInt(e)&&(e=parseInt(e)),i[s.field+"_"]=new Date(e)}if(-1!=["time"].indexOf(s.render))if(d.isTime(i[s.field])){let e=d.isTime(i[s.field],!0),t=new Date;t.setHours(e.hours,e.minutes,e.seconds||0,0),i[s.field+"_"]||(i[s.field+"_"]=t)}else{let e=i[s.field],t=(e=null!=(e=d.isInt(e)?parseInt(e):e)?new Date(e):new Date,new Date);t.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),0),i[s.field+"_"]||(i[s.field+"_"]=t)}}}if(i.w2ui?.children&&!0!==i.w2ui?.expanded)for(let e=0;e<i.w2ui.children.length;e++)t(i.w2ui.children[e])}(this.records[t])}nextCell(e,t,i){if((t+=1)>=this.columns.length)return null==(e=this.nextRow(e))?e:this.nextCell(e,-1,i);var s=this.records[e].w2ui,l=this.columns[t];return s=s&&s.colspan&&!isNaN(s.colspan[l.field])?parseInt(s.colspan[l.field]):1,null==l?null:l&&l.hidden||0===s?this.nextCell(e,t,i):!i||null!=(l=this.getCellEditable(e,t))&&-1==["checkbox","check"].indexOf(l.type)?{index:e,colIndex:t}:this.nextCell(e,t,i)}prevCell(e,t,i){if((t-=1)<0)return null==(e=this.prevRow(e))?e:this.prevCell(e,this.columns.length,i);if(t<0)return null;var s=this.records[e].w2ui,l=this.columns[t];return s=s&&s.colspan&&!isNaN(s.colspan[l.field])?parseInt(s.colspan[l.field]):1,null==l?null:l&&l.hidden||0===s?this.prevCell(e,t,i):!i||null!=(l=this.getCellEditable(e,t))&&-1==["checkbox","check"].indexOf(l.type)?{index:e,colIndex:t}:this.prevCell(e,t,i)}nextRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return this.records.length-1;if(e+i<this.records.length&&0===s.length||0<s.length&&e<s[s.length-i]){if(e+=i,0<s.length)for(;!(s.includes(e)||e>this.records.length);)e+=i;var o=this.records[e].w2ui,n=this.columns[t];l=0===(o=o&&o.colspan&&null!=n&&!isNaN(o.colspan[n.field])?parseInt(o.colspan[n.field]):1)?this.nextRow(e,t,i):e}return l}prevRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return 0;if(0<=e-i&&0===s.length||0<s.length&&e>s[0]){if(e-=i,0<s.length)for(;!(s.includes(e)||e<0);)e-=i;var o=this.records[e].w2ui,n=this.columns[t];l=0===(o=o&&o.colspan&&null!=n&&!isNaN(o.colspan[n.field])?parseInt(o.colspan[n.field]):1)?this.prevRow(e,t,i):e}return l}selectionSave(){return this.last.saved_sel=this.getSelection(),this.last.saved_sel}selectionRestore(e){var t,i=Date.now(),s=(this.last.selection={indexes:[],columns:{}},this.last.selection),l=this.last.saved_sel;if(l)for(let e=0;e<l.length;e++)d.isPlainObject(l[e])?null!=(t=this.get(l[e].recid,!0))&&(-1==s.indexes.indexOf(t)&&s.indexes.push(t),s.columns[t]||(s.columns[t]=[]),s.columns[t].push(l[e].column)):null!=(t=this.get(l[e],!0))&&s.indexes.push(t);return delete this.last.saved_sel,!0!==e&&this.refresh(),Date.now()-i}message(e){return d.message({owner:this,box:this.box,after:".w2ui-grid-header"},e)}confirm(e){return d.confirm({owner:this,box:this.box,after:".w2ui-grid-header"},e)}}class E extends l{constructor(e){super(e.name),this.name=null,this.header="",this.box=null,this.url="",this.method=null,this.routeData={},this.formURL="",this.formHTML="",this.page=0,this.pageStyle="",this.recid=null,this.fields=[],this.actions={},this.record={},this.original=null,this.dataType=null,this.postData={},this.httpHeaders={},this.toolbar={},this.tabs={},this.style="",this.focus=0,this.autosize=!0,this.nestedFields=!0,this.tabindexBase=0,this.isGenerated=!1,this.last={fetchCtrl:null,fetchOptions:null,errors:[]},this.onRequest=null,this.onLoad=null,this.onValidate=null,this.onSubmit=null,this.onProgress=null,this.onSave=null,this.onChange=null,this.onInput=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onAction=null,this.onToolbar=null,this.onError=null,this.msgRefresh="Loading...",this.msgSaving="Saving...",this.msgServerError="Server error",this.ALL_TYPES=["text","textarea","email","pass","password","int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","toggle","checkbox","radio","check","checks","list","combo","enum","file","select","switch","map","array","div","custom","html","empty"],this.LIST_TYPES=["select","radio","check","checks","list","combo","enum","switch"],this.W2FIELD_TYPES=["int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","list","combo","enum","file"],d.extend(this,e);var t,i,s=e.record,l=e.original,o=e.fields,n=e.toolbar;let r=e.tabs;if(Object.assign(this,{record:{},original:null,fields:[],tabs:{},toolbar:{},handlers:[]}),o&&(e=function e(t){let i=[],s=[];if(d.isPlainObject(t)){let l=t;function o(e){let t=["html"];return null==e.html&&(e.html={}),Object.keys(e).forEach((i=>{-1==t.indexOf(i)&&-1!=["label","attr","style","text","span","page","column","anchor","group","groupStyle","groupTitleStyle","groupCollapsible"].indexOf(i)&&(e.html[i]=e[i],delete e[i])})),e}function n(e,t){let i=["style","html"];Object.keys(e).forEach((s=>{-1==i.indexOf(s)&&-1!=["span","column","attr","text","label"].indexOf(s)&&e[s]&&!t.html[s]&&(t.html[s]=e[s])}))}t=[],Object.keys(l).forEach((i=>{let a=l[i];if("group"==a.type){if(a.text=i,d.isPlainObject(a.fields)){let e=a.fields;a.fields=[],Object.keys(e).forEach((t=>{let i=e[t];i.field=t,a.fields.push(o(i))}))}t.push(a)}else if("tab"==a.type){let l={id:i,text:i},o=(a.style&&(l.style=a.style),s.push(l),e(a.fields).fields);o.forEach((e=>{e.html=e.html||{},e.html.page=s.length-1,n(a,e)})),t.push(...o)}else a.field=i,t.push(o(a))}))}return t.forEach((e=>{if("group"==e.type){let t={group:e.text||"",groupStyle:e.style||"",groupTitleStyle:e.titleStyle||"",groupCollapsible:!0===e.collapsible};Array.isArray(e.fields)&&e.fields.forEach((s=>{let l=d.clone(s);null==l.html&&(l.html={}),d.extend(l.html,t),Array("span","column","attr","label","page").forEach((t=>{null==l.html[t]&&null!=e[t]&&(l.html[t]=e[t])})),null==l.field&&null!=l.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",e),l.field=l.name),i.push(l)}))}else{let t=d.clone(e);null==t.field&&null!=t.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",e),t.field=t.name),i.push(t)}})),{fields:i,tabs:s}}(o),this.fields=e.fields,!r)&&0<e.tabs.length&&(r=e.tabs),Array.isArray(r)){d.extend(this.tabs,{tabs:[]});for(let e=0;e<r.length;e++){var h=r[e];"object"==typeof h?(this.tabs.tabs.push(h),!0===h.active&&(this.tabs.active=h.id)):this.tabs.tabs.push({id:h,text:h})}}else d.extend(this.tabs,r);for(t in d.extend(this.toolbar,n),s)d.isPlainObject(s[t])?this.record[t]=d.clone(s[t]):this.record[t]=s[t];for(i in l)d.isPlainObject(l[i])?this.original[i]=d.clone(l[i]):this.original[i]=l[i];""!==this.formURL?fetch(this.formURL).then((e=>e.text())).then((e=>{this.formHTML=e,this.isGenerated=!0,this.box&&this.render(this.box)})):this.formURL||this.formHTML?this.formHTML&&(this.isGenerated=!0):(this.formHTML=this.generateHTML(),this.isGenerated=!0),"string"==typeof this.box&&(this.box=a(this.box).get(0)),this.box&&this.render(this.box)}get(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.fields.length;e++)null!=this.fields[e].field&&i.push(this.fields[e].field);return i}for(let i=0;i<this.fields.length;i++)if(this.fields[i].field==e)return!0===t?i:this.fields[i];return null}set(e,t){for(let i=0;i<this.fields.length;i++)if(this.fields[i].field==e)return d.extend(this.fields[i],t),delete this.fields[i].w2field,this.refresh(e),!0;return!1}getValue(e,t){if(this.nestedFields){let s;try{var i=!0===t?this.original:this.record;s=String(e).split(".").reduce(((e,t)=>e[t]),i)}catch(e){}return s}return this.record[e]}setValue(e,t,i){if((""===t||null==t||Array.isArray(t)&&0===t.length||d.isPlainObject(t)&&0==Object.keys(t).length)&&(t=null),!this.nestedFields)return this.record[e]=t,i||this.setFieldValue(e,t),!0;try{let s=this.record;return String(e).split(".").map(((e,i,l)=>{l.length-1!==i?s=s[e]||(s[e]={},s[e]):s[e]=t})),i||this.setFieldValue(e,t),!0}catch(e){return!1}}getFieldValue(e){let t=this.get(e);if(null!=t){var i=t.el;let n=this.getValue(e);var s;e=this.getValue(e,!0);let r=i.value;if(!["int","float","percent","money","currency"].includes(t.type)||"int"!=t.type&&"."==r[r.length-1]||(r=t.w2field.clean(r)),["radio"].includes(t.type)&&(s=a(i).closest("div").find("input:checked").get(0),r=s?t.options.items[a(s).data("index")].id:null),["toggle","checkbox"].includes(t.type)&&(r=i.checked),-1!==["check","checks"].indexOf(t.type)&&(r=[],0<(s=a(i).closest("div").find("input:checked")).length&&s.each((e=>{e=t.options.items[a(e).data("index")],r.push(e.id)})),Array.isArray(n)||(n=[])),i=t.w2field?.selected,["list","enum","file"].includes(t.type)&&i){var l=i,o=n;if(Array.isArray(l)){r=[];for(let e=0;e<l.length;e++)r[e]=d.clone(l[e])}if(Array.isArray(o)){n=[];for(let e=0;e<o.length;e++)n[e]=d.clone(o[e])}d.isPlainObject(l)&&(r=d.clone(l)),d.isPlainObject(o)&&(n=d.clone(o))}return["map","array"].includes(t.type)&&(r="map"==t.type?{}:[],t.$el.parent().find(".w2ui-map-field").each((e=>{var i=a(e).find(".w2ui-map.key").val();e=a(e).find(".w2ui-map.value").val(),"map"==t.type?r[i]=e:r.push(e)}))),{current:r,previous:n,original:e}}}setFieldValue(e,t){let i=this.get(e);if(null!=i){var s=i.el;switch(i.type){case"toggle":case"checkbox":s.checked=!!t;break;case"radio":{t=t?.id??t;let e=a(s).closest("div").find("input");i.options.items.forEach(((i,s)=>{i.id===t&&e.filter(`[data-index="${s}"]`).prop("checked",!0)}));break}case"check":case"checks":{t=(t=Array.isArray(t)?t:null!=t?[t]:[]).map((e=>e?.id??e));let e=a(s).closest("div").find("input");i.options.items.forEach(((i,s)=>{e.filter(`[data-index="${s}"]`).prop("checked",!!t.includes(i.id))}));break}case"list":case"combo":let e=t;null==e?.id&&Array.isArray(i.options?.items)&&i.options.items.forEach((i=>{i.id===t&&(e=i)})),e!=t&&this.setValue(i.name,e,!0),"list"==i.type?(i.w2field.selected=e,i.w2field.refresh()):i.el.value=e?.text??t;break;case"switch":s.value=t,i.toolbar.uncheck(...i.toolbar.get()),i.toolbar.check(t);break;case"enum":case"file":{let e=[...t=Array.isArray(t)?t:null!=t?[t]:[]],s=!1;e.forEach(((t,l)=>{null==t?.id&&Array.isArray(i.options.items)&&i.options.items.forEach((i=>{i.id==t&&(e[l]=i,s=!0)}))})),s&&this.setValue(i.name,e,!0),i.w2field.selected=e,i.w2field.refresh();break}case"map":case"array":"map"!=i.type||null!=t&&d.isPlainObject(t)||(this.setValue(i.field,{},!0),t=this.getValue(i.field)),"array"!=i.type||null!=t&&Array.isArray(t)||(this.setValue(i.field,[],!0),t=this.getValue(i.field));var l=a(i.el).parent().find(".w2ui-map-container");i.el.mapRefresh(t,l);break;case"div":case"custom":a(s).html(t);break;case"color":s.value=t??"",i.w2field.refresh();break;case"html":case"empty":break;default:s.value=t??""}}}show(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&t.hidden&&(t.hidden=!1,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),this.updateEmptyGroups(),e}hide(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&!t.hidden&&(t.hidden=!0,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),this.updateEmptyGroups(),e}enable(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&t.disabled&&(t.disabled=!1,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),e}disable(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&!t.disabled&&(t.disabled=!0,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),e}updateEmptyGroups(){a(this.box).find(".w2ui-group").each((e=>{!function(e){let t=!0;return e.each((e=>{"none"!=e.style.display&&(t=!1)})),t}(a(e).find(".w2ui-field"))?a(e).show():a(e).hide()}))}change(){Array.from(arguments).forEach((e=>{(e=this.get(e)).$el&&e.$el.change()}))}reload(e){return("object"!=typeof this.url?this.url:this.url.get)&&null!=this.recid?this.request(e):("function"==typeof e&&e(),new Promise((e=>{e()})))}clear(){0!=arguments.length?Array.from(arguments).forEach((e=>{let t=this.record;String(e).split(".").map(((e,i,s)=>{s.length-1!==i?t=t[e]:delete t[e]})),this.refresh(e)})):(this.recid=null,this.record={},this.original=null,this.refresh(),this.hideErrors())}error(e){var t=this.trigger("error",{target:this.name,message:e,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions});!0!==t.isCancelled&&(setTimeout((()=>{this.message(e)}),1),t.finish())}message(e){return d.message({owner:this,box:this.box,after:".w2ui-form-header"},e)}confirm(e){return d.confirm({owner:this,box:this.box,after:".w2ui-form-header"},e)}validate(e){null==e&&(e=!0);var t=[];for(let e=0;e<this.fields.length;e++){var i,s,l=this.fields[e];switch(null==this.getValue(l.field)&&this.setValue(l.field,""),-1!=["int","float","currency","money"].indexOf(l.type)&&(i=this.getValue(l.field),o=l.options.min,s=l.options.max,null!=o&&null!=i&&i<o&&t.push({field:l,error:d.lang("Should be more than ${min}",{min:o})}),null!=s)&&null!=i&&s<i&&t.push({field:l,error:d.lang("Should be less than ${max}",{max:s})}),l.type){case"alphanumeric":this.getValue(l.field)&&!d.isAlphaNumeric(this.getValue(l.field))&&t.push({field:l,error:d.lang("Not alpha-numeric")});break;case"int":this.getValue(l.field)&&!d.isInt(this.getValue(l.field))&&t.push({field:l,error:d.lang("Not an integer")});break;case"percent":case"float":this.getValue(l.field)&&!d.isFloat(this.getValue(l.field))&&t.push({field:l,error:d.lang("Not a float")});break;case"currency":case"money":this.getValue(l.field)&&!d.isMoney(this.getValue(l.field))&&t.push({field:l,error:d.lang("Not in money format")});break;case"color":case"hex":this.getValue(l.field)&&!d.isHex(this.getValue(l.field))&&t.push({field:l,error:d.lang("Not a hex number")});break;case"email":this.getValue(l.field)&&!d.isEmail(this.getValue(l.field))&&t.push({field:l,error:d.lang("Not a valid email")});break;case"checkbox":1==this.getValue(l.field)?this.setValue(l.field,!0):this.setValue(l.field,!1);break;case"date":l.options.format||(l.options.format=d.settings.dateFormat),this.getValue(l.field)&&!d.isDate(this.getValue(l.field),l.options.format)&&t.push({field:l,error:d.lang("Not a valid date")+": "+l.options.format})}var o=this.getValue(l.field);!0!==l.hidden&&l.required&&!["div","custom","html","empty"].includes(l.type)&&(null==o||""===o||Array.isArray(o)&&0===o.length||d.isPlainObject(o)&&0==Object.keys(o).length)&&t.push({field:l,error:d.lang("Required field")}),!0!==l.hidden&&0<l.options?.minLength&&!["enum","list","combo"].includes(l.type)&&(null==o||o.length<l.options.minLength)&&t.push({field:l,error:d.lang("Field should be at least ${count} characters.",{count:l.options.minLength})})}var n=this.trigger("validate",{target:this.name,errors:t});if(!0!==n.isCancelled)return this.last.errors=t,e&&this.showErrors(),n.finish(),t}showErrors(){var e=this.last.errors;e.length<=0||(this.goto(e[0].field.page),a(e[0].field.$el).parents(".w2ui-field")[0].scrollIntoView({block:"nearest",inline:"nearest"}),e.forEach((e=>{var t=d.extend({anchorClass:"w2ui-error",class:"w2ui-light",position:"right|left",hideOn:["input"]},e.options);if(null!=e.field){let i=e.field.el;"radio"===e.field.type?i=a(e.field.el).closest("div").get(0):["enum","file"].includes(e.field.type),g.show(d.extend({anchor:i,name:`${this.name}-${e.field.field}-error`,html:e.error},t))}})),a(e[0].field.$el).parents(".w2ui-page").off(".hideErrors").on("scroll.hideErrors",(e=>{this.hideErrors()})))}hideErrors(){this.fields.forEach((e=>{g.hide(`${this.name}-${e.field}-error`)}))}getChanges(){return null!=this.original&&"object"==typeof this.original&&0!==Object.keys(this.record).length?function e(t,i,s){if(Array.isArray(t)&&Array.isArray(i))for(;t.length<i.length;)t.push(null);for(var l in t)null!=t[l]&&"object"==typeof t[l]?(s[l]=e(t[l],i[l]||{},{}),(!s[l]||0==Object.keys(s[l]).length&&Object.keys(0==i[l].length))&&delete s[l]):(t[l]!=i[l]||null==t[l]&&null!=i[l])&&(s[l]=t[l]);return 0!=Object.keys(s).length?s:null}(this.record,this.original,{}):{}}getCleanRecord(e){let t=d.clone(this.record);return this.fields.forEach((e=>{if(-1!=["list","combo","enum"].indexOf(e.type)){var i={nestedFields:!0,record:t};let s=this.getValue.call(i,e.field);d.isPlainObject(s)&&null!=s.id&&this.setValue.call(i,e.field,s.id),Array.isArray(s)&&s.forEach(((e,t)=>{d.isPlainObject(e)&&e.id&&(s[t]=e.id)}))}var s;"map"==e.type&&(i={nestedFields:!0,record:t},(i=this.getValue.call(i,e.field))._order)&&delete i._order,"file"==e.type&&(i={nestedFields:!0,record:t},(s=this.getValue.call(i,e.field)??[]).forEach((e=>{delete e.file,delete e.modified})),this.setValue.call(i,e.field,s))})),!0===e&&Object.keys(t).forEach((e=>{this.get(e)||delete t[e]})),t}request(e,t){let i,s,l=this;var o=new Promise(((e,t)=>{i=e,s=t}));if("function"==typeof e&&(t=e,e=null),null==e&&(e={}),this.url&&("object"!=typeof this.url||this.url.get)){var n={action:"get"};if(!0!==(n.recid=this.recid,n.name=this.name,d.extend(n,this.postData),d.extend(n,e),e=this.trigger("request",{target:this.name,url:this.url,httpMethod:"GET",postData:n,httpHeaders:this.httpHeaders})).isCancelled){this.record={},this.original=null,this.lock(d.lang(this.msgRefresh));let r=e.detail.url;if("object"==typeof r&&r.get&&(r=r.get),this.last.fetchCtrl)try{this.last.fetchCtrl.abort()}catch(e){}if(0!=Object.keys(this.routeData).length){var a=d.parseRoute(r);if(0<a.keys.length)for(let c=0;c<a.keys.length;c++)null!=this.routeData[a.keys[c].name]&&(r=r.replace(new RegExp(":"+a.keys[c].name,"g"),this.routeData[a.keys[c].name]))}return r=new URL(r,location),n=d.prepareParams(r,{method:e.detail.httpMethod,headers:e.detail.httpHeaders,body:e.detail.postData},this.dataType),this.last.fetchCtrl=new AbortController,n.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=n,fetch(r,n).catch(h).then((e=>{200!=e?.status?e&&h(e):e.json().catch(h).then((e=>{var s=l.trigger("load",{target:l.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:e});!0!==s.isCancelled&&(null==e.error&&"error"===e.status&&(e.error=!0),e.record||Object.assign(e,{record:d.clone(e)}),!0===e.error?l.error(d.lang(e.message??this.msgServerError)):l.record=d.clone(e.record),l.unlock(),s.finish(),l.refresh(),l.setFocus(),"function"==typeof t&&t(e),i(e))}))})),e.finish(),o;function h(e){var t;"AbortError"!==e.name&&(l.unlock(),!0!==(t=l.trigger("error",{response:e,fetchCtrl:l.last.fetchCtrl,fetchOptions:l.last.fetchOptions})).isCancelled)&&(e.status&&200!=e.status?l.error(e.status+": "+e.statusText):(console.log("ERROR: Server request failed.",e,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),l.error(String(e))),t.finish(),s(e))}}}}submit(e,t){return this.save(e,t)}save(e,t){let i,s,l=this;var o=new Promise(((e,t)=>{i=e,s=t})),n=("function"==typeof e&&(t=e,e=null),l.validate(!0));if(0===n.length)if(null==e&&(e={}),!l.url||"object"==typeof l.url&&!l.url.save)console.log("ERROR: Form cannot be saved because no url is defined.");else if(l.lock(d.lang(l.msgSaving)+' <span id="'+l.name+'_progress"></span>'),(n={action:"save"}).recid=l.recid,n.name=l.name,d.extend(n,l.postData),d.extend(n,e),n.record=d.clone(l.record),!0!==(e=l.trigger("submit",{target:l.name,url:l.url,httpMethod:this.method??"POST",postData:n,httpHeaders:l.httpHeaders})).isCancelled){let r=e.detail.url;if("object"==typeof r&&r.save&&(r=r.save),l.last.fetchCtrl&&l.last.fetchCtrl.abort(),0<Object.keys(l.routeData).length){var a=d.parseRoute(r);if(0<a.keys.length)for(let c=0;c<a.keys.length;c++)null!=l.routeData[a.keys[c].name]&&(r=r.replace(new RegExp(":"+a.keys[c].name,"g"),l.routeData[a.keys[c].name]))}return r=new URL(r,location),n=d.prepareParams(r,{method:e.detail.httpMethod,headers:e.detail.httpHeaders,body:e.detail.postData},this.dataType),this.last.fetchCtrl=new AbortController,n.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=n,fetch(r,n).catch(h).then((e=>{l.unlock(),200!=e?.status?h(e??{}):e.json().catch(h).then((e=>{var s=l.trigger("save",{target:l.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:e});!0!==s.isCancelled&&(!0===e.error?l.error(d.lang(e.message??this.msgServerError)):l.original=null,s.finish(),l.refresh(),"function"==typeof t&&t(e),i(e))}))})),e.finish(),o;function h(e){var t;"AbortError"!==e?.name&&(l.unlock(),!0!==(t=l.trigger("error",{response:e,fetchCtrl:l.last.fetchCtrl,fetchOptions:l.last.fetchOptions})).isCancelled)&&(e.status&&200!=e.status?e.json().then((t=>{l.error(e.status+": "+t.message??e.statusText)})).catch((()=>{l.error(e.status+": "+e.statusText)})):(console.log("ERROR: Server request failed.",e,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),l.error(String(e))),t.finish(),s())}}}lock(e,t){var i=Array.from(arguments);i.unshift(this.box),d.lock(...i)}unlock(e){var t=this.box;d.unlock(t,e)}lockPage(e,t,i){return!!(e=a(this.box).find(".page-"+e)).length&&(d.lock(e,t,i),!0)}unlockPage(e,t){return!!(e=a(this.box).find(".page-"+e)).length&&(d.unlock(e,t),!0)}goto(e){this.page!==e&&(null!=e&&(this.page=e),!0===a(this.box).data("autoSize")&&(a(this.box).get(0).clientHeight=0),this.refresh())}generateHTML(){let e,t,i,s,l=[],o="";for(let r=0;r<this.fields.length;r++){i="";var n=' tabindex="'+(s=this.tabindexBase+r+1)+'"',a=this.fields[r];null==a.html&&(a.html={}),null==a.options&&(a.options={}),null!=a.html.caption&&null==a.html.label&&(console.log("NOTICE: form field.html.caption property is deprecated, please use field.html.label. Field ->",a),a.html.label=a.html.caption),null==a.html.label&&(a.html.label=a.field),a.html=d.extend({label:"",span:6,attr:"",text:"",style:"",page:0,column:0},a.html),null==e&&(e=a.html.page),null==t&&(t=a.html.column);let h=`<input id="${a.field}" name="${a.field}" class="w2ui-input ${a.html.class??""}" type="text" ${a.html.attr+n}>`;switch(a.type){case"pass":case"password":h=h.replace('type="text"','type="password"');break;case"checkbox":h=`\n                        <label class="w2ui-box-label">\n                            <input id="${a.field}" name="${a.field}" class="w2ui-input ${a.html.class??""}" type="checkbox" ${a.html.attr+n}>\n                            <span>${a.html.label}</span>\n                        </label>`;break;case"check":case"checks":{null==a.options.items&&null!=a.html.items&&(a.options.items=a.html.items);let e=a.options.items;h="",0<(e=Array.isArray(e)?e:[]).length&&(e=d.normMenu.call(this,e,a));for(let t=0;t<e.length;t++)h+=`\n                            <label class="w2ui-box-label">\n                                <input id="${a.field+t}" name="${a.field}" class="w2ui-input ${a.html.class??""}" type="checkbox"\n                                    ${a.html.attr+n} data-value="${e[t].id}" data-index="${t}">\n                                <span>&#160;${e[t].text}</span>\n                            </label>\n                            <br>`;break}case"radio":{h="",null==a.options.items&&null!=a.html.items&&(a.options.items=a.html.items);let e=a.options.items;0<(e=Array.isArray(e)?e:[]).length&&(e=d.normMenu.call(this,e,a));for(let t=0;t<e.length;t++)h+=`\n                            <label class="w2ui-box-label">\n                                <input id="${a.field+t}" name="${a.field}" class="w2ui-input ${a.html.class??""}" type="radio"\n                                    ${a.html.attr+(0===t?n:"")}\n                                    data-value="${e[t].id}" data-index="${t}">\n                                <span>&#160;${e[t].text}</span>\n                            </label>\n                            <br>`;break}case"select":{h=`<select id="${a.field}" name="${a.field}" class="w2ui-input ${a.html.class??""}" ${a.html.attr+n}>`,null==a.options.items&&null!=a.html.items&&(a.options.items=a.html.items);let e=a.options.items;0<(e=Array.isArray(e)?e:[]).length&&(e=d.normMenu.call(this,e,a));for(let t=0;t<e.length;t++)h+=`<option value="${e[t].id}">${e[t].text}</option>`;h+="</select>";break}case"switch":h=`<div id="${a.field}-tb" class="w2ui-form-switch ${a.html.class??""}" ${a.html.attr}\n                        style="outline1: 1px solid red !important; height: 34px; margin-top: -5px; padding: 0px; background-color: transparent; position: relative;"></div>\n                        <input id="${a.field}" name="${a.field}" ${n} class="w2ui-input"\n                            style="position: absolute; right: 0; margin-top: -30px; width: 1px; padding: 0; opacity: 0">`;break;case"textarea":h=`<textarea id="${a.field}" name="${a.field}" class="w2ui-input ${a.html.class??""}" ${a.html.attr+n}></textarea>`;break;case"toggle":h=`<input id="${a.field}" name="${a.field}" class="w2ui-input w2ui-toggle  ${a.html.class??""}"\n                                type="checkbox" ${a.html.attr+n}>\n                            <div><div></div></div>`;break;case"map":case"array":a.html.key=a.html.key||{},a.html.value=a.html.value||{},a.html.tabindex_str=n,h='<span style="float: right">'+(a.html.text||"")+'</span><input id="'+a.field+'" name="'+a.field+'" type="hidden" '+a.html.attr+n+'><div class="w2ui-map-container"></div>';break;case"div":case"custom":h=`<div id="${a.field}" name="${a.field}" ${a.html.attr+n} class="w2ui-input ${a.html.class??""}">`+(a&&a.html&&a.html.html?a.html.html:"")+"</div>";break;case"html":case"empty":h=`<div id="${a.field}" name="${a.field}" ${a.html.attr+n} class="w2ui-input ${a.html.class??""}">`+(a&&a.html?(a.html.html||"")+(a.html.text||""):"")+"</div>"}if(""!==o&&(e!=a.html.page||t!=a.html.column||a.html.group&&o!=a.html.group)&&(l[e][t]+="\n   </div>\n  </div>",o=""),a.html.group&&o!=a.html.group){let e="";a.html.groupCollapsible&&(e='<span class="w2ui-icon-collapse" style="width: 15px; display: inline-block; position: relative; top: -2px;"></span>'),i+='\n <div class="w2ui-group">\n   <div class="w2ui-group-title w2ui-eaction" style="'+(a.html.groupTitleStyle||"")+"; "+(""!=e?"cursor: pointer; user-select: none":"")+'"'+(""!=e?'data-group="'+d.base64encode(a.html.group)+'"':"")+(""!=e?'data-click="toggleGroup|'+a.html.group+'"':"")+">"+e+d.lang(a.html.group)+'</div>\n   <div class="w2ui-group-fields" style="'+(a.html.groupStyle||"")+'">',o=a.html.group}if(null==a.html.anchor){let e=null!=a.html.span?"w2ui-span"+a.html.span:"",t="<label"+("none"==(e=-1==a.html.span?"w2ui-span-none":e)?' style="display: none"':"")+">"+d.lang("checkbox"!=a.type?a.html.label:a.html.text)+"</label>";a.html.label||(t=""),i+='\n      <div class="w2ui-field '+e+'" style="'+(a.hidden?"display: none;":"")+a.html.style+'">\n         '+t+("empty"===a.type?h:"\n         <div>"+h+("array"!=a.type&&"map"!=a.type?d.lang("checkbox"!=a.type?a.html.text:""):"")+"</div>")+"\n      </div>"}else l[a.html.page].anchors=l[a.html.page].anchors||{},l[a.html.page].anchors[a.html.anchor]='<div class="w2ui-field w2ui-field-inline" style="'+(a.hidden?"display: none;":"")+a.html.style+'">'+("empty"===a.type?h:"<div>"+d.lang("checkbox"!=a.type?a.html.label:a.html.text,!0)+h+d.lang("checkbox"!=a.type?a.html.text:"")+"</div>")+"</div>";null==l[a.html.page]&&(l[a.html.page]={}),null==l[a.html.page][a.html.column]&&(l[a.html.page][a.html.column]=""),l[a.html.page][a.html.column]+=i,e=a.html.page,t=a.html.column}if(""!==o&&(l[e][t]+="\n   </div>\n  </div>"),this.tabs.tabs)for(let e=0;e<this.tabs.tabs.length;e++)null==l[e]&&(l[e]=[]);let r="";if(0<Object.keys(this.actions).length){for(var h in r+='\n<div class="w2ui-buttons">',s=this.tabindexBase+this.fields.length+1,this.actions){var c=this.actions[h],u={text:"",style:"",class:""};d.isPlainObject(c)?(null==c.text&&null!=c.caption&&(console.log("NOTICE: form action.caption property is deprecated, please use action.text. Action ->",c),c.text=c.caption),c.text&&(u.text=c.text),c.style&&(u.style=c.style),c.class&&(u.class=c.class)):(u.text=h,-1!==["save","update","create"].indexOf(h.toLowerCase())?u.class="w2ui-btn-blue":u.class=""),r+='\n    <button name="'+h+'" class="w2ui-btn '+u.class+'" style="'+u.style+'" tabindex="'+s+'">'+d.lang(u.text)+"</button>",s++}r+="\n</div>"}i="";for(let e=0;e<l.length;e++){if(i+='<div class="w2ui-page page-'+e+'" style="'+(0!==e?"display: none;":"")+this.pageStyle+'">',!l[e])return console.log(`ERROR: Page ${e} does not exist`),!1;l[e].before&&(i+=l[e].before),i+='<div class="w2ui-column-container">',Object.keys(l[e]).sort().forEach(((t,s)=>{t==parseInt(t)&&(i+='<div class="w2ui-column col-'+t+'">'+(l[e][t]||"")+"\n</div>")})),i+="\n</div>",l[e].after&&(i+=l[e].after),i+="\n</div>",l[e].anchors&&Object.keys(l[e].anchors).forEach(((t,s)=>{i=i.replace(t,l[e].anchors[t])}))}return i+=r}toggleGroup(e,t){var i;0!==(e=a(this.box).find('.w2ui-group-title[data-group="'+d.base64encode(e)+'"]')).length&&(i=a(e.prop("nextElementSibling")),(t=void 0===t?"none"==i.css("display"):t)?(i.show(),e.find("span").addClass("w2ui-icon-collapse").removeClass("w2ui-icon-expand")):(i.hide(),e.find("span").addClass("w2ui-icon-expand").removeClass("w2ui-icon-collapse")))}action(e,t){var i=this.actions[e];let s=i;d.isPlainObject(i)&&i.onClick&&(s=i.onClick),!0!==(e=this.trigger("action",{target:e,action:i,originalEvent:t})).isCancelled&&("function"==typeof s&&s.call(this,t),e.finish())}resize(){let e=this;var t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled){if(null!=this.box){let n=a(this.box).find(":scope > div .w2ui-form-header"),r=a(this.box).find(":scope > div .w2ui-form-toolbar"),h=a(this.box).find(":scope > div .w2ui-form-tabs"),c=a(this.box).find(":scope > div .w2ui-page");var i=a(this.box).find(":scope > div .w2ui-page.page-"+this.page+" > div");let u=a(this.box).find(":scope > div .w2ui-buttons");var{headerHeight:s,tbHeight:l,tabsHeight:o}=p();function p(){var t=""!==e.header?d.getSize(n,"height"):0,i=Array.isArray(e.toolbar?.items)&&0<e.toolbar?.items?.length?d.getSize(r,"height"):0,s=Array.isArray(e.tabs?.tabs)&&0<e.tabs?.tabs?.length?d.getSize(h,"height"):0;return r.css({top:t+"px"}),h.css({top:t+i+"px"}),c.css({top:t+i+s+"px",bottom:(0<u.length?d.getSize(u,"height"):0)+"px"}),{headerHeight:t,tbHeight:i,tabsHeight:s}}this.autosize&&(0!==a(this.box).get(0).clientHeight&&"yes"!=a(this.box).data("autosize")||(a(this.box).css({height:s+l+o+15+(0<c.length?d.getSize(i,"height"):0)+(0<u.length?d.getSize(u,"height"):0)+"px"}),a(this.box).data("autosize","yes")),p())}t.finish()}}refresh(){var e=Date.now();let t=this;if(this.box&&this.isGenerated&&a(this.box).html()){var i=this.trigger("refresh",{target:this.name,page:this.page,field:arguments[0],fields:arguments});if(!0!==i.isCancelled){let l=Array.from(this.fields.keys());0<arguments.length?l=Array.from(arguments).map(((e,t)=>("string"!=typeof e&&console.log("ERROR: Arguments in refresh functions should be field names"),this.get(e,!0)))).filter(((e,t)=>null!=e)):(a(this.box).find("input, textarea, select").each((e=>{var t=null!=a(e).attr("name")?a(e).attr("name"):a(e).attr("id"),i=this.get(t);if(i){var s=a(e).closest(".w2ui-page");if(0<s.length)for(let e=0;e<100;e++)if(s.hasClass("page-"+e)){i.page=e;break}}})),a(this.box).find(".w2ui-page").hide(),a(this.box).find(".w2ui-page.page-"+this.page).show(),a(this.box).find(".w2ui-form-header").html(d.lang(this.header)),"object"==typeof this.tabs&&Array.isArray(this.tabs.tabs)&&0<this.tabs.tabs.length?(a(this.box).find("#form_"+this.name+"_tabs").show(),this.tabs.active=this.tabs.tabs[this.page].id,this.tabs.refresh()):a(this.box).find("#form_"+this.name+"_tabs").hide(),"object"==typeof this.toolbar&&Array.isArray(this.toolbar.items)&&0<this.toolbar.items.length?(a(this.box).find("#form_"+this.name+"_toolbar").show(),this.toolbar.refresh()):a(this.box).find("#form_"+this.name+"_toolbar").hide());for(let e=0;e<l.length;e++){let i=this.fields[l[e]],s=(null==i.name&&null!=i.field&&(i.name=i.field),null==i.field&&null!=i.name&&(i.field=i.name),i.$el=a(this.box).find(`[name='${String(i.name).replace(/\\/g,"\\\\")}']`),i.el=i.$el.get(0),i.el&&(i.el.id=i.name),i.w2field&&i.w2field.reset(),i.$el.off(".w2form").on("change.w2form",(function(e){var s=t.getFieldValue(i.field),l=(["enum","file"].includes(i.type)&&(l=i.w2field?.helpers?.multi,a(l).removeClass("w2ui-error")),null!=this._previous&&(s.previous=this._previous,delete this._previous),t.trigger("change",{target:this.name,field:this.name,value:s,originalEvent:e}));!0!==l.isCancelled&&(t.setValue(this.name,s.current),l.finish())})).on("input.w2form",(function(e){null==t.original&&(0<Object.keys(t.record).length?t.original=d.clone(t.record):t.original={});var s=t.getFieldValue(i.field);!0!==(null==this._previous&&(this._previous=s.previous),e=t.trigger("input",{target:t.name,field:i,value:s,originalEvent:e})).isCancelled&&(t.setValue(this.name,s.current),e.finish())})),i.required?i.$el.closest(".w2ui-field").addClass("w2ui-required"):i.$el.closest(".w2ui-field").removeClass("w2ui-required"),null!=i.disabled&&(i.disabled?(null==i.$el.data("tabIndex")&&i.$el.data("tabIndex",i.$el.prop("tabIndex")),i.$el.prop("readOnly",!0).prop("disabled",!0).prop("tabIndex",-1).closest(".w2ui-field").addClass("w2ui-disabled")):i.$el.prop("readOnly",!1).prop("disabled",!1).prop("tabIndex",i.$el.data("tabIndex")??i.$el.prop("tabIndex")??0).closest(".w2ui-field").removeClass("w2ui-disabled")),i.el);s=s||a(this.box).find("#"+i.field),i.hidden?a(s).closest(".w2ui-field").hide():a(s).closest(".w2ui-field").show()}a(this.box).find("button, input[type=button]").each((e=>{a(e).off("click").on("click",(function(e){let i=this.value;this.id&&(i=this.id),this.name&&(i=this.name),t.action(i,e)}))}));for(let e=0;e<l.length;e++){let i=this.fields[l[e]];if(i.el){if(i.$el.hasClass("w2ui-input")||i.$el.addClass("w2ui-input"),i.type=String(i.type).toLowerCase(),i.options||(i.options={}),this.LIST_TYPES.includes(i.type)){let e=i.options.items;null==e&&(i.options.items=[]),"switch"==i.type?e.forEach(((t,i)=>e[i]="object"!=typeof t?{id:t,text:t}:t)):i.options.items=d.normMenu.call(this,e??[],i)}if("switch"==i.type&&(i.toolbar&&r[this.name+"_"+i.name+"_tb"].destroy(),(s=i.options.items).forEach((e=>e.type="radio")),i.toolbar=new y({box:i.$el.prev().get(0),name:this.name+"_"+i.name+"_tb",items:s,onClick(e){var s=e.detail.item.id;!0!==(s=t.trigger("change",{target:i.name,field:i.name,value:s,originalEvent:e})).isCancelled&&(t.record[i.name]=e.detail.item.id,t.setFieldValue(i.name,e.detail.item.id),s.finish())}}),i.$el.off(".form-input").on("focus.form-input",(e=>{var t=i.toolbar.get(i.$el.val(),!0);a(e.target).prop("_index",t)})).on("blur.form-input",(e=>{a(e.target).removeProp("_index"),a(`#${i.name}-tb .w2ui-tb-button`).removeClass("over")})).on("keydown.form-input",(e=>{let s=a(e.target).prop("_index");switch(e.key){case"ArrowLeft":0<s&&s--,a(`#${i.name}-tb .w2ui-tb-button`).removeClass("over").eq(s).addClass("over"),a(e.target).prop("_index",s);break;case"ArrowRight":s<i.toolbar.items.length-1&&s++,a(`#${i.name}-tb .w2ui-tb-button`).removeClass("over").eq(s).addClass("over"),a(e.target).prop("_index",s)}var l;32!=e.keyCode&&13!=e.keyCode||(l=i.toolbar.items[s],t.setFieldValue(i.name,l.id),a(`#${i.name}-tb .w2ui-tb-button`).removeClass("over")),e.metaKey||e.ctrlKey||9==e.keyCode||e.preventDefault()}))),"select"==i.type){var s=i.options.items;let e="";s.forEach((t=>{e+=`<option value="${t.id}">${t.text}</option>`})),i.$el.html(e)}this.W2FIELD_TYPES.includes(i.type)&&(i.w2field=i.w2field??new S(d.extend({},i.options,{type:i.type})),i.w2field.render(i.el)),["map","array"].includes(i.type)&&function(e){let i;e.el.mapAdd=function(e,t,i){var s=(e.disabled?" readOnly ":"")+(e.html.tabindex_str||"");i=`\n                            <div class="w2ui-map-field" style="margin-bottom: 5px" data-index="${i}">\n                            ${"map"==e.type?`<input type="text" ${(e.html.key.attr??"")+s} class="w2ui-input ${e.html.class??""} w2ui-map key">\n                                    ${e.html.key.text||""}\n                                `:""}\n                            <input type="text" ${(e.html.value.attr??"")+s} class="w2ui-input ${e.html.class??""} w2ui-map value">\n                                ${e.html.value.text||""}\n                            </div>`,t.append(i)},e.el.mapRefresh=function(s,l){let o,n,r;var h;"map"==e.type&&(null==(s=d.isPlainObject(s)?s:{})._order&&(s._order=Object.keys(s)),o=s._order),"array"==e.type&&(Array.isArray(s)||(s=[]),o=s.map(((e,t)=>t)));for(let e=l.find(".w2ui-map-field").length-1;e>=o.length;e--)l.find(`div[data-index='${e}']`).remove();for(let t=0;t<o.length;t++){let i=o[t],a=l.find(`div[data-index='${t}']`),d=(0==a.length&&(e.el.mapAdd(e,l,t),a=l.find(`div[data-index='${t}']`)),a.attr("data-key",i),n=a.find(".w2ui-map.key"),r=a.find(".w2ui-map.value"),s[i]);"array"==e.type&&0<(h=s.filter((e=>e.key==i))).length&&(d=h[0].value),n.val(i),r.val(d),!0!==e.disabled&&!1!==e.disabled||(n.prop("readOnly",!!e.disabled),r.prop("readOnly",!!e.disabled))}var c=o.length,u=l.find(`div[data-index='${c}']`);0!==u.length||n&&""==n.val()&&""==r.val()||n&&(!0===n.prop("readOnly")||!0===n.prop("disabled"))||e.el.mapAdd(e,l,c),!0!==e.disabled&&!1!==e.disabled||(u.find(".key").prop("readOnly",!!e.disabled),u.find(".value").prop("readOnly",!!e.disabled)),c=a(e.el).get(0)?.nextSibling,a(c).find("input.w2ui-map").off(".mapChange").on("keyup.mapChange",(function(e){var t=(s=a(e.target).closest(".w2ui-map-field")).get(0).nextElementSibling,s=s.get(0).previousElementSibling,l=(13==e.keyCode&&((l=i??t)instanceof HTMLElement&&0<(l=a(l).find("input")).length&&l.get(0).focus(),i=void 0),a(e.target).hasClass("key")?"key":"value");38==e.keyCode&&s&&(a(s).find("input."+l).get(0).select(),e.preventDefault()),40==e.keyCode&&t&&(a(t).find("input."+l).get(0).select(),e.preventDefault())})).on("keydown.mapChange",(function(e){38!=e.keyCode&&40!=e.keyCode||e.preventDefault()})).on("input.mapChange",(function(t){var i=(t=a(t.target).closest("div")).data("index"),s=t.get(0).nextElementSibling;if(""==t.find("input").val()||s){if(""==t.find("input").val()&&s){let e=!0;a(s).find("input").each((t=>{""!=t.value&&(e=!1)})),e&&a(s).remove()}}else e.el.mapAdd(e,l,parseInt(i)+1)})).on("change.mapChange",(function(s){null==t.original&&(0<Object.keys(t.record).length?t.original=d.clone(t.record):t.original={});let{current:o,previous:n,original:r}=t.getFieldValue(e.field);var h=a(s.target).closest(".w2ui-map-container");!0!==("map"==e.type&&(o._order=[]),h.find(".w2ui-map.key").each((e=>{o._order.push(e.value)})),h=t.trigger("change",{target:e.field,field:e.field,originalEvent:s,value:{current:o,previous:n,original:r}})).isCancelled&&("map"==e.type&&(o._order=o._order.filter((e=>""!==e)),delete o[""]),"array"==e.type&&(o=o.filter((e=>""!==e))),""==a(s.target).parent().find("input").val()&&(i=s.target),t.setValue(e.field,o),e.el.mapRefresh(o,l),h.finish())}))}}(i),this.setFieldValue(i.field,this.getValue(i.name))}}return i.finish(),this.resize(),Date.now()-e}}}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=a(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.isGenerated||this.formHTML)&&this.box){if(e='<div class="w2ui-form-box">'+(""!==this.header?'<div class="w2ui-form-header">'+d.lang(this.header)+"</div>":"")+'    <div id="form_'+this.name+'_toolbar" class="w2ui-form-toolbar" style="display: none"></div>    <div id="form_'+this.name+'_tabs" class="w2ui-form-tabs" style="display: none"></div>'+this.formHTML+"</div>",a(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-form").html(e),0<a(this.box).length&&(a(this.box)[0].style.cssText+=this.style),d.bindEvents(a(this.box).find(".w2ui-eaction"),this),"function"!=typeof this.toolbar.render&&(this.toolbar=new y(d.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.toolbar.on("click",(function(e){!0!==(e=i.trigger("toolbar",{target:e.target,originalEvent:e})).isCancelled&&e.finish()}))),"object"==typeof this.toolbar&&"function"==typeof this.toolbar.render&&this.toolbar.render(a(this.box).find("#form_"+this.name+"_toolbar")[0]),"function"!=typeof this.tabs.render&&(this.tabs=new x(d.extend({},this.tabs,{name:this.name+"_tabs",owner:this,active:this.tabs.active})),this.tabs.on("click",(function(e){i.goto(this.get(e.target,!0))}))),"object"==typeof this.tabs&&"function"==typeof this.tabs.render&&(this.tabs.render(a(this.box).find("#form_"+this.name+"_tabs")[0]),this.tabs.active)&&this.tabs.click(this.tabs.active),s.finish(),this.resize(),(e="object"!=typeof this.url?this.url:this.url.get)&&null!=this.recid?this.request().catch((e=>this.refresh())):this.refresh(),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),-1!=this.focus){let e=0,t=()=>{0<a(i.box).find("input, select, textarea").length?i.setFocus():++e<20&&setTimeout(t,50)};t()}return Date.now()-t}}unmount(){super.unmount(),this.tabs?.unmount?.(),this.toolbar?.unmount?.(),this.last.observeResize?.disconnect()}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(this.tabs?.destroy?.(),this.toolbar?.destroy?.(),0<a(this.box).find("#form_"+this.name+"_tabs").length&&this.unmount(),this.last.observeResize?.disconnect(),delete r[this.name],e.finish())}setFocus(e){let t;if(void 0===e&&(e=this.focus),d.isInt(e)){if(e<0)return;for(var i=a(this.box).find("div:not(.w2ui-field-helper) > input, select, textarea, div > label:nth-child(1) > [type=radio]").filter(":not(.file-input)");null==i[e].offsetParent&&i.length>=e;)e++;i[e]&&(t=a(i[e]))}else"string"==typeof e&&(t=a(this.box).find(`[name='${e}']`));return 0<t.length&&t.get(0).focus(),t}}class S extends l{constructor(e,t){super(),"string"==typeof e&&null==t&&(t={type:e}),"object"==typeof e&&null==t&&(t=d.clone(e)),"string"==typeof e&&"object"==typeof t&&(t.type=e),t.type=String(t.type).toLowerCase(),this.el=t.el??null,this.selected=null,this.helpers={},this.type=t.type??"text",this.options=d.clone(t),this.onClick=t.onClick??null,this.onAdd=t.onAdd??null,this.onNew=t.onNew??null,this.onRemove=t.onRemove??null,this.onMouseEnter=t.onMouseEnter??null,this.onMouseLeave=t.onMouseLeave??null,this.onScroll=t.onScroll??null,this.tmp={},delete this.options.type,delete this.options.onClick,delete this.options.onMouseEnter,delete this.options.onMouseLeave,delete this.options.onScroll,this.el&&this.render(this.el)}render(e){e instanceof HTMLElement?(e._w2field?.reset?.(),(e._w2field=this).el=e,this.init()):console.log("ERROR: Cannot init w2field on empty subject")}init(){let e,t=this.options;if(["INPUT","TEXTAREA"].includes(this.el.tagName.toUpperCase())){switch(this.type){case"text":case"int":case"float":case"money":case"currency":case"percent":case"alphanumeric":case"bin":case"hex":e={min:null,max:null,step:1,autoFormat:!0,autoCorrect:!0,currencyPrefix:d.settings.currencyPrefix,currencySuffix:d.settings.currencySuffix,currencyPrecision:d.settings.currencyPrecision,decimalSymbol:d.settings.decimalSymbol,groupSymbol:d.settings.groupSymbol,arrow:!1,keyboard:!0,precision:null,prefix:"",suffix:""},this.options=d.extend({},e,t),(t=this.options).numberRE=new RegExp("["+t.groupSymbol+"]","g"),t.moneyRE=new RegExp("["+t.currencyPrefix+t.currencySuffix+t.groupSymbol+"]","g"),t.percentRE=new RegExp("["+t.groupSymbol+"%]","g"),["text","alphanumeric","hex","bin"].includes(this.type)&&(t.arrow=!1,t.keyboard=!1);break;case"color":var i=parseInt(getComputedStyle(this.el)["font-size"])||12;e={prefix:"#",suffix:`<div style="width: ${i}px; height: ${i}px; margin-top: -2px;\n                                    position: relative; top: 50%; transform: translateY(-50%);">&#160;</div>`,arrow:!1,advanced:null,transparent:!0},this.options=d.extend({},e,t),t=this.options;break;case"date":e={format:d.settings.dateFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0},this.options=d.extend({type:"date"},e,t),t=this.options,null==a(this.el).attr("placeholder")&&a(this.el).attr("placeholder",t.format);break;case"time":e={format:d.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,btnNow:!0,noMinutes:!1},this.options=d.extend({type:"time"},e,t),t=this.options,null==a(this.el).attr("placeholder")&&a(this.el).attr("placeholder",t.format);break;case"datetime":e={format:d.settings.dateFormat+"|"+d.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,startTime:null,endTime:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0,noMinutes:!1},this.options=d.extend({type:"datetime"},e,t),t=this.options,null==a(this.el).attr("placeholder")&&a(this.el).attr("placeholder",t.placeholder||t.format);break;case"list":case"combo":e={items:[],selected:{},prefix:"",suffix:"",openOnFocus:!1,icon:null,iconStyle:"",url:null,recId:null,recText:null,method:null,debounce:250,postData:{},minLength:1,cacheMax:250,maxDropHeight:350,maxDropWidth:null,minDropWidth:null,match:"begins",align:"both",altRows:!0,renderDrop:null,compare:null,filter:!0,hideSelected:!1,markSearch:!1,msgNoItems:"No matches",msgSearch:"Type to search...",onSearch:null,onRequest:null,onLoad:null,onError:null},"function"==typeof t.items&&(t._items_fun=t.items),t.items=d.normMenu.call(this,t.items),"list"===this.type&&(a(this.el).addClass("w2ui-select"),!d.isPlainObject(t.selected))&&Array.isArray(t.items)&&t.items.forEach((e=>{e&&e.id===t.selected&&(t.selected=d.clone(e))})),t=d.extend({},e,t),(i=["is","begins","contains","ends"]).includes(t.match)||console.log(`ERROR: invalid value "${t.match}" for option.match. It should be one of following: ${i.join(", ")}.`),this.options=t,d.isPlainObject(t.selected)||(t.selected={}),this.selected=t.selected,a(this.el).attr("autocapitalize","off").attr("autocomplete","off").attr("autocorrect","off").attr("spellcheck","false"),null!=t.selected.text&&a(this.el).val(t.selected.text);break;case"enum":e={items:[],selected:[],max:0,maxItemWidth:250,style:"",openOnFocus:!1,renderItem:null,onMouseEnter:null,onMouseLeave:null,onScroll:null,onClick:null,onAdd:null,onNew:null,onRemove:null,url:null,recId:null,recText:null,debounce:250,method:null,postData:{},minLength:1,cacheMax:250,match:"begins",align:"",altRows:!0,renderDrop:null,maxDropHeight:350,maxDropWidth:null,markSearch:!1,compare:null,filter:!0,hideSelected:!0,msgNoItems:"No matches",msgSearch:"Type to search...",onSearch:null,onRequest:null,onLoad:null,onError:null},"function"==typeof(t=d.extend({},e,t,{suffix:""})).items&&(t._items_fun=t.items),(i=["is","begins","contains","ends"]).includes(t.match)||console.log(`ERROR: invalid value "${t.match}" for option.match. It should be one of following: ${i.join(", ")}.`),t.items=d.normMenu.call(this,t.items),t.selected=d.normMenu.call(this,t.selected),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected;break;case"file":e={selected:[],max:0,maxSize:0,maxFileSize:0,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,readContent:!0,silent:!0,align:"both",altRows:!0,renderItem:null,style:"",onClick:null,onAdd:null,onRemove:null,onMouseEnter:null,onMouseLeave:null},t=d.extend({},e,t),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected,null==a(this.el).attr("placeholder")&&a(this.el).attr("placeholder",d.lang("Attach files by dragging and dropping or Click to Select"));break;default:console.log(`ERROR: field type "${this.type}" is not supported.`)}a(this.el).css("box-sizing","border-box").addClass("w2field w2ui-input").off(".w2field").on("change.w2field",(e=>{this.change(e)})).on("click.w2field",(e=>{this.click(e)})).on("focus.w2field",(e=>{this.focus(e)})).on("blur.w2field",(e=>{"list"!==this.type&&this.blur(e)})).on("keydown.w2field",(e=>{this.keyDown(e)})).on("keyup.w2field",(e=>{this.keyUp(e)})),this.addPrefix(),this.addSuffix(),this.addSearch(),this.addMultiSearch(),this.change(new Event("change"))}else console.log("ERROR: w2field could only be applied to INPUT or TEXTAREA.",this.el)}get(){return-1!==["list","enum","file"].indexOf(this.type)?this.selected:a(this.el).val()}set(e,t){-1!==["list","enum","file"].indexOf(this.type)?("list"!==this.type&&t?(Array.isArray(this.selected)||(this.selected=[]),this.selected.push(e),(t=f.get(this.el.id+"_menu"))&&(t.options.selected=this.selected)):(null==e&&(e=[]),t="enum"!==this.type||Array.isArray(e)?e:[e],this.selected=t),a(this.el).trigger("input").trigger("change"),this.refresh()):a(this.el).val(e)}setIndex(e,t){if(-1!==["list","enum"].indexOf(this.type)){var i=this.options.items;if(i&&i[e])return"list"==this.type&&(this.selected=i[e]),"enum"==this.type&&(t||(this.selected=[]),this.selected.push(i[e])),(t=f.get(this.el.id+"_menu"))&&(t.options.selected=this.selected),a(this.el).trigger("input").trigger("change"),this.refresh(),!0}return!1}refresh(){let e=this.options;var t=Date.now(),i=getComputedStyle(this.el);if("color"==this.type){let e=this.el.value;"#"!=e.substr(0,1)&&"rgb"!=e.substr(0,3)&&(e="#"+e),a(this.helpers.suffix).find(":scope > div").css("background-color",e)}if("list"==this.type){if(this.helpers.prefix&&this.helpers.prefix.hide(),!this.helpers.search)return;null==this.selected&&e.icon?e.prefix=`\n                    <span class="w2ui-icon ${e.icon} "style="cursor: pointer; font-size: 14px;\n                        display: inline-block; margin-top: -1px; color: #7F98AD; ${e.iconStyle}">\n                    </span>`:e.prefix="",this.addPrefix();let t=a(this.helpers.search_focus);var s=a(t[0].previousElementSibling);t.css({outline:"none"}),""===t.val()?(t.css("opacity",0),s.css("opacity",0),this.selected?.id?(n=this.selected.text,o=this.findItemIndex(e.items,this.selected.id),null!=n&&a(this.el).val(d.lang(n)).data({selected:n,selectedIndex:o[0]})):(this.el.value="",a(this.el).removeData("selected selectedIndex"))):(t.css("opacity",1),s.css("opacity",1),a(this.el).val(""),setTimeout((()=>{this.helpers.prefix&&this.helpers.prefix.hide(),e.icon?(t.css("margin-left","17px"),a(this.helpers.search).find(".w2ui-icon-search").addClass("show-search")):(t.css("margin-left","0px"),a(this.helpers.search).find(".w2ui-icon-search").removeClass("show-search"))}),1)),a(this.el).prop("readOnly")||a(this.el).prop("disabled")?setTimeout((()=>{this.helpers.prefix&&a(this.helpers.prefix).css("opacity","0.6"),this.helpers.suffix&&a(this.helpers.suffix).css("opacity","0.6")}),1):setTimeout((()=>{this.helpers.prefix&&a(this.helpers.prefix).css("opacity","1"),this.helpers.suffix&&a(this.helpers.suffix).css("opacity","1")}),1)}let l=this.helpers.multi;if(["enum","file"].includes(this.type)&&l){let t="";Array.isArray(this.selected)&&this.selected.forEach(((i,s)=>{null!=i&&(t+=`\n                        <div class="li-item" index="${s}" style="max-width: ${parseInt(e.maxItemWidth)}px; ${i.style||""}">\n                        ${"function"==typeof e.renderItem?e.renderItem(i,s,`<div class="w2ui-list-remove" index="${s}">&#160;&#160;</div>`):`\n                               ${i.icon?`<span class="w2ui-icon ${i.icon}"></span>`:""}\n                               <div class="w2ui-list-remove" index="${s}">&#160;&#160;</div>\n                               ${("enum"===this.type?i.text:i.name)??i.id??i}\n                               ${i.size?`<span class="file-size"> - ${d.formatSize(i.size)}</span>`:""}\n                            `}\n                        </div>`)}));var o,n=l.find(".w2ui-multi-items");e.style&&l.attr("style",l.attr("style")+";"+e.style),a(this.el).css("z-index","-1"),a(this.el).prop("readOnly")||a(this.el).prop("disabled")?setTimeout((()=>{l[0].scrollTop=0,l.addClass("w2ui-readonly").find(".li-item").css("opacity","0.9").parent().find(".li-search").hide().find("input").prop("readOnly",!0).closest(".w2ui-multi-items").find(".w2ui-list-remove").hide()}),1):setTimeout((()=>{l.removeClass("w2ui-readonly").find(".li-item").css("opacity","1").parent().find(".li-search").show().find("input").prop("readOnly",!1).closest(".w2ui-multi-items").find(".w2ui-list-remove").show()}),1),0<this.selected?.length&&a(this.el).attr("placeholder",""),l.find(".w2ui-enum-placeholder").remove(),n.find(".li-item").remove(),""!==t?n.prepend(t):null!=a(this.el).attr("placeholder")&&""===l.find("input").val()&&(o=d.stripSpaces(`\n                    padding-top: ${i["padding-top"]};\n                    padding-left: ${i["padding-left"]};\n                    box-sizing: ${i["box-sizing"]};\n                    line-height: ${i["line-height"]};\n                    font-size: ${i["font-size"]};\n                    font-family: ${i["font-family"]};\n                `),l.prepend(`<div class="w2ui-enum-placeholder" style="${o}">${a(this.el).attr("placeholder")}</div>`)),l.off(".w2item").on("scroll.w2item",(e=>{!0!==(e=this.trigger("scroll",{target:this.el,originalEvent:e})).isCancelled&&(g.hide(this.el.id+"_preview"),e.finish())})).find(".li-item").on("click.w2item",(e=>{var t=a(e.target).closest(".li-item"),i=t.attr("index"),s=this.selected[i];if(!a(t).hasClass("li-search")){let l;if(e.stopPropagation(),a(e.target).hasClass("w2ui-list-remove"))a(this.el).prop("readOnly")||a(this.el).prop("disabled")||!0!==(l=this.trigger("remove",{target:this.el,originalEvent:e,item:s})).isCancelled&&(this.selected.splice(i,1),a(this.el).trigger("input").trigger("change"),a(e.target).remove());else if(!0!==(l=this.trigger("click",{target:this.el,originalEvent:e.originalEvent,item:s})).isCancelled){let e=s.tooltip;if("file"===this.type&&(/image/i.test(s.type)&&(e=`\n                                    <div class="w2ui-file-preview">\n                                        <img src="${s.content?"data:"+s.type+";base64,"+s.content:""}"\n                                            style="max-width: 300px">\n                                    </div>`),e+=`\n                                <div class="w2ui-file-info">\n                                    <div class="file-caption">${d.lang("Name")}:</div>\n                                    <div class="file-value">${s.name}</div>\n                                    <div class="file-caption">${d.lang("Size")}:</div>\n                                    <div class="file-value">${d.formatSize(s.size)}</div>\n                                    <div class="file-caption">${d.lang("Type")}:</div>\n                                    <div class="file-value file-type">${s.type}</div>\n                                    <div class="file-caption">${d.lang("Modified")}:</div>\n                                    <div class="file-value">${d.date(s.modified)}</div>\n                                </div>`),e){let i=this.el.id+"_preview";g.show({name:i,anchor:t.get(0),html:e,hideOn:["doc-click"],class:""}).show((e=>{a(`#w2overlay-${i} img`).on("load",(function(e){var t=this.clientWidth,i=this.clientHeight;t<300&i<300||(i<=t&&300<t&&a(this).css("width","300px"),t<i&&300<i&&a(this).css("height","300px"))})).on("error",(function(e){this.style.display="none"}))}))}l.finish()}}})).on("mouseenter.w2item",(e=>{var t=a(e.target).closest(".li-item");a(t).hasClass("li-search")||(t=this.selected[a(e.target).attr("index")],!0!==(e=this.trigger("mouseEnter",{target:this.el,originalEvent:e,item:t})).isCancelled&&e.finish())})).on("mouseleave.w2item",(e=>{var t=a(e.target).closest(".li-item");a(t).hasClass("li-search")||(t=this.selected[a(e.target).attr("index")],!0!==(e=this.trigger("mouseLeave",{target:this.el,originalEvent:e,item:t})).isCancelled&&e.finish())})),"enum"===this.type?this.helpers.multi.find("input").css({width:"15px"}):this.helpers.multi.find(".li-search").hide(),this.resize()}return Date.now()-t}resize(){var e=this.el.clientWidth,t=getComputedStyle(this.el),i=this.helpers.search,s=this.helpers.multi,l=this.helpers.suffix,o=this.helpers.prefix;if(i&&a(i).css("width",e),s&&a(s).css("width",e-parseInt(t["margin-left"],10)-parseInt(t["margin-right"],10)),l&&this.addSuffix(),o&&this.addPrefix(),i=this.helpers.multi,["enum","file"].includes(this.type)&&i){a(this.el).css("height","");let e=a(i).find(":scope div.w2ui-multi-items").get(0).clientHeight+5;(e=(e=e<20?20:e)>this.tmp["max-height"]?this.tmp["max-height"]:e)<this.tmp["min-height"]&&(e=this.tmp["min-height"]),(s=d.getSize(this.el,"height")-2)>e&&(e=s),a(i).css({height:e+"px",overflow:e==this.tmp["max-height"]?"auto":"hidden"}),a(i).css("height",e+"px"),a(this.el).css({height:e+"px"})}this.tmp.current_width=e}reset(){null!=this.tmp&&(a(this.el).css("height",""),Array("padding-left","padding-right","background-color","border-color").forEach((e=>{this.tmp&&null!=this.tmp["old-"+e]&&(a(this.el).css(e,this.tmp["old-"+e]),delete this.tmp["old-"+e])})),clearInterval(this.tmp.sizeTimer)),a(this.el).val(this.clean(a(this.el).val())).removeClass("w2field w2ui-input").removeData("selected selectedIndex").off(".w2field"),Object.keys(this.helpers).forEach((e=>{a(this.helpers[e]).remove()})),this.helpers={},delete this.el._w2field}clean(e){var t;return"number"!=typeof e&&(t=this.options,e=String(e).trim(),["int","float","money","currency","percent"].includes(this.type))?""!==(e="string"==typeof e?(e=t.autoFormat&&(["money","currency"].includes(this.type)&&(e=String(e).replace(t.moneyRE,"")),"percent"===this.type&&(e=String(e).replace(t.percentRE,"")),["int","float"].includes(this.type))?String(e).replace(t.numberRE,""):e).replace(/\s+/g,"").replace(new RegExp(t.groupSymbol,"g"),"").replace(t.decimalSymbol,"."):e)&&d.isFloat(e)?Number(e):"":e}format(e){var t=this.options;if(t.autoFormat&&""!==e){switch(this.type){case"money":case"currency":""!==(e=d.formatNumber(e,t.currencyPrecision,!0))&&(e=t.currencyPrefix+e+t.currencySuffix);break;case"percent":""!==(e=d.formatNumber(e,t.precision,!0))&&(e+="%");break;case"float":e=d.formatNumber(e,t.precision,!0);break;case"int":e=d.formatNumber(e,0,!0)}var i=parseInt(1e3).toLocaleString(d.settings.locale,{useGrouping:!0}).slice(1,2);i!==this.options.groupSymbol&&(e=e.replaceAll(i,this.options.groupSymbol))}return e}change(e){if(-1!==["int","float","money","currency","percent"].indexOf(this.type)){var t=a(this.el).val(),i=this.format(this.clean(a(this.el).val()));if(""!==t&&t!=i)return a(this.el).val(i),e.stopPropagation(),e.preventDefault(),!1}if("color"===this.type){let e=a(this.el).val();"rgb"!==e.substr(0,3).toLowerCase()&&(e="#"+e,8!==(t=a(this.el).val().length))&&6!==t&&3!==t&&(e=""),i=a(this.el).get(0).nextElementSibling,a(i).find("div").css("background-color",e),a(this.el).hasClass("has-focus")&&this.updateOverlay()}if(-1!==["list","enum","file"].indexOf(this.type)&&this.refresh(),-1!==["date","time","datetime"].indexOf(this.type)){let e=parseInt(this.el.value);d.isInt(this.el.value)&&3e3<e&&("time"===this.type&&(e=d.formatTime(new Date(e),this.options.format)),"date"===this.type&&(e=d.formatDate(new Date(e),this.options.format)),"datetime"===this.type&&(e=d.formatDateTime(new Date(e),this.options.format)),a(this.el).val(e).trigger("input").trigger("change"))}}click(e){var t;["list","combo","enum"].includes(this.type)&&(a(this.el).hasClass("has-focus")||this.focus(e),"list"!=this.type&&"combo"!=this.type||(this.tmp.openedOnFocus||(t=this.el.id+"_menu",f.get(t)?.displayed?f.hide(t):this.updateOverlay()),delete this.tmp.openedOnFocus,"list"==this.type&&e.stopPropagation())),["date","time","datetime","color"].includes(this.type)&&this.updateOverlay()}focus(e){if("list"==this.type&&document.activeElement==this.el)this.helpers.search_focus.focus();else{if(-1!==["color","date","time","datetime"].indexOf(this.type)){if(a(this.el).prop("readOnly")||a(this.el).prop("disabled"))return;this.updateOverlay()}if(-1!==["list","combo","enum"].indexOf(this.type)){if(a(this.el).prop("readOnly")||a(this.el).prop("disabled"))return void a(this.el).addClass("has-focus");"function"==typeof this.options._items_fun&&(this.options.items=d.normMenu.call(this,this.options._items_fun)),this.helpers.search&&((t=this.helpers.search_focus).value="",t.select()),"enum"==this.type&&(t=a(this.el.previousElementSibling).find(".li-search input").get(0),document.activeElement!==t)&&t.focus(),this.resize(),!1===e.showMenu||!1===this.options.openOnFocus&&!a(this.el).hasClass("has-focus")||this.tmp.overlay?.overlay?.displayed||setTimeout((()=>{this.tmp.openedOnFocus=!0,this.updateOverlay()}),0)}var t;"file"==this.type&&(t=a(this.el).get(0).previousElementSibling,a(t).addClass("has-focus")),a(this.el).addClass("has-focus")}}blur(e){var t,i=a(this.el).val().trim();if(a(this.el).removeClass("has-focus"),["int","float","money","currency","percent"].includes(this.type)&&""!==i){let e=i,s="";this.isStrValid(i)?(t=this.clean(i),null!=this.options.min&&t<this.options.min&&(e=this.options.min,s="Should be >= "+this.options.min),null!=this.options.max&&t>this.options.max&&(e=this.options.max,s="Should be <= "+this.options.max)):e="",this.options.autoCorrect&&(a(this.el).val(e).trigger("input").trigger("change"),s)&&(g.show({name:this.el.id+"_error",anchor:this.el,html:s}),setTimeout((()=>{g.hide(this.el.id+"_error")}),3e3))}["date","time","datetime"].includes(this.type)&&this.options.autoCorrect&&""!==i&&(t="date"==this.type?d.isDate:"time"==this.type?d.isTime:d.isDateTime,b.inRange(this.el.value,this.options)&&t.bind(d)(this.el.value,this.options.format)||a(this.el).val("").trigger("input").trigger("change")),"enum"===this.type&&a(this.helpers.multi).find("input").val("").css("width","15px"),"file"==this.type&&(i=this.el.previousElementSibling,a(i).removeClass("has-focus")),"list"===this.type&&(this.el.value=this.selected?.text??"")}keyDown(e,t){var i,s=this.options;t=e.keyCode||t&&t.keyCode;let l,o,n,r,h,c,u=!1;if(["int","float","money","currency","percent","hex","bin","color","alphanumeric"].includes(this.type)&&!(e.metaKey||e.ctrlKey||e.altKey||this.isStrValid(e.key??"1",!0)||[9,8,13,27,37,38,39,40,46].includes(e.keyCode)))return e.preventDefault(),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!1;if(["int","float","money","currency","percent"].includes(this.type)){if(!s.keyboard||a(this.el).prop("readOnly")||a(this.el).prop("disabled"))return;switch(l=parseFloat(a(this.el).val().replace(s.moneyRE,""))||0,o=s.step,(e.ctrlKey||e.metaKey)&&(o=10*s.step),t){case 38:e.shiftKey||(h=l+o<=s.max||null==s.max?Number((l+o).toFixed(12)):s.max,a(this.el).val(h).trigger("input").trigger("change"),u=!0);break;case 40:e.shiftKey||(h=l-o>=s.min||null==s.min?Number((l-o).toFixed(12)):s.min,a(this.el).val(h).trigger("input").trigger("change"),u=!0)}u&&(e.preventDefault(),this.moveCaret2end())}if(["date","datetime"].includes(this.type)){if(!s.keyboard||a(this.el).prop("readOnly")||a(this.el).prop("disabled"))return;var p=("date"==this.type?d.isDate:d.isDateTime).bind(d),m=("date"==this.type?d.formatDate:d.formatDateTime).bind(d);switch(n=864e5,o=1,(e.ctrlKey||e.metaKey)&&(o=10),(r=p(a(this.el).val(),s.format,!0))||(r=new Date,n=0),t){case 38:e.shiftKey||(10==o?r.setMonth(r.getMonth()+1):r.setTime(r.getTime()+n),c=m(r.getTime(),s.format),a(this.el).val(c).trigger("input").trigger("change"),u=!0);break;case 40:e.shiftKey||(10==o?r.setMonth(r.getMonth()-1):r.setTime(r.getTime()-n),c=m(r.getTime(),s.format),a(this.el).val(c).trigger("input").trigger("change"),u=!0)}u&&(e.preventDefault(),this.moveCaret2end(),this.updateOverlay())}if("time"===this.type){if(!s.keyboard||a(this.el).prop("readOnly")||a(this.el).prop("disabled"))return;o=e.ctrlKey||e.metaKey?60:1,l=a(this.el).val();let i=b.str2min(l)||b.str2min((new Date).getHours()+":"+((new Date).getMinutes()-1));switch(t){case 38:e.shiftKey||(i+=o,u=!0);break;case 40:e.shiftKey||(i-=o,u=!0)}u&&(e.preventDefault(),a(this.el).val(b.min2str(i)).trigger("input").trigger("change"),this.moveCaret2end())}if(["list","enum"].includes(this.type))switch(t){case 8:case 46:"list"==this.type?""==a(this.helpers.search_focus).val()&&(this.selected=null,f.hide(this.el.id+"_menu"),a(this.el).val("").trigger("input").trigger("change")):""==a(this.helpers.multi).find("input").val()&&(f.hide(this.el.id+"_menu"),this.selected.pop(),(i=f.get(this.el.id+"_menu"))&&(i.options.selected=this.selected),this.refresh());break;case 9:case 16:break;case 27:f.hide(this.el.id+"_menu"),this.refresh()}}keyUp(e){if("list"==this.type){let t=a(this.helpers.search_focus);""!==t.val()?a(this.el).attr("placeholder",""):a(this.el).attr("placeholder",this.tmp.pholder),13==e.keyCode&&setTimeout((()=>{t.val(""),f.hide(this.el.id+"_menu"),this.refresh()}),1),[38,40].includes(e.keyCode)&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay(),this.refresh()}var t,i;"combo"==this.type&&([9,16,27].includes(e.keyCode)||!0===this.options.openOnFocus||this.updateOverlay(),[38,40].includes(e.keyCode))&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay(),"enum"==this.type&&(t=this.helpers.multi.find("input"),i=getComputedStyle(t.get(0)),i=d.getStrWidth(t.val(),`font-family: ${i["font-family"]}; font-size: ${i["font-size"]};`),t.css({width:i+15+"px"}),this.resize(),[38,40].includes(e.keyCode))&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay()}findItemIndex(e,t,i){let s=[];var l;return i=i||[],["list","combo","enum"].includes(this.type)&&this.options.url&&(l=f.get(this.el.id+"_menu"))&&(e=l.options.items,this.options.items=e),e.forEach(((e,l)=>{e.id===t&&(s=i.concat([l]),this.options.index=[l]),0==s.length&&e.items&&0<e.items.length&&(i.push(l),s=this.findItemIndex(e.items,t,i),i.pop())})),s}updateOverlay(e){let t=this.options;if("color"===this.type){if(a(this.el).prop("readOnly")||a(this.el).prop("disabled"))return;w.show(d.extend({name:this.el.id+"_color",anchor:this.el,transparent:t.transparent,advanced:t.advanced,color:this.el.value,liveUpdate:!0},this.options)).select((e=>{e=e.detail.color,a(this.el).val(e).trigger("input").trigger("change")})).liveUpdate((e=>{e=e.detail.color,a(this.helpers.suffix).find(":scope > div").css("background-color","#"+e)}))}if(["list","combo","enum"].includes(this.type)){var i;this.el;let e=this.el;"enum"===this.type&&(i=this.helpers.multi.get(0),e=a(i).find("input").get(0)),"list"===this.type&&(i=this.selected,d.isPlainObject(i)&&0<Object.keys(i).length&&0<(i=this.findItemIndex(t.items,i.id)).length&&(t.index=i),e=this.helpers.search_focus),!a(this.el).hasClass("has-focus")||this.el.readOnly||this.el.disabled||(i=d.extend({},t,{name:this.el.id+"_menu",anchor:e,selected:this.selected,search:!1,render:t.renderDrop,anchorClass:"",offsetY:5,maxHeight:t.maxDropHeight,maxWidth:t.maxDropWidth,minWidth:t.minDropWidth}),this.tmp.overlay=f.show(i).select((i=>{var s,l;["list","combo"].includes(this.type)?(this.selected=i.detail.item,a(e).val(""),a(this.el).val(this.selected.text).trigger("input").trigger("change"),this.focus({showMenu:!1})):(l=this.selected,(s=i.detail?.item)&&!0!==(i=this.trigger("add",{target:this.el,item:s,originalEvent:i})).isCancelled&&(l.length>=t.max&&0<t.max&&l.pop(),delete s.hidden,l.push(s),a(this.el).trigger("input").trigger("change"),a(this.helpers.multi).find("input").val(""),(l=f.get(this.el.id+"_menu"))&&(l.options.selected=this.selected),i.finish()))})))}!["date","time","datetime"].includes(this.type)||a(this.el).prop("readOnly")||a(this.el).prop("disabled")||b.show(d.extend({name:this.el.id+"_date",anchor:this.el,value:this.el.value},this.options)).select((e=>{null!=(e=e.detail.date)&&a(this.el).val(e).trigger("input").trigger("change")}))}isStrValid(e,t){let i=!0;switch(this.type){case"int":i=!(!t||!["-",this.options.groupSymbol].includes(e))||d.isInt(e.replace(this.options.numberRE,""));break;case"percent":e=e.replace(/%/g,"");case"float":i=!(!t||!["-","",this.options.decimalSymbol,this.options.groupSymbol].includes(e))||d.isFloat(e.replace(this.options.numberRE,""));break;case"money":case"currency":i=!(!t||!["-",this.options.decimalSymbol,this.options.groupSymbol,this.options.currencyPrefix,this.options.currencySuffix].includes(e))||d.isFloat(e.replace(this.options.moneyRE,""));break;case"bin":i=d.isBin(e);break;case"color":case"hex":i=d.isHex(e);break;case"alphanumeric":i=d.isAlphaNumeric(e)}return i}addPrefix(){var e,t;this.options.prefix&&(t=getComputedStyle(this.el),null==this.tmp["old-padding-left"]&&(this.tmp["old-padding-left"]=t["padding-left"]),this.helpers.prefix&&a(this.helpers.prefix).remove(),a(this.el).before(`<div class="w2ui-field-helper">${this.options.prefix}</div>`),e=a(this.el).get(0).previousElementSibling,a(e).css({color:t.color,"font-family":t["font-family"],"font-size":t["font-size"],height:this.el.clientHeight+"px","padding-top":parseInt(t["padding-top"],10)+1+"px","padding-bottom":parseInt(t["padding-bottom"],10)-1+"px","padding-left":this.tmp["old-padding-left"],"padding-right":0,"margin-top":parseInt(t["margin-top"],10)+"px","margin-bottom":parseInt(t["margin-bottom"],10)+"px","margin-left":t["margin-left"],"margin-right":0,"z-index":1,display:"flex","align-items":"center"}),a(this.el).css("padding-left",e.clientWidth+"px !important"),this.helpers.prefix=e)}addSuffix(){if(this.options.suffix||this.options.arrow){let i,s=this;var e=getComputedStyle(this.el),t=(null==this.tmp["old-padding-right"]&&(this.tmp["old-padding-right"]=e["padding-right"]),parseInt(e["padding-right"]||0));this.options.arrow&&(this.helpers.arrow&&a(this.helpers.arrow).remove(),a(this.el).after('<div class="w2ui-field-helper" style="border: 1px solid transparent">&#160;    <div class="w2ui-field-up" type="up">        <div class="arrow-up" type="up"></div>    </div>    <div class="w2ui-field-down" type="down">        <div class="arrow-down" type="down"></div>    </div></div>'),i=a(this.el).get(0).nextElementSibling,a(i).css({color:e.color,"font-family":e["font-family"],"font-size":e["font-size"],height:this.el.clientHeight+"px",padding:0,"margin-top":parseInt(e["margin-top"],10)+1+"px","margin-bottom":0,"border-left":"1px solid silver",width:"16px",transform:"translateX(-100%)"}).on("mousedown",(function(e){a(e.target).hasClass("arrow-up")&&s.keyDown(e,{keyCode:38}),a(e.target).hasClass("arrow-down")&&s.keyDown(e,{keyCode:40})})),t+=i.clientWidth,a(this.el).css("padding-right",t+"px !important"),this.helpers.arrow=i),""!==this.options.suffix&&(this.helpers.suffix&&a(this.helpers.suffix).remove(),a(this.el).after(`<div class="w2ui-field-helper">${this.options.suffix}</div>`),i=a(this.el).get(0).nextElementSibling,a(i).css({color:e.color,"font-family":e["font-family"],"font-size":e["font-size"],height:this.el.clientHeight+"px","padding-top":e["padding-top"],"padding-bottom":e["padding-bottom"],"padding-left":0,"padding-right":e["padding-right"],"margin-top":parseInt(e["margin-top"],10)+2+"px","margin-bottom":parseInt(e["margin-bottom"],10)+1+"px",transform:"translateX(-100%)"}),a(this.el).css("padding-right",i.clientWidth+"px !important"),this.helpers.suffix=i)}}addSearch(){if("list"===this.type){this.helpers.search&&a(this.helpers.search).remove();let i=parseInt(a(this.el).attr("tabIndex")),s=(isNaN(i)||-1===i||(this.tmp["old-tabIndex"]=i),null!=(i=this.tmp["old-tabIndex"]?this.tmp["old-tabIndex"]:i)&&!isNaN(i)||(i=0),"");var e=`\n            <div class="w2ui-field-helper">\n                <span class="w2ui-icon w2ui-icon-search"></span>\n                <input ${s=null!=a(this.el).attr("id")?'id="'+a(this.el).attr("id")+'_search"':s} type="text" tabIndex="${i}" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"/>\n            </div>`,t=(a(this.el).attr("tabindex",-1).before(e),e=a(this.el).get(0).previousElementSibling,this.helpers.search=e,this.helpers.search_focus=a(e).find("input").get(0),getComputedStyle(this.el));a(e).css({width:this.el.clientWidth+"px","margin-top":t["margin-top"],"margin-left":t["margin-left"],"margin-bottom":t["margin-bottom"],"margin-right":t["margin-right"]}).find("input").css({cursor:"default",width:"100%",opacity:1,padding:t.padding,margin:t.margin,border:"1px solid transparent","background-color":"transparent"}),a(e).find("input").off(".helper").on("focus.helper",(e=>{a(e.target).val(""),this.tmp.pholder=a(this.el).attr("placeholder")??"",this.focus(e),e.stopPropagation()})).on("blur.helper",(e=>{a(e.target).val(""),null!=this.tmp.pholder&&a(this.el).attr("placeholder",this.tmp.pholder),this.blur(e),e.stopPropagation()})).on("keydown.helper",(e=>{this.keyDown(e)})).on("keyup.helper",(e=>{this.keyUp(e)})),a(e).on("click",(e=>{a(e.target).find("input").focus()}))}}addMultiSearch(){if(["enum","file"].includes(this.type)){a(this.helpers.multi).remove();let l="";var e,t,i=getComputedStyle(this.el),s=d.stripSpaces(`\n            margin-top: 0px;\n            margin-bottom: 0px;\n            margin-left: ${i["margin-left"]};\n            margin-right: ${i["margin-right"]};\n            width: ${d.getSize(this.el,"width")-parseInt(i["margin-left"],10)-parseInt(i["margin-right"],10)}px;\n        `);null==this.tmp["min-height"]&&(e=this.tmp["min-height"]=parseInt(("none"!=i["min-height"]?i["min-height"]:0)||0),t=parseInt(i.height),this.tmp["min-height"]=Math.max(e,t)),null==this.tmp["max-height"]&&"none"!=i["max-height"]&&(this.tmp["max-height"]=parseInt(i["max-height"]));let o="",n=(null!=a(this.el).attr("id")&&(o=`id="${a(this.el).attr("id")}_search"`),parseInt(a(this.el).attr("tabIndex"))),r=(isNaN(n)||-1===n||(this.tmp["old-tabIndex"]=n),null!=(n=this.tmp["old-tabIndex"]?this.tmp["old-tabIndex"]:n)&&!isNaN(n)||(n=0),"enum"===this.type&&(l=`\n            <div class="w2ui-field-helper w2ui-list" style="${s}">\n                <div class="w2ui-multi-items">\n                    <div class="li-search">\n                        <input ${o} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"\n                            tabindex="${n}"\n                            ${a(this.el).prop("readOnly")?"readonly":""}\n                            ${a(this.el).prop("disabled")?"disabled":""}>\n                    </div>\n                </div>\n            </div>`),"file"===this.type&&(l=`\n            <div class="w2ui-field-helper w2ui-list" style="${s}">\n                <div class="w2ui-multi-file">\n                    <input name="attachment" class="file-input" type="file" tabindex="-1"'\n                        style="width: 100%; height: 100%; opacity: 0" title=""\n                        ${1!==this.options.max?"multiple":""}\n                        ${a(this.el).prop("readOnly")||a(this.el).prop("disabled")?"disabled":""}\n                        ${a(this.el).attr("accept")?' accept="'+a(this.el).attr("accept")+'"':""}>\n                </div>\n                <div class="w2ui-multi-items">\n                    <div class="li-search" style="display: none">\n                        <input ${o} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"\n                            tabindex="${n}"\n                            ${a(this.el).prop("readOnly")?"readonly":""}\n                            ${a(this.el).prop("disabled")?"disabled":""}>\n                    </div>\n                </div>\n            </div>`),this.tmp["old-background-color"]=i["background-color"],this.tmp["old-border-color"]=i["border-color"],a(this.el).before(l).css({"border-color":"transparent","background-color":"transparent"}),a(this.el.previousElementSibling));this.helpers.multi=r,a(this.el).attr("tabindex",-1),r.on("click",(e=>{this.focus(e)})),r.find("input:not(.file-input)").on("click",(e=>{this.click(e)})).on("focus",(e=>{this.focus(e)})).on("blur",(e=>{this.blur(e)})).on("keydown",(e=>{this.keyDown(e)})).on("keyup",(e=>{this.keyUp(e)})),"file"===this.type&&r.find("input.file-input").off(".drag").on("click.drag",(e=>{e.stopPropagation(),a(this.el).prop("readOnly")||a(this.el).prop("disabled")||this.focus(e)})).on("dragenter.drag",(e=>{a(this.el).prop("readOnly")||a(this.el).prop("disabled")||r.addClass("w2ui-file-dragover")})).on("dragleave.drag",(e=>{a(this.el).prop("readOnly")||a(this.el).prop("disabled")||r.removeClass("w2ui-file-dragover")})).on("drop.drag",(e=>{a(this.el).prop("readOnly")||a(this.el).prop("disabled")||(r.removeClass("w2ui-file-dragover"),Array.from(e.dataTransfer.files).forEach((e=>{this.addFile(e)})),this.focus(e),e.preventDefault(),e.stopPropagation())})).on("dragover.drag",(e=>{e.preventDefault(),e.stopPropagation()})).on("change.drag",(e=>{void 0!==e.target.files&&Array.from(e.target.files).forEach((e=>{this.addFile(e)})),this.focus(e)})),this.refresh()}}addFile(e){var t=this.options,i=this.selected;let s={name:e.name,type:e.type,modified:e.lastModifiedDate,size:e.size,content:null,file:e},l=0,o=0,n=[],r=(Array.isArray(i)&&i.forEach((t=>{t.name==e.name&&t.size==e.size&&n.push(d.lang('The file "${name}" (${size}) is already added.',{name:e.name,size:d.formatSize(e.size)})),l+=t.size,o++})),0!==t.maxFileSize&&s.size>t.maxFileSize&&n.push(d.lang("Maximum file size is ${size}",{size:d.formatSize(t.maxFileSize)})),0!==t.maxSize&&l+s.size>t.maxSize&&n.push(d.lang("Maximum total size is ${size}",{size:d.formatSize(t.maxSize)})),0!==t.max&&o>=t.max&&n.push(d.lang("Maximum number of files is ${count}",{count:t.max})),this.trigger("add",{target:this.el,file:s,total:o,totalSize:l,errors:n}));if(!0!==r.isCancelled)if(!0!==t.silent&&0<n.length)g.show({anchor:this.el,html:"Errors: "+n.join("<br>")}),console.log("ERRORS (while adding files): ",n);else if(i.push(s),"undefined"!=typeof FileReader&&!0===t.readContent){i=new FileReader;let t=this;i.onload=function(e){var i=(e=e.target.result).indexOf(",");s.content=e.substr(i+1),t.refresh(),a(t.el).trigger("input").trigger("change"),r.finish()},i.readAsDataURL(e)}else this.refresh(),a(this.el).trigger("input").trigger("change"),r.finish()}moveCaret2end(){setTimeout((()=>{this.el.setSelectionRange(this.el.value.length,this.el.value.length)}),0)}}},872:(e,t,i)=>{i.a(e,(async(e,t)=>{try{var s=i(675),l=(i(947),i(688)),o=i(80),n=i(715),a=i(402),r=i(830),d=i(71),h=i(229);let e=new(i(972).A)({y:0,x:0},[]);window.IconPicker=e,window.w2layout=s.Yw,window.w2alert=s.mJ,window.w2grid=s.A$,window.query=s.P,window.EditorWindowSidebar=l.A,window.EditorWindowTopMenu=o.A,window.EditorWindowStatusBar=n.A,window.EditorWindow=a.A,window.DefaultStart=r.A,(0,d.C$)(),window.updateQueue=d.df,window.sendQueue=d.oU,window.allIcons=await(0,h.A)(),window.IconPicker.icons=window.allIcons,t()}catch(e){t(e)}}),1)}},o={};function n(e){var t=o[e];if(void 0!==t)return t.exports;var i=o[e]={exports:{}};return l[e](i,i.exports,n),i.exports}e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",i="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",s=e=>{e&&e.d<1&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},n.a=(l,o,n)=>{var a;n&&((a=[]).d=-1);var r,d,h,c=new Set,u=l.exports,p=new Promise(((e,t)=>{h=t,d=e}));p[t]=u,p[e]=e=>(a&&e(a),c.forEach(e),p.catch((e=>{}))),l.exports=p,o((l=>{var o;r=(l=>l.map((l=>{if(null!==l&&"object"==typeof l){if(l[e])return l;if(l.then){var o=[];o.d=0,l.then((e=>{n[t]=e,s(o)}),(e=>{n[i]=e,s(o)}));var n={};return n[e]=e=>e(o),n}}var a={};return a[e]=e=>{},a[t]=l,a})))(l);var n=()=>r.map((e=>{if(e[i])throw e[i];return e[t]})),d=new Promise((t=>{(o=()=>t(n)).r=0;var i=e=>e!==a&&!c.has(e)&&(c.add(e),e&&!e.d&&(o.r++,e.push(o)));r.map((t=>t[e](i)))}));return o.r?d:n()}),(e=>(e?h(p[i]=e):d(u),s(a)))),a&&a.d<0&&(a.d=0)},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n(872)})();