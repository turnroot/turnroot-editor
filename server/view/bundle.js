(()=>{"use strict";class e{constructor(e,t){Object.assign(this,{type:t.type??null,detail:t,owner:e,target:t.target??null,phase:t.phase??"before",object:t.object??null,execute:null,isStopped:!1,isCancelled:!1,onComplete:null,listeners:[]}),delete t.type,delete t.target,delete t.object,this.complete=new Promise(((e,t)=>{this._resolve=e,this._reject=t})),this.complete.catch((()=>{}))}finish(e){e&&a.extend(this.detail,e),this.phase="after",this.owner.trigger.call(this.owner,this)}done(e){this.listeners.push(e)}preventDefault(){this._reject(),this.isCancelled=!0}stopPropagation(){this.isStopped=!0}}class t{constructor(e){if(this.activeEvents=[],this.listeners=[],void 0!==e){if(!a.checkName(e))return;n[e]=this}this.debug=!1}on(e,t){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach((e=>{var i,s,l,n="string"==typeof e?e:e.type+":"+e.execute+"."+e.scope;"string"==typeof e&&([s,i]=e.split("."),[s,l]=s.replace(":complete",":after").replace(":done",":after").split(":"),e={type:s,execute:l??"before",scope:i}),(e=a.extend({type:null,execute:"before",onComplete:null},e)).type?t?(Array.isArray(this.listeners)||(this.listeners=[]),this.listeners.push({name:n,edata:e,handler:t}),this.debug&&console.log("w2base: add event",{name:n,edata:e,handler:t})):console.log("ERROR: You must specify event handler function when calling .on() method of "+this.name):console.log("ERROR: You must specify event type when calling .on() method of "+this.name)})),this}off(e,t){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach((e=>{var i,s,l,n="string"==typeof e?e:e.type+":"+e.execute+"."+e.scope;if("string"==typeof e&&([s,i]=e.split("."),[s,l]=s.replace(":complete",":after").replace(":done",":after").split(":"),e={type:s||"*",execute:l||"",scope:i||""}),(e=a.extend({type:null,execute:null,onComplete:null},e)).type||e.scope){t=t||null;let i=0;this.listeners=this.listeners.filter((t=>"*"!==e.type&&e.type!==t.edata.type||""!==e.execute&&e.execute!==t.edata.execute||""!==e.scope&&e.scope!==t.edata.scope||null!=e.handler&&e.handler!==t.edata.handler||(i++,!1))),this.debug&&console.log(`w2base: remove event (${i})`,{name:n,edata:e,handler:t})}else console.log("ERROR: You must specify event type when calling .off() method of "+this.name)})),this}trigger(t,i){if(1==arguments.length?i="string"==typeof t?{type:t,target:this}:t:(i.type=t,i.target=i.target??this),a.isPlainObject(i)&&"after"==i.phase){if(!(i=this.activeEvents.find((e=>e.type==i.type&&e.target==i.target))))return void console.log(`ERROR: Cannot find even handler for "${i.type}" on "${i.target}".`);console.log("NOTICE: This syntax \"edata.trigger({ phase: 'after' })\" is outdated. Use edata.finish() instead.")}else i instanceof e||(i=new e(this,i),this.activeEvents.push(i));let s,l,n;Array.isArray(this.listeners)||(this.listeners=[]),this.debug&&console.log(`w2base: trigger "${i.type}:${i.phase}"`,i);for(let e=this.listeners.length-1;0<=e;e--){let t=this.listeners[e];if(!(null==t||t.edata.type!==i.type&&"*"!==t.edata.type||t.edata.target!==i.target&&null!=t.edata.target||t.edata.execute!==i.phase&&"*"!==t.edata.execute&&"*"!==t.edata.phase)&&(Object.keys(t.edata).forEach((e=>{null==i[e]&&null!=t.edata[e]&&(i[e]=t.edata[e])})),s=[],n=new RegExp(/\((.*?)\)/).exec(String(t.handler).split("=>")[0]),2===(s=n?n[1].split(/\s*,\s*/):s).length?(t.handler.call(this,i.target,i),this.debug&&console.log(" - call (old)",t.handler)):(t.handler.call(this,i),this.debug&&console.log(" - call",t.handler)),!0===i.isStopped||!0===i.stop))return i}if(t="on"+i.type.substr(0,1).toUpperCase()+i.type.substr(1),!("before"===i.phase&&"function"==typeof this[t]&&(l=this[t],s=[],n=new RegExp(/\((.*?)\)/).exec(String(l).split("=>")[0]),2===(s=n?n[1].split(/\s*,\s*/):s).length?(l.call(this,i.target,i),this.debug&&console.log(" - call: on[Event] (old)",l)):(l.call(this,i),this.debug&&console.log(" - call: on[Event]",l)),!0===i.isStopped||!0===i.stop)||null!=i.object&&"before"===i.phase&&"function"==typeof i.object[t]&&(l=i.object[t],s=[],n=new RegExp(/\((.*?)\)/).exec(String(l).split("=>")[0]),2===(s=n?n[1].split(/\s*,\s*/):s).length?(l.call(this,i.target,i),this.debug&&console.log(" - call: edata.object (old)",l)):(l.call(this,i),this.debug&&console.log(" - call: edata.object",l)),!0===i.isStopped||!0===i.stop)||"after"!==i.phase)){"function"==typeof i.onComplete&&i.onComplete.call(this,i);for(let e=0;e<i.listeners.length;e++)"function"==typeof i.listeners[e]&&(i.listeners[e].call(this,i),this.debug)&&console.log(" - call: done",l);i._resolve(i),this.debug&&console.log(`w2base: trigger "${i.type}:${i.phase}"`,i),-1!==(t=this.activeEvents.indexOf(i))&&this.activeEvents.splice(t,1)}return i}render(e){}unmount(){var e=this.trigger("unmount",{target:this.name});if(!e.isCancelled){let t=[];this.box instanceof HTMLElement&&this.box.classList.forEach((e=>{e.startsWith("w2ui-")&&t.push(e)})),l(this.box).off().removeClass(t).removeAttr("name").html(""),this.box=null,e.finish()}}}const i={locale:"en-US",dateFormat:"m/d/yyyy",timeFormat:"hh:mi pm",datetimeFormat:"m/d/yyyy|hh:mi pm",currencyPrefix:"$",currencySuffix:"",currencyPrecision:2,groupSymbol:",",decimalSymbol:".",shortmonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fullmonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortdays:["M","T","W","T","F","S","S"],fulldays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],weekStarts:"S",phrases:{"${count} letters or more...":"---","Add new record":"---","Add New":"---","Advanced Search":"---",after:"---","AJAX error. See console for more details.":"---","All Fields":"---",All:"---",Any:"---","Are you sure you want to delete ${count} ${records}?":"---","Attach files by dragging and dropping or Click to Select":"---",before:"---","begins with":"---",begins:"---",between:"---",buffered:"---",Cancel:"---",Close:"---",Column:"---",Confirmation:"---",contains:"---",Copied:"---","Copy to clipboard":"---","Current Date & Time":"---","Delete selected records":"---",Delete:"---",'Do you want to delete search item "${item}"?':"---","Edit selected record":"---",Edit:"---","Empty list":"---","ends with":"---",ends:"---","Field should be at least ${count} characters.":"---",Hide:"---",in:"---","is not":"---",is:"---","less than":"---","Line #":"---","Load ${count} more...":"---","Loading...":"---","Maximum number of files is ${count}":"---","Maximum total size is ${count}":"---",Modified:"---","more than":"---","Multiple Fields":"---",Name:"---","No items found":"---","No matches":"---",No:"---",none:"---","Not a float":"---","Not a hex number":"---","Not a valid date":"---","Not a valid email":"---","Not alpha-numeric":"---","Not an integer":"---","Not in money format":"---","not in":"---",Notification:"---",of:"---",Ok:"---",Opacity:"---","Record ID":"---",record:"---",records:"---","Refreshing...":"---","Reload data in the list":"---",Remove:"---","Remove This Field":"---","Request aborted.":"---","Required field":"---",Reset:"---","Restore Default State":"---","Returned data is not in valid JSON format.":"---","Save changed records":"---","Save Grid State":"---",Save:"---","Saved Searches":"---","Saving...":"---","Search took ${count} seconds":"---",Search:"---","Select Hour":"---","Select Minute":"---",selected:"---","Server Response ${count} seconds":"---","Show/hide columns":"---",Show:"---",Size:"---",Skip:"---","Sorting took ${count} seconds":"---","Type to search...":"---",Type:"---",Yes:"---",Yesterday:"---","Your remote data source record count has changed, reloading from the first record.":"---"}};class s{static version=.8;constructor(e,t){this.context=t??document;let i=[];if(Array.isArray(e))i=e;else if(e instanceof Node||e instanceof Window)i=[e];else if(e instanceof s)i=e.nodes;else if("string"==typeof e){if("function"!=typeof this.context.querySelector)throw new Error("Invalid context");i=Array.from(this.context.querySelectorAll(e))}else if(null==e)i=[];else{if(t=Array.from(e??[]),"object"!=typeof e||!Array.isArray(t))throw new Error(`Invalid selector "${e}"`);i=t}this.nodes=i,this.length=i.length,this.each(((e,t)=>{this[t]=e}))}static _fragment(e){let t=document.createElement("template");return t.innerHTML=e,t.content.childNodes.forEach((e=>{var i=s._scriptConvert(e);i!=e&&t.content.replaceChild(i,e)})),t.content}static _scriptConvert(e){let t=e=>{var t=e.ownerDocument.createElement("script"),i=(t.text=e.text,e.attributes);for(let e=0;e<i.length;e++)t.setAttribute(i[e].name,i[e].value);return t};return(e="SCRIPT"==e.tagName?t(e):e).querySelectorAll&&e.querySelectorAll("script").forEach((e=>{e.parentNode.replaceChild(t(e),e)})),e}static _fixProp(e){return{cellpadding:"cellPadding",cellspacing:"cellSpacing",class:"className",colspan:"colSpan",contenteditable:"contentEditable",for:"htmlFor",frameborder:"frameBorder",maxlength:"maxLength",readonly:"readOnly",rowspan:"rowSpan",tabindex:"tabIndex",usemap:"useMap"}[e]||e}_insert(e,t){let i=[],l=this.length;if(!(l<1)){let n=this;if("string"==typeof t)this.each((l=>{var n=s._fragment(t);i.push(...n.childNodes),l[e](n)}));else if(t instanceof s){let n=1==l;t.each((t=>{this.each((l=>{var a=n?t:t.cloneNode(!0);i.push(a),l[e](a),s._scriptConvert(a)}))})),n||t.remove()}else{if(!(t instanceof Node))throw new Error(`Incorrect argument for "${e}(html)". It expects one string argument.`);this.each((n=>{var a=1===l?t:s._fragment(t.outerHTML);i.push(...1===l?[t]:a.childNodes),n[e](a)})),1<l&&t.remove()}return n="replaceWith"==e?new s(i,this.context):n}}_save(e,t,i){e._mQuery=e._mQuery??{},Array.isArray(i)?(e._mQuery[t]=e._mQuery[t]??[],e._mQuery[t].push(...i)):null!=i?e._mQuery[t]=i:delete e._mQuery[t]}get(e){return this[e=e<0?this.length+e:e]||(null!=e?null:this.nodes)}eq(e){let t=[this[e=e<0?this.length+e:e]];return null==t[0]&&(t=[]),new s(t,this.context)}then(e){return null!=(e=e(this))?e:this}find(e){let t=[];return this.each((i=>{0<(i=Array.from(i.querySelectorAll(e))).length&&t.push(...i)})),new s(t,this.context)}filter(e){let t=[];return this.each((i=>{(i===e||"string"==typeof e&&i.matches&&i.matches(e)||"function"==typeof e&&e(i))&&t.push(i)})),new s(t,this.context)}next(){let e=[];return this.each((t=>{(t=t.nextElementSibling)&&e.push(t)})),new s(e,this.context)}prev(){let e=[];return this.each((t=>{(t=t.previousElementSibling)&&e.push(t)})),new s(e,this.context)}shadow(e){let t=[];this.each((e=>{e.shadowRoot&&t.push(e.shadowRoot)}));var i=new s(t,this.context);return e?i.find(e):i}closest(e){let t=[];return this.each((i=>{(i=i.closest(e))&&t.push(i)})),new s(t,this.context)}host(e){let t=[],i=e=>e.parentNode?i(e.parentNode):e,l=s=>{s=i(s),t.push(s.host||s),s.host&&e&&l(s.host)};return this.each((e=>{l(e)})),new s(t,this.context)}parent(e){return this.parents(e,!0)}parents(e,t){let i=[],l=e=>{if(-1==i.indexOf(e)&&i.push(e),!t&&e.parentNode)return l(e.parentNode)};this.each((e=>{e.parentNode&&l(e.parentNode)}));var n=new s(i,this.context);return e?n.filter(e):n}add(e){return e=e instanceof s?e.nodes:Array.isArray(e)?e:[e],new s(this.nodes.concat(e),this.context)}each(e){return this.nodes.forEach(((t,i)=>{e(t,i,this)})),this}append(e){return this._insert("append",e)}prepend(e){return this._insert("prepend",e)}after(e){return this._insert("after",e)}before(e){return this._insert("before",e)}replace(e){return this._insert("replaceWith",e)}remove(){return this.each((e=>{e.remove()})),this}css(e,t){let i=e;var s,l=arguments.length;return 0===l||1===l&&"string"==typeof e?this[0]?(l=this[0].style,"string"==typeof e?(s=l.getPropertyPriority(e),l.getPropertyValue(e)+(s?"!"+s:"")):Object.fromEntries(this[0].style.cssText.split(";").filter((e=>!!e)).map((e=>e.split(":").map((e=>e.trim())))))):void 0:("object"!=typeof e&&((i={})[e]=t),this.each(((e,t)=>{Object.keys(i).forEach((t=>{var s=String(i[t]).toLowerCase().includes("!important")?"important":"";e.style.setProperty(t,String(i[t]).replace(/\!important/i,""),s)}))})),this)}addClass(e){return this.toggleClass(e,!0),this}removeClass(e){return this.toggleClass(e,!1),this}toggleClass(e,t){return"string"==typeof e&&(e=e.split(/[,\s]+/)),this.each((i=>{let s=e;(s=null==s&&!1===t?Array.from(i.classList):s).forEach((e=>{if(""!==e){let s=null!=t?t?"add":"remove":"toggle";i.classList[s](e)}}))})),this}hasClass(e){if(null==(e="string"==typeof e?e.split(/[,\s]+/):e)&&0<this.length)return Array.from(this[0].classList);let t=!1;return this.each((i=>{t=t||e.every((e=>Array.from(i.classList??[]).includes(e)))})),t}on(e,t,i){let s;return"function"==typeof t&&(i=t,t=void 0),t?.delegate&&(s=t.delegate,delete t.delegate),(e=e.split(/[,\s]+/)).forEach((e=>{let[n,a]=String(e).toLowerCase().split(".");if(s){let e=i;i=t=>{var i=l(t.target).parents(s);0<i.length?t.delegate=i[0]:t.delegate=t.target,(t.target.matches(s)||0<i.length)&&e(t)}}this.each((e=>{this._save(e,"events",[{event:n,scope:a,callback:i,options:t}]),e.addEventListener(n,i,t)}))})),this}off(e,t,i){return"function"==typeof t&&(i=t,t=void 0),(e=(e??"").split(/[,\s]+/)).forEach((e=>{let[t,s]=String(e).toLowerCase().split(".");this.each((e=>{if(Array.isArray(e._mQuery?.events))for(let n=e._mQuery.events.length-1;0<=n;n--){var l=e._mQuery.events[n];null==s||""===s?l.event!=t&&""!==t||l.callback!=i&&null!=i||(e.removeEventListener(l.event,l.callback,l.options),e._mQuery.events.splice(n,1)):l.event!=t&&""!==t||l.scope!=s||(e.removeEventListener(l.event,l.callback,l.options),e._mQuery.events.splice(n,1))}}))})),this}trigger(e,t){let i;return i=e instanceof Event||e instanceof CustomEvent?e:new(["click","dblclick","mousedown","mouseup","mousemove"].includes(e)?MouseEvent:["keydown","keyup","keypress"].includes(e)?KeyboardEvent:Event)(e,t),this.each((e=>{e.dispatchEvent(i)})),this}attr(e,t){if(void 0===t&&"string"==typeof e)return this[0]?this[0].getAttribute(e):void 0;{let i={};return"object"==typeof e?i=e:i[e]=t,this.each((e=>{Object.entries(i).forEach((([t,i])=>{e.setAttribute(t,i)}))})),this}}removeAttr(){return this.each((e=>{Array.from(arguments).forEach((t=>{e.removeAttribute(t)}))})),this}prop(e,t){if(void 0===t&&"string"==typeof e)return this[0]?this[0][e]:void 0;{let i={};return"object"==typeof e?i=e:i[e]=t,this.each((e=>{Object.entries(i).forEach((([t,i])=>{t=s._fixProp(t),e[t]=i,"innerHTML"==t&&s._scriptConvert(e)}))})),this}}removeProp(){return this.each((e=>{Array.from(arguments).forEach((t=>{delete e[s._fixProp(t)]}))})),this}data(e,t){if(e instanceof Object)Object.entries(e).forEach((e=>{this.data(e[0],e[1])}));else{if(e&&-1!=e.indexOf("-")&&console.error(`Key "${e}" contains "-" (dash). Dashes are not allowed in property names. Use camelCase instead.`),!(arguments.length<2))return this.each((i=>{null!=t?i.dataset[e]=t instanceof Object?JSON.stringify(t):t:delete i.dataset[e]})),this;if(this[0]){let t=Object.assign({},this[0].dataset);return Object.keys(t).forEach((e=>{if(t[e].startsWith("[")||t[e].startsWith("{"))try{t[e]=JSON.parse(t[e])}catch(e){}})),e?t[e]:t}}}removeData(e){return"string"==typeof e&&(e=e.split(/[,\s]+/)),this.each((t=>{e.forEach((e=>{delete t.dataset[e]}))})),this}show(){return this.toggle(!0)}hide(){return this.toggle(!1)}toggle(e){return this.each((t=>{var i,s=t.style.display,l=getComputedStyle(t).display,n="none"==s||"none"==l;!n||null!=e&&!0!==e||(i=t instanceof HTMLTableRowElement?"table-row":t instanceof HTMLTableCellElement?"table-cell":"block",t.style.display=t._mQuery?.prevDisplay??(s==l&&"none"!=l?"":i),this._save(t,"prevDisplay",null)),n||null!=e&&!1!==e||("none"!=l&&this._save(t,"prevDisplay",l),t.style.setProperty("display","none"))}))}empty(){return this.html("")}html(e){return e instanceof HTMLElement?this.empty().append(e):this.prop("innerHTML",e)}text(e){return this.prop("textContent",e)}val(e){return this.prop("value",e)}change(){return this.trigger("change")}click(){return this.trigger("click")}}let l=function(e,t){if("function"!=typeof e)return new s(e,t);"complete"==document.readyState?e():window.addEventListener("load",e)},n=(l.html=e=>(e=s._fragment(e),l(e.children,e)),l.version=s.version,{});var a=new class{constructor(){this.version="2.0.x",this.tmp={},this.settings=this.extend({},{dataType:"HTTPJSON",dateStartYear:1950,dateEndYear:2030,macButtonOrder:!1,warnNoPhrase:!1},i,{phrases:null}),this.i18nCompare=Intl.Collator().compare,this.hasLocalStorage=function(){var e="w2ui_test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}(),this.isMac=/Mac/i.test(navigator.platform),this.isMobile=/(iphone|ipod|mobile|android)/i.test(navigator.userAgent),this.isIOS=/(iphone|ipod|ipad)/i.test(navigator.platform),this.isAndroid=/(android)/i.test(navigator.userAgent),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isFirefox=/(Firefox)/i.test(navigator.userAgent),this.formatters={number:(e,t)=>(20<parseInt(t)&&(t=20),parseInt(t)<0&&(t=0),null==e||""===e?"":a.formatNumber(parseFloat(e),t,!0)),float:(e,t)=>a.formatters.number(e,t),int:(e,t)=>a.formatters.number(e,0),money:(e,t)=>null==e||""===e?"":(e=a.formatNumber(Number(e),a.settings.currencyPrecision),(a.settings.currencyPrefix||"")+e+(a.settings.currencySuffix||"")),currency:(e,t)=>a.formatters.money(e,t),percent:(e,t)=>null==e||""===e?"":a.formatNumber(e,t||1)+"%",size:(e,t)=>null==e||""===e?"":a.formatSize(parseInt(e)),date(e,t){if(""===t&&(t=a.settings.dateFormat),null==e||0===e||""===e)return"";let i=a.isDateTime(e,t,!0);return'<span title="'+(i=!1===i?a.isDate(e,t,!0):i)+'">'+a.formatDate(i,t)+"</span>"},datetime(e,t){if(""===t&&(t=a.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=a.isDateTime(e,t,!0);return'<span title="'+(i=!1===i?a.isDate(e,t,!0):i)+'">'+a.formatDateTime(i,t)+"</span>"},time(e,t){if(""===t&&(t=a.settings.timeFormat),null==e||0===e||""===e)return"";let i=a.isDateTime(e,t="h24"===(t="h12"===t?"hh:mi pm":t)?"h24:mi":t,!0);return'<span title="'+(i=!1===i?a.isDate(e,t,!0):i)+'">'+a.formatTime(e,t)+"</span>"},timestamp(e,t){if(""===t&&(t=a.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=a.isDateTime(e,t,!0);return(i=!1===i?a.isDate(e,t,!0):i).toString?i.toString():""},gmt(e,t){if(""===t&&(t=a.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=a.isDateTime(e,t,!0);return(i=!1===i?a.isDate(e,t,!0):i).toUTCString?i.toUTCString():""},age(e,t){if(null==e||0===e||""===e)return"";let i=a.isDateTime(e,null,!0);return'<span title="'+(i=!1===i?a.isDate(e,null,!0):i)+'">'+a.age(e)+(t?" "+t:"")+"</span>"},interval:(e,t)=>null==e||0===e||""===e?"":a.interval(e)+(t?" "+t:""),toggle:(e,t)=>e?a.lang("Yes"):"",password(e,t){let i="";if(e)for(let t=0;t<e.length;t++)i+="*";return i}}}isBin(e){return/^[0-1]+$/.test(e)}isInt(e){return/^[-+]?[0-9]+$/.test(e)}isFloat(e){return("number"==typeof(e="string"==typeof e?e.replace(this.settings.groupSymbol,"").replace(this.settings.decimalSymbol,"."):e)||"string"==typeof e&&""!==e)&&!isNaN(Number(e))}isMoney(e){var t,i;return"object"!=typeof e&&""!==e&&(!!this.isFloat(e)||(t=this.settings,i=new RegExp("^"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[-+]?"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[0-9]*[\\"+t.decimalSymbol+"]?[0-9]+"+(t.currencySuffix?"\\"+t.currencySuffix+"?":"")+"$","i"),"string"==typeof e&&(e=e.replace(new RegExp(t.groupSymbol,"g"),"")),i.test(e)))}isHex(e){return/^(0x)?[0-9a-fA-F]+$/.test(e)}isAlphaNumeric(e){return/^[a-zA-Z0-9_-]+$/.test(e)}isEmail(e){return/^[a-zA-Z0-9._%\-+]+@[а-яА-Яa-zA-Z0-9.-]+\.[а-яА-Яa-zA-Z]+$/.test(e)}isIpAddress(e){return new RegExp("^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$").test(e)}isDate(e,t,i){if(!e)return!1;var s="Invalid Date";let l,n,a;if(null==t&&(t=this.settings.dateFormat),"function"==typeof e.getFullYear)a=e.getFullYear(),l=e.getMonth()+1,n=e.getDate();else if(parseInt(e)==e&&0<parseInt(e))a=(e=new Date(parseInt(e))).getFullYear(),l=e.getMonth()+1,n=e.getDate();else{if(e=String(e),new RegExp("mon","ig").test(t)){t=t.replace(/month/gi,"m").replace(/mon/gi,"m").replace(/dd/gi,"d").replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase(),e=e.replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase();for(let t=0,i=this.settings.fullmonths.length;t<i;t++){var r=this.settings.fullmonths[t];e=e.replace(new RegExp(r,"ig"),parseInt(t)+1).replace(new RegExp(r.substr(0,3),"ig"),parseInt(t)+1)}}var o=e.replace(/-/g,"/").replace(/\./g,"/").toLowerCase().split("/");"mm/dd/yyyy"===(t=t.replace(/-/g,"/").replace(/\./g,"/").toLowerCase())&&(l=o[0],n=o[1],a=o[2]),"m/d/yyyy"===t&&(l=o[0],n=o[1],a=o[2]),"dd/mm/yyyy"===t&&(l=o[1],n=o[0],a=o[2]),"d/m/yyyy"===t&&(l=o[1],n=o[0],a=o[2]),"yyyy/dd/mm"===t&&(l=o[2],n=o[1],a=o[0]),"yyyy/d/m"===t&&(l=o[2],n=o[1],a=o[0]),"yyyy/mm/dd"===t&&(l=o[1],n=o[2],a=o[0]),"yyyy/m/d"===t&&(l=o[1],n=o[2],a=o[0]),"mm/dd/yy"===t&&(l=o[0],n=o[1],a=o[2]),"m/d/yy"===t&&(l=o[0],n=o[1],a=parseInt(o[2])+1900),"dd/mm/yy"===t&&(l=o[1],n=o[0],a=parseInt(o[2])+1900),"d/m/yy"===t&&(l=o[1],n=o[0],a=parseInt(o[2])+1900),"yy/dd/mm"===t&&(l=o[2],n=o[1],a=parseInt(o[0])+1900),"yy/d/m"===t&&(l=o[2],n=o[1],a=parseInt(o[0])+1900),"yy/mm/dd"===t&&(l=o[1],n=o[2],a=parseInt(o[0])+1900),"yy/m/d"===t&&(l=o[1],n=o[2],a=parseInt(o[0])+1900)}return!!this.isInt(a)&&!!this.isInt(l)&&!!this.isInt(n)&&(a=+a,l=+l,n=+n,(s=new Date(a,l-1,n)).setFullYear(a),null!=l)&&"Invalid Date"!==String(s)&&s.getMonth()+1===l&&s.getDate()===n&&s.getFullYear()===a&&(!0!==i||s)}isTime(e,t){if(null==e)return!1;let i,s,l;s=0<=(e=(e=String(e)).toUpperCase()).indexOf("AM");var n=(l=0<=e.indexOf("PM"))||s;i=n?12:24,e=(e=e.replace("AM","").replace("PM","").trim()).split(":");let a=parseInt(e[0]||0),r=parseInt(e[1]||0),o=parseInt(e[2]||0);return(n&&1===e.length||2===e.length||3===e.length)&&!(""===e[0]||a<0||a>i||!this.isInt(e[0])||2<e[0].length||1<e.length&&(""===e[1]||r<0||59<r||!this.isInt(e[1])||2!==e[1].length)||2<e.length&&(""===e[2]||o<0||59<o||!this.isInt(e[2])||2!==e[2].length)||!(n||i!==a||0===r&&0===o)||n&&1===e.length&&0===a)&&(!0!==t||(l&&12!==a&&(a+=12),s&&12===a&&(a+=12),{hours:a,minutes:r,seconds:o}))}isDateTime(e,t,i){var s;return"function"==typeof e.getFullYear?!0!==i||e:(s=parseInt(e))===e?!(s<0)&&(!0!==i||new Date(s)):(s=String(e).indexOf(" "))<0?!(String(e).indexOf("T")<0||"Invalid Date"==String(new Date(e)))&&(!0!==i||new Date(e)):(t=(t=null==t?this.settings.datetimeFormat:t).split("|"),e=[e.substr(0,s),e.substr(s).trim()],t[0]=t[0].trim(),t[1]&&(t[1]=t[1].trim()),s=this.isDate(e[0],t[0],!0),t=this.isTime(e[1],!0),!1!==s&&!1!==t&&(!0!==i||(s.setHours(t.hours),s.setMinutes(t.minutes),s.setSeconds(t.seconds),s)))}age(e){let t;if(""===e||null==e)return"";if(t="function"==typeof e.getFullYear?e:parseInt(e)==e&&0<parseInt(e)?new Date(parseInt(e)):new Date(e),"Invalid Date"===String(t))return"";let i="",s="";return(e=((new Date).getTime()-t.getTime())/1e3)<0?(i=0,s="sec"):e<60?(i=Math.floor(e),s="sec",e<0&&(i=0,s="sec")):e<3600?(i=Math.floor(e/60),s="min"):e<86400?(i=Math.floor(e/60/60),s="hour"):e<2592e3?(i=Math.floor(e/24/60/60),s="day"):e<31536e3?(i=Math.floor(e/30/24/60/60*10)/10,s="month"):e<126144e3?(i=Math.floor(e/365/24/60/60*10)/10,s="year"):126144e3<=e&&(i=Math.floor(e/365.25/24/60/60*10)/10,s="year"),i+" "+s+(1<i?"s":"")}interval(e){return e<100?"< 0.01 sec":e<1e3?Math.floor(e/10)/100+" sec":e<1e4?Math.floor(e/100)/10+" sec":e<6e4?Math.floor(e/1e3)+" secs":e<36e5?Math.floor(e/6e4)+" mins":e<864e5?Math.floor(e/36e5*10)/10+" hours":e<2628e6?Math.floor(e/864e5*10)/10+" days":e<31536e6?Math.floor(e/2628e6*10)/10+" months":Math.floor(e/31536e5)/10+" years"}date(e){if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let t=new Date(e);if(this.isInt(e)&&(t=new Date(Number(e))),"Invalid Date"===String(t))return"";e=this.settings.shortmonths;var i=new Date,s=((l=new Date).setTime(l.getTime()-864e5),e[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear()),l=(i=e[i.getMonth()]+" "+i.getDate()+", "+i.getFullYear(),e=e[l.getMonth()]+" "+l.getDate()+", "+l.getFullYear(),t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+" "+(12<=t.getHours()?"pm":"am"));let n=s==i?l:s;return'<span title="'+s+" "+(t.getHours()-(12<t.getHours()?12:0))+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+":"+(t.getSeconds()<10?"0":"")+t.getSeconds()+" "+(12<=t.getHours()?"pm":"am")+'">'+(n=s==e?this.lang("Yesterday"):n)+"</span>"}formatSize(e){var t;return this.isFloat(e)&&""!==e?0===(e=parseFloat(e))?0:(t=parseInt(Math.floor(Math.log(e)/Math.log(1024))),(Math.floor(e/Math.pow(1024,t)*10)/10).toFixed(0===t?0:1)+" "+(["Bt","KB","MB","GB","TB","PB","EB","ZB"][t]||"??")):""}formatNumber(e,t,i){return null==e||""===e||"object"==typeof e?"":(i={minimumFractionDigits:parseInt(t),maximumFractionDigits:parseInt(t),useGrouping:!!i},(null==t||t<0)&&(i.minimumFractionDigits=0,i.maximumFractionDigits=20),parseFloat(e).toLocaleString(this.settings.locale,i))}formatDate(e,t){if(t=t||this.settings.dateFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);var s,l;return this.isInt(e)&&(i=new Date(Number(e))),"Invalid Date"===String(i)?"":(e=i.getFullYear(),s=i.getMonth(),l=i.getDate(),t.toLowerCase().replace("month",this.settings.fullmonths[s]).replace("mon",this.settings.shortmonths[s]).replace(/yyyy/g,("000"+e).slice(-4)).replace(/yyy/g,("000"+e).slice(-4)).replace(/yy/g,("0"+e).slice(-2)).replace(/(^|[^a-z$])y/g,"$1"+e).replace(/mm/g,("0"+(s+1)).slice(-2)).replace(/dd/g,("0"+l).slice(-2)).replace(/th/g,1==l?"st":"th").replace(/th/g,2==l?"nd":"th").replace(/th/g,3==l?"rd":"th").replace(/(^|[^a-z$])m/g,"$1"+(s+1)).replace(/(^|[^a-z$])d/g,"$1"+l))}formatTime(e,t){if(t=t||this.settings.timeFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),this.isTime(e)&&(e=this.isTime(e,!0),(i=new Date).setHours(e.hours),i.setMinutes(e.minutes)),"Invalid Date"===String(i))return"";"h12"==t&&(t="hh:mi pm");let s="am",l=i.getHours();e=i.getHours();let n=i.getMinutes(),a=i.getSeconds();return n<10&&(n="0"+n),a<10&&(a="0"+a),-1===t.indexOf("am")&&-1===t.indexOf("pm")||(12<=l&&(s="pm"),12<l&&(l-=12),0===l&&(l=12)),t.toLowerCase().replace("am",s).replace("pm",s).replace("hhh",l<10?"0"+l:l).replace("hh24",e<10?"0"+e:e).replace("h24",e).replace("hh",l).replace("mm",n).replace("mi",n).replace("ss",a).replace(/(^|[^a-z$])h/g,"$1"+l).replace(/(^|[^a-z$])m/g,"$1"+n).replace(/(^|[^a-z$])s/g,"$1"+a)}formatDateTime(e,t){let i;return""===e||null==e||"object"==typeof e&&!e.getMonth?"":("string"!=typeof t?i=[this.settings.dateFormat,this.settings.timeFormat]:((i=t.split("|"))[0]=i[0].trim(),i[1]=1<i.length?i[1].trim():this.settings.timeFormat),"h12"===i[1]&&(i[1]="h:m pm"),"h24"===i[1]&&(i[1]="h24:m"),this.formatDate(e,i[0])+" "+this.formatTime(e,i[1]))}stripSpaces(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/(?:\r\n|\r|\n)/g," ").replace(/\s\s+/g," ").trim();break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.stripSpaces(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.stripSpaces(e[t])})))}return e}stripTags(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/<(?:[^>=]|='[^']*'|="[^"]*"|=[^'"][^\s>]*)*>/gi,"");break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.stripTags(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.stripTags(e[t])})))}return e}encodeTags(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.encodeTags(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.encodeTags(e[t])})))}return e}decodeTags(e){if(null!=e)switch(typeof e){case"number":break;case"string":e=String(e).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&");break;case"object":Array.isArray(e)?(e=this.extend([],e)).forEach(((t,i)=>{e[i]=this.decodeTags(t)})):(e=this.extend({},e),Object.keys(e).forEach((t=>{e[t]=this.decodeTags(e[t])})))}return e}escapeId(e){return""===e||null==e?"":(e+"").replace(/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,((e,t)=>t?"\0"===e?"�":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e))}unescapeId(e){return""===e||null==e?"":e.replace(/\\[\da-fA-F]{1,6}[\x20\t\r\n\f]?|\\([^\r\n\f])/g,((e,t)=>(e="0x"+e.slice(1)-65536,t||(e<0?String.fromCharCode(65536+e):String.fromCharCode(e>>10|55296,1023&e|56320)))))}base64encode(e){return btoa(e)}base64decode(e){return atob(e)}async sha256(e){return e=(new TextEncoder).encode(e),crypto.subtle.digest("SHA-256",e).then((e=>Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("")))}transition(e,t,i,s){return new Promise(((n,a)=>{var r=getComputedStyle(e);let o=parseInt(r.width),d=parseInt(r.height);if(e&&t){switch(e.parentNode.style.cssText+="perspective: 900px; overflow: hidden;",e.style.cssText+="; position: absolute; z-index: 1019; backface-visibility: hidden",t.style.cssText+="; position: absolute; z-index: 1020; backface-visibility: hidden",i){case"slide-left":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d("+o+"px, 0, 0)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(-"+o+"px, 0, 0)"}),1);break;case"slide-right":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(-"+o+"px, 0, 0)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0px, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d("+o+"px, 0, 0)"}),1);break;case"slide-down":e.style.cssText+="overflow: hidden; z-index: 1; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; z-index: 0; transform: translate3d(0, 0, 0)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(0, "+d+"px, 0)"}),1);break;case"slide-up":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, "+d+"px, 0)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)"}),1);break;case"flip-left":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(-180deg)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateY(180deg)"}),1);break;case"flip-right":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(180deg)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateY(-180deg)"}),1);break;case"flip-down":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(180deg)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateX(-180deg)"}),1);break;case"flip-up":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(-180deg)",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",e.style.cssText+="transition: 0.5s; transform: rotateX(180deg)"}),1);break;case"pop-in":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(.8); opacity: 0;",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; transform: scale(1); opacity: 1;",e.style.cssText+="transition: 0.5s;"}),1);break;case"pop-out":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(1); opacity: 1;",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); opacity: 0;",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; opacity: 1;",e.style.cssText+="transition: 0.5s; transform: scale(1.7); opacity: 0;"}),1);break;default:e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; translate3d(0, 0, 0); opacity: 0;",l(t).show(),setTimeout((()=>{t.style.cssText+="transition: 0.5s; opacity: 1;",e.style.cssText+="transition: 0.5s"}),1)}setTimeout((()=>{"slide-down"===i&&(l(e).css("z-index","1019"),l(t).css("z-index","1020")),t&&l(t).css({opacity:"1"}).css({transition:"",transform:""}),e&&l(e).css({opacity:"1"}).css({transition:"",transform:""}),"function"==typeof s&&s(),n()}),500)}else console.log("ERROR: Cannot do transition when one of the divs is null")}))}lock(e,t={}){if(null!=e){"string"==typeof t&&(t={msg:t}),arguments[2]&&(t.spinner=arguments[2]),t=this.extend({spinner:!1},t),e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),t.msg||0===t.msg||(t.msg=""),this.unlock(e);var i=l(e).get(0),s=i.scrollWidth;let n=`height: ${i.scrollHeight}px; width: ${s}px`,a=("BODY"==i.tagName&&(n="position: fixed; right: 0; bottom: 0;"),l(e).prepend(`<div class="w2ui-lock" style="${n}"></div><div class="w2ui-lock-msg"></div>`),l(e).find(".w2ui-lock"));s=l(e).find(".w2ui-lock-msg"),t.msg||s.css({"background-color":"transparent","background-image":"none",border:"0px","box-shadow":"none"}),!0===t.spinner&&(t.msg=`<div class="w2ui-spinner" ${t.msg?"":'style="width: 35px; height: 35px"'}></div>`+t.msg),t.msg?s.html(t.msg).css("display","block"):s.remove(),null!=t.opacity&&a.css("opacity",t.opacity),a.css({display:"block"}),t.bgColor&&a.css({"background-color":t.bgColor});let r=(i=getComputedStyle(a.get(0))).opacity??.15;a.on("mousedown",(function(){"function"==typeof t.onClick?t.onClick():a.css({transition:".2s",opacity:1.5*r})})).on("mouseup",(function(){"function"!=typeof t.onClick&&a.css({transition:".2s",opacity:r})})).on("mousewheel",(function(e){e&&(e.stopPropagation(),e.preventDefault())}))}}unlock(e,t){var i;null!=e&&(clearTimeout(e._prevUnlock),e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),this.isInt(t)&&0<t?(l(e).find(".w2ui-lock").css({transition:t/1e3+"s",opacity:0}),i=l(e).get(0),clearTimeout(i._prevUnlock),i._prevUnlock=setTimeout((()=>{l(e).find(".w2ui-lock").remove()}),t)):l(e).find(".w2ui-lock").remove(),l(e).find(".w2ui-lock-msg").remove())}message(e,i){let s,n,r;var o=()=>{var t=l(e?.box).find(".w2ui-message");0!=t.length&&"function"==typeof(i=t.get(0)._msg_options||{})?.close&&i.close()};let d=t=>{var i,s=t.box._msg_prevFocus;l(e.box).find(".w2ui-message").length<=1?e.owner?e.owner.unlock(e.param,150):this.unlock(e.box,150):l(e.box).find(`#w2ui-message-${e.owner?.name}-`+(t.msgIndex-1)).css("z-index",1500),s?0<(i=l(s).closest(".w2ui-message")).length?i.get(0)._msg_options.setFocus(s):s.focus():"function"==typeof e.owner?.focus&&e.owner.focus(),l(t.box).remove(),0===t.msgIndex&&(g.css("z-index",t.tmp.zIndex),l(e.box).css("overflow",t.tmp.overflow)),t.trigger&&r.finish()};if("object"!=typeof(i="string"!=typeof i&&"number"!=typeof i?i:{width:String(i).length<300?350:550,height:String(i).length<300?170:250,text:String(i)}))return void o();null!=i.text&&(i.body=`<div class="w2ui-centered w2ui-msg-text">${i.text}</div>`),null==i.width&&(i.width=350),null==i.height&&(i.height=170),null==i.hideOn&&(i.hideOn=["esc"]),null==i.on&&(u=i,i=new t,a.extend(i,u)),i.on("open",(e=>{a.bindEvents(l(i.box).find(".w2ui-eaction"),i),l(e.detail.box).find("button, input, textarea, [name=hidden-first]").off(".message").on("keydown.message",(function(e){27==e.keyCode&&i.hideOn.includes("esc")&&(i.cancelAction?i.action(i.cancelAction):i.close())})),setTimeout((()=>i.setFocus(i.focus)),300)})),i.off(".prom");let h={self:i,action:e=>(i.on("action.prom",e),h),close:e=>(i.on("close.prom",e),h),open:e=>(i.on("open.prom",e),h),then:e=>(i.on("open:after.prom",e),h)},c=(null==i.actions&&null==i.buttons&&null==i.html&&(i.actions={Ok(e){e.detail.self.close()}}),i.off(".buttons"),null!=i.actions&&(i.buttons="",Object.keys(i.actions).forEach((e=>{var t=i.actions[e];let s=e;"function"==typeof t&&(i.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}","event"]' name="${e}">${e}</button>`),"object"==typeof t&&(i.buttons+=`<button class="w2ui-btn w2ui-eaction ${t.class||""}" name="${e}" data-click='["action","${e}","event"]'\n                        style="${t.style??""}" ${t.attrs??""}>${t.text||e}</button>`,s=Array.isArray(i.actions)?t.text:e),"string"==typeof t&&(i.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${t}" data-click='["action","${t}","event"]'>${t}</button>`,s=t),"string"==typeof s&&(s=s[0].toLowerCase()+s.substr(1).replace(/\s+/g,"")),h[s]=function(e){return i.on("action.buttons",(t=>{t.detail.action[0].toLowerCase()+t.detail.action.substr(1).replace(/\s+/g,"")==s&&e(t)})),h}}))),Array("html","body","buttons").forEach((e=>{i[e]=String(i[e]??"").trim()})),""===i.body&&""===i.buttons||(i.html=`\n                <div class="w2ui-message-body">${i.body||""}</div>\n                <div class="w2ui-message-buttons">${i.buttons||""}</div>\n            `),getComputedStyle(l(e.box).get(0)));var u=parseFloat(c.width),p=parseFloat(c.height);let m=0,g=(0<l(e.after).length&&(c=getComputedStyle(l(e.after).get(0)),m=parseInt("none"!=c.display?parseInt(c.height):0)),i.width>u&&(i.width=u-10),i.height>p-m&&(i.height=p-10-m),i.originalWidth=i.width,i.originalHeight=i.height,parseInt(i.width)<0&&(i.width=u+i.width),parseInt(i.width)<10&&(i.width=10),parseInt(i.height)<0&&(i.height=p+i.height-m),parseInt(i.height)<10&&(i.height=10),i.originalHeight<0&&(i.height=p+i.originalHeight-m),i.originalWidth<0&&(i.width=u+2*i.originalWidth),l(e.box).find(e.after));return i.tmp||(i.tmp={zIndex:g.css("z-index"),overflow:c.overflow}),""===i.html&&""===i.body&&""===i.buttons?o():(i.msgIndex=l(e.box).find(".w2ui-message").length,0===i.msgIndex&&"function"==typeof this.lock&&(l(e.box).css("overflow","hidden"),e.owner?e.owner.lock(e.param):this.lock(e.box)),l(e.box).find(".w2ui-message").css("z-index",1390),g.css("z-index",1501),p=`\n                <div id="w2ui-message-${e.owner?.name}-${i.msgIndex}" class="w2ui-message" data-mousedown="stop"\n                    style="z-index: 1500; left: ${(u-i.width)/2}px; top: ${m}px;\n                        width: ${i.width}px; height: ${i.height}px; transform: translateY(-${i.height}px)"\n                    ${i.hideOn.includes("click")?e.param?`data-click='["message", "${e.param}"]`:'data-click="message"':""}>\n                    <span name="hidden-first" tabindex="0" style="position: absolute; top: 0; outline: none"></span>\n                    ${i.html}\n                    <span name="hidden-last" tabindex="0" style="position: absolute; top: 0; outline: none"></span>\n                </div>`,0<l(e.after).length?l(e.box).find(e.after).after(p):l(e.box).prepend(p),i.box=l(e.box).find(`#w2ui-message-${e.owner?.name}-`+i.msgIndex)[0],a.bindEvents(i.box,this),l(i.box).addClass("animating"),(i.box._msg_options=i).box._msg_prevFocus=document.activeElement,setTimeout((()=>{!0===(r=i.trigger("open",{target:this.name,box:i.box,self:i})).isCancelled?(l(e.box).find(`#w2ui-message-${e.owner?.name}-`+i.msgIndex).remove(),0===i.msgIndex&&(g.css("z-index",i.tmp.zIndex),l(e.box).css("overflow",i.tmp.overflow))):l(i.box).css({transition:"0.3s",transform:"translateY(0px)"})}),0),n=setTimeout((()=>{l(e.box).find(`#w2ui-message-${e.owner?.name}-`+i.msgIndex).removeClass("animating").css({transition:"0s"}),r.finish()}),300)),i.action=(e,t)=>{let s=i.actions[e];s instanceof Object&&s.onClick&&(s=s.onClick),!0!==(e=i.trigger("action",{target:this.name,action:e,self:i,originalEvent:t,value:i.input?i.input.value:null})).isCancelled&&("function"==typeof s&&s(e),e.finish())},i.close=()=>{!0!==(r=i.trigger("close",{target:"self",box:i.box,self:i})).isCancelled&&(clearTimeout(n),l(i.box).hasClass("animating")?(clearTimeout(s),d(i)):(l(i.box).addClass("w2ui-closing animating").css({transition:"0.15s",transform:"translateY(-"+i.height+"px)"}),0!==i.msgIndex&&l(e.box).find(`#w2ui-message-${e.owner?.name}-`+(i.msgIndex-1)).css("z-index",1499),s=setTimeout((()=>{d(i)}),150)))},i.setFocus=t=>{var i=l(e.box).find(".w2ui-message").length-1;let s=l(e.box).find(`#w2ui-message-${e.owner?.name}-`+i),n="input, button, select, textarea, [contentEditable], .w2ui-input";(null!=t?isNaN(t)?s.find(n).filter(t).get(0):s.find(n).get(t):s.find("[name=hidden-first]").get(0))?.focus(),l(e.box).find(".w2ui-message").find(n+",[name=hidden-first],[name=hidden-last]").off(".keep-focus"),l(s).find(n+",[name=hidden-first],[name=hidden-last]").on("blur.keep-focus",(function(e){setTimeout((()=>{var e=document.activeElement,t=0<l(s).find(n).filter(e).length,i=l(e).attr("name");!t&&e&&e!==document.body&&l(s).find(n).get(0)?.focus(),"hidden-last"==i&&l(s).find(n).get(0)?.focus(),"hidden-first"==i&&l(s).find(n).get(-1)?.focus()}),1)}))},h}notify(e,t){return new Promise((i=>{if("object"==typeof e&&(e=(t=e).text),(t=t||{}).where=t.where??document.body,t.timeout=t.timeout??15e3,"function"==typeof this.tmp.notify_resolve&&(this.tmp.notify_resolve(),l(this.tmp.notify_where).find("#w2ui-notify").remove()),this.tmp.notify_resolve=i,this.tmp.notify_where=t.where,clearTimeout(this.tmp.notify_timer),e){if("object"==typeof t.actions){let i={};Object.keys(t.actions).forEach((e=>{i[e]=`<a class="w2ui-notify-link" value="${e}">${e}</a>`})),e=this.execTemplate(e,i)}var s=`\n                    <div id="w2ui-notify">\n                        <div class="${t.class} ${t.error?"w2ui-notify-error":""}">\n                            ${e}\n                            <span class="w2ui-notify-close w2ui-icon-cross"></span>\n                        </div>\n                    </div>`;l(t.where).append(s),l(t.where).find("#w2ui-notify").find(".w2ui-notify-close").on("click",(e=>{l(t.where).find("#w2ui-notify").remove(),i()})),t.actions&&l(t.where).find("#w2ui-notify .w2ui-notify-link").on("click",(e=>{e=l(e.target).attr("value"),t.actions[e](),l(t.where).find("#w2ui-notify").remove(),i()})),0<t.timeout&&(this.tmp.notify_timer=setTimeout((()=>{l(t.where).find("#w2ui-notify").remove(),i()}),t.timeout))}}))}confirm(e,t){return a.normButtons(t="string"==typeof t?{text:t}:t,{yes:"Yes",no:"No"}),(e=a.message(e,t))&&e.action((e=>{e.detail.self.close()})),e}normButtons(e,t){e.actions=e.actions??{};var i=Object.keys(t);return i.forEach((i=>{var s=e["btn_"+i];s&&(t[i]={text:a.lang(s.text??t[i]??""),class:s.class??"",style:s.style??"",attrs:s.attrs??""},delete e["btn_"+i]),Array("text","class","style","attrs").forEach((s=>{e[i+"_"+s]&&("string"==typeof t[i]&&(t[i]={text:t[i]}),t[i][s]=e[i+"_"+s],delete e[i+"_"+s])}))})),i.includes("yes")&&i.includes("no")&&(a.settings.macButtonOrder?a.extend(e.actions,{no:t.no,yes:t.yes}):a.extend(e.actions,{yes:t.yes,no:t.no})),i.includes("ok")&&i.includes("cancel")&&(a.settings.macButtonOrder?a.extend(e.actions,{cancel:t.cancel,ok:t.ok}):a.extend(e.actions,{ok:t.ok,cancel:t.cancel})),e}getSize(e,t){let i=0;if(0<(e=l(e)).length){e=e[0];var s=getComputedStyle(e);switch(t){case"width":i=parseFloat(s.width),"auto"===s.width&&(i=0);break;case"height":i=parseFloat(s.height),"auto"===s.height&&(i=0);break;default:i=parseFloat(s[t]??0)||0}}return i}getStrWidth(e,t,i){let s=l("body > #_tmp_width");return 0===s.length&&(l("body").append('<div id="_tmp_width" style="position: absolute; top: -9000px;"></div>'),s=l("body > #_tmp_width")),s.html(i?e:this.encodeTags(e)).attr("style","position: absolute; top: -9000px; "+(t||"")),s[0].clientWidth}execTemplate(e,t){return"string"==typeof e&&t&&"object"==typeof t?e.replace(/\${([^}]+)?}/g,(function(e,i){return t[i]||i})):e}marker(e,t,i={onlyFirst:!1,wholeWord:!1}){Array.isArray(t)||(t=null!=t&&""!==t?[t]:[]);let s=i.wholeWord;l(e).each((e=>{for(var l=e,n=/\<span class=\"w2ui\-marker\"\>((.|\n|\r)*)\<\/span\>/gi;-1!==l.innerHTML.indexOf('<span class="w2ui-marker"');)l.innerHTML=l.innerHTML.replace(n,"$1");t.forEach((t=>{t=(t="string"!=typeof t?String(t):t).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/>/g,"&lt;"),t=new RegExp((s?"\\b":"")+t+(s?"\\b":"")+"(?!([^<]+)?>)","i"+(i.onlyFirst?"":"g")),e.innerHTML=e.innerHTML.replace(t,(e=>'<span class="w2ui-marker">'+e+"</span>"))}))}))}lang(e,t){if(!e||null==this.settings.phrases||"string"!=typeof e||"<=>=".includes(e))return this.execTemplate(e,t);let i=this.settings.phrases[e];return null==i?(i=e,this.settings.warnNoPhrase&&(this.settings.missing||(this.settings.missing={}),this.settings.missing[e]="---",this.settings.phrases[e]="---",console.log(`Missing translation for "%c${e}%c", see %c w2utils.settings.phrases %c with value "---"`,"color: orange","","color: #999",""))):"---"!==i||this.settings.warnNoPhrase||(i=e),"---"===i&&(i=`<span ${this.tooltip(e)}>---</span>`),this.execTemplate(i,t)}locale(e,t,s){return new Promise(((l,n)=>{if(Array.isArray(e)){this.settings.phrases={};let t=[],i={};e.forEach(((i,s)=>{5===i.length&&(i="locale/"+i.toLowerCase()+".json",e[s]=i),t.push(this.locale(i,!0,!1))})),Promise.allSettled(t).then((t=>{t.forEach((e=>{e.value&&(i[e.value.file]=e.value.data)})),e.forEach((e=>{this.settings=this.extend({},this.settings,i[e])})),l()}))}else(e=e||"en-us")instanceof Object?this.settings=this.extend({},this.settings,i,e):(5===e.length&&(e="locale/"+e.toLowerCase()+".json"),fetch(e,{method:"GET"}).then((e=>e.json())).then((n=>{!0!==s&&(this.settings=t?this.extend({},this.settings,n):this.extend({},this.settings,i,{phrases:{}},n)),l({file:e,data:n})})).catch((t=>{console.log("ERROR: Cannot load locale "+e),n(t)})))}))}scrollBarSize(){return this.tmp.scrollBarSize||(l("body").append('\n            <div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">\n                <div style="height: 120px">1</div>\n            </div>\n        '),this.tmp.scrollBarSize=100-l("#_scrollbar_width > div")[0].clientWidth,l("#_scrollbar_width").remove()),this.tmp.scrollBarSize}checkName(e){return null==e?(console.log('ERROR: Property "name" is required but not supplied.'),!1):null!=n[e]?(console.log(`ERROR: Object named "${e}" is already registered as w2ui.${e}.`),!1):!!this.isAlphaNumeric(e)||(console.log('ERROR: Property "name" has to be alpha-numeric (a-z, 0-9, dash and underscore).'),!1)}checkUniqueId(e,t,i,s){Array.isArray(t)||(t=[t]);let l=!0;return t.forEach((n=>{n.id===e&&(console.log(`ERROR: The item id="${e}" is not unique within the ${i} "${s}".`,t),l=!1)})),l}encodeParams(e,t=""){let i="";return Object.keys(e).forEach((s=>{""!=i&&(i+="&"),"object"==typeof e[s]?i+=this.encodeParams(e[s],t+s+(t?"]":"")+"["):i+=""+t+s+(t?"]":"")+"="+e[s]})),i}parseRoute(e){let t=[];return e=e.replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,((e,i,s,l,n,a)=>(t.push({name:l,optional:!!a}),i=i||"",(a?"":i)+"(?:"+(a?i:"")+(s||"")+(n||(s?"([^/.]+?)":"([^/]+?)"))+")"+(a||"")))).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),{path:new RegExp("^"+e+"$","i"),keys:t}}getCursorPosition(e){if(null==e)return null;let t=0;var i,s=e.ownerDocument||e.document,l=s.defaultView||s.parentWindow;let n;return["INPUT","TEXTAREA"].includes(e.tagName)?t=e.selectionStart:l.getSelection?0<(n=l.getSelection()).rangeCount&&((i=(l=n.getRangeAt(0)).cloneRange()).selectNodeContents(e),i.setEnd(l.endContainer,l.endOffset),t=i.toString().length):(n=s.selection)&&"Control"!==n.type&&(l=n.createRange(),(i=s.body.createTextRange()).moveToElementText(e),i.setEndPoint("EndToEnd",l),t=i.text.length),t}setCursorPosition(e,t,i){if(null!=e){var s=document.createRange();let n,a=window.getSelection();if(["INPUT","TEXTAREA"].includes(e.tagName))e.setSelectionRange(t,i??t);else{for(let i=0;i<e.childNodes.length;i++){let s=l(e.childNodes[i]).text();if(t<=(s=e.childNodes[i].tagName?(s=l(e.childNodes[i]).html()).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&nbsp;/g," "):s).length){(n=(n=e.childNodes[i]).childNodes&&0<n.childNodes.length?n.childNodes[0]:n).childNodes&&0<n.childNodes.length&&(n=n.childNodes[0]);break}t-=s.length}null!=n&&(t>n.length&&(t=n.length),s.setStart(n,t),i?s.setEnd(n,i):s.collapse(!0),a.removeAllRanges(),a.addRange(s))}}}parseColor(e){if("string"!=typeof e)return null;let t={};if(3===(e="#"===(e=e.trim().toUpperCase())[0]?e.substr(1):e).length)t={r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:1};else if(6===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:1};else if(8===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:Math.round(parseInt(e.substr(6,2),16)/255*100)/100};else if(4<e.length&&"RGB("===e.substr(0,4)){var i=e.replace("RGB","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:1}}else{if(!(5<e.length&&"RGBA("===e.substr(0,5)))return null;i=e.replace("RGBA","").replace(/\(/g,"").replace(/\)/g,"").split(","),t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:parseFloat(i[3])}}return t}colorContrast(e,t){return e=i(e),t=i(t),((Math.max(e,t)+.05)/(Math.min(e,t)+.05)).toFixed(2);function i(e){var{r:e,g:t,b:i}=a.parseColor(e)??{r:0,g:0,b:0},t=t/255,i=i/255;return.2126*((e/=255)<=.03928?e/12.92:Math.pow((.055+e)/1.055,2.2))+.7152*(t<=.03928?t/12.92:Math.pow((.055+t)/1.055,2.2))+.0722*(i<=.03928?i/12.92:Math.pow((.055+i)/1.055,2.2))}}hsv2rgb(e,t,i,s){let l,n,a,r,o,d,h,c;switch(1===arguments.length&&(t=e.s,i=e.v,s=e.a,e=e.h),d=(i/=100)*(1-(t/=100)),h=i*(1-(o=6*(e/=360)-(r=Math.floor(6*e)))*t),c=i*(1-(1-o)*t),r%6){case 0:l=i,n=c,a=d;break;case 1:l=h,n=i,a=d;break;case 2:l=d,n=i,a=c;break;case 3:l=d,n=h,a=i;break;case 4:l=c,n=d,a=i;break;case 5:l=i,n=d,a=h}return{r:Math.round(255*l),g:Math.round(255*n),b:Math.round(255*a),a:null!=s?s:1}}rgb2hsv(e,t,i,s){1===arguments.length&&(t=e.g,i=e.b,s=e.a,e=e.r);let l,n=Math.max(e,t,i),a=Math.min(e,t,i),r=n-a,o=0===n?0:r/n,d=n/255;switch(n){case a:l=0;break;case e:l=t-i+r*(t<i?6:0),l/=6*r;break;case t:l=i-e+2*r,l/=6*r;break;case i:l=e-t+4*r,l/=6*r}return{h:Math.round(360*l),s:Math.round(100*o),v:Math.round(100*d),a:null!=s?s:1}}tooltip(e,t){let i="mouseenter",s="mouseleave";return t=(t="object"==typeof e?e:t)||{},"string"==typeof e&&(t.html=e),t.showOn&&(i=t.showOn,delete t.showOn),t.hideOn&&(s=t.hideOn,delete t.hideOn),t.name||(t.name="no-name"),` on${i}="w2tooltip.show(this, JSON.parse(w2utils.base64decode('${this.base64encode(JSON.stringify(t))}')))" on${s}="w2tooltip.hide('${t.name}')"`}isPlainObject(e){return null!=e&&"[object Object]"===Object.prototype.toString.call(e)&&(void 0===e.constructor||null===(e=Object.getPrototypeOf(e))||e===Object.prototype)}clone(e,t){let i;return t=Object.assign({functions:!0,elements:!0,events:!0,exclude:[]},t??{}),Array.isArray(e)?(i=Array.from(e)).forEach(((e,s)=>{i[s]=this.clone(e,t)})):this.isPlainObject(e)?(i={},Object.assign(i,e),t.exclude&&t.exclude.forEach((e=>{delete i[e]})),Object.keys(i).forEach((e=>{i[e]=this.clone(i[e],t),void 0===i[e]&&delete i[e]}))):e instanceof Function&&!t.functions||e instanceof Node&&!t.elements||e instanceof Event&&!t.events||(i=e),i}extend(e,t){if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Arrays can be extended with arrays only");e.splice(0,e.length),t.forEach((t=>{e.push(this.clone(t))}))}else{if(e instanceof Node||e instanceof Event)throw new Error("HTML elmenents and events cannot be extended");if(e&&"object"==typeof e&&null!=t){if("object"!=typeof t)throw new Error("Object can be extended with other objects only.");Object.keys(t).forEach((i=>{var s;null!=e[i]&&"object"==typeof e[i]&&null!=t[i]&&"object"==typeof t[i]?(s=this.clone(t[i]),e[i]instanceof Node||e[i]instanceof Event?e[i]=s:(Array.isArray(e[i])&&this.isPlainObject(s)&&(e[i]={}),this.extend(e[i],s))):e[i]=this.clone(t[i])}))}else if(null!=t)throw new Error("Object is not extendable, only {} or [] can be extended.")}if(2<arguments.length)for(let t=2;t<arguments.length;t++)this.extend(e,arguments[t]);return e}naturalCompare(e,t){let i,s,l=1,n=0,a=0,r=String.alphabet;function o(e,t,s){if(s){for(i=t;(s=o(e,i))<76&&65<s;)++i;return+e.slice(t-1,i)}return-1<(s=r&&r.indexOf(e.charAt(t)))?s+76:(s=e.charCodeAt(t)||0)<45||127<s?s:s<46?65:s<48?s-1:s<58?s+18:s<65?s-11:s<91?s+11:s<97?s-37:s<123?s+5:s-63}if((e+="")!=(t+=""))for(;l;)if(s=o(e,n++),l=o(t,a++),s<76&&l<76&&66<s&&66<l&&(s=o(e,n,n),l=o(t,a,n=i),a=i),s!=l)return s<l?-1:1;return 0}normMenu(e,t){return Array.isArray(e)?(e.forEach(((t,i)=>{"string"==typeof t||"number"==typeof t?e[i]={id:t,text:String(t)}:null!=t?(null!=t.caption&&null==t.text&&(t.text=t.caption),null!=t.text&&null==t.id&&(t.id=t.text),null==t.text&&null!=t.id&&(t.text=t.id)):e[i]={id:null,text:"null"}})),e):"function"==typeof e?(t=e.call(this,e,t),a.normMenu.call(this,t)):"object"==typeof e?Object.keys(e).map((t=>({id:t,text:e[t]}))):void 0}prepareParams(e,t,i){i=i??a.settings.dataType;let s=t.body;switch(i){case"HTTPJSON":s={request:s},["PUT","DELETE"].includes(t.method)&&(t.method="POST"),l();break;case"HTTP":["PUT","DELETE"].includes(t.method)&&(t.method="POST"),l();break;case"RESTFULL":["PUT","DELETE"].includes(t.method)?t.headers["Content-Type"]="application/json":l();break;case"JSON":"GET"==t.method?(s={request:s},l()):(t.headers["Content-Type"]="application/json",t.method="POST")}return t.body="string"==typeof t.body?t.body:JSON.stringify(t.body),t;function l(){Object.keys(s).forEach((t=>{let i=s[t];"object"==typeof i&&(i=JSON.stringify(i)),e.searchParams.append(t,i)})),delete t.body}}bindEvents(e,t){0!=e.length&&(e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),l(e).each((e=>{let i=l(e).data();Object.keys(i).forEach((s=>{if(-1!=["click","dblclick","mouseenter","mouseleave","mouseover","mouseout","mousedown","mousemove","mouseup","contextmenu","focus","focusin","focusout","blur","input","change","keydown","keyup","keypress"].indexOf(String(s).toLowerCase())){let n=i[s],a=(n="string"==typeof n?n.split("|").map((e=>{"null"===(e="undefined"===(e="false"!==(e="true"===e||e)&&e)?void 0:e)&&(e=null);var t=["'",'"',"`"];return"string"==typeof(e=parseFloat(e)==e?parseFloat(e):e)&&t.includes(e[0])&&t.includes(e[e.length-1])?e.substring(1,e.length-1):e})):n)[0];n=n.slice(1),l(e).off(s+".w2utils-bind").on(s+".w2utils-bind",(function(e){switch(a){case"alert":alert(n[0]);break;case"stop":e.stopPropagation();break;case"prevent":e.preventDefault();break;case"stopPrevent":return e.stopPropagation(),e.preventDefault(),!1;default:if(null==t[a])throw new Error(`Cannot dispatch event as the method "${a}" does not exist.`);t[a].apply(t,n.map(((t,i)=>{switch(String(t).toLowerCase()){case"event":return e;case"this":return this;default:return t}})))}}))}}))})))}debounce(e,t=250){let i;return(...s)=>{clearTimeout(i),i=setTimeout((()=>{e(...s)}),t)}}};function r(e,t,i){let s;return t={title:a.lang(t??"Notification"),body:`<div class="w2ui-centered w2ui-msg-text">${e}</div>`,showClose:!1,actions:{ok:"Ok"},cancelAction:"ok"},(s=0<l("#w2ui-popup").length&&"closing"!=o.status?o.message(t):o.open(t)).ok((e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i()})),s}let o=new class extends t{constructor(){super(),this.defaults={title:"",text:"",body:"",buttons:"",width:450,height:250,focus:null,actions:null,style:"",speed:.3,blockPage:!0,modal:!1,maximized:!1,keyboard:!0,showClose:!0,showMax:!1,resizable:!1,transition:null,openMaximized:!1,moved:!1},this.name="popup",this.status="closed",this.onOpen=null,this.onClose=null,this.onMax=null,this.onMin=null,this.onToggle=null,this.onKeydown=null,this.onAction=null,this.onMove=null,this.tmp={},this.handleResize=e=>{this.options.moved||this.center(void 0,void 0,!0)}}open(e){let t=this;"closing"!=this.status&&!l("#w2ui-popup").hasClass("animating")||this.close(!0);var i=this.options;let s,n,r;null!=(e=["string","number"].includes(typeof e)?a.extend({title:"Notification",body:`<div class="w2ui-centered">${e}</div>`,actions:{Ok(){t.close()}},cancelAction:"ok"},arguments[1]??{}):e).text&&(e.body=`<div class="w2ui-centered w2ui-msg-text">${e.text}</div>`),e=Object.assign({},this.defaults,i,{title:"",body:""},e,{maximized:!1}),this.options=e,0===l("#w2ui-popup").length&&(this.off("*"),Object.keys(this).forEach((e=>{e.startsWith("on")&&"on"!=e&&(this[e]=null)}))),Object.keys(e).forEach((t=>{t.startsWith("on")&&"on"!=t&&e[t]&&(this[t]=e[t])})),e.width=parseInt(e.width),e.height=parseInt(e.height);var{top:o,left:d}=this.center();let h={self:this,action:e=>(t.on("action.prom",e),h),close:e=>(t.on("close.prom",e),h),then:e=>(t.on("open:after.prom",e),h)},c=(null==e.actions||e.buttons||(e.buttons="",Object.keys(e.actions).forEach((i=>{var s=e.actions[i];let l=i;"function"==typeof s&&(e.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${i}" data-click='["action","${i}","event"]'>${i}</button>`),"object"==typeof s&&(e.buttons+=`<button class="w2ui-btn w2ui-eaction ${s.class||""}" name="${i}" data-click='["action","${i}","event"]'\n                        style="${s.style}" ${s.attrs}>${s.text||i}</button>`,l=Array.isArray(e.actions)?s.text:i),"string"==typeof s&&(l=s[0].toLowerCase()+s.substr(1).replace(/\s+/g,""),e.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${i}" data-click='["action","${l}","event"]'>${s}</button>`),"string"==typeof l&&(l=l[0].toLowerCase()+l.substr(1).replace(/\s+/g,"")),h[l]=function(e){return t.on("action.buttons",(t=>{t.detail.action[0].toLowerCase()+t.detail.action.substr(1).replace(/\s+/g,"")==l&&e(t)})),h}}))),"");if(e.showClose&&(c+='<div class="w2ui-popup-button w2ui-popup-close">\n                        <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>\n                    </div>'),e.showMax&&(c+='<div class="w2ui-popup-button w2ui-popup-max">\n                        <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>\n                    </div>'),0===l("#w2ui-popup").length){if(!0===(s=this.trigger("open",{target:"popup",present:!1})).isCancelled)return;this.status="opening",e.blockPage&&a.lock(document.body,{opacity:.3,onClick:e.modal?null:()=>{this.close()}}),d=`\n                left: ${d}px;\n                top: ${o}px;\n                width: ${parseInt(e.width)}px;\n                height: ${parseInt(e.height)}px;\n                transition: ${e.speed}s\n            `,n=`<div id="w2ui-popup" class="w2ui-popup w2ui-anim-open animating ${e.blockPage?"":"w2ui-non-blocking"}" style="${a.stripSpaces(d)}"></div>`,l("body").append(n),l("#w2ui-popup")[0]._w2popup={self:this,created:new Promise((e=>{this._promCreated=e})),opened:new Promise((e=>{this._promOpened=e})),closing:new Promise((e=>{this._promClosing=e})),closed:new Promise((e=>{this._promClosed=e}))},d=(e.title?"":"top: 0px !important;")+" "+(e.buttons?"":"bottom: 0px !important;"),n=`\n                <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>\n                <div class="w2ui-popup-title-btns">${c}</div>\n                <div class="w2ui-popup-title" style="${e.title?"":"display: none"}"></div>\n                <div class="w2ui-box" style="${d}">\n                    <div class="w2ui-popup-body ${!e.title||" w2ui-popup-no-title"}\n                        ${!e.buttons||" w2ui-popup-no-buttons"}" style="${e.style}">\n                    </div>\n                </div>\n                <div class="w2ui-popup-buttons" style="${e.buttons?"":"display: none"}"></div>\n                <div class="w2ui-popup-resizer resize-point resize-icon"></div>\n                <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>\n            `,l("#w2ui-popup").html(n),e.title&&l("#w2ui-popup .w2ui-popup-title").append(a.lang(e.title)),e.buttons&&l("#w2ui-popup .w2ui-popup-buttons").append(e.buttons),e.body&&l("#w2ui-popup .w2ui-popup-body").append(e.body),setTimeout((()=>{l("#w2ui-popup").css("transition",e.speed+"s").removeClass("w2ui-anim-open"),a.bindEvents("#w2ui-popup .w2ui-eaction",this),l("#w2ui-popup").find(".w2ui-popup-body").show(),this._promCreated()}),1),clearTimeout(this._timer),this._timer=setTimeout((()=>{this.status="open",t.setFocus(e.focus),s.finish(),this._promOpened(),l("#w2ui-popup").removeClass("animating")}),1e3*e.speed)}else{if(!0===(s=this.trigger("open",{target:"popup",present:!0})).isCancelled)return;this.status="opening",null!=i&&(i.maximized||i.width==e.width&&i.height==e.height||this.resize(e.width,e.height),e.prevSize=e.width+"px:"+e.height+"px",e.maximized=i.maximized),o=l("#w2ui-popup .w2ui-box").get(0).cloneNode(!0),l(o).removeClass("w2ui-box").addClass("w2ui-box-temp").find(".w2ui-popup-body").empty().append(e.body),l("#w2ui-popup .w2ui-box").after(o),e.buttons?(l("#w2ui-popup .w2ui-popup-buttons").show().html("").append(e.buttons),l("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-buttons"),l("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","")):(l("#w2ui-popup .w2ui-popup-buttons").hide().html(""),l("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-buttons"),l("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","0px")),e.title?(l("#w2ui-popup .w2ui-popup-title").show().html(a.lang(e.title)),l("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-title"),l("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","")):(l("#w2ui-popup .w2ui-popup-title").hide().html(""),l("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-title"),l("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","0px")),c?l("#w2ui-popup .w2ui-popup-title-btns").show().html(c):l("#w2ui-popup .w2ui-popup-title-btns").hide();let n=l("#w2ui-popup .w2ui-box")[0],r=l("#w2ui-popup .w2ui-box-temp")[0];l("#w2ui-popup").addClass("animating"),a.transition(n,r,e.transition,(()=>{l(n).remove(),l(r).removeClass("w2ui-box-temp").addClass("w2ui-box");var i=l(r).find(".w2ui-popup-body");1==i.length&&(i[0].style.cssText=e.style,i.show()),t.setFocus(e.focus),l("#w2ui-popup").removeClass("animating")})),this.status="open",s.finish(),a.bindEvents("#w2ui-popup .w2ui-eaction",this),l("#w2ui-popup").find(".w2ui-popup-body").show()}return e.openMaximized&&this.max(),e._last_focus=document.activeElement,e.keyboard&&l(document.body).off(".w2popup").on("keydown.w2popup",(e=>{this.keydown(e)})),l(window).on("resize",this.handleResize),r={changing:!1,mvMove:function(e){1==r.changing&&(e=e||window.event,r.div_x=e.screenX-r.x,r.div_y=e.screenY-r.y,!0!==(e=t.trigger("move",{target:"popup",div_x:r.div_x,div_y:r.div_y,originalEvent:e})).isCancelled)&&("moving"==t.status?(l("#w2ui-popup").css({transition:"none",transform:"translate3d("+r.div_x+"px, "+r.div_y+"px, 0px)"}),t.options.moved=!0):l("#w2ui-popup").css({transition:"none",width:r.width+r.div_x+"px",height:r.height+r.div_y+"px"}),e.finish())},mvStop:function(e){1!=r.changing||(e=e||window.event,r.div_x=e.screenX-r.x,r.div_y=e.screenY-r.y,"moving"==t.status?l("#w2ui-popup").css({left:r.pos_x+r.div_x+"px",top:r.pos_y+r.div_y+"px"}).css({transition:"none",transform:"translate3d(0px, 0px, 0px)"}):(l("#w2ui-popup").css({transition:"none",width:r.width+r.div_x+"px",height:r.height+r.div_y+"px"}),t.resizeMessages()),r.changing=!1,t.status="open",l(document.body).off(".w2ui-popup"),r.isLocked)||t.unlock()}},l("#w2ui-popup .w2ui-popup-title").off("mousedown").on("mousedown",(function(e){t.options.maximized||u(e)})),e.resizable?(l("#w2ui-popup .w2ui-popup-resizer").show(),l("#w2ui-popup .w2ui-popup-resizer").off("mousedown").on("mousedown",(e=>{u(e,!0)}))):l("#w2ui-popup .w2ui-popup-resizer").hide(),h;function u(e,i){e=e||window.event,t.status=i?"resizing":"moving",i=l("#w2ui-popup").get(0).getBoundingClientRect(),Object.assign(r,{changing:!0,isLocked:1==l("#w2ui-popup > .w2ui-lock").length,x:e.screenX,y:e.screenY,pos_x:i.x,pos_y:i.y,width:i.width,height:i.height}),r.isLocked||t.lock({opacity:0}),l(document.body).on("mousemove.w2ui-popup",r.mvMove).on("mouseup.w2ui-popup",r.mvStop),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault()}}load(e){return new Promise(((t,i)=>{if(null==(e="string"==typeof e?{url:e}:e).url)console.log("ERROR: The url is not defined."),i("The url is not defined");else{this.status="loading";let[i,s]=String(e.url).split("#");i&&fetch(i).then((e=>e.text())).then((i=>{t(this.template(i,s,e))}))}}))}template(e,t,i={}){let s;try{s=l(e)}catch(t){s=l.html(e)}return t&&(s=s.filter("#"+t)),Object.assign(i,{width:parseInt(l(s).css("width")),height:parseInt(l(s).css("height")),title:l(s).find("[rel=title]").html(),body:l(s).find("[rel=body]").html(),buttons:l(s).find("[rel=buttons]").html(),style:l(s).find("[rel=body]").get(0).style.cssText}),this.open(i)}action(e,t){let i=this.options.actions[e];i instanceof Object&&i.onClick&&(i=i.onClick),!0!==(e=this.trigger("action",{action:e,target:"popup",self:this,originalEvent:t,value:this.input?this.input.value:null})).isCancelled&&("function"==typeof i&&i.call(this,t),e.finish())}keydown(e){var t;this.options&&!this.options.keyboard||!0!==(t=this.trigger("keydown",{target:"popup",originalEvent:e})).isCancelled&&(27===e.keyCode&&(e.preventDefault(),0==l("#w2ui-popup .w2ui-message").length)&&(this.options.cancelAction?this.action(this.options.cancelAction):this.close()),t.finish())}close(e){let t=this.trigger("close",{target:"popup"});var i;!0!==t.isCancelled&&(i=()=>{l("#w2ui-popup").remove(),this.options._last_focus&&0<this.options._last_focus.length&&this.options._last_focus.focus(),this.status="closed",this.options={},t.finish(),this._promClosed()},0!==l("#w2ui-popup").length)&&"closed"!=this.status&&("opening"==this.status&&(e=!0),"closing"==this.status&&!0===e?(i(),clearTimeout(this.tmp.closingTimer),a.unlock(document.body,0)):(this.status="closing",l("#w2ui-popup").css("transition",this.options.speed+"s").addClass("w2ui-anim-close animating"),a.unlock(document.body,300),this._promClosing(),e?i():this.tmp.closingTimer=setTimeout(i,1e3*this.options.speed),this.options.keyboard&&l(document.body).off("keydown",this.keydown),l(window).off("resize",this.handleResize)))}toggle(){let e=this.trigger("toggle",{target:"popup"});!0!==e.isCancelled&&(!0===this.options.maximized?this.min():this.max(),setTimeout((()=>{e.finish()}),1e3*this.options.speed+50))}max(){if(!0!==this.options.maximized){let t=this.trigger("max",{target:"popup"});var e;!0!==t.isCancelled&&(this.status="resizing",e=l("#w2ui-popup").get(0).getBoundingClientRect(),this.options.prevSize=e.width+":"+e.height,this.resize(1e4,1e4,(()=>{this.status="open",this.options.maximized=!0,t.finish()})))}}min(){if(!0===this.options.maximized){var e=this.options.prevSize.split(":");let t=this.trigger("min",{target:"popup"});!0!==t.isCancelled&&(this.status="resizing",this.options.maximized=!1,this.resize(parseInt(e[0]),parseInt(e[1]),(()=>{this.status="open",this.options.prevSize=null,t.finish()})))}}clear(){l("#w2ui-popup .w2ui-popup-title").html(""),l("#w2ui-popup .w2ui-popup-body").html(""),l("#w2ui-popup .w2ui-popup-buttons").html("")}reset(){this.open(this.defaults)}message(e){return a.message({owner:this,box:l("#w2ui-popup").get(0),after:".w2ui-popup-title"},e)}confirm(e){return a.confirm({owner:this,box:l("#w2ui-popup"),after:".w2ui-popup-title"},e)}setFocus(e){let t=l("#w2ui-popup"),i="input, button, select, textarea, [contentEditable], [tabindex], .w2ui-input";null!=e?(isNaN(e)?t.find(i).filter(e).get(0):t.find(i).get(e))?.focus():(e=t.find("[name=hidden-first]").get(0))&&e.focus(),l(t).find(i).off(".keep-focus").on("blur.keep-focus",(function(e){setTimeout((()=>{var e=document.activeElement,s=0<l(t).find(i).filter(e).length,n=l(e).attr("name");!s&&e&&e!==document.body&&l(t).find(i).get(0)?.focus(),"hidden-last"==n&&l(t).find(i).get(1)?.focus(),"hidden-first"==n&&l(t).find(i).get(-2)?.focus()}),1)}))}lock(e,t){var i=Array.from(arguments);i.unshift(l("#w2ui-popup")),a.lock(...i)}unlock(e){a.unlock(l("#w2ui-popup"),e)}center(e,t,i){let s,n;n=null==window.innerHeight?(s=parseInt(document.documentElement.offsetWidth),parseInt(document.documentElement.offsetHeight)):(s=parseInt(window.innerWidth),parseInt(window.innerHeight)),e=parseInt(e??this.options.width),t=parseInt(t??this.options.height),!0===this.options.maximized&&(e=s,t=n),s-10<e&&(e=s-10),n-10<t&&(t=n-10);var a=(n-t)/3,r=(s-e)/2;return i&&(l("#w2ui-popup").css({transition:"none",top:a+"px",left:r+"px",width:e+"px",height:t+"px"}),this.resizeMessages()),{top:a,left:r,width:e,height:t}}resize(e,t,i){let s=this;null==this.options.speed&&(this.options.speed=0);var{top:e,left:t,width:n,height:a}=this.center(e,t),r=this.options.speed;l("#w2ui-popup").css({transition:r+`s width, ${r}s height, ${r}s left, ${r}s top`,top:e+"px",left:t+"px",width:n+"px",height:a+"px"});let o=setInterval((()=>{s.resizeMessages()}),10);setTimeout((()=>{clearInterval(o),s.resizeMessages(),"function"==typeof i&&i()}),1e3*this.options.speed+50)}resizeMessages(){l("#w2ui-popup .w2ui-message").each((e=>{var t=e._msg_options,i=l("#w2ui-popup"),s=(parseInt(t.width)<10&&(t.width=10),parseInt(t.height)<10&&(t.height=10),i[0].getBoundingClientRect()),n=(i=parseInt(i.find(".w2ui-popup-title")[0].clientHeight),parseInt(s.width));s=parseInt(s.height),t.width=t.originalWidth,t.width>n-10&&(t.width=n-10),t.height=t.originalHeight,t.height>s-i-5&&(t.height=s-i-5),t.originalHeight<0&&(t.height=s+t.originalHeight-i),t.originalWidth<0&&(t.width=n+2*t.originalWidth),l(e).css({left:(n-t.width)/2+"px",width:t.width+"px",height:t.height+"px"})}))}};class d{static active={};constructor(){this.defaults={name:null,html:"",style:"",class:"",position:"top|bottom",align:"",anchor:null,contextMenu:!1,anchorClass:"",anchorStyle:"",autoShow:!1,autoShowOn:null,autoHideOn:null,arrowSize:8,screenMargin:2,autoResize:!0,margin:1,offsetX:0,offsetY:0,maxWidth:null,maxHeight:null,watchScroll:null,watchResize:null,hideOn:null,onThen:null,onShow:null,onHide:null,onUpdate:null,onMove:null}}static observeRemove=new MutationObserver((e=>{let t=0;Object.keys(d.active).forEach((e=>{(e=d.active[e]).displayed&&(e.anchor&&e.anchor.isConnected?t++:e.hide())})),0===t&&d.observeRemove.disconnect()}));trigger(e,t){var i;if(2==arguments.length&&(i=e,(e=t).type=i),e.overlay)return e.overlay.trigger(e);console.log("ERROR: cannot find overlay where to trigger events")}get(e){return 0==arguments.length?Object.keys(d.active):!0===e?d.active:d.active[e.replace(/[\s\.#]/g,"_")]}attach(e,i){let s,n,r=this;if(0!=arguments.length){1==arguments.length&&e instanceof Object?e=(s=e).anchor:2===arguments.length&&"string"==typeof i?i=(s={anchor:e,html:i}).html:2===arguments.length&&null!=i&&"object"==typeof i&&(i=(s=i).html),s=a.extend({},this.defaults,s||{}),!(i=!i&&s.text?s.text:i)&&s.html&&(i=s.html),delete s.anchor;let o=s.name||e?.id;e!=document&&null!=e||(e=document.body),s.contextMenu&&(e=document.body,o=o??"context-menu"),o||(o="noname-"+Object.keys(d.active).length,console.log("NOTICE: name property is not defined for tooltip, could lead to too many instances")),o=o.replace(/[\s\.#]/g,"_"),d.active[o]?((n=d.active[o]).prevOptions=n.options,n.options=s,n.anchor=e,n.prevOptions.html==n.options.html&&n.prevOptions.class==n.options.class&&n.prevOptions.style==n.options.style||(n.needsUpdate=!0),s=n.options,Object.keys(n).forEach((e=>{var t=n[e];e.startsWith("on")&&"function"==typeof t&&delete n[e]}))):(n=new t,Object.assign(n,{id:"w2overlay-"+o,name:o,options:s,anchor:e,self:r,displayed:!1,tmp:{observeResize:new ResizeObserver((()=>{this.resize(n.name)}))},hide(){r.hide(o)}}),d.active[o]=n),Object.keys(n.options).forEach((e=>{var t=n.options[e];e.startsWith("on")&&"function"==typeof t&&(n[e]=t,delete n.options[e])})),!0===s.autoShow&&(s.autoShowOn=s.autoShowOn??"mouseenter",s.autoHideOn=s.autoHideOn??"mouseleave",s.autoShow=!1,s._keep=!0),s.autoShowOn&&(i="autoShow-"+n.name,l(e).off("."+i).on(s.autoShowOn+"."+i,(e=>{r.show(n.name),e.stopPropagation()})),delete s.autoShowOn,s._keep=!0),s.autoHideOn&&(i="autoHide-"+n.name,l(e).off("."+i).on(s.autoHideOn+"."+i,(e=>{r.hide(n.name),e.stopPropagation()})),delete s.autoHideOn,s._keep=!0),n.off(".attach");let h={overlay:n,then:e=>(n.on("show:after.attach",(t=>{e(t)})),h),show:e=>(n.on("show.attach",(t=>{e(t)})),h),hide:e=>(n.on("hide.attach",(t=>{e(t)})),h),update:e=>(n.on("update.attach",(t=>{e(t)})),h),move:e=>(n.on("move.attach",(t=>{e(t)})),h)};return h}}update(e,t){var i=d.active[e];i?(i.needsUpdate=!0,i.options.html=t,this.show(e)):console.log(`Tooltip "${e}" is not displayed. Cannot update it.`)}show(e){if(e instanceof HTMLElement||e instanceof Object){let t=e,i=(e instanceof HTMLElement&&((t=arguments[1]||{}).anchor=e),this.attach(t));return i.overlay.tmp.hidden=!1,l(i.overlay.anchor).off(".autoShow-"+i.overlay.name).off(".autoHide-"+i.overlay.name),setTimeout((()=>{i.overlay.tmp.hidden||(this.show(i.overlay.name),this.initControls&&this.initControls(i.overlay))}),1),i}let t,i=this,s=d.active[e.replace(/[\s\.#]/g,"_")];if(s){let o=s.options;if(!s||s.displayed&&!s.needsUpdate)this.resize(s?.name);else{var n=o.position.split("|");n=["top","bottom"].includes(n[0]);let h="both"==o.align&&n?"":"white-space: nowrap;";if(o.maxWidth&&a.getStrWidth(o.html,"")>o.maxWidth&&(h="width: "+o.maxWidth+"px; white-space: inherit; overflow: auto;"),h+=" max-height: "+(o.maxHeight||window.innerHeight-4)+"px;",""!==o.html&&null!=o.html){if(s.box){if(!0===(t=this.trigger("update",{target:e,overlay:s})).isCancelled)return void(s.prevOptions&&(s.options=s.prevOptions,delete s.prevOptions));l(s.box).find(".w2ui-overlay-body").attr("style",(o.style||"")+"; "+h).removeClass().addClass("w2ui-overlay-body "+o.class).html(o.html)}else{if(!0===(t=this.trigger("show",{target:e,overlay:s})).isCancelled)return;l("body").append(`<div id="${s.id}" name="${e}" style="display: none; pointer-events: none" class="w2ui-overlay"\n                        data-click="stop" data-focusin="stop">\n                    <style></style>\n                    <div class="w2ui-overlay-body ${o.class}" style="${o.style||""}; ${h}">\n                        ${o.html}\n                    </div>\n                </div>`),s.box=l("#"+a.escapeId(s.id))[0],s.displayed=!0,(n=l(s.anchor).data("tooltipName")??[]).push(e),l(s.anchor).data("tooltipName",n),a.bindEvents(s.box,{}),s.tmp.originalCSS="",0<l(s.anchor).length&&(s.tmp.originalCSS=l(s.anchor)[0].style.cssText)}this.resize(s.name),o.anchorStyle&&(s.anchor.style.cssText+=";"+o.anchorStyle),!o.anchorClass||"w2ui-focus"==o.anchorClass&&s.anchor==document.body||l(s.anchor).addClass(o.anchorClass),"string"==typeof o.hideOn&&(o.hideOn=[o.hideOn]),Array.isArray(o.hideOn)||(o.hideOn=[]),Object.assign(s.tmp,{scrollLeft:document.body.scrollLeft,scrollTop:document.body.scrollTop});{let e=e=>{i.hide(s.name)},t=l(s.anchor),n="tooltip-"+s.name;l("html").off("."+n),o.hideOn.includes("doc-click")&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&t.off(`.${n}-doc`).on(`click.${n}-doc`,(e=>{e.stopPropagation()})),l("html").on("click."+n,e)),o.hideOn.includes("focus-change")&&l("html").on("focusin."+n,(e=>{document.activeElement!=s.anchor&&i.hide(s.name)})),["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&(t.off("."+n),o.hideOn.forEach((i=>{-1==["doc-click","focus-change"].indexOf(i)&&t.on(i+"."+n,{once:!0},e)})))}{var r=document.body;let e="tooltip-"+s.name,t=r;"BODY"==r.tagName&&(t=r.ownerDocument),l(t).off("."+e).on("scroll."+e,(e=>{Object.assign(s.tmp,{scrollLeft:r.scrollLeft,scrollTop:r.scrollTop}),i.resize(s.name)}))}return l(s.box).show(),s.tmp.observeResize.observe(s.box),d.observeRemove.observe(document.body,{subtree:!0,childList:!0}),l(s.box).css("opacity",1).find(".w2ui-overlay-body").html(o.html),setTimeout((()=>{l(s.box).css({"pointer-events":"auto"}).data("ready","yes")}),100),delete s.needsUpdate,s.box.overlay=s,t&&t.finish(),{overlay:s}}i.hide(e)}}}hide(e){let t;if(0==arguments.length)Object.keys(d.active).forEach((e=>{this.hide(e)}));else if(e instanceof HTMLElement)(l(e).data("tooltipName")??[]).forEach((e=>{this.hide(e)}));else if("string"==typeof e&&(e=e.replace(/[\s\.#]/g,"_"),t=d.active[e]),t?.tmp&&(t.tmp.hidden=!0),t&&t.box){var i=this.trigger("hide",{target:e,overlay:t});if(!0!==i.isCancelled){t.options._keep||delete d.active[e],e="tooltip-"+t.name,t.tmp.observeResize?.disconnect(),t.options.watchScroll&&l(t.options.watchScroll).off(".w2scroll-"+t.name);let n=0;Object.keys(d.active).forEach((e=>{d.active[e].displayed&&n++})),0==n&&d.observeRemove.disconnect(),l("html").off("."+e),l(document).off("."+e),t.box?.remove(),t.box=null,t.displayed=!1;var s=l(t.anchor).data("tooltipName")??[];-1!=s.indexOf(t.name)&&s.splice(s.indexOf(t.name),1),0==s.length?l(t.anchor).removeData("tooltipName"):l(t.anchor).data("tooltipName",s),t.options.anchorStyle&&(t.anchor.style.cssText=t.tmp.originalCSS),l(t.anchor).off("."+e).removeClass(t.options.anchorClass),t.options.url&&(t.options.items.splice(0),t.tmp.remote.hasMore=!0,t.tmp.remote.search=null),i.finish()}}}resize(e){if(0==arguments.length)Object.keys(d.active).forEach((e=>{(e=d.active[e]).displayed&&this.resize(e.name)}));else{var t=d.active[e.replace(/[\s\.#]/g,"_")];let s=this.getPosition(t.name);var i=s.left+"x"+s.top;let n;t.tmp.lastPos!=i&&(n=this.trigger("move",{target:e,overlay:t,pos:s})),l(t.box).css({left:s.left+"px",top:s.top+"px"}).then((e=>{null!=s.width&&e.css("width",s.width+"px").find(".w2ui-overlay-body").css("width","100%"),null!=s.height&&e.css("height",s.height+"px").find(".w2ui-overlay-body").css("height","100%")})).find(".w2ui-overlay-body").removeClass("w2ui-arrow-right w2ui-arrow-left w2ui-arrow-top w2ui-arrow-bottom").addClass(s.arrow.class).closest(".w2ui-overlay").find("style").text(s.arrow.style),t.tmp.lastPos!=i&&n&&(t.tmp.lastPos=i,n.finish())}}getPosition(e){let t=d.active[e.replace(/[\s\.#]/g,"_")];if(t&&t.box){let d=t.options;(t.tmp.resizedY||t.tmp.resizedX)&&l(t.box).css({width:"",height:"",scroll:"auto"}),e=a.scrollBarSize();var i=!(document.body.scrollWidth==document.body.clientWidth),s=!(document.body.scrollHeight==document.body.clientHeight);let p={width:window.innerWidth-(s?e:0),height:window.innerHeight-(i?e:0)};var n,r="auto"==d.position?"top|bottom|right|left".split("|"):Array.isArray(d.position)?d.position:d.position.split("|");let m=["top","bottom"].includes(r[0]),g=t.box.getBoundingClientRect(),f=t.anchor?.getBoundingClientRect?.();if(t.anchor==document.body){let e=d.originalEvent;for(;e?.originalEvent;)e=e.originalEvent;var{x:o,y:h,width:c,height:u}=e??{x:d.x,y:d.y,width:0,height:10};f={left:o-(d.contextMenu?4:0),top:h-(d.contextMenu?4:0),width:c??0,height:u??10,arrow:d.contextMenu?"none":null}}let b=d.arrowSize,v=("none"==f.arrow&&(b=0),{top:f.top-b,bottom:p.height-b-(f.top+f.height)-(i?e:0)-2,left:f.left,right:p.width-(f.left+f.width)+(s?e:0)});g.width<22&&(g.width=22),g.height<14&&(g.height=14);let y,w,x,_,k="",C={offset:0,class:"",style:`#${t.id} { --tip-size: ${b}px; }`},S={left:0,top:0},E={posX:"",x:0,posY:"",y:0};switch(r.forEach((e=>{["top","bottom"].includes(e)&&(!k&&g.height+b/1.893<v[e]&&(k=e),v[e]>E.y)&&Object.assign(E,{posY:e,y:v[e]}),["left","right"].includes(e)&&(!k&&g.width+b/1.893<v[e]&&(k=e),v[e]>E.x)&&Object.assign(E,{posX:e,x:v[e]})})),k=k||(m?E.posY:E.posX),d.autoResize&&(["top","bottom"].includes(k)&&(g.height>v[k]?(_=v[k],t.tmp.resizedY=!0):t.tmp.resizedY=!1),["left","right"].includes(k))&&(g.width>v[k]?(x=v[k],t.tmp.resizedX=!0):t.tmp.resizedX=!1),o=k,C.class=f.arrow||"w2ui-arrow-"+o,o){case"top":y=f.left+(f.width-(x??g.width))/2,w=f.top-(_??g.height)-b/1.5+1;break;case"bottom":y=f.left+(f.width-(x??g.width))/2,w=f.top+f.height+b/1.25+1;break;case"left":y=f.left-(x??g.width)-b/1.2-1,w=f.top+(f.height-(_??g.height))/2;break;case"right":y=f.left+f.width+b/1.2+1,w=f.top+(f.height-(_??g.height))/2}m&&("left"==d.align&&(S.left=f.left-y,y=f.left),"right"==d.align&&(S.left=f.left+f.width-(x??g.width)-y,y=f.left+f.width-(x??g.width)),["top","bottom"].includes(k)&&d.align.startsWith("both")&&(n=d.align.split(":")[1]??50,f.width>=n)&&(y=f.left,x=f.width),"top"==d.align&&(S.top=f.top-w,w=f.top),"bottom"==d.align&&(S.top=f.top+f.height-(_??g.height)-w,w=f.top+f.height-(_??g.height)),["left","right"].includes(k)&&d.align.startsWith("both")&&(n=d.align.split(":")[1]??50,f.height>=n)&&(w=f.top,_=f.height)),w+=parseFloat(d.offsetY*("top"==k?-1:1)),y+=parseFloat(d.offsetX*("left"==k?-1:1));{let e;(["left","right"].includes(d.align)&&f.width<(x??g.width)||["top","bottom"].includes(d.align)&&f.height<(_??g.height))&&(e=!0),h="right"==k?b:d.screenMargin,c="bottom"==k?b:d.screenMargin,u=p.width-(x??g.width)-("left"==k?b:d.screenMargin),i=p.height-(_??g.height)-("top"==k?b:d.screenMargin)+3,(["top","bottom"].includes(k)||d.autoResize)&&(y<h&&(e=!0,S.left-=y,y=h),y>u)&&(e=!0,S.left-=y-u,y+=u-y),(["left","right"].includes(k)||d.autoResize)&&(w<c&&(e=!0,S.top-=w,w=c),w>i)&&(e=!0,S.top-=w-i,w+=i-w),e&&(h=m?"left":"top",u=m?"width":"height",C.offset=-S[h],c=g[u]/2-b,Math.abs(C.offset)>c+b&&(C.class=""),Math.abs(C.offset)>c&&(C.offset=C.offset<0?-c:c),C.style=a.stripSpaces(`#${t.id} .w2ui-overlay-body:after,\n                            #${t.id} .w2ui-overlay-body:before {\n                                --tip-size: ${b}px;\n                                margin-${h}: ${C.offset}px;\n                            }`))}return s="top"==k?-d.margin:"bottom"==k?d.margin:0,e="left"==k?-d.margin:"right"==k?d.margin:0,w=Math.floor(100*(w+parseFloat(s)))/100,{left:y=Math.floor(100*(y+parseFloat(e)))/100,top:w,arrow:C,adjust:S,width:x,height:_,pos:k}}}}let h=new d,c=new class extends d{constructor(){super(),this.defaults=a.extend({},this.defaults,{type:"normal",items:[],index:null,render:null,spinner:!1,msgNoItems:a.lang("No items found"),topHTML:"",menuStyle:"",filter:!1,markSearch:!1,prefilter:!1,match:"contains",search:!1,altRows:!1,arrowSize:10,align:"left",position:"bottom|top",class:"w2ui-white",anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change","select"],onSelect:null,onSubMenu:null,onRemove:null})}attach(e,t){let i;1==arguments.length&&e instanceof Object?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e),t=i.hideOn,i=a.extend({},this.defaults,i||{}),t&&(i.hideOn=t),i.style+="; padding: 0;",null==i.items&&(i.items=[]),i.cacheMax<=0&&console.log(`The option "cacheMax" is ${i.cacheMax} but should be more than 0`),i.items=a.normMenu(i.items),i.html=this.getMenuHTML(i);let s=super.attach(i),n=s.overlay;return n.on("show:after.attach, update:after.attach",(e=>{if(s.overlay?.box){let e="";n.selected=null,["INPUT","TEXTAREA"].includes(n.anchor.tagName)&&(e=n.anchor.value,n.selected=n.anchor.dataset.selectedIndex);var t=l(s.overlay.box).find(".w2ui-eaction");a.bindEvents(t,this),this.applyFilter(n.name,null,e).then((e=>{d.active[n.name].displayed&&(n.tmp.searchCount=e.count,n.tmp.search=e.search,i.prefilter&&this.refreshSearch(n.name),this.initControls(s.overlay),this.refreshIndex(n.name,!0))}))}})),n.next=()=>{var e,t=this.getActiveChain(n.name);null==n.selected||0==n.selected?.length?n.selected=t[0]:(-1==(e=t.indexOf(n.selected))&&(n.selected=t[0]),e<t.length-1&&(n.selected=t[e+1])),this.refreshIndex(n.name)},n.prev=()=>{var e,t=this.getActiveChain(n.name);null==n.selected||0==n.selected?.length?n.selected=t[t.length-1]:(-1==(e=t.indexOf(n.selected))&&(n.selected=t[t.length-1]),0<e&&(n.selected=t[e-1])),this.refreshIndex(n.name)},n.click=()=>{$(n.box).find(".w2ui-selected").click()},n.on("hide:after.attach",(e=>{h.hide(n.name+"-tooltip")})),s.select=e=>(n.on("select.attach",(t=>{e(t)})),s),s.remove=e=>(n.on("remove.attach",(t=>{e(t)})),s),s.subMenu=e=>(n.on("subMenu.attach",(t=>{e(t)})),s),s}update(e,t){var i,s=d.active[e];s?((i=s.options).items!=t&&(i.items=t),t=this.getMenuHTML(i),i.html!=t&&(i.html=t,s.needsUpdate=!0,this.show(e))):console.log(`Tooltip "${e}" is not displayed. Cannot update it.`)}initControls(e){let t="mousedown",i="click";a.isMobile&&(t="touchstart",i="touchend"),l(e.box).find(".w2ui-menu:not(.w2ui-sub-menu)").off(".w2menu").on("contextmenu.w2menu",(e=>{e.preventDefault()})).on(t+".w2menu",{delegate:".w2ui-menu-item"},(t=>{var i=t.delegate.dataset;this.menuDown(e,t,i.index,i.parents)})).on(i+".w2menu",{delegate:".w2ui-menu-item"},(t=>{var i=t.delegate.dataset;this.menuClick(e,t,parseInt(i.index),i.parents)})).find(".w2ui-menu-item").off(".w2menu").on("mouseEnter.w2menu",(t=>{var i=t.target.dataset,s=e.options.items[i.index]?.tooltip;(s&&h.show({name:e.name+"-tooltip",anchor:t.target,html:s,position:"right|left",hideOn:["doc-click"]}),s=l(t.target).closest(".w2ui-menu").get(0))._evt&&s._evt.target!=t.target&&this.closeSubMenu(s._evt),"yes"==i.hassubmenu&&(i={index:parseInt(i.index),parents:""!==s.dataset.parents?s.dataset.parents.split("-").map((e=>parseInt(e))):[],target:t.target,originalEvent:t,overlay:e},s._evt=i,this.openSubMenu(i))})).on("mouseLeave.w2menu",(t=>{h.hide(e.name+"-tooltip")})).find(".menu-help").off(".w2menu").on("mouseEnter.w2menu",(t=>{var i=t.target.parentNode.parentNode.dataset;i=e.options.items[i.index]?.help,i&&h.show({name:e.name+"-help-tp",anchor:t.target,html:i,position:"right|left",hideOn:["doc-click"]})})).on("mouseLeave.w2menu",(t=>{h.hide(e.name+"-help-tp")})),["INPUT","TEXTAREA"].includes(e.anchor.tagName)&&l(e.anchor).off(".w2menu").on("input.w2menu",(e=>{})).on("keyup.w2menu",(t=>{t._searchType="filter",this.keyUp(e,t)})),e.options.search&&l(e.box).find("#menu-search").off(".w2menu").on("keyup.w2menu",(t=>{t._searchType="search",this.keyUp(e,t)}))}getCurrent(e,t){var i=(e=d.active[e.replace(/[\s\.#]/g,"_")]).options;let s=(t||(e.selected??"")).split("-");t=s.length-1,e=s[t];var l=s.slice(0,s.length-1).join("-");e=a.isInt(e)?parseInt(e):0;let n=i.items;return s.forEach(((e,t)=>{t<s.length-1&&(n=n[e].items)})),{last:t,index:e,items:n,item:n[e],parents:l}}getMenuHTML(e){if(e.spinner)return`\n            <div class="w2ui-menu">\n                <div class="w2ui-no-items">\n                    <div class="w2ui-spinner"></div>\n                    ${a.lang("Loading...")}\n                </div>\n            </div>`;let t=e.parents??[],i=e.items,s=(Array.isArray(i)||(i=[]),0),l=null,n="",r=(e.search&&(n+='\n                <div class="w2ui-menu-search">\n                    <span class="w2ui-icon w2ui-icon-search"></span>\n                    <input id="menu-search" class="w2ui-input" type="text"/>\n                </div>',i.forEach((e=>e.hidden=!1))),e.topHTML&&(n+=`<div class="w2ui-menu-top">${e.topHTML}</div>`),`\n            ${n}\n            <div class="w2ui-menu" style="${e.menuStyle}" data-parents="${t.join("-")}">\n        `);if(i.forEach(((n,o)=>{l=n.icon;var d=(0<t.length?t.join("-")+"-":"")+o;if(null==l&&(l=null),-1==["radio","check"].indexOf(e.type)||Array.isArray(n.items)||!1===n.group||(l=!0===n.checked?"w2ui-icon-check":"w2ui-icon-empty"),!0!==n.hidden){let t=n.text,i="";if("function"==typeof(t="function"==typeof e.render?e.render(n,e):t)&&(t=t(n,e)),l&&("<"!==String(l).slice(0,1)&&(l=`<span class="w2ui-icon ${l}"></span>`),i=`<div class="menu-icon">${l}</span></div>`),null==n.removable&&null!=n.remove&&(n.removable=n.remove),"break"!==n.type&&null!=t&&""!==t&&"--"!=String(t).substr(0,2)){var h=["w2ui-menu-item"];1==e.altRows&&h.push(s%2==0?"w2ui-even":"w2ui-odd");let l=1,c=(""===i&&l++,null==n.count&&null==n.hotkey&&!0!==n.removable&&null==n.items&&l++,null==n.tooltip&&null!=n.hint&&(n.tooltip=n.hint),"");!0===n.removable?c='<span class="menu-remove">x</span>':null!=n.items?(h.push("has-sub-menu"),c='<span style="background-color: transparent; border: transparent; box-shadow: none;"></span>'):(null!=n.count&&(c+="<span>"+n.count+"</span>"),null!=n.hotkey&&(c+='<span class="menu-hotkey">'+n.hotkey+"</span>"),null!=n.help&&(c+='<span class="menu-help">?</span>')),!0===n.disabled&&h.push("w2ui-disabled"),!0===n._noSearchInside&&h.push("w2ui-no-search-inside"),r+=`\n                        <div index="${d}" class="${h.join(" ")}" style="${n.style||""}"\n                            data-index="${o}" data-hasSubmenu="${null!=n.items?"yes":""}">\n                                <div style="width: ${parseInt(n.indent??0)}px"></div>\n                                ${i}\n                                <div class="menu-text" colspan="${l}">${a.lang(t)}</div>\n                                <div class="menu-extra">${c}</div>\n                        </div>`,s++}else h=(t??"").replace(/^-+/g,""),r+=`\n                        <div index="${d}" class="w2ui-menu-divider ${""!=h?"has-text":""}">\n                            <div class="line"></div>\n                            ${h?`<div class="text">${h}</div>`:""}\n                        </div>`}i[o]=n})),0===s&&e.msgNoItems){var o=d.active[e.name.replace(/[\s\.#]/g,"_")]?.tmp.remote;let t=e.msgNoItems;e.url&&(t=0==s&&!1===o?.hasMore?e.msgNoItems:e.msgSearch),r+=`\n                <div class="w2ui-no-items">\n                    ${a.lang(t)}\n                </div>`}return r+="</div>"}openSubMenu(e){var t=l(e.originalEvent.target).get(0);let i=e.overlay;var s;let n=[];"function"==typeof(s=(s=i.options.items)[e.index]).items?n=s.items(s):Array.isArray(s.items)&&(n=s.items),(s=c.get(i.name+"-submenu"))&&s.hide(),l(e.target).addClass("expanded"),c.show({name:i.name+"-submenu",anchor:t,items:n,class:i.options.class,offsetX:-7,arrowSize:0,parentOverlay:i,parents:[...e.parents,e.index],position:"right|left",hideOn:["doc-click"]}).hide((t=>{l(e.target).removeClass("expanded")})).select((e=>{var t=e.detail.overlay.options.parents;let s=i;for(;s.options.parentOverlay;)s=s.options.parentOverlay;this.menuClick(s,e.detail.originalEvent,parseInt(e.detail.index),t)})),setTimeout((()=>{l("#w2overlay-"+i.name+"-submenu").on("mouseenter",(e=>{e.target._keepSubOpen=!0})).on("mouseleave",(e=>{e.target._keepSubOpen=!1}))}),10)}closeSubMenu(e){var t=e.overlay;!0!==e.target._keepSubOpen&&(e=c.get(t.name+"-submenu"))&&e.hide()}refreshIndex(e,t){var i,s;(e=d.active[e.replace(/[\s\.#]/g,"_")])&&(e.displayed||this.show(e.name),i=l(e.box).find(".w2ui-overlay-body").get(0),s=l(e.box).find(".w2ui-menu-search, .w2ui-menu-top").get(0),l(e.box).find(".w2ui-menu-item.w2ui-selected").removeClass("w2ui-selected"),e=l(e.box).find(`.w2ui-menu-item[index="${e.selected}"]`).addClass("w2ui-selected").get(0))&&(e.offsetTop+e.clientHeight>i.clientHeight+i.scrollTop&&e.scrollIntoView({behavior:t?"instant":"smooth",block:t?"center":"start",inline:t?"center":"start"}),e.offsetTop<i.scrollTop+(s?s.clientHeight:0))&&e.scrollIntoView({behavior:t?"instant":"smooth",block:t?"center":"end",inline:t?"center":"end"})}refreshSearch(e){let t=d.active[e.replace(/[\s\.#]/g,"_")];t&&(t.displayed||this.show(t.name),l(t.box).find(".w2ui-no-items").hide(),l(t.box).find(".w2ui-menu-item, .w2ui-menu-divider").each((i=>{var s;this.getCurrent(e,i.getAttribute("index")).item?.hidden?l(i).hide():(s=t.tmp?.search,t.options.markSearch&&a.marker(i,s,{onlyFirst:"begins"==t.options.match}),l(i).show())})),l(t.box).find(".w2ui-sub-menu").each((t=>{var i=l(t).find(".w2ui-menu-item").get().some((e=>"none"!=e.style.display));this.getCurrent(e,t.dataset.parent).item.expanded&&(i?l(t).parent().show():l(t).parent().hide())})),0!=t.tmp.searchCount&&0!=t.options?.items?.length||(0==l(t.box).find(".w2ui-no-items").length&&l(t.box).find(".w2ui-menu:not(.w2ui-sub-menu)").append(`\n                    <div class="w2ui-no-items">\n                        ${a.lang(t.options.msgNoItems)}\n                    </div>`),l(t.box).find(".w2ui-no-items").show()))}applyFilter(e,t,i,s){let n=0;var r=d.active[e.replace(/[\s\.#]/g,"_")];let o,h,c=r.options;var u=new Promise(((e,t)=>{o=e,h=t}));null==i&&(i=["INPUT","TEXTAREA"].includes(r.anchor.tagName)?r.anchor.value:"");let p=[];c.selected&&(Array.isArray(c.selected)?p=c.selected.map((e=>e?.id??e)):c.selected?.id&&(p=[c.selected.id])),r.tmp.activeChain=null;var m,g=r.tmp.remote??{hasMore:!0,emptySet:!1,search:null,cached:-1};if(0==g.hasMore&&(m=g.hasMore_search.length,i.substr(0,m)!=g.hasMore_search)&&(g.hasMore=!0),null==t&&c.url&&g.hasMore&&g.search!==i){let t=!0,n=a.lang("Loading...");i.length<c.minLength&&!0!==g.emptySet&&(n=a.lang("${count} letters or more...",{count:c.minLength}),t=!1,""===i&&(n=a.lang(c.msgSearch)),0<c.items?.length)&&(this.update(e,[]),this.applyFilter(e,null,i)),l(r.box).find(".w2ui-no-items").html(n),g.search=i,c.items=[],r.tmp.remote=g,t&&this.request(r,i,s).then((t=>{this.update(e,t),this.applyFilter(e,null,i).then((e=>{o(e)}))})).catch((e=>{console.log("Server Request error",e)}))}else{let s;null==t&&!0===(s=this.trigger("search",{search:i,overlay:r,prom:u,resolve:o,reject:h})).isCancelled||(null==t&&(t=r.options.items),!1===c.filter?o({count:-1,search:i}):(t.forEach((t=>{let s="",l="";-1!==["is","begins","begins with"].indexOf(c.match)&&(s="^"),-1!==["is","ends","ends with"].indexOf(c.match)&&(l="$");try{new RegExp(s+i+l,"i").test(t.text)||"..."===t.text?t.hidden=!1:t.hidden=!0}catch(s){}c.hideSelected&&p.includes(t.id)&&(t.hidden=!0),Array.isArray(t.items)&&0<t.items.length&&(delete t._noSearchInside,this.applyFilter(e,t.items,i).then((e=>{0<(e=e.count)&&(n+=e,t.hidden&&(t._noSearchInside=!0),i&&(t.expanded=!0),t.hidden=!1)}))),!0!==t.hidden&&n++})),o({count:n,search:i}),s?.finish()))}return u}request(e,t,i){let s,l,n=e.options,r=e.tmp.remote;return(0===n.items.length&&0!==r.cached||r.cached==n.cacheMax&&t.length>r.search.length||t.length>=r.search.length&&t.substr(0,r.search.length)!==r.search||t.length<r.search.length)&&(r.controller&&r.controller.abort(),r.loading=!0,clearTimeout(r.timeout),r.timeout=setTimeout((()=>{var i=n.url;let o={search:t,max:n.cacheMax};Object.assign(o,n.postData);var d,h=this.trigger("request",{search:t,overlay:e,url:i,postData:o,httpMethod:n.method??"GET",httpHeaders:{}});!0!==h.isCancelled&&(i=new URL(h.detail.url,location),d=a.prepareParams(i,{method:h.detail.httpMethod,headers:h.detail.httpHeaders,body:h.detail.postData}),r.controller=new AbortController,d.signal=r.controller.signal,fetch(i,d).then((e=>e.json())).then((i=>{r.controller=null;var l=e.trigger("load",{search:o.search,overlay:e,data:i});!0!==l.isCancelled&&("string"==typeof(i=l.detail.data)&&(i=JSON.parse(i)),null==(i=Array.isArray(i)?{records:i}:i).records&&null!=i.items&&(i.records=i.items,delete i.items),i.error||null!=i.records||(i.records=[]),Array.isArray(i.records)?(i.records.length>=n.cacheMax?(i.records.splice(n.cacheMax,i.records.length),r.hasMore=!0):(r.hasMore=!1,r.hasMore_search=t),null==n.recId&&null!=n.recid&&(n.recId=n.recid),(n.recId||n.recText)&&i.records.forEach((e=>{"string"==typeof n.recId&&(e.id=e[n.recId]),"function"==typeof n.recId&&(e.id=n.recId(e)),"string"==typeof n.recText&&(e.text=e[n.recText]),"function"==typeof n.recText&&(e.text=n.recText(e))})),r.loading=!1,r.search=t,r.cached=0==i.records.length?-1:i.records.length,r.lastError="",r.emptySet=""===t&&0===i.records.length,l.finish(),s(a.normMenu(i.records))):console.error("ERROR: server did not return proper data structure","\n"," - it should return",{records:[{id:1,text:"item"}]},"\n"," - or just an array ",[{id:1,text:"item"}],"\n"," - or if errorr ",{error:!0,message:"error message"}))})).catch((i=>{var s=this.trigger("error",{overlay:e,search:t,error:i});!0!==s.isCancelled&&("AbortError"!==i?.name&&console.error("ERROR: Server communication failed.","\n"," - it should return",{records:[{id:1,text:"item"}]},"\n"," - or just an array ",[{id:1,text:"item"}],"\n"," - or if errorr ",{error:!0,message:"error message"}),r.loading=!1,r.search="",r.cached=-1,r.emptySet=!0,r.lastError=s.detail.error||"Server communication failed",n.items=[],s.finish(),l())})),h.finish())}),i?n.debounce??350:0)),new Promise(((e,t)=>{s=e,l=t}))}getActiveChain(e,t,i=[],s=[],l){var n=d.active[e.replace(/[\s\.#]/g,"_")];return null!=n.tmp.activeChain?n.tmp.activeChain:((t=null==t?n.options.items:t).forEach(((t,l)=>{t.hidden||t.disabled||t?.text?.startsWith("--")||(s.push(i.concat([l]).join("-")),Array.isArray(t.items)&&0<t.items.length&&t.expanded&&(i.push(l),this.getActiveChain(e,t.items,i,s,!0),i.pop()))})),null==l&&(n.tmp.activeChain=s),s)}menuDown(e,t,i,s){var n=e.options;let a=n.items;var r=l(t.delegate).find(".w2ui-icon");let o=l(t.target).closest(".w2ui-menu:not(.w2ui-sub-menu)"),d=("string"==typeof s&&""!==s&&s.split("-").forEach((e=>{a=a[e].items})),(a="function"==typeof a?a({overlay:e,index:i,parents:s,event:t}):a)[i]);if(null!=d&&!d.disabled){let e=(t,i)=>{t.forEach(((s,l)=>{s.id!=d.id&&(s.group===d.group&&s.checked&&(o.find(`.w2ui-menu-item[index="${(i?i+"-":"")+l}"] .w2ui-icon`).removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),t[l].checked=!1),Array.isArray(s.items))&&e(s.items,l)}))};"check"!==n.type&&"radio"!==n.type||!1===d.group||l(t.target).hasClass("menu-remove")||l(t.target).hasClass("menu-help")||l(t.target).closest(".w2ui-menu-item").hasClass("has-sub-menu")||(d.checked="radio"==n.type||!d.checked,d.checked?("radio"===n.type&&l(t.target).closest(".w2ui-menu").find(".w2ui-icon").removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),"check"===n.type&&null!=d.group&&e(n.items),r.removeClass("w2ui-icon-empty").addClass("w2ui-icon-check")):"check"===n.type&&r.removeClass("w2ui-icon-check").addClass("w2ui-icon-empty")),l(t.target).hasClass("menu-remove")||l(t.target).hasClass("menu-help")||(o.find(".w2ui-menu-item").removeClass("w2ui-selected"),l(t.delegate).hasClass("has-sub-menu"))||l(t.delegate).addClass("w2ui-selected")}}menuClick(e,t,i,s){var n=e.options;let a=n.items;var r=l(t.delegate).closest(".w2ui-menu-item");let o=!n.hideOn.includes("select");(t.shiftKey||t.metaKey||t.ctrlKey)&&(o=!0),"string"==typeof s&&""!==s?s=s.split("-"):Array.isArray(s)||(s=null),s&&s.forEach((e=>{a=a[e].items}));var d=(a="function"==typeof a?a({overlay:e,index:i,parents:s,event:t}):a)[i];if(d&&(!d.disabled||l(t.target).hasClass("menu-remove"))){let a;if(l(t.target).hasClass("menu-remove")){if(!0===(a=this.trigger("remove",{originalEvent:t,target:e.name,overlay:e,item:d,index:i,parents:s,el:r[0]})).isCancelled)return;o=!n.hideOn.includes("item-remove"),r.remove()}else if(r.hasClass("has-sub-menu")){if(!0===(a=this.trigger("subMenu",{originalEvent:t,target:e.name,overlay:e,item:d,index:i,parents:s,el:r[0]})).isCancelled)return;o=!0}else{if(n=this.findChecked(n.items),e.selected=parseInt(r.attr("index")),!0===(a=this.trigger("select",{originalEvent:t,target:e.name,overlay:e,item:d,index:i,parents:s,selected:n,keepOpen:o,el:r[0]})).isCancelled)return;null!=d.keepOpen&&(o=d.keepOpen),["INPUT","TEXTAREA"].includes(e.anchor.tagName)&&(e.anchor.dataset.selected=d.id,e.anchor.dataset.selectedIndex=e.selected)}o||this.hide(e.name),a.finish()}}findChecked(e){let t=[];return e.forEach((e=>{e.checked&&t.push(e),Array.isArray(e.items)&&(t=t.concat(this.findChecked(e.items)))})),t}keyUp(e,t){var i=e.options,s=t.target.value;let n=!0,a=!1;switch(t.keyCode){case 46:case 8:""!==s||e.displayed||(n=!1);break;case 13:if(!e.displayed||!e.selected)return;var{index:r,parents:o}=this.getCurrent(e.name);t.delegate=l(e.box).find(".w2ui-selected").get(0),this.menuClick(e,t,parseInt(r),o),n=!1;break;case 27:n=!1,e.displayed?this.hide(e.name):(r=e.anchor,["INPUT","TEXTAREA"].includes(r.tagName)&&(r.value="",delete r.dataset.selected,delete r.dataset.selectedIndex));break;case 37:{if(!e.displayed)return;let{item:s,index:r,parents:o}=this.getCurrent(e.name);o&&(s=i.items[o],r=parseInt(o),o="",a=!0),Array.isArray(s?.items)&&0<s.items.length&&s.expanded&&(t.delegate=l(e.box).find(`.w2ui-menu-item[index="${r}"]`).get(0),e.selected=r,this.menuClick(e,t,parseInt(r),o)),n=!1;break}case 39:if(!e.displayed)return;var{item:o,index:r,parents:d}=this.getCurrent(e.name);Array.isArray(o?.items)&&0<o.items.length&&!o.expanded&&(t.delegate=l(e.box).find(".w2ui-selected").get(0),this.menuClick(e,t,parseInt(r),d)),n=!1;break;case 38:e.displayed&&(e.prev(),n=!1,t.preventDefault());break;case 40:e.displayed&&(e.next(),n=!1,t.preventDefault())}n&&e.displayed&&(i.filter&&"filter"==t._searchType||i.search&&"search"==t._searchType)&&this.applyFilter(e.name,null,s,!0).then((t=>{e.tmp.searchCount=t.count,e.tmp.search=t.search,0!==t.count&&this.getActiveChain(e.name).includes(e.selected)||(e.selected=null),this.refreshSearch(e.name)})),a&&this.refreshIndex(e.name)}},u=new class extends d{constructor(){super(),this.palette=[["000000","333333","555555","777777","888888","999999","AAAAAA","CCCCCC","DDDDDD","EEEEEE","F7F7F7","FFFFFF"],["FF011B","FF9838","FFC300","FFFD59","86FF14","14FF7A","2EFFFC","2693FF","006CE7","9B24F4","FF21F5","FF0099"],["FFEAEA","FCEFE1","FCF4DC","FFFECF","EBFFD9","D9FFE9","E0FFFF","E8F4FF","ECF4FC","EAE6F4","FFF5FE","FCF0F7"],["F4CCCC","FCE5CD","FFF1C2","FFFDA1","D5FCB1","B5F7D0","BFFFFF","D6ECFF","CFE2F3","D9D1E9","FFE3FD","FFD9F0"],["EA9899","F9CB9C","FFE48C","F7F56F","B9F77E","84F0B1","83F7F7","B5DAFF","9FC5E8","B4A7D6","FAB9F6","FFADDE"],["E06666","F6B26B","DEB737","E0DE51","8FDB48","52D189","4EDEDB","76ACE3","6FA8DC","8E7CC3","E07EDA","F26DBD"],["CC0814","E69138","AB8816","B5B20E","6BAB30","27A85F","1BA8A6","3C81C7","3D85C6","674EA7","A14F9D","BF4990"],["99050C","B45F17","80650E","737103","395E14","10783D","13615E","094785","0A5394","351C75","780172","782C5A"]],this.defaults=a.extend({},this.defaults,{advanced:!1,transparent:!0,position:"top|bottom",class:"w2ui-white",color:"",updateInput:!0,arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null,onLiveUpdate:null})}attach(e,t){let i;1==arguments.length&&e instanceof Object?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e),t=i.hideOn,i=a.extend({},this.defaults,i||{}),t&&(i.hideOn=t),i.style+="; padding: 0;",i.transparent&&"333333"==this.palette[0][1]&&(this.palette[0].splice(1,1),this.palette[0].push("TRANSPARENT")),i.transparent||"333333"==this.palette[0][1]||(this.palette[0].splice(1,0,"333333"),this.palette[0].pop()),i.color&&(i.color=String(i.color).toUpperCase()),"string"==typeof i.color&&"#"===i.color.substr(0,1)&&(i.color=i.color.substr(1)),this.index=[-1,-1];let s=super.attach(i),n=s.overlay;return n.options.html=this.getColorHTML(n.name,i),n.on("show.attach",(e=>{var t=(e=e.detail.overlay).anchor,i=e.options;["INPUT","TEXTAREA"].includes(t.tagName)&&!i.color&&t.value&&(e.tmp.initColor=t.value),delete e.newColor})),n.on("show:after.attach",(e=>{var t;s.overlay?.box&&(t=l(s.overlay.box).find(".w2ui-eaction"),a.bindEvents(t,this),this.initControls(s.overlay))})),n.on("update:after.attach",(e=>{var t;s.overlay?.box&&(t=l(s.overlay.box).find(".w2ui-eaction"),a.bindEvents(t,this),this.initControls(s.overlay))})),n.on("hide.attach",(e=>{var t=(e=e.detail.overlay).anchor,i=e.newColor??e.options.color??"";""!==i&&(["INPUT","TEXTAREA"].includes(t.tagName)&&t.value!=i&&e.options.updateInput&&(t.value=i),!0!==(t=this.trigger("select",{color:i,target:e.name,overlay:e})).isCancelled)&&t.finish()})),s.liveUpdate=e=>(n.on("liveUpdate.attach",(t=>{e(t)})),s),s.select=e=>(n.on("select.attach",(t=>{e(t)})),s),s}select(e,t){let i;this.index=[-1,-1],"string"!=typeof t&&(i=t.target,this.index=l(i).attr("index").split(":"),t=l(i).closest(".w2ui-overlay").attr("name"));var s=this.get(t);!0!==(t=this.trigger("liveUpdate",{color:e,target:t,overlay:s,param:arguments[1]})).isCancelled&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&s.options.updateInput&&l(s.anchor).val(e),s.newColor=e,l(s.box).find(".w2ui-color.w2ui-selected").removeClass("w2ui-selected"),i&&l(i).addClass("w2ui-selected"),t.finish())}nextColor(e){var t=this.palette;switch(e){case"up":this.index[0]--;break;case"down":this.index[0]++;break;case"right":this.index[1]++;break;case"left":this.index[1]--}return this.index[0]<0&&(this.index[0]=0),this.index[0]>t.length-2&&(this.index[0]=t.length-2),this.index[1]<0&&(this.index[1]=0),this.index[1]>t[0].length-1&&(this.index[1]=t[0].length-1),t[this.index[0]][this.index[1]]}tabClick(e,t){"string"!=typeof t&&(t=l(t.target).closest(".w2ui-overlay").attr("name")),t=this.get(t);var i=l(t.box).find(`.w2ui-color-tab:nth-child(${e})`);l(t.box).find(".w2ui-color-tab").removeClass("w2ui-selected"),l(i).addClass("w2ui-selected"),l(t.box).find(".w2ui-tab-content").hide().closest(".w2ui-colors").find(".tab-"+e).show()}getColorHTML(e,t){let i='\n            <div class="w2ui-colors">\n                <div class="w2ui-tab-content tab-1">';for(let l=0;l<this.palette.length;l++){i+='<div class="w2ui-color-row">';for(let n=0;n<this.palette[l].length;n++){var s=this.palette[l][n];let a="FFFFFF"===s?"; border: 1px solid #efefef":"";i+=`\n                    <div class="w2ui-color w2ui-eaction ${"TRANSPARENT"===s?"w2ui-no-color":""} ${t.color==s?"w2ui-selected":""}"\n                        style="background-color: #${s+a};" name="${s}" index="${l}:${n}"\n                        data-mousedown="select|'${s}'|event" data-mouseup="hide|${e}">&nbsp;\n                    </div>`}i+="</div>",l<2&&(i+='<div style="height: 8px"></div>')}return(i=(i+="</div>")+`\n            <div class="w2ui-tab-content tab-2" style="display: none">\n                <div class="color-info">\n                    <div class="color-preview-bg"><div class="color-preview"></div><div class="color-original"></div></div>\n                    <div class="color-part">\n                        <span>H</span> <input class="w2ui-input" name="h" maxlength="3" max="360" tabindex="101">\n                        <span>R</span> <input class="w2ui-input" name="r" maxlength="3" max="255" tabindex="104">\n                    </div>\n                    <div class="color-part">\n                        <span>S</span> <input class="w2ui-input" name="s" maxlength="3" max="100" tabindex="102">\n                        <span>G</span> <input class="w2ui-input" name="g" maxlength="3" max="255" tabindex="105">\n                    </div>\n                    <div class="color-part">\n                        <span>V</span> <input class="w2ui-input" name="v" maxlength="3" max="100" tabindex="103">\n                        <span>B</span> <input class="w2ui-input" name="b" maxlength="3" max="255" tabindex="106">\n                    </div>\n                    <div class="color-part opacity">\n                        <span>${a.lang("Opacity")}</span>\n                        <input class="w2ui-input" name="a" maxlength="5" max="1" tabindex="107">\n                    </div>\n                </div>\n                <div class="palette" name="palette">\n                    <div class="palette-bg"></div>\n                    <div class="value1 move-x move-y"></div>\n                </div>\n                <div class="rainbow" name="rainbow">\n                    <div class="value2 move-x"></div>\n                </div>\n                <div class="alpha" name="alpha">\n                    <div class="alpha-bg"></div>\n                    <div class="value2 move-x"></div>\n                </div>\n            </div>`)+`\n            <div class="w2ui-color-tabs">\n                <div class="w2ui-color-tab w2ui-selected w2ui-eaction" data-click="tabClick|1|event|this"><span class="w2ui-icon w2ui-icon-colors"></span></div>\n                <div class="w2ui-color-tab w2ui-eaction" data-click="tabClick|2|event|this"><span class="w2ui-icon w2ui-icon-settings"></span></div>\n                <div style="padding: 5px; width: 100%; text-align: right;">\n                    ${"string"==typeof t.html?t.html:""}\n                </div>\n            </div>`}initControls(e){let t,i=this;var s=e.options,n=s.color||e.tmp.initColor;let r=a.parseColor(n),o=(null==r&&(r={r:140,g:150,b:160,a:1}),a.rgb2hsv(r));!0===s.advanced&&this.tabClick(2,e.name),c(o,!0,n??""),l(e.box).off(".w2color").on("contextmenu.w2color",(e=>{e.preventDefault()})).find("input").off(".w2color").on("change.w2color",(e=>{e=l(e.target);let t=parseFloat(e.val());var i=parseFloat(e.attr("max"));isNaN(t)&&(t=0,e.val(0)),1<i&&(t=parseInt(t)),0<i&&t>i&&(e.val(i),t=i),t<0&&(e.val(0),t=0),i=e.attr("name"),e={},-1!==["r","g","b","a"].indexOf(i)?(r[i]=t,o=a.rgb2hsv(r)):-1!==["h","s","v"].indexOf(i)&&(e[i]=t),c(e,!0)})),l(e.box).find(".color-original").off(".w2color").on("click.w2color",(e=>{null!=(e=a.parseColor(l(e.target).css("background-color")))&&(r=e,c(o=a.rgb2hsv(r),!0))})),s=(a.isMobile?"touchstart":"mousedown")+".w2color";let d=(a.isMobile?"touchend":"mouseup")+".w2color",h=(a.isMobile?"touchmove":"mousemove")+".w2color";function c(t,s,n){null!=t.h&&(o.h=t.h),null!=t.s&&(o.s=t.s),null!=t.v&&(o.v=t.v),null!=t.a&&(r.a=t.a,o.a=t.a);let d="rgba("+(r=a.hsv2rgb(o)).r+","+r.g+","+r.b+","+r.a+")",h=[Number(r.r).toString(16).toUpperCase(),Number(r.g).toString(16).toUpperCase(),Number(r.b).toString(16).toUpperCase(),Math.round(255*Number(r.a)).toString(16).toUpperCase()];var c,p;h.forEach(((e,t)=>{1===e.length&&(h[t]="0"+e)})),d=h[0]+h[1]+h[2]+h[3],1===r.a&&(d=h[0]+h[1]+h[2]),l(e.box).find(".color-preview").css("background-color","#"+d),l(e.box).find("input").each((e=>{e.name&&(null!=r[e.name]&&(e.value=r[e.name]),null!=o[e.name]&&(e.value=o[e.name]),"a"===e.name)&&(e.value=r.a)})),null!=n?(t=e.tmp.initColor||d,l(e.box).find(".color-original").css("background-color","#"+t),l(e.box).find(".w2ui-color.w2ui-selected").removeClass("w2ui-selected"),l(e.box).find(`.w2ui-colors [name="${t}"], .w2ui-colors [name="${n}"]`).addClass("w2ui-selected"),8==d.length&&i.tabClick(2,e.name)):i.select(d,e.name),s&&(t=l(e.box).find(".palette .value1"),n=l(e.box).find(".rainbow .value2"),s=l(e.box).find(".alpha .value2"),t[0]&&n[0]&&s[0]&&(c=parseInt(t[0].clientWidth)/2,p=parseInt(n[0].clientWidth)/2,t.css({left:150*o.s/100-c+"px",top:125*(100-o.v)/100-c+"px"}),n.css("left",o.h/2.4-p+"px"),s.css("left",150*r.a-p+"px")),u())}function u(){var t=`${(t=a.hsv2rgb(o.h,100,100)).r},${t.g},`+t.b;l(e.box).find(".palette").css("background-image",`linear-gradient(90deg, rgba(${t},0) 0%, rgba(${t},1) 100%)`)}function p(e){l("html").off(".w2color")}function m(e){var i=t.el,s=e.pageX-t.x;e=e.pageY-t.y;let n=t.left+s,a=t.top+e;n<-(s=parseInt(i.prop("clientWidth"))/2)&&(n=-s),a<-s&&(a=-s),n>t.width-s&&(n=t.width-s),a>t.height-s&&(a=t.height-s),i.hasClass("move-x")&&i.css({left:n+"px"}),i.hasClass("move-y")&&i.css({top:a+"px"}),e=l(i.get(0).parentNode).attr("name");var r=parseInt(i.css("left"))+s;i=parseInt(i.css("top"))+s,"palette"===e&&c({s:Math.round(r/t.width*100),v:Math.round(100-i/t.height*100)}),"rainbow"===e&&(c({h:Math.round(2.4*r)}),u()),"alpha"===e&&c({a:parseFloat(Number(r/150).toFixed(2))})}l(e.box).find(".palette, .rainbow, .alpha").off(".w2color").on(s+".w2color",(function(e){var i=l(this).find(".value1, .value2"),s=parseInt(i.prop("clientWidth"))/2;i.hasClass("move-x")&&i.css({left:e.offsetX-s+"px"}),i.hasClass("move-y")&&i.css({top:e.offsetY-s+"px"}),t={el:i,x:e.pageX,y:e.pageY,width:i.prop("parentNode").clientWidth,height:i.prop("parentNode").clientHeight,left:parseInt(i.css("left")),top:parseInt(i.css("top"))},m(e),l("html").off(".w2color").on(h,m).on(d,p)}))}},p=new class extends d{constructor(){super();var e=new Date;this.daysCount=[31,28,31,30,31,30,31,31,30,31,30,31],this.today=e.getFullYear()+"/"+(Number(e.getMonth())+1)+"/"+e.getDate(),this.defaults=a.extend({},this.defaults,{position:"top|bottom",class:"w2ui-calendar",type:"date",value:"",format:"",start:null,end:null,btnNow:!1,blockDates:[],blockWeekdays:[],colored:{},arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null})}attach(e,t){let i;1==arguments.length&&e instanceof Object?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e),t=i.hideOn,i=a.extend({},this.defaults,i||{}),t&&(i.hideOn=t),i.format||(e=a.settings.dateFormat,t=a.settings.timeFormat,"date"==i.type?i.format=e:"time"==i.type?i.format=t:i.format=e+"|"+t),e="time"==i.type?this.getHourHTML(i):this.getMonthHTML(i),i.style+="; padding: 0;",i.html=e.html;let s=super.attach(i),l=s.overlay;return Object.assign(l.tmp,e),l.on("show.attach",(e=>{var t=(e=e.detail.overlay).anchor,i=e.options;["INPUT","TEXTAREA"].includes(t.tagName)&&!i.value&&t.value&&(e.tmp.initValue=t.value),delete e.newValue,delete e.newDate})),l.on("show:after.attach",(e=>{s.overlay?.box&&this.initControls(s.overlay)})),l.on("update:after.attach",(e=>{s.overlay?.box&&this.initControls(s.overlay)})),l.on("hide.attach",(e=>{var t=(e=e.detail.overlay).anchor;null!=e.newValue&&(e.newDate&&(e.newValue=e.newDate+" "+e.newValue),["INPUT","TEXTAREA"].includes(t.tagName)&&t.value!=e.newValue&&(t.value=e.newValue),!0!==(t=this.trigger("select",{date:e.newValue,target:e.name,overlay:e})).isCancelled)&&t.finish()})),s.select=e=>(l.on("select.attach",(t=>{e(t)})),s),s}initControls(e){let t=e.options,i=i=>{let{month:s,year:n}=e.tmp;12<(s+=i)&&(s=1,n++),s<1&&(s=12,n--),i=this.getMonthHTML(t,s,n),Object.assign(e.tmp,i),l(e.box).find(".w2ui-overlay-body").html(i.html),this.initControls(e)},s=(i,s)=>{l(i.target).parent().find(".w2ui-jump-month, .w2ui-jump-year").removeClass("w2ui-selected"),l(i.target).addClass("w2ui-selected"),i=new Date;let{jumpMonth:n,jumpYear:a}=e.tmp;(n=s&&(null==a&&(a=i.getFullYear()),null==n)?i.getMonth()+1:n)&&a&&(s=this.getMonthHTML(t,n,a),Object.assign(e.tmp,s),l(e.box).find(".w2ui-overlay-body").html(s.html),e.tmp.jump=!1,this.initControls(e))};l(e.box).find(".w2ui-cal-title").off(".calendar").on("click.calendar",(i=>{var s,n;Object.assign(e.tmp,{jumpYear:null,jumpMonth:null}),e.tmp.jump?(({month:s,year:n}=e.tmp),s=this.getMonthHTML(t,s,n),l(e.box).find(".w2ui-overlay-body").html(s.html),e.tmp.jump=!1):(l(e.box).find(".w2ui-overlay-body .w2ui-cal-days").replace(this.getYearHTML()),(n=l(e.box).find(`[name="${e.tmp.year}"]`).get(0))&&n.scrollIntoView(!0),e.tmp.jump=!0),this.initControls(e),i.stopPropagation()})).find(".w2ui-cal-previous").off(".calendar").on("click.calendar",(e=>{i(-1),e.stopPropagation()})).parent().find(".w2ui-cal-next").off(".calendar").on("click.calendar",(e=>{i(1),e.stopPropagation()})),l(e.box).find(".w2ui-cal-now").off(".calendar").on("click.calendar",(i=>{"datetime"==t.type?e.newDate?e.newValue=a.formatTime(new Date,t.format.split("|")[1]):e.newValue=a.formatDateTime(new Date,t.format):"date"==t.type?e.newValue=a.formatDate(new Date,t.format):"time"==t.type&&(e.newValue=a.formatTime(new Date,t.format)),this.hide(e.name)})),l(e.box).off(".calendar").on("contextmenu.calendar",(e=>{e.preventDefault()})).on("click.calendar",{delegate:".w2ui-day.w2ui-date"},(i=>{"datetime"==t.type?(e.newDate=l(i.target).attr("date"),l(e.box).find(".w2ui-overlay-body").html(this.getHourHTML(e.options).html),this.initControls(e)):(e.newValue=l(i.target).attr("date"),this.hide(e.name))})).on("click.calendar",{delegate:".w2ui-jump-month"},(t=>{e.tmp.jumpMonth=parseInt(l(t.target).attr("name")),s(t)})).on("dblclick.calendar",{delegate:".w2ui-jump-month"},(t=>{e.tmp.jumpMonth=parseInt(l(t.target).attr("name")),s(t,!0)})).on("click.calendar",{delegate:".w2ui-jump-year"},(t=>{e.tmp.jumpYear=parseInt(l(t.target).attr("name")),s(t)})).on("dblclick.calendar",{delegate:".w2ui-jump-year"},(t=>{e.tmp.jumpYear=parseInt(l(t.target).attr("name")),s(t,!0)})).on("click.calendar",{delegate:".w2ui-time.hour"},(i=>{i=l(i.target).attr("hour");let s=this.str2min(t.value)%60;e.tmp.initValue&&!t.value&&(s=this.str2min(e.tmp.initValue)%60),t.noMinutes?(e.newValue=this.min2str(60*i,t.format),this.hide(e.name)):(e.newValue=i+":"+s,i=this.getMinHTML(i,t).html,l(e.box).find(".w2ui-overlay-body").html(i),this.initControls(e))})).on("click.calendar",{delegate:".w2ui-time.min"},(i=>{i=60*Math.floor(this.str2min(e.newValue)/60)+parseInt(l(i.target).attr("min")),e.newValue=this.min2str(i,t.format),this.hide(e.name)}))}getMonthHTML(e,t,i){var s=a.settings.fulldays.slice(),l=a.settings.shortdays.slice();"M"!==a.settings.weekStarts&&(s.unshift(s.pop()),l.unshift(l.pop()));let n=new Date;s="datetime"===e.type?a.isDateTime(e.value,e.format,!0):a.isDate(e.value,e.format,!0);var r=a.formatDate(s);null!=t&&null!=i||(i=(s||n).getFullYear(),t=s?s.getMonth()+1:n.getMonth()+1),12<t&&(t-=12,i++),(t<1||0===t)&&(t+=12,i--),i/4==Math.floor(i/4)?this.daysCount[1]=29:this.daysCount[1]=28,e.current=t+"/"+i;let o=(n=new Date(i,t-1,1)).getDay(),d="";var h=a.settings.weekStarts;for(let e=0;e<l.length;e++)d+=`<div class="w2ui-day w2ui-weekday ${"M"==h&&5==e||"M"!=h&&6==e?"w2ui-sunday":""} ${"M"==h&&6==e||"M"!=h&&0==e?"w2ui-saturday":""}">${l[e]}</div>`;let c=`\n            <div class="w2ui-cal-title">\n                <div class="w2ui-cal-previous">\n                    <div></div>\n                </div>\n                <div class="w2ui-cal-next">\n                    <div></div>\n                </div>\n                ${a.settings.fullmonths[t-1]}, ${i}\n                <span class="arrow-down"></span>\n            </div>\n            <div class="w2ui-cal-days">\n                ${d}\n        `,u=new Date(i+`/${t}/1`);s=(u=new Date(u.getTime()+432e5)).getDay(),"M"==a.settings.weekStarts&&o--;let p=6,m=0;0<s?u=new Date(u.getTime()-864e5*o):(p+=o,m+=o,p<0&&(p=6+p+1),m<0&&(m=6+m+1));for(let i=0;i<42;i++){var g=[],f=`${u.getFullYear()}/${u.getMonth()+1}/`+u.getDate(),b=(u.getDay()===p&&g.push("w2ui-saturday"),u.getDay()===m&&g.push("w2ui-sunday"),u.getMonth()+1!==t&&g.push("outside"),f==this.today&&g.push("w2ui-today"),u.getDate());let i,s,l="",n="";s="datetime"===e.type?(i=a.formatDateTime(f,e.format),a.formatDate(f,a.settings.dateFormat)):i=a.formatDate(f,e.format),e.colored&&void 0!==e.colored[s]&&(n="background-color: "+(f=e.colored[s].split("|"))[0]+";",l="color: "+f[1]+";"),c+=`<div class="w2ui-day ${this.inRange(i,e,!0)?"w2ui-date "+(s==r?"w2ui-selected":""):"w2ui-blocked"} ${g.join(" ")}"\n                       style="${l+n}" date="${s}" data-date="${u.getTime()}">\n                            ${b}\n                    </div>`,u=new Date(u.getTime()+864e5)}return c+="</div>",e.btnNow&&(c+=`<div class="w2ui-cal-now">${s=a.lang("Today"+("datetime"==e.type?" & Now":""))}</div>`),{html:c,month:t,year:i}}getYearHTML(){let e="",t="";for(let t=0;t<a.settings.fullmonths.length;t++)e+=`<div class="w2ui-jump-month" name="${t+1}">${a.settings.shortmonths[t]}</div>`;for(let e=a.settings.dateStartYear;e<=a.settings.dateEndYear;e++)t+=`<div class="w2ui-jump-year" name="${e}">${e}</div>`;return`<div class="w2ui-cal-jump">\n            <div id="w2ui-jump-month">${e}</div>\n            <div id="w2ui-jump-year">${t}</div>\n        </div>`}getHourHTML(e){(e=e??{}).format||(e.format=a.settings.timeFormat);var t=-1<e.format.indexOf("h24"),i=e.value||(e.anchor?e.anchor.value:""),s=[];for(let r=0;r<24;r++){let o=(12<=r&&!t?r-12:r)+":00"+(t?"":r<12?" am":" pm"),d=(12!=r||t||(o="12:00 pm"),s[Math.floor(r/8)]||(s[Math.floor(r/8)]=""),this.min2str(this.str2min(o))),h=this.min2str(this.str2min(o)+59);"datetime"===e.type&&(n=a.isDateTime(i,e.format,!0),l=e.format.split("|")[0].trim(),d=a.formatDate(n,l)+" "+d,h=a.formatDate(n,l)+" "+h);var l,n=this.inRange(d,e)||this.inRange(h,e);s[Math.floor(r/8)]+=`<span hour="${r}"\n                class="hour ${n?"w2ui-time ":"w2ui-blocked"}">${o}</span>`}return{html:`<div class="w2ui-calendar">\n            <div class="w2ui-time-title">${a.lang("Select Hour")}</div>\n            <div class="w2ui-cal-time">\n                <div class="w2ui-cal-column">${s[0]}</div>\n                <div class="w2ui-cal-column">${s[1]}</div>\n                <div class="w2ui-cal-column">${s[2]}</div>\n            </div>\n            ${e.btnNow?`<div class="w2ui-cal-now">${a.lang("Now")}</div>`:""}\n        </div>`}}getMinHTML(e,t){null==e&&(e=0),(t=t??{}).format||(t.format=a.settings.timeFormat);var i=-1<t.format.indexOf("h24"),s=t.value||(t.anchor?t.anchor.value:""),l=[];for(let h=0;h<60;h+=5){var n=(12<e&&!i?e-12:e)+":"+(h<10?0:"")+h+" "+(i?"":e<12?"am":"pm");let c=n;var r,o,d=h<20?0:h<40?1:2;l[d]||(l[d]=""),"datetime"===t.type&&(r=a.isDateTime(s,t.format,!0),o=t.format.split("|")[0].trim(),c=a.formatDate(r,o)+" "+c),l[d]+=`<span min="${h}" class="min ${this.inRange(c,t)?"w2ui-time ":"w2ui-blocked"}">${n}</span>`}return{html:`<div class="w2ui-calendar">\n            <div class="w2ui-time-title">${a.lang("Select Minute")}</div>\n            <div class="w2ui-cal-time">\n                <div class="w2ui-cal-column">${l[0]}</div>\n                <div class="w2ui-cal-column">${l[1]}</div>\n                <div class="w2ui-cal-column">${l[2]}</div>\n            </div>\n            ${t.btnNow?`<div class="w2ui-cal-now">${a.lang("Now")}</div>`:""}\n        </div>`}}inRange(e,t,i){let s=!1;if("date"===t.type){var n=a.isDate(e,t.format,!0);if(n){if(t.start||t.end){var r="string"==typeof t.start?t.start:l(t.start).val(),o="string"==typeof t.end?t.end:l(t.end).val();let e=a.isDate(r,t.format,!0),i=a.isDate(o,t.format,!0);r=new Date(n),e=e||r,i=i||r,r>=e&&r<=i&&(s=!0)}else s=!0;Array.isArray(t.blockDates)&&t.blockDates.includes(e)&&(s=!1),Array.isArray(t.blockWeekdays)&&t.blockWeekdays.includes(n.getDay())&&(s=!1)}}else if("time"===t.type)if(t.start||t.end){o=this.str2min(e);let i=this.str2min(t.start),l=this.str2min(t.end);i=i||o,l=l||o,o>=i&&o<=l&&(s=!0)}else s=!0;else"datetime"===t.type&&(r=a.isDateTime(e,t.format,!0))&&(n=t.format.split("|").map((e=>e.trim())),i?(o=a.formatDate(r,n[0]),e=a.extend({},t,{type:"date",format:n[0]}),this.inRange(o,e)&&(s=!0)):(i=a.formatTime(r,n[1]),o={type:"time",format:n[1],start:t.startTime,end:t.endTime},this.inRange(i,o)&&(s=!0)));return s}str2min(e){var t;return"string"!=typeof e||2!==(t=e.split(":")).length?null:(t[0]=parseInt(t[0]),t[1]=parseInt(t[1]),-1!==e.indexOf("pm")&&12!==t[0]&&(t[0]+=12),e.includes("am")&&12==t[0]&&(t[0]=0),60*t[0]+t[1])}min2str(e,t){1440<=e&&(e%=1440),e<0&&(e=1440+e);var i=Math.floor(e/60);return e=(e%60<10?"0":"")+e%60,-1!==(t=t||a.settings.timeFormat).indexOf("h24")?i+":"+e:(i<=12?i:i-12)+":"+e+" "+(12<=i?"pm":"am")}};class m extends t{constructor(e){super(e.name),this.box=null,this.name=null,this.routeData={},this.items=[],this.right="",this.tooltip="top|left",this.onClick=null,this.onChange=null,this.onMouseDown=null,this.onMouseUp=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.item_template={id:null,type:"button",text:null,html:"",tooltip:null,count:null,hidden:!1,disabled:!1,checked:!1,icon:null,route:null,arrow:null,style:null,group:null,items:null,selected:null,color:null,backColor:null,overlay:{anchorClass:""},onClick:null,onRefresh:null},this.last={badge:{},pendingRefresh:{}},this._refresh=({effected:e,resize:t,refreshTooltip:i})=>{var s=this.last.pendingRefresh;s.ids??=[],s.ids.push(...e),Object.assign(s,{resize:t,refreshTooltip:i}),this._refreshDebounced()},this._refreshDebounced=a.debounce((()=>{let e=this.last.pendingRefresh;new Set(e.ids).forEach((t=>{this.refresh(t),e.hideTooltip&&this.tooltipHide(t)})),e.resize&&this.resize(),this.last.pendingRefresh={}}),15);var t=e.items;delete e.items,Object.assign(this,e),Array.isArray(t)&&this.add(t,!0),e.items=t,"string"==typeof this.box&&(this.box=l(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){this.insert(null,e,t)}insert(e,t,i){(t=Array.isArray(t)?t:[t]).forEach(((t,s,l)=>{"string"==typeof t&&(t=l[s]={id:t,text:t});var n,r=["button","check","radio","drop","menu","menu-radio","menu-check","color","text-color","html","label","input","group","break","spacer","new-line"];if(r.includes(String(t.type)))if(null!=t.id||["break","spacer","new-line"].includes(t.type)){if(null==t.type)console.log('ERROR: The parameter "type" is required but not supplied.',t);else if(a.checkUniqueId(t.id,this.items,"toolbar",this.name)){let r=a.extend({},this.item_template,t);"group"==r.type&&Array.isArray(r.items)&&r.items.forEach(((e,t)=>{r.items[t]=a.extend({},this.item_template,r.items[t])})),"menu-check"==r.type?(Array.isArray(r.selected)||(r.selected=[]),Array.isArray(r.items)&&r.items.forEach((e=>{(e="string"==typeof e?l[s]={id:e,text:e}:e).checked&&!r.selected.includes(e.id)&&r.selected.push(e.id),!e.checked&&r.selected.includes(e.id)&&(e.checked=!0),null==e.checked&&(e.checked=!1)}))):"menu-radio"==r.type&&Array.isArray(r.items)&&r.items.forEach(((e,t,i)=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&null==r.selected?r.selected=e.id:e.checked=!1,e.checked||r.selected!=e.id||(e.checked=!0),null==e.checked&&(e.checked=!1)})),null==e?this.items.push(r):(n=this.get(e,!0),this.items=this.items.slice(0,n).concat([r],this.items.slice(n))),r.line=r.line??1,!0!==i&&this.refresh(r.id)}}else console.log('ERROR: The parameter "id" is required but not supplied.',t);else console.log('ERROR: The parameter "type" should be one of the following:',r,`, but ${t.type} is supplied.`,t)})),!0!==i&&this.resize()}remove(){let e=0;return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&-1==String(t).indexOf(":")&&(e++,l(this.box).find("#tb_"+this.name+"_item_"+a.escapeId(i.id)).remove(),null!=(t=this.get(i.id,!0)))&&this.items.splice(t,1)})),this.resize(),e}set(e,t){var i=this.get(e);return null!=i&&(Object.assign(i,t),this.refresh(String(e).split(":")[0]),!0)}get(e,t,i){if(0===arguments.length){var s=[];for(let e=0;e<this.items.length;e++){var l=this.items[e];if(null!=l.id&&s.push(l.id),"group"==l.type)for(let e=0;e<l.items.length;e++)null!=l.items[e].id&&s.push(l.items[e].id)}return s}var n=String(e).split(":");null==i&&(i=this.items);for(let s=0;s<i.length;s++){var a=i[s];if(["menu","menu-radio","menu-check"].includes(a.type)&&2==n.length&&a.id==n[0]){let e=a.items;"function"==typeof e&&(e=e(this));for(let i=0;i<e.length;i++){var r=e[i];if(r.id==n[1]||null==r.id&&r.text==n[1])return 1==t?i:r;if(Array.isArray(r.items))for(let e=0;e<r.items.length;e++)if(r.items[e].id==n[1]||null==r.items[e].id&&r.items[e].text==n[1])return 1==t?i:r.items[e]}}else{if(a.id==n[0])return 1==t?s:a;if("group"==a.type&&null!=(a=this.get(e,t,a.items)))return a}}return null}setCount(e,t,i,s){var n=l(this.box).find(`#tb_${this.name}_item_${a.escapeId(e)} .w2ui-tb-count > span`);0<n.length?(n.removeClass().addClass(i??"").text(t).get(0).style.cssText=s??"",this.last.badge[e]={className:i??"",style:s??""},this.get(e).count=t):(this.set(e,{count:t}),this.setCount(...arguments))}show(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&(i.hidden=!1,e.push(String(t).split(":")[0]),"group"==i.type)&&i.items.forEach((e=>this.show(e.id)))})),this._refresh({effected:e,resize:!0}),e}hide(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&(i.hidden=!0,e.push(String(t).split(":")[0]),"group"==i.type)&&i.items.forEach((e=>this.hide(e.id)))})),this._refresh({effected:e,hideTooltip:!0,resize:!0}),e}enable(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&("group"==i.type?i.items.forEach((e=>this.enable(e.id))):(i.disabled=!1,e.push(String(t).split(":")[0])))})),this._refresh({effected:e}),e}disable(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&("group"==i.type?i.items.forEach((e=>this.disable(e.id))):(i.disabled=!0,e.push(String(t).split(":")[0])))})),this._refresh({effected:e,hideTooltip:!0}),e}check(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&-1==String(t).indexOf(":")&&("group"==i.type?i.items.forEach((e=>this.check(e.id))):(i.checked=!0,e.push(String(t).split(":")[0])))})),this._refresh({effected:e}),e}uncheck(){let e=[];return Array.from(arguments).forEach((t=>{var i=this.get(t);i&&-1==String(t).indexOf(":")&&(["menu","menu-radio","menu-check","drop","color","text-color"].includes(i.type)&&i.checked&&h.hide(this.name+"-drop"),"group"==i.type?i.items.forEach((e=>this.uncheck(e.id))):(i.checked=!1,e.push(String(t).split(":")[0])))})),this._refresh({effected:e}),e}click(e,t){var i=String(e).split(":");let s=this.get(i[0]),n=s&&s.items?a.normMenu.call(this,s.items,s):[];if(1<i.length)(i=this.get(e))&&!i.disabled&&this.menuClick({name:this.name,item:s,subItem:i,originalEvent:t});else if(s&&!s.disabled&&!0!==(i=this.trigger("click",{target:null!=e?e:this.name,item:s,object:s,originalEvent:t})).isCancelled){n=s&&s.items?a.normMenu.call(this,s.items,s):[];let p="#tb_"+this.name+"_item_"+a.escapeId(s.id);if(l(this.box).find(p).removeClass("down"),"radio"==s.type){for(let e=0;e<this.items.length;e++){var r=this.items[e];if("group"==r.type)for(let e=0;e<r.items.length;e++){var o=r.items[e];null!=o&&o.id!=s.id&&"radio"===o.type&&o.group==s.group&&o.checked&&(o.checked=!1,this.refresh(o.id))}null!=r&&r.id!=s.id&&"radio"===r.type&&r.group==s.group&&r.checked&&(r.checked=!1,this.refresh(r.id))}s.checked=!0,l(this.box).find(p).addClass("checked")}if(["menu","menu-radio","menu-check","drop","color","text-color"].includes(s.type)){if(this.tooltipHide(e),s.checked)return void h.hide(this.name+"-drop");t=h.get(this.name+"-drop"),t?.displayed&&t.hide(),t?.listeners?.splice(0),setTimeout((()=>{var e=(e,t)=>{let i=this;return function(){i.set(e,{checked:!1})}},t=l(this.box).find("#tb_"+this.name+"_item_"+a.escapeId(s.id));if(a.isPlainObject(s.overlay)||(s.overlay={}),"drop"==s.type&&h.show(a.extend({html:s.html,class:"w2ui-white",hideOn:["doc-click"]},s.overlay,{anchor:t[0],name:this.name+"-drop",data:{item:s,btn:p}})).hide(e(s.id)),["menu","menu-radio","menu-check"].includes(s.type)){let i="normal";"menu-radio"==s.type&&(i="radio",n.forEach((e=>{s.selected==e.id?e.checked=!0:e.checked=!1}))),"menu-check"==s.type&&(i="check",n.forEach((e=>{Array.isArray(s.selected)&&s.selected.includes(e.id)?e.checked=!0:e.checked=!1}))),c.show(a.extend({items:n,align:s.text?"left":"none"},s.overlay,{type:i,name:this.name+"-drop",anchor:t[0],data:{item:s,btn:p}})).hide(e(s.id)).remove((e=>{this.menuClick({name:this.name,remove:!0,item:s,subItem:e.detail.item,originalEvent:e})})).select((e=>{this.menuClick({name:this.name,item:s,subItem:e.detail.item,originalEvent:e})}))}["color","text-color"].includes(s.type)&&u.show(a.extend({color:s.color},s.overlay,{anchor:t[0],name:this.name+"-drop",data:{item:s,btn:p}})).hide(e(s.id)).select((e=>{null!=e.detail.color&&this.colorClick({name:this.name,item:s,color:e.detail.color})}))}),0)}if(["check","menu","menu-radio","menu-check","drop","color","text-color"].includes(s.type)&&(s.checked=!s.checked,s.checked?l(this.box).find(p).addClass("checked"):l(this.box).find(p).removeClass("checked")),s.route){let e=String("/"+s.route).replace(/\/{2,}/g,"/");var d=a.parseRoute(e);if(0<d.keys.length)for(let t=0;t<d.keys.length;t++)e=e.replace(new RegExp(":"+d.keys[t].name,"g"),this.routeData[d.keys[t].name]);setTimeout((()=>{window.location.hash=e}),1)}this.tooltipShow(e),i.finish()}}scroll(e,t,i){return new Promise(((s,n)=>{var a=l(this.box).find(`.w2ui-tb-line:nth-child(${t}) .w2ui-scroll-wrapper`),r=a.get(0).scrollLeft,o=a.find(".w2ui-tb-right").get(0),d=a.parent().get(0).getBoundingClientRect().width,h=r+parseInt(o.offsetLeft)+parseInt(o.clientWidth);switch(e){case"left":(scroll=r-d+50)<=0&&(scroll=0),a.get(0).scrollTo({top:0,left:scroll,behavior:i?"atuo":"smooth"});break;case"right":(scroll=r+d-50)>=h-d&&(scroll=h-d),a.get(0).scrollTo({top:0,left:scroll,behavior:i?"atuo":"smooth"})}setTimeout((()=>{this.resize(),s()}),i?0:600)}))}render(e){var t=Date.now(),i=("string"==typeof e&&(e=l(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==i.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.box)){Array.isArray(this.right)||(this.right=[this.right]);let e="",n=0;for(let t=0;t<this.items.length;t++){var s=this.items[t];null!=s&&(null==s.id&&(s.id="item_"+t),null!=s.caption&&console.log("NOTICE: toolbar item.caption property is deprecated, please use item.text. Item -> ",s),null!=s.hint&&console.log("NOTICE: toolbar item.hint property is deprecated, please use item.tooltip. Item -> ",s),0!==t&&"new-line"!=s.type||(n++,e+=`\n                    <div class="w2ui-tb-line">\n                        <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">\n                            <div class="w2ui-tb-right">${this.right[n-1]??""}</div>\n                        </div>\n                        <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll", "left", "${n}"]'></div>\n                        <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll", "right", "${n}"]'></div>\n                    </div>\n                `),s.line=n)}return l(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-toolbar").html(e),0<l(this.box).length&&(l(this.box)[0].style.cssText+=this.style),a.bindEvents(l(this.box).find(".w2ui-tb-line .w2ui-eaction"),this),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),this.refresh(),this.resize(),i.finish(),Date.now()-t}}refresh(e){var t=Date.now(),i=this.trigger("refresh",{target:null!=e?e:this.name,item:this.get(e)});if(!0!==i.isCancelled){let d;if(null==e)for(let e=0;e<this.items.length;e++){var s=this.items[e];null==s.id&&(s.id="item_"+e),this.refresh(s.id)}else{var n=this.get(e);if(null==n)return!1;if("function"!=typeof n.onRefresh||!0!==(d=this.trigger("refresh",{target:e,item:n,object:n})).isCancelled){var r=`#tb_${this.name}_item_`+a.escapeId(n.id);let s=l(this.box).find(r);var o=this.getItemHTML(n);if(this.tooltipHide(e),"spacer"==n.type&&l(this.box).find(`.w2ui-tb-line:nth-child(${n.line??1})`).find(".w2ui-tb-right").css("width","auto"),0===s.length){e=parseInt(this.get(e,!0))+1;let t=l(this.box).find(`#tb_${this.name}_item_`+a.escapeId(this.items[e]?this.items[e].id:""));0==t.length?t=l(this.box).find(".w2ui-tb-line:nth-child("+n.line).find(".w2ui-tb-right").before(o):t.after(o),a.bindEvents(l(this.box).find(r+`, ${r} .w2ui-eaction`),this)}else{l(this.box).find(r).replace(l.html(o));let e=l(this.box).find(r),t=(a.bindEvents(e,this),a.bindEvents(e.find(".w2ui-eaction"),this),h.get(!0));Object.keys(t).forEach((i=>{t[i].anchor==s.get(0)&&(t[i].anchor=e.get(0))}))}if(["menu","menu-radio","menu-check"].includes(n.type)&&n.checked){let t=Array.isArray(n.selected)?n.selected:[n.selected];(e="function"==typeof n.items?n.items(n):[...n.items]).forEach((e=>{t.includes(e.id)?e.checked=!0:e.checked=!1})),c.update(this.name+"-drop",e)}return"function"==typeof n.onRefresh&&d.finish(),i.finish(),Date.now()-t}}}}resize(){var e=Date.now(),t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled)return l(this.box).find(".w2ui-tb-line").each((e=>{var t=((e=l(e)).find(".w2ui-scroll-left, .w2ui-scroll-right").hide(),e.find(".w2ui-scroll-wrapper").get(0)),i=e.find(".w2ui-tb-right"),s=e.get(0).getBoundingClientRect().width;s<(i=0<i.length?i[0].offsetLeft+i[0].clientWidth:0)&&(0<t.scrollLeft&&e.find(".w2ui-scroll-left").show(),s<i-t.scrollLeft)&&e.find(".w2ui-scroll-right").show()})),t.finish(),Date.now()-e}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<l(this.box).find(".w2ui-scroll-wrapper").length&&this.unmount(),delete n[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}getItemHTML(e){let t="",i=(null!=e.caption&&null==e.text&&(e.text=e.caption),null==e.text&&(e.text=""),null==e.tooltip&&null!=e.hint&&(e.tooltip=e.hint),null==e.tooltip&&(e.tooltip=""),"function"==typeof e.get||!Array.isArray(e.items)&&"function"!=typeof e.items||(e.get=function(t){let i=e.items;return(i="function"==typeof i?e.items(e):i).find((e=>e.id==t))}),""),s="function"==typeof e.text?e.text.call(this,e):e.text;e.icon&&(i=e.icon,"function"==typeof e.icon&&(i=e.icon.call(this,e)),i=`<div class="w2ui-tb-icon">${i="<"!==String(i).slice(0,1)?`<span class="${i}" ${e.icon_style?`style="${e.icon_style}"`:""}></span>`:i}</div>`);var l=["w2ui-tb-button","w2ui-eaction"];switch(e.checked&&l.push("checked"),e.disabled&&l.push("disabled"),e.hidden&&l.push("hidden"),i||l.push("no-icon"),e.type){case"color":case"text-color":if("string"==typeof e.color&&("#"==e.color.slice(0,1)&&(e.color=e.color.slice(1)),[3,6,8].includes(e.color.length))&&(e.color="#"+e.color),"color"==e.type&&(s=`<span class="w2ui-tb-color-box" style="background-color: ${null!=e.color?e.color:"#fff"}"></span>\n                           `+(e.text?`<div style="margin-left: 17px;">${a.lang(e.text)}</div>`:"")),"text-color"==e.type){var n=null!=e.color?e.color:"#444";let t=e.backColor;!0===e.backColor&&(t="#fff",a.colorContrast("#fff",n)<2)&&(t="#555"),s=`<span style="color: ${n}">${e.text?a.lang(e.text):e.backColor?`<b style="background-color: ${t??"transparent"}; padding: 2px 5px; border-radius: 3px;">Ab</b>`:"<b>Ab</b>"}</span>`}case"menu":case"menu-check":case"menu-radio":case"button":case"check":case"radio":case"label":case"drop":n=!0===e.arrow||!1!==e.arrow&&["menu","menu-radio","menu-check","drop","color","text-color"].includes(e.type),t=`\n                    <div id="tb_${this.name}_item_${e.id}" class="${l.join(" ")} ${e.class||""}"\n                        style="${e.hidden?"display: none":""} ${"label"==e.type?e.style??"":""}"\n                        ${e.disabled?"":`data-click='["click","${e.id}", "event"]'\n                               data-mouseenter='["mouseAction", "event", "this", "Enter", "${e.id}"]'\n                               data-mouseleave='["mouseAction", "event", "this", "Leave", "${e.id}"]'\n                               data-mousedown='["mouseAction", "event", "this", "Down", "${e.id}"]'\n                               data-mouseup='["mouseAction", "event", "this", "Up", "${e.id}"]'`}\n                    >\n                        ${i}\n                        ${""!=s&&null!=s||null!=e.count||n?`<div class="w2ui-tb-text" style="${"label"!=e.type?e.style??"":""}; ${s?"":"padding-left: 0; margin-left: 23px;"}">\n                                    ${a.lang(s)}\n                                    ${null!=e.count?a.stripSpaces(`\n                                            <span class="w2ui-tb-count">\n                                                <span class="${this.last.badge[e.id]?this.last.badge[e.id].className??"":""}"\n                                                        style="${this.last.badge[e.id]?this.last.badge[e.id].style??"":""}">${e.count}</span>\n                                            </span>`):""}\n                                    ${n?`<span class="w2ui-tb-down" ${s||e.count?"":'style="margin-left: -3px"'}><span></span></span>`:""}\n                                </div>`:""}\n                    </div>\n                `;break;case"break":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-break"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}">\n                            &#160;\n                        </div>`;break;case"spacer":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-spacer"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}">\n                        </div>`;break;case"html":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-html ${l.join(" ")}"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}">\n                            ${"function"==typeof e.html?e.html.call(this,e):e.html}\n                        </div>`;break;case"input":{var r;n=e.placeholder;let i=e.value;e.spinner&&"object"==typeof e.spinner&&(e.input??={},Object.assign(e.input,e.spinner,{spinner:!0})),null!=i&&""!==String(i).trim()&&e.input?.spinner&&(r=e.input?.step??1,r=e.input?.precision??String(r).split(".")[1]?.length??0,i=isNaN(i)?i:i.toFixed(r)),t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-input w2ui-eaction ${l.join(" ")}"\n                            style="${e.hidden?"display: none":""}; ${e.style||""}"\n                        >\n                            <span class="w2ui-input-label">${e.text??""}</span>\n                            ${e.input?.spinner?`<span class="w2ui-spinner-dec w2ui-eaction" data-click='["spinner", "${e.id}", "dec", "event"]'> – </span>`:""}\n                            <input class="w2ui-toolbar-input w2ui-eaction ${e.input?.spinner?"w2ui-has-spinner":""}"\n                                ${n?`placeholder="${n}"`:""} style="${e.input?.style??""}"\n                                value="${i??""}${e.input?.suffix??""}" ${e.input?.attrs??""}\n                                data-input='["change", "${e.id}", "this", true]'\n                                data-change='["change", "${e.id}", "this"]'\n                                data-keydown='["spinner", "${e.id}", "key", "event"]'\n                                data-mouseenter='["mouseAction", "event", "this", "Enter", "${e.id}"]'\n                                data-mouseleave='["mouseAction", "event", "this", "Leave", "${e.id}"]'\n                            >\n                            ${e.input?.spinner?`<span class="w2ui-spinner-inc w2ui-eaction" data-click='["spinner", "${e.id}", "inc", "event"]'> + </span>`:""}\n                        </div>`;break}case"group":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-group"\n                    style="display: flex; ${e.hidden?"display: none":""}; ${e.style||""}">`,Array.isArray(e.items)?e.items.forEach((e=>{t+=this.getItemHTML(e)})):console.log("ERROR: toolbar group is empty"),t+="</div>"}return t}spinner(e,t,i){var s=this.get(e);let l=0;switch(t){case"inc":l=s.input?.step??1;break;case"dec":l=-(s.input?.step??1);break;case"key":if(s.input.spinner||null!=s.input.step){let e=1;switch((i.shiftKey||i.metaKey)&&(e=10),i.altKey&&(e=.1),i.key){case"ArrowUp":l=(s.input?.step??1)*e,i.preventDefault();break;case"ArrowDown":l=-(s.input?.step??1)*e,i.preventDefault()}}}0!==l&&this.change(e,parseFloat(s.value??0)+l)}change(e,t,i){var s=this.get(e),n=l(this.box).find("#tb_"+this.name+"_item_"+a.escapeId(e)).find("input.w2ui-toolbar-input"),r=(null==(t=t instanceof HTMLInputElement?t.value:t)&&(t=n.val()),!s.input.spinner&&null==s.input.min&&null==s.input.max&&null==s.input.step||(t=parseFloat(t)),null!=s.input?.suffix&&String(t).substr(-s.input.suffix.length)==s.input.suffix&&(t=String(t).substr(0,t.length-s.input.suffix.length)),null!=s.input?.min&&s.input.min>t&&(t=s.input.min),null!=s.input?.max&&s.input.max<t&&(t=s.input.max),s.input.step&&(isNaN(t)&&(t=s.input.min??0),r=s.input?.step??1,r=s.input.precision??String(r).split(".")[1]?.length??0,t=t.toFixed(r)),this.trigger(i?"input":"change",{target:e,id:e,value:t,item:s}));if(!r.isCancelled){s.value=t;let e="";null!=s.input?.suffix&&String(t).substr(-s.input.suffix.length)!=s.input.suffix&&(e=s.input.suffix),i||n.val(t+e),r.finish()}}tooltipShow(e){if(null!=this.tooltip){var t=l(this.box).find("#tb_"+this.name+"_item_"+a.escapeId(e)).get(0),i=(e=this.get(e),"string"==typeof this.tooltip?{position:this.tooltip}:this.tooltip);let s=e.tooltip;"function"==typeof s&&(s=s.call(this,e)),["menu","menu-radio","menu-check","drop","color","text-color"].includes(e.type)&&1==e.checked||h.show({anchor:t,name:this.name+"-tooltip",html:s,...i})}}tooltipHide(e){null!=this.tooltip&&h.hide(this.name+"-tooltip")}menuClick(e){if(e.item&&!e.item.disabled){var t=this.trigger(!0!==e.remove?"click":"remove",{target:e.item.id+":"+e.subItem.id,item:e.item,subItem:e.subItem,originalEvent:e.originalEvent});if(!0!==t.isCancelled){let l=e.subItem,n=this.get(e.item.id),r=n.items;if("function"==typeof r&&(r=n.items()),"menu"==n.type&&(n.selected=l.id),"menu-radio"==n.type&&(n.selected=l.id,Array.isArray(r)&&r.forEach((e=>{!0===e.checked&&delete e.checked,Array.isArray(e.items)&&e.items.forEach((e=>{!0===e.checked&&delete e.checked}))})),l.checked=!0),"menu-check"==n.type)if(Array.isArray(n.selected)||(n.selected=[]),null==l.group){var i=n.selected.indexOf(l.id);-1==i?(n.selected.push(l.id),l.checked=!0):(n.selected.splice(i,1),l.checked=!1)}else if(!1!==l.group){let e=[];i=n.selected.indexOf(l.id);let t=i=>{i.forEach((i=>{var s;i.group===l.group&&-1!=(s=n.selected.indexOf(i.id))&&(i.id!=l.id&&e.push(i.id),n.selected.splice(s,1)),Array.isArray(i.items)&&t(i.items)}))};t(r),-1==i&&(n.selected.push(l.id),l.checked=!0)}if("string"==typeof l.route){let e=""!==l.route?String("/"+l.route).replace(/\/{2,}/g,"/"):"";var s=a.parseRoute(e);if(0<s.keys.length)for(let t=0;t<s.keys.length;t++)null!=this.routeData[s.keys[t].name]&&(e=e.replace(new RegExp(":"+s.keys[t].name,"g"),this.routeData[s.keys[t].name]));setTimeout((()=>{window.location.hash=e}),1)}this.refresh(e.item.id),t.finish()}}}colorClick(e){var t;e.item&&!e.item.disabled&&!0!==(t=this.trigger("click",{target:e.item.id,item:e.item,color:e.color,final:!0})).isCancelled&&(e.item.color=e.color,this.refresh(e.item.id),t.finish())}mouseAction(e,t,i,s){var n=this.get(s);if(!0!==(e=this.trigger("mouse"+i,{target:s,item:n,object:n,originalEvent:e})).isCancelled&&!n.disabled&&!n.hidden){switch(i){case"Enter":["label","input"].includes(n.type)||l(t).addClass("over"),this.tooltipShow(s);break;case"Leave":["label","input"].includes(n.type)||l(t).removeClass("over down"),this.tooltipHide(s);break;case"Down":["label","input"].includes(n.type)||l(t).addClass("down");break;case"Up":["label","input"].includes(n.type)||l(t).removeClass("down")}e.finish()}}}class g extends t{constructor(e){super(e.name),this.name=null,this.box=null,this.sidebar=null,this.parent=null,this.nodes=[],this.menu=[],this.routeData={},this.selected=null,this.icon=null,this.style="",this.topHTML="",this.bottomHTML="",this.multi=!1,this.editable=!1,this.reorder=!1,this.flatButton=!1,this.keyboard=!0,this.flat=!1,this.hasFocus=!1,this.levelPadding=12,this.toggleAlign="right",this.skipRefresh=!1,this.tabIndex=null,this.handle={width:0,style:"",text:"",tooltip:""},this.badge=null,this.onClick=null,this.onSelect=null,this.onUnselect=null,this.onDblClick=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onContextMenu=null,this.onMenuClick=null,this.onExpand=null,this.onCollapse=null,this.onKeydown=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onFocus=null,this.onBlur=null,this.onFlat=null,this.onEdit=null,this.onRename=null,this.onReorder=null,this.onDragStart=null,this.onDragOver=null,this.node_template={id:null,text:"",order:null,count:null,icon:null,nodes:[],style:"",route:null,selected:!1,expanded:!1,hidden:!1,disabled:!1,group:!1,groupShowHide:!0,collapsible:!1,plus:!1,childOffset:0,onClick:null,onDblClick:null,onContextMenu:null,onExpand:null,onCollapse:null,parent:null,sidebar:null},this.last={badge:{},renaming:!1,move:null};var t=e.nodes;delete e.nodes,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.nodes=t,"string"==typeof this.box&&(this.box=l(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){return 1==arguments.length&&(t=arguments[0],e=this),"string"==typeof e&&(e=this.get(e)),this.insert(e=null!=e&&""!=e?e:this,null,t)}insert(e,t,i){let s,l,n,a,r;if(2==arguments.length&&"string"==typeof e)if(i=arguments[1],null!=(t=arguments[0])){if(null==(l=this.get(t)))return null!=(i=Array.isArray(i)?i:[i])[0].caption&&null==i[0].text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",i[0]),i[0].text=i[0].caption),s=i[0].text,console.log('ERROR: Cannot insert node "'+s+'" because cannot find node "'+t+'" to insert before.'),null;e=this.get(t).parent}else e=this;null!=(e="string"==typeof e?this.get(e):e)&&""!=e||(e=this),Array.isArray(i)||(i=[i]);for(let o=0;o<i.length;o++)if(null!=(a=i[o]).caption&&null==a.text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text"),a.text=a.caption),null==typeof a.id)s=a.text,console.log('ERROR: Cannot insert node "'+s+'" because it has no id.');else if(null!=this.get(this,a.id))console.log("ERROR: Cannot insert node with id="+a.id+" (text: "+a.text+") because another node with the same id already exists.");else{if((n=Object.assign({},this.node_template,a)).sidebar=this,n.parent=e,r=n.nodes||[],n.nodes=[],null==t)e.nodes.push(n);else{if(null==(l=this.get(e,t,!0)))return console.log('ERROR: Cannot insert node "'+a.text+'" because cannot find node "'+t+'" to insert before.'),null;e.nodes.splice(l,0,n)}0<r.length&&this.insert(n,null,r)}return this.skipRefresh||this.refresh(e.id),n}remove(){let e,t=0;return Array.from(arguments).forEach((i=>{null!=(e=this.get(i))&&(null!=this.selected&&(Array.isArray(this.selected)?this.selected.splice(this.selected.indexOf(e.id),1):this.selected===e.id&&(this.selected=null)),null!=(i=this.get(e.parent,i,!0)))&&(e.parent.nodes[i].selected&&e.sidebar.unselect(e.id),e.parent.nodes.splice(i,1),e.parent.collapsible=0<e.parent.nodes.length,t++)})),this.skipRefresh||(0<t&&1==arguments.length?this.refresh(e.parent.id):this.refresh()),t}set(e,t,i){if(2==arguments.length&&(i=t,t=e,e=this),null==(e="string"==typeof e?this.get(e):e).nodes)return null;for(let l=0;l<e.nodes.length;l++){var s;if(e.nodes[l].id===t)return s=this.update(t,i),0!=Object.keys(s).length&&(s=i.nodes,a.extend(e.nodes[l],i,null!=s?{nodes:[]}:{}),null!=s&&this.add(e.nodes[l],s),this.skipRefresh||this.refresh(t)),!0;if(this.set(e.nodes[l],t,i))return!0}return!1}get(e,t,i){if(0===arguments.length){var s=[],l=this.find({});for(let e=0;e<l.length;e++)null!=l[e].id&&s.push(l[e].id);return s}if((1==arguments.length||2==arguments.length&&!0===t)&&(i=t,t=e,e=this),null!=(e="string"==typeof e?this.get(e):e).nodes)for(let s=0;s<e.nodes.length;s++){if(e.nodes[s].id==t)return!0===i?s:e.nodes[s];var n=this.get(e.nodes[s],t,i);if(n||0===n)return n}return null}setCount(e,t,i={}){var s=l(this.box).find(`#node_${a.escapeId(e)} .w2ui-node-badge`);0<s.length?(s.removeClass().addClass("w2ui-node-badge "+(i.className??"w2ui-node-count")).text(t).get(0).style.cssText=i.style||"",this.last.badge[e]={className:i.className??"",style:i.style??""},this.get(e).count=t):(this.set(e,{count:t}),this.setCount(...arguments))}find(e,t,i){if(1==arguments.length&&(t=e,e=this),i=i||[],null!=(e="string"==typeof e?this.get(e):e).nodes)for(let l=0;l<e.nodes.length;l++){let n=!0;for(var s in t)e.nodes[l][s]!=t[s]&&(n=!1);n&&i.push(e.nodes[l]),0<e.nodes[l].nodes.length&&(i=this.find(e.nodes[l],t,i))}return i}sort(e,t){null==(e=e&&"object"==typeof e?e:{}).foldersFirst&&(e.foldersFirst=!0),null==e.caseSensitive&&(e.caseSensitive=!1),null==e.reverse&&(e.reverse=!1),(t=null==t?this.nodes:t).sort(((t,i)=>{var s=t.nodes&&0<t.nodes.length,l=i.nodes&&0<i.nodes.length;if(!1===e.foldersFirst||!s&&!l||s&&l){let s=t.text,l=i.text;return e.caseSensitive||(s=s.toLowerCase(),l=l.toLowerCase()),null!=t.order&&(s=t.order),null!=i.order&&(l=i.order),(1===(t=a.naturalCompare(s,l))||-1===t)&e.reverse?-t:t}return s&&!l?e.reverse?1:-1:!s&&l?e.reverse?-1:1:void 0})),t.forEach((t=>{t.nodes&&0<t.nodes.length&&this.sort(e,t.nodes)}))}each(e,t){(t=null==t?this.nodes:t).forEach((t=>{e.call(this,t),t.nodes&&0<t.nodes.length&&this.each(e,t.nodes)}))}search(e,t=null){let i=0,s=e.toLowerCase();return this.each((l=>{let n=!1;(n="function"==typeof t?t(e,l):!(-1===l.text.toLowerCase().indexOf(s)))?(i++,function e(t){t.parent&&(t.parent.hidden=!1,e(t.parent))}(l),l.hidden=!1):l.hidden=!0})),this.refresh(),i}show(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!1!==t.hidden&&(t.hidden=!1,e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}hide(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!0!==t.hidden&&(t.hidden=!0,e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}enable(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!1!==t.disabled&&(t.disabled=!1,e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}disable(){let e=[];return Array.from(arguments).forEach((t=>{null!=(t=this.get(t))&&!0!==t.disabled&&(t.disabled=!0,t.selected&&this.unselect(t.id),e.push(t.id))})),0<e.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),e}select(e){if(!Array.isArray(e)){var t=this.get(e);if(!t)return!1;var i=this.trigger("select",{target:e,id:e,node:t});if(!0!==i.isCancelled){if(!this.multi&&this.selected==e&&t.selected)return!1;var s=l(this.box).find("#node_"+a.escapeId(e));s.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),0<s.length&&(this.inView(e)||this.scrollIntoView(e)),t.selected=!0,this.multi?(Array.isArray(this.selected)||(this.selected=this.selected?[this.selected]:[]),this.selected.push(e)):this.selected=this.multi?[e]:e,i.finish()}return!0}[...e].forEach((e=>this.select(e)))}unselect(e){var t,i;if(0===arguments.length&&(e=this.selected),!Array.isArray(e))return!!(i=this.get(e))&&(!0!==(t=this.trigger("unselect",{target:e,id:e,node:i})).isCancelled&&(i.selected=!1,l(this.box).find("#node_"+a.escapeId(e)).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),"string"==typeof this.selected&&this.selected==e&&(this.selected=null),this.multi&&Array.isArray(this.selected)&&-1!=(i=this.selected.indexOf(e))&&this.selected.splice(i,1),t.finish()),!0);[...e].forEach((e=>this.unselect(e)))}toggle(e){var t=this.get(e);return null!=t&&(t.plus?(this.set(e,{plus:!1}),this.expand(e),void this.refresh(e)):0!==t.nodes.length&&!!t.collapsible&&(this.get(e).expanded?this.collapse(e):this.expand(e)))}collapse(e){var t,i=this.get(e);return null!=i&&(!0!==(t=this.trigger("collapse",{target:e,object:i,node:i})).isCancelled?(l(this.box).find("#node_"+a.escapeId(e)+"_sub").hide(),l(this.box).find("#node_"+a.escapeId(e)+" .w2ui-expanded").removeClass("w2ui-expanded").addClass("w2ui-collapsed"),i.expanded=!1,t.finish(),this.refresh(e),!0):void 0)}expand(e){var t=this.get(e),i=this.trigger("expand",{target:e,object:t,node:t});if(!0!==i.isCancelled)return l(this.box).find("#node_"+a.escapeId(e)+"_sub").show(),l(this.box).find("#node_"+a.escapeId(e)+" .w2ui-collapsed").removeClass("w2ui-collapsed").addClass("w2ui-expanded"),t.expanded=!0,i.finish(),this.refresh(e),!0}collapseAll(e){if(null==(e="string"==typeof(e=null==e?this:e)?this.get(e):e).nodes)return!1;for(let t=0;t<e.nodes.length;t++)!0===e.nodes[t].expanded&&(e.nodes[t].expanded=!1),e.nodes[t].nodes&&0<e.nodes[t].nodes.length&&this.collapseAll(e.nodes[t]);return this.refresh(e.id),!0}expandAll(e){if(null==(e="string"==typeof(e=null==e?this:e)?this.get(e):e).nodes)return!1;for(let t=0;t<e.nodes.length;t++)!1===e.nodes[t].expanded&&(e.nodes[t].expanded=!0),e.nodes[t].nodes&&0<e.nodes[t].nodes.length&&this.expandAll(e.nodes[t]);this.refresh(e.id)}expandParents(e){return null!=(e=this.get(e))&&(e.parent&&(e.parent.expanded||(e.parent.expanded=!0,this.refresh(e.parent.id)),this.expandParents(e.parent.id)),!0)}click(e,t){let i=this,s=this.get(e);if(null!=s)if(s.disabled||s.group)i.trigger("click",{target:e,originalEvent:t,node:s,object:s}).finish();else{let n=l(i.box).find("#node_"+a.escapeId(e));n.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),setTimeout((()=>{var l=i.trigger("click",{target:e,originalEvent:t,node:s,object:s});if(!0===l.isCancelled)n.removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected");else{if(this.multi){var r=t?.shiftKey??!1,o=(t?.ctrlKey||t?.metaKey)??!1;if("string"==typeof this.selected&&(this.selected=[this.selected]),o&&!r){if(this.selected?.includes(e))return void this.unselect(e);this.select(e)}else if(!o&&r){let t=this.getChain();var d=Math.min(this.selected.map((e=>t.indexOf(e)))),h=t.indexOf(e);for(let e=Math.min(d,h);e<t.length&&e<=Math.max(d,h);e++){var c=this.get(t[e]);this.selected.includes(t[e])||1==c.hidden||this.select(t[e])}}else o=this.selected?.filter((t=>t!=e&&this.selected.includes(t))),this.unselect(o),this.selected?.includes(e)||this.select(e)}else if(this.selected!==e&&(null!=this.selected&&this.unselect(this.selected),this.select(e),"string"==typeof s.route)){let e=""!==s.route?String("/"+s.route).replace(/\/{2,}/g,"/"):"";var u=a.parseRoute(e);if(0<u.keys.length)for(let t=0;t<u.keys.length;t++)null!=i.routeData[u.keys[t].name]&&(e=e.replace(new RegExp(":"+u.keys[t].name,"g"),i.routeData[u.keys[t].name]));setTimeout((()=>{window.location.hash=e}),1)}l.finish()}}),1)}}focus(e){let t=this;if(!0===(e=this.trigger("focus",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!0,l(this.box).find(".w2ui-sidebar-body").addClass("w2ui-focus"),setTimeout((()=>{var e=l(t.box).find("#sidebar_"+t.name+"_focus").get(0);document.activeElement!=e&&e.focus()}),10),e.finish()}blur(e){if(!0===(e=this.trigger("blur",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!1,l(this.box).find(".w2ui-sidebar-body").removeClass("w2ui-focus"),e.finish()}next(e,t){if(null==e)return null;var i=e.parent,s=this.get(e.id,!0);let l=null;return null!=(l=e.expanded&&0<e.nodes.length&&!0!==t?(t=e.nodes[0]).hidden||t.disabled||t.group?this.next(t):t:i&&s+1<i.nodes.length?i.nodes[s+1]:this.next(i,!0))&&(l.hidden||l.disabled||l.group)?this.next(l):l}prev(e){if(null==e)return null;var t=e.parent;e=this.get(e.id,!0);let i=e=>{var t;return e.expanded&&0<e.nodes.length?(t=e.nodes[e.nodes.length-1]).hidden||t.disabled||t.group?this.prev(t):i(t):e},s=0<e?i(t.nodes[e-1]):t;return null!=s&&(s.hidden||s.disabled||s.group)?this.prev(s):s}getChain(e,t={}){t.returnDisabled??=!1,t.returnGroups??=!1;let i=[];return(e=null==e?this.nodes:e).forEach((e=>{(!e.disabled&&!e.group||e.disabled&&t.returnDisabled||e.group&&t.returnGroups)&&i.push(e.id),Array.isArray(e.nodes)&&e.expanded&&i.push(...this.getChain(e.nodes,t))})),i}keydown(e){let t=this;var i=Array.isArray(this.selected)?this.selected[0]:this.selected;let s=t.get(i);if(!0===this.keyboard){if(s=s||this.nodes[0],27==e.keyCode){var l=this.last.move;if(l?.reorder&&l?.moved)return void l.restore()}!0!==(l=this.trigger("keydown",{target:this.name,originalEvent:e})).isCancelled&&(13!=e.keyCode&&32!=e.keyCode||(13!=e.keyCode||!this.editable||e.ctrlKey||e.metaKey?0<s.nodes.length&&this.toggle(i):this.edit(i)),37==e.keyCode&&(0<s.nodes.length&&s.expanded?this.collapse(i):(n(s.parent),s.parent.group||this.collapse(s.parent.id))),39==e.keyCode&&(0<s.nodes.length||s.plus)&&!s.expanded&&this.expand(i),38==e.keyCode&&(null==this.get(i)?n(this.nodes[0]||null):n(a(s,this.prev))),40==e.keyCode&&(null==this.get(i)?n(this.nodes[0]||null):n(a(s,this.next))),[13,32,37,38,39,40].includes(e.keyCode)&&(e.preventDefault&&e.preventDefault(),e.stopPropagation)&&e.stopPropagation(),l.finish())}function n(e,i){null==e||e.hidden||e.disabled||e.group||(t.click(e.id,i),t.inView(e.id))||t.scrollIntoView(e.id)}function a(e,i){for(e=i.call(t,e);null!=e&&(e.hidden||e.disabled)&&!e.group;)e=i(e);return e}}inView(e){var t;return!(!(e=l(this.box).find("#node_"+a.escapeId(e)).get(0))||(t=l(this.box).find(".w2ui-sidebar-body").get(0),e.offsetTop<t.scrollTop)||e.offsetTop+e.clientHeight>t.clientHeight+t.scrollTop)}scrollIntoView(e,t){return new Promise(((i,s)=>{null==e&&(e=Array.isArray(this.selected)?this.selected[0]:this.selected),null!=this.get(e)&&(l(this.box).find("#node_"+a.escapeId(e)).get(0).scrollIntoView({block:"center",inline:"center",behavior:t?"atuo":"smooth"}),setTimeout((()=>{this.resize(),i()}),t?0:500))}))}dblClick(e,t){var i=this.get(e);!0!==(t=this.trigger("dblClick",{target:e,originalEvent:t,object:i})).isCancelled&&(this.editable?this.edit(e):this.toggle(e),t.finish())}mouseDown(e,t){let i=this;if(this.reorder){this.last.move={x:t.screenX,y:t.screenY,divX:0,divY:0,reorder:!0,moved:!1};let r=this.last.move;var s,n=l(this.box).find(".w2ui-sidebar-body");r.ghost||(s=l(this.box).find("#node_"+a.escapeId(e)),r.offsetY=t.offsetY,r.target=e,r.pos={top:s.get(0).offsetTop-1,left:s.get(0).offsetLeft},t=l(s.find(".w2ui-node-data").get(0).cloneNode(!0)),r.node=s,r.nodeSub=s.next(),n.append('<div id="sidebar_'+this.name+'_ghost" class="w2ui-node w2ui-ghost"></div>'),l(this.box).find("#sidebar_"+this.name+"_ghost").append(t),r.ghost=l(this.box).find("#sidebar_"+this.name+"_ghost"),r.ghost.css({display:"none"}),r.restore=()=>{r.resetReorder(),this.refresh()},r.resetReorder=()=>{this.last.move=null,l(this.box).find(`#sidebar_${this.name}_ghost`).remove(),l(document).off(`.w2ui-${this.name}-reorder`)}),l(document).on(`mousemove.w2ui-${this.name}-reorder`,(function(e){if(e.target.tagName){var t=i.last.move;if(t.divX=e.screenX-t.x,t.divY=e.screenY-t.y,!(Math.abs(t.divX)<=1&&Math.abs(t.divY)<=1)){if(1==i.reorder&&t.reorder&&!t.moved){var s=i.trigger("dragStart",{target:t.target,moved:!0,node:i.get(t.target),mv:t,originalEvent:e});if(!0===s.isCancelled)return void t.restore();var n=t.node.get(0).getBoundingClientRect();t.moved=!0,t.node.html("").removeAttr("id","data-id").addClass("w2ui-reorder-empty").css({height:n.height+"px"}),"none"!==t.node.next().css("display")&&(n=t.node.next().get(0).getBoundingClientRect(),t.node.next().html('<div class="w2ui-reorder-empty-sub"></div>').css({height:n.height+"px"})),t.ghost.css({display:"block"}),s.finish()}var r;t.ghost.css({top:t.pos.top+t.divY+"px",left:0}),n=l(e.target).closest(".w2ui-node, .w2ui-node-group").attr("data-id"),l(e.target).hasClass("w2ui-sidebar-body")&&5<e.layerY&&!t.append?!0!==(s=i.trigger("dragOver",{target:t.target,append:!0,mv:t,originalEvent:e})).isCancelled&&(t.ghost.before(t.node),t.ghost.before(t.nodeSub),t.append=!0,t.moveBefore=null,s.finish()):null!=n&&n!=t.moveBefore&&(t.append=!1,t.moveBefore=n,!0!==(e=i.trigger("dragOver",{target:t.target,moveBefore:n,mv:t,originalEvent:e})).isCancelled)&&((r=l(i.box).find("#node_"+a.escapeId(n))).before(t.node),r.before(t.nodeSub),e.finish())}}})).on(`mouseup.w2ui-${this.name}-reorder`,(function(e){var t=i.last.move;if(t.resetReorder(),t.moved)if(null!=t.moveBefore&&t.target!=t.moveBefore||t.append)if(!0===(e=i.trigger("reorder",{target:t.target,moveBefore:t.moveBefore,append:t.append,originalEvent:e})).isCancelled)i.refresh();else{var s=(l=i.get(t.target)).parent.nodes.indexOf(l),l=l.parent.nodes.splice(s,1);if(t.append)i.nodes.push(...l),l.forEach((e=>e.parent=i));else{let e=i.get(t.moveBefore);s=e.parent.nodes.indexOf(e),l.forEach((t=>t.parent=e.parent)),e.parent.nodes.splice(s,0,...l)}i.refresh(),e.finish()}else i.refresh()}))}}edit(e){let t=this,i=l(this.box).find("#node_"+a.escapeId(e)),s=i.find(".w2ui-node-text");var n=this.trigger("edit",{target:e,el:i,textEl:s});if(!0!==n.isCancelled){this.last.renaming=!0,i.addClass("w2ui-editing"),s.addClass("w2ui-focus").css("pointer-events","all").attr("contenteditable",a.isFirefox?"true":"plaintext-only").on("blur.node-editing",(e=>{setTimeout(o,0)})).on("keydown.node-editing",(e=>{13==e.keyCode&&o(e),27==e.keyCode&&o(e,!0)})).get(0).focus();let r=s.text();return a.setCursorPosition(s[0],0,s.text().length),n.finish(),s.get(0);function o(l,n){var a=s.text();if(i.removeClass("w2ui-editing"),s.removeClass("w2ui-focus").css("pointer-events","none").removeAttr("contenteditable").off(".node-editing"),!n&&t.last.renaming&&r!==a){if(!0===(l=t.trigger("rename",{target:e,text_previous:r,text_new:a,originalEvent:l})).isCancelled)return s.text(r),t.last.renaming=!1,void t.focus();t.set(e,{text:a}),l.finish()}n&&t.set(e,{text:r}),t.last.renaming=!1,t.focus()}}}contextMenu(e,t){var i=this.get(e),s=(Array.isArray(this.selected)?this.selected.includes(e)||this.click(e):e!=this.selected&&this.click(e),this.trigger("contextMenu",{target:e,originalEvent:t,object:i,allowOnDisabled:!1}));!0===s.isCancelled||i.disabled&&!s.allowOnDisabled||(0<this.menu.length&&c.show({name:this.name+"_menu",anchor:document.body,items:this.menu,originalEvent:t}).select((i=>{this.menuClick(e,parseInt(i.detail.index),t)})),t.preventDefault&&t.preventDefault(),s.finish())}menuClick(e,t,i){!0!==(e=this.trigger("menuClick",{target:e,originalEvent:i,menuIndex:t,menuItem:this.menu[t]})).isCancelled&&e.finish()}goFlat(){var e=this.trigger("flat",{goFlat:!this.flat});!0!==e.isCancelled&&(this.flat=!this.flat,this.refresh(),e.finish())}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=l(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.box)){let r;return l(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-sidebar").html(`<div>\n                <div class="w2ui-sidebar-top"></div>\n                <input id="sidebar_${this.name}_focus" ${this.tabIndex?'tabindex="'+this.tabIndex+'"':""}\n                    style="position: absolute; top: 0; right: 0; width: 1px; z-index: -1; opacity: 0"\n                    ${a.isMobile?"readonly":""}/>\n                <div class="w2ui-sidebar-body"></div>\n                <div class="w2ui-sidebar-bottom"></div>\n            </div>`),e=l(this.box).get(0).getBoundingClientRect(),l(this.box).find(":scope > div").css({width:e.width+"px",height:e.height+"px"}),l(this.box).get(0).style.cssText+=this.style,l(this.box).find("#sidebar_"+this.name+"_focus").on("focus",(function(e){clearTimeout(r),i.hasFocus||i.focus(e)})).on("blur",(function(e){r=setTimeout((()=>{i.hasFocus&&i.blur(e)}),100)})).on("keydown",(function(e){n[i.name].keydown.call(n[i.name],e)})),l(this.box).off("mousedown").on("mousedown",(function(e){setTimeout((()=>{var t;-1==["INPUT","TEXTAREA","SELECT"].indexOf(e.target.tagName.toUpperCase())&&(t=l(i.box).find("#sidebar_"+i.name+"_focus"),document.activeElement!=t.get(0))&&0<t.length&&t.get(0).focus()}),1)})),e=`<div class="w2ui-flat w2ui-flat-${this.flat?"right":"left"}" ${0==this.flatButton?'style="display: none"':""}></div>`,""===this.topHTML&&!e||(l(this.box).find(".w2ui-sidebar-top").html(this.topHTML+e),l(this.box).find(".w2ui-sidebar-body").css("top",l(this.box).find(".w2ui-sidebar-top").get(0)?.clientHeight+"px"),l(this.box).find(".w2ui-flat").off("click").on("click",(e=>{this.goFlat()}))),""!==this.bottomHTML&&(l(this.box).find(".w2ui-sidebar-bottom").html(this.bottomHTML),l(this.box).find(".w2ui-sidebar-body").css("bottom",l(this.box).find(".w2ui-sidebar-bottom").get(0)?.clientHeight+"px")),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),s.finish(),this.refresh(),Date.now()-t}}update(e,t={}){let i;if(e=this.get(e)){var s=l(this.box).find("#node_"+a.escapeId(e.id));if(e.group)t.text&&(e.text=t.text,s.find(".w2ui-group-text").replace("function"==typeof e.text?e.text.call(this,e):'<span class="w2ui-group-text">'+e.text+"</span>"),delete t.text),t.class&&(e.class=t.class,i=s.data("level"),s.get(0).className="w2ui-node-group w2ui-level-"+i+(e.class?" "+e.class:""),delete t.class),t.style&&(e.style=t.style,s.get(0).nextElementSibling.style=e.style+";"+(!e.hidden&&e.expanded?"":"display: none;"),delete t.style);else{if(t.icon&&0<(n=s.find(".w2ui-node-image > span")).length&&(e.icon=t.icon,n[0].className="function"==typeof e.icon?e.icon.call(this,e):e.icon,delete t.icon),t.count){e.count=t.count;let l=e.count??this.badge.text;var n=this.badge.style,r=this.last.badge[e.id];"function"==typeof l&&(l=l.call(this,e,i)),s.find(".w2ui-node-badge").html(l).attr("style",n+"; "+(r?.style??"")),0<s.find(".w2ui-node-badge").length&&delete t.count}t.class&&0<s.length&&(e.class=t.class,i=s.data("level"),s[0].className="w2ui-node w2ui-level-"+i+(e.selected?" w2ui-selected":"")+(e.disabled?" w2ui-disabled":"")+(e.class?" "+e.class:""),delete t.class),t.text&&(e.text=t.text,s.find(".w2ui-node-text").html("function"==typeof e.text?e.text.call(this,e):e.text),delete t.text),t.style&&0<s.length&&(n=s.find(".w2ui-node-text"),e.style=t.style,n[0].style=e.style,delete t.style)}}return t}refresh(e,t){if(null!=this.box){var i=Date.now();let d=this;var s=this.trigger("refresh",{target:null!=e?e:this.name,nodeId:null!=e?e:null,fullRefresh:null==e});if(!0!==s.isCancelled){1==this.flatButton?l(this.box).find(".w2ui-sidebar-top .w2ui-flat").show().removeClass("w2ui-flat-left w2ui-flat-right").addClass(" w2ui-flat-"+(this.flat?"right":"left")):l(this.box).find(".w2ui-sidebar-top .w2ui-flat").hide(),l(this.box).find(":scope > div").removeClass("w2ui-sidebar-flat").addClass(this.flat?"w2ui-sidebar-flat":"").css({width:l(this.box).get(0)?.clientWidth+"px",height:l(this.box).get(0)?.clientHeight+"px"}),0<this.nodes.length&&null==this.nodes[0].parent&&(n=this.nodes,this.nodes=[],this.add(this,n));let h,c,u=this;if(null==e)h=this,c=".w2ui-sidebar-body";else{if(null==(h=this.get(e)))return;c="#node_"+a.escapeId(h.id)+"_sub"}var n="#node_"+a.escapeId(h.id);let p;h!==this&&(p=m(h),l(this.box).find(n).before('<div id="sidebar_'+this.name+'_tmp"></div>'),l(this.box).find(n).remove(),l(this.box).find(c).remove(),l(this.box).find("#sidebar_"+this.name+"_tmp").before(p),l(this.box).find("#sidebar_"+this.name+"_tmp").remove()),e=l(this.box).find(":scope > div").get(0);var r={top:e?.scrollTop,left:e?.scrollLeft};l(this.box).find(c).html("");for(let g=0;g<h.nodes.length;g++){var o=h.nodes[g];if(p=m(o),l(this.box).find(c).append(p),0!==o.nodes.length)this.refresh(o.id,!0);else{if(!0===(o=this.trigger("refresh",{target:o.id})).isCancelled)return;o.finish()}}return e&&(e.scrollTop=r.top,e.scrollLeft=r.left),t||(e=l(this.box).find(n+`, ${n} .w2ui-eaction, ${c} .w2ui-eaction`),a.bindEvents(e,this)),s.finish(),Date.now()-i;function m(e){let t="",i=e.icon,s=(null==i&&(i=u.icon),e.parent),l=0;for(;s&&null!=s.parent;)s=s.parent,l++;if(null!=e.caption&&null==e.text&&(e.text=e.caption),null!=e.caption&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",e),e.text=e.caption),Array.isArray(e.nodes)&&0<e.nodes.length&&(e.collapsible=!0),e.group){let i=a.lang("function"==typeof e.text?e.text.call(u,e,l):e.text);"<span"!=String(i).substr(0,5)&&(i=`<span class="w2ui-group-text">${i}</span>`),t=`\n                    <div id="node_${e.id}" data-id="${e.id}" data-level="${l}" style="${e.hidden?"display: none":""}"\n                        class="w2ui-node-group w2ui-level-${l} ${e.class||""} w2ui-eaction"\n                        data-click="toggle|${e.id}"\n                        data-contextmenu="contextMenu|${e.id}|event"\n                        data-mouseenter="showPlus|this|inherit"\n                        data-mouseleave="showPlus|this|transparent">\n                        ${e.groupShowHide&&e.collapsible?`<span>${!e.hidden&&e.expanded?a.lang("Hide"):a.lang("Show")}</span>`:"<span></span>"} ${i}\n                    </div>\n                    <div class="w2ui-node-sub" id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}">\n                </div>`,u.flat&&(t=`\n                        <div class="w2ui-node-group" id="node_${e.id}" data-id="${e.id}"><span>&#160;</span></div>\n                        <div id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}"></div>`)}else{e.selected&&!e.disabled&&(u.multi?(u.selected??=[],u.selected.includes(e.id)||u.selected.push(e.id)):u.selected=e.id);let s="";i&&(s=i instanceof Object?(n="function"==typeof i.text?i.text.call(u,e,l)??"":i.text,`\n                            <div class="w2ui-node-image w2ui-eaction" style="${u.icon.style??""}; pointer-events: all"\n                                data-mouseEnter="mouseAction|Enter|this|${e.id}|event|icon"\n                                data-mouseLeave="mouseAction|Leave|this|${e.id}|event|icon"\n                                data-click="mouseAction|click|this|${e.id}|event|icon">\n                                    ${n}\n                            </div>\n                        `):`\n                            <div class="w2ui-node-image">\n                                <span class="${"function"==typeof i?i.call(u,e,l):i}"></span>\n                            </div>`);let o="",h="";if(null!=d.badge||null!=e.count){let t=e.count??d.badge?.text;var n=d.badge?.style,r=u.last.badge[e.id];(t="function"==typeof t?t.call(d,e,l):t)&&(h=`\n                            <div class="w2ui-node-badge w2ui-eaction ${null!=e.count?"w2ui-node-count":""} ${r?.className??""}"\n                                style="${n??""};${r?.style??""}"\n                                data-mouseEnter="mouseAction|Enter|this|${e.id}|event|badge"\n                                data-mouseLeave="mouseAction|Leave|this|${e.id}|event|badge"\n                                data-click="mouseAction|click|this|${e.id}|event|badge"\n                            >\n                                ${t}\n                            </div>`)}n=["w2ui-node","w2ui-level-"+l,"w2ui-eaction"],e.selected&&n.push("w2ui-selected"),e.disabled&&n.push("w2ui-disabled"),e.class&&n.push(e.class),!0===e.collapsible&&(r=["w2ui-sb-toggle","w2ui-eaction",e.expanded?"w2ui-expanded":"w2ui-collapsed"],"left"==d.toggleAlign&&r.push("w2ui-left-toggle"),o=`<div class="${r.join(" ")}" data-click="toggle|${e.id}"><span></span></div>`,n.push("w2ui-has-children")),r=a.lang("function"==typeof e.text?e.text.call(u,e,l):e.text);let c=e.parent?.childOffset??0;0===l&&!0===e.collapsible&&"left"==d.toggleAlign&&(c+=12),t=`\n                    <div id="node_${e.id}" class="${n.join(" ")}" data-id="${e.id}" data-level="${l}"\n                        style="${e.hidden?"display: none;":""}"\n                        data-click="click|${e.id}|event"\n                        data-dblclick="dblClick|${e.id}|event"\n                        data-mouseDown="mouseDown|${e.id}|event"\n                        data-contextmenu="contextMenu|${e.id}|event"\n                        data-mouseEnter="mouseAction|Enter|this|${e.id}|event"\n                        data-mouseLeave="mouseAction|Leave|this|${e.id}|event"\n                    >\n                        ${u.handle.text?`<div class="w2ui-node-handle w2ui-eaction" style="width: ${u.handle.width}px; ${u.handle.style}"\n                                    data-mouseEnter="mouseAction|Enter|this|${e.id}|event|handle"\n                                    data-mouseLeave="mouseAction|Leave|this|${e.id}|event|handle"\n                                    data-click="mouseAction|click|this|${e.id}|event|handle"\n                                >\n                                   ${"function"==typeof u.handle.text?u.handle.text.call(u,e,l)??"":u.handle.text}\n                              </div>`:""}\n                      <div class="w2ui-node-data" style="margin-left: ${l*u.levelPadding+c+u.handle.width}px">\n                            ${o} ${s} ${h}\n                            <div class="w2ui-node-text ${s?"":"no-icon"}" style="${e.style||""}">${r}</div>\n                       </div>\n                    </div>\n                    <div class="w2ui-node-sub" id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}"></div>`,u.flat&&(t=`\n                        <div id="node_${e.id}" class="${n.join(" ")}" data-id="${e.id}" style="${e.hidden?"display: none;":""}"\n                            data-click="click|${e.id}|event"\n                            data-dblclick="dblClick|${e.id}|event"\n                            data-contextmenu="contextMenu|${e.id}|event"\n                            data-mouseEnter="mouseAction|Enter|this|${e.id}|event|tooltip"\n                            data-mouseLeave="mouseAction|Leave|this|${e.id}|event|tooltip"\n                        >\n                            <div class="w2ui-node-data w2ui-node-flat">${s}</div>\n                        </div>\n                        <div class="w2ui-node-sub" id="node_${e.id}_sub" style="${e.style}; ${!e.hidden&&e.expanded?"":"display: none;"}"></div>`)}return t}}}}mouseAction(e,t,i,s,l){let n;if(i=this.get(i),null==l&&(n=this.trigger("mouse"+e,{target:i.id,node:i,originalEvent:s})),"tooltip"==l){let s=a.lang("function"==typeof i.text?i.text.call(this,i):i.text)+(i.count||0===i.count?' - <span class="w2ui-node-badge w2ui-node-count">'+i.count+"</span>":"");"Leave"==e&&(s=""),this.tooltip(t,s)}if("handle"==l)if("click"==e){var r=this.handle.onClick;"function"==typeof r&&r.call(this,i,s)}else{let l=this.handle.tooltip;"function"==typeof l&&(l=l.call(this,i,s)),"Leave"==e&&(l=""),this.otherTooltip(t,l)}if("icon"==l)if("click"==e)"function"==typeof(r=this.icon.onClick)&&r.call(this,i,s);else{let l=this.icon.tooltip;"function"==typeof l&&(l=l.call(this,i,s)),"Leave"==e&&(l=""),this.otherTooltip(t,l)}if("badge"==l)if("click"==e)r=this.badge?.onClick,"function"==typeof r&&r.call(this,i,s);else{let l=this.badge?.tooltip;"function"==typeof l&&(l=l.call(this,i,s)),"Leave"==e&&(l=""),this.otherTooltip(t,l)}n?.finish()}tooltip(e,t){e=l(e).find(".w2ui-node-data"),""!==t?h.show({anchor:e.get(0),name:this.name+"_tooltip",html:t,position:"right|left"}):h.hide(this.name+"_tooltip")}otherTooltip(e,t){""!==t?h.show({anchor:e,name:this.name+"_tooltip",html:t,position:"top|bottom"}):h.hide(this.name+"_tooltip")}showPlus(e,t){l(e).find("span:nth-child(1)").css("color",t)}resize(){var e,t=Date.now(),i=this.trigger("resize",{target:this.name});if(!0!==i.isCancelled)return null!=this.box&&(e=l(this.box).get(0).getBoundingClientRect(),l(this.box).css("overflow","hidden"),l(this.box).find(":scope > div").css({width:e.width+"px",height:e.height+"px"})),i.finish(),Date.now()-t}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<l(this.box).find(".w2ui-sidebar-body").length&&this.unmount(),delete n[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}lock(e,t){var i=Array.from(arguments);i.unshift(this.box),a.lock(...i)}unlock(e){a.unlock(this.box,e)}}class f extends t{constructor(e){super(e.name),this.box=null,this.name=null,this.active=null,this.reorder=!1,this.flow="down",this.tooltip="top|left",this.tabs=[],this.routeData={},this.last={},this.right="",this.style="",this.onClick=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onMouseDown=null,this.onMouseUp=null,this.onClose=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.tab_template={id:null,text:null,route:null,hidden:!1,disabled:!1,closable:!1,tooltip:null,style:"",onClick:null,onRefresh:null,onClose:null};var t=e.tabs;delete e.tabs,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.tabs=t,"string"==typeof this.box&&(this.box=l(this.box).get(0)),this.box&&this.render(this.box)}add(e){return this.insert(null,e)}insert(e,t){Array.isArray(t)||(t=[t]);let i=[];return t.forEach((t=>{var s,l;null==t.id?console.log(`ERROR: The parameter "id" is required but not supplied. (obj: ${this.name})`):a.checkUniqueId(t.id,this.tabs,"tabs",this.name)&&(t=Object.assign({},this.tab_template,t),null==e?(this.tabs.push(t),i.push(this.animateInsert(null,t))):(s=this.get(e,!0),l=this.tabs[s].id,this.tabs.splice(s,0,t),i.push(this.animateInsert(l,t))))})),Promise.all(i)}remove(){let e=0;return Array.from(arguments).forEach((t=>{(t=this.get(t))&&(e++,this.tabs.splice(this.get(t.id,!0),1),l(this.box).find(`#tabs_${this.name}_tab_`+a.escapeId(t.id)).remove())})),this.resize(),e}select(e){return this.active!=e&&null!=this.get(e)&&(this.active=e,this.refresh(),!0)}set(e,t){var i=this.get(e,!0);return null!=i&&(a.extend(this.tabs[i],t),this.refresh(e),!0)}get(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.tabs.length;e++)null!=this.tabs[e].id&&i.push(this.tabs[e].id);return i}for(let i=0;i<this.tabs.length;i++)if(this.tabs[i].id==e)return!0===t?i:this.tabs[i];return null}show(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!1!==t.hidden&&(t.hidden=!1,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e),this.resize()}))}),15),e}hide(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!0!==t.hidden&&(t.hidden=!0,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e),this.resize()}))}),15),e}enable(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!1!==t.disabled&&(t.disabled=!1,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e)}))}),15),e}disable(){let e=[];return Array.from(arguments).forEach((t=>{(t=this.get(t))&&!0!==t.disabled&&(t.disabled=!0,e.push(t.id))})),setTimeout((()=>{e.forEach((e=>{this.refresh(e)}))}),15),e}dragMove(e){if(this.last.reordering){let o=this;var t=this.last.moving,i=this.tabs[t.index],s=d(t.index,1),n=d(t.index,-1);if(i=l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(i.id)),0<t.divX&&s){var r=l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(s.id));let h=parseInt(i.get(0).clientWidth),c=parseInt(r.get(0).clientWidth);if(h=h<c?Math.floor(h/3):Math.floor(c/3),c-=h,t.divX>c)return s=this.tabs.indexOf(s),this.tabs.splice(t.index,0,this.tabs.splice(s,1)[0]),t.$tab.before(r.get(0)),t.$tab.css("opacity",0),void Object.assign(this.last.moving,{index:s,divX:-h,x:e.pageX+h,left:t.left+t.divX+h})}if(t.divX<0&&n){r=l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(n.id));let u=parseInt(i.get(0).clientWidth),p=parseInt(r.get(0).clientWidth);u=u<p?Math.floor(u/3):Math.floor(p/3),p-=u,Math.abs(t.divX)>p&&(s=this.tabs.indexOf(n),this.tabs.splice(t.index,0,this.tabs.splice(s,1)[0]),r.before(t.$tab),t.$tab.css("opacity",0),Object.assign(t,{index:s,divX:u,x:e.pageX-u,left:t.left+t.divX-u}))}function d(e,t){e+=t;let i=o.tabs[e];return i&&i.hidden?d(e,t):i}}}mouseAction(e,t,i){var s=this.get(t),l=this.trigger("mouse"+e,{target:t,tab:s,object:s,originalEvent:i});if(!0!==l.isCancelled&&!s?.disabled&&!s?.hidden){switch(e){case"Enter":this.tooltipShow(t);break;case"Leave":this.tooltipHide(t);break;case"Down":this.initReorder(t,i)}l.finish()}}tooltipShow(e){var t=this.get(e);if(e=l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(e)).get(0),null!=this.tooltip&&!t?.disabled&&!this.last.reordering){var i=this.tooltip;let s=t?.tooltip;"function"==typeof s&&(s=s.call(this,t)),h.show({anchor:e,name:this.name+"_tooltip",html:s,position:i})}}tooltipHide(e){null!=this.tooltip&&h.hide(this.name+"_tooltip")}getTabHTML(e){if(e=this.get(e,!0),null==(e=this.tabs[e]))return!1;null==e.text&&null!=e.caption&&(e.text=e.caption),null==e.tooltip&&null!=e.hint&&(e.tooltip=e.hint),null!=e.caption&&console.log("NOTICE: tabs tab.caption property is deprecated, please use tab.text. Tab -> ",e),null!=e.hint&&console.log("NOTICE: tabs tab.hint property is deprecated, please use tab.tooltip. Tab -> ",e);let t=e.text,i=(null==(t="function"==typeof t?t.call(this,e):t)&&(t=""),""),s="";return e.hidden&&(s+="display: none;"),e.disabled&&(s+="opacity: 0.2;"),e.closable&&!e.disabled&&(i=`<div class="w2ui-tab-close w2ui-eaction ${this.active===e.id?"active":""}"\n                data-mousedown="stop" data-mouseup="clickClose|${e.id}|event">\n            </div>`),`\n            <div id="tabs_${this.name}_tab_${e.id}" style="${s} ${e.style}"\n                class="w2ui-tab w2ui-eaction ${this.active===e.id?"active":""} ${e.closable?"closable":""} ${e.class||""}"\n                data-mouseenter="mouseAction|Enter|${e.id}|event]"\n                data-mouseleave="mouseAction|Leave|${e.id}|event]"\n                data-mousedown="mouseAction|Down|${e.id}|event"\n                data-mouseup="mouseAction|Up|${e.id}|event"\n                data-click="click|${e.id}|event"\n               >\n                    ${a.lang(t)+i}\n            </div>`}refresh(e){var t=Date.now(),i=("up"==this.flow?l(this.box).addClass("w2ui-tabs-up"):l(this.box).removeClass("w2ui-tabs-up"),this.trigger("refresh",{target:null!=e?e:this.name,object:this.get(e)}));if(!0!==i.isCancelled){if(null==e)for(let e=0;e<this.tabs.length;e++)this.refresh(this.tabs[e].id);else{var s="#tabs_"+this.name+"_tab_"+a.escapeId(e),n=l(this.box).find(s);e=this.getTabHTML(e),0===n.length?l(this.box).find("#tabs_"+this.name+"_right").before(e):0==l(this.box).find(".tab-animate-insert").length&&n.replace(e),a.bindEvents(l(this.box).find(s+`, ${s} .w2ui-eaction`),this)}return l(this.box).find("#tabs_"+this.name+"_right").html(this.right),i.finish(),Date.now()-t}}render(e){var t=Date.now(),i=("string"==typeof e&&(e=l(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==i.isCancelled)return null!=e&&(this.unmount(),this.box=e),!!this.box&&(e=`\n            <div class="w2ui-tabs-line"></div>\n            <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">\n                <div id="tabs_${this.name}_right" class="w2ui-tabs-right">${this.right}</div>\n            </div>\n            <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll","left"]'></div>\n            <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll","right"]'></div>`,l(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-tabs").html(e),0<l(this.box).length&&(l(this.box)[0].style.cssText+=this.style),a.bindEvents(l(this.box).find(".w2ui-eaction"),this),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),i.finish(),this.refresh(),this.resize(),Date.now()-t)}initReorder(e,t){if(this.reorder){let i,s=this,n=l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(e)),r=this.get(e,!0),o=l(n.get(0).cloneNode(!0));o.attr("id","#tabs_"+this.name+"_tab_ghost"),this.last.moving={index:r,indexFrom:r,$tab:n,$ghost:o,divX:0,left:n.get(0).getBoundingClientRect().left,parentX:l(this.box).get(0).getBoundingClientRect().left,x:t.pageX,opacity:n.css("opacity")},l(document).off(".w2uiTabReorder").on("mousemove.w2uiTabReorder",(function(e){if(!s.last.reordering){if(!0===(i=s.trigger("reorder",{target:s.tabs[r].id,indexFrom:r,tab:s.tabs[r]})).isCancelled)return;h.hide(this.name+"_tooltip"),s.last.reordering=!0,o.addClass("moving"),o.css({"pointer-events":"none",position:"absolute",left:n.get(0).getBoundingClientRect().left}),n.css("opacity",0),l(s.box).find(".w2ui-scroll-wrapper").append(o.get(0)),l(s.box).find(".w2ui-tab-close").hide()}s.last.moving.divX=e.pageX-s.last.moving.x,o.css("left",s.last.moving.left-s.last.moving.parentX+s.last.moving.divX+"px"),s.dragMove(e)})).on("mouseup.w2uiTabReorder",(function(){l(document).off(".w2uiTabReorder"),o.css({transition:"0.1s",left:s.last.moving.$tab.get(0).getBoundingClientRect().left-s.last.moving.parentX}),l(s.box).find(".w2ui-tab-close").show(),o.remove(),n.css({opacity:s.last.moving.opacity}),s.last.reordering&&i.finish({indexTo:s.last.moving.index}),s.last.reordering=!1}))}}scroll(e,t){return new Promise(((i,s)=>{var n=l(this.box).find(".w2ui-scroll-wrapper"),a=n.get(0).scrollLeft,r=n.find(".w2ui-tabs-right").get(0),o=n.parent().get(0).getBoundingClientRect().width,d=a+parseInt(r.offsetLeft)+parseInt(r.clientWidth);switch(e){case"left":{let e=a-o+50;e<=0&&(e=0),n.get(0).scrollTo({top:0,left:e,behavior:t?"atuo":"smooth"});break}case"right":{let e=a+o-50;e>=d-o&&(e=d-o),n.get(0).scrollTo({top:0,left:e,behavior:t?"atuo":"smooth"});break}}setTimeout((()=>{this.resize(),i()}),t?0:350)}))}scrollIntoView(e,t){return new Promise(((i,s)=>{null==e&&(e=this.active),null!=this.get(e)&&(l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(e)).get(0).scrollIntoView({block:"start",inline:"center",behavior:t?"atuo":"smooth"}),setTimeout((()=>{this.resize(),i()}),t?0:500))}))}resize(){var e=Date.now();if(null!=this.box){var t,i,s,n,a=this.trigger("resize",{target:this.name});if(!0!==a.isCancelled)return null!=this.box&&((t=l(this.box)).find(".w2ui-scroll-left, .w2ui-scroll-right").hide(),i=t.find(".w2ui-scroll-wrapper").get(0),n=t.find(".w2ui-tabs-right"),(s=t.get(0).getBoundingClientRect().width)<(n=0<n.length?n[0].offsetLeft+n[0].clientWidth:0))&&(0<i.scrollLeft&&t.find(".w2ui-scroll-left").show(),s<n-i.scrollLeft)&&t.find(".w2ui-scroll-right").show(),a.finish(),Date.now()-e}}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<l(this.box).find("#tabs_"+this.name+"_right").length&&this.unmount(),delete n[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}click(e,t){var i=this.get(e);if(null==i||i.disabled||this.last.reordering)return!1;if(!0!==(e=this.trigger("click",{target:e,tab:i,object:i,originalEvent:t})).isCancelled){if(l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(this.active)).removeClass("active"),this.active=i.id,l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(this.active)).addClass("active"),"string"==typeof i.route){let e=""!==i.route?String("/"+i.route).replace(/\/{2,}/g,"/"):"";var s=a.parseRoute(e);if(0<s.keys.length)for(let t=0;t<s.keys.length;t++)null!=this.routeData[s.keys[t].name]&&(e=e.replace(new RegExp(":"+s.keys[t].name,"g"),this.routeData[s.keys[t].name]));setTimeout((()=>{window.location.hash=e}),1)}e.finish()}}clickClose(e,t){var i=this.get(e);if(null==i||i.disabled)return!1;let s=this.trigger("close",{target:e,object:i,tab:i,originalEvent:t});!0!==s.isCancelled&&(this.animateClose(e).then((()=>{this.remove(e),s.finish(),this.refresh()})),t)&&t.stopPropagation()}animateClose(e){return new Promise(((t,i)=>{var s=l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(e)),n=parseInt(s.get(0).clientWidth||0);let r=s.replace(`<div class="tab-animate-close" style="display: inline-block; flex-shrink: 0; width: ${n}px; transition: width 0.25s"></div>`);setTimeout((()=>{r.css({width:"0px"})}),1),setTimeout((()=>{r.remove(),this.resize(),t()}),500)}))}animateInsert(e,t){return new Promise(((i,s)=>{let n=l(this.box).find("#tabs_"+this.name+"_tab_"+a.escapeId(e)),r=l.html(this.getTabHTML(t.id));if(0==n.length)(n=l(this.box).find("#tabs_tabs_right")).before(r),this.resize();else{r.css({opacity:0}),l(this.box).find("#tabs_tabs_right").before(r.get(0));let e=l(this.box).find("#"+r.attr("id")).get(0)?.clientWidth??0,s=l.html('<div class="tab-animate-insert" style="flex-shrink: 0; width: 0; transition: width 0.25s"></div>');n.before(s),r.hide(),s.before(r[0]),setTimeout((()=>{s.css({width:e+"px"})}),1),setTimeout((()=>{s.remove(),r.css({opacity:1}).show(),this.refresh(t.id),this.resize(),i()}),500)}}))}}let b=["top","left","main","preview","right","bottom"];class v extends t{constructor(e){super(e.name),this.box=null,this.name=null,this.panels=[],this.last={},this.padding=1,this.resizer=4,this.style="",this.onShow=null,this.onHide=null,this.onResizing=null,this.onResizerClick=null,this.onRender=null,this.onRefresh=null,this.onChange=null,this.onResize=null,this.onDestroy=null,this.panel_template={type:null,title:"",size:100,minSize:20,maxSize:!1,hidden:!1,resizable:!1,overflow:"auto",style:"",html:"",tabs:null,toolbar:null,width:null,height:null,show:{toolbar:!1,tabs:!1},removed:null,onRefresh:null,onShow:null,onHide:null},Object.assign(this,e),Array.isArray(this.panels)||(this.panels=[]),this.panels.forEach(((e,t)=>{var i,s,l;this.panels[t]=a.extend({},this.panel_template,e),(a.isPlainObject(e.tabs)||Array.isArray(e.tabs))&&function(e,t,i){var s=e.get(t);if(null!=s&&null==i&&(i=s.tabs),null!=s&&null!=i){Array.isArray(i)&&(i={tabs:i});var l=e.name+"_"+t+"_tabs";n[l]&&n[l].destroy(),s.tabs=new f(a.extend({},i,{owner:e,name:e.name+"_"+t+"_tabs"})),s.show.tabs=!0}}(this,e.type),(a.isPlainObject(e.toolbar)||Array.isArray(e.toolbar))&&(t=this,e=e.type,i=void 0,null!=(s=t.get(e))&&null==i&&(i=s.toolbar),null!=s)&&null!=i&&(Array.isArray(i)&&(i={items:i}),l=t.name+"_"+e+"_toolbar",n[l]&&n[l].destroy(),s.toolbar=new m(a.extend({},i,{owner:t,name:t.name+"_"+e+"_toolbar"})),s.show.toolbar=!0)})),b.forEach((e=>{null==this.get(e)&&this.panels.push(a.extend({},this.panel_template,{type:e,hidden:"main"!==e,size:50}))})),"string"==typeof this.box&&(this.box=l(this.box).get(0)),this.box&&this.render(this.box)}html(e,t,i){let s=this.get(e);var n={panel:e,html:s.html,error:!1,cancelled:!1,removed(e){"function"==typeof e&&(s.removed=e)}};if("function"==typeof s.removed&&(s.removed({panel:e,html:s.html,html_new:t,transition:i||"none"}),s.removed=null),"css"==e)l(this.box).find("#layout_"+this.name+"_panel_css").html("<style>"+t+"</style>"),n.status=!0;else if(null==s)console.log("ERROR: incorrect panel name. Panel name can be main, left, right, top, bottom, preview or css"),n.error=!0;else if(null!=t){var r=this.trigger("change",{target:e,panel:s,html_new:t,transition:i});if(!0===r.isCancelled)n.cancelled=!0;else{let n="#layout_"+this.name+"_panel_"+s.type;var o=l(this.box).find(n+'> [data-role="panel-content"]');let d=0;if(0<o.length&&(l(this.box).find(n).get(0).scrollTop=0,d=l(o).css("top")),"function"==typeof s.html.unmount&&s.html.unmount(),o.addClass("w2ui-panel-content"),o.removeAttr("style"),this.resizeBoxes(e),""===s.html)s.html=t,this.refresh(e);else if(s.html=t,!s.hidden)if(null!=i&&""!==i){l(this.box).addClass("animating");let r=l(this.box).find(n+'> [data-role="panel-content"]'),o=(r.after('<div class="w2ui-panel-content new-panel" data-role="panel-content" style="'+r[0].style.cssText+'"></div>'),l(this.box).find(n+'> [data-role="panel-content"].new-panel'));r.css("top",d),o.css("top",d),"object"==typeof t?(t.box=o[0],t.render()):o.hide().html(t),a.transition(r[0],o[0],i,(()=>{r.remove(),o.removeClass("new-panel"),o.css("overflow",s.overflow),l(l(this.box).find(n+'> [data-role="panel-content"]').get(1)).remove(),l(this.box).removeClass("animating"),this.refresh(e)}))}else this.refresh(e);r.finish()}}return n}message(e,t){var i=this.get(e);let s=l(this.box).find("#layout_"+this.name+"_panel_"+i.type),n=s.css("overflow");return s.css("overflow","hidden"),(i=a.message({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t))&&i.self.on("close:after",(()=>{s.css("overflow",n)})),i}confirm(e,t){var i=this.get(e);let s=l(this.box).find("#layout_"+this.name+"_panel_"+i.type),n=s.css("overflow");return s.css("overflow","hidden"),(i=a.confirm({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t))&&i.self.on("close:after",(()=>{s.css("overflow",n)})),i}load(e,t,i){return new Promise(((s,l)=>{"css"!=e&&null==this.get(e)||null==t?l():fetch(t).then((e=>e.text())).then((t=>{this.resize(),s(this.html(e,t,i))}))}))}sizeTo(e,t,i){return null!=this.get(e)&&(l(this.box).find(":scope > div > .w2ui-panel").css("transition",!0!==i?".2s":"0s"),setTimeout((()=>{this.set(e,{size:t})}),1),setTimeout((()=>{l(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),this.resize()}),300),!0)}show(e,t){let i=this.trigger("show",{target:e,thisect:this.get(e),immediate:t});var s;if(!0!==i.isCancelled)return null!=(s=this.get(e))&&(!(s.hidden=!1)===t?(l(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"1"}),i.finish(),this.resize()):(l(this.box).addClass("animating"),l(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),l(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),setTimeout((()=>{this.resize()}),1),setTimeout((()=>{l(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"1"})}),250),setTimeout((()=>{l(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),l(this.box).removeClass("animating"),i.finish(),this.resize()}),300)),!0)}hide(e,t){let i=this.trigger("hide",{target:e,object:this.get(e),immediate:t});var s;if(!0!==i.isCancelled)return null!=(s=this.get(e))&&((s.hidden=!0)===t?(l(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),i.finish(),this.resize()):(l(this.box).addClass("animating"),l(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),l(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),setTimeout((()=>{this.resize()}),1),setTimeout((()=>{l(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),l(this.box).removeClass("animating"),i.finish(),this.resize()}),300)),!0)}toggle(e,t){var i=this.get(e);return null!=i&&(i.hidden?this.show(e,t):this.hide(e,t))}set(e,t){var i=this.get(e,!0);return null!=i&&(a.extend(this.panels[i],t),null==t.html&&null==t.resizable||this.refresh(e),this.resize(),!0)}get(e,t){for(let i=0;i<this.panels.length;i++)if(this.panels[i].type==e)return!0===t?i:this.panels[i];return null}el(e){return 1!=(e=l(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-content"]')).length?null:e[0]}hideToolbar(e){var t=this.get(e);t&&(t.show.toolbar=!1,l(this.box).find(`#layout_${this.name}_panel_${e} > [data-role="panel-toolbar"]`).hide(),this.resize())}showToolbar(e){var t=this.get(e);t&&(t.show.toolbar=!0,l(this.box).find(`#layout_${this.name}_panel_${e} > [data-role="panel-toolbar"]`).show(),this.resize())}toggleToolbar(e){var t=this.get(e);t&&(t.show.toolbar?this.hideToolbar(e):this.showToolbar(e))}assignToolbar(e,t){"string"==typeof t&&null!=n[t]&&(t=n[t]);var i=this.get(e),s=(i.toolbar=t,l(this.box).find(e+'> [data-role="panel-toolbar"]'));null!=i.toolbar?(s.attr("name")!=i.toolbar.name?i.toolbar.render(s.get(0)):null!=i.toolbar&&i.toolbar.refresh(),(t.owner=this).showToolbar(e),this.refresh(e)):(s.html(""),this.hideToolbar(e))}hideTabs(e){var t=this.get(e);t&&(t.show.tabs=!1,l(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-tabs"]').hide(),this.resize())}showTabs(e){var t=this.get(e);t&&(t.show.tabs=!0,l(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-tabs"]').show(),this.resize())}toggleTabs(e){var t=this.get(e);t&&(t.show.tabs?this.hideTabs(e):this.showTabs(e))}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=l(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled){if(null!=e&&(this.unmount(),this.box=e),!this.box)return!1;l(this.box).attr("name",this.name).addClass("w2ui-layout").html("<div></div>"),0<l(this.box).length&&(l(this.box)[0].style.cssText+=this.style);for(let e=0;e<b.length;e++){var n='<div id="layout_'+this.name+"_panel_"+b[e]+'" class="w2ui-panel">    <div class="w2ui-panel-title"></div>    <div class="w2ui-panel-tabs" data-role="panel-tabs"></div>    <div class="w2ui-panel-toolbar" data-role="panel-toolbar"></div>    <div class="w2ui-panel-content" data-role="panel-content"></div></div><div id="layout_'+this.name+"_resizer_"+b[e]+'" class="w2ui-resizer"></div>';l(this.box).find(":scope > div").append(n)}return l(this.box).find(":scope > div").append('<div id="layout_'+this.name+'_panel_css" style="position: absolute; top: 10000px;"></div>'),this.refresh(),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),s.finish(),setTimeout((()=>{i.last.events={resizeStart:r,mouseMove:d,mouseUp:o},this.resize()}),0),Date.now()-t}function r(e,t){i.box&&(t=t||window.event,l(document).off("mousemove",i.last.events.mouseMove).on("mousemove",i.last.events.mouseMove),l(document).off("mouseup",i.last.events.mouseUp).on("mouseup",i.last.events.mouseUp),i.last.resize={type:e,x:t.screenX,y:t.screenY,diff_x:0,diff_y:0,value:0},b.forEach((e=>{var t=l(i.el(e)).find(".w2ui-lock");0<t.length?t.data("locked","yes"):i.lock(e,{opacity:0})})),t=l(i.box).find("#layout_"+i.name+"_resizer_"+e).get(0),"left"!=e&&"right"!=e||(i.last.resize.value=parseInt(t.style.left)),"top"!=e&&"preview"!=e&&"bottom"!=e||(i.last.resize.value=parseInt(t.style.top)))}function o(e){if(i.box&&(e=e||window.event,l(document).off("mousemove",i.last.events.mouseMove),l(document).off("mouseup",i.last.events.mouseUp),null!=i.last.resize)){if(b.forEach((e=>{var t=l(i.el(e)).find(".w2ui-lock");"yes"==t.data("locked")?t.removeData("locked"):i.unlock(e)})),0!==i.last.diff_x||0!==i.last.resize.diff_y){var t=i.get("top"),s=i.get("bottom"),n=i.get(i.last.resize.type),r=(e=a.getSize(l(i.box),"width"),a.getSize(l(i.box),"height")),o=String(n.size);let d,h;switch(i.last.resize.type){case"top":d=parseInt(n.sizeCalculated)+i.last.resize.diff_y,h=0;break;case"bottom":d=parseInt(n.sizeCalculated)-i.last.resize.diff_y,h=0;break;case"preview":d=parseInt(n.sizeCalculated)-i.last.resize.diff_y,h=(t&&!t.hidden?t.sizeCalculated:0)+(s&&!s.hidden?s.sizeCalculated:0);break;case"left":d=parseInt(n.sizeCalculated)+i.last.resize.diff_x,h=0;break;case"right":d=parseInt(n.sizeCalculated)-i.last.resize.diff_x,h=0}"%"==o.substr(o.length-1)?n.size=Math.floor(100*d/("left"==n.type||"right"==n.type?e:r-h)*100)/100+"%":"-"==String(n.size).substr(0,1)?n.size=parseInt(n.size)-n.sizeCalculated+d:n.size=d,i.resize()}l(i.box).find("#layout_"+i.name+"_resizer_"+i.last.resize.type).removeClass("active"),delete i.last.resize}}function d(e){if(i.box&&(e=e||window.event,null!=i.last.resize)){var t=i.get(i.last.resize.type),s=i.last.resize,n=i.trigger("resizing",{target:i.name,object:t,originalEvent:e,panel:s?s.type:"all",diff_x:s?s.diff_x:0,diff_y:s?s.diff_y:0});if(!0!==n.isCancelled){var a=l(i.box).find("#layout_"+i.name+"_resizer_"+s.type);let o=e.screenX-s.x,d=e.screenY-s.y;var r=i.get("main");switch(a.hasClass("active")||a.addClass("active"),s.type){case"left":t.minSize-o>t.width&&(o=t.minSize-t.width),t.maxSize&&t.width+o>t.maxSize&&(o=t.maxSize-t.width),r.minSize+o>r.width&&(o=r.width-r.minSize);break;case"right":t.minSize+o>t.width&&(o=t.width-t.minSize),t.maxSize&&t.width-o>t.maxSize&&(o=t.width-t.maxSize),r.minSize-o>r.width&&(o=r.minSize-r.width);break;case"top":t.minSize-d>t.height&&(d=t.minSize-t.height),t.maxSize&&t.height+d>t.maxSize&&(d=t.maxSize-t.height),r.minSize+d>r.height&&(d=r.height-r.minSize);break;case"preview":case"bottom":t.minSize+d>t.height&&(d=t.height-t.minSize),t.maxSize&&t.height-d>t.maxSize&&(d=t.height-t.maxSize),r.minSize-d>r.height&&(d=r.minSize-r.height)}switch(s.diff_x=o,s.diff_y=d,s.type){case"top":case"preview":case"bottom":(s.diff_x=0)<a.length&&(a[0].style.top=s.value+s.diff_y+"px");break;case"left":case"right":(s.diff_y=0)<a.length&&(a[0].style.left=s.value+s.diff_x+"px")}n.finish()}}}}unmount(){super.unmount(),this.panels.forEach((e=>{e.tabs?.unmount?.(),e.toolbar?.unmount?.()})),this.last.observeResize?.disconnect()}destroy(){var e=this.trigger("destroy",{target:this.name});if(!0!==e.isCancelled)return null!=n[this.name]&&(this.panels.forEach((e=>{e.tabs?.destroy?.(),e.toolbar?.destroy?.()})),0<l(this.box).find("#layout_"+this.name+"_panel_main").length&&this.unmount(),delete n[this.name],e.finish(),this.last.events&&this.last.events.resize&&l(window).off("resize",this.last.events.resize),!0)}refresh(e){let t=this;null==e&&(e=null);var i=Date.now(),s=t.trigger("refresh",{target:null!=e?e:t.name,object:t.get(e)});if(!0!==s.isCancelled){if("string"==typeof e){let i=t.get(e);if(null==i)return;let s="#layout_"+t.name+"_panel_"+i.type;e="#layout_"+t.name+"_resizer_"+i.type,l(t.box).find(s).css({display:i.hidden?"none":"block"}),i.resizable?l(t.box).find(e).show():l(t.box).find(e).hide(),"object"==typeof i.html&&"function"==typeof i.html.render?(i.html.box=l(t.box).find(s+'> [data-role="panel-content"]')[0],setTimeout((()=>{0<l(t.box).find(s+'> [data-role="panel-content"]').length&&(l(t.box).find(s+'> [data-role="panel-content"]').removeClass().removeAttr("name").addClass("w2ui-panel-content").css("overflow",i.overflow)[0].style.cssText+=";"+i.style),i.html&&"function"==typeof i.html.render&&i.html.render()}),1)):0<l(t.box).find(s+'> [data-role="panel-content"]').length&&(l(t.box).find(s+'> [data-role="panel-content"]').removeClass().removeAttr("name").addClass("w2ui-panel-content").html(i.html).css("overflow",i.overflow)[0].style.cssText+=";"+i.style);let n=l(t.box).find(s+'> [data-role="panel-tabs"]');i.show.tabs?(n.attr("name")!=i.tabs.name&&null!=i.tabs?i.tabs.render(n.get(0)):i.tabs.refresh(),n.addClass("w2ui-panel-tabs")):n.html("").removeAttr("name").removeClass("w2ui-tabs").hide(),n=l(t.box).find(s+'> [data-role="panel-toolbar"]'),i.show.toolbar?(n.attr("name")!=i.toolbar.name&&null!=i.toolbar?i.toolbar.render(n.get(0)):i.toolbar.refresh(),n.addClass("w2ui-panel-toolbar")):n.html("").removeAttr("name").removeClass("w2ui-toolbar").hide(),n=l(t.box).find(s+"> .w2ui-panel-title"),i.title?n.html(i.title).show():n.html("").hide()}else{if(0===l(t.box).find("#layout_"+t.name+"_panel_main").length)return void t.render();t.resize();for(let e=0;e<this.panels.length;e++)t.refresh(this.panels[e].type)}return s.finish(),Date.now()-i}}resize(){if(!this.box)return!1;var e=Date.now();let t=this.last.resize;var i=this.trigger("resize",{target:this.name,panel:t?t.type:"all",diff_x:t?t.diff_x:0,diff_y:t?t.diff_y:0});if(!0!==i.isCancelled){this.padding<0&&(this.padding=0);var s=a.getSize(l(this.box),"width"),r=a.getSize(l(this.box),"height");let x=this;var o=this.get("main"),d=this.get("preview"),h=this.get("left"),c=this.get("right"),u=this.get("top"),p=this.get("bottom"),m=null!=d&&!0!==d.hidden,g=null!=h&&!0!==h.hidden,f=null!=c&&!0!==c.hidden,v=null!=u&&!0!==u.hidden,y=null!=p&&!0!==p.hidden;let _,k,C,S;for(let e=0;e<b.length;e++)if("main"!==b[e]&&(t=this.get(b[e]))){var w=String(t.size||0);if("%"==w.substr(w.length-1)){let e=r;"preview"==t.type&&(e=e-(u&&!u.hidden?u.sizeCalculated:0)-(p&&!p.hidden?p.sizeCalculated:0)),t.sizeCalculated=parseInt(("left"==t.type||"right"==t.type?s:e)*parseFloat(t.size)/100)}else t.sizeCalculated=parseInt(t.size);t.sizeCalculated=Math.max(t.sizeCalculated,parseInt(t.minSize))}return"-"==String(c.size).substr(0,1)&&(g&&"-"==String(h.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):c.sizeCalculated=s-(g?h.sizeCalculated:0)+parseInt(c.size)),"-"==String(h.size).substr(0,1)&&(f&&"-"==String(c.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):h.sizeCalculated=s-(f?c.sizeCalculated:0)+parseInt(h.size)),null!=u&&!0!==u.hidden?(_=0,k=0,C=s,S=u.sizeCalculated,l(this.box).find("#layout_"+this.name+"_panel_top").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px"}),u.width=C,u.height=S,u.resizable&&(k=u.sizeCalculated-(0===this.padding?this.resizer:0),S=this.resizer>this.padding?this.resizer:this.padding,l(this.box).find("#layout_"+this.name+"_resizer_top").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=x.trigger("resizerClick",{target:"top",originalEvent:e});if(!0!==t.isCancelled)return n[x.name].last.events.resizeStart("top",e),t.finish(),!1})))):(l(this.box).find("#layout_"+this.name+"_panel_top").hide(),l(this.box).find("#layout_"+this.name+"_resizer_top").hide()),null!=h&&!0!==h.hidden?(_=0,k=0+(v?u.sizeCalculated+this.padding:0),C=h.sizeCalculated,S=r-(v?u.sizeCalculated+this.padding:0)-(y?p.sizeCalculated+this.padding:0),l(this.box).find("#layout_"+this.name+"_panel_left").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px"}),h.width=C,h.height=S,h.resizable&&(_=h.sizeCalculated-(0===this.padding?this.resizer:0),C=this.resizer>this.padding?this.resizer:this.padding,l(this.box).find("#layout_"+this.name+"_resizer_left").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=x.trigger("resizerClick",{target:"left",originalEvent:e});if(!0!==t.isCancelled)return n[x.name].last.events.resizeStart("left",e),t.finish(),!1})))):(l(this.box).find("#layout_"+this.name+"_panel_left").hide(),l(this.box).find("#layout_"+this.name+"_resizer_left").hide()),null!=c&&!0!==c.hidden?(_=s-c.sizeCalculated,k=0+(v?u.sizeCalculated+this.padding:0),C=c.sizeCalculated,S=r-(v?u.sizeCalculated+this.padding:0)-(y?p.sizeCalculated+this.padding:0),l(this.box).find("#layout_"+this.name+"_panel_right").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px"}),c.width=C,c.height=S,c.resizable&&(_-=this.padding,C=this.resizer>this.padding?this.resizer:this.padding,l(this.box).find("#layout_"+this.name+"_resizer_right").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=x.trigger("resizerClick",{target:"right",originalEvent:e});if(!0!==t.isCancelled)return n[x.name].last.events.resizeStart("right",e),t.finish(),!1})))):(l(this.box).find("#layout_"+this.name+"_panel_right").hide(),l(this.box).find("#layout_"+this.name+"_resizer_right").hide()),null!=p&&!0!==p.hidden?(_=0,k=r-p.sizeCalculated,C=s,S=p.sizeCalculated,l(this.box).find("#layout_"+this.name+"_panel_bottom").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px"}),p.width=C,p.height=S,p.resizable&&(k-=0===this.padding?0:this.padding,S=this.resizer>this.padding?this.resizer:this.padding,l(this.box).find("#layout_"+this.name+"_resizer_bottom").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=x.trigger("resizerClick",{target:"bottom",originalEvent:e});if(!0!==t.isCancelled)return n[x.name].last.events.resizeStart("bottom",e),t.finish(),!1})))):(l(this.box).find("#layout_"+this.name+"_panel_bottom").hide(),l(this.box).find("#layout_"+this.name+"_resizer_bottom").hide()),_=0+(g?h.sizeCalculated+this.padding:0),k=0+(v?u.sizeCalculated+this.padding:0),C=s-(g?h.sizeCalculated+this.padding:0)-(f?c.sizeCalculated+this.padding:0),S=r-(v?u.sizeCalculated+this.padding:0)-(y?p.sizeCalculated+this.padding:0)-(m?d.sizeCalculated+this.padding:0),l(this.box).find("#layout_"+this.name+"_panel_main").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px"}),o.width=C,o.height=S,null!=d&&!0!==d.hidden?(_=0+(g?h.sizeCalculated+this.padding:0),k=r-(y?p.sizeCalculated+this.padding:0)-d.sizeCalculated,C=s-(g?h.sizeCalculated+this.padding:0)-(f?c.sizeCalculated+this.padding:0),S=d.sizeCalculated,l(this.box).find("#layout_"+this.name+"_panel_preview").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px"}),d.width=C,d.height=S,d.resizable&&(k-=0===this.padding?0:this.padding,S=this.resizer>this.padding?this.resizer:this.padding,l(this.box).find("#layout_"+this.name+"_resizer_preview").css({display:"block",left:_+"px",top:k+"px",width:C+"px",height:S+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",(function(e){e.preventDefault();var t=x.trigger("resizerClick",{target:"preview",originalEvent:e});if(!0!==t.isCancelled)return n[x.name].last.events.resizeStart("preview",e),t.finish(),!1})))):(l(this.box).find("#layout_"+this.name+"_panel_preview").hide(),l(this.box).find("#layout_"+this.name+"_resizer_preview").hide()),this.resizeBoxes(),i.finish(),Date.now()-e}}resizeBoxes(e){let t=b;(t=e||"string"!=typeof e?b:[e]).forEach(((e,t)=>{var i;t=this.get(b[t]),e=`#layout_${this.name}_panel_${e} > `;let s=0;t&&(t.title&&(i=l(this.box).find(e+".w2ui-panel-title").css({top:s+"px",display:"block"}),s+=a.getSize(i,"height")),t.show.tabs&&(i=l(this.box).find(e+'[data-role="panel-tabs"]').css({top:s+"px",display:"block"}),s+=a.getSize(i,"height")),t.show.toolbar)&&(i=l(this.box).find(e+'[data-role="panel-toolbar"]').css({top:s+"px",display:"block"}),s+=a.getSize(i,"height")),l(this.box).find(e+'[data-role="panel-content"]').css({display:"block",top:s+"px"})}))}lock(e,t,i){var s;-1==b.indexOf(e)?console.log("ERROR: First parameter needs to be the a valid panel name."):((s=Array.from(arguments))[0]="#layout_"+this.name+"_panel_"+e,a.lock(...s))}unlock(e,t){-1==b.indexOf(e)?console.log("ERROR: First parameter needs to be the a valid panel name."):(e="#layout_"+this.name+"_panel_"+e,a.unlock(e,t))}}class y extends t{constructor(e){super(e.name),this.name=null,this.header="",this.box=null,this.url="",this.method=null,this.routeData={},this.formURL="",this.formHTML="",this.page=0,this.pageStyle="",this.recid=null,this.fields=[],this.actions={},this.record={},this.original=null,this.dataType=null,this.postData={},this.httpHeaders={},this.toolbar={},this.tabs={},this.style="",this.focus=0,this.autosize=!0,this.nestedFields=!0,this.tabindexBase=0,this.isGenerated=!1,this.last={fetchCtrl:null,fetchOptions:null,errors:[]},this.onRequest=null,this.onLoad=null,this.onValidate=null,this.onSubmit=null,this.onProgress=null,this.onSave=null,this.onChange=null,this.onInput=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onAction=null,this.onToolbar=null,this.onError=null,this.msgRefresh="Loading...",this.msgSaving="Saving...",this.msgServerError="Server error",this.ALL_TYPES=["text","textarea","email","pass","password","int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","toggle","checkbox","radio","check","checks","list","combo","enum","file","select","switch","map","array","div","custom","html","empty"],this.LIST_TYPES=["select","radio","check","checks","list","combo","enum","switch"],this.W2FIELD_TYPES=["int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","list","combo","enum","file"],a.extend(this,e);var t,i,s=e.record,n=e.original,r=e.fields,o=e.toolbar;let d=e.tabs;if(Object.assign(this,{record:{},original:null,fields:[],tabs:{},toolbar:{},handlers:[]}),r&&(e=function e(t){let i=[],s=[];if(a.isPlainObject(t)){let l=t;function n(e){let t=["html"];return null==e.html&&(e.html={}),Object.keys(e).forEach((i=>{-1==t.indexOf(i)&&-1!=["label","attr","style","text","span","page","column","anchor","group","groupStyle","groupTitleStyle","groupCollapsible"].indexOf(i)&&(e.html[i]=e[i],delete e[i])})),e}function r(e,t){let i=["style","html"];Object.keys(e).forEach((s=>{-1==i.indexOf(s)&&-1!=["span","column","attr","text","label"].indexOf(s)&&e[s]&&!t.html[s]&&(t.html[s]=e[s])}))}t=[],Object.keys(l).forEach((i=>{let o=l[i];if("group"==o.type){if(o.text=i,a.isPlainObject(o.fields)){let e=o.fields;o.fields=[],Object.keys(e).forEach((t=>{let i=e[t];i.field=t,o.fields.push(n(i))}))}t.push(o)}else if("tab"==o.type){let l={id:i,text:i},n=(o.style&&(l.style=o.style),s.push(l),e(o.fields).fields);n.forEach((e=>{e.html=e.html||{},e.html.page=s.length-1,r(o,e)})),t.push(...n)}else o.field=i,t.push(n(o))}))}return t.forEach((e=>{if("group"==e.type){let t={group:e.text||"",groupStyle:e.style||"",groupTitleStyle:e.titleStyle||"",groupCollapsible:!0===e.collapsible};Array.isArray(e.fields)&&e.fields.forEach((s=>{let l=a.clone(s);null==l.html&&(l.html={}),a.extend(l.html,t),Array("span","column","attr","label","page").forEach((t=>{null==l.html[t]&&null!=e[t]&&(l.html[t]=e[t])})),null==l.field&&null!=l.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",e),l.field=l.name),i.push(l)}))}else{let t=a.clone(e);null==t.field&&null!=t.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",e),t.field=t.name),i.push(t)}})),{fields:i,tabs:s}}(r),this.fields=e.fields,!d)&&0<e.tabs.length&&(d=e.tabs),Array.isArray(d)){a.extend(this.tabs,{tabs:[]});for(let e=0;e<d.length;e++){var h=d[e];"object"==typeof h?(this.tabs.tabs.push(h),!0===h.active&&(this.tabs.active=h.id)):this.tabs.tabs.push({id:h,text:h})}}else a.extend(this.tabs,d);for(t in a.extend(this.toolbar,o),s)a.isPlainObject(s[t])?this.record[t]=a.clone(s[t]):this.record[t]=s[t];for(i in n)a.isPlainObject(n[i])?this.original[i]=a.clone(n[i]):this.original[i]=n[i];""!==this.formURL?fetch(this.formURL).then((e=>e.text())).then((e=>{this.formHTML=e,this.isGenerated=!0,this.box&&this.render(this.box)})):this.formURL||this.formHTML?this.formHTML&&(this.isGenerated=!0):(this.formHTML=this.generateHTML(),this.isGenerated=!0),"string"==typeof this.box&&(this.box=l(this.box).get(0)),this.box&&this.render(this.box)}get(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.fields.length;e++)null!=this.fields[e].field&&i.push(this.fields[e].field);return i}for(let i=0;i<this.fields.length;i++)if(this.fields[i].field==e)return!0===t?i:this.fields[i];return null}set(e,t){for(let i=0;i<this.fields.length;i++)if(this.fields[i].field==e)return a.extend(this.fields[i],t),delete this.fields[i].w2field,this.refresh(e),!0;return!1}getValue(e,t){if(this.nestedFields){let s;try{var i=!0===t?this.original:this.record;s=String(e).split(".").reduce(((e,t)=>e[t]),i)}catch(e){}return s}return this.record[e]}setValue(e,t,i){if((""===t||null==t||Array.isArray(t)&&0===t.length||a.isPlainObject(t)&&0==Object.keys(t).length)&&(t=null),!this.nestedFields)return this.record[e]=t,i||this.setFieldValue(e,t),!0;try{let s=this.record;return String(e).split(".").map(((e,i,l)=>{l.length-1!==i?s=s[e]||(s[e]={},s[e]):s[e]=t})),i||this.setFieldValue(e,t),!0}catch(e){return!1}}getFieldValue(e){let t=this.get(e);if(null!=t){var i=t.el;let o=this.getValue(e);var s;e=this.getValue(e,!0);let d=i.value;if(!["int","float","percent","money","currency"].includes(t.type)||"int"!=t.type&&"."==d[d.length-1]||(d=t.w2field.clean(d)),["radio"].includes(t.type)&&(s=l(i).closest("div").find("input:checked").get(0),d=s?t.options.items[l(s).data("index")].id:null),["toggle","checkbox"].includes(t.type)&&(d=i.checked),-1!==["check","checks"].indexOf(t.type)&&(d=[],0<(s=l(i).closest("div").find("input:checked")).length&&s.each((e=>{e=t.options.items[l(e).data("index")],d.push(e.id)})),Array.isArray(o)||(o=[])),i=t.w2field?.selected,["list","enum","file"].includes(t.type)&&i){var n=i,r=o;if(Array.isArray(n)){d=[];for(let e=0;e<n.length;e++)d[e]=a.clone(n[e])}if(Array.isArray(r)){o=[];for(let e=0;e<r.length;e++)o[e]=a.clone(r[e])}a.isPlainObject(n)&&(d=a.clone(n)),a.isPlainObject(r)&&(o=a.clone(r))}return["map","array"].includes(t.type)&&(d="map"==t.type?{}:[],t.$el.parent().find(".w2ui-map-field").each((e=>{var i=l(e).find(".w2ui-map.key").val();e=l(e).find(".w2ui-map.value").val(),"map"==t.type?d[i]=e:d.push(e)}))),{current:d,previous:o,original:e}}}setFieldValue(e,t){let i=this.get(e);if(null!=i){var s=i.el;switch(i.type){case"toggle":case"checkbox":s.checked=!!t;break;case"radio":{t=t?.id??t;let e=l(s).closest("div").find("input");i.options.items.forEach(((i,s)=>{i.id===t&&e.filter(`[data-index="${s}"]`).prop("checked",!0)}));break}case"check":case"checks":{t=(t=Array.isArray(t)?t:null!=t?[t]:[]).map((e=>e?.id??e));let e=l(s).closest("div").find("input");i.options.items.forEach(((i,s)=>{e.filter(`[data-index="${s}"]`).prop("checked",!!t.includes(i.id))}));break}case"list":case"combo":let e=t;null==e?.id&&Array.isArray(i.options?.items)&&i.options.items.forEach((i=>{i.id===t&&(e=i)})),e!=t&&this.setValue(i.name,e,!0),"list"==i.type?(i.w2field.selected=e,i.w2field.refresh()):i.el.value=e?.text??t;break;case"switch":s.value=t,i.toolbar.uncheck(...i.toolbar.get()),i.toolbar.check(t);break;case"enum":case"file":{let e=[...t=Array.isArray(t)?t:null!=t?[t]:[]],s=!1;e.forEach(((t,l)=>{null==t?.id&&Array.isArray(i.options.items)&&i.options.items.forEach((i=>{i.id==t&&(e[l]=i,s=!0)}))})),s&&this.setValue(i.name,e,!0),i.w2field.selected=e,i.w2field.refresh();break}case"map":case"array":"map"!=i.type||null!=t&&a.isPlainObject(t)||(this.setValue(i.field,{},!0),t=this.getValue(i.field)),"array"!=i.type||null!=t&&Array.isArray(t)||(this.setValue(i.field,[],!0),t=this.getValue(i.field));var n=l(i.el).parent().find(".w2ui-map-container");i.el.mapRefresh(t,n);break;case"div":case"custom":l(s).html(t);break;case"color":s.value=t??"",i.w2field.refresh();break;case"html":case"empty":break;default:s.value=t??""}}}show(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&t.hidden&&(t.hidden=!1,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),this.updateEmptyGroups(),e}hide(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&!t.hidden&&(t.hidden=!0,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),this.updateEmptyGroups(),e}enable(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&t.disabled&&(t.disabled=!1,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),e}disable(){var e=[];for(let i=0;i<arguments.length;i++){var t=this.get(arguments[i]);t&&!t.disabled&&(t.disabled=!0,e.push(t.field))}return 0<e.length&&this.refresh.apply(this,e),e}updateEmptyGroups(){l(this.box).find(".w2ui-group").each((e=>{!function(e){let t=!0;return e.each((e=>{"none"!=e.style.display&&(t=!1)})),t}(l(e).find(".w2ui-field"))?l(e).show():l(e).hide()}))}change(){Array.from(arguments).forEach((e=>{(e=this.get(e)).$el&&e.$el.change()}))}reload(e){return("object"!=typeof this.url?this.url:this.url.get)&&null!=this.recid?this.request(e):("function"==typeof e&&e(),new Promise((e=>{e()})))}clear(){0!=arguments.length?Array.from(arguments).forEach((e=>{let t=this.record;String(e).split(".").map(((e,i,s)=>{s.length-1!==i?t=t[e]:delete t[e]})),this.refresh(e)})):(this.recid=null,this.record={},this.original=null,this.refresh(),this.hideErrors())}error(e){var t=this.trigger("error",{target:this.name,message:e,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions});!0!==t.isCancelled&&(setTimeout((()=>{this.message(e)}),1),t.finish())}message(e){return a.message({owner:this,box:this.box,after:".w2ui-form-header"},e)}confirm(e){return a.confirm({owner:this,box:this.box,after:".w2ui-form-header"},e)}validate(e){null==e&&(e=!0);var t=[];for(let e=0;e<this.fields.length;e++){var i,s,l=this.fields[e];switch(null==this.getValue(l.field)&&this.setValue(l.field,""),-1!=["int","float","currency","money"].indexOf(l.type)&&(i=this.getValue(l.field),n=l.options.min,s=l.options.max,null!=n&&null!=i&&i<n&&t.push({field:l,error:a.lang("Should be more than ${min}",{min:n})}),null!=s)&&null!=i&&s<i&&t.push({field:l,error:a.lang("Should be less than ${max}",{max:s})}),l.type){case"alphanumeric":this.getValue(l.field)&&!a.isAlphaNumeric(this.getValue(l.field))&&t.push({field:l,error:a.lang("Not alpha-numeric")});break;case"int":this.getValue(l.field)&&!a.isInt(this.getValue(l.field))&&t.push({field:l,error:a.lang("Not an integer")});break;case"percent":case"float":this.getValue(l.field)&&!a.isFloat(this.getValue(l.field))&&t.push({field:l,error:a.lang("Not a float")});break;case"currency":case"money":this.getValue(l.field)&&!a.isMoney(this.getValue(l.field))&&t.push({field:l,error:a.lang("Not in money format")});break;case"color":case"hex":this.getValue(l.field)&&!a.isHex(this.getValue(l.field))&&t.push({field:l,error:a.lang("Not a hex number")});break;case"email":this.getValue(l.field)&&!a.isEmail(this.getValue(l.field))&&t.push({field:l,error:a.lang("Not a valid email")});break;case"checkbox":1==this.getValue(l.field)?this.setValue(l.field,!0):this.setValue(l.field,!1);break;case"date":l.options.format||(l.options.format=a.settings.dateFormat),this.getValue(l.field)&&!a.isDate(this.getValue(l.field),l.options.format)&&t.push({field:l,error:a.lang("Not a valid date")+": "+l.options.format})}var n=this.getValue(l.field);!0!==l.hidden&&l.required&&!["div","custom","html","empty"].includes(l.type)&&(null==n||""===n||Array.isArray(n)&&0===n.length||a.isPlainObject(n)&&0==Object.keys(n).length)&&t.push({field:l,error:a.lang("Required field")}),!0!==l.hidden&&0<l.options?.minLength&&!["enum","list","combo"].includes(l.type)&&(null==n||n.length<l.options.minLength)&&t.push({field:l,error:a.lang("Field should be at least ${count} characters.",{count:l.options.minLength})})}var r=this.trigger("validate",{target:this.name,errors:t});if(!0!==r.isCancelled)return this.last.errors=t,e&&this.showErrors(),r.finish(),t}showErrors(){var e=this.last.errors;e.length<=0||(this.goto(e[0].field.page),l(e[0].field.$el).parents(".w2ui-field")[0].scrollIntoView({block:"nearest",inline:"nearest"}),e.forEach((e=>{var t=a.extend({anchorClass:"w2ui-error",class:"w2ui-light",position:"right|left",hideOn:["input"]},e.options);if(null!=e.field){let i=e.field.el;"radio"===e.field.type?i=l(e.field.el).closest("div").get(0):["enum","file"].includes(e.field.type),h.show(a.extend({anchor:i,name:`${this.name}-${e.field.field}-error`,html:e.error},t))}})),l(e[0].field.$el).parents(".w2ui-page").off(".hideErrors").on("scroll.hideErrors",(e=>{this.hideErrors()})))}hideErrors(){this.fields.forEach((e=>{h.hide(`${this.name}-${e.field}-error`)}))}getChanges(){return null!=this.original&&"object"==typeof this.original&&0!==Object.keys(this.record).length?function e(t,i,s){if(Array.isArray(t)&&Array.isArray(i))for(;t.length<i.length;)t.push(null);for(var l in t)null!=t[l]&&"object"==typeof t[l]?(s[l]=e(t[l],i[l]||{},{}),(!s[l]||0==Object.keys(s[l]).length&&Object.keys(0==i[l].length))&&delete s[l]):(t[l]!=i[l]||null==t[l]&&null!=i[l])&&(s[l]=t[l]);return 0!=Object.keys(s).length?s:null}(this.record,this.original,{}):{}}getCleanRecord(e){let t=a.clone(this.record);return this.fields.forEach((e=>{if(-1!=["list","combo","enum"].indexOf(e.type)){var i={nestedFields:!0,record:t};let s=this.getValue.call(i,e.field);a.isPlainObject(s)&&null!=s.id&&this.setValue.call(i,e.field,s.id),Array.isArray(s)&&s.forEach(((e,t)=>{a.isPlainObject(e)&&e.id&&(s[t]=e.id)}))}var s;"map"==e.type&&(i={nestedFields:!0,record:t},(i=this.getValue.call(i,e.field))._order)&&delete i._order,"file"==e.type&&(i={nestedFields:!0,record:t},(s=this.getValue.call(i,e.field)??[]).forEach((e=>{delete e.file,delete e.modified})),this.setValue.call(i,e.field,s))})),!0===e&&Object.keys(t).forEach((e=>{this.get(e)||delete t[e]})),t}request(e,t){let i,s,l=this;var n=new Promise(((e,t)=>{i=e,s=t}));if("function"==typeof e&&(t=e,e=null),null==e&&(e={}),this.url&&("object"!=typeof this.url||this.url.get)){var r={action:"get"};if(!0!==(r.recid=this.recid,r.name=this.name,a.extend(r,this.postData),a.extend(r,e),e=this.trigger("request",{target:this.name,url:this.url,httpMethod:"GET",postData:r,httpHeaders:this.httpHeaders})).isCancelled){this.record={},this.original=null,this.lock(a.lang(this.msgRefresh));let d=e.detail.url;if("object"==typeof d&&d.get&&(d=d.get),this.last.fetchCtrl)try{this.last.fetchCtrl.abort()}catch(e){}if(0!=Object.keys(this.routeData).length){var o=a.parseRoute(d);if(0<o.keys.length)for(let c=0;c<o.keys.length;c++)null!=this.routeData[o.keys[c].name]&&(d=d.replace(new RegExp(":"+o.keys[c].name,"g"),this.routeData[o.keys[c].name]))}return d=new URL(d,location),r=a.prepareParams(d,{method:e.detail.httpMethod,headers:e.detail.httpHeaders,body:e.detail.postData},this.dataType),this.last.fetchCtrl=new AbortController,r.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=r,fetch(d,r).catch(h).then((e=>{200!=e?.status?e&&h(e):e.json().catch(h).then((e=>{var s=l.trigger("load",{target:l.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:e});!0!==s.isCancelled&&(null==e.error&&"error"===e.status&&(e.error=!0),e.record||Object.assign(e,{record:a.clone(e)}),!0===e.error?l.error(a.lang(e.message??this.msgServerError)):l.record=a.clone(e.record),l.unlock(),s.finish(),l.refresh(),l.setFocus(),"function"==typeof t&&t(e),i(e))}))})),e.finish(),n;function h(e){var t;"AbortError"!==e.name&&(l.unlock(),!0!==(t=l.trigger("error",{response:e,fetchCtrl:l.last.fetchCtrl,fetchOptions:l.last.fetchOptions})).isCancelled)&&(e.status&&200!=e.status?l.error(e.status+": "+e.statusText):(console.log("ERROR: Server request failed.",e,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),l.error(String(e))),t.finish(),s(e))}}}}submit(e,t){return this.save(e,t)}save(e,t){let i,s,l=this;var n=new Promise(((e,t)=>{i=e,s=t})),r=("function"==typeof e&&(t=e,e=null),l.validate(!0));if(0===r.length)if(null==e&&(e={}),!l.url||"object"==typeof l.url&&!l.url.save)console.log("ERROR: Form cannot be saved because no url is defined.");else if(l.lock(a.lang(l.msgSaving)+' <span id="'+l.name+'_progress"></span>'),(r={action:"save"}).recid=l.recid,r.name=l.name,a.extend(r,l.postData),a.extend(r,e),r.record=a.clone(l.record),!0!==(e=l.trigger("submit",{target:l.name,url:l.url,httpMethod:this.method??"POST",postData:r,httpHeaders:l.httpHeaders})).isCancelled){let d=e.detail.url;if("object"==typeof d&&d.save&&(d=d.save),l.last.fetchCtrl&&l.last.fetchCtrl.abort(),0<Object.keys(l.routeData).length){var o=a.parseRoute(d);if(0<o.keys.length)for(let c=0;c<o.keys.length;c++)null!=l.routeData[o.keys[c].name]&&(d=d.replace(new RegExp(":"+o.keys[c].name,"g"),l.routeData[o.keys[c].name]))}return d=new URL(d,location),r=a.prepareParams(d,{method:e.detail.httpMethod,headers:e.detail.httpHeaders,body:e.detail.postData},this.dataType),this.last.fetchCtrl=new AbortController,r.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=r,fetch(d,r).catch(h).then((e=>{l.unlock(),200!=e?.status?h(e??{}):e.json().catch(h).then((e=>{var s=l.trigger("save",{target:l.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:e});!0!==s.isCancelled&&(!0===e.error?l.error(a.lang(e.message??this.msgServerError)):l.original=null,s.finish(),l.refresh(),"function"==typeof t&&t(e),i(e))}))})),e.finish(),n;function h(e){var t;"AbortError"!==e?.name&&(l.unlock(),!0!==(t=l.trigger("error",{response:e,fetchCtrl:l.last.fetchCtrl,fetchOptions:l.last.fetchOptions})).isCancelled)&&(e.status&&200!=e.status?e.json().then((t=>{l.error(e.status+": "+t.message??e.statusText)})).catch((()=>{l.error(e.status+": "+e.statusText)})):(console.log("ERROR: Server request failed.",e,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),l.error(String(e))),t.finish(),s())}}}lock(e,t){var i=Array.from(arguments);i.unshift(this.box),a.lock(...i)}unlock(e){var t=this.box;a.unlock(t,e)}lockPage(e,t,i){return!!(e=l(this.box).find(".page-"+e)).length&&(a.lock(e,t,i),!0)}unlockPage(e,t){return!!(e=l(this.box).find(".page-"+e)).length&&(a.unlock(e,t),!0)}goto(e){this.page!==e&&(null!=e&&(this.page=e),!0===l(this.box).data("autoSize")&&(l(this.box).get(0).clientHeight=0),this.refresh())}generateHTML(){let e,t,i,s,l=[],n="";for(let d=0;d<this.fields.length;d++){i="";var r=' tabindex="'+(s=this.tabindexBase+d+1)+'"',o=this.fields[d];null==o.html&&(o.html={}),null==o.options&&(o.options={}),null!=o.html.caption&&null==o.html.label&&(console.log("NOTICE: form field.html.caption property is deprecated, please use field.html.label. Field ->",o),o.html.label=o.html.caption),null==o.html.label&&(o.html.label=o.field),o.html=a.extend({label:"",span:6,attr:"",text:"",style:"",page:0,column:0},o.html),null==e&&(e=o.html.page),null==t&&(t=o.html.column);let h=`<input id="${o.field}" name="${o.field}" class="w2ui-input ${o.html.class??""}" type="text" ${o.html.attr+r}>`;switch(o.type){case"pass":case"password":h=h.replace('type="text"','type="password"');break;case"checkbox":h=`\n                        <label class="w2ui-box-label">\n                            <input id="${o.field}" name="${o.field}" class="w2ui-input ${o.html.class??""}" type="checkbox" ${o.html.attr+r}>\n                            <span>${o.html.label}</span>\n                        </label>`;break;case"check":case"checks":{null==o.options.items&&null!=o.html.items&&(o.options.items=o.html.items);let e=o.options.items;h="",0<(e=Array.isArray(e)?e:[]).length&&(e=a.normMenu.call(this,e,o));for(let t=0;t<e.length;t++)h+=`\n                            <label class="w2ui-box-label">\n                                <input id="${o.field+t}" name="${o.field}" class="w2ui-input ${o.html.class??""}" type="checkbox"\n                                    ${o.html.attr+r} data-value="${e[t].id}" data-index="${t}">\n                                <span>&#160;${e[t].text}</span>\n                            </label>\n                            <br>`;break}case"radio":{h="",null==o.options.items&&null!=o.html.items&&(o.options.items=o.html.items);let e=o.options.items;0<(e=Array.isArray(e)?e:[]).length&&(e=a.normMenu.call(this,e,o));for(let t=0;t<e.length;t++)h+=`\n                            <label class="w2ui-box-label">\n                                <input id="${o.field+t}" name="${o.field}" class="w2ui-input ${o.html.class??""}" type="radio"\n                                    ${o.html.attr+(0===t?r:"")}\n                                    data-value="${e[t].id}" data-index="${t}">\n                                <span>&#160;${e[t].text}</span>\n                            </label>\n                            <br>`;break}case"select":{h=`<select id="${o.field}" name="${o.field}" class="w2ui-input ${o.html.class??""}" ${o.html.attr+r}>`,null==o.options.items&&null!=o.html.items&&(o.options.items=o.html.items);let e=o.options.items;0<(e=Array.isArray(e)?e:[]).length&&(e=a.normMenu.call(this,e,o));for(let t=0;t<e.length;t++)h+=`<option value="${e[t].id}">${e[t].text}</option>`;h+="</select>";break}case"switch":h=`<div id="${o.field}-tb" class="w2ui-form-switch ${o.html.class??""}" ${o.html.attr}\n                        style="outline1: 1px solid red !important; height: 34px; margin-top: -5px; padding: 0px; background-color: transparent; position: relative;"></div>\n                        <input id="${o.field}" name="${o.field}" ${r} class="w2ui-input"\n                            style="position: absolute; right: 0; margin-top: -30px; width: 1px; padding: 0; opacity: 0">`;break;case"textarea":h=`<textarea id="${o.field}" name="${o.field}" class="w2ui-input ${o.html.class??""}" ${o.html.attr+r}></textarea>`;break;case"toggle":h=`<input id="${o.field}" name="${o.field}" class="w2ui-input w2ui-toggle  ${o.html.class??""}"\n                                type="checkbox" ${o.html.attr+r}>\n                            <div><div></div></div>`;break;case"map":case"array":o.html.key=o.html.key||{},o.html.value=o.html.value||{},o.html.tabindex_str=r,h='<span style="float: right">'+(o.html.text||"")+'</span><input id="'+o.field+'" name="'+o.field+'" type="hidden" '+o.html.attr+r+'><div class="w2ui-map-container"></div>';break;case"div":case"custom":h=`<div id="${o.field}" name="${o.field}" ${o.html.attr+r} class="w2ui-input ${o.html.class??""}">`+(o&&o.html&&o.html.html?o.html.html:"")+"</div>";break;case"html":case"empty":h=`<div id="${o.field}" name="${o.field}" ${o.html.attr+r} class="w2ui-input ${o.html.class??""}">`+(o&&o.html?(o.html.html||"")+(o.html.text||""):"")+"</div>"}if(""!==n&&(e!=o.html.page||t!=o.html.column||o.html.group&&n!=o.html.group)&&(l[e][t]+="\n   </div>\n  </div>",n=""),o.html.group&&n!=o.html.group){let e="";o.html.groupCollapsible&&(e='<span class="w2ui-icon-collapse" style="width: 15px; display: inline-block; position: relative; top: -2px;"></span>'),i+='\n <div class="w2ui-group">\n   <div class="w2ui-group-title w2ui-eaction" style="'+(o.html.groupTitleStyle||"")+"; "+(""!=e?"cursor: pointer; user-select: none":"")+'"'+(""!=e?'data-group="'+a.base64encode(o.html.group)+'"':"")+(""!=e?'data-click="toggleGroup|'+o.html.group+'"':"")+">"+e+a.lang(o.html.group)+'</div>\n   <div class="w2ui-group-fields" style="'+(o.html.groupStyle||"")+'">',n=o.html.group}if(null==o.html.anchor){let e=null!=o.html.span?"w2ui-span"+o.html.span:"",t="<label"+("none"==(e=-1==o.html.span?"w2ui-span-none":e)?' style="display: none"':"")+">"+a.lang("checkbox"!=o.type?o.html.label:o.html.text)+"</label>";o.html.label||(t=""),i+='\n      <div class="w2ui-field '+e+'" style="'+(o.hidden?"display: none;":"")+o.html.style+'">\n         '+t+("empty"===o.type?h:"\n         <div>"+h+("array"!=o.type&&"map"!=o.type?a.lang("checkbox"!=o.type?o.html.text:""):"")+"</div>")+"\n      </div>"}else l[o.html.page].anchors=l[o.html.page].anchors||{},l[o.html.page].anchors[o.html.anchor]='<div class="w2ui-field w2ui-field-inline" style="'+(o.hidden?"display: none;":"")+o.html.style+'">'+("empty"===o.type?h:"<div>"+a.lang("checkbox"!=o.type?o.html.label:o.html.text,!0)+h+a.lang("checkbox"!=o.type?o.html.text:"")+"</div>")+"</div>";null==l[o.html.page]&&(l[o.html.page]={}),null==l[o.html.page][o.html.column]&&(l[o.html.page][o.html.column]=""),l[o.html.page][o.html.column]+=i,e=o.html.page,t=o.html.column}if(""!==n&&(l[e][t]+="\n   </div>\n  </div>"),this.tabs.tabs)for(let e=0;e<this.tabs.tabs.length;e++)null==l[e]&&(l[e]=[]);let d="";if(0<Object.keys(this.actions).length){for(var h in d+='\n<div class="w2ui-buttons">',s=this.tabindexBase+this.fields.length+1,this.actions){var c=this.actions[h],u={text:"",style:"",class:""};a.isPlainObject(c)?(null==c.text&&null!=c.caption&&(console.log("NOTICE: form action.caption property is deprecated, please use action.text. Action ->",c),c.text=c.caption),c.text&&(u.text=c.text),c.style&&(u.style=c.style),c.class&&(u.class=c.class)):(u.text=h,-1!==["save","update","create"].indexOf(h.toLowerCase())?u.class="w2ui-btn-blue":u.class=""),d+='\n    <button name="'+h+'" class="w2ui-btn '+u.class+'" style="'+u.style+'" tabindex="'+s+'">'+a.lang(u.text)+"</button>",s++}d+="\n</div>"}i="";for(let e=0;e<l.length;e++){if(i+='<div class="w2ui-page page-'+e+'" style="'+(0!==e?"display: none;":"")+this.pageStyle+'">',!l[e])return console.log(`ERROR: Page ${e} does not exist`),!1;l[e].before&&(i+=l[e].before),i+='<div class="w2ui-column-container">',Object.keys(l[e]).sort().forEach(((t,s)=>{t==parseInt(t)&&(i+='<div class="w2ui-column col-'+t+'">'+(l[e][t]||"")+"\n</div>")})),i+="\n</div>",l[e].after&&(i+=l[e].after),i+="\n</div>",l[e].anchors&&Object.keys(l[e].anchors).forEach(((t,s)=>{i=i.replace(t,l[e].anchors[t])}))}return i+=d}toggleGroup(e,t){var i;0!==(e=l(this.box).find('.w2ui-group-title[data-group="'+a.base64encode(e)+'"]')).length&&(i=l(e.prop("nextElementSibling")),(t=void 0===t?"none"==i.css("display"):t)?(i.show(),e.find("span").addClass("w2ui-icon-collapse").removeClass("w2ui-icon-expand")):(i.hide(),e.find("span").addClass("w2ui-icon-expand").removeClass("w2ui-icon-collapse")))}action(e,t){var i=this.actions[e];let s=i;a.isPlainObject(i)&&i.onClick&&(s=i.onClick),!0!==(e=this.trigger("action",{target:e,action:i,originalEvent:t})).isCancelled&&("function"==typeof s&&s.call(this,t),e.finish())}resize(){let e=this;var t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled){if(null!=this.box){let o=l(this.box).find(":scope > div .w2ui-form-header"),d=l(this.box).find(":scope > div .w2ui-form-toolbar"),h=l(this.box).find(":scope > div .w2ui-form-tabs"),c=l(this.box).find(":scope > div .w2ui-page");var i=l(this.box).find(":scope > div .w2ui-page.page-"+this.page+" > div");let u=l(this.box).find(":scope > div .w2ui-buttons");var{headerHeight:s,tbHeight:n,tabsHeight:r}=p();function p(){var t=""!==e.header?a.getSize(o,"height"):0,i=Array.isArray(e.toolbar?.items)&&0<e.toolbar?.items?.length?a.getSize(d,"height"):0,s=Array.isArray(e.tabs?.tabs)&&0<e.tabs?.tabs?.length?a.getSize(h,"height"):0;return d.css({top:t+"px"}),h.css({top:t+i+"px"}),c.css({top:t+i+s+"px",bottom:(0<u.length?a.getSize(u,"height"):0)+"px"}),{headerHeight:t,tbHeight:i,tabsHeight:s}}this.autosize&&(0!==l(this.box).get(0).clientHeight&&"yes"!=l(this.box).data("autosize")||(l(this.box).css({height:s+n+r+15+(0<c.length?a.getSize(i,"height"):0)+(0<u.length?a.getSize(u,"height"):0)+"px"}),l(this.box).data("autosize","yes")),p())}t.finish()}}refresh(){var e=Date.now();let t=this;if(this.box&&this.isGenerated&&l(this.box).html()){var i=this.trigger("refresh",{target:this.name,page:this.page,field:arguments[0],fields:arguments});if(!0!==i.isCancelled){let r=Array.from(this.fields.keys());0<arguments.length?r=Array.from(arguments).map(((e,t)=>("string"!=typeof e&&console.log("ERROR: Arguments in refresh functions should be field names"),this.get(e,!0)))).filter(((e,t)=>null!=e)):(l(this.box).find("input, textarea, select").each((e=>{var t=null!=l(e).attr("name")?l(e).attr("name"):l(e).attr("id"),i=this.get(t);if(i){var s=l(e).closest(".w2ui-page");if(0<s.length)for(let e=0;e<100;e++)if(s.hasClass("page-"+e)){i.page=e;break}}})),l(this.box).find(".w2ui-page").hide(),l(this.box).find(".w2ui-page.page-"+this.page).show(),l(this.box).find(".w2ui-form-header").html(a.lang(this.header)),"object"==typeof this.tabs&&Array.isArray(this.tabs.tabs)&&0<this.tabs.tabs.length?(l(this.box).find("#form_"+this.name+"_tabs").show(),this.tabs.active=this.tabs.tabs[this.page].id,this.tabs.refresh()):l(this.box).find("#form_"+this.name+"_tabs").hide(),"object"==typeof this.toolbar&&Array.isArray(this.toolbar.items)&&0<this.toolbar.items.length?(l(this.box).find("#form_"+this.name+"_toolbar").show(),this.toolbar.refresh()):l(this.box).find("#form_"+this.name+"_toolbar").hide());for(let e=0;e<r.length;e++){let i=this.fields[r[e]],s=(null==i.name&&null!=i.field&&(i.name=i.field),null==i.field&&null!=i.name&&(i.field=i.name),i.$el=l(this.box).find(`[name='${String(i.name).replace(/\\/g,"\\\\")}']`),i.el=i.$el.get(0),i.el&&(i.el.id=i.name),i.w2field&&i.w2field.reset(),i.$el.off(".w2form").on("change.w2form",(function(e){var s=t.getFieldValue(i.field),n=(["enum","file"].includes(i.type)&&(n=i.w2field?.helpers?.multi,l(n).removeClass("w2ui-error")),null!=this._previous&&(s.previous=this._previous,delete this._previous),t.trigger("change",{target:this.name,field:this.name,value:s,originalEvent:e}));!0!==n.isCancelled&&(t.setValue(this.name,s.current),n.finish())})).on("input.w2form",(function(e){null==t.original&&(0<Object.keys(t.record).length?t.original=a.clone(t.record):t.original={});var s=t.getFieldValue(i.field);!0!==(null==this._previous&&(this._previous=s.previous),e=t.trigger("input",{target:t.name,field:i,value:s,originalEvent:e})).isCancelled&&(t.setValue(this.name,s.current),e.finish())})),i.required?i.$el.closest(".w2ui-field").addClass("w2ui-required"):i.$el.closest(".w2ui-field").removeClass("w2ui-required"),null!=i.disabled&&(i.disabled?(null==i.$el.data("tabIndex")&&i.$el.data("tabIndex",i.$el.prop("tabIndex")),i.$el.prop("readOnly",!0).prop("disabled",!0).prop("tabIndex",-1).closest(".w2ui-field").addClass("w2ui-disabled")):i.$el.prop("readOnly",!1).prop("disabled",!1).prop("tabIndex",i.$el.data("tabIndex")??i.$el.prop("tabIndex")??0).closest(".w2ui-field").removeClass("w2ui-disabled")),i.el);s=s||l(this.box).find("#"+i.field),i.hidden?l(s).closest(".w2ui-field").hide():l(s).closest(".w2ui-field").show()}l(this.box).find("button, input[type=button]").each((e=>{l(e).off("click").on("click",(function(e){let i=this.value;this.id&&(i=this.id),this.name&&(i=this.name),t.action(i,e)}))}));for(let e=0;e<r.length;e++){let i=this.fields[r[e]];if(i.el){if(i.$el.hasClass("w2ui-input")||i.$el.addClass("w2ui-input"),i.type=String(i.type).toLowerCase(),i.options||(i.options={}),this.LIST_TYPES.includes(i.type)){let e=i.options.items;null==e&&(i.options.items=[]),"switch"==i.type?e.forEach(((t,i)=>e[i]="object"!=typeof t?{id:t,text:t}:t)):i.options.items=a.normMenu.call(this,e??[],i)}if("switch"==i.type&&(i.toolbar&&n[this.name+"_"+i.name+"_tb"].destroy(),(s=i.options.items).forEach((e=>e.type="radio")),i.toolbar=new m({box:i.$el.prev().get(0),name:this.name+"_"+i.name+"_tb",items:s,onClick(e){var s=e.detail.item.id;!0!==(s=t.trigger("change",{target:i.name,field:i.name,value:s,originalEvent:e})).isCancelled&&(t.record[i.name]=e.detail.item.id,t.setFieldValue(i.name,e.detail.item.id),s.finish())}}),i.$el.off(".form-input").on("focus.form-input",(e=>{var t=i.toolbar.get(i.$el.val(),!0);l(e.target).prop("_index",t)})).on("blur.form-input",(e=>{l(e.target).removeProp("_index"),l(`#${i.name}-tb .w2ui-tb-button`).removeClass("over")})).on("keydown.form-input",(e=>{let s=l(e.target).prop("_index");switch(e.key){case"ArrowLeft":0<s&&s--,l(`#${i.name}-tb .w2ui-tb-button`).removeClass("over").eq(s).addClass("over"),l(e.target).prop("_index",s);break;case"ArrowRight":s<i.toolbar.items.length-1&&s++,l(`#${i.name}-tb .w2ui-tb-button`).removeClass("over").eq(s).addClass("over"),l(e.target).prop("_index",s)}var n;32!=e.keyCode&&13!=e.keyCode||(n=i.toolbar.items[s],t.setFieldValue(i.name,n.id),l(`#${i.name}-tb .w2ui-tb-button`).removeClass("over")),e.metaKey||e.ctrlKey||9==e.keyCode||e.preventDefault()}))),"select"==i.type){var s=i.options.items;let e="";s.forEach((t=>{e+=`<option value="${t.id}">${t.text}</option>`})),i.$el.html(e)}this.W2FIELD_TYPES.includes(i.type)&&(i.w2field=i.w2field??new w(a.extend({},i.options,{type:i.type})),i.w2field.render(i.el)),["map","array"].includes(i.type)&&function(e){let i;e.el.mapAdd=function(e,t,i){var s=(e.disabled?" readOnly ":"")+(e.html.tabindex_str||"");i=`\n                            <div class="w2ui-map-field" style="margin-bottom: 5px" data-index="${i}">\n                            ${"map"==e.type?`<input type="text" ${(e.html.key.attr??"")+s} class="w2ui-input ${e.html.class??""} w2ui-map key">\n                                    ${e.html.key.text||""}\n                                `:""}\n                            <input type="text" ${(e.html.value.attr??"")+s} class="w2ui-input ${e.html.class??""} w2ui-map value">\n                                ${e.html.value.text||""}\n                            </div>`,t.append(i)},e.el.mapRefresh=function(s,n){let r,o,d;var h;"map"==e.type&&(null==(s=a.isPlainObject(s)?s:{})._order&&(s._order=Object.keys(s)),r=s._order),"array"==e.type&&(Array.isArray(s)||(s=[]),r=s.map(((e,t)=>t)));for(let e=n.find(".w2ui-map-field").length-1;e>=r.length;e--)n.find(`div[data-index='${e}']`).remove();for(let t=0;t<r.length;t++){let i=r[t],l=n.find(`div[data-index='${t}']`),a=(0==l.length&&(e.el.mapAdd(e,n,t),l=n.find(`div[data-index='${t}']`)),l.attr("data-key",i),o=l.find(".w2ui-map.key"),d=l.find(".w2ui-map.value"),s[i]);"array"==e.type&&0<(h=s.filter((e=>e.key==i))).length&&(a=h[0].value),o.val(i),d.val(a),!0!==e.disabled&&!1!==e.disabled||(o.prop("readOnly",!!e.disabled),d.prop("readOnly",!!e.disabled))}var c=r.length,u=n.find(`div[data-index='${c}']`);0!==u.length||o&&""==o.val()&&""==d.val()||o&&(!0===o.prop("readOnly")||!0===o.prop("disabled"))||e.el.mapAdd(e,n,c),!0!==e.disabled&&!1!==e.disabled||(u.find(".key").prop("readOnly",!!e.disabled),u.find(".value").prop("readOnly",!!e.disabled)),c=l(e.el).get(0)?.nextSibling,l(c).find("input.w2ui-map").off(".mapChange").on("keyup.mapChange",(function(e){var t=(s=l(e.target).closest(".w2ui-map-field")).get(0).nextElementSibling,s=s.get(0).previousElementSibling,n=(13==e.keyCode&&((n=i??t)instanceof HTMLElement&&0<(n=l(n).find("input")).length&&n.get(0).focus(),i=void 0),l(e.target).hasClass("key")?"key":"value");38==e.keyCode&&s&&(l(s).find("input."+n).get(0).select(),e.preventDefault()),40==e.keyCode&&t&&(l(t).find("input."+n).get(0).select(),e.preventDefault())})).on("keydown.mapChange",(function(e){38!=e.keyCode&&40!=e.keyCode||e.preventDefault()})).on("input.mapChange",(function(t){var i=(t=l(t.target).closest("div")).data("index"),s=t.get(0).nextElementSibling;if(""==t.find("input").val()||s){if(""==t.find("input").val()&&s){let e=!0;l(s).find("input").each((t=>{""!=t.value&&(e=!1)})),e&&l(s).remove()}}else e.el.mapAdd(e,n,parseInt(i)+1)})).on("change.mapChange",(function(s){null==t.original&&(0<Object.keys(t.record).length?t.original=a.clone(t.record):t.original={});let{current:r,previous:o,original:d}=t.getFieldValue(e.field);var h=l(s.target).closest(".w2ui-map-container");!0!==("map"==e.type&&(r._order=[]),h.find(".w2ui-map.key").each((e=>{r._order.push(e.value)})),h=t.trigger("change",{target:e.field,field:e.field,originalEvent:s,value:{current:r,previous:o,original:d}})).isCancelled&&("map"==e.type&&(r._order=r._order.filter((e=>""!==e)),delete r[""]),"array"==e.type&&(r=r.filter((e=>""!==e))),""==l(s.target).parent().find("input").val()&&(i=s.target),t.setValue(e.field,r),e.el.mapRefresh(r,n),h.finish())}))}}(i),this.setFieldValue(i.field,this.getValue(i.name))}}return i.finish(),this.resize(),Date.now()-e}}}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=l(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.isGenerated||this.formHTML)&&this.box){if(e='<div class="w2ui-form-box">'+(""!==this.header?'<div class="w2ui-form-header">'+a.lang(this.header)+"</div>":"")+'    <div id="form_'+this.name+'_toolbar" class="w2ui-form-toolbar" style="display: none"></div>    <div id="form_'+this.name+'_tabs" class="w2ui-form-tabs" style="display: none"></div>'+this.formHTML+"</div>",l(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-form").html(e),0<l(this.box).length&&(l(this.box)[0].style.cssText+=this.style),a.bindEvents(l(this.box).find(".w2ui-eaction"),this),"function"!=typeof this.toolbar.render&&(this.toolbar=new m(a.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.toolbar.on("click",(function(e){!0!==(e=i.trigger("toolbar",{target:e.target,originalEvent:e})).isCancelled&&e.finish()}))),"object"==typeof this.toolbar&&"function"==typeof this.toolbar.render&&this.toolbar.render(l(this.box).find("#form_"+this.name+"_toolbar")[0]),"function"!=typeof this.tabs.render&&(this.tabs=new f(a.extend({},this.tabs,{name:this.name+"_tabs",owner:this,active:this.tabs.active})),this.tabs.on("click",(function(e){i.goto(this.get(e.target,!0))}))),"object"==typeof this.tabs&&"function"==typeof this.tabs.render&&(this.tabs.render(l(this.box).find("#form_"+this.name+"_tabs")[0]),this.tabs.active)&&this.tabs.click(this.tabs.active),s.finish(),this.resize(),(e="object"!=typeof this.url?this.url:this.url.get)&&null!=this.recid?this.request().catch((e=>this.refresh())):this.refresh(),this.last.observeResize=new ResizeObserver((()=>{this.resize()})),this.last.observeResize.observe(this.box),-1!=this.focus){let e=0,t=()=>{0<l(i.box).find("input, select, textarea").length?i.setFocus():++e<20&&setTimeout(t,50)};t()}return Date.now()-t}}unmount(){super.unmount(),this.tabs?.unmount?.(),this.toolbar?.unmount?.(),this.last.observeResize?.disconnect()}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(this.tabs?.destroy?.(),this.toolbar?.destroy?.(),0<l(this.box).find("#form_"+this.name+"_tabs").length&&this.unmount(),this.last.observeResize?.disconnect(),delete n[this.name],e.finish())}setFocus(e){let t;if(void 0===e&&(e=this.focus),a.isInt(e)){if(e<0)return;for(var i=l(this.box).find("div:not(.w2ui-field-helper) > input, select, textarea, div > label:nth-child(1) > [type=radio]").filter(":not(.file-input)");null==i[e].offsetParent&&i.length>=e;)e++;i[e]&&(t=l(i[e]))}else"string"==typeof e&&(t=l(this.box).find(`[name='${e}']`));return 0<t.length&&t.get(0).focus(),t}}class w extends t{constructor(e,t){super(),"string"==typeof e&&null==t&&(t={type:e}),"object"==typeof e&&null==t&&(t=a.clone(e)),"string"==typeof e&&"object"==typeof t&&(t.type=e),t.type=String(t.type).toLowerCase(),this.el=t.el??null,this.selected=null,this.helpers={},this.type=t.type??"text",this.options=a.clone(t),this.onClick=t.onClick??null,this.onAdd=t.onAdd??null,this.onNew=t.onNew??null,this.onRemove=t.onRemove??null,this.onMouseEnter=t.onMouseEnter??null,this.onMouseLeave=t.onMouseLeave??null,this.onScroll=t.onScroll??null,this.tmp={},delete this.options.type,delete this.options.onClick,delete this.options.onMouseEnter,delete this.options.onMouseLeave,delete this.options.onScroll,this.el&&this.render(this.el)}render(e){e instanceof HTMLElement?(e._w2field?.reset?.(),(e._w2field=this).el=e,this.init()):console.log("ERROR: Cannot init w2field on empty subject")}init(){let e,t=this.options;if(["INPUT","TEXTAREA"].includes(this.el.tagName.toUpperCase())){switch(this.type){case"text":case"int":case"float":case"money":case"currency":case"percent":case"alphanumeric":case"bin":case"hex":e={min:null,max:null,step:1,autoFormat:!0,autoCorrect:!0,currencyPrefix:a.settings.currencyPrefix,currencySuffix:a.settings.currencySuffix,currencyPrecision:a.settings.currencyPrecision,decimalSymbol:a.settings.decimalSymbol,groupSymbol:a.settings.groupSymbol,arrow:!1,keyboard:!0,precision:null,prefix:"",suffix:""},this.options=a.extend({},e,t),(t=this.options).numberRE=new RegExp("["+t.groupSymbol+"]","g"),t.moneyRE=new RegExp("["+t.currencyPrefix+t.currencySuffix+t.groupSymbol+"]","g"),t.percentRE=new RegExp("["+t.groupSymbol+"%]","g"),["text","alphanumeric","hex","bin"].includes(this.type)&&(t.arrow=!1,t.keyboard=!1);break;case"color":var i=parseInt(getComputedStyle(this.el)["font-size"])||12;e={prefix:"#",suffix:`<div style="width: ${i}px; height: ${i}px; margin-top: -2px;\n                                    position: relative; top: 50%; transform: translateY(-50%);">&#160;</div>`,arrow:!1,advanced:null,transparent:!0},this.options=a.extend({},e,t),t=this.options;break;case"date":e={format:a.settings.dateFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0},this.options=a.extend({type:"date"},e,t),t=this.options,null==l(this.el).attr("placeholder")&&l(this.el).attr("placeholder",t.format);break;case"time":e={format:a.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,btnNow:!0,noMinutes:!1},this.options=a.extend({type:"time"},e,t),t=this.options,null==l(this.el).attr("placeholder")&&l(this.el).attr("placeholder",t.format);break;case"datetime":e={format:a.settings.dateFormat+"|"+a.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,startTime:null,endTime:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0,noMinutes:!1},this.options=a.extend({type:"datetime"},e,t),t=this.options,null==l(this.el).attr("placeholder")&&l(this.el).attr("placeholder",t.placeholder||t.format);break;case"list":case"combo":e={items:[],selected:{},prefix:"",suffix:"",openOnFocus:!1,icon:null,iconStyle:"",url:null,recId:null,recText:null,method:null,debounce:250,postData:{},minLength:1,cacheMax:250,maxDropHeight:350,maxDropWidth:null,minDropWidth:null,match:"begins",align:"both",altRows:!0,renderDrop:null,compare:null,filter:!0,hideSelected:!1,markSearch:!1,msgNoItems:"No matches",msgSearch:"Type to search...",onSearch:null,onRequest:null,onLoad:null,onError:null},"function"==typeof t.items&&(t._items_fun=t.items),t.items=a.normMenu.call(this,t.items),"list"===this.type&&(l(this.el).addClass("w2ui-select"),!a.isPlainObject(t.selected))&&Array.isArray(t.items)&&t.items.forEach((e=>{e&&e.id===t.selected&&(t.selected=a.clone(e))})),t=a.extend({},e,t),(i=["is","begins","contains","ends"]).includes(t.match)||console.log(`ERROR: invalid value "${t.match}" for option.match. It should be one of following: ${i.join(", ")}.`),this.options=t,a.isPlainObject(t.selected)||(t.selected={}),this.selected=t.selected,l(this.el).attr("autocapitalize","off").attr("autocomplete","off").attr("autocorrect","off").attr("spellcheck","false"),null!=t.selected.text&&l(this.el).val(t.selected.text);break;case"enum":e={items:[],selected:[],max:0,maxItemWidth:250,style:"",openOnFocus:!1,renderItem:null,onMouseEnter:null,onMouseLeave:null,onScroll:null,onClick:null,onAdd:null,onNew:null,onRemove:null,url:null,recId:null,recText:null,debounce:250,method:null,postData:{},minLength:1,cacheMax:250,match:"begins",align:"",altRows:!0,renderDrop:null,maxDropHeight:350,maxDropWidth:null,markSearch:!1,compare:null,filter:!0,hideSelected:!0,msgNoItems:"No matches",msgSearch:"Type to search...",onSearch:null,onRequest:null,onLoad:null,onError:null},"function"==typeof(t=a.extend({},e,t,{suffix:""})).items&&(t._items_fun=t.items),(i=["is","begins","contains","ends"]).includes(t.match)||console.log(`ERROR: invalid value "${t.match}" for option.match. It should be one of following: ${i.join(", ")}.`),t.items=a.normMenu.call(this,t.items),t.selected=a.normMenu.call(this,t.selected),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected;break;case"file":e={selected:[],max:0,maxSize:0,maxFileSize:0,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,readContent:!0,silent:!0,align:"both",altRows:!0,renderItem:null,style:"",onClick:null,onAdd:null,onRemove:null,onMouseEnter:null,onMouseLeave:null},t=a.extend({},e,t),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected,null==l(this.el).attr("placeholder")&&l(this.el).attr("placeholder",a.lang("Attach files by dragging and dropping or Click to Select"));break;default:console.log(`ERROR: field type "${this.type}" is not supported.`)}l(this.el).css("box-sizing","border-box").addClass("w2field w2ui-input").off(".w2field").on("change.w2field",(e=>{this.change(e)})).on("click.w2field",(e=>{this.click(e)})).on("focus.w2field",(e=>{this.focus(e)})).on("blur.w2field",(e=>{"list"!==this.type&&this.blur(e)})).on("keydown.w2field",(e=>{this.keyDown(e)})).on("keyup.w2field",(e=>{this.keyUp(e)})),this.addPrefix(),this.addSuffix(),this.addSearch(),this.addMultiSearch(),this.change(new Event("change"))}else console.log("ERROR: w2field could only be applied to INPUT or TEXTAREA.",this.el)}get(){return-1!==["list","enum","file"].indexOf(this.type)?this.selected:l(this.el).val()}set(e,t){-1!==["list","enum","file"].indexOf(this.type)?("list"!==this.type&&t?(Array.isArray(this.selected)||(this.selected=[]),this.selected.push(e),(t=c.get(this.el.id+"_menu"))&&(t.options.selected=this.selected)):(null==e&&(e=[]),t="enum"!==this.type||Array.isArray(e)?e:[e],this.selected=t),l(this.el).trigger("input").trigger("change"),this.refresh()):l(this.el).val(e)}setIndex(e,t){if(-1!==["list","enum"].indexOf(this.type)){var i=this.options.items;if(i&&i[e])return"list"==this.type&&(this.selected=i[e]),"enum"==this.type&&(t||(this.selected=[]),this.selected.push(i[e])),(t=c.get(this.el.id+"_menu"))&&(t.options.selected=this.selected),l(this.el).trigger("input").trigger("change"),this.refresh(),!0}return!1}refresh(){let e=this.options;var t=Date.now(),i=getComputedStyle(this.el);if("color"==this.type){let e=this.el.value;"#"!=e.substr(0,1)&&"rgb"!=e.substr(0,3)&&(e="#"+e),l(this.helpers.suffix).find(":scope > div").css("background-color",e)}if("list"==this.type){if(this.helpers.prefix&&this.helpers.prefix.hide(),!this.helpers.search)return;null==this.selected&&e.icon?e.prefix=`\n                    <span class="w2ui-icon ${e.icon} "style="cursor: pointer; font-size: 14px;\n                        display: inline-block; margin-top: -1px; color: #7F98AD; ${e.iconStyle}">\n                    </span>`:e.prefix="",this.addPrefix();let t=l(this.helpers.search_focus);var s=l(t[0].previousElementSibling);t.css({outline:"none"}),""===t.val()?(t.css("opacity",0),s.css("opacity",0),this.selected?.id?(o=this.selected.text,r=this.findItemIndex(e.items,this.selected.id),null!=o&&l(this.el).val(a.lang(o)).data({selected:o,selectedIndex:r[0]})):(this.el.value="",l(this.el).removeData("selected selectedIndex"))):(t.css("opacity",1),s.css("opacity",1),l(this.el).val(""),setTimeout((()=>{this.helpers.prefix&&this.helpers.prefix.hide(),e.icon?(t.css("margin-left","17px"),l(this.helpers.search).find(".w2ui-icon-search").addClass("show-search")):(t.css("margin-left","0px"),l(this.helpers.search).find(".w2ui-icon-search").removeClass("show-search"))}),1)),l(this.el).prop("readOnly")||l(this.el).prop("disabled")?setTimeout((()=>{this.helpers.prefix&&l(this.helpers.prefix).css("opacity","0.6"),this.helpers.suffix&&l(this.helpers.suffix).css("opacity","0.6")}),1):setTimeout((()=>{this.helpers.prefix&&l(this.helpers.prefix).css("opacity","1"),this.helpers.suffix&&l(this.helpers.suffix).css("opacity","1")}),1)}let n=this.helpers.multi;if(["enum","file"].includes(this.type)&&n){let t="";Array.isArray(this.selected)&&this.selected.forEach(((i,s)=>{null!=i&&(t+=`\n                        <div class="li-item" index="${s}" style="max-width: ${parseInt(e.maxItemWidth)}px; ${i.style||""}">\n                        ${"function"==typeof e.renderItem?e.renderItem(i,s,`<div class="w2ui-list-remove" index="${s}">&#160;&#160;</div>`):`\n                               ${i.icon?`<span class="w2ui-icon ${i.icon}"></span>`:""}\n                               <div class="w2ui-list-remove" index="${s}">&#160;&#160;</div>\n                               ${("enum"===this.type?i.text:i.name)??i.id??i}\n                               ${i.size?`<span class="file-size"> - ${a.formatSize(i.size)}</span>`:""}\n                            `}\n                        </div>`)}));var r,o=n.find(".w2ui-multi-items");e.style&&n.attr("style",n.attr("style")+";"+e.style),l(this.el).css("z-index","-1"),l(this.el).prop("readOnly")||l(this.el).prop("disabled")?setTimeout((()=>{n[0].scrollTop=0,n.addClass("w2ui-readonly").find(".li-item").css("opacity","0.9").parent().find(".li-search").hide().find("input").prop("readOnly",!0).closest(".w2ui-multi-items").find(".w2ui-list-remove").hide()}),1):setTimeout((()=>{n.removeClass("w2ui-readonly").find(".li-item").css("opacity","1").parent().find(".li-search").show().find("input").prop("readOnly",!1).closest(".w2ui-multi-items").find(".w2ui-list-remove").show()}),1),0<this.selected?.length&&l(this.el).attr("placeholder",""),n.find(".w2ui-enum-placeholder").remove(),o.find(".li-item").remove(),""!==t?o.prepend(t):null!=l(this.el).attr("placeholder")&&""===n.find("input").val()&&(r=a.stripSpaces(`\n                    padding-top: ${i["padding-top"]};\n                    padding-left: ${i["padding-left"]};\n                    box-sizing: ${i["box-sizing"]};\n                    line-height: ${i["line-height"]};\n                    font-size: ${i["font-size"]};\n                    font-family: ${i["font-family"]};\n                `),n.prepend(`<div class="w2ui-enum-placeholder" style="${r}">${l(this.el).attr("placeholder")}</div>`)),n.off(".w2item").on("scroll.w2item",(e=>{!0!==(e=this.trigger("scroll",{target:this.el,originalEvent:e})).isCancelled&&(h.hide(this.el.id+"_preview"),e.finish())})).find(".li-item").on("click.w2item",(e=>{var t=l(e.target).closest(".li-item"),i=t.attr("index"),s=this.selected[i];if(!l(t).hasClass("li-search")){let n;if(e.stopPropagation(),l(e.target).hasClass("w2ui-list-remove"))l(this.el).prop("readOnly")||l(this.el).prop("disabled")||!0!==(n=this.trigger("remove",{target:this.el,originalEvent:e,item:s})).isCancelled&&(this.selected.splice(i,1),l(this.el).trigger("input").trigger("change"),l(e.target).remove());else if(!0!==(n=this.trigger("click",{target:this.el,originalEvent:e.originalEvent,item:s})).isCancelled){let e=s.tooltip;if("file"===this.type&&(/image/i.test(s.type)&&(e=`\n                                    <div class="w2ui-file-preview">\n                                        <img src="${s.content?"data:"+s.type+";base64,"+s.content:""}"\n                                            style="max-width: 300px">\n                                    </div>`),e+=`\n                                <div class="w2ui-file-info">\n                                    <div class="file-caption">${a.lang("Name")}:</div>\n                                    <div class="file-value">${s.name}</div>\n                                    <div class="file-caption">${a.lang("Size")}:</div>\n                                    <div class="file-value">${a.formatSize(s.size)}</div>\n                                    <div class="file-caption">${a.lang("Type")}:</div>\n                                    <div class="file-value file-type">${s.type}</div>\n                                    <div class="file-caption">${a.lang("Modified")}:</div>\n                                    <div class="file-value">${a.date(s.modified)}</div>\n                                </div>`),e){let i=this.el.id+"_preview";h.show({name:i,anchor:t.get(0),html:e,hideOn:["doc-click"],class:""}).show((e=>{l(`#w2overlay-${i} img`).on("load",(function(e){var t=this.clientWidth,i=this.clientHeight;t<300&i<300||(i<=t&&300<t&&l(this).css("width","300px"),t<i&&300<i&&l(this).css("height","300px"))})).on("error",(function(e){this.style.display="none"}))}))}n.finish()}}})).on("mouseenter.w2item",(e=>{var t=l(e.target).closest(".li-item");l(t).hasClass("li-search")||(t=this.selected[l(e.target).attr("index")],!0!==(e=this.trigger("mouseEnter",{target:this.el,originalEvent:e,item:t})).isCancelled&&e.finish())})).on("mouseleave.w2item",(e=>{var t=l(e.target).closest(".li-item");l(t).hasClass("li-search")||(t=this.selected[l(e.target).attr("index")],!0!==(e=this.trigger("mouseLeave",{target:this.el,originalEvent:e,item:t})).isCancelled&&e.finish())})),"enum"===this.type?this.helpers.multi.find("input").css({width:"15px"}):this.helpers.multi.find(".li-search").hide(),this.resize()}return Date.now()-t}resize(){var e=this.el.clientWidth,t=getComputedStyle(this.el),i=this.helpers.search,s=this.helpers.multi,n=this.helpers.suffix,r=this.helpers.prefix;if(i&&l(i).css("width",e),s&&l(s).css("width",e-parseInt(t["margin-left"],10)-parseInt(t["margin-right"],10)),n&&this.addSuffix(),r&&this.addPrefix(),i=this.helpers.multi,["enum","file"].includes(this.type)&&i){l(this.el).css("height","");let e=l(i).find(":scope div.w2ui-multi-items").get(0).clientHeight+5;(e=(e=e<20?20:e)>this.tmp["max-height"]?this.tmp["max-height"]:e)<this.tmp["min-height"]&&(e=this.tmp["min-height"]),(s=a.getSize(this.el,"height")-2)>e&&(e=s),l(i).css({height:e+"px",overflow:e==this.tmp["max-height"]?"auto":"hidden"}),l(i).css("height",e+"px"),l(this.el).css({height:e+"px"})}this.tmp.current_width=e}reset(){null!=this.tmp&&(l(this.el).css("height",""),Array("padding-left","padding-right","background-color","border-color").forEach((e=>{this.tmp&&null!=this.tmp["old-"+e]&&(l(this.el).css(e,this.tmp["old-"+e]),delete this.tmp["old-"+e])})),clearInterval(this.tmp.sizeTimer)),l(this.el).val(this.clean(l(this.el).val())).removeClass("w2field w2ui-input").removeData("selected selectedIndex").off(".w2field"),Object.keys(this.helpers).forEach((e=>{l(this.helpers[e]).remove()})),this.helpers={},delete this.el._w2field}clean(e){var t;return"number"!=typeof e&&(t=this.options,e=String(e).trim(),["int","float","money","currency","percent"].includes(this.type))?""!==(e="string"==typeof e?(e=t.autoFormat&&(["money","currency"].includes(this.type)&&(e=String(e).replace(t.moneyRE,"")),"percent"===this.type&&(e=String(e).replace(t.percentRE,"")),["int","float"].includes(this.type))?String(e).replace(t.numberRE,""):e).replace(/\s+/g,"").replace(new RegExp(t.groupSymbol,"g"),"").replace(t.decimalSymbol,"."):e)&&a.isFloat(e)?Number(e):"":e}format(e){var t=this.options;if(t.autoFormat&&""!==e){switch(this.type){case"money":case"currency":""!==(e=a.formatNumber(e,t.currencyPrecision,!0))&&(e=t.currencyPrefix+e+t.currencySuffix);break;case"percent":""!==(e=a.formatNumber(e,t.precision,!0))&&(e+="%");break;case"float":e=a.formatNumber(e,t.precision,!0);break;case"int":e=a.formatNumber(e,0,!0)}var i=parseInt(1e3).toLocaleString(a.settings.locale,{useGrouping:!0}).slice(1,2);i!==this.options.groupSymbol&&(e=e.replaceAll(i,this.options.groupSymbol))}return e}change(e){if(-1!==["int","float","money","currency","percent"].indexOf(this.type)){var t=l(this.el).val(),i=this.format(this.clean(l(this.el).val()));if(""!==t&&t!=i)return l(this.el).val(i),e.stopPropagation(),e.preventDefault(),!1}if("color"===this.type){let e=l(this.el).val();"rgb"!==e.substr(0,3).toLowerCase()&&(e="#"+e,8!==(t=l(this.el).val().length))&&6!==t&&3!==t&&(e=""),i=l(this.el).get(0).nextElementSibling,l(i).find("div").css("background-color",e),l(this.el).hasClass("has-focus")&&this.updateOverlay()}if(-1!==["list","enum","file"].indexOf(this.type)&&this.refresh(),-1!==["date","time","datetime"].indexOf(this.type)){let e=parseInt(this.el.value);a.isInt(this.el.value)&&3e3<e&&("time"===this.type&&(e=a.formatTime(new Date(e),this.options.format)),"date"===this.type&&(e=a.formatDate(new Date(e),this.options.format)),"datetime"===this.type&&(e=a.formatDateTime(new Date(e),this.options.format)),l(this.el).val(e).trigger("input").trigger("change"))}}click(e){var t;["list","combo","enum"].includes(this.type)&&(l(this.el).hasClass("has-focus")||this.focus(e),"list"!=this.type&&"combo"!=this.type||(this.tmp.openedOnFocus||(t=this.el.id+"_menu",c.get(t)?.displayed?c.hide(t):this.updateOverlay()),delete this.tmp.openedOnFocus,"list"==this.type&&e.stopPropagation())),["date","time","datetime","color"].includes(this.type)&&this.updateOverlay()}focus(e){if("list"==this.type&&document.activeElement==this.el)this.helpers.search_focus.focus();else{if(-1!==["color","date","time","datetime"].indexOf(this.type)){if(l(this.el).prop("readOnly")||l(this.el).prop("disabled"))return;this.updateOverlay()}if(-1!==["list","combo","enum"].indexOf(this.type)){if(l(this.el).prop("readOnly")||l(this.el).prop("disabled"))return void l(this.el).addClass("has-focus");"function"==typeof this.options._items_fun&&(this.options.items=a.normMenu.call(this,this.options._items_fun)),this.helpers.search&&((t=this.helpers.search_focus).value="",t.select()),"enum"==this.type&&(t=l(this.el.previousElementSibling).find(".li-search input").get(0),document.activeElement!==t)&&t.focus(),this.resize(),!1===e.showMenu||!1===this.options.openOnFocus&&!l(this.el).hasClass("has-focus")||this.tmp.overlay?.overlay?.displayed||setTimeout((()=>{this.tmp.openedOnFocus=!0,this.updateOverlay()}),0)}var t;"file"==this.type&&(t=l(this.el).get(0).previousElementSibling,l(t).addClass("has-focus")),l(this.el).addClass("has-focus")}}blur(e){var t,i=l(this.el).val().trim();if(l(this.el).removeClass("has-focus"),["int","float","money","currency","percent"].includes(this.type)&&""!==i){let e=i,s="";this.isStrValid(i)?(t=this.clean(i),null!=this.options.min&&t<this.options.min&&(e=this.options.min,s="Should be >= "+this.options.min),null!=this.options.max&&t>this.options.max&&(e=this.options.max,s="Should be <= "+this.options.max)):e="",this.options.autoCorrect&&(l(this.el).val(e).trigger("input").trigger("change"),s)&&(h.show({name:this.el.id+"_error",anchor:this.el,html:s}),setTimeout((()=>{h.hide(this.el.id+"_error")}),3e3))}["date","time","datetime"].includes(this.type)&&this.options.autoCorrect&&""!==i&&(t="date"==this.type?a.isDate:"time"==this.type?a.isTime:a.isDateTime,p.inRange(this.el.value,this.options)&&t.bind(a)(this.el.value,this.options.format)||l(this.el).val("").trigger("input").trigger("change")),"enum"===this.type&&l(this.helpers.multi).find("input").val("").css("width","15px"),"file"==this.type&&(i=this.el.previousElementSibling,l(i).removeClass("has-focus")),"list"===this.type&&(this.el.value=this.selected?.text??"")}keyDown(e,t){var i,s=this.options;t=e.keyCode||t&&t.keyCode;let n,r,o,d,h,u,m=!1;if(["int","float","money","currency","percent","hex","bin","color","alphanumeric"].includes(this.type)&&!(e.metaKey||e.ctrlKey||e.altKey||this.isStrValid(e.key??"1",!0)||[9,8,13,27,37,38,39,40,46].includes(e.keyCode)))return e.preventDefault(),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!1;if(["int","float","money","currency","percent"].includes(this.type)){if(!s.keyboard||l(this.el).prop("readOnly")||l(this.el).prop("disabled"))return;switch(n=parseFloat(l(this.el).val().replace(s.moneyRE,""))||0,r=s.step,(e.ctrlKey||e.metaKey)&&(r=10*s.step),t){case 38:e.shiftKey||(h=n+r<=s.max||null==s.max?Number((n+r).toFixed(12)):s.max,l(this.el).val(h).trigger("input").trigger("change"),m=!0);break;case 40:e.shiftKey||(h=n-r>=s.min||null==s.min?Number((n-r).toFixed(12)):s.min,l(this.el).val(h).trigger("input").trigger("change"),m=!0)}m&&(e.preventDefault(),this.moveCaret2end())}if(["date","datetime"].includes(this.type)){if(!s.keyboard||l(this.el).prop("readOnly")||l(this.el).prop("disabled"))return;var g=("date"==this.type?a.isDate:a.isDateTime).bind(a),f=("date"==this.type?a.formatDate:a.formatDateTime).bind(a);switch(o=864e5,r=1,(e.ctrlKey||e.metaKey)&&(r=10),(d=g(l(this.el).val(),s.format,!0))||(d=new Date,o=0),t){case 38:e.shiftKey||(10==r?d.setMonth(d.getMonth()+1):d.setTime(d.getTime()+o),u=f(d.getTime(),s.format),l(this.el).val(u).trigger("input").trigger("change"),m=!0);break;case 40:e.shiftKey||(10==r?d.setMonth(d.getMonth()-1):d.setTime(d.getTime()-o),u=f(d.getTime(),s.format),l(this.el).val(u).trigger("input").trigger("change"),m=!0)}m&&(e.preventDefault(),this.moveCaret2end(),this.updateOverlay())}if("time"===this.type){if(!s.keyboard||l(this.el).prop("readOnly")||l(this.el).prop("disabled"))return;r=e.ctrlKey||e.metaKey?60:1,n=l(this.el).val();let i=p.str2min(n)||p.str2min((new Date).getHours()+":"+((new Date).getMinutes()-1));switch(t){case 38:e.shiftKey||(i+=r,m=!0);break;case 40:e.shiftKey||(i-=r,m=!0)}m&&(e.preventDefault(),l(this.el).val(p.min2str(i)).trigger("input").trigger("change"),this.moveCaret2end())}if(["list","enum"].includes(this.type))switch(t){case 8:case 46:"list"==this.type?""==l(this.helpers.search_focus).val()&&(this.selected=null,c.hide(this.el.id+"_menu"),l(this.el).val("").trigger("input").trigger("change")):""==l(this.helpers.multi).find("input").val()&&(c.hide(this.el.id+"_menu"),this.selected.pop(),(i=c.get(this.el.id+"_menu"))&&(i.options.selected=this.selected),this.refresh());break;case 9:case 16:break;case 27:c.hide(this.el.id+"_menu"),this.refresh()}}keyUp(e){if("list"==this.type){let t=l(this.helpers.search_focus);""!==t.val()?l(this.el).attr("placeholder",""):l(this.el).attr("placeholder",this.tmp.pholder),13==e.keyCode&&setTimeout((()=>{t.val(""),c.hide(this.el.id+"_menu"),this.refresh()}),1),[38,40].includes(e.keyCode)&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay(),this.refresh()}var t,i;"combo"==this.type&&([9,16,27].includes(e.keyCode)||!0===this.options.openOnFocus||this.updateOverlay(),[38,40].includes(e.keyCode))&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay(),"enum"==this.type&&(t=this.helpers.multi.find("input"),i=getComputedStyle(t.get(0)),i=a.getStrWidth(t.val(),`font-family: ${i["font-family"]}; font-size: ${i["font-size"]};`),t.css({width:i+15+"px"}),this.resize(),[38,40].includes(e.keyCode))&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay()}findItemIndex(e,t,i){let s=[];var l;return i=i||[],["list","combo","enum"].includes(this.type)&&this.options.url&&(l=c.get(this.el.id+"_menu"))&&(e=l.options.items,this.options.items=e),e.forEach(((e,l)=>{e.id===t&&(s=i.concat([l]),this.options.index=[l]),0==s.length&&e.items&&0<e.items.length&&(i.push(l),s=this.findItemIndex(e.items,t,i),i.pop())})),s}updateOverlay(e){let t=this.options;if("color"===this.type){if(l(this.el).prop("readOnly")||l(this.el).prop("disabled"))return;u.show(a.extend({name:this.el.id+"_color",anchor:this.el,transparent:t.transparent,advanced:t.advanced,color:this.el.value,liveUpdate:!0},this.options)).select((e=>{e=e.detail.color,l(this.el).val(e).trigger("input").trigger("change")})).liveUpdate((e=>{e=e.detail.color,l(this.helpers.suffix).find(":scope > div").css("background-color","#"+e)}))}if(["list","combo","enum"].includes(this.type)){var i;this.el;let e=this.el;"enum"===this.type&&(i=this.helpers.multi.get(0),e=l(i).find("input").get(0)),"list"===this.type&&(i=this.selected,a.isPlainObject(i)&&0<Object.keys(i).length&&0<(i=this.findItemIndex(t.items,i.id)).length&&(t.index=i),e=this.helpers.search_focus),!l(this.el).hasClass("has-focus")||this.el.readOnly||this.el.disabled||(i=a.extend({},t,{name:this.el.id+"_menu",anchor:e,selected:this.selected,search:!1,render:t.renderDrop,anchorClass:"",offsetY:5,maxHeight:t.maxDropHeight,maxWidth:t.maxDropWidth,minWidth:t.minDropWidth}),this.tmp.overlay=c.show(i).select((i=>{var s,n;["list","combo"].includes(this.type)?(this.selected=i.detail.item,l(e).val(""),l(this.el).val(this.selected.text).trigger("input").trigger("change"),this.focus({showMenu:!1})):(n=this.selected,(s=i.detail?.item)&&!0!==(i=this.trigger("add",{target:this.el,item:s,originalEvent:i})).isCancelled&&(n.length>=t.max&&0<t.max&&n.pop(),delete s.hidden,n.push(s),l(this.el).trigger("input").trigger("change"),l(this.helpers.multi).find("input").val(""),(n=c.get(this.el.id+"_menu"))&&(n.options.selected=this.selected),i.finish()))})))}!["date","time","datetime"].includes(this.type)||l(this.el).prop("readOnly")||l(this.el).prop("disabled")||p.show(a.extend({name:this.el.id+"_date",anchor:this.el,value:this.el.value},this.options)).select((e=>{null!=(e=e.detail.date)&&l(this.el).val(e).trigger("input").trigger("change")}))}isStrValid(e,t){let i=!0;switch(this.type){case"int":i=!(!t||!["-",this.options.groupSymbol].includes(e))||a.isInt(e.replace(this.options.numberRE,""));break;case"percent":e=e.replace(/%/g,"");case"float":i=!(!t||!["-","",this.options.decimalSymbol,this.options.groupSymbol].includes(e))||a.isFloat(e.replace(this.options.numberRE,""));break;case"money":case"currency":i=!(!t||!["-",this.options.decimalSymbol,this.options.groupSymbol,this.options.currencyPrefix,this.options.currencySuffix].includes(e))||a.isFloat(e.replace(this.options.moneyRE,""));break;case"bin":i=a.isBin(e);break;case"color":case"hex":i=a.isHex(e);break;case"alphanumeric":i=a.isAlphaNumeric(e)}return i}addPrefix(){var e,t;this.options.prefix&&(t=getComputedStyle(this.el),null==this.tmp["old-padding-left"]&&(this.tmp["old-padding-left"]=t["padding-left"]),this.helpers.prefix&&l(this.helpers.prefix).remove(),l(this.el).before(`<div class="w2ui-field-helper">${this.options.prefix}</div>`),e=l(this.el).get(0).previousElementSibling,l(e).css({color:t.color,"font-family":t["font-family"],"font-size":t["font-size"],height:this.el.clientHeight+"px","padding-top":parseInt(t["padding-top"],10)+1+"px","padding-bottom":parseInt(t["padding-bottom"],10)-1+"px","padding-left":this.tmp["old-padding-left"],"padding-right":0,"margin-top":parseInt(t["margin-top"],10)+"px","margin-bottom":parseInt(t["margin-bottom"],10)+"px","margin-left":t["margin-left"],"margin-right":0,"z-index":1,display:"flex","align-items":"center"}),l(this.el).css("padding-left",e.clientWidth+"px !important"),this.helpers.prefix=e)}addSuffix(){if(this.options.suffix||this.options.arrow){let i,s=this;var e=getComputedStyle(this.el),t=(null==this.tmp["old-padding-right"]&&(this.tmp["old-padding-right"]=e["padding-right"]),parseInt(e["padding-right"]||0));this.options.arrow&&(this.helpers.arrow&&l(this.helpers.arrow).remove(),l(this.el).after('<div class="w2ui-field-helper" style="border: 1px solid transparent">&#160;    <div class="w2ui-field-up" type="up">        <div class="arrow-up" type="up"></div>    </div>    <div class="w2ui-field-down" type="down">        <div class="arrow-down" type="down"></div>    </div></div>'),i=l(this.el).get(0).nextElementSibling,l(i).css({color:e.color,"font-family":e["font-family"],"font-size":e["font-size"],height:this.el.clientHeight+"px",padding:0,"margin-top":parseInt(e["margin-top"],10)+1+"px","margin-bottom":0,"border-left":"1px solid silver",width:"16px",transform:"translateX(-100%)"}).on("mousedown",(function(e){l(e.target).hasClass("arrow-up")&&s.keyDown(e,{keyCode:38}),l(e.target).hasClass("arrow-down")&&s.keyDown(e,{keyCode:40})})),t+=i.clientWidth,l(this.el).css("padding-right",t+"px !important"),this.helpers.arrow=i),""!==this.options.suffix&&(this.helpers.suffix&&l(this.helpers.suffix).remove(),l(this.el).after(`<div class="w2ui-field-helper">${this.options.suffix}</div>`),i=l(this.el).get(0).nextElementSibling,l(i).css({color:e.color,"font-family":e["font-family"],"font-size":e["font-size"],height:this.el.clientHeight+"px","padding-top":e["padding-top"],"padding-bottom":e["padding-bottom"],"padding-left":0,"padding-right":e["padding-right"],"margin-top":parseInt(e["margin-top"],10)+2+"px","margin-bottom":parseInt(e["margin-bottom"],10)+1+"px",transform:"translateX(-100%)"}),l(this.el).css("padding-right",i.clientWidth+"px !important"),this.helpers.suffix=i)}}addSearch(){if("list"===this.type){this.helpers.search&&l(this.helpers.search).remove();let i=parseInt(l(this.el).attr("tabIndex")),s=(isNaN(i)||-1===i||(this.tmp["old-tabIndex"]=i),null!=(i=this.tmp["old-tabIndex"]?this.tmp["old-tabIndex"]:i)&&!isNaN(i)||(i=0),"");var e=`\n            <div class="w2ui-field-helper">\n                <span class="w2ui-icon w2ui-icon-search"></span>\n                <input ${s=null!=l(this.el).attr("id")?'id="'+l(this.el).attr("id")+'_search"':s} type="text" tabIndex="${i}" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"/>\n            </div>`,t=(l(this.el).attr("tabindex",-1).before(e),e=l(this.el).get(0).previousElementSibling,this.helpers.search=e,this.helpers.search_focus=l(e).find("input").get(0),getComputedStyle(this.el));l(e).css({width:this.el.clientWidth+"px","margin-top":t["margin-top"],"margin-left":t["margin-left"],"margin-bottom":t["margin-bottom"],"margin-right":t["margin-right"]}).find("input").css({cursor:"default",width:"100%",opacity:1,padding:t.padding,margin:t.margin,border:"1px solid transparent","background-color":"transparent"}),l(e).find("input").off(".helper").on("focus.helper",(e=>{l(e.target).val(""),this.tmp.pholder=l(this.el).attr("placeholder")??"",this.focus(e),e.stopPropagation()})).on("blur.helper",(e=>{l(e.target).val(""),null!=this.tmp.pholder&&l(this.el).attr("placeholder",this.tmp.pholder),this.blur(e),e.stopPropagation()})).on("keydown.helper",(e=>{this.keyDown(e)})).on("keyup.helper",(e=>{this.keyUp(e)})),l(e).on("click",(e=>{l(e.target).find("input").focus()}))}}addMultiSearch(){if(["enum","file"].includes(this.type)){l(this.helpers.multi).remove();let n="";var e,t,i=getComputedStyle(this.el),s=a.stripSpaces(`\n            margin-top: 0px;\n            margin-bottom: 0px;\n            margin-left: ${i["margin-left"]};\n            margin-right: ${i["margin-right"]};\n            width: ${a.getSize(this.el,"width")-parseInt(i["margin-left"],10)-parseInt(i["margin-right"],10)}px;\n        `);null==this.tmp["min-height"]&&(e=this.tmp["min-height"]=parseInt(("none"!=i["min-height"]?i["min-height"]:0)||0),t=parseInt(i.height),this.tmp["min-height"]=Math.max(e,t)),null==this.tmp["max-height"]&&"none"!=i["max-height"]&&(this.tmp["max-height"]=parseInt(i["max-height"]));let r="",o=(null!=l(this.el).attr("id")&&(r=`id="${l(this.el).attr("id")}_search"`),parseInt(l(this.el).attr("tabIndex"))),d=(isNaN(o)||-1===o||(this.tmp["old-tabIndex"]=o),null!=(o=this.tmp["old-tabIndex"]?this.tmp["old-tabIndex"]:o)&&!isNaN(o)||(o=0),"enum"===this.type&&(n=`\n            <div class="w2ui-field-helper w2ui-list" style="${s}">\n                <div class="w2ui-multi-items">\n                    <div class="li-search">\n                        <input ${r} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"\n                            tabindex="${o}"\n                            ${l(this.el).prop("readOnly")?"readonly":""}\n                            ${l(this.el).prop("disabled")?"disabled":""}>\n                    </div>\n                </div>\n            </div>`),"file"===this.type&&(n=`\n            <div class="w2ui-field-helper w2ui-list" style="${s}">\n                <div class="w2ui-multi-file">\n                    <input name="attachment" class="file-input" type="file" tabindex="-1"'\n                        style="width: 100%; height: 100%; opacity: 0" title=""\n                        ${1!==this.options.max?"multiple":""}\n                        ${l(this.el).prop("readOnly")||l(this.el).prop("disabled")?"disabled":""}\n                        ${l(this.el).attr("accept")?' accept="'+l(this.el).attr("accept")+'"':""}>\n                </div>\n                <div class="w2ui-multi-items">\n                    <div class="li-search" style="display: none">\n                        <input ${r} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"\n                            tabindex="${o}"\n                            ${l(this.el).prop("readOnly")?"readonly":""}\n                            ${l(this.el).prop("disabled")?"disabled":""}>\n                    </div>\n                </div>\n            </div>`),this.tmp["old-background-color"]=i["background-color"],this.tmp["old-border-color"]=i["border-color"],l(this.el).before(n).css({"border-color":"transparent","background-color":"transparent"}),l(this.el.previousElementSibling));this.helpers.multi=d,l(this.el).attr("tabindex",-1),d.on("click",(e=>{this.focus(e)})),d.find("input:not(.file-input)").on("click",(e=>{this.click(e)})).on("focus",(e=>{this.focus(e)})).on("blur",(e=>{this.blur(e)})).on("keydown",(e=>{this.keyDown(e)})).on("keyup",(e=>{this.keyUp(e)})),"file"===this.type&&d.find("input.file-input").off(".drag").on("click.drag",(e=>{e.stopPropagation(),l(this.el).prop("readOnly")||l(this.el).prop("disabled")||this.focus(e)})).on("dragenter.drag",(e=>{l(this.el).prop("readOnly")||l(this.el).prop("disabled")||d.addClass("w2ui-file-dragover")})).on("dragleave.drag",(e=>{l(this.el).prop("readOnly")||l(this.el).prop("disabled")||d.removeClass("w2ui-file-dragover")})).on("drop.drag",(e=>{l(this.el).prop("readOnly")||l(this.el).prop("disabled")||(d.removeClass("w2ui-file-dragover"),Array.from(e.dataTransfer.files).forEach((e=>{this.addFile(e)})),this.focus(e),e.preventDefault(),e.stopPropagation())})).on("dragover.drag",(e=>{e.preventDefault(),e.stopPropagation()})).on("change.drag",(e=>{void 0!==e.target.files&&Array.from(e.target.files).forEach((e=>{this.addFile(e)})),this.focus(e)})),this.refresh()}}addFile(e){var t=this.options,i=this.selected;let s={name:e.name,type:e.type,modified:e.lastModifiedDate,size:e.size,content:null,file:e},n=0,r=0,o=[],d=(Array.isArray(i)&&i.forEach((t=>{t.name==e.name&&t.size==e.size&&o.push(a.lang('The file "${name}" (${size}) is already added.',{name:e.name,size:a.formatSize(e.size)})),n+=t.size,r++})),0!==t.maxFileSize&&s.size>t.maxFileSize&&o.push(a.lang("Maximum file size is ${size}",{size:a.formatSize(t.maxFileSize)})),0!==t.maxSize&&n+s.size>t.maxSize&&o.push(a.lang("Maximum total size is ${size}",{size:a.formatSize(t.maxSize)})),0!==t.max&&r>=t.max&&o.push(a.lang("Maximum number of files is ${count}",{count:t.max})),this.trigger("add",{target:this.el,file:s,total:r,totalSize:n,errors:o}));if(!0!==d.isCancelled)if(!0!==t.silent&&0<o.length)h.show({anchor:this.el,html:"Errors: "+o.join("<br>")}),console.log("ERRORS (while adding files): ",o);else if(i.push(s),"undefined"!=typeof FileReader&&!0===t.readContent){i=new FileReader;let t=this;i.onload=function(e){var i=(e=e.target.result).indexOf(",");s.content=e.substr(i+1),t.refresh(),l(t.el).trigger("input").trigger("change"),d.finish()},i.readAsDataURL(e)}else this.refresh(),l(this.el).trigger("input").trigger("change"),d.finish()}moveCaret2end(){setTimeout((()=>{this.el.setSelectionRange(this.el.value.length,this.el.value.length)}),0)}}const x={unitsCanHaveChildren:!0,useExperienceSublevels:!1,useExperienceAptitudes:!0,unitEditorAvatarDefaultHairColor:"rgb(39, 31, 86)",unitEditorAvatarDefaultEyeColor:"rgb(34, 132, 181)",combatCombatArts:!1,combatCombatArtLimit:3,combatWeaponTriangle:!0,combatTriangleTypes:[],combatNeutralTypes:[],combatTriangleMapping:{},combatExpandedWeaponTriangle:!1,combatWeaponTriangleAdvantage:20,combatWeaponTriangleDisadvantage:-20,combatMagicTriangle:!1,combatMagicTriangleAdvantage:20,combatMagicTriangleDisadvantage:-20,combatMagicTriangleTypes:[],combatNeutralMagicTypes:[],combatMagicTriangleMapping:{},combatBattalions:!0,combatBattalionLimit:1,combatBattalionEndurance:!0,combatPairUp:!0,combatAdjutants:!1,combatAdjutantHeal:!1,combatAdjutantGuard:!1,combatAdjutantAttack:!1,statsUseExtraStatWeight:!1,statsExtraStatWeightAffectsMovement:!1,statsUseExtraStatLuck:!0,combatSeparateCritAvoid:!1,statsUseExtraStatAuthority:!1,statsUseExtraStatCharm:!0,statsAptitudesUseRiding:!0,statsAptitudesUseFlying:!0,statsAptitudesUseAuthority:!1,statsAptitudesUseArmor:!1,globalWeaponsTypes:{types:[{name:"Sword",icon:"",id:"sword",magic:!1,ranges:[1,2],defaultRange:1},{name:"Lance",icon:"",id:"lance",magic:!1,ranges:[1,2],defaultRange:1},{name:"Axe",icon:"",id:"axe",magic:!1,ranges:[1,2],defaultRange:1},{name:"Bow",icon:"",id:"bow",magic:!1,ranges:[1,2,3,4],defaultRange:2},{name:"Gauntlet",icon:"",id:"gauntlet",magic:!1,ranges:[1],defaultRange:1},{name:"Dagger",icon:"",id:"dagger",magic:!1,ranges:[1,2],defaultRange:1}]}},_=["unitsCanHaveChildren","useExperienceSublevels","useExperienceAptitudes","combatCombatArts","combatWeaponTriangle","combatExpandedWeaponTriangle","combatMagicTriangle","combatBattalions","combatBattalionEndurance","combatPairUp","combatAdjutants","combatAdjutantHeal","combatAdjutantGuard","combatAdjutantAttack","statsUseExtraStatWeight","statsExtraStatWeightAffectsMovement","statsUseExtraStatLuck","combatSeparateCritAvoid","statsUseExtraStatAuthority","statsUseExtraStatCharm","statsAptitudesUseRiding","statsAptitudesUseFlying","statsAptitudesUseAuthority","statsAptitudesUseArmor"],k=["combatCombatArtLimit","combatWeaponTriangleAdvantage","combatWeaponTriangleDisadvantage","combatMagicTriangleAdvantage","combatMagicTriangleDisadvantage","combatBattalionLimit"],C=["unitEditorAvatarDefaultHairColor","unitEditorAvatarDefaultEyeColor"],S=["unit-editor-basic-fields","unit-editor-friend-fields","unit-editor-avatar-fields","unit-editor-enemy-fields","unit-editor-npc-fields"];_.forEach((e=>{Object.defineProperty(window,e,{get:function(){return"true"===localStorage.getItem(e)},set:function(t){localStorage.setItem(e,t)}}),localStorage.getItem(e)||(window[e]=x[e])})),k.forEach((e=>{Object.defineProperty(window,e,{get:function(){const t=localStorage.getItem(e);return t?parseInt(t,10):null},set:function(t){localStorage.setItem(e,t)}}),localStorage.getItem(e)||(window[e]=x[e])})),C.forEach((e=>{Object.defineProperty(window,e,{get:function(){return localStorage.getItem(e)},set:function(t){localStorage.setItem(e,t)}}),localStorage.getItem(e)||(window[e]=x[e])})),["combatTriangleMapping","combatMagicTriangleMapping","globalWeaponsTypes"].forEach((e=>{Object.defineProperty(window,e,{get:function(){return JSON.parse(localStorage.getItem(e))},set:function(t){localStorage.setItem(e,JSON.stringify(t))}}),localStorage.getItem(e)||(window[e]=x[e])})),["combatTriangleTypes","combatNeutralTypes","combatMagicTriangleTypes","combatNeutralMagicTypes"].forEach((e=>{Object.defineProperty(window,e,{get:function(){return localStorage.getItem(e).split(",")},set:function(t){localStorage.setItem(e,t.join(","))}}),localStorage.getItem(e)||(window[e]=x[e])}));const E=()=>{S.forEach((e=>{n[e]?n[e].updateGlobals():window.turnrootEditorLogs.push(`${new Date}||error||Form ${e} not found`)}))};let T=[{field:"hp",type:"int",html:{label:"HP",attr:"",column:1}},{field:"str",type:"int",html:{label:"Strength",attr:"",column:1}},{field:"mag",type:"int",html:{label:"Magic",attr:"",column:1}},{field:"skl",type:"int",html:{label:"Skill",attr:"",column:1}},{field:"spd",type:"int",html:{label:"Speed",attr:"",column:1}},{field:"def",type:"int",html:{label:"Defense",attr:"",column:1}},{field:"res",type:"int",html:{label:"Resistance",attr:"",column:1}},{field:"mov",type:"int",html:{label:"Movement",attr:"",column:1}}];window.statsUseExtraStatWeight&&(T.push({field:"weight",type:"int",html:{label:"Weight",attr:"",column:1}}),T.push({field:"con",type:"int",html:{label:"Constitution",attr:"",column:1}})),window.statsUseExtraStatCharm&&T.push({field:"cha",type:"int",html:{label:"Charisma",attr:"",column:1}}),window.statsUseExtraStatLuck&&T.push({field:"lck",type:"int",html:{label:"Luck",attr:"",column:1}}),window.statsUseExtraStatAuthority&&T.push({field:"authority",type:"int",html:{label:"Authority",attr:"",column:1}}),window.turnrootEditorLogs.push(`${new Date}||info||Global stats loaded`);const A=T;let I=0;let D=1,z={};const M=e=>{Object.keys(e).forEach((t=>{z[t]=e[t]})),D=1};window.unitEditorStatGrowthModalReset=e=>M(e),window.unitEditorStatGrowthModalReset=e=>M(e);let O=(e,t)=>{let i="";return Object.keys(e).forEach((t=>{let s=e[t];Math.floor(100*Math.random())<s&&z[t]++,i+=`<tr><td>${t}</td><td>${z[t]}</td></tr>`})),i};window.unitEditorStatGrowthModalTestGrowth=(e,t)=>O(e),window.unitEditorStatGrowthModalBuild=e=>(e=>(z={...e},window.unitEditorStatGrowthModalTestGrowth(e,D),`\n    <p>Each time a unit levels up, they have a 0-100% chance of any given stat increasing. You can set those here.</p>\n    <table>\n        <tr>\n            <th>Stat</th>\n            <th>Growth</th>\n        </tr>\n        ${Object.entries(e).map((([e,t])=>`<tr><td>${e}</td><td><input type="number" class="w2ui-input w2field" value="${t}" id="growth-rate-modal-${e}"></td></tr>`)).join("")}\n    </table>\n    <div class = "flex"><button class="w2ui-btn" id ='test-growth-btn'>Test Growth</button><button class="w2ui-btn" id ='reset-growth-btn'>Reset </button></div>\n    \n    <p>This will take the base stats and the current growth rates and "level up" your unit. Each click increases the level by 1.<br/>Note that this isn't a prediction of what <em>will</em> happen- just an example of what <em>might</em> happen.</p>\n    <p id="current-level">Current Level: Level ${D}</p>\n    <table id ='level-up-table'>\n        <tr>\n            <th>Stat</th>\n            <th>Value</th>\n        </tr>\n    </table>\n    </div>`))(e);let R={name:"unit-editor-basic-fields",record:{name:"New Unit",pronouns:"they/them/their/theirs",subtype:"Avatar",notes:"",age:18,orientation:"straight",canSSupport:!0,canHaveChildren:!0,height:168,birthdayDay:1,birthdayMonth:1,shortBio:"",useAccentColors:!1},fields:[{field:"",type:"html",html:{html:"<h2>Basic Info</h2>",column:0}},{field:"name",type:"text",html:{label:"Unit name",attr:"",column:0}},{field:"pronouns",type:"select",html:{label:"Pronouns",attr:"",column:0},options:{items:["he/him/his/his","she/her/her/hers","they/them/their/theirs"]}},{field:"subtype",type:"radio",html:{label:"Subtype",attr:"",column:0},options:{items:["Avatar","NPC","Friend","Enemy"]}},{field:"age",type:"int",options:{min:0},html:{label:"Age",column:0}},{field:"orientation",type:"select",html:{label:"Orientation",attr:"",column:0},options:{items:["straight","gay/lesbian","bisexual","pansexual","asexual"]}},{field:"canSSupport",type:"checkbox",disabled:!1,html:{label:"Can S-Support",column:0}},{field:"canHaveChildren",type:"checkbox",html:{label:"Can have children",column:0}},{field:"isUnique",type:"checkbox",hidden:!0,html:{label:"Unique (only one of this unit can exist in the game)",column:0}},{type:"html",field:"uniqueBaseStatsRandomizer",hidden:!0,html:{html:'<button class="w2ui-btn">Randomize base stats</button>',column:0,class:"no-label"}},{field:"canRecruit",type:"checkbox",hidden:!0,html:{label:"Can be recruited to join player's team",column:0}},{field:"height",type:"int",options:{min:32,max:214},html:{label:"Height (cm)",column:0}},{field:"base-stats-header",type:"html",html:{class:"no-label",html:"<h2>Base Stats</h2>",column:1}},{field:"birthdayDay",type:"int",options:{min:1,max:31},html:{label:"Birthday Day",column:0}},{field:"birthdayMonth",type:"int",options:{min:1,max:12},html:{label:"Birthday Month",column:0}}]};A.forEach(((e,t)=>{R.fields.push({field:e.field,type:"int",options:{min:0},html:{label:e.html.label,attr:'style="width:2rem"',column:1}}),R.record[e.field]=0})),window.unitEditorHandleStatsGrowthPopup=e=>{(e=>{let t=document.createElement("div"),i={...e};t.style.width="100%",t.style.height="100%",t.style.padding="1rem",t.style.overflowY="auto",t.id="unit-editor-stat-growth-popup-inner";let s=window.unitEditorStatGrowthModalBuild(e);t.innerHTML=s,o.open({title:"Stat Growth",body:t,resizable:!0,actions:{save:{text:"Save",class:"w2ui-btn",onClick(e){window.turnrootEditorLogs.push(`${new Date}||info||Stat growth rates changed`),o.close()}},Cancel(){window.turnrootEditorLogs.push(`${new Date}||info||Stat growth rates unchanged`),e=i,o.close()}}}).then((()=>{let t=document.querySelector("#unit-editor-stat-growth-popup-inner").parentElement.parentElement.parentElement;t.style.height="60vh",t.style.width="50vw",t.style.minHeight="400px",t.style.top="20vh",t.style.left="25vw",window.turnrootEditorLogs.push(`${new Date}||info||Stat growth rates modal opened`),document.getElementById("test-growth-btn").addEventListener("click",(()=>{let t=O(e);document.getElementById("level-up-table").innerHTML=`\n                <tr>\n                    <th>Stat</th>\n                    <th>Value</th>\n                </tr>\n                ${t}\n            `,D++,document.getElementById("current-level").innerHTML=`Current Level: Level ${D}`})),document.getElementById("reset-growth-btn").addEventListener("click",(()=>{M(i),document.getElementById("level-up-table").innerHTML="\n                <tr>\n                    <th>Stat</th>\n                    <th>Value</th>\n                </tr>\n            ",D=1,document.getElementById("current-level").innerHTML=`Current Level: Level ${D}`}))})),Object.keys(e).forEach((t=>{document.getElementById(`growth-rate-modal-${t}`).addEventListener("change",(i=>{e[t]=Number(i.target.value)}))}))})(A.reduce(((e,t)=>(e[t.field]=0,e)),{}))},R.fields.push({type:"html",field:"growth-rates",class:"no-label",html:{class:"no-label",html:"<button id='growth-rates-button' onclick='window.unitEditorHandleStatsGrowthPopup()' class='w2ui-btn'>Growth Rates</button>",column:1,attr:'style="width:100%;margin-top:.5rem"'}}),R.fields.push({type:"textarea",field:"notes",html:{label:"Notes",attr:"",column:2}}),R.fields.push({type:"html",html:{html:"<em><small>Notes are just for you, they're not added to your game</small></em>",column:2,attr:'style="width:100%;margin-top:.5rem"'}}),R.fields.push({type:"textarea",field:"shortBio",html:{label:"Short Bio",attr:"",column:2}}),R.fields.push({type:"html",html:{html:"<em><small>Color class sprites with unique unit colors</small></em>",column:2,attr:'style="width:100%;margin-top:.5rem"'}}),R.fields.push({type:"checkbox",field:"useAccentColors",html:{label:"Use accent colors",attr:"",column:2}}),R.fields.push({type:"html",field:"unit-accent-color-1",hidden:!0,html:{label:"Accent color 1",attr:"",column:2,html:'<input type="color" value="#000000">'}}),R.fields.push({type:"html",field:"unit-accent-color-2",hidden:!0,html:{label:"Accent color 2",attr:"",column:2,html:'<input type="color" value="#000000">'}});let F=new y(R);F.on("change",(e=>{((e,t)=>{let i=t.detail.field,s=t.detail.value;window.turnrootEditorLogs.push(`${new Date}||info||Unit field ${i} requested change to ${s.current}`),"useAccentColors"===i?!0===s.current?(e.show("unit-accent-color-1"),e.show("unit-accent-color-2")):(e.hide("unit-accent-color-1"),e.hide("unit-accent-color-2")):"canRecruit"===i?!0===s.current&&!1===e.get("isUnique").el.checked&&(e.setValue("isUnique",!0),r('A recruitable unit must be unique. The "isUnique" checkbox has been checked.'),e.show("uniqueBaseStatsRandomizer")):"isUnique"===i&&!1===s.current&&!0===e.get("canRecruit").el.checked?!0===e.get("canRecruit").el.checked&&(e.setValue("canRecruit",!1),r('A recruitable unit must be unique. The "canRecruit" checkbox has been unchecked.'),e.hide("uniqueBaseStatsRandomizer")):"isUnique"===i?!0===s.current?e.show("uniqueBaseStatsRandomizer"):e.hide("uniqueBaseStatsRandomizer"):"subtype"===i&&(e.lock("",!0),"Avatar"===s.current&&I>0?e.message({body:'<div class="w2ui-centered">You already have an Avatar unit. You cannot create another.</div>',width:400,height:200,actions:{OK(){e.setValue("subtype",s.previous),e.unlock(),e.message()}}}):e.message({body:'<div class="w2ui-centered">Do you want to change the subtype? This will significantly alter your unit.</div>',width:400,height:200,actions:{Yes(){"Avatar"===s.previous&&"Avatar"!==s.current&&I--;let t=n["unit-editor-bottom-toolbar"];switch(s.current){case"Avatar":I++,e.show("orientation"),e.show("canSSupport"),e.show("canHaveChildren"),e.hide("canRecruit"),e.show("height"),e.show("birthdayDay"),e.show("birthdayMonth"),e.show("age"),e.hide("isUnique"),A.forEach(((t,i)=>{e.show(t.field)})),e.show("useAccentColors"),e.show("growth-rates"),e.show("base-stats-header"),e.unlock(),e.message(),e.disable("canSSupport"),t.get("unit-editor-bottom-toolbar-behavior").hidden=!0,t.refresh();break;case"NPC":e.hide("orientation"),e.hide("canSSupport"),e.hide("canHaveChildren"),e.hide("canRecruit"),A.forEach(((t,i)=>{e.hide(t.field)})),e.hide("growth-rates"),e.hide("unit-accent-color-1"),e.hide("unit-accent-color-2"),e.hide("base-stats-header"),e.hide("useAccentColors"),e.hide("height"),e.hide("birthdayDay"),e.hide("birthdayMonth"),e.hide("age"),e.show("isUnique"),e.unlock(),e.message(),t.get("unit-editor-bottom-toolbar-behavior").hidden=!0,t.refresh();break;case"Friend":e.show("orientation"),e.show("canSSupport"),e.show("canHaveChildren"),e.show("canRecruit"),A.forEach(((t,i)=>{e.show(t.field)})),e.show("growth-rates"),e.show("useAccentColors"),e.show("base-stats-header"),e.show("height"),e.show("birthdayDay"),e.show("birthdayMonth"),e.show("age"),e.show("isUnique"),e.unlock(),e.message(),e.enable("canSSupport"),t.get("unit-editor-bottom-toolbar-behavior").hidden=!1,t.refresh();break;case"Enemy":e.hide("canSSupport"),e.hide("orientation"),e.hide("canHaveChildren"),e.show("canRecruit"),A.forEach(((t,i)=>{e.hide(t.field)})),e.show("useAccentColors"),e.hide("growth-rates"),e.hide("base-stats-header"),e.hide("height"),e.hide("birthdayDay"),e.hide("birthdayMonth"),e.hide("age"),e.show("isUnique"),e.unlock(),e.message(),t.get("unit-editor-bottom-toolbar-behavior").hidden=!1,t.refresh()}e.unlock(),e.message()},No(){e.setValue("subtype",s.previous),e.unlock(),e.message()}}}))})(F,e)})),F.updateGlobals=()=>{window.unitsCanHaveChildren?F.fields.find((e=>"canHaveChildren"===e.field)).hidden=!1:F.fields.find((e=>"canHaveChildren"===e.field)).hidden=!0},F.updateGlobals();const L=F,j=new g({name:"UnitEditorLeft",flatButton:!1,icon:{text(e){}},nodes:["Unit 1","Unit 2","Unit 3"].map((e=>({id:e,text:e})))});let N=new m({name:"UnitEditorTopMenu",tooltip:"bottom",items:[{type:"button",id:"new-unit",text:"New unit",class:"w2ui-btn",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>'},{type:"button",id:"unit-checklist",text:"Unit checklist",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>'},{type:"spacer"},{type:"button",id:"delete-unit",text:"Delete unit",class:"w2ui-btn slider1",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>'}]});N.on("click",(function(e){e.done((()=>{window.turnrootEditorLogs.push(`${new Date}||info||Unit toolbar button clicked: ${JSON.stringify(e.target)}`)}))}));const H=N;let P=window.globalWeaponsTypes.types;P.forEach((e=>{e.html={},e.type=e.id,e.html.label=e.name})),window.turnrootEditorLogs.push(`${new Date}||info||Global weapon types loaded`);const B=P;let U,W=[];U=window.useExperienceSublevels?{items:["E","E+","D","D+","C","C+","B","B+","A","A+","S"]}:{items:["E","D","C","B","A","S"]},window.statsAptitudesUseRiding&&W.push({field:"riding",type:"select",options:U,html:{label:"Riding",attr:"",column:0}}),window.statsAptitudesUseFlying&&W.push({field:"flying",type:"select",options:U,html:{label:"Flying",attr:"",column:0}}),window.statsAptitudesUseAuthority&&W.push({field:"authority",type:"select",options:U,html:{label:"Authority",attr:"",column:0}}),window.statsAptitudesUseArmor&&W.push({field:"armor",type:"select",options:U,html:{label:"Armor",attr:"",column:0}});for(let e of B)W.push({field:e.type,type:"select",options:U,html:{label:e.html.label,attr:"",column:0}});window.turnrootEditorLogs.push(`${new Date}||info||Global experiences loaded`);const V=W;let q={name:"unit-editor-friend-fields",record:{},fields:[{type:"html",html:{html:"<div><h2>Uniques</h2><small>Set classes, items, and skills only this unit (or their children, if inheritance is on), can have. Personal skills and classes are set here.</br></br>If there are no classes, items, or skills available to select, you can create them by clicking Skills, Items, or Classes on the left sidebar.</small></div>"}},{type:"html",html:{html:"<h3>Unique skills</h3>"}},{field:"unique-skills",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Skill 1","Skill 2","Skill 3","Skill 4","Skill 5"]}},{type:"html",html:{html:"<h3>Unique classes</h3>"}},{field:"unique-classes",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Class 1","Class 2","Class 3","Class 4","Class 5"]}},{type:"html",html:{html:"<h3>Unique items</h3>"}},{field:"unique-items",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Item 1","Item 2","Item 3","Item 4","Item 5"]}},{type:"html",html:{html:"<h2>Base aptitudes</h2>",column:0}}]};q.fields.push({type:"html",html:{html:window.useExperienceAptitudes?"<small>Set this unit's starting aptitudes, as well as their affinity for them (positive, negative, or neutral).</br>A positive affinity means this unit will learn it faster, a negative means slower.</small>":"<small>Set this unit's starting aptitudes.</small>",column:0}}),V.forEach(((e,t)=>{e.field="friend-base-aptitudes-"+e.field.toLowerCase(),e.html.group=e.field,e.html.class="group-flex",q.fields.push(e),q.fields.push({type:"html",field:e.field+"-affinity-friend",html:{class:"no-label",attr:'style="width:max-content"',column:0,html:`<div style = "display:flex;align-items:center;flex-wrap:wrap;width:100%;"><p style = "margin-right:.25rem;">Affinity:</p><input type = "radio" name = "${e.field+"-affinity-radio"}" class="w2ui-input"><label style = "font-size:1.5rem;margin-right:.5rem;">-</label></input><input name = "${e.field+"-affinity-radio"}" type = "radio" class="w2ui-input" checked><label style = "font-size:1rem;margin-right:.5rem;">None</label></input><input name = "${e.field+"-affinity-radio"}" type = "radio" class="w2ui-input"><label style = "font-size:1.5rem;margin-right:.5rem;">+</label></input></div>`}}),q.record[e.field+"-affinity-friend"]="None",q.record[e.field]="E"}));let Y=new y(q);Y.updateGlobals=()=>{let e;window.useExperienceAptitudes?(e=Y.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!1))):(e=Y.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!0)))},Y.updateGlobals(),Y.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.turnrootEditorLogs.push(`${new Date}||info||Friend field ${i} requested change to ${s.current}`)})(e)}));const G=Y;let X;localStorage.getItem("hairColors")?X=JSON.parse(localStorage.getItem("hairColors")):(X=["rgb(39, 31, 86)","rgb(218, 145, 32)","rgb(139, 69, 19)","rgb(84, 42, 2)","rgb(171, 33, 0)","rgb(34, 223, 154)","rgb(34, 162, 231)","rgb(255, 192, 208)","rgb(255, 222, 176)","rgb(255, 105, 180)"],localStorage.setItem("hairColors",JSON.stringify(X))),window.setDefaultHairColor=e=>{e.preventDefault(),document.querySelector("#unit-editor-avatar-hair-colors").querySelectorAll(".hidden-until-hover-wrapper").forEach((e=>e.style.border="")),e.target.style.border="2px solid var(--accent)",window.unitEditorAvatarDefaultHairColor=e.target.style.backgroundColor},window.unitEditorAvatarRemoveHairColor=e=>{e.preventDefault();let t=e.target.style.backgroundColor;X=X.filter((e=>e!==t)),window.turnrootEditorLogs.push(`${new Date}||info||Removed hair color: ${t}`);let i='<div id = "unit-editor-avatar-hair-colors">';for(let e of X)i+=`<div class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultHairColor(event)" onclick="unitEditorAvatarRemoveHairColor(event)"></div>`;i+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddHairColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-hair-colors").innerHTML=i,localStorage.setItem("hairColors",JSON.stringify(X))},window.unitEditorAvatarAddHairColor=e=>{let t=(i=e.target.previousElementSibling.value,`rgb(${parseInt(i.substring(1,3),16)}, ${parseInt(i.substring(3,5),16)}, ${parseInt(i.substring(5,7),16)})`);var i;X.push(t),window.turnrootEditorLogs.push(`${new Date}||info||Added hair color: ${t}`);let s='<div id = "unit-editor-avatar-hair-colors">';for(let e of X)s+=`<div id="unit-editor-avatar-hair-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultHairColor(event)" onclick="unitEditorAvatarRemoveHairColor(event)"></div>`;s+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddHairColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-hair-colors").innerHTML=s,localStorage.setItem("hairColors",JSON.stringify(X))};let K='<div id = "unit-editor-avatar-hair-colors">';for(let e of X)K+=`<div id="unit-editor-avatar-hair-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"  oncontextmenu="setDefaultHairColor(event)" onclick="unitEditorAvatarRemoveHairColor(event)"></div>`;K+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddHairColor(event)">Add color</button></div></div>';const J=K;let Q;localStorage.getItem("eyeColors")?Q=JSON.parse(localStorage.getItem("eyeColors")):(Q=["rgb(104, 52, 2)","rgb(124, 183, 74)","rgb(34, 132, 181)","rgb(130, 150, 210)"],localStorage.setItem("eyeColors",JSON.stringify(Q))),window.setDefaultEyeColor=e=>{e.preventDefault(),document.querySelector("#unit-editor-avatar-eye-colors").querySelectorAll(".hidden-until-hover-wrapper").forEach((e=>e.style.border="")),e.target.style.border="2px solid var(--accent)",window.unitEditorAvatarDefaultEyeColor=e.target.style.backgroundColor},window.unitEditorAvatarRemoveEyeColor=e=>{e.preventDefault();let t=e.target.style.backgroundColor;Q=Q.filter((e=>e!==t)),window.turnrootEditorLogs.push(`${new Date}||info||Removed eye color: ${t}`);let i='<div id = "unit-editor-avatar-eye-colors">';for(let e of Q)i+=`<div class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultEyeColor(event)" onclick="unitEditorAvatarRemoveEyeColor(event)"></div>`;i+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddEyeColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-eye-colors").innerHTML=i,localStorage.setItem("eyeColors",JSON.stringify(Q))},window.unitEditorAvatarAddEyeColor=e=>{let t=(i=e.target.previousElementSibling.value,`rgb(${parseInt(i.substring(1,3),16)}, ${parseInt(i.substring(3,5),16)}, ${parseInt(i.substring(5,7),16)})`);var i;Q.push(t),window.turnrootEditorLogs.push(`${new Date}||info||Added eye color: ${t}`);let s='<div id = "unit-editor-avatar-eye-colors">';for(let e of Q)s+=`<div id="unit-editor-avatar-eye-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;" oncontextmenu="setDefaultEyeColor(event)" onclick="unitEditorAvatarRemoveEyeColor(event)"></div>`;s+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddEyeColor(event)">Add color</button></div></div>',document.querySelector("#unit-editor-avatar-eye-colors").innerHTML=s,localStorage.setItem("eyeColors",JSON.stringify(Q))};let Z='<div id = "unit-editor-avatar-eye-colors">';for(let e of Q)Z+=`<div id="unit-editor-avatar-eye-colors" class="hidden-until-hover-wrapper" style="background-color:${e};width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"  oncontextmenu="setDefaultEyeColor(event)" onclick="unitEditorAvatarRemoveEyeColor(event)"></div>`;Z+='<div style="display:flex;"><input type = "color" style = "width:2rem;height:2rem;display:inline-block;margin:0.25rem;border-radius:.25rem;"><button class= "w2ui-btn" onclick="unitEditorAvatarAddEyeColor(event)">Add color</button></div></div>';const ee=Z;let te={name:"unit-editor-avatar-fields",record:{},fields:[{type:"html",html:{html:"<div><h2>Uniques</h2><small>Set classes, items, and skills only this unit (or their children, if inheritance is on), can have. Personal skills and classes are set here.</br></br>If there are no classes, items, or skills available to select, you can create them by clicking Skills, Items, or Classes on the left sidebar.</small></div>"}},{type:"html",html:{html:"<h3>Unique skills</h3>"}},{field:"unique-skills",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Skill 1","Skill 2","Skill 3","Skill 4","Skill 5"]}},{type:"html",html:{html:"<h3>Unique classes</h3>"}},{field:"unique-classes",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Class 1","Class 2","Class 3","Class 4","Class 5"]}},{type:"html",html:{html:"<h3>Unique items</h3>"}},{field:"unique-items",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Item 1","Item 2","Item 3","Item 4","Item 5"]}},{type:"html",html:{html:"<h2>Base aptitudes</h2>",column:0}},{type:"html",html:{html:"<div><h2>Appearance</h2><small>Set the options that the player will have to customize their avatar's appearance. Right-click to set the default. Click to delete.</small></div>",column:1}},{type:"html",html:{html:`<div><h3>Hair colors</h3><small>Default: <span style = "width:2rem;height:1rem;background-color:${window.unitEditorAvatarDefaultHairColor};display:inline-block;border-radius:.25rem;"</small></div>`,column:1}},{type:"html",field:"hair-colors",html:{class:"no-label",attr:'style="width:12rem"',column:1,html:J}},{type:"html",html:{html:`<div><h3>Eye colors</h3><small>Default: <span style = "width:2rem;height:1rem;background-color:${window.unitEditorAvatarDefaultEyeColor};display:inline-block;border-radius:.25rem;"</small></div>`,column:1}},{type:"html",field:"eye-colors",html:{class:"no-label",attr:'style="width:12rem"',column:1,html:ee}}]};te.fields.push({type:"html",html:{html:window.useExperienceAptitudes?"<small>Set this unit's starting aptitudes, as well as their affinity for them (positive, negative, or neutral).</br>A positive affinity means this unit will learn it faster, a negative means slower.</small>":"<small>Set this unit's starting aptitudes.</small>",column:0}}),V.forEach(((e,t)=>{e.field="avatar-base-aptitudes-"+e.field.toLowerCase(),e.html.group=e.field,e.html.class="group-flex",te.fields.push(e),te.fields.push({type:"html",field:e.field+"-affinity-avatar",html:{class:"no-label",attr:'style="width:max-content"',column:0,html:`<div style = "display:flex;align-items:center;flex-wrap:wrap;width:100%;"><p style = "margin-right:.25rem;">Affinity:</p><input type = "radio" name = "${e.field+"-affinity-radio"}" class="w2ui-input"><label style = "font-size:1.5rem;margin-right:.5rem;">-</label></input><input name = "${e.field+"-affinity-radio"}" type = "radio" class="w2ui-input" checked><label style = "font-size:1rem;margin-right:.5rem;">None</label></input><input name = "${e.field+"-affinity-radio"}" type = "radio" class="w2ui-input"><label style = "font-size:1.5rem;margin-right:.5rem;">+</label></input></div>`}}),te.record[e.field+"-affinity-avatar"]="None",te.record[e.field]="E"}));let ie=new y(te);ie.updateGlobals=()=>{let e;window.useExperienceAptitudes?(e=ie.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!1))):(e=ie.fields.filter((e=>e.field?.includes("affinity"))),e.forEach((e=>e.html.hidden=!0)))},ie.updateGlobals(),ie.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.turnrootEditorLogs.push(`${new Date}||info||Avatar field ${i} requested change to ${s.current}`)})(e)}));const se=ie;let le=new y({name:"unit-editor-enemy-fields",record:{},fields:[{type:"html",html:{html:"<div><h2>Uniques</h2><small>Set classes, items, and skills only this unit can have. Personal skills and classes are set here.</br></br>If there are no classes, items, or skills available to select, you can create them by clicking Skills, Items, or Classes on the left sidebar.</small></div>"}},{type:"html",html:{html:"<h3>Unique skills</h3>"}},{field:"enemy-unique-skills",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Skill 1","Skill 2","Skill 3","Skill 4","Skill 5"]}},{type:"html",html:{html:"<h3>Unique classes</h3>"}},{field:"enemy-unique-classes",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Class 1","Class 2","Class 3","Class 4","Class 5"]}},{type:"html",html:{html:"<h3>Unique items</h3>"}},{field:"enemy-unique-items",type:"enum",html:{class:"no-label",attr:'style="width:10rem"',column:0},options:{openOnFocus:!0,max:3,items:["Item 1","Item 2","Item 3","Item 4","Item 5"]}}]});le.updateGlobals=()=>{window.turnrootEditorLogs.push(`${new Date}||info||Updating Enemy form globals`)},le.updateGlobals(),le.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.turnrootEditorLogs.push(`${new Date}||info||Enemy field ${i} requested change to ${s.current}`)})(e)}));const ne=le;let ae=new y({name:"unit-editor-npc-fields",record:{},fields:[]});ae.updateGlobals=()=>{window.turnrootEditorLogs.push(`${new Date}||info||Updating NPC form globals`)},ae.updateGlobals(),ae.on("change",(function(e){((e,t)=>{let i=e.detail.field,s=e.detail.value;window.turnrootEditorLogs.push(`${new Date}||info||Friend field ${i} requested change to ${s.current}`)})(e)}));const re=ae;let oe=null;document.onmouseup=e=>{oe&&(oe.dragging=!1,oe.thumb.style.width="1.25rem",oe.thumb.style.height="1.25rem",oe=null)},document.onmousemove=e=>{if(oe?.dragging){e.preventDefault(),oe.thumb.style.width="1.4rem",oe.thumb.style.height="1.4rem";let t=oe.track.getBoundingClientRect(),i=(e.clientX-t.left)/t.width*100;i<10&&(i=10),i>100&&(i=100);let s=Math.ceil(1.1*i-10-1),l=`color-mix(in oklab,var(--slider-0) ${s}%,var(--slider-1))`;oe.thumb.style.right=100-i+"%",oe.thumb.style.backgroundColor=l,oe.onchange(s)}};const de=class{constructor(e,t="h",i=50){this.value=i,this.container=e,this.hv=t,this.onchange=e=>e,this.sliderDiv=document.createElement("div"),this.sliderDiv.style.width="100%",this.sliderDiv.style.height="min-content",this.container.appendChild(this.sliderDiv),this.thumb=void 0,this.track=void 0,this.coloredRange(),this.dragging=!1}setValue(e){this.value=parseInt(e),this.thumb.style.right=100-this.value+"%";let t=`color-mix(in oklab,var(--slider-0) ${Math.ceil(1.1*this.value-10-1)}%,var(--slider-1))`;this.thumb.style.backgroundColor=t}coloredRange(){let e=document.createElement("div");"h"===this.hv?(e.style.width="100%",e.style.height="1.5rem"):(e.style.width="1.5rem",e.style.height="100%"),e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";let t=document.createElement("div");this.track=t,"h"===this.hv?(t.style.width="90%",t.style.height="3px"):(t.style.width="3px",t.style.height="90%"),t.style.backgroundColor="color-mix(in srgb,var(--window-background) 60%,var(--window-background-alt))",t.style.position="relative",e.appendChild(t);let i=document.createElement("div");this.thumb=i,i.className="no-transition",i.style.width="1.25rem",i.style.height="1.25rem",i.style.borderRadius=".25rem",i.style.position="relative",i.style.right=`${this.value}%`,i.style.backgroundColor="var(--slider-0)",i.onmousedown=e=>{e.preventDefault(),oe=this,oe.thumb=i,oe.sliderDiv=this.sliderDiv,oe.track=t,this.dragging=!0,i.style.width="1.4rem",i.style.height="1.4rem"},this.sliderDiv.onmousedown=e=>{e.preventDefault(),oe=this,oe.dragging=!0,oe.thumb=i;let s=i.getBoundingClientRect(),l=!1;if(e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom&&(l=!0),!l){oe.sliderDiv=this.sliderDiv,oe.track=t;let s=""+(100-(e.clientX-t.getBoundingClientRect().left)/t.getBoundingClientRect().width*100-12);s<10&&(s=10),s>100&&(s=100);let l=Math.ceil(1.1*s-10-1);l>100&&(l=100);let n=`color-mix(in oklab,var(--slider-0) ${l}%,var(--slider-1))`;i.style.backgroundColor=n,oe.thumb.style.right=`${s}%`}},e.appendChild(i),this.sliderDiv.appendChild(e)}};let he=document.createElement("div");he.style.width="100%",he.style.height="100%",he.style.padding="1rem";let ce=document.createElement("div");ce.style.maxWidth="100ch",ce.style.lineHeight="1.5rem",ce.innerHTML="\n    <div><h2>How does all this work?</h2>\n    <em>As noted above, you should generally not worry about specific rules and just load a preset, then tweak the sliders.</em> \n    <h3>Sliders</h3>\n    The sliders control the priority of a rule. The higher the priority, the more likely that rule is to occur.\n    <h3>Customizing rules</h3>\n    You can customize any rule with the dropdowns. For example, you could change Move towards nearest foe (Mindless) to Move towards nearest foe (Lone Wolf) by selecting 'Lone Wolf' from the dropdown.<br/><br/>\n    The Priority and Target columns are customizable- the rule columns are set in stone. You can disable rules, but not add or change them. <br/><br/>",he.appendChild(ce);let ue=[],pe=[];he.innerHTML="<div><h2>Behavior</h2>\n<p>Units that move on their own have their behaviors controlled by these sliders, which in turn influence the priority of the rules below. The presets will cover most common cases- for specific units, you can tweak things as needed. Generally, you just need to load a preset.<br/><br/>For special behaviors, see the Specials tab.</p></div>\n";let me=document.createElement("div");me.style.display="flex",me.style.flexWrap="wrap",me.style.justifyContent="center",me.style.gap=".25rem",me.style.marginBottom="1rem",me.style.width="100%";let ge=document.createElement("button");ge.innerHTML="Foot Soldier",ge.className="w2ui-btn";let fe=document.createElement("button");fe.innerHTML="Mindless Creature",fe.className="w2ui-btn";let be=document.createElement("button");be.innerHTML="Cautious Healer",be.className="w2ui-btn";let ve=document.createElement("button");ve.innerHTML="Sniper",ve.className="w2ui-btn";let ye=document.createElement("button");ye.innerHTML="Steadfast Tank",ye.className="w2ui-btn";let we=document.createElement("button");we.innerHTML="Independent Assassin",we.className="w2ui-btn";let xe=document.createElement("button");xe.innerHTML="Vengeful Demon",xe.className="w2ui-btn";let _e=document.createElement("button");_e.innerHTML="Weak Coward",_e.className="w2ui-btn";let ke=document.createElement("button");ke.innerHTML="Looter",ke.className="w2ui-btn";let Ce=[ge,fe,be,ve,ye,we,xe,_e,ke],Se=[{left:"Move towards",center:"nearest foe",right:"Mindless"},{left:"Move towards",center:"disadvantaged foe",right:"Strategic"},{left:"Move towards",center:"last attacked foe",right:"Team Player"},{left:"Move towards",center:"safety",right:"Coward"},{left:"Move towards",center:"cover",right:"Coward"},{left:"Move towards",center:"hurt ally (can heal or rally)",right:"Selfless"},{left:"Move towards",center:"nearest objective tile",right:"Strategic"},{left:"Move towards",center:"chest (if can open)",right:"Greedy"},{left:"Move towards",center:"door (if can open)",right:"Lone Wolf"},{left:"Move towards",center:"fortress",right:"Strategic"},{left:"Move towards",center:"emplacement",right:"Lone Wolf"},{left:"Move towards",center:"minimize receiving attack count",right:"Team Player"},{left:"Move towards",center:"team leader",right:"Team Player"},{left:"Move towards",center:"furthest distance",right:"Lone Wolf"},{left:"Move towards",center:"player avatar",right:"Hero"}],Ee={Default:["Move towards nearest foe","Move towards last attacked foe","Move towards disadvantaged foe","Move towards nearest objective tile","Move towards team leader"],MindlessCreature:["Move towards nearest foe","Move towards last attacked foe","Move towards nearest objective tile","Move towards furthest distance"],CautiousHealer:["Move towards disadvantaged foe","Move towards minimize receiving attack count","Move towards safety","Move towards hurt ally (can heal or rally)","move towards fortress","Move towards cover"],Sniper:["Move towards disadvantaged foe","Move towards last attacked foe","Move towards furthest distance","Move towards minimize receiving attack count","move towards emplacement","Move towards safety","Move towards cover"],SteadfastTank:["Move towards nearest foe","Move towards last attacked foe","Move towards fortress","Move towards player avatar","Move towards disadvantaged foe","Move towards team leader","Move towards nearest objective tile"],IndependentAssassin:["Move towards disadvantaged foe","Move towards last attacked foe","Move towards furthest distance","Move towards minimize receiving attack count","Move towards safety","Move towards cover","Move towards player avatar"],WeakCoward:["Move towards safety","Move towards cover","Move towards hurt ally (can heal or rally)","Move towards nearest objective tile","Move towards team leader","Move towards minimize receiving attack count"],Looter:["Move towards chest (if can open)","Move towards door (if can open)","Move towards safety","Move towards disadvantaged foe","Move towards nearest objective tile","minimize receiving attack count"],VengefulDemon:["Move towards last attacked foe","Move towards disadvantaged foe","Move towards nearest foe","Move towards player avatar"]},$e={Default:{"unitEditorBehavior.TeamPlayer":20,"unitEditorBehavior.Hero":40,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":55,list:[20,40,50,55]},MindlessCreature:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":50,"unitEditorBehavior.Strategic":90,"unitEditorBehavior.Selfless":50,list:[90,50,90,50]},CautiousHealer:{"unitEditorBehavior.TeamPlayer":20,"unitEditorBehavior.Hero":30,"unitEditorBehavior.Strategic":20,"unitEditorBehavior.Selfless":10,list:[20,30,20,10]},Sniper:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":70,"unitEditorBehavior.Strategic":10,"unitEditorBehavior.Selfless":80,list:[90,70,10,80]},SteadfastTank:{"unitEditorBehavior.TeamPlayer":10,"unitEditorBehavior.Hero":10,"unitEditorBehavior.Strategic":60,"unitEditorBehavior.Selfless":50,list:[10,10,60,50]},IndependentAssassin:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":90,"unitEditorBehavior.Strategic":10,"unitEditorBehavior.Selfless":90,list:[90,90,10,90]},WeakCoward:{"unitEditorBehavior.TeamPlayer":30,"unitEditorBehavior.Hero":90,"unitEditorBehavior.Strategic":40,"unitEditorBehavior.Selfless":70,list:[30,90,40,70]},Looter:{"unitEditorBehavior.TeamPlayer":90,"unitEditorBehavior.Hero":50,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":90,list:[90,50,50,90]},VengefulDemon:{"unitEditorBehavior.TeamPlayer":70,"unitEditorBehavior.Hero":10,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":30,list:[70,10,50,30]}};const Te=e=>{Oe.innerHTML="",ue.forEach(((t,i)=>{let s=$e[e].list[i];t.setValue(s)}));let t=Ee[e],i=document.createElement("div"),s=document.createElement("div"),l=document.createElement("div");Re(i,Fe),Re(s,Fe),Re(l,Fe),i.style.backgroundColor="var(--button-alt-text)",s.style.backgroundColor="var(--button-alt-text)",l.style.backgroundColor="var(--button-alt-text)",i.style.color="var(--window-background-alt)",s.style.color="var(--window-background-alt)",i.innerHTML="<strong>Rule</strong>",s.innerHTML="<strong>Target</strong>",l.innerHTML="<strong>Priority</strong>",Oe.appendChild(i),Oe.appendChild(s),Oe.appendChild(l),Se.forEach((e=>{if(t.includes(e.left+" "+e.center)){let t=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div");t.innerHTML=e.left,i.innerHTML=e.center,s.innerHTML=`\n            <select id="unitEditorBehaviorRule${e.left.replace(" ","")+e.center.replace(" ","")}" name="unitEditorBehaviorRule${e.left.replace(" ","")+e.center.replace(" ","")}" class="w2ui-input " tabindex="1" style = "width:100%;height:100%;margin:0;font-size:1rem;border-radius:0;" onchange='window.unitEditorBehaviorUpdateWindow()'>\n            <option value="Team Player" ${"Team Player"===e.right?"selected":""}>Team Player</option>\n            <option value="Lone Wolf" ${"Lone Wolf"===e.right?"selected":""}>Lone Wolf</option>\n            <option value="Hero" ${"Hero"===e.right?"selected":""}>Hero</option>\n            <option value="Coward" ${"Coward"===e.right?"selected":""}>Coward</option>\n            <option value="Strategic" ${"Strategic"===e.right?"selected":""}>Strategic</option>\n            <option value="Mindless" ${"Mindless"===e.right?"selected":""}>Mindless</option>\n            <option value="Selfless" ${"Selfless"===e.right?"selected":""}>Selfless</option>\n            <option value="Greedy" ${"Greedy"===e.right?"selected":""}>Greedy</option>\n            </select>`,Re(t,Fe),Re(i,Fe),Re(s,Fe,!1),s.style.margin="0",s.style.padding="0px!important",t.style.backgroundColor="var(--node-text)",i.style.backgroundColor="var(--node-title)",Oe.appendChild(t),Oe.appendChild(i),Oe.appendChild(s)}}))};ge.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),ge.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("Default"),window.unitEditorBehaviorUpdateWindow($e.Default)},fe.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),fe.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("MindlessCreature"),window.unitEditorBehaviorUpdateWindow($e.MindlessCreature)},be.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),be.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("CautiousHealer"),window.unitEditorBehaviorUpdateWindow($e.CautiousHealer)},ve.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),ve.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("Sniper"),window.unitEditorBehaviorUpdateWindow($e.Sniper)},ye.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),ye.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("SteadfastTank"),window.unitEditorBehaviorUpdateWindow($e.SteadfastTank)},we.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),we.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("IndependentAssassin"),window.unitEditorBehaviorUpdateWindow($e.IndependentAssassin)},_e.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),_e.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("WeakCoward"),window.unitEditorBehaviorUpdateWindow($e.WeakCoward)},xe.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),xe.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("VengefulDemon"),window.unitEditorBehaviorUpdateWindow($e.VengefulDemon)},ke.onclick=()=>{Ce.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),ke.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",Te("Looter"),window.unitEditorBehaviorUpdateWindow($e.Looter)},Ce.forEach((e=>{me.appendChild(e)})),he.appendChild(me);let Ae,Ie,De,ze,Me={"unitEditorBehavior.TeamPlayer":50,"unitEditorBehavior.Hero":50,"unitEditorBehavior.Strategic":50,"unitEditorBehavior.Selfless":50,list:[50,50,50,50]};[{left:"Team Player",right:"Lone Wolf"},{left:"Hero",right:"Coward"},{left:"Strategic",right:"Mindless"},{left:"Selfless",right:"Greedy"}].forEach((e=>{Ie=document.createElement("p"),Ie.innerHTML=e.left,Ie.style.width="12%",De=document.createElement("p"),De.innerHTML=e.right,De.style.width="12%",ze=document.createElement("div"),ze.style.flexGrow=2,Ae=new de(ze),Ae.onchange=t=>{Me[`unitEditorBehavior.${e.left.replace(" ","")}`]=t,He()},pe.push([Ie,ze,De]),ue.push(Ae)})),pe.forEach((e=>{let t=document.createElement("div");t.innerHTML="",t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.appendChild(e[0]),t.appendChild(e[1]),t.appendChild(e[2]),he.appendChild(t)}));let Oe=document.createElement("div");function Re(e,t,i=!0){Object.keys(t).forEach((s=>{i||"padding"!==s?e.style[s]=t[s]:e.style.padding="0"}))}Oe.id="unitEditorBehaviorRules",Oe.style.width="100%",Oe.style.display="grid",Oe.style.gridTemplateColumns="1fr 1fr 1fr";let Fe={padding:".5rem",border:"1px solid var(--window-background)",height:"2.5rem",color:"var(--window-background-alt)"},Le=document.createElement("div"),je=document.createElement("div"),Ne=document.createElement("div");Re(Le,Fe),Re(je,Fe),Re(Ne,Fe),Le.style.backgroundColor="var(--button-alt-text)",je.style.backgroundColor="var(--button-alt-text)",Ne.style.backgroundColor="var(--button-alt-text)",Le.style.color="var(--window-background-alt)",je.style.color="var(--window-background-alt)",Le.innerHTML="<strong>Rule</strong>",je.innerHTML="<strong>Target</strong>",Ne.innerHTML="<strong>Priority</strong>",Oe.appendChild(Le),Oe.appendChild(je),Oe.appendChild(Ne);const He=(e=null)=>{e||(e=Me),window.unitEditorBehaviorTeamPlayer=e["unitEditorBehavior.TeamPlayer"],window.unitEditorBehaviorHero=e["unitEditorBehavior.Hero"],window.unitEditorBehaviorStrategic=e["unitEditorBehavior.Strategic"],window.unitEditorBehaviorSelfless=e["unitEditorBehavior.Selfless"],e.list=[window.unitEditorBehaviorTeamPlayer,window.unitEditorBehaviorHero,window.unitEditorBehaviorStrategic,window.unitEditorBehaviorSelfless];let t=Oe.children;for(let e=3;e<t.length;e+=3){let i=[t[e],t[e+1],t[e+2]],s=i[2].children[0].value;i[2].children[0].style.backgroundColor="Team Player"===s||"Lone Wolf"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorTeamPlayer}%,var(--slider-1))`:"Hero"===s||"Coward"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorHero}%,var(--slider-1))`:"Strategic"===s||"Mindless"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorStrategic}%,var(--slider-1))`:"Selfless"===s||"Greedy"===s?`color-mix(in oklab,var(--slider-0) ${window.unitEditorBehaviorSelfless}%,var(--slider-1))`:"var(--node-text)"}};window.unitEditorBehaviorUpdateWindow=He,ue.forEach(((e,t)=>{let i=Me.list[t];e.setValue(i)})),He(),he.appendChild(Oe),Ne.style.backgroundColor="var(--button-alt-text)";const Pe=he;let Be=document.createElement("div");Be.style.width="100%",Be.style.height="100%",Be.style.padding="1rem",Be.innerHTML="<div><h2>Tile rules</h2>\nUnits that move on their own get their tile interaction rules from here. Exercise extreme caution here- you can very easily break your game with a single misclick here. There are no guardrails. Pick a preset and do not modify specifics unless you're confident in what you're doing! The default tile rules are correct for 99% of units, including riding and infantry units. You should use the \"Flier\" tile preset for all flying units.\n<h3>What are the presets?</h3>\n<ul>\n    <li><highlight>Default</highlight>: The default tile rules for most units.</li>\n    <li><highlight>Flier</highlight>: The tile rules for flying units.</li>\n    <li><highlight>Pirate</highlight>: Tile rules for units that are agile in water.</li>\n    <li><highlight>Beast</highlight>: Tile rules for units that are agile in forests and unaffected by fog or mist.</li>\n</ul>\nIf you're not sure which preset to use, use the Default preset. \n</div>\n";let Ue=document.createElement("div");Ue.style.display="flex",Ue.style.justifyContent="center",Ue.style.gap=".25rem",Ue.style.marginBottom="1rem",Ue.style.width="100%";let We=document.createElement("button");We.innerHTML="Default",We.className="w2ui-btn";let Ve=document.createElement("button");Ve.innerHTML="Flier",Ve.className="w2ui-btn";let qe=document.createElement("button");qe.innerHTML="Pirate",qe.className="w2ui-btn";let Ye=document.createElement("button");Ye.innerHTML="Beast",Ye.className="w2ui-btn";let Ge=[We,Ve,qe,Ye],Xe=[{left:"ground",right:["move","see"]},{left:"wall",right:["stop","see"]},{left:"cliff",right:["stop","blind"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["hurt immediately","hurt on turn start","move","see"]},{left:"fire",right:["hurt on turn start","move","see"]},{left:"sand",right:["move","slow*1","slow horse*2","see"]},{left:"stairs",right:["move","slow*.5","slow horse*1","see"]},{left:"ice",right:["move","slow*1.25","see"]},{left:"snow",right:["move","slow*2","blind*.5"]},{left:"shallow_water",right:["move","slow*1.5","slow horse*.5","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind","open"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see","arms"]},{left:"magic_emplacement",right:["move","see","arms"]},{left:"heal",right:["move","see","heal"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see","guard*1"]},{left:"avoid",right:["move","see","avoid*1"]},{left:"roof",right:["stop","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see","avoid*.5"]},{left:"bushes",right:["move","slow*.5","see","avoid*1"]},{left:"trees",right:["move","slow*1.5","see","avoid*1.5"]},{left:"boulder",right:["stop","see"]},{left:"fence",right:["stop","see"]},{left:"forest",right:["move","slow*1.5","slow horse*2","blind*.5","avoid*2","hidden"]},{left:"fog",right:["move","blind","stop if enemy","hidden"]},{left:"mist",right:["move","blind*.5","stop if enemy"]}],Ke=[{left:"ground",right:["move","see"]},{left:"wall",right:["move","see"]},{left:"cliff",right:["move","see"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["move","see"]},{left:"fire",right:["move","see"]},{left:"sand",right:["move","see"]},{left:"stairs",right:["move","see"]},{left:"ice",right:["move","see"]},{left:"snow",right:["move","blind*.5"]},{left:"shallow_water",right:["move","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see"]},{left:"magic_emplacement",right:["move","see"]},{left:"heal",right:["move","see"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see"]},{left:"avoid",right:["move","see"]},{left:"roof",right:["move","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see"]},{left:"bushes",right:["move","see"]},{left:"trees",right:["move","see"]},{left:"boulder",right:["move","see"]},{left:"fence",right:["move","see"]},{left:"forest",right:["move","see"]},{left:"fog",right:["move","blind","stop if enemy","hidden"]},{left:"mist",right:["move","blind*.5","stop if enemy"]}],Je=[{left:"ground",right:["move","see"]},{left:"wall",right:["stop","see"]},{left:"cliff",right:["stop","blind"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["hurt immediately","hurt on turn start","move","see"]},{left:"fire",right:["hurt on turn start","move","see"]},{left:"sand",right:["move","slow*1","slow horse*2","see"]},{left:"stairs",right:["move","slow*.5","slow horse*1","see"]},{left:"ice",right:["move","slow*1.25","see"]},{left:"snow",right:["move","slow*2","blind*.5"]},{left:"shallow_water",right:["move","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind","open"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see","arms"]},{left:"magic_emplacement",right:["move","see","arms"]},{left:"heal",right:["move","see","heal"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see","guard*1"]},{left:"avoid",right:["move","see","avoid*1"]},{left:"roof",right:["stop","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see","avoid*.5"]},{left:"bushes",right:["move","slow*.5","see","avoid*1"]},{left:"trees",right:["move","slow*1.5","see","avoid*1.5"]},{left:"boulder",right:["stop","see"]},{left:"fence",right:["stop","see"]},{left:"forest",right:["move","slow*1.5","slow horse*2","blind*.5","avoid*2","hidden"]},{left:"fog",right:["move","blind","stop if enemy","hidden"]},{left:"mist",right:["move","blind*.5","stop if enemy"]}],Qe=[{left:"ground",right:["move","see"]},{left:"wall",right:["stop","see"]},{left:"cliff",right:["stop","blind"]},{left:"chasm",right:["stop","see"]},{left:"trap",right:["hurt immediately","hurt on turn start","move","see"]},{left:"fire",right:["hurt on turn start","move","see"]},{left:"sand",right:["move","slow*1","slow horse*2","see"]},{left:"stairs",right:["move","slow*.5","slow horse*1","see"]},{left:"ice",right:["move","slow*1.25","see"]},{left:"snow",right:["move","slow*2","see"]},{left:"shallow_water",right:["move","slow*1.5","slow horse*.5","see"]},{left:"deep_water",right:["stop","see"]},{left:"locked_door",right:["stop","blind","open"]},{left:"open_door",right:["move","see"]},{left:"teleporter",right:["move","see","warp"]},{left:"lever",right:["move","see","use"]},{left:"switch",right:["move","see","use"]},{left:"locked_chest",right:["stop","see"]},{left:"open_chest",right:["move","see"]},{left:"lava",right:["stop","see"]},{left:"acid",right:["stop","see"]},{left:"ranged_emplacement",right:["move","see","arms"]},{left:"magic_emplacement",right:["move","see","arms"]},{left:"heal",right:["move","see","heal"]},{left:"stronghold",right:["move","see","heal*1.5","guard*1.5","avoid*1"]},{left:"guard",right:["move","see","guard*1"]},{left:"avoid",right:["move","see","avoid*1"]},{left:"roof",right:["stop","see"]},{left:"tallwall",right:["stop","blind"]},{left:"shrubs",right:["move","see","avoid*.5"]},{left:"bushes",right:["move","see","avoid*1"]},{left:"trees",right:["move","see","avoid*1.5"]},{left:"boulder",right:["stop","see"]},{left:"fence",right:["stop","see"]},{left:"forest",right:["move","avoid*2","hidden"]},{left:"fog",right:["move","see","hidden"]},{left:"mist",right:["move","see","hidden"]}];We.onclick=()=>{Ge.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),We.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",st(Xe)},Ve.onclick=()=>{Ge.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),Ve.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",st(Ke)},qe.onclick=()=>{Ge.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),qe.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",st(Je)},Ye.onclick=()=>{Ge.forEach((e=>{e.style.backgroundColor="color-mix(in srgb,var(--node-background) 80%,var(--slider-1))"})),Ye.style.backgroundColor="color-mix(in srgb,var(--node-background) 40%,var(--slider-1))",st(Qe)},Ue.appendChild(We),Ue.appendChild(Ve),Ue.appendChild(qe),Ue.appendChild(Ye),Be.appendChild(Ue);let Ze=document.createElement("div");function et(e,t){Object.keys(t).forEach((i=>{e.style[i]=t[i]}))}Ze.id="unitEditorBehaviorRules",Ze.style.width="100%",Ze.style.display="grid",Ze.style.gridTemplateColumns="1fr 1fr";let tt={padding:".5rem",backgroundColor:"var(--list-background)",border:"1px solid var(--window-background)",height:"4rem",color:"var(--node-title)"},it=["move","see","stop","blind","hurt immediately","hurt on turn start","slow*1","slow horse*2","slow*.5","slow horse*1","slow*1.25","slow*2","blind*.5","slow*1.5","slow horse*.5","warp","use","heal","heal*1.5","guard*1.5","avoid*1","guard*1","avoid*.5","avoid*1.5","avoid*2","hidden","stop if enemy","arms","hidden","open"];const st=e=>{Ze.innerHTML="",e.forEach((e=>{let t=document.createElement("div");t.innerHTML=e.left,et(t,tt),Ze.appendChild(t);let i=document.createElement("div");et(i,tt),i.style.padding="0";let s=document.createElement("div");s.className="w2ui-field expand",s.style.backgroundColor="var(--node-title-background)",s.style.color="var(--node-title)";let l=document.createElement("input");l.id="unitEditorBehaviorTiles"+e.left.replace(" ",""),s.appendChild(l),new w("enum",{items:it,selected:e.right,el:l,renderDrop:!1,renderMulti:!0,renderInline:!0,renderItems:!0,openOnFocus:!0}),i.appendChild(s),Ze.appendChild(i)}))};Be.appendChild(Ze),We.click();const lt=Be;let nt=document.createElement("div");nt.style.width="100%",nt.style.height="100%",nt.style.padding="1rem",nt.innerHTML="<div><h2>Specials</h2>\nSpecials are a way to add unique behaviors to units.\n";let at=document.createElement("div");function rt(e,t){Object.keys(t).forEach((i=>{e.style[i]=t[i]}))}at.style.width="100%",at.style.display="grid",at.style.gridTemplateColumns="6fr 9fr 1fr";let ot={padding:".5rem",backgroundColor:"var(--list-background)",border:"1px solid var(--window-background)",height:"4rem",color:"var(--node-title)"};[{left:"Flees",right:"The unit will flee, avoid enemies, and refuse to attack or counterattack."},{left:"Invincible",right:"The unit is immune to all damage."},{left:"Here to steal",right:"The unit will only approach units with items to steal or chests."},{left:"Will not move",right:"The unit will not move from its starting position."},{left:"Will not attack first",right:"The unit will not attack first."},{left:"Can't be targeted",right:"The unit cannot be targeted by enemies."},{left:"Suicidal",right:"The unit will seek their own death."},{left:"Here for the objective",right:"The unit will only move towards objective tiles, ignoring enemies."},{left:"Protect the leader",right:"The unit will stay adjcaent to the leader."},{left:"Will not move until attacked",right:"The unit will not move until attacked."},{left:"Ignores terrain",right:"The unit can move through any terrain."},{left:"Move through units",right:"The unit can move through other units."},{left:"Murderous",right:"The unit will always prioritize attacking weak units, disadvantaged units, or units with low health."},{left:"Kill the avatar",right:"The unit will always attack the avatar."}].forEach((e=>{let t=document.createElement("div");t.innerHTML=e.left,rt(t,ot),at.appendChild(t);let i=document.createElement("div");i.innerHTML=e.right,rt(i,ot),i.style.backgroundColor="var(--node-title)",i.style.color="var(--window-background-alt)",at.appendChild(i);let s=document.createElement("div");s.innerHTML=`<input type="checkbox" class="w2ui-input" style="width:2rem;height:2rem;" id = "unitEditorBehaviorSpecials${e.left.replace(/ /g,"").replace(/'/g,"")}">`,rt(s,ot),s.style.backgroundColor="var(--node-title)",s.style.color="var(--window-background-alt)",at.appendChild(s)})),nt.appendChild(at);const dt=nt;let ht=new m({name:"unit-editor-behavior-container-bottom-toolbar",items:[{type:"radio",group:"1",id:"unit-editor-behavior-container-bottom-toolbar-sliders",text:"Sliders",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"unit-editor-behavior-container-bottom-toolbar-tiles",text:"Tiles",class:"panel-tabs"},{type:"radio",group:"1",id:"unit-editor-behavior-container-bottom-toolbar-specials",text:"Specials",class:"panel-tabs"}]});ht.on("click",(function(e){e.done((()=>{((e,t)=>{let i=n["unit-editor-behavior-container"];"unit-editor-behavior-container-bottom-toolbar-sliders"===e.detail.item.id?i.html("main",Pe):"unit-editor-behavior-container-bottom-toolbar-tiles"===e.detail.item.id?i.html("main",lt):"unit-editor-behavior-container-bottom-toolbar-specials"===e.detail.item.id&&i.html("main",dt)})(e)}))}));const ct=new v({name:"unit-editor-behavior-container",panels:[{type:"main",content:"main",html:Pe,style:"overflow-x: hidden"},{type:"bottom",size:30,resizable:!1,content:"bottom",style:"overflow-y: hidden;",html:ht}]});let ut=new m({name:"unit-editor-bottom-toolbar",items:[{type:"radio",group:"1",id:"unit-editor-bottom-toolbar-basic",text:"Basic Info",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"unit-editor-bottom-toolbar-subtype",text:"Subtype",class:"panel-tabs"},{type:"radio",group:"1",id:"unit-editor-bottom-toolbar-behavior",text:"Behavior",class:"panel-tabs",hidden:!0}]});ut.on("click",(function(e){e.done((()=>{((e,t)=>{window.turnrootEditorLogs.push(`${new Date}||info||Unit editor bottom toolbar item clicked: ${e.detail.item.id}`);let i=n.UnitEditor;if("unit-editor-bottom-toolbar-basic"===e.detail.item.id)i.html("main",L);else if("unit-editor-bottom-toolbar-subtype"===e.detail.item.id){let e=n["unit-editor-basic-fields"].record.subtype;"Friend"===e?i.html("main",G):"Avatar"===e?i.html("main",se):"Enemy"===e?i.html("main",ne):"NPC"===e&&i.html("main",re)}else"unit-editor-bottom-toolbar-behavior"===e.detail.item.id&&i.html("main",ct)})(e)}))}));const pt=new v({name:"UnitEditor",panels:[{type:"top",size:30,resizable:!1,content:"top",html:H,style:"overflow-y: hidden;"},{type:"main",content:"main",html:L},{type:"left",size:200,resizable:!0,content:"left",html:j},{type:"bottom",size:30,resizable:!1,content:"bottom",html:ut,style:"overflow-y: hidden;"}]}),mt=new v({name:"ClassEditor",panels:[{type:"top",size:30,resizable:!1,content:"top",html:'<div style="padding: 10px;">Top</div>'},{type:"main",content:"main",html:'<div style="padding: 10px;">Main Class Editor</div>'}]}),gt={unitsCanHaveChildren:"Units can have children",useExperienceSublevels:"Use experience sublevels",useExperienceAptitudes:"Use experience aptitudes",combatCombatArts:"Combat arts",combatWeaponTriangle:"Weapon triangle",combatExpandedWeaponTriangle:"Expanded weapon triangle",combatMagicTriangle:"Magic triangle",combatBattalions:"Battalions",combatBattalionEndurance:"Battalion endurance",combatPairUp:"Pair up",combatAdjutants:"Adjutants",combatAdjutantHeal:"Adjutant heal",combatAdjutantGuard:"Adjutant guard",combatAdjutantAttack:"Adjutant attack",statsUseExtraStatWeight:"Use extra stat weight",statsExtraStatWeightAffectsMovement:"Extra stat weight affects movement",statsUseExtraStatLuck:"Use extra stat luck",combatSeparateCritAvoid:"Separate crit avoid",statsUseExtraStatAuthority:"Use extra stat authority",statsUseExtraStatCharm:"Use extra stat charm",statsAptitudesUseRiding:"Aptitudes use riding",statsAptitudesUseFlying:"Aptitudes use flying",statsAptitudesUseAuthority:"Aptitudes use authority",statsAptitudesUseArmor:"Aptitudes use armor",combatCombatArtLimit:"Combat art limit",combatWeaponTriangleAdvantage:"Weapon triangle advantage",combatWeaponTriangleDisadvantage:"Weapon triangle disadvantage",combatMagicTriangleAdvantage:"Magic triangle advantage",combatMagicTriangleDisadvantage:"Magic triangle disadvantage",combatBattalionLimit:"Battalion limit",unitEditorAvatarDefaultHairColor:"Avatar default hair color",unitEditorAvatarDefaultEyeColor:"Avatar default eye color",combatTriangleMapping:"Combat triangle mapping",combatMagicTriangleMapping:"Combat magic triangle mapping",globalWeaponsTypes:"Global weapons types",combatTriangleTypes:"Combat triangle types",combatNeutralTypes:"Combat neutral types",combatMagicTriangleTypes:"Combat magic triangle types",combatNeutralMagicTypes:"Combat neutral magic types"};let ft={name:"game-editor-global-fields",record:{},fields:[{type:"html",html:{html:'<h3 style = "margin-top:2rem;padding-top:.5rem;">General</h3>'}}]},bt={useExperienceAptitudes:"Combat",combatAdjutantAttack:"Unit stats",statsUseExtraStatCharm:"Aptitudes"},vt={combatBattalionLimit:"Avatar defaults"};_.forEach((e=>{ft.fields.push({field:e,type:"checkbox",attr:'style="width:100%"',html:{text:gt[e],class:"no-label",style:"width:100%;",column:0}}),ft.record[e]=window[e],bt[e]&&ft.fields.push({type:"html",html:{html:`<h3 style = "margin-top:2rem;padding-top:.5rem;">${bt[e]}</h3>`,class:"no-label",column:0}})})),ft.fields.push({type:"html",html:{html:'<h3 style = "margin-top:2rem;padding-top:.5rem;">Combat</h3>',class:"no-label",column:1}}),k.forEach((e=>{ft.fields.push({field:e,type:"int",html:{text:gt[e],class:"no-label",column:1}}),ft.record[e]=window[e],vt[e]&&ft.fields.push({type:"html",html:{html:`<h3 style = "margin-top:2rem;padding-top:.5rem;">${vt[e]}</h3>`,class:"no-label",column:1}})})),C.forEach((e=>{ft.fields.push({field:e,type:"text",html:{text:gt[e],class:"no-label",column:1}}),ft.record[e]=window[e]}));let yt=new y(ft);yt.on("change",(function(e){((e,t)=>{window[e.detail.field]=e.detail.value.current,E()})(e)}));const wt=yt;window.gameEditorGameDetailsFinishInitialAndNext=()=>{let e=n.GameEditor,t=n["game-editor-bottom-toolbar"];t.show("game-editor-bottom-toolbar-game-settings"),t.show("game-editor-bottom-toolbar-assets"),t.show("game-editor-bottom-toolbar-build-and-export"),t.click("game-editor-bottom-toolbar-game-settings");let i=n.EditorWindowStatusBar;i.set("status-bar-project-status",{text:"game details saved"}),setTimeout((()=>{i.set("status-bar-project-status",{text:""}),i.hide("status-bar-project-status")}),5e3),e.html("main",wt);let s=n.EditorWindowSidebar;s.get("sidebar-editors-list").nodes.forEach((e=>{s.enable(e.id)})),r("You can now access the other editors in the left sidebar, as well as more advanced game settings. If you feel overwhelmed, please see docs.turnroot.com/your-first-hour for a guided tour on what to do next and where everything is. Check out the docs or the forums for additional resources.<br/><br/> Happy turnrooting!","<h3>Game details saved</h3>")};let xt=new y({name:"gameEditorRequiredGameDetails",fields:[{type:"html",html:{html:"<h2>Basic Game Details</h2><p>You must fill out these fields before any other editors are available.</p>",style:"text-align:left;font-size:150%;overflow:hidden;margin:auto;margin-bottom:2rem;"}},{field:"gameName",type:"text",required:!0,html:{label:"Game Name",attr:'style="width: 100%;font-size:150%;"',class:"emphasized-field full-width-field"}},{field:"gameSubtitle",type:"text",required:!0,html:{label:"Game Subtitle",attr:'style="width: 100%;font-size:150%;"',class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<p style = "width:100%;max-width:100%!important;">The game subtitle is for long, multi-part titles (say for example you wanted to name your game something like Icy Shield: Lineage of the Evil War - Heirs of Photonic Rays, "Heirs of Photonic Rays" would be your subtitle. A subtitle is optional.</p>',class:"full-width-field"}},{field:"gameAuthorDisplayName",type:"textarea",required:!0,html:{label:"Game Creator Credits",attr:'style="width: 100%;font-size:150%;"',class:"emphasized-field full-width-field"}},{type:"html",html:{html:"<p style = \"width:100%;max-width:100%!important;\">Put one credit per line:<br/> Main creator: username<br/>Music: username 2</br>If you're not sure of all credits yet, that's fine, just list yourself. You can edit this later.</small>",class:"full-width-field"}},{type:"file",field:"gameIcon",required:!1,html:{label:"Game Icon",class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<p style = "width:100%;max-width:100%!important;">The game icon should be a square image, at least 200px on each side. If you don\'t provide one, a default will be used. You can replace this later by uploading an image here.</p>',class:"full-width-field"}},{type:"checks",field:"gameDifficulty",required:!0,options:{items:["Beginner","Easy","Normal","Hard","Insane","Maddening"],checked:["Normal"]},html:{label:"Game Difficulties",class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<p style = "width:100%;max-width:100%!important;">When working on units or other game components, you will have the option to change things by difficulty (i.e., add reinforcements to a level on Hard or above), but the base stats, growth rates, etc, you will be setting are for Normal difficulty. You can set scalars that impact these stats for different difficulty levels- just bear in mind that if, for example, you\'re using stats on a wiki for an existing game as a guide, you should use the Normal stats at all times.</p>'}},{type:"checks",field:"gameMode",required:!0,options:{items:["Casual","Classic","Casual (Lose Items)","Casual (Stat Penalty)"]},html:{label:"Game Modes",class:"emphasized-field full-width-field"}},{type:"html",html:{html:'<ul><li>Casual: "dead" units retreat and rejoin you in the next battle</li><li>Classic: dead units are gone forever</li><li>Casual (Lose Items): "dead" units retreat and rejoin, but lose their inventory at time of death</li><li>Casual (Stat Penalty): "dead" units retreat and rejoin, but come back with lowered stats.</li></ul>',class:"full-width-field"}},{type:"html",html:{html:'<div><p>When you\'re happy with the settings above, click Next to move on to more advanced game settings. Clicking Next will also unlock the other editors.</p><button class="w2ui-btn" onclick="window.gameEditorGameDetailsFinishInitialAndNext()" style="width:100%;font-size:150%;">Next</button></div>'}}]});xt.on("change",(function(e){((e,t)=>{window[e.detail.field]=e.detail.value.current,E()})(e)}));const _t=xt;let kt=new m({name:"game-editor-bottom-toolbar",items:[{type:"radio",group:"1",id:"game-editor-bottom-toolbar-game-details",text:"Game details",class:"panel-tabs",checked:!0},{type:"radio",group:"1",id:"game-editor-bottom-toolbar-game-settings",text:"Game settings",class:"panel-tabs",hidden:!0},{type:"radio",group:"1",id:"game-editor-bottom-toolbar-assets",text:"Assets",class:"panel-tabs",hidden:!0},{type:"radio",group:"1",id:"game-editor-bottom-toolbar-build-and-export",text:"Build and export",class:"panel-tabs",hidden:!0}]});kt.on("click",(function(e){e.done((()=>{((e,t)=>{window.turnrootEditorLogs.push(`${new Date}||info||GameEditor bottom toolbar button clicked: ${e.detail.item.id}`);let i=n.GameEditor;"game-editor-bottom-toolbar-game-details"===e.detail.item.id?i.html("main",_t):"game-editor-bottom-toolbar-game-settings"===e.detail.item.id&&i.html("main",wt)})(e)}))}));const Ct=new v({name:"GameEditor",panels:[{type:"main",content:"main",html:_t},{type:"bottom",size:30,resizable:!1,content:"bottom",html:kt,style:"overflow-y: hidden;"}]});let St=new g({name:"EditorWindowSidebar",flatButton:!0,icon:{text:e=>"sidebar-editors-unit-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>':"sidebar-editors-class-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-drama"><path d="M10 11h.01"/><path d="M14 6h.01"/><path d="M18 6h.01"/><path d="M6.5 13.1h.01"/><path d="M22 5c0 9-4 12-6 12s-6-3-6-12c0-2 2-3 6-3s6 1 6 3"/><path d="M17.4 9.9c-.8.8-2 .8-2.8 0"/><path d="M10.1 7.1C9 7.2 7.7 7.7 6 8.6c-3.5 2-4.7 3.9-3.7 5.6 4.5 7.8 9.5 8.4 11.2 7.4.9-.5 1.9-2.1 1.9-4.7"/><path d="M9.1 16.5c.3-1.1 1.4-1.7 2.4-1.4"/></svg>':"sidebar-editors-game-editor"===e.id?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>':void 0},nodes:[{id:"sidebar-editors-list",text:"Editors",expanded:!0,group:!0,groupShowHide:!1,nodes:[{id:"sidebar-editors-game-editor",text:"Project"},{id:"sidebar-editors-unit-editor",text:"Units",disabled:!0},{id:"sidebar-editors-class-editor",text:"Classes",disabled:!0}],onCollapse(e){e.preventDefault()}},{id:"sidebar-recent-files",text:"Recent Files",expanded:!0,group:!0,groupShowHide:!0,nodes:[]}],onFlat(e){n.EditorWindowLayout.sizeTo("left",e.detail.goFlat?"24":"12%",!0)}});St.on("click",(function(e){e.object.disabled||(window.turnrootEditorLogs.push(`${new Date}||info||Sidebar button clicked: ${JSON.stringify(e.target)}`),"sidebar-editors-unit-editor"===e.target?n.EditorWindowLayout.html("main",pt).removed():"sidebar-editors-class-editor"===e.target?n.EditorWindowLayout.html("main",mt).removed():"sidebar-editors-game-editor"===e.target&&n.EditorWindowLayout.html("main",Ct).removed())})),window.goFlat=function(){St.goFlat()};const Et=St;let $t=["settings:default-editor-welcome-message","settings:default-editor-unit-editor"];const Tt=(e,t)=>{if("logs"===!e.detail.item.id&&window.turnrootEditorLogs.push(`${new Date}||info||Top menu button clicked: ${JSON.stringify(e.target)} with details ${JSON.stringify(e.detail)}`),$t.includes(e.target)){let i=e.target.split(":")[1];t.get("settings").get("default-editor").items.forEach((e=>{e.id===i?e.style="background-color: var(--window-background-alt);":e.style=""}))}else if("collapseSidebar"===e.detail.item.id)window.goFlat();else if("logs"===e.detail.item.id)(()=>{let e=document.createElement("div");e.style.width="100%",e.style.height="100%",e.style.padding="1rem",e.style.overflowY="auto",e.id="logs-popup-inner",e.innerHTML=(()=>{let e=window.turnrootEditorLogs,t="<code><small>";return e.forEach((e=>{let i=e.split("||"),s=i[0],l=i[1],n=i[2],a=new Date(s).toLocaleTimeString();t+="error"===l?`<span style="background-color:red;">${a} - ${n}</span><br>`:`${a} - ${n}<br>`,t+="<br>"})),t+="</small></code>",t})(),o.open({title:"Logs",body:e,resizable:!0}).then((()=>{let e=document.querySelector("#logs-popup-inner").parentElement.parentElement.parentElement;e.style.height="60vh",e.style.width="50vw",e.style.minHeight="400px",e.style.top="20vh",e.style.left="25vw"}))})();else if("forums"===e.detail.item.id)window.open("https://community.turnroot.com","_blank");else if("help"===e.detail.item.id)window.open("https://docs.turnroot.com","_blank");else if("show-status-bar"===e.detail.item.id){n.EditorWindowStatusBar;let t=n.EditorWindowLayout;e.detail.item.checked?(t.show("bottom"),t.sizeTo("bottom","24",!0)):(t.hide("bottom"),t.sizeTo("bottom","0",!0))}e.detail.subItem&&t.get("settings").get("themes").items.map((e=>e.id)).includes(e.detail.subItem.id)&&((e=>{const t=document.querySelector("#main");t.classList.remove("ocean_waves","turnroot","charcoal","charcoal_blue","charcoal_green","chocolate","midnight_spark","snowdrift","tokyo_night","pink_dream","forest_mist","sunset_glow","pine_coast"),t.classList.add(e),t.dataset.theme=e,window.MainEditorWindow.refresh(),window.EditorWindowSidebar.refresh(),localStorage.setItem("theme",e)})(e.detail.subItem.id),t.get("settings").get("themes").items.forEach((t=>{t.id===e.detail.subItem.id?t.style="background-color: var(--window-background-alt);":t.style=""})))};let At=new m({name:"EditorWindowTopMenu",tooltip:"bottom",items:[{type:"menu",id:"settings",text:"Settings",items:[{type:"menu",id:"themes",text:"Themes",items:[{text:"Ocean Waves",id:"ocean_waves"},{text:"Turnroot",id:"turnroot"},{text:"Charcoal",id:"charcoal"},{text:"Charcoal Blue",id:"charcoal_blue"},{text:"Charcoal Green",id:"charcoal_green"},{text:"Chocolate",id:"chocolate"},{text:"Snowdrift",id:"snowdrift"},{text:"Tokyo Night",id:"tokyo_night"},{text:"Pink Dream",id:"pink_dream"},{text:"Forest Mist",id:"forest_mist"},{text:"Sunset Glow",id:"sunset_glow"},{text:"Pine Coast",id:"pine_coast"}]},{type:"menu-radio",id:"default-editor",text:"Startup view",items:[{text:"Welcome message",id:"default-editor-welcome-message",style:"background-color: var(--window-background-alt);",checked:!0},{text:"Unit Editor",id:"default-editor-unit-editor"},{text:"Class Editor",id:"default-editor-class-editor"}]}]},{type:"check",id:"collapseSidebar",text:"Collapse sidebar",class:"w2ui-tb-check"},{type:"check",id:"show-status-bar",text:"Status bar",checked:!0,class:"w2ui-tb-check"},{type:"button",id:"logs",text:"Logs"},{type:"spacer"},{type:"menu",id:"import-menu",text:"Import assets",tooltip:"Import graphics, models, music, sound effects, tilesets, or other assets from the market or your computer.",items:[{text:"Import from Turnroot Market",id:"import-marketplace"},{text:"Import from file",id:"import-file"}]},{type:"button",id:"check-build",text:"Check for issues",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bug-play"><path d="M12.765 21.522a.5.5 0 0 1-.765-.424v-8.196a.5.5 0 0 1 .765-.424l5.878 3.674a1 1 0 0 1 0 1.696z"/><path d="M14.12 3.88 16 2"/><path d="M18 11a4 4 0 0 0-4-4h-4a4 4 0 0 0-4 4v3a6.1 6.1 0 0 0 2 4.5"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M6 13H2"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="m8 2 1.88 1.88"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/></svg></div>'},{type:"spacer"},{type:"button",id:"account",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>'},{type:"break"},{type:"button",id:"help",text:"Help",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg></div>'},{type:"button",id:"forums",text:"Forums",style:"margin:0!important;",icon:'<div style="width:100%;height:100%;display:flex;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-speech"><path d="M8.8 20v-4.1l1.9.2a2.3 2.3 0 0 0 2.164-2.1V8.3A5.37 5.37 0 0 0 2 8.25c0 2.8.656 3.054 1 4.55a5.77 5.77 0 0 1 .029 2.758L2 20"/><path d="M19.8 17.8a7.5 7.5 0 0 0 .003-10.603"/><path d="M17 15a3.5 3.5 0 0 0-.025-4.975"/></svg></div>'}]});At.on("click",(function(e){e.done((()=>{Tt(e,At)}))}));let It=localStorage.getItem("theme");It&&At.get("settings:themes").items.forEach((e=>{e.id===It?(main.classList.remove("ocean_waves","turnroot","charcoal","charcoal_blue","charcoal_green","chocolate","midnight_spark","forest_mist","snowdrift","tokyo_night","pink_dream","sunset_glow","pine_coast"),main.classList.add(It),main.dataset.theme=It,e.style="background-color: var(--window-background-alt);"):e.style=""}));const Dt=At;let zt=new m({name:"EditorWindowStatusBar",tooltip:"top",items:[{type:"label",id:"status-bar-project-status",text:"Required project settings missing",class:"status-bar"},{type:"break"},{type:"label",id:"status-bar-db-status",icon:'<div style = "margin-top:-8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--slider-1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-server-off"><path d="M7 2h13a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-5"/><path d="M10 10 2.5 2.5C2 2 2 2.5 2 5v3a2 2 0 0 0 2 2h6z"/><path d="M22 17v-1a2 2 0 0 0-2-2h-1"/><path d="M4 14a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h16.5l1-.5.5.5-8-8H4z"/><path d="M6 18h.01"/><path d="m2 2 20 20"/></svg></div>',tooltip:"Database connection lost"},{type:"label",id:"status-bar-autosave-status",class:"status-bar",icon:'<div style="margin-top:-.5rem; margin-right:.25rem;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-check"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></svg></div>'},{type:"spacer"},{type:"label",id:"status-bar-turnroot-version",class:"status-bar",text:"Turnroot Editor v0.0.3 Weekly"},{type:"spacer"},{type:"label",id:"status-bar-report-issue",class:"status-bar report-issue",text:"Report an issue",style:"margin:0!important;padding:0!important;"}]});zt.on("click",(function(e){e.done((()=>{window.turnrootEditorLogs.push(`${new Date}||info||Status bar button clicked: ${JSON.stringify(e.target)}`),"status-bar-report-issue"===e.target?window.open("https://community.turnroot.com/c/turnroot-editor/editor-support/6","_blank"):"status-bar-project-status"===e.target&&n.EditorWindowSidebar.click("sidebar-editors-game-editor")}))}));const Mt=zt,Ot=new v({name:"EditorWindow",panels:[{type:"top",size:30,resizable:!1,content:"top",html:'<div style="padding: 10px;">Top</div>'},{type:"main",content:"main",html:'<div style="padding: 10px;">Main</div>'},{type:"bottom",size:30,resizable:!1,content:"bottom",html:'<div style="padding: 10px;">Bottom</div>'},{type:"left",size:200,resizable:!0,content:"left",html:'<div style="padding: 10px;">Left</div>'},{type:"right",size:200,resizable:!0,content:"right",html:'<div style="padding: 10px;">Right</div>'},{type:"preview",size:200,resizable:!0,content:"preview",html:'<div style="padding: 10px;">Preview</div>'}]}),Rt='<div style="margin-top:-.5rem; margin-right:.25rem;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-check"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></svg></div>',Ft='<div style="margin-top:-.5rem; margin-right:.25rem;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-up"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 12v6"/><path d="m15 15-3-3-3 3"/></svg></div>';let Lt,jt;window.w2layout=v,window.w2grid=class extends t{constructor(e){if(super(e.name),this.name=null,this.box=null,this.columns=[],this.columnGroups=[],this.records=[],this.summary=[],this.searches=[],this.toolbar={},this.ranges=[],this.contextMenu=[],this.searchMap={},this.searchData=[],this.sortMap={},this.sortData=[],this.savedSearches=[],this.defaultSearches=[],this.total=0,this.recid=null,this.last={field:"",label:"",logic:"AND",search:"",searchIds:[],selection:{indexes:[],columns:{}},saved_sel:null,multi:!1,fetch:{action:"",offset:null,start:0,response:0,options:null,controller:null,loaded:!1,hasMore:!1},vscroll:{scrollTop:0,scrollLeft:0,recIndStart:null,recIndEnd:null,colIndStart:0,colIndEnd:0,pull_more:!1,pull_refresh:!0,show_extra:0},sel_ind:null,sel_col:null,sel_type:null,sel_recid:null,idCache:{},move:null,cancelClick:null,inEditMode:!1,_edit:null,kbd_timer:null,marker_timer:null,click_time:null,click_recid:null,bubbleEl:null,colResizing:!1,tmp:null,copy_event:null,userSelect:"",columnDrag:!1,state:null,toolbar_height:0},this.header="",this.url="",this.limit=100,this.offset=0,this.postData={},this.routeData={},this.httpHeaders={},this.show={header:!1,toolbar:!1,footer:!1,columnMenu:!0,columnHeaders:!0,lineNumbers:!1,expandColumn:!1,selectColumn:!1,emptyRecords:!0,toolbarReload:!0,toolbarColumns:!1,toolbarSearch:!0,toolbarAdd:!1,toolbarEdit:!1,toolbarDelete:!1,toolbarSave:!1,searchAll:!0,searchLogic:!0,searchHiddenMsg:!1,searchSave:!0,statusRange:!0,statusBuffered:!1,statusRecordID:!0,statusSelection:!0,statusResponse:!0,statusSort:!1,statusSearch:!1,recordTitles:!1,selectionBorder:!0,selectionResizer:!0,skipRecords:!0,saveRestoreState:!0},this.stateId=null,this.hasFocus=!1,this.autoLoad=!0,this.fixedBody=!0,this.recordHeight=32,this.lineNumberWidth=34,this.keyboard=!0,this.selectType="row",this.liveSearch=!1,this.multiSearch=!0,this.multiSelect=!0,this.multiSort=!0,this.reorderColumns=!1,this.reorderRows=!1,this.showExtraOnSearch=0,this.markSearch=!0,this.columnTooltip="top|bottom",this.disableCVS=!1,this.nestedFields=!0,this.vs_start=150,this.vs_extra=5,this.style="",this.tabIndex=null,this.dataType=null,this.parser=null,this.advanceOnEdit=!0,this.useLocalStorage=!0,this.colTemplate={text:"",field:"",size:null,min:20,max:null,gridMinWidth:null,sizeCorrected:null,sizeCalculated:null,sizeOriginal:null,sizeType:null,hidden:!1,sortable:!1,sortMode:null,searchable:!1,resizable:!0,hideable:!0,autoResize:null,attr:"",style:"",render:null,title:null,tooltip:null,editable:{},frozen:!1,info:null,clipboardCopy:!1},this.stateColProps={text:!1,field:!0,size:!0,min:!1,max:!1,gridMinWidth:!1,sizeCorrected:!1,sizeCalculated:!0,sizeOriginal:!0,sizeType:!0,hidden:!0,sortable:!1,sortMode:!0,searchable:!1,resizable:!1,hideable:!1,autoResize:!1,attr:!1,style:!1,render:!1,title:!1,tooltip:!1,editable:!1,frozen:!0,info:!1,clipboardCopy:!1},this.msgDelete="Are you sure you want to delete ${count} ${records}?",this.msgNotJSON="Returned data is not in valid JSON format.",this.msgHTTPError="HTTP error. See console for more details.",this.msgServerError="Server error",this.msgRefresh="Refreshing...",this.msgNeedReload="Your remote data source record count has changed, reloading from the first record.",this.msgEmpty="",this.buttons={reload:{type:"button",id:"w2ui-reload",icon:"w2ui-icon-reload",tooltip:"Reload data in the list"},columns:{type:"menu-check",id:"w2ui-column-on-off",icon:"w2ui-icon-columns",tooltip:"Show/hide columns",overlay:{align:"none"}},search:{type:"html",id:"w2ui-search",html:'<div class="w2ui-icon w2ui-icon-search w2ui-search-down w2ui-action" data-click="searchShowFields"></div>'},add:{type:"button",id:"w2ui-add",text:"Add New",tooltip:"Add new record",icon:"w2ui-icon-plus"},edit:{type:"button",id:"w2ui-edit",text:"Edit",tooltip:"Edit selected record",icon:"w2ui-icon-pencil",batch:1,disabled:!0},delete:{type:"button",id:"w2ui-delete",text:"Delete",tooltip:"Delete selected records",icon:"w2ui-icon-cross",batch:!0,disabled:!0},save:{type:"button",id:"w2ui-save",text:"Save",tooltip:"Save changed records",icon:"w2ui-icon-check"}},this.operators={text:["is","begins","contains","ends"],number:["=","between",">","<",">=","<="],date:["is",{oper:"less",text:"before"},{oper:"more",text:"since"},"between"],list:["is"],hex:["is","between"],color:["is","begins","contains","ends"],enum:["in","not in"]},this.defaultOperator={text:"begins",number:"=",date:"is",list:"is",enum:"in",hex:"begins",color:"begins"},this.operatorsMap={text:"text",int:"number",float:"number",money:"number",currency:"number",percent:"number",hex:"hex",alphanumeric:"text",color:"color",date:"date",time:"date",datetime:"date",list:"list",combo:"text",enum:"enum",file:"enum",select:"list",radio:"list",checkbox:"list",toggle:"list"},this.onAdd=null,this.onEdit=null,this.onRequest=null,this.onLoad=null,this.onDelete=null,this.onSave=null,this.onSelect=null,this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onContextMenuClick=null,this.onColumnClick=null,this.onColumnDblClick=null,this.onColumnContextMenu=null,this.onColumnResize=null,this.onColumnAutoResize=null,this.onSort=null,this.onSearch=null,this.onSearchOpen=null,this.onChange=null,this.onRestore=null,this.onExpand=null,this.onCollapse=null,this.onError=null,this.onKeydown=null,this.onToolbar=null,this.onColumnOnOff=null,this.onCopy=null,this.onPaste=null,this.onSelectionExtend=null,this.onEditField=null,this.onRender=null,this.onRefresh=null,this.onReload=null,this.onResize=null,this.onDestroy=null,this.onStateSave=null,this.onStateRestore=null,this.onFocus=null,this.onBlur=null,this.onReorderRow=null,this.onSearchSave=null,this.onSearchRemove=null,this.onSearchSelect=null,this.onColumnSelect=null,this.onColumnDragStart=null,this.onColumnDragEnd=null,this.onResizerDblClick=null,this.onMouseEnter=null,this.onMouseLeave=null,a.extend(this,e),Array.isArray(this.records)){let e=[];this.records.forEach(((t,i)=>{null!=t[this.recid]&&(t.recid=t[this.recid]),null==t.recid&&console.log("ERROR: Cannot add records without recid. (obj: "+this.name+")"),!0===t.w2ui?.summary&&(this.summary.push(t),e.push(i))})),e.sort();for(let t=e.length-1;0<=t;t--)this.records.splice(e[t],1)}Array.isArray(this.columns)&&this.columns.forEach(((e,t)=>{if(e=a.extend({},this.colTemplate,e),null!=(t=(this.columns[t]=e).searchable)&&!1!==t&&null==this.getSearch(e.field))if(a.isPlainObject(t))this.addSearch(a.extend({field:e.field,label:e.text,type:"text"},t));else{let t=e.searchable,i="";!0===e.searchable&&(t="text",i='size="20"'),this.addSearch({field:e.field,label:e.text,type:t,attr:i})}})),Array.isArray(this.defaultSearches)&&this.defaultSearches.forEach(((e,t)=>{e.id="default-"+t,e.icon??="w2ui-icon-search"})),e=this.cache("searches"),Array.isArray(e)&&e.forEach((e=>{this.savedSearches.push({id:e.id??"none",text:e.text??"none",icon:"w2ui-icon-search",remove:!0,logic:e.logic??"AND",data:e.data??[]})})),this.initToolbar(),"string"==typeof this.box&&(this.box=l(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){Array.isArray(e)||(e=[e]);let i=0;for(let l=0;l<e.length;l++){var s=e[l];null!=s[this.recid]&&(s.recid=s[this.recid]),null==s.recid?console.log("ERROR: Cannot add record without recid. (obj: "+this.name+")"):(!0===s.w2ui?.summary?t?this.summary.unshift(s):this.summary.push(s):t?this.records.unshift(s):this.records.push(s),i++)}var n,r;return(this.url?.get??this.url)||(this.total=this.records.length,this.localSort(!1,!0),this.localSearch(),r=(n=this.records.length-e.length)+e.length,this.last.vscroll.recIndStart<=r&&this.last.vscroll.recIndEnd>=n)?this.refresh():l(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right .w2ui-total").html(a.formatNumber(this.total)),i}find(e,t,i){var s,l=[];let n=!1;for(s in e=null==e?{}:e)-1!=String(s).indexOf(".")&&(n=!0);var a=i?this.last.vscroll.recIndStart:0;let r=i?this.last.vscroll.recIndEnd+1:this.records.length;r>this.records.length&&(r=this.records.length);for(let i=a;i<r;i++){let s=!0;for(var o in e){let t=this.records[i][o];n&&-1!=String(o).indexOf(".")&&(t=this.parseField(this.records[i],o)),"not-null"==e[o]?null!=t&&""!==t||(s=!1):e[o]!=t&&(s=!1)}s&&!0!==t&&l.push(this.records[i].recid),s&&!0===t&&l.push(i)}return l}set(e,t,i){if("object"==typeof e&&null!==e&&(i=t,t=e,e=null),null==e){for(let e=0;e<this.records.length;e++)a.extend(this.records[e],t);!0!==i&&this.refresh()}else{var s=this.get(e,!0);if(null==s)return!1;this.records[s]?.recid!=e?a.extend(this.summary[s],t):a.extend(this.records[s],t),!0!==i&&this.refreshRow(e,s)}return!0}replace(e,t,i){var s=this.get(e,!0);return null!=s&&(this.records[s]?.recid!=e?this.summary[s]=t:this.records[s]=t,!0!==i&&this.refreshRow(e,s),!0)}get(e,t){if(Array.isArray(e)){var i=[];for(let l=0;l<e.length;l++){var s=this.get(e[l],t);null!==s&&i.push(s)}return i}{let i=this.last.idCache;i||(this.last.idCache=i={});var l=i[e];if("number"==typeof l){if(0<=l&&l<this.records.length&&this.records[l].recid==e)return!0===t?l:this.records[l];if(0<=(l=~l)&&l<this.summary.length&&this.summary[l].recid==e)return!0===t?l:this.summary[l];this.last.idCache=i={}}for(let s=0;s<this.records.length;s++)if(this.records[s].recid==e)return i[e]=s,!0===t?s:this.records[s];for(let s=0;s<this.summary.length;s++)if(this.summary[s].recid==e)return i[e]=~s,!0===t?s:this.summary[s];return null}}getFirst(e){if(0==this.records.length)return null;let t=this.records[0];var i=this.last.searchIds;return 0<this.searchData.length?Array.isArray(i)&&0<i.length?this.records[i[e||0]]:null:t}remove(){let e=0;for(let t=0;t<arguments.length;t++){for(let i=this.records.length-1;0<=i;i--)this.records[i].recid==arguments[t]&&(this.records.splice(i,1),e++);for(let i=this.summary.length-1;0<=i;i--)this.summary[i].recid==arguments[t]&&(this.summary.splice(i,1),e++)}return(this.url?.get??this.url)||(this.localSort(!1,!0),this.localSearch(),this.total=this.records.length),this.refresh(),e}addColumn(e,t){let i=0;1==arguments.length?(t=e,e=this.columns.length):null==(e="string"==typeof e?this.getColumn(e,!0):e)&&(e=this.columns.length),Array.isArray(t)||(t=[t]);for(let l=0;l<t.length;l++){var s=a.extend({},this.colTemplate,t[l]);if(this.columns.splice(e,0,s),t[l].searchable){let e=t[l].searchable,i="";!0===t[l].searchable&&(e="text",i='size="20"'),this.addSearch({field:t[l].field,label:t[l].text,type:e,attr:i})}e++,i++}return this.refresh(),i}removeColumn(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.columns.length-1;0<=i;i--)this.columns[i].field==arguments[t]&&(this.columns[i].searchable&&this.removeSearch(arguments[t]),this.columns.splice(i,1),e++);return this.refresh(),e}getColumn(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.columns.length;e++)i.push(this.columns[e].field);return i}for(let i=0;i<this.columns.length;i++)if(this.columns[i].field==e)return!0===t?i:this.columns[i];return null}updateColumn(e,t){let i=0;return(e=Array.isArray(e)?e:[e]).forEach((e=>{this.columns.forEach((s=>{if(s.field==e){let e=a.clone(t);Object.keys(e).forEach((t=>{"function"==typeof e[t]&&(e[t]=e[t](s)),s[t]!=e[t]&&i++})),a.extend(s,e)}}))})),0<i&&this.refresh(),i}toggleColumn(){return this.updateColumn(Array.from(arguments),{hidden:e=>!e.hidden})}showColumn(){return this.updateColumn(Array.from(arguments),{hidden:!1})}hideColumn(){return this.updateColumn(Array.from(arguments),{hidden:!0})}addSearch(e,t){let i=0;1==arguments.length?(t=e,e=this.searches.length):null==(e="string"==typeof e?this.getSearch(e,!0):e)&&(e=this.searches.length),Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++)this.searches.splice(e,0,t[s]),e++,i++;return this.searchClose(),i}removeSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&(this.searches.splice(i,1),e++);return this.searchClose(),e}getSearch(e,t){if(0===arguments.length){var i=[];for(let e=0;e<this.searches.length;e++)i.push(this.searches[e].field);return i}for(let i=0;i<this.searches.length;i++)if(this.searches[i].field==e)return!0===t?i:this.searches[i];return null}toggleSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&(this.searches[i].hidden=!this.searches[i].hidden,e++);return this.searchClose(),e}showSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&!1!==this.searches[i].hidden&&(this.searches[i].hidden=!1,e++);return this.searchClose(),e}hideSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;0<=i;i--)this.searches[i].field==arguments[t]&&!0!==this.searches[i].hidden&&(this.searches[i].hidden=!0,e++);return this.searchClose(),e}getSearchData(e){for(let t=0;t<this.searchData.length;t++)if(this.searchData[t].field==e)return this.searchData[t];return null}localSort(e,t){let i=this;if(this.url?.get??this.url)return console.log("ERROR: grid.localSort can only be used on local data source, grid.url should be empty."),0;if(0===Object.keys(this.sortData).length){let e=this.last.originalSort;return e&&this.records.sort(((t,i)=>(t=e.indexOf(t.recid),e.indexOf(i.recid)<t?1:-1))),0}let s=Date.now();this.selectionSave(),this.prepareData(),t||this.reset();for(let e=0;e<this.sortData.length;e++){var l=this.getColumn(this.sortData[e].field);if(!l)return;"string"==typeof l.render&&(-1!=["date","age"].indexOf(l.render.split(":")[0])&&(this.sortData[e].field_=l.field+"_"),-1!=["time"].indexOf(l.render.split(":")[0]))&&(this.sortData[e].field_=l.field+"_")}for(let e=0;e<i.records.length;e++){var n=i.records[e];null!=n.w2ui?.parent_recid&&(n.w2ui._path=o(n))}this.records.sort(((e,t)=>{if(!(e.w2ui&&null!=e.w2ui.parent_recid||t.w2ui&&null!=t.w2ui.parent_recid))return d(e,t);var i=o(e),s=o(t);for(let e=0;e<Math.min(i.length,s.length);e++){var l=d(i[e],s[e]);if(0!==l)return l}return i.length>s.length?1:i.length<s.length?-1:(console.log("ERROR: two paths should not be equal."),0)}));for(let e=0;e<i.records.length;e++){var r=i.records[e];null!=r.w2ui?.parent_recid&&(r.w2ui._path=null)}return this.selectionRestore(t),s=Date.now()-s,!0!==e&&this.show.statusSort&&setTimeout((()=>{this.status(a.lang("Sorting took ${count} seconds",{count:s/1e3}))}),10),s;function o(e){var t;return e.w2ui&&null!=e.w2ui.parent_recid?e.w2ui._path||((t=i.get(e.w2ui.parent_recid))?o(t).concat(e):(console.log("ERROR: no parent record: "+e.w2ui.parent_recid),[e])):[e]}function d(e,t){if(e===t)return 0;for(let n=0;n<i.sortData.length;n++){var s=i.sortData[n].field,l=i.sortData[n].field_||s;let r=e[l],o=t[l];if(-1!=String(s).indexOf(".")&&(r=i.parseField(e,l),o=i.parseField(t,l)),(l=i.getColumn(s))&&0<Object.keys(l.editable).length&&(a.isPlainObject(r)&&r.text&&(r=r.text),a.isPlainObject(o))&&o.text&&(o=o.text),0!==(s=h(r,o,0,i.sortData[n].direction,l.sortMode||"default")))return s}return h(e.recid,t.recid,0,"asc")}function h(e,t,i,s,l){if(e===t)return 0;if((null==e||""===e)&&null!=t&&""!==t)return 1;if(null!=e&&""!==e&&(null==t||""===t))return-1;if(s="asc"===s.toLowerCase()?1:-1,typeof e!=typeof t)return typeof t<typeof e?s:-s;if(e.constructor.name!=t.constructor.name)return e.constructor.name>t.constructor.name?s:-s;e&&"object"==typeof e&&(e=e.valueOf()),t&&"object"==typeof t&&(t=t.valueOf());var n={}.toString;switch(e&&"object"==typeof e&&e.toString!=n&&(e=String(e)),t&&"object"==typeof t&&t.toString!=n&&(t=String(t)),"string"==typeof e&&(e=e.toLowerCase().trim()),"string"==typeof t&&(t=t.toLowerCase().trim()),l){case"natural":l=a.naturalCompare;break;case"i18n":l=a.i18nCompare}return"function"==typeof l?l(e,t)*s:t<e?s:e<t?-s:0}}localSearch(e){let t=this;var i=this.url?.get??this.url;if(!i){let l=Date.now(),n={}.toString,r={};if(this.total=this.records.length,this.last.searchIds=[],this.prepareData(),0<this.searchData.length&&!i){for(let e=this.total=0;e<this.records.length;e++){var s=this.records[e];if(function e(i){let s,l,r,o,d=0,h=!1;for(let e=0;e<t.searchData.length;e++){let c=t.searchData[e],u=t.getSearch(c.field);if(null!=c){null==u&&(u={field:c.field,type:c.type});let e=t.parseField(i,u.field);switch(s=null==e||"object"==typeof e&&e.toString==n?"":String(e).toLowerCase(),null!=c.value&&(Array.isArray(c.value)?(l=c.value[0],r=c.value[1]):l=String(c.value).toLowerCase()),c.operator){case"=":case"is":t.parseField(i,u.field)==c.value?d++:"date"==u.type?(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.formatDate(o,"yyyy-mm-dd"),l=a.formatDate(a.isDate(l,a.settings.dateFormat,!0),"yyyy-mm-dd"),s==l&&d++):"time"==u.type?(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.formatTime(o,"hh24:mi"),l=a.formatTime(l,"hh24:mi"),s==l&&d++):"datetime"==u.type&&(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.formatDateTime(o,"yyyy-mm-dd|hh24:mm:ss"),l=a.formatDateTime(a.isDateTime(l,a.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),s==l)&&d++;break;case"between":-1!=["int","float","money","currency","percent"].indexOf(u.type)?parseFloat(t.parseField(i,u.field))>=parseFloat(l)&&parseFloat(t.parseField(i,u.field))<=parseFloat(r)&&d++:"date"==u.type?(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.isDate(o,a.settings.dateFormat,!0),l=a.isDate(l,a.settings.dateFormat,!0),null!=(r=a.isDate(r,a.settings.dateFormat,!0))&&(r=new Date(r.getTime()+864e5)),s>=l&&s<r&&d++):"time"==u.type?(s=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),l=a.isTime(l,!0),r=a.isTime(r,!0),l=(new Date).setHours(l.hours,l.minutes,l.seconds||0,0),r=(new Date).setHours(r.hours,r.minutes,r.seconds||0,0),s>=l&&s<r&&d++):"datetime"==u.type&&(s=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),l=a.isDateTime(l,a.settings.datetimeFormat,!0),r=(r=a.isDateTime(r,a.settings.datetimeFormat,!0))&&new Date(r.getTime()+864e5),s>=l)&&s<r&&d++;break;case"<=":h=!0;case"<":case"less":-1!=["int","float","money","currency","percent"].indexOf(u.type)?(s=parseFloat(t.parseField(i,u.field)),l=parseFloat(c.value),(s<l||h&&s===l)&&d++):"date"==u.type?(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.isDate(o,a.settings.dateFormat,!0),l=a.isDate(l,a.settings.dateFormat,!0),(s<l||h&&s===l)&&d++):"time"==u.type?(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.formatTime(o,"hh24:mi"),l=a.formatTime(l,"hh24:mi"),(s<l||h&&s===l)&&d++):"datetime"==u.type&&(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.formatDateTime(o,"yyyy-mm-dd|hh24:mm:ss"),l=a.formatDateTime(a.isDateTime(l,a.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),s.length==l.length)&&(s<l||h&&s===l)&&d++;break;case">=":h=!0;case">":case"more":-1!=["int","float","money","currency","percent"].indexOf(u.type)?(s=parseFloat(t.parseField(i,u.field)),l=parseFloat(c.value),(s>l||h&&s===l)&&d++):"date"==u.type?(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.isDate(o,a.settings.dateFormat,!0),l=a.isDate(l,a.settings.dateFormat,!0),(s>l||h&&s===l)&&d++):"time"==u.type?(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.formatTime(o,"hh24:mi"),l=a.formatTime(l,"hh24:mi"),(s>l||h&&s===l)&&d++):"datetime"==u.type&&(o=t.parseField(i,u.field+"_")instanceof Date?t.parseField(i,u.field+"_"):t.parseField(i,u.field),s=a.formatDateTime(o,"yyyy-mm-dd|hh24:mm:ss"),l=a.formatDateTime(a.isDateTime(l,a.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),s.length==l.length)&&(s>l||h&&s===l)&&d++;break;case"in":o=c.value,(-1!==(o=c.svalue?c.svalue:o).indexOf(a.isFloat(e)?parseFloat(e):e)||-1!==o.indexOf(s)&&""!==s)&&d++;break;case"not in":o=c.value,-1!==(o=c.svalue?c.svalue:o).indexOf(a.isFloat(e)?parseFloat(e):e)||-1!==o.indexOf(s)&&""!==s||d++;break;case"begins":case"begins with":0===s.indexOf(l)&&d++;break;case"contains":0<=s.indexOf(l)&&d++;break;case"null":null==t.parseField(i,u.field)&&d++;break;case"not null":null!=t.parseField(i,u.field)&&d++;break;case"ends":case"ends with":let n=s.lastIndexOf(l);-1!==n&&n==s.length-l.length&&d++}}}if("OR"==t.last.logic&&0!==d||"AND"==t.last.logic&&d==t.searchData.length)return!0;if(i.w2ui?.children&&!0!==i.w2ui?.expanded)for(let t=0;t<i.w2ui.children.length;t++)if(e(i.w2ui.children[t]))return!0;return!1}(s))if(s?.w2ui&&function e(i){let s=t.get(i,!0);if(null==s||null==i||r[i]||t.last.searchIds.includes(s))return;r[i]=!0;let l=t.records[s];l?.w2ui&&e(l.w2ui.parent_recid),t.last.searchIds.push(s)}(s.w2ui.parent_recid),0<this.showExtraOnSearch){let t=this.showExtraOnSearch,i=this.showExtraOnSearch;if(e<t&&(t=e),e+i>this.records.length&&(i=this.records.length-e),0<t)for(let i=e-t;i<e;i++)this.last.searchIds.indexOf(i)<0&&this.last.searchIds.push(i);if(this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e),0<i)for(let t=e+1;t<=e+i;t++)this.last.searchIds.indexOf(t)<0&&this.last.searchIds.push(t)}else this.last.searchIds.push(e)}this.total=this.last.searchIds.length}return l=Date.now()-l,!0!==e&&this.show.statusSearch&&setTimeout((()=>{this.status(a.lang("Search took ${count} seconds",{count:l/1e3}))}),10),l}console.log("ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.")}getRangeData(e,t){var i=this.get(e[0].recid,!0),s=this.get(e[1].recid,!0),l=e[0].column,n=e[1].column,a=[];if(l==n)for(let e=i;e<=s;e++){var r=this.records[e],o=r[this.columns[l].field]||null;a.push(!0!==t?o:{data:o,column:l,index:e,record:r})}else if(i==s){var d=this.records[i];for(let e=l;e<=n;e++){var h=d[this.columns[e].field]||null;a.push(!0!==t?h:{data:h,column:e,index:i,record:d})}}else for(let e=i;e<=s;e++){var c=this.records[e];a.push([]);for(let i=l;i<=n;i++){var u=c[this.columns[i].field];!0!==t?a[a.length-1].push(u):a[a.length-1].push({data:u,column:i,index:e,record:c})}}return a}addRange(e){let t,i,s=0;if("row"!=this.selectType){Array.isArray(e)||(e=[e]);for(let n=0;n<e.length;n++){if("object"!=typeof e[n]&&(e[n]={name:"selection"}),"selection"==e[n].name){if(!1===this.show.selectionBorder)continue;var l=this.getSelection();if(0===l.length){this.removeRange("selection");continue}t=l[0],i=l[l.length-1]}else t=e[n].range[0],i=e[n].range[1];if(t){l={name:e[n].name,range:[{recid:t.recid,column:t.column},{recid:i.recid,column:i.column}],style:e[n].style||"",class:e[n].class};let a=!1;for(let t=0;t<this.ranges.length;t++)if(this.ranges[t].name==e[n].name){a=t;break}!1!==a?this.ranges[a]=l:this.ranges.push(l),s++}}this.refreshRanges()}return s}removeRange(){let e=0;for(let i=0;i<arguments.length;i++){var t=arguments[i];l(this.box).find("#grid_"+this.name+"_"+t).remove(),l(this.box).find("#grid_"+this.name+"_f"+t).remove();for(let i=this.ranges.length-1;0<=i;i--)this.ranges[i].name==t&&(this.ranges.splice(i,1),e++)}return e}refreshRanges(){if(0!==this.ranges.length){let p,m=this;var e=Date.now(),t=l(this.box).find(`#grid_${this.name}_frecords`),i=l(this.box).find(`#grid_${this.name}_records`);for(let w=0;w<this.ranges.length;w++){var s=this.ranges[w],n=s.range[0],r=s.range[1];null==n.index&&(n.index=this.get(n.recid,!0)),null==r.index&&(r.index=this.get(r.recid,!0));let x=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(n.recid)+' td[col="'+n.column+'"]'),_=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(r.recid)+' td[col="'+r.column+'"]'),k=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(n.recid)+' td[col="'+n.column+'"]'),C=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(r.recid)+' td[col="'+r.column+'"]'),S=r.column;n.column<this.last.vscroll.colIndStart&&r.column>this.last.vscroll.colIndStart&&(x=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(n.recid)+' td[col="start"]')),n.column<this.last.vscroll.colIndEnd&&r.column>this.last.vscroll.colIndEnd&&(_=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(r.recid)+' td[col="end"]'),S='"end"');var o,d=parseInt(l(this.box).find("#grid_"+this.name+"_rec_top").next().attr("index")),h=parseInt(l(this.box).find("#grid_"+this.name+"_rec_bottom").prev().attr("index")),c=parseInt(l(this.box).find("#grid_"+this.name+"_frec_top").next().attr("index")),u=parseInt(l(this.box).find("#grid_"+this.name+"_frec_bottom").prev().attr("index"));0===x.length&&n.index<d&&r.index>d&&(x=l(this.box).find("#grid_"+this.name+"_rec_top").next().find('td[col="'+n.column+'"]')),0===_.length&&r.index>h&&n.index<h&&(_=l(this.box).find("#grid_"+this.name+"_rec_bottom").prev().find('td[col="'+S+'"]')),0===k.length&&n.index<c&&r.index>c&&(k=l(this.box).find("#grid_"+this.name+"_frec_top").next().find('td[col="'+n.column+'"]')),0===C.length&&r.index>u&&n.index<u&&(C=l(this.box).find("#grid_"+this.name+"_frec_bottom").prev().find('td[col="'+r.column+'"]')),h=(d=l(this.box).find("#grid_"+this.name+"_editable").find(".w2ui-input")).attr("index"),c=this.records[h]?.recid,u=d.attr("column"),"selection"==s.name&&s.range[0].recid==c&&s.range[0].column==u||(p=l(this.box).find("#grid_"+this.name+"_f"+s.name),(0<k.length||0<C.length)&&(0===p.length?(t.append('<div id="grid_'+this.name+"_f"+s.name+'" class="w2ui-selection" style="'+s.style+'">'+("selection"==s.name&&this.show.selectionResizer?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),p=l(this.box).find("#grid_"+this.name+"_f"+s.name)):(p.attr("style",s.style),p.find(".w2ui-selection-resizer").show()),0===C.length&&(0===(C=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(r.recid)+" td:last-child")).length&&(C=l(this.box).find("#grid_"+this.name+"_frec_bottom td:first-child")),p.css("border-right","0px"),p.find(".w2ui-selection-resizer").hide()),null!=n.recid)&&null!=r.recid&&0<k.length&&0<C.length?(h=getComputedStyle(C[0]),d=k.prop("offsetTop")-k.prop("scrollTop"),c=k.prop("offsetLeft")+k.prop("scrollLeft"),u=C.prop("offsetTop")-C.prop("scrollTop"),o=C.prop("offsetLeft")+C.prop("scrollLeft"),p.show().css({top:(0<d?d:0)+"px",left:(0<c?c:0)+"px",width:o-c+parseFloat(h.width)-1+"px",height:u-d+parseFloat(h.height)-1+"px"})):p.hide(),p=l(this.box).find("#grid_"+this.name+"_"+s.name),(0<x.length||0<_.length)&&(0===p.length?(i.append(`\n                        <div id="grid_${this.name}_${s.name}" class="w2ui-selection ${s.class??""}" style="${s.style}">\n                            ${"selection"==s.name&&this.show.selectionResizer?`<div id="grid_${this.name}_resizer" class="w2ui-selection-resizer"></div>`:""}\n                        </div>\n                    `),p=l(this.box).find("#grid_"+this.name+"_"+s.name)):p.attr("style",s.style),0===x.length&&0===(x=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(n.recid)+" td:first-child")).length&&(x=l(this.box).find("#grid_"+this.name+"_rec_top td:first-child")),0!==C.length&&p.css("border-left","0px"),null!=n.recid)&&null!=r.recid&&0<x.length&&0<_.length?(o=getComputedStyle(_[0]),c=x.prop("offsetTop")-x.prop("scrollTop"),u=x.prop("offsetLeft")+x.prop("scrollLeft"),d=_.prop("offsetTop")-_.prop("scrollTop"),h=_.prop("offsetLeft")+_.prop("scrollLeft"),p.show().css({top:(0<c?c:0)+"px",left:(0<u?u:0)+"px",width:h-u+parseFloat(o.width)-1+"px",height:d-c+parseFloat(o.height)-1+"px"})):p.hide())}l(this.box).find(".w2ui-selection-resizer").off(".resizer").on("mousedown.resizer",(function(e){var t=(i=m.getSelection())[0],i=i[i.length-1];m.last.move={type:"expand",x:e.screenX,y:e.screenY,divX:0,divY:0,index:t.index,recid:t.recid,column:t.column,name:b[t.column]+(t.index+1)+":"+b[i.column]+(i.index+1),originalRange:[a.clone(t),a.clone(i)],newRange:[a.clone(t),a.clone(i)]},f.originalName=m.last.move.name,f.originalRange=m.last.move.originalRange,l("body").off(".w2ui-"+m.name).on("mousemove.w2ui-"+m.name,v).on("mouseup.w2ui-"+m.name,y),e.preventDefault()})).on("dblclick.resizer",(e=>{!0!==(e=this.trigger("resizerDblClick",{target:this.name,originalEvent:e})).isCancelled&&e.finish()}));let g,f={target:this.name,originalRange:null,newRange:null},b="abcdefghijklmnopqrstuvwxyz";return Date.now()-e;function v(e){var t=m.last.move;if(t&&"expand"==t.type){t.divX=e.screenX-t.x,t.divY=e.screenY-t.y;let i,s,n,r=e.target;"TD"!=r.tagName.toUpperCase()&&(r=l(r).closest("td")[0]),null!=(n=null!=l(r).attr("col")?parseInt(l(r).attr("col")):n)&&(r=l(r).closest("tr")[0],s=parseInt(l(r).attr("index")),i=m.records[s]?.recid,t.newRange[1].recid!=i||t.newRange[1].column!=n)&&(e=a.clone(t.newRange),t.newRange=[{recid:t.recid,index:t.index,column:t.column},{recid:i,index:s,column:n}],f.newName=b[t.column]+(t.index+1)+":"+b[n]+(s+1),f.newRange=a.clone(t.newRange),!0===(g=m.trigger("selectionExtend",f)).isCancelled?(t.newRange=e,f.newRange=e):m.addRange({name:"selection-expand",range:t.newRange,class:"w2ui-selection-expand"}))}}function y(e){m.removeRange("selection-expand"),l("body").off(".w2ui-"+m.name),"expand"==m.last.move?.type&&g.finish&&g.finish(),delete m.last.move}}}select(){if(0===arguments.length)return 0;let e=0;var t=this.last.selection;this.multiSelect||this.selectNone(!0);let i=Array.from(arguments);Array.isArray(i[0])&&(i=i[0]);var s={target:this.name};if(1==i.length?(s.multiple=!1,a.isPlainObject(i[0])?s.clicked={recid:i[0].recid,column:i[0].column}:s.recid=i[0]):(s.multiple=!0,s.clicked={recids:i}),0!=this.compareSelection(i).select.length){if(!0===(s=this.trigger("select",s)).isCancelled)return 0;if("row"==this.selectType)for(let s=0;s<i.length;s++){var n="object"==typeof i[s]?i[s].recid:i[s],r=this.get(n,!0);if(null!=r){let i=null,s=null;(0!==this.searchData.length||r+1>=this.last.vscroll.recIndStart&&r+1<=this.last.vscroll.recIndEnd)&&(i=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(n)),s=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(n))),"row"==this.selectType&&-1==t.indexes.indexOf(r)&&(t.indexes.push(r),i&&s&&(i.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),s.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),i.find(".w2ui-grid-select-check").prop("checked",!0)),e++)}}else{var o={};for(let e=0;e<i.length;e++){var d="object"==typeof i[e]?i[e].recid:i[e],h="object"==typeof i[e]?i[e].column:null;if(o[d]=o[d]||[],Array.isArray(h))o[d]=h;else if(a.isInt(h))o[d].push(h);else for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||o[d].push(parseInt(e))}var c,u=[];for(c in o){var p=this.get(c,!0);if(null!=p){let i=null,s=null;p+1>=this.last.vscroll.recIndStart&&p+1<=this.last.vscroll.recIndEnd&&(i=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(c)),s=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(c)));var m=t.columns[p]||[];-1==t.indexes.indexOf(p)&&t.indexes.push(p);for(let e=0;e<o[c].length;e++)-1==m.indexOf(o[c][e])&&m.push(o[c][e]);m.sort(((e,t)=>e-t));for(let t=0;t<o[c].length;t++){var g=o[c][t];-1==u.indexOf(g)&&u.push(g),i&&(i.find("#grid_"+this.name+"_data_"+p+"_"+g).addClass("w2ui-selected"),i.find(".w2ui-col-number").addClass("w2ui-row-selected"),i.find(".w2ui-grid-select-check").prop("checked",!0)),s&&(s.find("#grid_"+this.name+"_data_"+p+"_"+g).addClass("w2ui-selected"),s.find(".w2ui-col-number").addClass("w2ui-row-selected"),s.find(".w2ui-grid-select-check").prop("checked",!0)),e++}t.columns[p]=m}}for(let e=0;e<u.length;e++)l(this.box).find("#grid_"+this.name+"_column_"+u[e]+" .w2ui-col-header").addClass("w2ui-col-selected")}t.indexes.sort(((e,t)=>e-t));var f=0<this.records.length&&t.indexes.length==this.records.length,b=0<t.indexes.length&&0!==this.searchData.length&&t.indexes.length==this.last.searchIds.length;return f||b?l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(t,f),s.finish(),e}}unselect(){let e=0;var t=this.last.selection;let i=Array.from(arguments);Array.isArray(i[0])&&(i=i[0]);var s={target:this.name};if(1==i.length?(s.multiple=!1,a.isPlainObject(i[0])?s.clicked={recid:i[0].recid,column:i[0].column}:s.clicked={recid:i[0]}):(s.multiple=!0,s.recids=i),0!=this.compareSelection(i).unselect.length){if(!0===(s=this.trigger("select",s)).isCancelled)return 0;for(let s=0;s<i.length;s++){var n="object"==typeof i[s]?i[s].recid:i[s];if(null!=(r=this.get(n))){var r=this.get(r.recid,!0),o=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(n)),d=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(n));if("row"==this.selectType)-1!=t.indexes.indexOf(r)&&(t.indexes.splice(t.indexes.indexOf(r),1),o.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),d.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),0!=o.length&&(o[0].style.cssText="height: "+this.recordHeight+"px; "+o.attr("custom_style"),d[0].style.cssText="height: "+this.recordHeight+"px; "+d.attr("custom_style")),o.find(".w2ui-grid-select-check").prop("checked",!1),e++);else{var h=i[s].column;if(!a.isInt(h)){var c=[];for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||c.push({recid:n,column:e});return this.unselect(c)}if(d=t.columns[r],Array.isArray(d)&&-1!=d.indexOf(h)){d.splice(d.indexOf(h),1),l(this.box).find(`#grid_${this.name}_rec_${a.escapeId(n)} > td[col="${h}"]`).removeClass("w2ui-selected w2ui-inactive"),l(this.box).find(`#grid_${this.name}_frec_${a.escapeId(n)} > td[col="${h}"]`).removeClass("w2ui-selected w2ui-inactive");let i=!1,s=!1;var u=this.getSelection();for(let e=0;e<u.length;e++)u[e].column==h&&(i=!0),u[e].recid==n&&(s=!0);i||l(this.box).find(`.w2ui-grid-columns td[col="${h}"] .w2ui-col-header, .w2ui-grid-fcolumns td[col="${h}"] .w2ui-col-header`).removeClass("w2ui-col-selected"),s||l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(n)).find(".w2ui-col-number").removeClass("w2ui-row-selected"),e++,0===d.length&&(delete t.columns[r],t.indexes.splice(t.indexes.indexOf(r),1),o.find(".w2ui-grid-select-check").prop("checked",!1))}}}}var p=0<this.records.length&&t.indexes.length==this.records.length,m=0<t.indexes.length&&0!==this.searchData.length&&t.indexes.length==this.last.searchIds.length;return p||m?l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(t,p),s.finish(),e}}compareSelection(e){var t=this.getSelection(),i=[],s=[];if("row"==this.selectType){e.forEach(((t,i)=>{"object"==typeof t&&(e[i]=t.recid)}));for(let s=0;s<e.length;s++)t.includes(e[s])||i.push(e[s]);for(let i=0;i<e.length;i++)t.includes(e[i])&&s.push(e[i])}else{for(let s=0;s<e.length;s++){let l=!1;for(let i=0;i<t.length;i++)e[s].recid==t[i].recid&&e[s].column==t[i].column&&(l=!0);l||i.push({recid:e[s].recid,column:e[s].column})}for(let i=0;i<t.length;i++){let l=!1;for(let s=0;s<e.length;s++)e[s].recid==t[i].recid&&e[s].column==t[i].column&&(l=!0);l||s.push({recid:t[i].recid,column:t[i].column})}}return{select:i,unselect:s}}selectAll(){var e=Date.now();if(!1!==this.multiSelect){var t=this.url?.get??this.url;let s=a.clone(this.last.selection);var i=[];for(let e=0;e<this.columns.length;e++)i.push(e);if(s.indexes=[],t||0===this.searchData.length){let e=this.records.length;0==this.searchData.length||t||(e=this.last.searchIds.length);for(let t=0;t<e;t++)s.indexes.push(t),"row"!=this.selectType&&(s.columns[t]=i.slice())}else for(let e=0;e<this.last.searchIds.length;e++)s.indexes.push(this.last.searchIds[e]),"row"!=this.selectType&&(s.columns[this.last.searchIds[e]]=i.slice());if(!0!==(t=this.trigger("select",{target:this.name,multiple:!0,all:!0,clicked:s})).isCancelled)return this.last.selection=s,"row"==this.selectType?(l(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),l(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected")):(l(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").addClass("w2ui-col-selected"),l(this.box).find(".w2ui-grid-records tr .w2ui-col-number").addClass("w2ui-row-selected"),l(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected"),l(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").addClass("w2ui-row-selected"),l(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected")),l(this.box).find("input.w2ui-grid-select-check").prop("checked",!0),s=this.getSelection(!0),this.addRange("selection"),l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0),this.status(),this.updateToolbar({indexes:s},!0),t.finish(),Date.now()-e}}selectNone(e){var t,i=Date.now();let s;if(e||!0!==(s=this.trigger("select",{target:this.name,clicked:[]})).isCancelled)return t=this.last.selection,"row"==this.selectType?(l(this.box).find(".w2ui-grid-records tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),l(this.box).find(".w2ui-grid-frecords tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected")):(l(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").removeClass("w2ui-col-selected"),l(this.box).find(".w2ui-grid-records tr .w2ui-col-number").removeClass("w2ui-row-selected"),l(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").removeClass("w2ui-row-selected"),l(this.box).find(".w2ui-grid-data.w2ui-selected").removeClass("w2ui-selected w2ui-inactive")),l(this.box).find("input.w2ui-grid-select-check").prop("checked",!1),t.indexes=[],t.columns={},this.removeRange("selection"),l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.updateToolbar(t,!1),e||s.finish(),Date.now()-i}updateToolbar(e){let t=this,i=e&&e.indexes?e.indexes.length:0;function s(s,l){if(null!=s.batch){let n=!1;!0===s.batch?0<i&&(n=!0):"number"==typeof s.batch?i===s.batch&&(n=!0):"function"==typeof s.batch&&(n=s.batch({cnt:i,sel:e})),n?t.toolbar.enable(l+s.id):t.toolbar.disable(l+s.id)}}this.toolbar.render&&(this.toolbar.items.forEach((e=>{s(e,""),Array.isArray(e.items)&&e.items.forEach((t=>{s(t,e.id+":")}))})),this.show.toolbarSave)&&(0<this.getChanges().length?this.toolbar.enable("w2ui-save"):this.toolbar.disable("w2ui-save"))}getSelection(e){var t=[],i=this.last.selection;if("row"==this.selectType)for(let s=0;s<i.indexes.length;s++)this.records[i.indexes[s]]&&t.push(!0===e?i.indexes[s]:this.records[i.indexes[s]].recid);else for(let e=0;e<i.indexes.length;e++){var s=i.columns[i.indexes[e]];if(this.records[i.indexes[e]])for(let l=0;l<s.length;l++)t.push({recid:this.records[i.indexes[e]].recid,index:parseInt(i.indexes[e]),column:s[l]})}return t}search(e,t){var i=this.url?.get??this.url,s=[];let n=this.last.multi,r=this.last.logic,o=this.last.field,d=this.last.search,h=!1;var c=l(`#w2overlay-${this.name}-search-overlay`);""===t&&(t=null);for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(s.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),h=!0);if(0===arguments.length&&0===c.length&&(t=this.multiSearch?(e=this.searchData,this.last.logic):(e=this.last.field,this.last.search)),0===arguments.length&&0!==c.length){this.focus(),r=c.find(`#grid_${this.name}_logic`).val(),d="";for(let e=0;e<this.searches.length;e++){var u=this.searches[e],p=c.find("#grid_"+this.name+"_operator_"+e).val(),m=c.find("#grid_"+this.name+"_field_"+e),g=c.find("#grid_"+this.name+"_field2_"+e);let t=m.val(),l=g.val(),r=null,o=null;if(-1!=["int","float","money","currency","percent"].indexOf(u.type)&&(f=m[0]._w2field,g=g[0]._w2field,f&&(t=f.clean(t)),g)&&(l=g.clean(l)),-1!=["list","enum"].indexOf(u.type)||-1!=["in","not in"].indexOf(p))if(t=m[0]._w2field.selected||{},Array.isArray(t)){r=[];for(let e=0;e<t.length;e++)r.push(a.isFloat(t[e].id)?parseFloat(t[e].id):String(t[e].id).toLowerCase()),delete t[e].hidden;0===Object.keys(t).length&&(t="")}else o=t.text||"",t=t.id||"";if(""!==t&&null!=t||null!=l&&""!==l){var f={field:u.field,type:u.type,operator:p};"between"==p?a.extend(f,{value:[t,l]}):"in"==p&&"string"==typeof t||"not in"==p&&"string"==typeof t?a.extend(f,{value:t.split(",")}):a.extend(f,{value:t}),r&&a.extend(f,{svalue:r}),o&&a.extend(f,{text:o});try{"date"==u.type&&"between"==p&&(f.value[0]=t,f.value[1]=l),"date"==u.type&&"is"==p&&(f.value=t)}catch(i){}s.push(f),n=!0}}}if("string"==typeof e&&(1==arguments.length&&(t=e,e="all"),o=e,d=t,n=!1,r=h?"AND":"OR",null!=t))if("all"==e.toLowerCase()){if(0<this.searches.length)for(let e=0;e<this.searches.length;e++){var b,v=this.searches[e];if(("text"==v.type||"alphanumeric"==v.type&&a.isAlphaNumeric(t)||"int"==v.type&&a.isInt(t)||"float"==v.type&&a.isFloat(t)||"percent"==v.type&&a.isFloat(t)||("hex"==v.type||"color"==v.type)&&a.isHex(t)||"currency"==v.type&&a.isMoney(t)||"money"==v.type&&a.isMoney(t)||"date"==v.type&&a.isDate(t)||"time"==v.type&&a.isTime(t)||"datetime"==v.type&&a.isDateTime(t)||"datetime"==v.type&&a.isDate(t)||"enum"==v.type&&a.isAlphaNumeric(t)||"list"==v.type&&a.isAlphaNumeric(t))&&(b=this.defaultOperator[this.operatorsMap[v.type]],b={field:v.field,type:v.type,operator:null!=v.operator?v.operator:b,value:t},""!=String(t).trim())&&s.push(b),-1!=["int","float","money","currency","percent"].indexOf(v.type)&&2==String(t).trim().split("-").length&&(b=String(t).trim().split("-"),y={field:v.field,type:v.type,operator:null!=v.operator?v.operator:"between",value:[b[0],b[1]]},s.push(y)),-1!=["list","enum"].indexOf(v.type)){var y,w=[];null==v.options&&(v.options={}),Array.isArray(v.options.items)||(v.options.items=[]);for(let e=0;e<v.options.items;e++){var x=v.options.items[e];try{var _=new RegExp(t,"i");_.test(x)&&w.push(e),x.text&&_.test(x.text)&&w.push(x.id)}catch(i){}}0<w.length&&(y={field:v.field,type:v.type,operator:null!=v.operator?v.operator:"in",value:w},s.push(y))}}else for(let e=0;e<this.columns.length;e++){var k={field:this.columns[e].field,type:"text",operator:this.defaultOperator.text,value:t};s.push(k)}0==s.length&&(C={field:"All",type:"text",operator:this.defaultOperator.text,value:t},s.push(C))}else{var C=c.find("#grid_"+this.name+"_search_all");let i=this.getSearch(e);if((i=null==i?{field:e,type:"text"}:i).field==e&&(this.last.label=i.label),""!==t){let e=this.defaultOperator[this.operatorsMap[i.type]],l=t;if(-1!=["date","time","datetime"].indexOf(i.type)&&(e="is"),-1!=["list","enum"].indexOf(i.type)&&(e="is",l=(C=C._w2field.get())&&0<Object.keys(C).length?C.id:""),"int"==i.type&&""!==t&&(e="is",-1!=String(t).indexOf("-")&&2==(C=t.split("-")).length&&(e="between",l=[parseInt(C[0]),parseInt(C[1])]),-1!=String(t).indexOf(","))){var S=t.split(",");e="in",l=[];for(let e=0;e<S.length;e++)l.push(S[e])}null!=i.operator&&(e=i.operator),C={field:i.field,type:i.type,operator:e,value:l},s.push(C)}}if(Array.isArray(e)){let i="AND";"string"==typeof t&&"OR"!=(i=t.toUpperCase())&&"AND"!=i&&(i="AND"),d="",n=!0,r=i;for(let t=0;t<e.length;t++){var E=e[t];"number"==typeof E.value&&null==E.operator&&(E.operator=this.defaultOperator.number),"string"==typeof E.value&&null==E.operator&&(E.operator=this.defaultOperator.text),Array.isArray(E.value)&&null==E.operator&&(E.operator=this.defaultOperator.enum),a.isDate(E.value)&&null==E.operator&&(E.operator=this.defaultOperator.date),s.push(E)}}!0!==(C=this.trigger("search",{target:this.name,multi:0===arguments.length,searchField:e||"multi",searchValue:e?t:"multi",searchData:s,searchLogic:r})).isCancelled&&(this.searchData=C.detail.searchData,this.last.field=o,this.last.search=d,this.last.multi=n,this.last.logic=C.detail.searchLogic,this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),i?(this.last.fetch.offset=0,this.reload()):(this.localSearch(),this.refresh()),C.finish())}searchOpen(){if(this.box&&0!==this.searches.length){let e=this.trigger("searchOpen",{target:this.name});if(!0!==e.isCancelled){let t=l(this.toolbar.box).find(".w2ui-grid-search-input .w2ui-search-drop");t.addClass("checked"),h.show({name:this.name+"-search-overlay",anchor:l(this.box).find("#grid_"+this.name+"_search_all").get(0),position:"bottom|top",html:this.getSearchesHTML(),align:"left",arrowSize:12,class:"w2ui-grid-search-advanced",hideOn:["doc-click"]}).then((t=>{this.initSearches(),this.last.search_opened=!0;let i=l(`#w2overlay-${this.name}-search-overlay`);i.data("gridName",this.name).off(".grid-search").on("click.grid-search",(()=>{i.find("input, select").each((e=>{(e=l(e).data("tooltipName"))&&e.forEach((e=>{h.hide(e)}))}))})),a.bindEvents(i.find("select, input, button"),this);var s=l(`#w2overlay-${this.name}-search-overlay *[rel=search]`);0<s.length&&s[0].focus(),e.finish()})).hide((e=>{t.removeClass("checked"),this.last.search_opened=!1}))}}}searchClose(){h.hide(this.name+"-search-overlay")}searchFieldTooltip(e,t,i){e=this.searches[e];var s=this.searchData[t];let n=s.operator,r=("less"==(n="more"==n&&"date"==s.type?"since":n)&&"date"==s.type&&(n="before"),""),o=s.value;Array.isArray(s.value)?(s.value.forEach((e=>{r+=`<span class="value">${e.text||e}</span>`})),"date"==s.type&&(r="",s.value.forEach((e=>{r+=`<span class="value">${a.formatDate(e)}</span>`})))):"date"==s.type&&(o=a.formatDateTime(o)),h.hide(this.name+"-search-props"),h.show({name:this.name+"-search-props",anchor:i,class:"w2ui-white",hideOn:"doc-click",html:`\n                <div class="w2ui-grid-search-single">\n                    <span class="field">${e.label}</span>\n                    <span class="operator">${a.lang(n)}</span>\n                    ${Array.isArray(s.value)?""+r:`<span class="value">${o}</span>`}\n                    <div class="buttons">\n                        <button id="remove" class="w2ui-btn">${a.lang("Remove This Field")}</button>\n                    </div>\n                </div>`}).then((e=>{l(e.detail.overlay.box).find("#remove").on("click",(()=>{this.searchData.splice(""+t,1),this.reload(),this.localSearch(),h.hide(this.name+"-search-props")}))}))}searchSuggest(e,t,i){clearTimeout(this.last.kbd_timer),clearTimeout(this.last.overlay_timer),this.searchShowFields(!0),this.searchClose(),!0===t?h.hide(this.name+"-search-suggest"):0<l(`#w2overlay-${this.name}-search-suggest`).length||(e?(t=l(this.box).find(`#grid_${this.name}_search_all`).get(0),e=[...this.defaultSearches??[],...0<this.defaultSearches?.length&&0<this.savedSearches?.length?["--"]:[],...this.savedSearches??[]],Array.isArray(e)&&0<e.length&&c.show({name:this.name+"-search-suggest",anchor:t,align:"both",items:e,hideOn:["doc-click","sleect","remove"],render(e){let t=e.text;return e.isDefault?`<b>${t}</b>`:t}}).select((e=>{var t=this.trigger("searchSelect",{target:this.name,index:e.detail.index,item:e.detail.item});!0===t.isCancelled?e.preventDefault():(e.detail.overlay.hide(),this.last.logic=e.detail.item.logic||"AND",this.last.search="",this.last.label="[Multiple Fields]",this.searchData=a.clone(e.detail.item.data),this.searchSelected=a.clone(e.detail.item,{exclude:["icon","remove"]}),this.reload(),t.finish())})).remove((e=>{let t=e.detail.item,i=this.trigger("searchRemove",{target:this.name,index:e.detail.index,item:t});!0===i.isCancelled?e.preventDefault():(e.detail.overlay.hide(),this.confirm(a.lang('Do you want to delete search "${item}"?',{item:t.text})).yes((e=>{var s=this.savedSearches.findIndex((e=>e.id==t.id));-1!==s&&this.savedSearches.splice(s,1),this.cacheSave("searches",this.savedSearches.map((e=>a.clone(e,{exclude:["remove","icon"]})))),e.detail.self.close(),i.finish()})).no((e=>{e.detail.self.close()})))}))):this.last.overlay_timer=setTimeout((()=>{this.searchSuggest(!0)}),100))}searchSave(){let e="",t=(this.searchSelected&&(e=this.searchSelected.text),this.savedSearches.findIndex((e=>e.id==this.searchSelected?.id))),i=this.trigger("searchSave",{target:this.name,saveLocalStorage:!0});!0!==i.isCancelled&&this.message({width:350,height:150,body:`<div class="w2ui-grid-save-search">\n                        <span>${a.lang(-1!=t?"Update Search":"Save New Search")}</span>\n                        <input class="search-name w2ui-input" placeholder="${a.lang("Search name")}">\n                   </div>`,buttons:`\n                <button id="grid-search-cancel" class="w2ui-btn">${a.lang("Cancel")}</button>\n                <button id="grid-search-save" class="w2ui-btn w2ui-btn-blue" ${""==String(e).trim()?"disabled":""}>${a.lang("Save")}</button>\n            `}).open((async s=>{l(s.detail.box).find("input, button").eq(0).val(e),await s.complete,l(s.detail.box).find("#grid-search-cancel").on("click",(()=>{this.message()})),l(s.detail.box).find("#grid-search-save").on("click",(()=>{var e=l(s.detail.box).find(".w2ui-message .search-name").val();this.searchSelected&&-1!=t?Object.assign(this.savedSearches[t],{id:e,text:e,logic:this.last.logic,data:a.clone(this.searchData)}):this.savedSearches.push({id:e,text:e,icon:"w2ui-icon-search",remove:!0,logic:this.last.logic,data:this.searchData}),this.cacheSave("searches",this.savedSearches.map((e=>a.clone(e,{exclude:["remove","icon"]})))),this.message(),(this.searchSelected?(this.searchSelected.text=e,l(this.box).find(`#grid_${this.name}_search_name .name-text`)):(this.searchSelected={text:e,logic:this.last.logic,data:a.clone(this.searchData)},l(s.detail.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),l(s.detail.box).find(`#grid_${this.name}_search_name`).show().find(".name-text"))).html(e),i.finish({name:e})})),l(s.detail.box).find("input, button").off(".message").on("keydown.message",(e=>{var t=String(l(s.detail.box).find(".w2ui-message-body input").val()).trim();13==e.keyCode&&""!=t&&l(s.detail.box).find("#grid-search-save").trigger("click"),27==e.keyCode&&this.message()})).eq(0).on("input.message",(e=>{var t=l(s.detail.box).closest(".w2ui-message").find("#grid-search-save");""===String(l(s.detail.box).val()).trim()?t.prop("disabled",!0):t.prop("disabled",!1)})).get(0).focus()}))}cache(e){if(a.hasLocalStorage&&this.useLocalStorage)try{var t=JSON.parse(localStorage.w2ui||"{}");return t[this.stateId||this.name]??={},t[this.stateId||this.name][e]}catch(e){}return null}cacheSave(e,t){if(a.hasLocalStorage&&this.useLocalStorage)try{var i=JSON.parse(localStorage.w2ui||"{}");return i[this.stateId||this.name]??={},i[this.stateId||this.name][e]=t,localStorage.w2ui=JSON.stringify(i),!0}catch(e){delete localStorage.w2ui}return!1}searchReset(e){var t=[];let i=!1;for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(t.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),i=!0);var s=this.trigger("search",{reset:!0,target:this.name,searchData:t});if(!0!==s.isCancelled){var n=l(this.box).find("#grid_"+this.name+"_search_all");if(this.searchData=s.detail.searchData,this.searchSelected=null,this.last.search="",this.last.logic=i?"AND":"OR",n.next().hide(),0<this.searches.length)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields",n.next().show();else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}this.last.multi=!1,this.last.fetch.offset=0,this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),n=n.val("").get(0),n?._w2field&&n._w2field.reset(),e||this.reload(),s.finish()}}searchShowFields(e){if(!0===e)h.hide(this.name+"-search-fields");else{var t=[];for(let e=-1;e<this.searches.length;e++){let s=this.searches[e];var i=s?s.field:null;i=this.getColumn(i);let l=!1,n=null;if(1==this.show.searchHiddenMsg&&-1!=e&&(null==i||!0===i.hidden&&!1!==i.hideable)&&(l=!0,n=a.lang("This column "+(null==i?"does not exist":"is hidden"))),-1==e){if(!this.multiSearch||!this.show.searchAll)continue;s={field:"all",label:"All Fields"}}else{if(null!=i&&!1===i.hideable)continue;if(!0===s.hidden&&(n=a.lang("This column is hidden"),!1===s.simple))continue}null==s.label&&null!=s.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",s),s.label=s.caption),t.push({id:s.field,text:a.lang(s.label),search:s,tooltip:n,disabled:l,checked:s.field==this.last.field})}c.show({type:"radio",name:this.name+"-search-fields",anchor:l(this.box).find("#grid_"+this.name+"_search_name").parent().find(".w2ui-search-down").get(0),items:t,align:"none",hideOn:["doc-click","select"]}).select((e=>{this.searchInitInput(e.detail.item.search.field)}))}}searchInitInput(e,t){let i;var s=l(this.box).find("#grid_"+this.name+"_search_all");if("all"==e)i={field:"all",label:a.lang("All Fields")};else if(null==(i=this.getSearch(e)))return;""!=this.last.search?(this.last.label=i.label,this.search(i.field,this.last.search)):(this.last.field=i.field,this.last.label=i.label),s.attr("placeholder",a.lang("Search")+" "+a.lang(i.label||i.caption||i.field,!0)),this.searchSelected?(l(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),l(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.text)):(l(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),l(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html(""))}clear(e){this.total=0,this.records=[],this.summary=[],this.last.fetch.offset=0,this.last.idCache={},this.last.selection={indexes:[],columns:{}},this.reset(!0),e||this.refresh()}reset(e){this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.vscroll.recIndStart=null,this.last.vscroll.recIndEnd=null,l(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),e||this.refresh()}skip(e,t){this.url?.get??this.url?(this.offset=parseInt(e),this.offset>this.total&&(this.offset=this.total-this.limit),(this.offset<0||!a.isInt(this.offset))&&(this.offset=0),this.clear(!0),this.reload(t)):console.log("ERROR: grid.skip() can only be called when you have remote data source.")}load(e,t){return null==e?(console.log('ERROR: You need to provide url argument when calling .load() method of "'+this.name+'" object.'),new Promise(((e,t)=>{t()}))):(this.clear(!0),this.request("load",{},e,t))}reload(e){let t=this;var i=this.url?.get??this.url;return t.selectionSave(),i?this.load(i,(()=>{t.selectionRestore(),"function"==typeof e&&e()})):(this.reset(!0),this.localSearch(),this.selectionRestore(),"function"==typeof e&&e({status:"success"}),new Promise((e=>{e()})))}request(e,t,i,s){let l,n,r=this;var o=new Promise(((e,t)=>{l=e,n=t}));if(null==t&&(t={}),!(i=i||this.url))return new Promise(((e,t)=>{t()}));let d;a.isInt(this.offset)||(this.offset=0),a.isInt(this.last.fetch.offset)||(this.last.fetch.offset=0);var h={limit:this.limit,offset:parseInt(this.offset)+parseInt(this.last.fetch.offset),searchLogic:this.last.logic,search:this.searchData.map((e=>(e=a.clone(e),this.searchMap&&this.searchMap[e.field]&&(e.field=this.searchMap[e.field]),e))),sort:this.sortData.map((e=>(e=a.clone(e),this.sortMap&&this.sortMap[e.field]&&(e.field=this.sortMap[e.field]),e)))};if(0===this.searchData.length&&(delete h.search,delete h.searchLogic),0===this.sortData.length&&delete h.sort,a.extend(h,this.postData),a.extend(h,t),"delete"!=e&&"save"!=e||(delete h.limit,delete h.offset,"delete"==(h.action=e)&&(h[this.recid||"recid"]=this.getSelection())),"load"==e){if(!0===(d=this.trigger("request",{target:this.name,url:i,postData:h,httpMethod:"GET",httpHeaders:this.httpHeaders})).isCancelled)return new Promise(((e,t)=>{t()}))}else d={detail:{url:i,postData:h,httpMethod:"save"==e?"PUT":"DELETE",httpHeaders:this.httpHeaders}};if(0===this.last.fetch.offset&&this.lock(a.lang(this.msgRefresh),!0),this.last.fetch.controller)try{this.last.fetch.controller.abort()}catch(t){}switch(i=d.detail.url,e){case"save":i?.save&&(i=i.save);break;case"delete":i?.remove&&(i=i.remove);break;default:i=i?.get??i}if(0<Object.keys(this.routeData).length){var c=a.parseRoute(i);if(0<c.keys.length)for(let e=0;e<c.keys.length;e++)null!=this.routeData[c.keys[e].name]&&(i=i.replace(new RegExp(":"+c.keys[e].name,"g"),this.routeData[c.keys[e].name]))}return i=new URL(i,location),t=a.prepareParams(i,{method:d.detail.httpMethod,headers:d.detail.httpHeaders,body:d.detail.postData},this.dataType),Object.assign(this.last.fetch,{action:e,options:t,controller:new AbortController,start:Date.now(),loaded:!1}),t.signal=this.last.fetch.controller.signal,fetch(i,t).catch(u).then((t=>{null!=t&&(200!=t?.status?u(t??{}):(r.unlock(),t.json().catch(u).then((t=>{this.requestComplete(t,e,s,l,n)}))))})),"load"==e&&d.finish(),o;function u(t){var i;"AbortError"!==t?.name&&(r.unlock(),!0!==(i=r.trigger("error",{response:t,lastFetch:r.last.fetch})).isCancelled)&&(t.status&&200!=t.status?t.json().then((e=>{r.error(t.status+": "+e.message??t.statusText)})).catch((()=>{r.error(t.status+": "+t.statusText)})):(console.log("ERROR: Server communication failed.","\n   EXPECTED:",{total:5,records:[{recid:1,field:"value"}]},"\n         OR:",{error:!0,message:"error message"}),r.requestComplete({error:!0,message:a.lang(this.msgHTTPError),response:t},e,s,l,n)),i.finish())}}requestComplete(e,t,i,s,n){let r=e.error??!1,o=(null==e.error&&"error"===e.status&&(r=!0),this.last.fetch.response=(Date.now()-this.last.fetch.start)/1e3,setTimeout((()=>{this.show.statusResponse&&this.status(a.lang("Server Response ${count} seconds",{count:this.last.fetch.response}))}),10),this.last.vscroll.pull_more=!1,this.last.vscroll.pull_refresh=!0,"load");"save"==this.last.fetch.action&&(o="save"),"delete"==this.last.fetch.action&&(o="delete");var d=this.trigger(o,{target:this.name,error:r,data:e,lastFetch:this.last.fetch});if(!0===d.isCancelled)n();else{if(r)this.error(a.lang(e.message??this.msgServerError)),n(e);else if("function"==typeof this.parser?"object"!=typeof(e=this.parser(e))&&console.log("ERROR: Your parser did not return proper object"):null==e?e={error:!0,message:a.lang(this.msgNotJSON)}:Array.isArray(e)&&(e={error:r,records:e,total:e.length}),"load"==t){if(null==e.total&&(e.total=-1),null==e.records&&(e.records=[]),e.records.length==this.limit?(n=this.records.length+e.records.length,this.last.fetch.hasMore=n!=this.total):(this.last.fetch.hasMore=!1,this.total=this.offset+this.last.fetch.offset+e.records.length),this.last.fetch.hasMore||l(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").hide(),0===this.last.fetch.offset)this.records=[],this.summary=[];else if(-1!=e.total&&parseInt(e.total)!=parseInt(this.total)){let e=this;return this.message(a.lang(this.msgNeedReload)).ok((()=>{delete e.last.fetch.offset,e.reload()})),new Promise((e=>{e()}))}a.isInt(e.total)&&(this.total=parseInt(e.total)),e.records&&e.records.forEach((e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.records.length),(!0===e.w2ui?.summary?this.summary:this.records).push(e)})),e.summary&&(this.summary=[],e.summary.forEach((e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.summary.length),this.summary.push(e)})))}else if("delete"==t)return this.reset(),this.reload();(this.url?.get??this.url)||(this.localSort(),this.localSearch()),this.total=parseInt(this.total),0===this.last.fetch.offset?this.refresh():(this.scroll(),this.resize()),"function"==typeof i&&i(e),s(e),d.finish(),this.last.fetch.loaded=!0}}error(e){var t=this.trigger("error",{target:this.name,message:e});!0!==t.isCancelled&&(this.message(e),t.finish())}getChanges(e){var t=[];void 0===e&&(e=this.records);for(let l=0;l<e.length;l++){var i,s=e[l];s?.w2ui&&(null!=s.w2ui.changes&&((i={})[this.recid||"recid"]=s.recid,t.push(a.extend(i,s.w2ui.changes))),!0!==s.w2ui.expanded)&&s.w2ui.children&&s.w2ui.children.length&&t.push(...this.getChanges(s.w2ui.children))}return t}mergeChanges(){var e=this.getChanges();for(let s=0;s<e.length;s++){var t,i=this.get(e[s][this.recid||"recid"]);for(t in e[s])if(!("recid"==t||this.recid&&t==this.recid)){"object"==typeof e[s][t]&&(e[s][t]=e[s][t].text);try{!function e(t,i,s){let l=i.split(".");1==l.length?t[i]=s:(t=t[l[0]],l.shift(),e(t,l.join("."),s))}(i,t,e[s][t])}catch(e){console.log("ERROR: Cannot merge. ",e.message||"",e)}i.w2ui&&delete i.w2ui.changes}}this.refresh()}save(e){var t=this.getChanges(),i=this.url?.save??this.url;let s=this.trigger("save",{target:this.name,changes:t});!0!==s.isCancelled&&(i?this.request("save",{changes:s.detail.changes},null,(t=>{t.error||this.mergeChanges(),s.finish(),"function"==typeof e&&e(t)})):(this.mergeChanges(),s.finish()))}editField(e,t,i,s){let n=this;if(!0===this.last.inEditMode)s&&13==s.keyCode?(({index:r,column:o,value:d}=this.last._edit),this.editChange({type:"custom",value:d},r,o,s),this.editDone(r,o,s)):0<(d=l(this.box).find("div.w2ui-edit-box .w2ui-input")).length&&("DIV"==d.get(0).tagName?(d.text(d.text()+i),a.setCursorPosition(d.get(0),d.text().length)):(d.val(d.val()+i),a.setCursorPosition(d.get(0),d.val().length)));else{let c=this.get(e,!0),u=this.getCellEditable(c,t);if(u&&!["checkbox","check"].includes(u.type)){let p=this.records[c],m=this.columns[t];var r=!0===m.frozen?"_f":"_";if(-1!=["enum","file"].indexOf(u.type))console.log('ERROR: input types "enum" and "file" are not supported in inline editing.');else{var o=this.trigger("editField",{target:this.name,recid:e,column:t,value:i,index:c,originalEvent:s});if(!0!==o.isCancelled){i=o.detail.value,this.last.inEditMode=!0,this.last.editColumn=t,this.last._edit={value:i,index:c,column:t,recid:e},this.selectNone(!0),this.select({recid:e,column:t});var d=l(this.box).find("#grid_"+this.name+r+"rec_"+a.escapeId(e));let g=d.find('[col="'+t+'"] > div'),f=(this.last._edit.tr=d,this.last._edit.div=g,l(this.box).find("div.w2ui-edit-box").remove(),"row"!=this.selectType&&(l(this.box).find("#grid_"+this.name+r+"selection").attr("id","grid_"+this.name+"_editable").removeClass("w2ui-selection").addClass("w2ui-edit-box").prepend('<div style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;"></div>').find(".w2ui-selection-resizer").remove(),g=l(this.box).find("#grid_"+this.name+"_editable > div:first-child")),u.attr=u.attr??"",u.text=u.text??"",u.style=u.style??"",u.items=u.items??[],null!=p.w2ui?.changes?.[m.field]?a.stripTags(p.w2ui.changes[m.field]):a.stripTags(n.parseField(p,m.field))),b="object"!=typeof(f=null==f?"":f)?f:"",v=(null!=o.detail.prevValue&&(b=o.detail.prevValue),null!=i&&(f=i),null!=m.style?m.style+";":"");"string"==typeof m.render&&["number","int","float","money","percent","size"].includes(m.render.split(":")[0])&&(v+="text-align: right;"),0<u.items.length&&!a.isPlainObject(u.items[0])&&(u.items=a.normMenu(u.items));let y,x=["date","time","datetime","color","list","combo"];function _(e){try{var t=getComputedStyle(e),i="DIV"==e.tagName.toUpperCase()?e.innerText:e.value,s=l(n.box).find("#grid_"+n.name+"_editable").get(0),r=`font-family: ${t["font-family"]}; font-size: ${t["font-size"]}; white-space: no-wrap;`,o=a.getStrWidth(i,r);o+20>s.clientWidth&&l(s).css("width",o+20+"px")}catch(e){}}r=`font-family: ${(s=getComputedStyle(d.find('[col="'+t+'"] > div').get(0)))["font-family"]}; font-size: ${s["font-size"]};`,"div"===u.type?(g.addClass("w2ui-editable").html(a.stripSpaces(`<div id="grid_${this.name}_edit_${e}_${t}" class="w2ui-input w2ui-focus"\n                        contenteditable autocorrect="off" autocomplete="off" spellcheck="false"\n                        style="${r+v+u.style}"\n                        field="${m.field}" recid="${e}" column="${t}" ${u.attr}>\n                    </div>`+u.text)),(y=g.find("div.w2ui-input").get(0)).innerText="object"!=typeof f?f:"",null!=i?a.setCursorPosition(y,y.innerText.length):a.setCursorPosition(y,0,y.innerText.length)):(g.addClass("w2ui-editable").html(a.stripSpaces(`<input id="grid_${this.name}_edit_${e}_${t}" class="w2ui-input"\n                        autocorrect="off" autocomplete="off" spellcheck="false" type="text"\n                        style="${r+v+u.style}"\n                        field="${m.field}" recid="${e}" column="${t}" ${u.attr}>`+u.text)),y=g.find("input").get(0),"number"==u.type&&(f=a.formatNumber(f)),"date"==u.type&&(f=a.formatDate(a.isDate(f,u.format,!0)||new Date,u.format)),y.value="object"!=typeof f?f:"",d=e=>{var t=this.last._edit?.escKey;let i=!1;var s=l(y).data("tooltipName");s&&null!=h.get(s[0])?.selected&&(i=!0),!this.last.inEditMode||t||!x.includes(u.type)||e.detail.overlay.anchor?.id!=this.last._edit.input?.id&&"list"!=u.type||(this.editChange(),this.editDone(void 0,void 0,{keyCode:i?13:0}))},new w(a.extend({},u,{el:y,selected:f,onSelect:d,onHide:d})),null==i&&y&&y.select()),Object.assign(this.last._edit,{input:y,edit:u}),l(y).off(".w2ui-editable").on("blur.w2ui-editable",(e=>{var i;this.last.inEditMode&&(i=this.last._edit.edit.type,l(y).data("tooltipName")&&x.includes(i)||!0===e.target._keepOpen?delete e.target._keepOpen:(this.editChange(y,c,t,e),this.editDone()))})).on("mousedown.w2ui-editable",(e=>{e.stopPropagation()})).on("click.w2ui-editable",(e=>{_.call(y,e)})).on("paste.w2ui-editable",(e=>{e.preventDefault(),e=e.clipboardData.getData("text/plain"),document.execCommand("insertHTML",!1,e)})).on("keyup.w2ui-editable",(e=>{_.call(y,e)})).on("keydown.w2ui-editable",(i=>{switch(i.keyCode){case 8:"list"!=u.type||y._w2field||i.preventDefault();break;case 9:case 13:i.preventDefault();break;case 27:var s=l(y).data("tooltipName");if(s&&0<s.length)return this.last._edit.escKey=!0,h.hide(s[0]),void i.preventDefault();i.stopPropagation()}setTimeout((()=>{switch(i.keyCode){case 9:var s=i.shiftKey?n.prevCell(c,t,!0):n.nextCell(c,t,!0);null!=s&&(a=n.records[s.index].recid,this.editChange(y,c,t,i),this.editDone(c,t,i),"row"!=n.selectType?(n.selectNone(!0),n.select({recid:a,column:s.colIndex})):n.editField(a,s.colIndex,null,i),i.preventDefault)&&i.preventDefault();break;case 13:{let e=!1;var a=l(y).data("tooltipName");a&&null!=h.get(a[0]).selected&&(e=!0),a&&e||!0===y._keepOpen?delete y._keepOpen:(this.editChange(y,c,t,i),this.editDone(c,t,i));break}case 27:{this.last._edit.escKey=!1;let s=n.parseField(p,m.field);null!=p.w2ui?.changes?.[m.field]&&(s=p.w2ui.changes[m.field]),null!=y._prevValue&&(s=y._prevValue),"DIV"==y.tagName?y.innerText=null!=s?s:"":y.value=null!=s?s:"",this.editDone(c,t,i),setTimeout((()=>{n.select({recid:e,column:t})}),1);break}}_(y)}),1)})),y&&(y._prevValue=b),"list"!=u.type&&setTimeout((()=>{this.last.inEditMode&&y&&(y.focus(),clearTimeout(this.last.kbd_timer),(y.resize=_)(y))}),50),o.finish({input:y})}}}}}editChange(e,t,i,s){e=e??this.last._edit.input,t=t??this.last._edit.index,i=i??this.last._edit.column,s=s??{};var l=(t<0?this.summary:this.records)[t=t<0?-t-1:t],n=this.columns[i];let r="DIV"==e?.tagName?e.innerText:e.value;var o=e._w2field,d=(o&&(null!=(r="list"==o.type?o.selected:r)&&0!==Object.keys(r).length||(r=""),a.isPlainObject(r)||(r=o.clean(r))),"checkbox"==e.type&&(!1===l.w2ui?.editable&&(e.checked=!e.checked),r=e.checked),this.parseField(l,n.field)),h=l.w2ui?.changes&&l.w2ui.changes.hasOwnProperty(n.field)?l.w2ui.changes[n.field]:d;let c={target:this.name,input:e,recid:l.recid,index:t,column:i,originalEvent:s,value:{new:r,previous:h,original:d}},u=(null!=s.target?._prevValue&&(c.value.previous=s.target._prevValue),0);for(;u<20;){if(u++,"object"!=typeof(r=c.value.new)&&String(d)!=String(r)||"object"==typeof r&&r&&r.id!=d&&("object"!=typeof d||null==d||r.id!=d.id)){if(!0!==(c=this.trigger("change",c)).isCancelled){if(r!==c.detail.value.new)continue;(""!==c.detail.value.new&&null!=c.detail.value.new||""!==h&&null!=h)&&(l.w2ui=l.w2ui??{},l.w2ui.changes=l.w2ui.changes??{},l.w2ui.changes[n.field]=c.detail.value.new),c.finish()}}else if(!0!==(c=this.trigger("restore",c)).isCancelled){if(r!==c.detail.value.new)continue;l.w2ui?.changes&&(delete l.w2ui.changes[n.field],0===Object.keys(l.w2ui.changes).length)&&delete l.w2ui.changes,c.finish()}break}}editDone(e,t,i){if(e=e??this.last._edit.index,t=t??this.last._edit.column,i=i??{},this.advanceOnEdit&&13==i.keyCode){let s=i.shiftKey?this.prevRow(e,t,1):this.nextRow(e,t,1);null==s&&(s=e),setTimeout((()=>{"row"!=this.selectType?(this.selectNone(!0),this.select({recid:this.records[s].recid,column:t})):this.editField(this.records[s].recid,t,null,i)}),1)}var s=e<0,n=l(this.last._edit?.tr).find('[col="'+t+'"]'),a=this.records[e],r=this.columns[t];this.last.inEditMode=!1,this.last._edit=null,s||(null!=a.w2ui?.changes?.[r.field]?n.addClass("w2ui-changed"):n.removeClass("w2ui-changed"),n.replace(this.getCellHTML(e,t,s))),l(this.box).find("div.w2ui-edit-box").remove(),this.updateToolbar(),setTimeout((()=>{var e=l(this.box).find(`#grid_${this.name}_focus`).get(0);document.activeElement===e||this.last.inEditMode||e.focus()}),10)}delete(e){var t=this.trigger("delete",{target:this.name,force:e});if(e&&this.message(),!0!==t.isCancelled){e=t.detail.force;var i=this.getSelection();if(0!==i.length)if(""==this.msgDelete||e){if("object"!=typeof this.url?this.url:this.url.remove)this.request("delete");else if("object"!=typeof i[0])this.selectNone(),this.remove.apply(this,i);else{for(let e=0;e<i.length;e++){var s=this.columns[i[e].column].field,l=this.get(i[e].recid,!0),n=this.records[l];null!=l&&"recid"!=s&&(this.records[l][s]="",n.w2ui?.changes)&&delete n.w2ui.changes[s]}this.update()}t.finish()}else this.confirm({text:a.lang(this.msgDelete,{count:i.length,records:a.lang(1==i.length?"record":"records")}),width:380,height:170,yes_text:a.lang("Delete"),yes_class:"w2ui-btn-red",no_text:a.lang("Cancel")}).yes((e=>{e.detail.self.close(),this.delete(!0)})).no((e=>{e.detail.self.close()}))}}click(e,t){var i=Date.now();let s=null;if(!(1==this.last.cancelClick||t&&t.altKey))if("object"==typeof e&&null!==e&&(s=e.column,e=e.recid),null==t&&(t={}),i-parseInt(this.last.click_time)<350&&this.last.click_recid==e&&"click"==t.type)this.dblClick(e,t);else{if(this.last.bubbleEl&&(this.last.bubbleEl=null),this.last.click_time=i,i=this.last.click_recid,this.last.click_recid=e,null==s&&t.target){let e=t.target;"TD"!=e.tagName&&(e=l(e).closest("td")[0]),null!=l(e).attr("col")&&(s=parseInt(l(e).attr("col")))}var n=this.trigger("click",{target:this.name,recid:e,column:s,originalEvent:t});if(!0!==n.isCancelled){var a=this.getSelection(),r=(l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.get(e,!0)),o=[];let c,u,p,m;if(this.last.sel_ind=r,this.last.sel_col=s,this.last.sel_recid=e,this.last.sel_type="click",t.shiftKey&&0<a.length&&this.multiSelect){if(a[0].recid){c=this.get(a[0].recid,!0),u=this.get(e,!0),m=s>a[0].column?(p=a[0].column,s):(p=s,a[0].column);for(let e=p;e<=m;e++)o.push(e)}else c=this.get(i,!0),u=this.get(e,!0);var d=[],h=(c>u&&(i=c,c=u,u=i),this.url?.get?this.url.get:this.url);for(let e=c;e<=u;e++)if(!(0<this.searchData.length)||h||this.last.searchIds.includes(e))if("row"==this.selectType)d.push(this.records[e].recid);else for(let t=0;t<o.length;t++)d.push({recid:this.records[e].recid,column:o[t]});this.select(d)}else{let n=-1!=(i=this.last.selection).indexes.indexOf(r),o=!1;l(t.target).closest("td").hasClass("w2ui-col-select")&&(o=!0),(t.ctrlKey||t.shiftKey||t.metaKey||o)&&this.multiSelect||this.showSelectColumn?!0===(n="row"==this.selectType&&n)?this.unselect({recid:e,column:s}):this.select({recid:e,column:s}):!0===(n=!("row"!=this.selectType&&!i.columns[r]?.includes(s))&&n)&&1==a.length?this.unselect({recid:e,column:s}):(this.selectNone(!0),this.select({recid:e,column:s}))}this.status(),this.initResize(),n.finish()}}}columnClick(e,t){if(!0!==this.last.colResizing){let n=this.trigger("columnClick",{target:this.name,field:e,originalEvent:t});if(!0!==n.isCancelled){if("row"==this.selectType)(i=this.getColumn(e))&&i.sortable&&this.sort(e,null,!(!t||!(t.ctrlKey||t.metaKey||t.shiftKey))),"line-number"==n.detail.field&&(this.getSelection().length>=this.records.length?this.selectNone():this.selectAll());else if(t.altKey&&(i=this.getColumn(e))&&i.sortable&&this.sort(e,null,!(!t||!(t.ctrlKey||t.metaKey||t.shiftKey))),"line-number"==n.detail.field)this.getSelection().length>=this.records.length?this.selectNone():this.selectAll();else{t.shiftKey||t.metaKey||t.ctrlKey||this.selectNone(!0);var i=this.getSelection(),s=(e=this.getColumn(n.detail.field,!0),[]),l=[];if(0!=i.length&&t.shiftKey){let t=e,s=i[0].column;t>s&&(t=i[0].column,s=e);for(let e=t;e<=s;e++)l.push(e)}else l.push(e);if(!0!==(n=this.trigger("columnSelect",{target:this.name,columns:l})).isCancelled){for(let e=0;e<this.records.length;e++)s.push({recid:this.records[e].recid,column:l});this.select(s)}n.finish()}n.finish()}}}columnDblClick(e,t){!0!==(e=this.trigger("columnDblClick",{target:this.name,field:e,originalEvent:t})).isCancelled&&e.finish()}columnContextMenu(e,t){!0!==(e=this.trigger("columnContextMenu",{target:this.name,field:e,originalEvent:t})).isCancelled&&(this.show.columnMenu&&(c.show({type:"check",contextMenu:!0,originalEvent:t,items:this.initColumnOnOff()}).then((()=>{l("#w2overlay-context-menu .w2ui-grid-skip").off(".w2ui-grid").on("click.w2ui-grid",(e=>{e.stopPropagation()})).on("keypress",(e=>{13==e.keyCode&&(this.skip(e.target.value),this.toolbar.click("w2ui-column-on-off"))}))})).select((e=>{var t=e.detail.item.id;["w2ui-stateSave","w2ui-stateReset"].includes(t)?this[t.substring(5)]():"w2ui-skip"!=t&&this.columnOnOff(e,e.detail.item.id),clearTimeout(this.last.kbd_timer)})),clearTimeout(this.last.kbd_timer)),t.preventDefault(),e.finish())}columnAutoSize(e){if(0==arguments.length)this.columns.forEach(((e,t)=>this.columnAutoSize(t)));else{var t=this.columns[e],i=l(`#grid_${this.name}_column_${e} .w2ui-col-header`)[0];if(!1===t.autoResize||!0===t.hidden||!i)return!0;var s=getComputedStyle(i);let n=a.getStrWidth(i.innerHTML,`font-family: ${s.fontFamily}; font-size: `+s.fontSize,!0)+parseFloat(s.paddingLeft)+parseFloat(s.paddingRight)+4;l(this.box).find(`.w2ui-grid-records td[col="${e}"] > div`,this.box).each((e=>{var t=getComputedStyle(e);e=a.getStrWidth(e.innerHTML,`font-family: ${t.fontFamily}; font-size: `+t.fontSize,!0)+parseFloat(t.paddingLeft)+parseFloat(t.paddingRight)+4,n<e&&(n=e)})),!0!==(i=this.trigger("columnAutoResize",{maxWidth:n,originalEvent:event,target:this.name,column:t})).isCancelled&&(0<n&&(null==t.sizeOriginal&&(t.sizeOriginal=t.size),t.size=Math.min(Math.abs(n),t.max||1/0)+"px",this.resizeRecords(),this.resizeRecords(),this.scroll()),i.finish())}}columnAutoSizeAll(){this.columns.forEach(((e,t)=>this.columnAutoSize(t)))}focus(e){if(!0===(e=this.trigger("focus",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!0,l(this.box).removeClass("w2ui-inactive").find(".w2ui-inactive").removeClass("w2ui-inactive"),setTimeout((()=>{var e=l(this.box).find(`#grid_${this.name}_focus`).get(0);e&&document.activeElement!=e&&e.focus()}),10),e.finish()}blur(e){if(!0===(e=this.trigger("blur",{target:this.name,originalEvent:e})).isCancelled)return!1;this.hasFocus=!1,l(this.box).addClass("w2ui-inactive").find(".w2ui-selected").addClass("w2ui-inactive"),l(this.box).find(".w2ui-selection").addClass("w2ui-inactive"),e.finish()}keydown(e){let t=this,i="object"!=typeof this.url?this.url:this.url.get;if(!0===t.keyboard){var s=t.trigger("keydown",{target:t.name,originalEvent:e});if(!0!==s.isCancelled)if(0<l(this.box).find(".w2ui-message").length)27==e.keyCode&&this.message();else{let d=!1,h=l(t.box).find("#grid_"+t.name+"_records"),c=t.getSelection(),u=(0===c.length&&(d=!0),c[0]||null),p=[],m=c[c.length-1];if("object"==typeof u&&null!=u){u=c[0].recid,p=[];let S=0;for(;c[S]&&c[S].recid==u;)p.push(c[S].column),S++;m=c[c.length-1].recid}let g=t.get(u,!0),f=t.get(m,!0),b=l(t.box).find(`#grid_${t.name}_rec_`+(null!=g?a.escapeId(t.records[g].recid):"none"));var n,r=Math.floor(h[0].clientHeight/t.recordHeight);let v=!1,y=e.keyCode,w=e.shiftKey;switch(y){case 8:case 46:t.delete(),v=!0,e.stopPropagation();break;case 27:t.last.move?.type?(delete t.last.move,t.removeRange("selection-preview"),t.removeRange("selection-expand")):t.selectNone(),v=!0;break;case 65:(e.metaKey||e.ctrlKey)&&(t.selectAll(),v=!0);break;case 13:if("row"==this.selectType&&!0===t.show.expandColumn){if(b.length<=0)break;t.toggle(u,e),v=!0}else{for(let E=0;E<this.columns.length;E++)if(this.getCellEditable(g,E)){p.push(parseInt(E));break}0<(p="row"==this.selectType&&this.last._edit&&this.last._edit.column?[this.last._edit.column]:p).length&&(t.editField(u,p[0]??this.last.editColumn,null,e),v=!0)}break;case 37:!function(){if(d)k();else{if("row"==t.selectType){if(b.length<=0)return;var i=t.records[g].w2ui||{};!i||null==i.parent_recid||Array.isArray(i.children)&&0!==i.children.length&&i.expanded?t.collapse(u,e):(t.unselect(u),t.collapse(i.parent_recid,e),t.select(i.parent_recid))}else{let i=t.prevCell(g,p[0]);if(i=i?.index!=g?null:i?.colIndex,w||null!=i||(t.selectNone(!0),i=0),null!=i)if(w&&t.multiSelect){if(C())return;var s=[],l=[],n=[];if(0===p.indexOf(t.last.sel_col)&&1<p.length){for(let e=0;e<c.length;e++)-1==s.indexOf(c[e].recid)&&s.push(c[e].recid),n.push({recid:c[e].recid,column:p[p.length-1]});t.unselect(n),t.scrollIntoView(g,p[p.length-1],!0)}else{for(let e=0;e<c.length;e++)-1==s.indexOf(c[e].recid)&&s.push(c[e].recid),l.push({recid:c[e].recid,column:i});t.select(l),t.scrollIntoView(g,i,!0)}}else t.click({recid:u,column:i},e),t.scrollIntoView(g,i,!0);else w||t.selectNone(!0)}v=!0}}();break;case 39:!function(){if(d)k();else{if("row"==t.selectType){if(b.length<=0)return;t.expand(u,e)}else{let n=t.nextCell(g,p[p.length-1]);if(n=n.index!=g?null:n.colIndex,w||null!=n||(t.selectNone(!0),n=t.columns.length-1),null!=n)if(w&&39==y&&t.multiSelect){if(C())return;var i=[],s=[],l=[];if(p.indexOf(t.last.sel_col)==p.length-1&&1<p.length){for(let e=0;e<c.length;e++)-1==i.indexOf(c[e].recid)&&i.push(c[e].recid),l.push({recid:c[e].recid,column:p[0]});t.unselect(l),t.scrollIntoView(g,p[0],!0)}else{for(let e=0;e<c.length;e++)-1==i.indexOf(c[e].recid)&&i.push(c[e].recid),s.push({recid:c[e].recid,column:n});t.select(s),t.scrollIntoView(g,n,!0)}}else t.click({recid:u,column:n},e),t.scrollIntoView(g,n,!0);else w||t.selectNone(!0)}v=!0}}();break;case 33:x(r);break;case 34:_(r);break;case 35:_(-1);break;case 36:x(-1);break;case 38:x(e.metaKey||e.ctrlKey?-1:1);break;case 40:_(e.metaKey||e.ctrlKey?-1:1);break;case 17:case 91:d||a.isSafari&&(t.last.copy_event=t.copy(!1,e),(n=l(t.box).find("#grid_"+t.name+"_focus")).val(t.last.copy_event.detail.text),n[0].select());break;case 67:(e.metaKey||e.ctrlKey)&&(a.isSafari||(t.last.copy_event=t.copy(!1,e),(n=l(t.box).find("#grid_"+t.name+"_focus")).val(t.last.copy_event.detail.text),n[0].select()),t.copy(t.last.copy_event,e));break;case 88:d||(e.ctrlKey||e.metaKey)&&(a.isSafari||(t.last.copy_event=t.copy(!1,e),(n=l(t.box).find("#grid_"+t.name+"_focus")).val(t.last.copy_event.detail.text),n[0].select()),t.copy(t.last.copy_event,e))}var o=[32,187,189,192,219,220,221,186,222,188,190,191];for(let $=48;$<=111;$++)o.push($);function x(s){if(d&&k(),!(b.length<=0)){let a=t.prevRow(g,"row"==t.selectType?0:c[0].column,s);if(null!=(a=w||null!=a?a:0==t.searchData.length||i?0:t.last.searchIds[0])){if(w&&t.multiSelect){if(C())return;if("row"==t.selectType)t.last.sel_ind>a&&t.last.sel_ind!=f?t.unselect(t.records[f].recid):t.select(t.records[a].recid);else if(t.last.sel_ind>a&&t.last.sel_ind!=f){a=f;var l=[];for(let e=0;e<p.length;e++)l.push({recid:t.records[a].recid,column:p[e]});t.unselect(l)}else{var n=[];for(let e=0;e<p.length;e++)n.push({recid:t.records[a].recid,column:p[e]});t.select(n)}}else t.selectNone(!0),t.click({recid:t.records[a].recid,column:p[0]},e);t.scrollIntoView(a,null,!0,1!=s),e.preventDefault&&e.preventDefault()}else w||t.selectNone(!0)}}function _(s){if(d&&k(),!(b.length<=0)){let a=t.nextRow(f,"row"==t.selectType?0:c[0].column,s);if(null!=(a=w||null!=a?a:0==t.searchData.length||i?t.records.length-1:t.last.searchIds[t.last.searchIds.length-1])){if(w&&t.multiSelect){if(C())return;if("row"==t.selectType)t.last.sel_ind<a&&t.last.sel_ind!=g?t.unselect(t.records[g].recid):t.select(t.records[a].recid);else if(t.last.sel_ind<a&&t.last.sel_ind!=g){a=g;var l=[];for(let e=0;e<p.length;e++)l.push({recid:t.records[a].recid,column:p[e]});t.unselect(l)}else{var n=[];for(let e=0;e<p.length;e++)n.push({recid:t.records[a].recid,column:p[e]});t.select(n)}}else t.selectNone(!0),t.click({recid:t.records[a].recid,column:p[0]},e);t.scrollIntoView(a,null,!0,1!=s),v=!0}else w||t.selectNone(!0)}}function k(){if(t.records&&0!==t.records.length){let e=Math.floor(h[0].scrollTop/t.recordHeight)+1;(!t.records[e]||e<2)&&(e=0),void 0!==t.records[e]&&t.select({recid:t.records[e].recid,column:0})}}function C(){if("click"==t.last.sel_type){if("row"==t.selectType)return t.last.sel_type="key",1<c.length&&(c.splice(c.indexOf(t.records[t.last.sel_ind].recid),1),t.unselect(c),1);if(t.last.sel_type="key",1<c.length){for(let e=0;e<c.length;e++)if(c[e].recid==t.last.sel_recid&&c[e].column==t.last.sel_col){c.splice(e,1);break}return t.unselect(c),1}}}-1==o.indexOf(y)||e.ctrlKey||e.metaKey||v||(0===p.length&&p.push(0),v=!1,setTimeout((()=>{var i=l(t.box).find("#grid_"+t.name+"_focus"),s=i.val();i.val(""),t.editField(u,p[0],s,e)}),1)),v&&e.preventDefault&&e.preventDefault(),s.finish()}}}scrollIntoView(e,t,i,s){let n=this.records.length;if(0!==(n=0==this.searchData.length||this.url?n:this.last.searchIds.length)){if(null==e){if(0===(r=this.getSelection()).length)return;a.isPlainObject(r[0])?(e=r[0].index,t=r[0].column):e=this.get(r[0],!0)}var r,o=(r=l(this.box).find(`#grid_${this.name}_records`))[0].clientWidth,d=r[0].clientHeight,h=r[0].scrollTop,c=r[0].scrollLeft,u=this.last.searchIds.length;if(0<u&&(e=this.last.searchIds.indexOf(e)),r.css({"scroll-behavior":i?"auto":"smooth"}),d<this.recordHeight*(0<u?u:n)&&0<r.length&&(u=(i=Math.floor(h/this.recordHeight))+Math.floor(d/this.recordHeight),e==i&&r.prop("scrollTop",h-d/1.3),e==u&&r.prop("scrollTop",h+d/1.3),(e<i||u<e)&&r.prop("scrollTop",(e-1)*this.recordHeight),!0===s)&&r.prop("scrollTop",e*this.recordHeight),null!=t){let e=0,i=0;h=a.scrollBarSize();for(let s=0;s<=t;s++){var p=this.columns[s];p.frozen||p.hidden||(e=i,i+=parseInt(p.sizeCalculated))}o<i-c?r.prop("scrollLeft",e-h):e<c&&r.prop("scrollLeft",i-o+2*h)}}}scrollToColumn(e){if(null!=e){let i=0,s=!1;for(let l=0;l<this.columns.length;l++){var t=this.columns[l];if(t.field==e){s=!0;break}t.frozen||t.hidden||(i+=t=parseInt(t.sizeCalculated||t.size))}s&&(this.last.vscroll.scrollLeft=i+1,this.scroll())}}dblClick(e,t){let i=null;if("object"==typeof e&&null!==e&&(i=e.column,e=e.recid),null==t&&(t={}),null==i&&t.target){let e=t.target;"TD"!=e.tagName.toUpperCase()&&(e=l(e).closest("td")[0]),i=parseInt(l(e).attr("col"))}var s=this.get(e,!0),n=this.records[s],a=this.trigger("dblClick",{target:this.name,recid:e,column:i,originalEvent:t});!0!==a.isCancelled&&(this.selectNone(!0),this.getCellEditable(s,i)?this.editField(e,i,null,t):(this.select({recid:e,column:i}),(this.show.expandColumn||n&&n.w2ui&&Array.isArray(n.w2ui.children))&&this.toggle(e)),a.finish())}showContextMenu(e,t,i){if("text"!=this.last.userSelect){null==(i=null==i?{offsetX:0,offsetY:0,target:l(this.box).find(`#grid_${this.name}_rec_`+e)[0]}:i).offsetX&&(i.offsetX=i.layerX-i.target.offsetLeft,i.offsetY=i.layerY-i.target.offsetTop);var s=this.getSelection();if("row"==this.selectType)-1==s.indexOf(e)&&this.click(e);else{let l=!1;for(let i=0;i<s.length;i++)s[i].recid!=e&&s[i].column!=t||(l=!0);l||null==e||this.click({recid:e,column:t}),l||null==t||this.columnClick(this.columns[t].field,i)}var n=this.trigger("contextMenu",{target:this.name,originalEvent:i,recid:e,column:t});!0!==n.isCancelled&&(0<this.contextMenu?.length&&c.show({contextMenu:!0,originalEvent:i,items:this.contextMenu}).select((i=>{clearTimeout(this.last.kbd_timer),this.contextMenuClick(e,t,i)})),i.preventDefault(),clearTimeout(this.last.kbd_timer),n.finish())}}contextMenuClick(e,t,i){!0!==(e=this.trigger("contextMenuClick",{target:this.name,recid:e,column:t,originalEvent:i.detail.originalEvent,menuEvent:i,menuIndex:i.detail.index,menuItem:i.detail.item})).isCancelled&&e.finish()}toggle(e){var t=this.get(e);if(null!=t)return t.w2ui=t.w2ui??{},!0===t.w2ui.expanded?this.collapse(e):this.expand(e)}expand(e,t){var i=this.get(e,!0);let s=this.records[i];s.w2ui=s.w2ui??{};var n=a.escapeId(e),r=s.w2ui.children;let o;if(Array.isArray(r)){if(!0===s.w2ui.expanded||0===r.length)return!1;if(!0===(o=this.trigger("expand",{target:this.name,recid:e})).isCancelled)return!1;s.w2ui.expanded=!0,r.forEach((e=>{e.w2ui=e.w2ui??{},e.w2ui.parent_recid=s.recid,null==e.w2ui.children&&(e.w2ui.children=[])})),this.records.splice.apply(this.records,[i+1,0].concat(r)),-1!==this.total&&(this.total+=r.length),("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(!0,!0),0<this.searchData.length&&this.localSearch(!0)),!0!==t&&this.refresh(),o.finish()}else{if(0<l(this.box).find("#grid_"+this.name+"_rec_"+n+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if("none"==s.w2ui.expanded)return!1;if(l(this.box).find("#grid_"+this.name+"_rec_"+n).after(`<tr id="grid_${this.name}_rec_${e}_expanded_row" class="w2ui-expanded-row">\n                    <td colspan="100" class="w2ui-expanded2">\n                        <div id="grid_${this.name}_rec_${e}_expanded"></div>\n                    </td>\n                    <td class="w2ui-grid-data-last"></td>\n                </tr>`),l(this.box).find("#grid_"+this.name+"_frec_"+n).after(`<tr id="grid_${this.name}_frec_${e}_expanded_row" class="w2ui-expanded-row">\n                    ${this.show.lineNumbers?'<td class="w2ui-col-number"></td>':""}\n                    <td class="w2ui-grid-data w2ui-expanded1" colspan="100">\n                       <div id="grid_${this.name}_frec_${e}_expanded"></div>\n                    </td>\n                </tr>`),!0===(o=this.trigger("expand",{target:this.name,recid:e,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"})).isCancelled)return l(this.box).find("#grid_"+this.name+"_rec_"+n+"_expanded_row").remove(),l(this.box).find("#grid_"+this.name+"_frec_"+n+"_expanded_row").remove(),!1;i=l(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded"),r=l(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded"),t=i.find(":scope div:first-child")[0]?.clientHeight??50,i[0].clientHeight<t&&i.css({height:t+"px"}),r[0].clientHeight<t&&r.css({height:t+"px"}),l(this.box).find("#grid_"+this.name+"_rec_"+n).attr("expanded","yes").addClass("w2ui-expanded"),l(this.box).find("#grid_"+this.name+"_frec_"+n).attr("expanded","yes").addClass("w2ui-expanded"),l(this.box).find("#grid_"+this.name+"_cell_"+this.get(e,!0)+"_expand div").html("-"),s.w2ui.expanded=!0,o.finish(),this.resizeRecords()}return!0}collapse(e,t){var i=this.get(e,!0);let s=this.records[i],n=(s.w2ui=s.w2ui||{},a.escapeId(e));var r=s.w2ui.children;let o;if(Array.isArray(r)){if(!0!==s.w2ui.expanded)return!1;if(!0===(o=this.trigger("collapse",{target:this.name,recid:e})).isCancelled)return!1;!function e(t){t.w2ui.expanded=!1;for(let i=0;i<t.w2ui.children.length;i++){let s=t.w2ui.children[i];s.w2ui.expanded&&e(s)}}(s);var d=[];for(let e=s;null!=e;e=this.get(e.w2ui.parent_recid))d.push(e.w2ui.parent_recid);let l=r=i+1;for(;!(this.records.length<=l+1||null==this.records[l+1].w2ui||0<=d.indexOf(this.records[l+1].w2ui.parent_recid));)l++;this.records.splice(r,l-r+1),-1!==this.total&&(this.total-=l-r+1),("object"!=typeof this.url?this.url:this.url.get)||0<this.searchData.length&&this.localSearch(!0),!0!==t&&this.refresh(),o.finish()}else{if(0===l(this.box).find("#grid_"+this.name+"_rec_"+n+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if(!0===(o=this.trigger("collapse",{target:this.name,recid:e,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"})).isCancelled)return!1;l(this.box).find("#grid_"+this.name+"_rec_"+n).removeAttr("expanded").removeClass("w2ui-expanded"),l(this.box).find("#grid_"+this.name+"_frec_"+n).removeAttr("expanded").removeClass("w2ui-expanded"),l(this.box).find("#grid_"+this.name+"_cell_"+this.get(e,!0)+"_expand div").html("+"),l(this.box).find("#grid_"+this.name+"_rec_"+n+"_expanded").css("height","0px"),l(this.box).find("#grid_"+this.name+"_frec_"+n+"_expanded").css("height","0px"),setTimeout((()=>{l(this.box).find("#grid_"+this.name+"_rec_"+n+"_expanded_row").remove(),l(this.box).find("#grid_"+this.name+"_frec_"+n+"_expanded_row").remove(),s.w2ui.expanded=!1,o.finish(),this.resizeRecords()}),300)}return!0}sort(e,t,i){var s=this.trigger("sort",{target:this.name,field:e,direction:t,multiField:i});if(!0!==s.isCancelled){if(null!=e){let s=this.sortData.length;for(let t=0;t<this.sortData.length;t++)if(this.sortData[t].field==e){s=t;break}if(null==t)if(null==(t=this.sortData[s]?.direction))null==this.last.originalSort&&(this.last.originalSort=this.records.map((e=>e.recid))),t="asc";else switch(t.toLowerCase()){case"asc":t="desc";break;case"desc":t="";break;default:t="asc"}1!=i&&(this.sortData=[],s=0),""===t?this.sortData.splice(s,1):(this.sortData[s]??={},Object.assign(this.sortData[s],{field:e,direction:t}))}else this.sortData=[];("object"!=typeof this.url?this.url:this.url.get)?(s.finish({direction:t}),this.last.fetch.offset=0,this.reload()):(this.localSort(!1,!0),0<this.searchData.length&&this.localSearch(!0),this.last.vscroll.scrollTop=0,l(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),s.finish({direction:t}),this.refresh())}}copy(e,t){if(a.isPlainObject(e))return e.finish(),e.text;var i=this.getSelection();if(0===i.length)return"";let s,l="";if("object"==typeof i[0]){let e=i[0].column,t=i[0].column;var n=[];for(let s=0;s<i.length;s++)i[s].column<e&&(e=i[s].column),i[s].column>t&&(t=i[s].column),-1==n.indexOf(i[s].index)&&n.push(i[s].index);n.sort(((e,t)=>e-t));for(let i=0;i<n.length;i++){var r=n[i];for(let i=e;i<=t;i++)!0!==this.columns[i].hidden&&(l+=this.getCellCopy(r,i)+"\t");l=l.substr(0,l.length-1),l+="\n"}}else{for(let e=0;e<this.columns.length;e++){var o=this.columns[e];if(!0!==o.hidden){let e=o.text||o.field;o.text&&o.text.length<3&&o.tooltip&&(e=o.tooltip),l+='"'+a.stripTags(e)+'"\t'}}l=l.substr(0,l.length-1),l+="\n";for(let e=0;e<i.length;e++){var d=this.get(i[e],!0);for(let e=0;e<this.columns.length;e++)!0!==this.columns[e].hidden&&(l+='"'+this.getCellCopy(d,e)+'"\t');l=l.substr(0,l.length-1),l+="\n"}}return l=l.substr(0,l.length-1),null==e?!0===(s=this.trigger("copy",{target:this.name,text:l,cut:88==t.keyCode,originalEvent:t})).isCancelled?"":(l=s.detail.text,s.finish(),l):!1===e?!0===(s=this.trigger("copy",{target:this.name,text:l,cut:88==t.keyCode,originalEvent:t})).isCancelled?"":(l=s.detail.text,s):void 0}getCellCopy(e,t){return a.stripTags(this.getCellHTML(e,t))}paste(e,t){var i=this.getSelection();let s=this.get(i[0].recid,!0);var l,n,a,r=i[0].column;if(!0!==(t=this.trigger("paste",{target:this.name,text:e,index:s,column:r,originalEvent:t})).isCancelled){if(e=t.detail.text,"row"==this.selectType||0===i.length)console.log("ERROR: You can paste only if grid.selectType = 'cell' and when at least one cell selected.");else{if("object"!=typeof e){var o=[];e=e.split("\n");for(let t=0;t<e.length;t++){var d=e[t].split("\t");let i=0;var h=this.records[s],c=[];if(null!=h){for(let e=0;e<d.length;e++)this.columns[r+i]&&(l=h,n=this.columns[r+i].field,a=d[e],l.w2ui=l.w2ui??{},l.w2ui.changes=l.w2ui.changes||{},l.w2ui.changes[n]=a,c.push(r+i),i++);for(let e=0;e<c.length;e++)o.push({recid:h.recid,column:c[e]});s++}}this.selectNone(!0),this.select(o)}else this.selectNone(!0),this.select([{recid:this.records[s],column:r}]);this.refresh()}t.finish()}}resize(){var e=Date.now();if(this.box&&l(this.box).attr("name")==this.name){var t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled)return null!=this.box&&(this.resizeBoxes(),this.resizeRecords()),t.finish(),Date.now()-e}}update({cells:e,fullCellRefresh:t,ignoreColumns:i}={}){var s=Date.now();let n=this;if(null==this.box)return 0;if(Array.isArray(e))for(let t=0;t<e.length;t++){var r=e[t].index,o=e[t].column;if(!(r<0))if(null==r||null==o)console.log("ERROR: Wrong argument for grid.update({ cells }), cells should be [{ index: X, column: Y }, ...]");else{var d=this.records[r]??{};d.w2ui=d.w2ui??{},d.w2ui._update=d.w2ui._update??{cells:[]};let e=d.w2ui._update.row1,t=d.w2ui._update.row2;null!=e&&e.isConnected&&null!=t&&t.isColSelected||(e=this.box.querySelector(`#grid_${this.name}_rec_`+a.escapeId(d.recid)),t=this.box.querySelector(`#grid_${this.name}_frec_`+a.escapeId(d.recid)),d.w2ui._update.row1=e,d.w2ui._update.row2=t),c(d,e,t,r,o)}}else for(let e=this.last.vscroll.recIndStart-1;e<=this.last.vscroll.recIndEnd;e++){let t=e;t=0<this.last.searchIds.length?this.last.searchIds[e]:e;var h=this.records[t];if(!(t<0||null==h)){h.w2ui=h.w2ui??{},h.w2ui._update=h.w2ui._update??{cells:[]};let e=h.w2ui._update.row1,i=h.w2ui._update.row2;null!=e&&e.isConnected&&null!=i&&i.isColSelected||(e=this.box.querySelector(`#grid_${this.name}_rec_`+a.escapeId(h.recid)),i=this.box.querySelector(`#grid_${this.name}_frec_`+a.escapeId(h.recid)),h.w2ui._update.row1=e,h.w2ui._update.row2=i);for(let s=0;s<this.columns.length;s++)c(h,e,i,t,s)}}return Date.now()-s;function c(e,s,r,o,d){var h=n.columns[d];if(!Array.isArray(i)||!i.includes(d)&&!i.includes(h.field)){let i=e.w2ui._update.cells[d];if(null!=i&&i.isConnected||(i=n.box.querySelector(`#grid_${n.name}_data_${o}_`+d),e.w2ui._update.cells[d]=i),null!=i){if(t)l(i).replace(n.getCellHTML(o,d,!1)),i=n.box.querySelector(`#grid_${n.name}_data_${o}_`+d),e.w2ui._update.cells[d]=i;else{var c=i.children[0],{value:o,style:u,className:p}=n.getCellValue(o,d,!1,!0);if(c.innerHTML!=o&&(c.innerHTML=o),""!=u&&i.style.cssText!=u&&(i.style.cssText=u),""!=p){let e=["w2ui-grid-data"],t=[];c=p.split(" ").filter((e=>!!e)),i.classList.forEach((i=>{e.includes(i)||t.push(i)})),i.classList.remove(...t),i.classList.add(...c)}}if(n.columns[d].style&&n.columns[d].style!=i.style.cssText&&(i.style.cssText=n.columns[d].style??""),null!=e.w2ui.class){if("string"==typeof e.w2ui.class){let t=["w2ui-odd","w2ui-even","w2ui-record"],i=[];o=e.w2ui.class.split(" ").filter((e=>!!e)),s&&r&&(s.classList.forEach((e=>{t.includes(e)||i.push(e)})),s.classList.remove(...i),s.classList.add(...o),r.classList.remove(...i),r.classList.add(...o))}if(a.isPlainObject(e.w2ui.class)&&"string"==typeof e.w2ui.class[h.field]){let t=["w2ui-grid-data"],s=[];u=e.w2ui.class[h.field].split(" ").filter((e=>!!e)),i.classList.forEach((e=>{t.includes(e)||s.push(e)})),i.classList.remove(...s),i.classList.add(...u)}}null!=e.w2ui.style&&(s&&r&&"string"==typeof e.w2ui.style&&s.style.cssText!==e.w2ui.style&&(s.style.cssText="height: "+n.recordHeight+"px;"+e.w2ui.style,s.setAttribute("custom_style",e.w2ui.style),r.style.cssText="height: "+n.recordHeight+"px;"+e.w2ui.style,r.setAttribute("custom_style",e.w2ui.style)),a.isPlainObject(e.w2ui.style))&&"string"==typeof e.w2ui.style[h.field]&&i.style.cssText!==e.w2ui.style[h.field]&&(i.style.cssText=e.w2ui.style[h.field])}}}}refreshCell(e,t){var i=this.get(e,!0),s=(t=this.getColumn(t,!0),e=!this.records[i]||this.records[i].recid!=e,l(this.box).find(`${e?".w2ui-grid-summary ":""}#grid_${this.name}_data_${i}_`+t));return 0!=s.length&&(s.replace(this.getCellHTML(i,t,e)),!0)}refreshRow(e,t=null){let i=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(e)),s=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(e));if(0<i.length){null==t&&(t=this.get(e,!0));var n=i.attr("line"),r=!this.records[t]||this.records[t].recid!=e,o="object"!=typeof this.url?this.url:this.url.get;if(0<this.searchData.length&&!o)for(let e=0;e<this.last.searchIds.length;e++)this.last.searchIds[e]==t&&(t=e);o=this.getRecordHTML(t,n,r),i.replace(o[0]),s.replace(o[1]);let d=this.records[t].w2ui?this.records[t].w2ui.style:"";return"string"==typeof d&&(i=l(this.box).find("#grid_"+this.name+"_frec_"+a.escapeId(e)),s=l(this.box).find("#grid_"+this.name+"_rec_"+a.escapeId(e)),i.attr("custom_style",d),s.attr("custom_style",d),i.hasClass("w2ui-selected")&&(d=d.replace("background-color","none")),i[0].style.cssText="height: "+this.recordHeight+"px;"+d,s[0].style.cssText="height: "+this.recordHeight+"px;"+d),r&&this.resize(),!0}return!1}refresh(){var e=Date.now(),t="object"!=typeof this.url?this.url:this.url.get;if(this.total<=0&&!t&&0===this.searchData.length&&(this.total=this.records.length),this.box&&!0!==(t=this.trigger("refresh",{target:this.name})).isCancelled){this.show.header?l(this.box).find(`#grid_${this.name}_header`).html(a.lang(this.header)+"&#160;").show():l(this.box).find(`#grid_${this.name}_header`).hide(),this.show.toolbar?l(this.box).find("#grid_"+this.name+"_toolbar").show():l(this.box).find("#grid_"+this.name+"_toolbar").hide(),this.searchClose();var i=l(this.box).find("#grid_"+this.name+"_search_all");!this.multiSearch&&"all"==this.last.field&&0<this.searches.length&&(this.last.field=this.searches[0].field,this.last.label=this.searches[0].label);for(let e=0;e<this.searches.length;e++)this.searches[e].field==this.last.field&&(this.last.label=this.searches[e].label);if(this.last.multi?i.attr("placeholder","["+a.lang("Multiple Fields")+"]"):i.attr("placeholder",a.lang("Search")+" "+a.lang(this.last.label,!0)),i.val()!=this.last.search){let e=this.last.search;(s=i._w2field)&&(e=s.format(e)),i.val(e)}this.refreshSearch(),this.refreshBody(),this.show.footer?l(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()).show():l(this.box).find(`#grid_${this.name}_footer`).hide();var s=this.last.selection,n=(i=0<this.records.length&&s.indexes.length==this.records.length,s=0<s.indexes.length&&0!==this.searchData.length&&s.indexes.length==this.last.searchIds.length,i||s?l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):l(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.find({"w2ui.expanded":!0},!0,!0));for(let e=0;e<n.length;e++){var r=this.records[n[e]].w2ui;r&&!Array.isArray(r.children)&&(r.expanded=!1)}return this.markSearch&&setTimeout((()=>{var e=[];for(let s=0;s<this.searchData.length;s++){var t=this.searchData[s],i=this.getSearch(t.field);i&&!i.hidden&&(i=this.getColumn(t.field,!0),e.push({field:t.field,search:t.value,col:i}))}0<e.length&&e.forEach((e=>{var t=l(this.box).find('td[col="'+e.col+'"]:not(.w2ui-head)');a.marker(t,e.search)}))}),50),this.updateToolbar(this.last.selection),t.finish(),this.resize(),this.addRange("selection"),setTimeout((()=>{this.resize(),this.scroll()}),1),this.reorderColumns&&!this.last.columnDrag?this.last.columnDrag=this.initColumnDrag():!this.reorderColumns&&this.last.columnDrag&&this.last.columnDrag.remove(),Date.now()-e}}refreshSearch(){if(this.multiSearch&&0<this.searchData.length){0==l(this.box).find(".w2ui-grid-searches").length&&l(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+35+"px").append(`<div id="grid_${this.name}_searches" class="w2ui-grid-searches"></div>`);let e=`\n                <span id="grid_${this.name}_search_logic" class="w2ui-grid-search-logic"></span>\n                <div class="grid-search-line"></div>`;this.searchData.forEach(((t,i)=>{var s=this.getSearch(t.field,!0),l=this.searches[s];let n;if(n="enum"==l?.type&&Array.isArray(t.value)?`<span class="grid-search-count">${t.value.length}</span>`:"list"==l?.type&&t.text&&t.text!==t.value?": "+t.text:": "+t.value,l&&"date"==l.type)if("between"==t.operator){let e=t.value[0],i=t.value[1];Number(e)===e&&(e=a.formatDate(e)),Number(i)===i&&(i=a.formatDate(i)),n=`: ${e} - `+i}else{let e=t.value,i=(Number(e)==e&&(e=a.formatDate(e)),t.operator);"more:"==(i="less"==(i="more"==i?"since":i)?"before":i).substr(0,5)&&(i="since"),n=`: ${i} `+e}e+=`<span class="w2ui-action" data-click="searchFieldTooltip|${s}|${i}|this">\n                    ${l?l.label??l.field:t.field}\n                    ${n}\n                    <span class="icon-chevron-down"></span>\n                </span>`})),e+=`\n                ${this.show.searchSave?`<div class="grid-search-line"></div>\n                       <button class="w2ui-btn grid-search-btn" data-click="searchSave">${a.lang("Save")}</button>\n                      `:""}\n                <button class="w2ui-btn grid-search-btn btn-remove"\n                    data-click="searchReset">X</button>\n            `,l(this.box).find(`#grid_${this.name}_searches`).html(e),l(this.box).find(`#grid_${this.name}_search_logic`).html(a.lang("AND"==this.last.logic?"All":"Any"))}else l(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+"px").find(".w2ui-grid-searches").remove();this.searchSelected?(l(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),l(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.text)):(l(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),l(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html("")),a.bindEvents(l(this.box).find(`#grid_${this.name}_searches .w2ui-action, #grid_${this.name}_searches button`),this)}refreshBody(){this.scroll();var e=this.getRecordsHTML(),t=this.getColumnsHTML();e='<div id="grid_'+this.name+'_frecords" class="w2ui-grid-frecords" style="margin-bottom: '+(a.scrollBarSize()-1)+'px;">'+e[0]+'</div><div id="grid_'+this.name+'_records" class="w2ui-grid-records">'+e[1]+'</div><div id="grid_'+this.name+'_scroll1" class="w2ui-grid-scroll1" style="height: '+a.scrollBarSize()+'px"></div><div id="grid_'+this.name+'_fcolumns" class="w2ui-grid-fcolumns">    <table><tbody>'+t[0]+'</tbody></table></div><div id="grid_'+this.name+'_columns" class="w2ui-grid-columns">    <table><tbody>'+t[1]+"</tbody></table></div>"+`<div class="w2ui-intersection-marker" style="display: none; height: ${this.recordHeight-5}px">\n               <div class="top-marker"></div>\n               <div class="bottom-marker"></div>\n            </div>`;let i=l(this.box).find(`#grid_${this.name}_body`,this.box).html(e);t=l(this.box).find(`#grid_${this.name}_records`,this.box),e=l(this.box).find(`#grid_${this.name}_frecords`,this.box),"row"==this.selectType&&(t.on("mouseover mouseout",{delegate:"tr"},(e=>{var t=l(e.delegate).attr("index");t=this.records[t]?.recid,l(this.box).find(`#grid_${this.name}_frec_`+a.escapeId(t)).toggleClass("w2ui-record-hover","mouseover"==e.type)})),e.on("mouseover mouseout",{delegate:"tr"},(e=>{var t=l(e.delegate).attr("index");t=this.records[t]?.recid,l(this.box).find(`#grid_${this.name}_rec_`+a.escapeId(t)).toggleClass("w2ui-record-hover","mouseover"==e.type)}))),a.isMobile?t.append(e).on("click",{delegate:"tr"},(e=>{var t=l(e.delegate).attr("index");t=this.records[t]?.recid,this.dblClick(t,e)})):t.add(e).on("click",{delegate:"tr"},(e=>{var t=l(e.delegate).attr("index");t=this.records[t]?.recid,"-none-"!=t&&this.click(t,e)})).on("contextmenu",{delegate:"tr"},(e=>{var t=l(e.delegate).attr("index"),i=(t=this.records[t]?.recid,(i=l(e.target).closest("td")).attr("col")?parseInt(i.attr("col")):null);this.showContextMenu(t,i,e)})).on("mouseover",{delegate:"tr"},(e=>{this.last.rec_out=!1;let t=l(e.delegate).attr("index"),i=this.records[t]?.recid;t!==this.last.rec_over&&(this.last.rec_over=t,setTimeout((()=>{delete this.last.rec_out,this.trigger("mouseEnter",{target:this.name,originalEvent:e,index:t,recid:i}).finish()})))})).on("mouseout",{delegate:"tr"},(e=>{let t=l(e.delegate).attr("index"),i=this.records[t]?.recid;this.last.rec_out=!0,setTimeout((()=>{let s=()=>{this.trigger("mouseLeave",{target:this.name,originalEvent:e,index:t,recid:i}).finish()};t!==this.last.rec_over&&s(),setTimeout((()=>{this.last.rec_out&&(delete this.last.rec_out,delete this.last.rec_over,s())}))}))})),i.data("scroll",{lastDelta:0,lastTime:0}).find(".w2ui-grid-frecords").on("mousewheel DOMMouseScroll ",(e=>{e.preventDefault();var t=i.data("scroll"),s=i.find(".w2ui-grid-records"),l=(e=null!=typeof e.wheelDelta?-e.wheelDelta:e.detail||e.deltaY,s.prop("scrollTop"));t.lastDelta+=e,e=Math.round(t.lastDelta),i.data("scroll",t),s.get(0).scroll({top:l+e,behavior:"smooth"})})),t.off(".body-global").on("scroll.body-global",{delegate:".w2ui-grid-records"},(e=>{this.scroll(e)})),l(this.box).find(".w2ui-grid-body").off(".body-global").on("click.body-global dblclick.body-global contextmenu.body-global",{delegate:"td.w2ui-head"},(e=>{var t=l(e.delegate).attr("col"),i=this.columns[t]??{field:t};switch(e.type){case"click":this.columnClick(i.field,e);break;case"dblclick":this.columnDblClick(i.field,e);break;case"contextmenu":this.columnContextMenu(i.field,e)}})).on("mouseover.body-global",{delegate:".w2ui-col-header"},(e=>{let t=l(e.delegate).parent().attr("col");this.columnTooltipShow(t,e),l(e.delegate).off(".tooltip").on("mouseleave.tooltip",(()=>{this.columnTooltipHide(t,e)}))})).on("click.body-global",{delegate:"input.w2ui-select-all"},(e=>{e.delegate.checked?this.selectAll():this.selectNone(),e.stopPropagation(),clearTimeout(this.last.kbd_timer)})).on("click.body-global",{delegate:".w2ui-show-children, .w2ui-col-expand"},(e=>{e.stopPropagation(),e=l(e.target).parents("tr").attr("index"),this.toggle(this.records[e].recid)})).on("click.body-global mouseover.body-global",{delegate:".w2ui-info"},(e=>{var t=l(e.delegate).closest("td"),i=t.parent(),s=this.columns[t.attr("col")],n=i.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");["mouseenter","mouseover"].includes(s.info?.showOn?.toLowerCase())&&"mouseover"==e.type?this.showBubble(i.attr("index"),t.attr("col"),n).then((()=>{l(e.delegate).off(".tooltip").on("mouseleave.tooltip",(()=>{h.hide(this.name+"-bubble")}))})):"click"==e.type&&(h.hide(this.name+"-bubble"),this.showBubble(i.attr("index"),t.attr("col"),n))})).on("mouseover.body-global",{delegate:".w2ui-clipboard-copy"},(e=>{if(!e.delegate._tooltipShow){let i=l(e.delegate).parent(),s=i.parent();var t=this.columns[i.attr("col")];let n=s.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");h.show({name:this.name+"-bubble",anchor:e.delegate,html:a.lang("string"==typeof t.clipboardCopy?t.clipboardCopy:"Copy to clipboard"),position:"top|bottom",offsetY:-2}).hide((t=>{e.delegate._tooltipShow=!1,l(e.delegate).off(".tooltip")})),l(e.delegate).off(".tooltip").on("mouseleave.tooltip",(e=>{h.hide(this.name+"-bubble")})).on("click.tooltip",(e=>{e.stopPropagation(),h.update(this.name+"-bubble",a.lang("Copied")),this.clipboardCopy(s.attr("index"),i.attr("col"),n)})),e.delegate._tooltipShow=!0}})).on("click.body-global",{delegate:".w2ui-editable-checkbox"},(e=>{var t=l(e.delegate).data();this.editChange.call(this,e.delegate,t.changeind,t.colind,e),this.updateToolbar()})),0===this.records.length&&this.msgEmpty?l(this.box).find(`#grid_${this.name}_body`).append(`<div id="grid_${this.name}_empty_msg" class="w2ui-grid-empty-msg"><div>${a.lang(this.msgEmpty)}</div></div>`):0<l(this.box).find(`#grid_${this.name}_empty_msg`).length&&l(this.box).find(`#grid_${this.name}_empty_msg`).remove(),0<this.summary.length?(e=this.getSummaryHTML(),l(this.box).find(`#grid_${this.name}_fsummary`).html(e[0]).show(),l(this.box).find(`#grid_${this.name}_summary`).html(e[1]).show()):(l(this.box).find(`#grid_${this.name}_fsummary`).hide(),l(this.box).find(`#grid_${this.name}_summary`).hide())}render(e){var t=Date.now();let i=this;"string"==typeof e&&(e=l(e).get(0));var s=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==s.isCancelled&&(null!=e&&(this.unmount(),this.box=e),this.box)){if(e="object"!=typeof this.url?this.url:this.url.get,this.reset(!0),!this.last.field)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields";else{let u=0;for(;u<this.searches.length&&(this.searches[u].hidden||!1===this.searches[u].simple);)u++;u>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[u].field,this.last.label=this.searches[u].label)}if(l(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-grid w2ui-inactive").html('<div class="w2ui-grid-box">    <div id="grid_'+this.name+'_header" class="w2ui-grid-header"></div>    <div id="grid_'+this.name+'_toolbar" class="w2ui-grid-toolbar"></div>    <div id="grid_'+this.name+'_body" class="w2ui-grid-body"></div>    <div id="grid_'+this.name+'_fsummary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_footer" class="w2ui-grid-footer"></div>    <textarea id="grid_'+this.name+'_focus" class="w2ui-grid-focus-input" '+(this.tabIndex?'tabindex="'+this.tabIndex+'"':"")+(a.isMobile?"readonly":"")+"></textarea></div>"),"row"!=this.selectType&&l(this.box).addClass("w2ui-ss"),0<l(this.box).length&&(l(this.box)[0].style.cssText+=this.style),null!=this.toolbar&&this.toolbar.render(l(this.box).find("#grid_"+this.name+"_toolbar")[0]),this.last.toolbar_height=l(this.box).find(`#grid_${this.name}_toolbar`).prop("offsetHeight"),this.last.field&&"all"!=this.last.field){let p=this.searchData;setTimeout((()=>{this.searchInitInput(this.last.field,1==p.length?p[0].value:null)}),1)}l(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()),this.last.state||(this.last.state=this.stateSave(!0)),this.stateRestore(),e&&(this.clear(),this.refresh());let r,o=!1;for(let m=0;m<this.searches.length;m++)if(this.searches[m].hidden){o=!0;break}return o?(this.searchReset(!1),e||setTimeout((()=>{this.searchReset()}),1)):this.reload(),l(this.box).find(`#grid_${this.name}_focus`).on("focus",(e=>{clearTimeout(this.last.kbd_timer),this.hasFocus||this.focus()})).on("blur",(e=>{clearTimeout(this.last.kbd_timer),this.last.kbd_timer=setTimeout((()=>{this.hasFocus&&this.blur()}),100)})).on("paste",(e=>{var t=e.clipboardData||null;if(t){let l=t.items,a=[];for(var i in l=2==l.length&&2==(l=2==l.length&&"file"==l[1].kind?[l[1]]:l).length&&"text/plain"==l[0].type&&"text/html"==l[1].type?[l[1]]:l)if("file"===(i=l[i]).kind){var s=i.getAsFile();a.push({kind:"file",data:s})}else if("string"===i.kind&&("text/plain"===i.type||"text/html"===i.type)){e.preventDefault();let s=t.getData("text/plain");-1!=s.indexOf("\r")&&-1==s.indexOf("\n")&&(s=s.replace(/\r/g,"\n")),a.push({kind:"text/html"==i.type?"html":"text",data:s})}1===a.length&&"file"!=a[0].kind&&(a=a[0].data),n[this.name].paste(a,e),e.preventDefault()}})).on("keydown",(function(e){n[i.name].keydown.call(n[i.name],e)})),l(this.box).off("mousedown.mouseStart").on("mousedown.mouseStart",(function(e){if(1==e.which&&("text"==i.last.userSelect&&(i.last.userSelect="",l(i.box).find(".w2ui-grid-body").css("user-select","none")),!("row"==i.selectType&&(l(e.target).parents().hasClass("w2ui-head")||l(e.target).hasClass("w2ui-head"))||i.last.move&&"expand"==i.last.move.type))){if(e.altKey)l(i.box).find(".w2ui-grid-body").css("user-select","text"),i.selectNone(),i.last.move={type:"text-select"},i.last.userSelect="text";else{let r=e.target;var t={x:e.offsetX-10,y:e.offsetY-10};let o=!1;for(;r&&(!r.classList||!r.classList.contains("w2ui-grid"));)r.tagName&&"TD"==r.tagName.toUpperCase()&&(o=!0),r.tagName&&"TR"!=r.tagName.toUpperCase()&&1==o&&(t.x+=r.offsetLeft,t.y+=r.offsetTop),r=r.parentNode;var s=l(e.target).parents("tr").attr("index");if(s=i.records[s]?.recid,"cell"==i.selectType&&!e.shiftKey){let t=parseInt(l(e.target).closest("td").attr("col")),n=t;isNaN(t)&&(t=0,n=i.columns.length-1),i.addRange({name:"selection-preview",range:[{recid:s,column:t},{recid:s,column:n}],class:"w2ui-selection-preview"})}i.last.move={x:e.screenX,y:e.screenY,divX:0,divY:0,focusX:t.x,focusY:t.y,recid:s,column:parseInt(("TD"==e.target.tagName.toUpperCase()?l(e.target):l(e.target).parents("td")).attr("col")),type:"select",ghost:!1,start:!0},null==i.last.move.recid&&0<i.records.length&&(i.last.move.type="select-column",s=parseInt(l(e.target).closest("td").attr("col")),n=i.records[0].recid,a=i.records[i.records.length-1].recid,i.addRange({name:"selection-preview",range:[{recid:n,column:s},{recid:a,column:s}],class:"w2ui-selection-preview"}));let d=e.target,h=l(i.box).find("#grid_"+i.name+"_focus");if(i.last.move){let e=i.last.move.focusX,t=i.last.move.focusY;var n=l(d).parents("table").parent();(n.hasClass("w2ui-grid-records")||n.hasClass("w2ui-grid-frecords")||n.hasClass("w2ui-grid-columns")||n.hasClass("w2ui-grid-fcolumns")||n.hasClass("w2ui-grid-summary"))&&(e=i.last.move.focusX-l(i.box).find("#grid_"+i.name+"_records").prop("scrollLeft"),t=i.last.move.focusY-l(i.box).find("#grid_"+i.name+"_records").prop("scrollTop")),(l(d).hasClass("w2ui-grid-footer")||0<l(d).parents("div.w2ui-grid-footer").length)&&(t=l(i.box).find("#grid_"+i.name+"_footer").get(0).offsetTop),n.hasClass("w2ui-scroll-wrapper")&&n.parent().hasClass("w2ui-toolbar")&&(e=i.last.move.focusX-n.prop("scrollLeft")),h.css({left:e-10,top:t})}setTimeout((()=>{i.last.inEditMode||(["INPUT","TEXTAREA","SELECT"].includes(d.tagName)?d.focus():h.get(0)!==document.active&&h.get(0)?.focus({preventScroll:!0}))}),50),i.multiSelect||i.reorderRows||"drag"!=i.last.move.type||delete i.last.move}if(1==i.reorderRows){let t=e.target;var a,r,o,c,u;"TD"!=t.tagName.toUpperCase()&&(t=l(t).parents("td")[0]),l(t).hasClass("w2ui-col-number")||l(t).hasClass("w2ui-col-order")?(i.selectNone(),i.last.move.reorder=!0,a=l(i.box).find(".w2ui-even.w2ui-empty-record").css("background-color"),s=l(i.box).find(".w2ui-odd.w2ui-empty-record").css("background-color"),l(i.box).find(".w2ui-even td").filter(":not(.w2ui-col-number)").css("background-color",a),l(i.box).find(".w2ui-odd td").filter(":not(.w2ui-col-number)").css("background-color",s),r=i.last.move,o=l(i.box).find(".w2ui-grid-records"),r.ghost||(u=(c=l(i.box).find(`#grid_${i.name}_rec_`+r.recid)).parents("table").find("tr:first-child").get(0).cloneNode(!0),r.offsetY=e.offsetY,r.from=r.recid,r.pos={top:c.get(0).offsetTop-1,left:c.get(0).offsetLeft},r.ghost=l(c.get(0).cloneNode(!0)),r.ghost.removeAttr("id"),r.ghost.find("td").css({"border-top":"1px solid silver","border-bottom":"1px solid silver"}),c.find("td").remove(),c.append(`<td colspan="1000"><div class="w2ui-reorder-empty" style="height: ${i.recordHeight-2}px"></div></td>`),o.append('<div id="grid_'+i.name+'_ghost_line" style="position: absolute; z-index: 999999; pointer-events: none; width: 100%;"></div>'),o.append('<table id="grid_'+i.name+'_ghost" style="position: absolute; z-index: 999998; opacity: 0.9; pointer-events: none;"></table>'),l(i.box).find("#grid_"+i.name+"_ghost").append(u).append(r.ghost)),l(i.box).find("#grid_"+i.name+"_ghost").css({top:r.pos.top+"px",left:r.pos.left+"px"})):i.last.move.reorder=!1}l(document).on("mousemove.w2ui-"+i.name,d).on("mouseup.w2ui-"+i.name,h),e.stopPropagation()}})),this.updateToolbar(),s.finish(),this.last.observeResize=new ResizeObserver((()=>{this.resize(),this.scroll()})),this.last.observeResize.observe(this.box),Date.now()-t;function d(e){if(e.target.tagName){var t=i.last.move;if(t&&["select","select-column"].includes(t.type)&&(t.divX=e.screenX-t.x,t.divY=e.screenY-t.y,!(Math.abs(t.divX)<=1&&Math.abs(t.divY)<=1)))if(i.last.cancelClick=!0,1==i.reorderRows&&i.last.move.reorder){var s=l(e.target).parents("tr").attr("index");let n=i.records[s]?.recid;(n="-none-"!=n&&null!=n?n:"bottom")!=t.from&&(s=l(i.box).find("#grid_"+i.name+"_rec_"+n),l(i.box).find(".insert-before"),s.addClass("insert-before"),t.lastY=e.screenY,t.to=n,s={top:s.get(0)?.offsetTop,left:s.get(0)?.offsetLeft},l(i.box).find("#grid_"+i.name+"_ghost_line").css({top:s.top+"px",left:t.pos.left+"px","border-top":"2px solid #769EFC"})),l(i.box).find("#grid_"+i.name+"_ghost").css({top:t.pos.top+t.divY+"px",left:t.pos.left+"px"})}else{"row"==i.selectType&&t.start&&t.recid&&(i.selectNone(),t.start=!1);var n=[];if(s=("TR"==e.target.tagName.toUpperCase()?l(e.target):l(e.target).parents("tr")).attr("index"),s=i.records[s]?.recid,null==s){if("row"!=i.selectType&&(!i.last.move||"select"!=i.last.move.type)){var a=parseInt(l(e.target).parents("td").attr("col"));if(isNaN(a))i.removeRange("column-selection"),l(i.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected"),l(i.box).find(".w2ui-col-number").removeClass("w2ui-row-selected"),delete t.colRange;else{let e=a+"-"+a;t.column<a&&(e=t.column+"-"+a);var o=[],d=(e=t.column>a?a+"-"+t.column:e).split("-");for(let e=parseInt(d[0]);e<=parseInt(d[1]);e++)o.push(e);t.colRange!=e&&"select-column"==t.type&&!0!==(r=i.trigger("columnSelect",{target:i.name,columns:o})).isCancelled&&(t.colRange=e,a=i.records[0].recid,c=i.records[i.records.length-1].recid,i.addRange({name:"selection-preview",range:[{recid:a,column:d[0]},{recid:c,column:d[1]}],class:"w2ui-selection-preview"}))}}}else{let r=i.get(t.recid,!0);if(!(null==r||i.records[r]&&i.records[r].recid!=t.recid)){let o=i.get(s,!0);if(null!=o){let d=parseInt(t.column),p=parseInt(("TD"==e.target.tagName.toUpperCase()?l(e.target):l(e.target).parents("td")).attr("col"));isNaN(d)&&isNaN(p)&&(d=0,p=i.columns.length-1),r>o&&(a=r,r=o,o=a);var h,c="ind1:"+r+",ind2;"+o+",col1:"+d+",col2:"+p;if(t.range!=c){t.range=c;for(let e=r;e<=o;e++)if(!(0<i.last.searchIds.length&&-1==i.last.searchIds.indexOf(e)))if("row"!=i.selectType){d>p&&(h=d,d=p,p=h);for(let t=d;t<=p;t++)i.columns[t].hidden||n.push({recid:i.records[e].recid,column:parseInt(t)})}else n.push(i.records[e].recid);if("row"!=i.selectType)s=n[0],e=n[n.length-1],i.addRange({name:"selection-preview",range:[{recid:s.recid,column:s.column},{recid:e.recid,column:e.column}],class:"w2ui-selection-preview"}),t.newRange=n;else if(i.multiSelect){var u=i.getSelection();for(let e=0;e<n.length;e++)-1==u.indexOf(n[e])&&i.select(n[e]);for(let e=0;e<u.length;e++)-1==n.indexOf(u[e])&&i.unselect(u[e])}}}}}}}}function h(e){var t=i.last.move;if(setTimeout((()=>{delete i.last.cancelClick}),1),!l(e.target).parents().hasClass(".w2ui-head")&&!l(e.target).hasClass(".w2ui-head")){if(i.removeRange("selection-preview"),t&&["select","select-column"].includes(t.type)){if(null!=t.colRange&&!0!==r.isCancelled){var s=t.colRange.split("-"),n=[];for(let e=0;e<i.records.length;e++){var a=[];for(let e=parseInt(s[0]);e<=parseInt(s[1]);e++)a.push(e);n.push({recid:i.records[e].recid,column:a})}r.finish(),i.selectNone(!0),i.select(n)}else null!=t.newRange&&(i.selectNone(!0),i.select(...t.newRange));if(1==i.reorderRows&&i.last.move.reorder)if(null!=t.to){if(!0===(e=i.trigger("reorderRow",{target:i.name,recid:t.from,moveBefore:t.to})).isCancelled)return c(),void delete i.last.move;var o=i.get(t.from,!0);let s=i.get(t.to,!0);"bottom"==t.to&&(s=i.records.length),t=i.records[o],null!=o&&null!=s&&(i.records.splice(o,1),o>s?i.records.splice(s,0,t):i.records.splice(s-1,0,t)),i.sortData=[],l(i.box).find(`#grid_${i.name}_columns .w2ui-col-header`).removeClass("w2ui-col-sorted"),c(),e.finish()}else c()}delete i.last.move,l(document).off(".w2ui-"+i.name)}}function c(){l(i.box).find(`#grid_${i.name}_ghost`).remove(),l(i.box).find(`#grid_${i.name}_ghost_line`).remove(),i.refresh(),delete i.last.move}}}unmount(){super.unmount(),this.toolbar?.unmount(),this.last.observeResize?.disconnect()}destroy(){var e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(this.toolbar?.destroy?.(),0<l(this.box).find(`#grid_${this.name}_body`).length&&this.unmount(),delete n[this.name],e.finish())}initColumnOnOff(){var e,t=[{id:"line-numbers",text:"Line #",checked:this.show.lineNumbers}];for(let e=0;e<this.columns.length;e++){var i=this.columns[e];let s=this.columns[e].text;!1!==i.hideable&&(s=(s=!s&&this.columns[e].tooltip?this.columns[e].tooltip:s)||"- column "+(parseInt(e)+1)+" -",t.push({id:i.field,text:a.stripTags(s),checked:!i.hidden}))}(("object"!=typeof this.url?this.url:this.url.get)&&this.show.skipRecords||this.show.saveRestoreState)&&t.push({text:"--"}),this.show.skipRecords&&(e=a.lang("Skip")+`<input id="${this.name}_skip" type="text" class="w2ui-input w2ui-grid-skip" value="${this.offset}">`+a.lang("records"),t.push({id:"w2ui-skip",text:e,group:!1,icon:"w2ui-icon-empty"})),this.show.saveRestoreState&&t.push({id:"w2ui-stateSave",text:a.lang("Save Grid State"),icon:"w2ui-icon-empty",group:!1},{id:"w2ui-stateReset",text:a.lang("Restore Default State"),icon:"w2ui-icon-empty",group:!1});let s=[];return t.forEach((e=>{e.text=a.lang(e.text),e.checked&&s.push(e.id)})),this.toolbar.set("w2ui-column-on-off",{selected:s,items:t}),t}initColumnDrag(e){if(this.columnGroups&&this.columnGroups.length)throw"Draggable columns are not currently supported with column groups.";let t=this,i={pressed:!1,targetPos:null,columnHead:null},s=(e,t)=>{var i=["w2ui-col-number","w2ui-col-expand","w2ui-col-select"];!0!==t&&i.push("w2ui-head-last");for(let t=0;t<i.length;t++)if(l(e).closest(".w2ui-head").hasClass(i[t]))return!0;return!1};function n(e){var n,a,r,o;i.pressed&&i.columnHead&&(n=e.pageX,a=e.pageY,s(e.target,!0)||0!=l(e.target).closest("td").length&&(r=(r=l(e.target).closest("td")).hasClass("w2ui-head-last")?t.columns.length:parseInt(r.attr("col")),i.targetPos!=r)&&(o=l(t.box).find(".w2ui-grid-body").get(0).getBoundingClientRect(),e=l(e.target).closest("td").get(0).getBoundingClientRect(),l(t.box).find(".w2ui-intersection-marker").show().css({left:e.left-o.left+"px",height:e.height+"px"}),i.targetPos=r),o=n,e=a,l(i.ghost).css({left:o-10+"px",top:e-10+"px"}).show())}function r(e){if(i.pressed&&i.columnHead){i.pressed=!1;var s,n,r=()=>{var e=l(t.box).find(".w2ui-grid-ghost");l(t.box).find(".w2ui-intersection-marker").hide(),l(i.ghost).remove(),e.remove(),l(document).off(".colDrag"),i={}};if(e.pageX==i.initialX&&e.pageY==i.initialY)t.columnClick(t.columns[i.originalPos].field,e),r();else{if(!0===(e=t.trigger("columnDragEnd",{originalEvent:e,target:i.columnHead[0],dragData:i})).isCancelled)return!1;s=t.columns[i.originalPos],n=t.columns,i.originalPos!=i.targetPos&&null!=i.targetPos&&(n.splice(i.targetPos,0,a.clone(s)),n.splice(n.indexOf(s),1)),r(),t.refresh(),e.finish({targetColumn:NaN})}}}return l(t.box).off(".colDrag").on("mousedown.colDrag",(function(e){var o,d;if(!i.pressed&&0!==i.numberPreColumnsPresent&&0===e.button&&l(e.target).parents().hasClass("w2ui-head")&&!s(e.target)){if(i.pressed=!0,i.initialX=e.pageX,i.initialY=e.pageY,i.numberPreColumnsPresent=l(t.box).find(".w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select").length,i.columnHead=h=l(e.target).closest(".w2ui-head"),i.originalPos=d=parseInt(h.attr("col"),10),!0===(d=t.trigger("columnDragStart",{originalEvent:e,origColumnNumber:d,target:h[0]})).isCancelled)return!1;o=i.columns=l(t.box).find(".w2ui-head:not(.w2ui-head-last)"),l(document).on("mouseup.colDrag",r),l(document).on("mousemove.colDrag",n);var h=t.columns[i.originalPos];h=a.lang("function"==typeof h.text?h.text(h):h.text),i.ghost=l.html(`<span col="${i.originalPos}">${h}</span>`)[0],l(document.body).append(i.ghost),l(i.ghost).css({display:"none",left:e.pageX,top:e.pageY,opacity:1,margin:"3px 0 0 20px",padding:"3px","background-color":"white",position:"fixed","z-index":999999}).addClass(".w2ui-grid-ghost"),i.offsets=[];for(let e=0,t=o.length;e<t;e++){var c=o[e].getBoundingClientRect();i.offsets.push(c.left)}d.finish()}})),{remove(){l(t.box).off(".colDrag"),t.last.columnDrag=!1}}}columnOnOff(e,t){if(!0!==(e=this.trigger("columnOnOff",{target:this.name,field:t,originalEvent:e})).isCancelled){var i=this.find({"w2ui.expanded":!0},!0);for(let e=0;e<i.length;e++){var s=this.records[e].w2ui;s&&!Array.isArray(s.children)&&(this.records[e].w2ui.expanded=!1)}"line-numbers"==t?(this.show.lineNumbers=!this.show.lineNumbers,this.refresh()):(t=this.getColumn(t)).hidden?this.showColumn(t.field):this.hideColumn(t.field),e.finish()}}initToolbar(){if(null==this.toolbar.render){let t=this.toolbar.items||[];var e;this.toolbar.items=[],this.toolbar=new m(a.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.show.toolbarReload&&this.toolbar.items.push(a.extend({},this.buttons.reload)),this.show.toolbarColumns&&this.toolbar.items.push(a.extend({},this.buttons.columns)),this.show.toolbarSearch&&(e=`\n                <div class="w2ui-grid-search-input">\n                    ${this.buttons.search.html}\n                    <div id="grid_${this.name}_search_name" class="w2ui-grid-search-name">\n                        <span class="name-icon w2ui-icon-search"></span>\n                        <span class="name-text"></span>\n                        <span class="name-cross w2ui-action" data-click="searchReset">x</span>\n                    </div>\n                    <input type="text" id="grid_${this.name}_search_all" class="w2ui-search-all" tabindex="-1"\n                        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"\n                        placeholder="${a.lang(this.last.label,!0)}" value="${this.last.search}"\n                        data-focus="searchSuggest" data-click="stop"\n                    >\n                    <div class="w2ui-search-drop w2ui-action" data-click="searchOpen"\n                            style="${this.multiSearch?"":"display: none"}">\n                        <span class="w2ui-icon-drop"></span>\n                    </div>\n                </div>`,this.toolbar.items.push({id:"w2ui-search",type:"html",html:e,onRefresh:async e=>{await e.complete,e=l(this.box).find(`#grid_${this.name}_search_all`),a.bindEvents(l(this.box).find(`#grid_${this.name}_search_all, .w2ui-action`),this);let t=a.debounce((e=>{e=e.target.value,this.liveSearch&&this.last.liveText!=e&&(this.last.liveText=e,this.search(this.last.field,e))}),250);e.on("blur",(()=>{this.last.liveText=""})).on("keyup",(e=>{switch(e.keyCode){case 40:this.searchSuggest(!0);break;case 38:this.searchSuggest(!0,!0);break;case 13:this.search(this.last.field,e.target.value);break;default:t(e)}}))}})),Array.isArray(t)&&(e=t.map((e=>e.id)),this.show.toolbarAdd&&!e.includes(this.buttons.add.id)&&this.toolbar.items.push(a.extend({},this.buttons.add)),this.show.toolbarEdit&&!e.includes(this.buttons.edit.id)&&this.toolbar.items.push(a.extend({},this.buttons.edit)),this.show.toolbarDelete&&!e.includes(this.buttons.delete.id)&&this.toolbar.items.push(a.extend({},this.buttons.delete)),this.show.toolbarSave&&!e.includes(this.buttons.save.id)&&((this.show.toolbarAdd||this.show.toolbarDelete||this.show.toolbarEdit)&&this.toolbar.items.push({type:"break",id:"w2ui-break2"}),this.toolbar.items.push(a.extend({},this.buttons.save))),t=t.map((e=>this.buttons[e.name]?a.extend({},this.buttons[e.name],e):e))),this.toolbar.items.push(...t),this.toolbar.on("click",(e=>{var t=this.trigger("toolbar",{target:e.target,originalEvent:e});if(!0!==t.isCancelled){let s;switch(e.detail.item.id){case"w2ui-reload":if(!0===(s=this.trigger("reload",{target:this.name})).isCancelled)return!1;this.reload(),s.finish();break;case"w2ui-column-on-off":e.detail.subItem?(i=e.detail.subItem.id,["w2ui-stateSave","w2ui-stateReset"].includes(i)?this[i.substring(5)]():"w2ui-skip"!=i&&this.columnOnOff(e,e.detail.subItem.id)):(this.initColumnOnOff(),setTimeout((()=>{l(`#w2overlay-${this.name}_toolbar-drop .w2ui-grid-skip`).off(".w2ui-grid").on("click.w2ui-grid",(e=>{e.stopPropagation()})).on("keypress",(e=>{13==e.keyCode&&(this.skip(e.target.value),this.toolbar.click("w2ui-column-on-off"))}))}),100));break;case"w2ui-add":if(!0===(s=this.trigger("add",{target:this.name,recid:null})).isCancelled)return!1;s.finish();break;case"w2ui-edit":{var i=this.getSelection();let e=null;if(1==i.length&&(e=i[0]),!0===(s=this.trigger("edit",{target:this.name,recid:e})).isCancelled)return!1;s.finish();break}case"w2ui-delete":this.delete();break;case"w2ui-save":this.save()}t.finish()}})),this.toolbar.on("refresh",(e=>{if("w2ui-search"==e.target){let e=this.searchData;setTimeout((()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)}),1)}}))}}initResize(){let e=this;l(this.box).find(".w2ui-resizer").off(".grid-col-resize").on("click.grid-col-resize",(function(e){e.stopPropagation(),e.preventDefault()})).on("mousedown.grid-col-resize",(function(t){t=t||window.event,e.last.colResizing=!0,e.last.tmp={x:t.screenX,y:t.screenY,gx:t.screenX,gy:t.screenY,col:parseInt(l(this).attr("name"))},e.last.tmp.tds=l(e.box).find("#grid_"+e.name+'_body table tr:first-child td[col="'+e.last.tmp.col+'"]'),t.stopPropagation(),t.preventDefault();for(let t=0;t<e.columns.length;t++)e.columns[t].hidden||(null==e.columns[t].sizeOriginal&&(e.columns[t].sizeOriginal=e.columns[t].size),e.columns[t].size=e.columns[t].sizeCalculated);let i,s=e.trigger("columnResize",{target:e.name,resizeBy:0,originalEvent:t,column:e.last.tmp.col,field:e.columns[e.last.tmp.col].field});l(document).off(".grid-col-resize").on("mousemove.grid-col-resize",(function(t){var l,n;1==e.last.colResizing&&(t=t||window.event,!0!==(l=e.trigger("columnResizeMove",a.extend(s.detail,{resizeBy:t.screenX-e.last.tmp.gx,originalEvent:t}))).isCancelled)&&(e.last.tmp.x=t.screenX-e.last.tmp.x,e.last.tmp.y=t.screenY-e.last.tmp.y,n=parseInt(e.columns[e.last.tmp.col].size)+e.last.tmp.x+"px",e.columns[e.last.tmp.col].size=n,i&&clearTimeout(i),i=setTimeout((()=>{e.resizeRecords(),e.scroll()}),100),e.last.tmp.tds.css({width:n}),e.last.tmp.x=t.screenX,e.last.tmp.y=t.screenY,l.finish())})).on("mouseup.grid-col-resize",(function(t){l(document).off(".grid-col-resize"),e.resizeRecords(),e.scroll(),s.finish({originalEvent:t}),setTimeout((()=>{e.last.colResizing=!1}),1)}))})).on("dblclick.grid-col-resize",(function(t){var i=parseInt(l(this).attr("name"));e.columnAutoSize(i),t.stopPropagation(),t.preventDefault()})).each((e=>{var t=l(e).get(0).parentNode;l(e).css({height:t.clientHeight+"px","margin-left":t.clientWidth-3+"px"})}))}resizeBoxes(){var e=l(this.box).find(`#grid_${this.name}_header`),t=l(this.box).find(`#grid_${this.name}_toolbar`),i=l(this.box).find(`#grid_${this.name}_fsummary`),s=l(this.box).find(`#grid_${this.name}_summary`),n=l(this.box).find(`#grid_${this.name}_footer`),r=l(this.box).find(`#grid_${this.name}_body`);this.show.header&&e.css({top:"0px",left:"0px",right:"0px"}),this.show.toolbar&&t.css({top:0+(this.show.header?a.getSize(e,"height"):0)+"px",left:"0px",right:"0px"}),0<this.summary.length&&(i.css({bottom:0+(this.show.footer?a.getSize(n,"height"):0)+"px"}),s.css({bottom:0+(this.show.footer?a.getSize(n,"height"):0)+"px",right:"0px"})),this.show.footer&&n.css({bottom:"0px",left:"0px",right:"0px"}),r.css({top:0+(this.show.header?a.getSize(e,"height"):0)+(this.show.toolbar?a.getSize(t,"height"):0)+"px",bottom:0+(this.show.footer?a.getSize(n,"height"):0)+(0<this.summary.length?a.getSize(s,"height"):0)+"px",left:"0px",right:"0px"})}resizeRecords(){let e=this;l(this.box).find(".w2ui-empty-record").remove();var t,i=l(this.box),s=l(this.box).find(":scope > div.w2ui-grid-box"),n=l(this.box).find(`#grid_${this.name}_header`),r=l(this.box).find(`#grid_${this.name}_toolbar`),o=l(this.box).find(`#grid_${this.name}_summary`),d=l(this.box).find(`#grid_${this.name}_fsummary`),h=l(this.box).find(`#grid_${this.name}_footer`),c=l(this.box).find(`#grid_${this.name}_body`),u=l(this.box).find(`#grid_${this.name}_columns`),p=l(this.box).find(`#grid_${this.name}_fcolumns`),m=l(this.box).find(`#grid_${this.name}_records`),g=l(this.box).find(`#grid_${this.name}_frecords`),f=l(this.box).find(`#grid_${this.name}_scroll1`);let b=8*String(this.total).length+10,v=(b<34&&(b=34),null!=this.lineNumberWidth&&(b=this.lineNumberWidth),!1),y=!1,w=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(w+=parseInt(this.columns[e].sizeCalculated||this.columns[e].size));m[0]?.clientWidth<w&&(v=!0),c[0]?.clientHeight-(u[0]?.clientHeight??0)<(l(m).find(":scope > table")[0]?.clientHeight??0)+(v?a.scrollBarSize():0)&&(y=!0),this.fixedBody?(t=s[0]?.clientHeight-(this.show.header?a.getSize(n,"height"):0)-(this.show.toolbar?a.getSize(r,"height"):0)-("none"!=o.css("display")?a.getSize(o,"height"):0)-(this.show.footer?a.getSize(h,"height"):0),c.css("height",t+"px")):(n=(t=a.getSize(u,"height")+a.getSize(l(this.box).find("#grid_"+this.name+"_records table"),"height")+(v?a.scrollBarSize():0))+(this.show.header?a.getSize(n,"height"):0)+(this.show.toolbar?a.getSize(r,"height"):0)+("none"!=o.css("display")?a.getSize(o,"height"):0)+(this.show.footer?a.getSize(h,"height"):0),s.css("height",n+"px"),c.css("height",t+"px"),i.css("height",a.getSize(s,"height")+"px"));let x,_,k=this.records.length;if(r="object"!=typeof this.url?this.url:this.url.get,0==this.searchData.length||r||(k=this.last.searchIds.length),this.fixedBody||(y=!1),v||y?(u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",a.scrollBarSize()+"px").show(),m.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+a.getSize(u,"height")+"px","-webkit-overflow-scrolling":"touch","overflow-x":v?"auto":"hidden","overflow-y":y?"auto":"hidden"})):(u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").hide(),m.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+a.getSize(u,"height")+"px",overflow:"hidden"}),0<m.length&&(this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0)),v?(g.css("margin-bottom",a.scrollBarSize()+"px"),f.show()):(g.css("margin-bottom",0),f.hide()),g.css({overflow:"hidden",top:m.css("top")}),this.show.emptyRecords&&!y){let e=Math.floor((m[0]?.clientHeight??0)/this.recordHeight)-1,t=0;if((t=m[0]?m[0].scrollHeight-e*this.recordHeight:t)>=this.recordHeight&&(t-=this.recordHeight,e++),this.fixedBody){for(let t=k;t<e;t++)C(t,this.recordHeight,this);C(e,t,this)}}function C(e,t,i){let s="",n="";var a;s+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',n+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',i.show.lineNumbers&&(s+='<td class="w2ui-col-number"></td>'),i.show.selectColumn&&(s+='<td class="w2ui-grid-data w2ui-col-select"></td>'),i.show.expandColumn&&(s+='<td class="w2ui-grid-data w2ui-col-expand"></td>'),n+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',i.reorderRows&&(n+='<td class="w2ui-grid-data w2ui-col-order" col="order"></td>');for(let e=0;e<i.columns.length;e++){var r=i.columns[e];(r.hidden||e<i.last.vscroll.colIndStart||e>i.last.vscroll.colIndEnd)&&!r.frozen||(a='<td class="w2ui-grid-data" '+(null!=r.attr?r.attr:"")+' col="'+e+'"></td>',r.frozen?s+=a:n+=a)}s+='<td class="w2ui-grid-data-last"></td> </tr>',n+='<td class="w2ui-grid-data-last" col="end"></td> </tr>',l(i.box).find("#grid_"+i.name+"_frecords > table").append(s),l(i.box).find("#grid_"+i.name+"_records > table").append(n)}if(0<c.length){let e=parseInt(c[0].clientWidth)-(y?a.scrollBarSize():0)-(this.show.lineNumbers?b:0)-(this.reorderRows?26:0)-(this.show.selectColumn?26:0)-(this.show.expandColumn?26:0)-1,t=(x=e,!1);for(let e=_=0;e<this.columns.length;e++){var S=this.columns[e];0<S.gridMinWidth&&(S.gridMinWidth>x&&!0!==S.hidden&&(S.hidden=!0,t=!0),S.gridMinWidth<x)&&!0===S.hidden&&(S.hidden=!1,t=!0)}if(!0===t)return void this.refresh();for(let t=0;t<this.columns.length;t++){var E=this.columns[t];E.hidden||("px"==String(E.size).substr(String(E.size).length-2).toLowerCase()?(e-=parseFloat(E.size),this.columns[t].sizeCalculated=E.size,this.columns[t].sizeType="px"):(_+=parseFloat(E.size),this.columns[t].sizeType="%",delete E.sizeCorrected))}if(100!=_&&0<_)for(let e=0;e<this.columns.length;e++){var $=this.columns[e];$.hidden||"%"==$.sizeType&&($.sizeCorrected=Math.round(100*parseFloat($.size)*100/_)/100+"%")}for(let t=0;t<this.columns.length;t++){var T=this.columns[t];T.hidden||"%"==T.sizeType&&(null!=this.columns[t].sizeCorrected?this.columns[t].sizeCalculated=Math.floor(e*parseFloat(T.sizeCorrected)/100)-1+"px":this.columns[t].sizeCalculated=Math.floor(e*parseFloat(T.size)/100)-1+"px")}}let A=0;for(let e=0;e<this.columns.length;e++){var I=this.columns[e];I.hidden||(null==I.min&&(I.min=20),parseInt(I.sizeCalculated)<parseInt(I.min)&&(I.sizeCalculated=I.min+"px"),parseInt(I.sizeCalculated)>parseInt(I.max)&&(I.sizeCalculated=I.max+"px"),A+=parseInt(I.sizeCalculated))}let D=parseInt(x)-parseInt(A);if(0<D&&0<_){let e=0;for(;;){var z=this.columns[e];if(null==z)e=0;else{if(!z.hidden&&"px"!=z.sizeType&&(z.sizeCalculated=parseInt(z.sizeCalculated)+1+"px",0==--D))break;e++}}}else 0<D&&u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",a.scrollBarSize()+"px").show();let M=1;this.show.lineNumbers&&(M+=b),this.show.selectColumn&&(M+=26),this.show.expandColumn&&(M+=26);for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||this.columns[e].frozen&&(M+=parseInt(this.columns[e].sizeCalculated));p.css("width",M+"px"),g.css("width",M+"px"),d.css("width",M+"px"),f.css("width",M+"px"),u.css("left",M+.5+"px"),m.css("left",M+"px"),o.css("left",M+"px"),u.find(":scope > table > tbody > tr:nth-child(1) td").add(p.find(":scope > table > tbody > tr:nth-child(1) td")).each((t=>{l(t).hasClass("w2ui-col-number")&&l(t).css("width",b+"px");var i=l(t).attr("col");if(null!=i){if("start"==i){let i=0;for(let t=0;t<e.last.vscroll.colIndStart;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));l(t).css("width",i+"px")}e.columns[i]&&l(t).css("width",e.columns[i].sizeCalculated)}if(l(t).hasClass("w2ui-head-last"))if(e.last.vscroll.colIndEnd+1<e.columns.length){let i=0;for(let t=e.last.vscroll.colIndEnd+1;t<e.columns.length;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));l(t).css("width",i+"px")}else l(t).css("width",a.scrollBarSize()+(0<D&&0===_?D:0)+"px")})),3==u.find(":scope > table > tbody > tr").length&&u.find(":scope > table > tbody > tr:nth-child(1) td").add(p.find(":scope > table > tbody > tr:nth-child(1) td")).html("").css({height:"0",border:"0",padding:"0",margin:"0"}),m.find(":scope > table > tbody > tr:nth-child(1) td").add(g.find(":scope > table > tbody > tr:nth-child(1) td")).each((t=>{l(t).hasClass("w2ui-col-number")&&l(t).css("width",b+"px");var i=l(t).attr("col");if(null!=i){if("start"==i){let i=0;for(let t=0;t<e.last.vscroll.colIndStart;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));l(t).css("width",i+"px")}e.columns[i]&&l(t).css("width",e.columns[i].sizeCalculated)}if(l(t).hasClass("w2ui-grid-data-last")&&0===l(t).parents(".w2ui-grid-frecords").length)if(e.last.vscroll.colIndEnd+1<e.columns.length){let i=0;for(let t=e.last.vscroll.colIndEnd+1;t<e.columns.length;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));l(t).css("width",i+"px")}else l(t).css("width",(0<D&&0===_?D:0)+"px")})),o.find(":scope > table > tbody > tr:nth-child(1) td").add(d.find(":scope > table > tbody > tr:nth-child(1) td")).each((t=>{l(t).hasClass("w2ui-col-number")&&l(t).css("width",b+"px");var i=l(t).attr("col");if(null!=i){if("start"==i){let i=0;for(let t=0;t<e.last.vscroll.colIndStart;t++)!e.columns[t]||e.columns[t].frozen||e.columns[t].hidden||(i+=parseInt(e.columns[t].sizeCalculated));l(t).css("width",i+"px")}e.columns[i]&&l(t).css("width",e.columns[i].sizeCalculated)}l(t).hasClass("w2ui-grid-data-last")&&0===l(t).parents(".w2ui-grid-frecords").length&&l(t).css("width",a.scrollBarSize()+(0<D&&0===_?D:0)+"px")})),this.initResize(),this.refreshRanges(),(this.last.vscroll.scrollTop||this.last.vscroll.scrollLeft)&&0<m.length&&(u.prop("scrollLeft",this.last.vscroll.scrollLeft),m.prop("scrollTop",this.last.vscroll.scrollTop),m.prop("scrollLeft",this.last.vscroll.scrollLeft)),u.css("will-change","scroll-position")}getSearchesHTML(){let e=`\n            <div class="search-title">\n                ${a.lang("Advanced Search")}\n                <span class="search-logic" style="${this.show.searchLogic?"":"display: none"}">\n                    <select id="grid_${this.name}_logic" class="w2ui-input">\n                        <option value="AND" ${"AND"==this.last.logic?"selected":""}>${a.lang("All")}</option>\n                        <option value="OR" ${"OR"==this.last.logic?"selected":""}>${a.lang("Any")}</option>\n                    </select>\n                </span>\n            </div>\n            <table cellspacing="0"><tbody>\n        `;for(let s=0;s<this.searches.length;s++){var t=this.searches[s];if(t.type=String(t.type).toLowerCase(),!t.hidden){null==t.attr&&(t.attr=""),null==t.text&&(t.text=""),null==t.style&&(t.style=""),null==t.type&&(t.type="text"),null==t.label&&null!=t.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",t),t.label=t.caption);var i=`<select id="grid_${this.name}_operator_${s}" class="w2ui-input" data-change="initOperator|${s}">\n                    ${this.getOperators(t.type,t.operators)}\n                </select>`;let l;switch(e+=`<tr>\n                        <td class="caption">${a.lang(t.label??t.field)||""}</td>\n                        <td class="operator">${i}</td>\n                        <td class="value">`,t.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":l="width: 250px;",-1!=["hex","color"].indexOf(t.type)&&(l="width: 90px;"),e+=`<input rel="search" type="text" id="grid_${this.name}_field_${s}" name="${t.field}"\n                               class="w2ui-input" style="${l+t.style}" ${t.attr}>`;break;case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":l="width: 90px;","datetime"==t.type&&(l="width: 140px;"),e+=`<input id="grid_${this.name}_field_${s}" name="${t.field}" ${t.attr} rel="search" type="text"\n                                class="w2ui-input" style="${l+t.style}">\n                            <span id="grid_${this.name}_range_${s}" style="display: none">&#160;-&#160;&#160;\n                                <input rel="search" type="text" class="w2ui-input" style="${l+t.style}" id="grid_${this.name}_field2_${s}" name="${t.field}" ${t.attr}>\n                            </span>`;break;case"select":e+=`<select rel="search" class="w2ui-input" style="${t.style}" id="grid_${this.name}_field_${s}"\n                                name="${t.field}" ${t.attr}></select>`}e+=t.text+"    </td></tr>"}}return e+`<tr>\n            <td colspan="2" class="actions">\n                <button type="button" class="w2ui-btn close-btn" data-click="searchClose">${a.lang("Close")}</button>\n            </td>\n            <td class="actions">\n                <button type="button" class="w2ui-btn" data-click="searchReset">${a.lang("Reset")}</button>\n                <button type="button" class="w2ui-btn w2ui-btn-blue" data-click="search">${a.lang("Search")}</button>\n            </td>\n        </tr></tbody></table>`}getOperators(e,t){let i=this.operators[this.operatorsMap[e]]||[],s=(null!=t&&Array.isArray(t)&&(i=t),"");return i.forEach((e=>{let t=e,i=e;Array.isArray(e)?(t=e[1],i=e[0]):a.isPlainObject(e)&&(t=e.text,i=e.oper),null==t&&(t=e),s+=`<option name="11" value="${i}">${a.lang(t)}</option>\n`})),s}initOperator(e){let t;var i=this.searches[e],s=this.getSearchData(i.field),n=l(`#w2overlay-${this.name}-search-overlay`),r=n.find(`#grid_${this.name}_range_`+e);let o=n.find(`#grid_${this.name}_field_`+e),d=n.find(`#grid_${this.name}_field2_`+e);var h=n.find(`#grid_${this.name}_operator_`+e).val();switch(o.show(),r.hide(),h){case"between":r.css("display","inline");break;case"null":case"not null":o.hide(),o.val(h),o.trigger("change")}switch(i.type){case"text":case"alphanumeric":var c=o[0]._w2field;c&&c.reset();break;case"int":case"float":case"hex":case"color":case"money":case"currency":case"percent":case"date":case"time":case"datetime":o[0]._w2field||(new w(i.type,{el:o[0],...i.options}),new w(i.type,{el:d[0],...i.options}),setTimeout((()=>{o.trigger("keydown"),d.trigger("keydown")}),1));break;case"list":case"combo":case"enum":t=i.options,"list"==i.type&&(t.selected={}),"enum"==i.type&&(t.selected=[]),s&&(t.selected=s.value),o[0]._w2field||(c=new w(i.type,{el:o[0],...t}),s&&null!=s.text&&c.set({id:s.value,text:s.text}));break;case"select":t='<option value="">--</option>';for(let e=0;e<i.options.items.length;e++){var u=i.options.items[e];if(a.isPlainObject(i.options.items[e])){let e=u.id,i=u.text;null==e&&null!=u.value&&(e=u.value),null==i&&null!=u.text&&(i=u.text),null==e&&(e=""),t+='<option value="'+e+'">'+i+"</option>"}else t+='<option value="'+u+'">'+u+"</option>"}o.html(t)}}initSearches(){var e=l(`#w2overlay-${this.name}-search-overlay`);for(let l=0;l<this.searches.length;l++){var t=this.searches[l],i=this.getSearchData(t.field);t.type=String(t.type).toLowerCase(),"object"!=typeof t.options&&(t.options={});let n=t.operator,r=[...this.operators[this.operatorsMap[t.type]]];t.operators&&(r=t.operators),a.isPlainObject(n)&&(n=n.oper),r.forEach(((e,t)=>{a.isPlainObject(e)&&(r[t]=e.oper)})),i&&i.operator&&(n=i.operator),t=this.defaultOperator[this.operatorsMap[t.type]],-1==r.indexOf(n)&&(n=t),e.find(`#grid_${this.name}_operator_`+l).val(n),this.initOperator(l),t=e.find(`#grid_${this.name}_field_`+l);var s=e.find(`#grid_${this.name}_field2_`+l);null!=i&&(Array.isArray(i.value)?["in","not in"].includes(i.operator)?t[0]._w2field.set(i.value):(t.val(i.value[0]).trigger("change"),s.val(i.value[1]).trigger("change")):null!=i.value&&t.val(i.value).trigger("change"))}e.find(".w2ui-grid-search-advanced *[rel=search]").on("keypress",(e=>{13==e.keyCode&&(this.search(),h.hide(this.name+"-search-overlay"))}))}getColumnsHTML(){let e=this,t="",i="";var s,l,n;return this.show.columnHeaders&&(i=0<this.columnGroups.length?(n=r(!0),s=function(){let t="<tr>",i="<tr>",s="",l=e.columnGroups.length-1;null==e.columnGroups[l].text&&null!=e.columnGroups[l].caption&&(console.log("NOTICE: grid columnGroup.caption property is deprecated, please use columnGroup.text. Group -> ",e.columnGroups[l]),e.columnGroups[l].text=e.columnGroups[l].caption),""!=e.columnGroups[e.columnGroups.length-1].text&&e.columnGroups.push({text:""}),e.show.lineNumbers&&(t+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>&#160;</div></td>'),e.show.selectColumn&&(t+='<td class="w2ui-head w2ui-col-select" col="select">    <div style="height: 25px">&#160;</div></td>'),e.show.expandColumn&&(t+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div style="height: 25px">&#160;</div></td>');let n=0;i+=`<td id="grid_${e.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`,e.reorderRows&&(i+='<td class="w2ui-head w2ui-col-order" col="order">    <div style="height: 25px">&#160;</div></td>');for(let l=0;l<e.columnGroups.length;l++){var r=e.columnGroups[l],o=e.columns[n]||{};null!=r.colspan&&(r.span=r.colspan),null!=r.span&&r.span==parseInt(r.span)||(r.span=1),null==o.text&&null!=o.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column ->",o),o.text=o.caption);let h=0;for(let t=n;t<n+r.span;t++)e.columns[t]&&!e.columns[t].hidden&&h++;if(!((h=l==e.columnGroups.length-1?100:h)<=0)){if(!0===r.main){let t="";for(let i=0;i<e.sortData.length;i++)e.sortData[i].field==o.field&&("asc"===(e.sortData[i].direction||"").toLowerCase()&&(t="w2ui-sort-up"),"desc"===(e.sortData[i].direction||"").toLowerCase())&&(t="w2ui-sort-down");let i="";!1!==o.resizable&&(i=`<div class="w2ui-resizer" name="${n}"></div>`);var d=a.lang("function"==typeof o.text?o.text(o):o.text);s=`<td id="grid_${e.name}_column_${n}" class="w2ui-head ${t}" col="${n}"     rowspan="2" colspan="${h}">`+i+`    <div class="w2ui-col-group w2ui-col-header ${t?"w2ui-col-sorted":""}">`+`        <div class="${t}"></div>`+(d||"&#160;")+"    </div></td>"}else d=a.lang("function"==typeof r.text?r.text(r):r.text),s=`<td id="grid_${e.name}_column_${n}" class="w2ui-head" col="${n}" colspan="${h}">    <div class="w2ui-col-group" style="${r.style??""}">${d||"&#160;"}</div></td>`;o&&o.frozen?t+=s:i+=s}n+=r.span}return t+="<td></td></tr>",i+=`<td id="grid_${e.name}_column_end" class="w2ui-head" col="end"></td></tr>`,[t,i]}(),l=r(!1),t=n[0]+s[0]+l[0],n[1]+s[1]+l[1]):(t=(n=r(!0))[0],n[1])),[t,i];function r(t){let i,s="<tr>",l="<tr>",n=(e.show.lineNumbers&&(s+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>#</div></td>'),e.show.selectColumn&&(s+=`<td class="w2ui-head w2ui-col-select" col="select">    <div>        <input type="checkbox" id="grid_${e.name}_check_all" class="w2ui-select-all" tabindex="-1"            style="${0==e.multiSelect?"display: none;":""}"        >    </div></td>`),e.show.expandColumn&&(s+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div>&#160;</div></td>'),0),a=0;l+=`<td id="grid_${e.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`,e.reorderRows&&(l+='<td class="w2ui-head w2ui-col-order" col="order">    <div>&#160;</div></td>');for(let d=0;d<e.columns.length;d++){var r,o=e.columns[d];null==o.text&&null!=o.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column -> ",o),o.text=o.caption),null==o.size&&(o.size="100%"),d==a&&(i=e.columnGroups[n++]||{},a+=i.span),(d<e.last.vscroll.colIndStart||d>e.last.vscroll.colIndEnd)&&!o.frozen||o.hidden||!0===i.main&&!t||(r=e.getColumnCellHTML(d),o&&o.frozen?s+=r:l+=r)}return s+='<td class="w2ui-head w2ui-head-last"><div>&#160;</div></td>',l+='<td class="w2ui-head w2ui-head-last" col="end"><div>&#160;</div></td>',s+="</tr>",l+="</tr>",[s,l]}}getColumnCellHTML(e){var t=this.columns[e];if(null==t)return"";var i=!this.reorderColumns||this.columnGroups&&this.columnGroups.length?"":" w2ui-col-reorderable ";let s="";for(let e=0;e<this.sortData.length;e++)this.sortData[e].field==t.field&&("asc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-up"),"desc"===(this.sortData[e].direction||"").toLowerCase())&&(s="w2ui-sort-down");var l,n=this.last.selection.columns;let r=!1;for(l in n)for(let t=0;t<n[l].length;t++)n[l][t]==e&&(r=!0);var o=a.lang("function"==typeof t.text?t.text(t):t.text);return'<td id="grid_'+this.name+"_column_"+e+'" col="'+e+'" class="w2ui-head '+s+i+'">'+(!1!==t.resizable?'<div class="w2ui-resizer" name="'+e+'"></div>':"")+'    <div class="w2ui-col-header '+(s?"w2ui-col-sorted":"")+" "+(r?"w2ui-col-selected":"")+'">        <div class="'+s+'"></div>'+(o||"&#160;")+"    </div></td>"}columnTooltipShow(e,t){var i=l(this.box).find("#grid_"+this.name+"_column_"+e),s=(e=this.columns[e],this.columnTooltip);h.show({name:this.name+"-column-tooltip",anchor:i.get(0),html:e?.tooltip,position:s})}columnTooltipHide(e,t){h.hide(this.name+"-column-tooltip")}getRecordsHTML(){let e=this.records.length;var t="object"!=typeof this.url?this.url:this.url.get;(e=0==this.searchData.length||t?e:this.last.searchIds.length)>this.vs_start?this.last.vscroll.show_extra=this.vs_extra:this.last.vscroll.show_extra=this.vs_start,t=l(this.box).find(`#grid_${this.name}_records`);let i=Math.floor((t.get(0)?.clientHeight||0)/this.recordHeight)+this.last.vscroll.show_extra+1;i<this.vs_start&&(i=this.vs_start),(!this.fixedBody||i>e)&&(i=e);var s=this.getRecordHTML(-1,0);let n="<table><tbody>"+s[0],a="<table><tbody>"+s[1];n+='<tr id="grid_'+this.name+'_frec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>',a+='<tr id="grid_'+this.name+'_rec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>';for(let e=0;e<i;e++)n+=(s=this.getRecordHTML(e,e+1))[0],a+=s[1];return t=(e-i)*this.recordHeight,n+='<tr id="grid_'+this.name+'_frec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_frec_more" style="display: none; ">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',a+='<tr id="grid_'+this.name+'_rec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_rec_more" style="display: none">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',this.last.vscroll.recIndStart=0,this.last.vscroll.recIndEnd=i,[n,a]}getSummaryHTML(){if(0!==this.summary.length){var e=this.getRecordHTML(-1,0);let t="<table><tbody>"+e[0],i="<table><tbody>"+e[1];for(let s=0;s<this.summary.length;s++)t+=(e=this.getRecordHTML(s,s+1,!0))[0],i+=e[1];return t+="</tbody></table>",i+="</tbody></table>",[t,i]}}scroll(e){let t=this;var i="object"!=typeof this.url?this.url:this.url.get,s=l(this.box).find(`#grid_${this.name}_records`),n=l(this.box).find(`#grid_${this.name}_frecords`);e&&(x=e.target.scrollTop,e=e.target.scrollLeft,this.last.vscroll.scrollTop=x,this.last.vscroll.scrollLeft=e,p=l(this.box).find(`#grid_${this.name}_columns`)[0],m=l(this.box).find(`#grid_${this.name}_summary`)[0],p&&(p.scrollLeft=e),m&&(m.scrollLeft=e),n[0])&&(n[0].scrollTop=x),this.last.bubbleEl&&(h.hide(this.name+"-bubble"),this.last.bubbleEl=null);let r=null,o=null;if(this.disableCVS||0<this.columnGroups.length)r=0,o=this.columns.length-1;else{var d,c=s.prop("clientWidth");let e=0;for(let t=0;t<this.columns.length;t++)this.columns[t].frozen||this.columns[t].hidden||(e+(d=parseInt(this.columns[t].sizeCalculated||this.columns[t].size))+30>this.last.vscroll.scrollLeft&&null==r&&(r=t),e+d-30>this.last.vscroll.scrollLeft+c&&null==o&&(o=t),e+=d);null==o&&(o=this.columns.length-1)}if(null!=r&&(r<0&&(r=0),o<0&&(o=0),r==o&&(0<r?r--:o++),r!=this.last.vscroll.colIndStart||o!=this.last.vscroll.colIndEnd)){var u=l(this.box),p=Math.abs(r-this.last.vscroll.colIndStart),m=Math.abs(o-this.last.vscroll.colIndEnd);if(p<5&&m<5){var g=u.find(`.w2ui-grid-columns #grid_${this.name}_column_start`),f=u.find(".w2ui-grid-columns .w2ui-head-last"),b=u.find(`#grid_${this.name}_records .w2ui-grid-data-spacer`),v=u.find(`#grid_${this.name}_records .w2ui-grid-data-last`),y=u.find(`#grid_${this.name}_summary .w2ui-grid-data-spacer`),w=u.find(`#grid_${this.name}_summary .w2ui-grid-data-last`);if(r>this.last.vscroll.colIndStart)for(let e=this.last.vscroll.colIndStart;e<r;e++)u.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),u.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),u.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(o<this.last.vscroll.colIndEnd)for(let e=this.last.vscroll.colIndEnd;e>o;e--)u.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),u.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),u.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(r<this.last.vscroll.colIndStart)for(let e=this.last.vscroll.colIndStart-1;e>=r;e--)this.columns[e]&&(this.columns[e].frozen||this.columns[e].hidden)||(g.after(this.getColumnCellHTML(e)),b.each((t=>{var i=l(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),e,!1)),l(t).after(s)})),y.each((t=>{var i=l(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),e,!0)),l(t).after(s)})));if(o>this.last.vscroll.colIndEnd)for(let e=this.last.vscroll.colIndEnd+1;e<=o;e++)this.columns[e]&&(this.columns[e].frozen||this.columns[e].hidden)||(f.before(this.getColumnCellHTML(e)),v.each((t=>{var i=l(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),e,!1)),l(t).before(s)})),w.each((t=>{var i=l(t).parent().attr("index")||-1;i=this.getCellHTML(parseInt(i),e,!0),l(t).before(i)})));this.last.vscroll.colIndStart=r,this.last.vscroll.colIndEnd=o}else{this.last.vscroll.colIndStart=r,this.last.vscroll.colIndEnd=o,e=this.getColumnsHTML();var x=this.getRecordsHTML();p=this.getSummaryHTML(),m=u.find(`#grid_${this.name}_columns`);let t=u.find(`#grid_${this.name}_records`);var _=u.find(`#grid_${this.name}_frecords`);let i=u.find(`#grid_${this.name}_summary`);m.find("tbody").html(e[1]),_.html(x[0]),t.prepend(x[1]),null!=p&&i.html(p[1]),setTimeout((()=>{t.find(":scope > table").filter(":not(table:first-child)").remove(),i[0]&&(i[0].scrollLeft=this.last.vscroll.scrollLeft)}),1)}this.resizeRecords()}let k=this.records.length;if(k>this.total&&-1!==this.total&&(k=this.total),0!==(k=0==this.searchData.length||i?k:this.last.searchIds.length)&&0!==s.length&&0!==s.prop("clientHeight")){k>this.vs_start?this.last.vscroll.show_extra=this.vs_extra:this.last.vscroll.show_extra=this.vs_start;let r=Math.round(s.prop("scrollTop")/this.recordHeight+1),o=r+(Math.round(s.prop("clientHeight")/this.recordHeight)-1);if(r>k&&(r=k),o>=k-1&&(o=k),l(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right").html((this.show.statusRange?a.formatNumber(this.offset+r)+"-"+a.formatNumber(this.offset+o)+(-1!=this.total?" "+a.lang("of")+' <span class="w2ui-total">'+a.formatNumber(this.total)+"</span>":""):"")+(i&&this.show.statusBuffered?" ("+a.lang("buffered")+' <span class="w2ui-buffered">'+a.formatNumber(k)+"</span>"+(0<this.offset?', skip <span class="w2ui-skip">'+a.formatNumber(this.offset):"")+"</span>)":"")),i||this.fixedBody&&!(-1!=this.total&&this.total<=this.vs_start)){let i=Math.floor(s.prop("scrollTop")/this.recordHeight)-this.last.vscroll.show_extra,r=i+Math.floor(s.prop("clientHeight")/this.recordHeight)+2*this.last.vscroll.show_extra+1;i<1&&(i=1),r>this.total&&-1!=this.total&&(r=this.total);var C=s.find("#grid_"+this.name+"_rec_top"),S=s.find("#grid_"+this.name+"_rec_bottom"),E=n.find("#grid_"+this.name+"_frec_top"),$=n.find("#grid_"+this.name+"_frec_bottom");let o,d,h,c,u;if(-1!=String(C.next().prop("id")).indexOf("_expanded_row")&&(C.next().remove(),E.next().remove()),this.total>r&&-1!=String(S.prev().prop("id")).indexOf("_expanded_row")&&(S.prev().remove(),$.prev().remove()),m=parseInt(C.next().attr("line")),e=parseInt(S.prev().attr("line")),m<=i||1==m||this.last.vscroll.pull_refresh){if(r<=e+this.last.vscroll.show_extra-2&&r!=this.total)return;for(this.last.vscroll.pull_refresh=!1;d=n.find("#grid_"+this.name+"_frec_top").next(),"bottom"!=(h=s.find("#grid_"+this.name+"_rec_top").next()).attr("line")&&parseInt(h.attr("line"))<i;)d.remove(),h.remove();o=s.find("#grid_"+this.name+"_rec_bottom").prev(),"top"==(c=o.attr("line"))&&(c=i);for(let e=parseInt(c)+1;e<=r;e++)this.records[e-1]&&((h=this.records[e-1].w2ui)&&!Array.isArray(h.children)&&(h.expanded=!1),u=this.getRecordHTML(e-1,e),S.before(u[1]),$.before(u[0]))}else{if(i>=m-this.last.vscroll.show_extra+2&&1<i)return;for(;d=n.find("#grid_"+this.name+"_frec_bottom").prev(),"top"!=(h=s.find("#grid_"+this.name+"_rec_bottom").prev()).attr("line")&&parseInt(h.attr("line"))>r;)d.remove(),h.remove();o=s.find("#grid_"+this.name+"_rec_top").next(),"bottom"==(c=o.attr("line"))&&(c=r);for(let e=parseInt(c)-1;e>=i;e--)this.records[e-1]&&((h=this.records[e-1].w2ui)&&!Array.isArray(h.children)&&(h.expanded=!1),u=this.getRecordHTML(e-1,e),C.after(u[1]),E.after(u[0]))}t.markSearch&&(clearTimeout(t.last.marker_timer),t.last.marker_timer=setTimeout((()=>{var e=[];for(let l=0;l<t.searchData.length;l++){var i=t.searchData[l],s=t.getSearch(i.field);s&&!s.hidden&&(s=t.getColumn(i.field,!0),e.push({field:i.field,search:i.value,col:s}))}0<e.length&&e.forEach((e=>{var i=l(t.box).find('td[col="'+e.col+'"]:not(.w2ui-head)');a.marker(i,e.search)}))}),50)),setTimeout((()=>{this.refreshRanges()}),0),_=(i-1)*this.recordHeight;let p=(k-r)*this.recordHeight;p<0&&(p=0),C.css("height",_+"px"),E.css("height",_+"px"),S.css("height",p+"px"),$.css("height",p+"px"),this.last.vscroll.recIndStart=i,this.last.vscroll.recIndEnd=r,Math.floor(s.prop("scrollTop")/this.recordHeight)+Math.floor(s.prop("clientHeight")/this.recordHeight)+10>k&&!0!==this.last.vscroll.pull_more&&(k<this.total-this.offset||-1==this.total&&this.last.fetch.hasMore)&&(!0===this.autoLoad&&(this.last.vscroll.pull_more=!0,this.last.fetch.offset+=this.limit,this.request("load")),l(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").show().eq(1).off(".load-more").on("click.load-more",(function(){l(this).find("td").html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>'),t.last.vscroll.pull_more=!0,t.last.fetch.offset+=t.limit,t.request("load")})).find("td").html(t.autoLoad?'<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>':'<div style="padding-top: 15px">'+a.lang("Load ${count} more...",{count:t.limit})+"</div>"))}}}getRecordHTML(e,t,i){let s="",l="";var n=this.last.selection;let a;if(-1==e){s+='<tr line="0">',l+='<tr line="0">',this.show.lineNumbers&&(s+='<td class="w2ui-col-number" style="height: 0px"></td>'),this.show.selectColumn&&(s+='<td class="w2ui-col-select" style="height: 0px"></td>'),this.show.expandColumn&&(s+='<td class="w2ui-col-expand" style="height: 0px"></td>'),l+='<td class="w2ui-grid-data w2ui-grid-data-spacer" col="start" style="height: 0px; width: 0px"></td>',this.reorderRows&&(l+='<td class="w2ui-col-order" style="height: 0px"></td>');for(let e=0;e<this.columns.length;e++){var r=this.columns[e],o='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px;"></td>';r.frozen&&!r.hidden?s+=o:r.hidden||e<this.last.vscroll.colIndStart||e>this.last.vscroll.colIndEnd||(l+=o)}s+='<td class="w2ui-grid-data-last" style="height: 0px"></td>',l+='<td class="w2ui-grid-data-last" col="end" style="height: 0px"></td>'}else{var d="object"!=typeof this.url?this.url:this.url.get;if(!0!==i){if(0<this.searchData.length&&!d){if(e>=this.last.searchIds.length)return"";e=this.last.searchIds[e]}else if(e>=this.records.length)return"";a=this.records[e]}else{if(e>=this.summary.length)return"";a=this.summary[e]}if(!a)return"";null==a.recid&&null!=this.recid&&null!=(d=this.parseField(a,this.recid))&&(a.recid=d);let r=!1,o=(-1!=n.indexes.indexOf(e)&&(r=!0),a.w2ui?a.w2ui.style:""),m=(null!=o&&"string"==typeof o||(o=""),a.w2ui?a.w2ui.class:"");if(null!=m&&"string"==typeof m||(m=""),s+='<tr id="grid_'+this.name+"_frec_"+a.recid+'" recid="'+a.recid+'" line="'+t+'" index="'+e+'"  class="'+(t%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+m+(r&&"row"==this.selectType?" w2ui-selected":"")+(a.w2ui&&!1===a.w2ui.editable?" w2ui-no-edit":"")+(a.w2ui&&!0===a.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(r||""==o?o.replace("background-color","none"):o)+'" '+(""!=o?'custom_style="'+o+'"':"")+">",l+='<tr id="grid_'+this.name+"_rec_"+a.recid+'" recid="'+a.recid+'" line="'+t+'" index="'+e+'"  class="'+(t%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+m+(r&&"row"==this.selectType?" w2ui-selected":"")+(a.w2ui&&!1===a.w2ui.editable?" w2ui-no-edit":"")+(a.w2ui&&!0===a.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(r||""==o?o.replace("background-color","none"):o)+'" '+(""!=o?'custom_style="'+o+'"':"")+">",this.show.lineNumbers&&(s+='<td id="grid_'+this.name+"_cell_"+e+"_number"+(i?"_s":"")+'"    class="w2ui-col-number '+(r?" w2ui-row-selected":"")+'"'+(this.reorderRows?' style="cursor: move"':"")+">"+(!0!==i?this.getLineHTML(t,a):"")+"</td>"),this.show.selectColumn&&(s+='<td id="grid_'+this.name+"_cell_"+e+"_select"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-select">'+(!0===i||a.w2ui&&!0===a.w2ui.hideCheckBox?"":'    <div>        <input class="w2ui-grid-select-check" type="checkbox" tabindex="-1" '+(r?'checked="checked"':"")+' style="pointer-events: none"/>    </div>')+"</td>"),this.show.expandColumn){let t="";t=!0===a.w2ui?.expanded?"-":"+","none"!=a.w2ui?.expanded&&Array.isArray(a.w2ui?.children)&&a.w2ui?.children.length||(t="+"),"spinner"==a.w2ui?.expanded&&(t='<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>'),s+='<td id="grid_'+this.name+"_cell_"+e+"_expand"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-expand">'+(!0!==i?`<div>${t}</div>`:"")+"</td>"}l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',this.reorderRows&&(l+='<td id="grid_'+this.name+"_cell_"+e+"_order"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-order" col="order">'+(!0!==i?'<div title="Drag to reorder">&nbsp;</div>':"")+"</td>");let g=0,f=0;for(;;){let t=1;var h,c=this.columns[g];if(null==c)break;if(c.hidden)g++,0<f&&f--;else if(0<f){if(g++,null==this.columns[g])break;a.w2ui.colspan[this.columns[g-1].field]=0,f--}else{if(a.w2ui&&(p=a.w2ui.colspan,h=this.columns[g].field,p)&&0===p[h]&&delete p[h],!(g<this.last.vscroll.colIndStart||g>this.last.vscroll.colIndEnd)||c.frozen){if(a.w2ui&&"object"==typeof a.w2ui.colspan){var u=parseInt(a.w2ui.colspan[c.field])||null;if(1<u){let e=0;for(let t=g;t<g+u&&!(t>=this.columns.length);t++)this.columns[t].hidden&&e++;t=u-e,f=u-1}}var p=this.getCellHTML(e,g,i,t);c.frozen?s+=p:l+=p}g++}}s+='<td class="w2ui-grid-data-last"></td>',l+='<td class="w2ui-grid-data-last" col="end"></td>'}return s+="</tr>",l+="</tr>",[s,l]}getLineHTML(e){return"<div>"+e+"</div>"}getCellHTML(e,t,i,s){let l=this,n=this.columns[t];if(null==n)return"";let r=(!0!==i?this.records:this.summary)[e],{value:o,style:d,className:h,attr:c,divAttr:u}=this.getCellValue(e,t,i,!0);var p=-1!==e?this.getCellEditable(e,t):"";let m="max-height: "+parseInt(this.recordHeight)+"px;"+(n.clipboardCopy?"margin-right: 20px":"");var g=!i&&r?.w2ui?.changes&&null!=r.w2ui.changes[n.field],f=this.last.selection;let b=!1,v="";if(-1!=f.indexes.indexOf(e)&&(b=!0),null==s&&(s=r?.w2ui?.colspan&&r.w2ui.colspan[n.field]?r.w2ui.colspan[n.field]:1),0===t&&Array.isArray(r?.w2ui?.children)){let e=0,t=this.get(r.w2ui.parent_recid,!0);for(;null!=t;){e++;var y=this.records[t].w2ui;if(null==y||null==y.parent_recid)break;t=this.get(y.parent_recid,!0)}if(r.w2ui.parent_recid)for(let t=0;t<e;t++)v+='<span class="w2ui-show-children w2ui-icon-empty"></span>';var w=0<r.w2ui.children.length?r.w2ui.expanded?"w2ui-icon-collapse":"w2ui-icon-expand":"w2ui-icon-empty";v+=`<span class="w2ui-show-children ${w}"></span>`}if(!0===n.info&&(n.info={}),null!=n.info){let s="w2ui-icon-info",l=("function"==typeof n.info.icon?s=n.info.icon(r,{self:this,index:e,colIndex:t,summary:!!i}):"object"==typeof n.info.icon?s=n.info.icon[this.parseField(r,n.field)]||"":"string"==typeof n.info.icon&&(s=n.info.icon),n.info.style||"");"function"==typeof n.info.style?l=n.info.style(r,{self:this,index:e,colIndex:t,summary:!!i}):"object"==typeof n.info.style?l=n.info.style[this.parseField(r,n.field)]||"":"string"==typeof n.info.style&&(l=n.info.style),v+=`<span class="w2ui-info ${s}" style="${l}"></span>`}let x,_=o,k=(p&&-1!=["checkbox","check"].indexOf(p.type)&&(m+="text-align: center;",_=`<input tabindex="-1" type="checkbox" class="w2ui-editable-checkbox"\n                            data-changeInd="${i?-(e+1):e}" data-colInd="${t}" ${_?'checked="checked"':""}>`,v=""),null==(_=`<div style="${m}" ${function(s){let o;return l.show.recordTitles&&(null!=n.title?("function"==typeof n.title&&(o=n.title.call(l,r,{self:this,index:e,colIndex:t,summary:!!i})),"string"==typeof n.title&&(o=n.title)):o=a.stripTags(String(s).replace(/"/g,"''"))),null!=o?'title="'+String(o)+'"':""}(_)} ${u}>${v}${String(_)}</div>`)&&(_=""),"string"==typeof n.render&&(w=n.render.toLowerCase().split(":"),-1!=["number","int","float","money","currency","percent","size"].indexOf(w[0]))&&(d+="text-align: right;"),r?.w2ui&&("object"==typeof r.w2ui.style&&("string"==typeof r.w2ui.style[t]&&(d+=r.w2ui.style[t]+";"),"string"==typeof r.w2ui.style[n.field])&&(d+=r.w2ui.style[n.field]+";"),"object"==typeof r.w2ui.class)&&("string"==typeof r.w2ui.class[t]&&(h+=r.w2ui.class[t]+" "),"string"==typeof r.w2ui.class[n.field])&&(h+=r.w2ui.class[n.field]+" "),!1);return b&&f.columns[e]?.includes(t)&&(k=!0),n.clipboardCopy&&(x='<span class="w2ui-clipboard-copy w2ui-icon-paste"></span>'),_='<td class="w2ui-grid-data'+(k?" w2ui-selected":"")+" "+h+(g?" w2ui-changed":"")+'"    id="grid_'+this.name+"_data_"+e+"_"+t+'" col="'+t+'"    style="'+d+(null!=n.style?n.style:"")+'" '+(null!=n.attr?n.attr:"")+c+(1<s?'colspan="'+s+'"':"")+">"+_+(x&&a.stripTags(_)?x:"")+"</td>",-1===e&&!0===i?'<td class="w2ui-grid-data" col="'+t+'" style="height: 0px; '+d+'" '+(1<s?'colspan="'+s+'"':"")+"></td>":_}clipboardCopy(e,t,i){var s=(i?this.summary:this.records)[e],n=this.columns[t];let a=n?this.parseField(s,n.field):"";"function"==typeof n.clipboardCopy&&(a=n.clipboardCopy(s,{self:this,index:e,colIndex:t,summary:!!i})),l(this.box).find("#grid_"+this.name+"_focus").text(a).get(0).select(),document.execCommand("copy")}showBubble(e,t,i){var s=this.columns[t].info;if(s){let m="";var n=this.records[e],r=l(this.box).find(`${i?".w2ui-grid-summary":""} #grid_${this.name}_data_${e}_${t} .w2ui-info`);if(this.last.bubbleEl&&h.hide(this.name+"-bubble"),this.last.bubbleEl=r,null==s.fields){s.fields=[];for(let e=0;e<this.columns.length;e++){var o=this.columns[e];s.fields.push(o.field+("string"==typeof o.render?":"+o.render:""))}}let g=s.fields;if("function"==typeof g&&(g=g(n,{self:this,index:e,colIndex:t,summary:!!i})),"function"==typeof s.render)m=s.render(n,{self:this,index:e,colIndex:t,summary:!!i});else if(Array.isArray(g)){m='<table cellpadding="0" cellspacing="0">';for(let e=0;e<g.length;e++){var d=String(g[e]).split(":");if(""==d[0]||"-"==d[0]||"--"==d[0]||"---"==d[0])m+='<tr><td colspan=2><div style="border-top: '+(""==d[0]?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';else{let e=this.getColumn(d[0]),t=(e=null==e?{field:d[0],caption:d[0]}:e)?this.parseField(n,e.field):"";1<d.length&&(a.formatters[d[1]]?t=a.formatters[d[1]](t,d[2]||null,n):console.log('ERROR: w2utils.formatters["'+d[1]+'"] does not exists.')),(!0===s.showEmpty||null!=t&&""!=t)&&(null!=s.maxLength&&"string"==typeof t&&t.length>s.maxLength&&(t=t.substr(0,s.maxLength)+"..."),m+="<tr><td>"+e.text+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}}m+="</table>"}else if(a.isPlainObject(g)){for(var c in m='<table cellpadding="0" cellspacing="0">',g){var u=g[c];if(""==u||"-"==u||"--"==u||"---"==u)m+='<tr><td colspan=2><div style="border-top: '+(""==u?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';else{var p=String(u).split(":");let l=this.getColumn(p[0]),r=(l=null==l?{field:p[0],caption:p[0]}:l)?this.parseField(n,l.field):"";1<p.length&&(a.formatters[p[1]]?r=a.formatters[p[1]](r,p[2]||null,n):console.log('ERROR: w2utils.formatters["'+p[1]+'"] does not exists.')),"function"==typeof u&&(r=u(n,{self:this,index:e,colIndex:t,summary:!!i})),(!0===s.showEmpty||null!=r&&""!=r)&&(null!=s.maxLength&&"string"==typeof r&&r.length>s.maxLength&&(r=r.substr(0,s.maxLength)+"..."),m+="<tr><td>"+c+"</td><td>"+((0===r?"0":r)||"")+"</td></tr>")}}m+="</table>"}return h.show(a.extend({name:this.name+"-bubble",html:m,anchor:r.get(0),position:"top|bottom",class:"w2ui-info-bubble",style:"",hideOn:["doc-click"]},s.options??{})).hide((()=>[this.last.bubbleEl=null]))}}getCellEditable(e,t){var i=this.columns[t],s=this.records[e];if(!s||!i)return null;let l=s.w2ui?s.w2ui.editable:null;return!1===l?null:(null!=l&&!0!==l||"function"==typeof(l=0<Object.keys(i.editable??{}).length?i.editable:null)&&(i=this.getCellValue(e,t,!1),l=l.call(this,s,{self:this,value:i,index:e,colIndex:t})),l)}getCellValue(e,t,i,s){var l=this.columns[t],n=(!0!==i?this.records:this.summary)[e];let r=this.parseField(n,l.field),o="",d="",h="",c="";if(null!=n?.w2ui?.changes?.[l.field]&&(r=n.w2ui.changes[l.field]),null!=l.render&&-1!==e){if("function"==typeof l.render&&null!=n){let a;try{a=l.render.call(this,n,{self:this,value:r,index:e,colIndex:t,summary:!!i})}catch(s){throw new Error(`Render function for column "${l.field}" in grid "${this.name}": -- `+s.message)}null!=a&&"object"==typeof a&&"function"!=typeof a?(null!=a.id&&null!=a.text?r=a.text:"string"==typeof a.html?r=(a.html||"").trim():(r="",console.log("ERROR: render function should return a primitive or an object of the following structure.",{html:"",attr:"",style:"",class:"",divAttr:""})),h=a.attr??"",d=a.style??"",o=a.class??"",c=a.divAttr??""):r=String(a||"").trim()}if("object"==typeof l.render&&null!=(e=l.render[r])&&""!==e&&(r=e),"string"==typeof l.render){i=[],-1==(t=l.render.toLowerCase().indexOf(":"))?(i[0]=l.render.toLowerCase(),i[1]=""):(i[0]=l.render.toLowerCase().substr(0,t),i[1]=l.render.toLowerCase().substr(t+1));let e=a.formatters[i[0]];l.options&&!1===l.options.autoFormat&&(e=null),r="function"==typeof e?e(r,i[1],n):""}}return null==r&&(r=""),s?{value:r,attr:h,style:d,className:o,divAttr:c}:r}getFooterHTML(){return'<div>    <div class="w2ui-footer-left"></div>    <div class="w2ui-footer-right"></div>    <div class="w2ui-footer-center"></div></div>'}status(e){if(null!=e)l(this.box).find(`#grid_${this.name}_footer`).find(".w2ui-footer-left").html(e);else{let t="";if(0<(e=this.getSelection()).length&&(this.show.statusSelection&&1<e.length&&(t=String(e.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+a.settings.groupSymbol)+" "+a.lang("selected")),this.show.statusRecordID)&&1==e.length){let i=e[0];"object"==typeof i&&(i=i.recid+", "+a.lang("Column")+": "+i.column),t=a.lang("Record ID")+": "+i+" "}l(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-left").html(t)}}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),setTimeout((()=>{l(this.box).find("#grid_"+this.name+"_empty_msg").remove(),a.lock(...i)}),10)}unlock(e){setTimeout((()=>{l(this.box).find(".w2ui-message").hasClass("w2ui-closing")||a.unlock(this.box,e)}),25)}stateSave(e){var t={columns:[],show:a.clone(this.show),last:{search:this.last.search,multi:this.last.multi,logic:this.last.logic,label:this.last.label,field:this.last.field,scrollTop:this.last.vscroll.scrollTop,scrollLeft:this.last.vscroll.scrollLeft},sortData:[],searchData:[]};let i;for(let e=0;e<this.columns.length;e++){let s=this.columns[e],l={};Object.keys(this.stateColProps).forEach(((e,t)=>{this.stateColProps[e]&&(i=void 0!==s[e]?s[e]:this.colTemplate[e]||null,l[e]=i)})),t.columns.push(l)}for(let e=0;e<this.sortData.length;e++)t.sortData.push(a.clone(this.sortData[e]));for(let e=0;e<this.searchData.length;e++)t.searchData.push(a.clone(this.searchData[e]));var s=this.trigger("stateSave",{target:this.name,state:t});if(!0!==s.isCancelled)return!0!==e&&this.cacheSave("state",t),s.finish(),t}stateRestore(e){let t="object"!=typeof this.url?this.url:this.url.get;e=e||this.cache("state");var i=this.trigger("stateRestore",{target:this.name,state:e});if(!0!==i.isCancelled){if(a.isPlainObject(e)){a.extend(this.show,e.show??{}),a.extend(this.last,e.last??{});let i=this.last.vscroll.scrollTop,n=this.last.vscroll.scrollLeft;for(let t=0;t<e.columns?.length;t++){var s=e.columns[t],l=this.getColumn(s.field,!0);null!==l&&(a.extend(this.columns[l],s),t!==l)&&this.columns.splice(t,0,this.columns.splice(l,1)[0])}this.sortData.splice(0,this.sortData.length);for(let t=0;t<e.sortData?.length;t++)this.sortData.push(e.sortData[t]);this.searchData.splice(0,this.searchData.length);for(let t=0;t<e.searchData?.length;t++)this.searchData.push(e.searchData[t]);setTimeout((()=>{t||(0<this.sortData.length&&this.localSort(),0<this.searchData.length&&this.localSearch()),this.last.vscroll.scrollTop=i,this.last.vscroll.scrollLeft=n,this.refresh()}),1),console.log(`INFO (w2ui): state restored for "${this.name}"`)}return i.finish(),!0}}stateReset(){this.stateRestore(this.last.state),this.cacheSave("state",null)}parseField(e,t){if(this.nestedFields){let s="";try{s=e;var i=String(t).split(".");for(let e=0;e<i.length;e++)s=s[i[e]]}catch(e){s=""}return s}return e?e[t]:""}prepareData(){let e=this;for(let t=0;t<this.records.length;t++)!function t(i){for(let t=0;t<e.columns.length;t++){let s=e.columns[t];if(null!=i[s.field]&&"string"==typeof s.render){if(-1!=["number","int","float","money","currency","percent"].indexOf(s.render.split(":")[0])&&"number"!=typeof i[s.field]&&(i[s.field]=parseFloat(i[s.field])),-1!=["date","age"].indexOf(s.render.split(":")[0])&&!i[s.field+"_"]){let e=i[s.field];a.isInt(e)&&(e=parseInt(e)),i[s.field+"_"]=new Date(e)}if(-1!=["time"].indexOf(s.render))if(a.isTime(i[s.field])){let e=a.isTime(i[s.field],!0),t=new Date;t.setHours(e.hours,e.minutes,e.seconds||0,0),i[s.field+"_"]||(i[s.field+"_"]=t)}else{let e=i[s.field],t=(e=null!=(e=a.isInt(e)?parseInt(e):e)?new Date(e):new Date,new Date);t.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),0),i[s.field+"_"]||(i[s.field+"_"]=t)}}}if(i.w2ui?.children&&!0!==i.w2ui?.expanded)for(let e=0;e<i.w2ui.children.length;e++)t(i.w2ui.children[e])}(this.records[t])}nextCell(e,t,i){if((t+=1)>=this.columns.length)return null==(e=this.nextRow(e))?e:this.nextCell(e,-1,i);var s=this.records[e].w2ui,l=this.columns[t];return s=s&&s.colspan&&!isNaN(s.colspan[l.field])?parseInt(s.colspan[l.field]):1,null==l?null:l&&l.hidden||0===s?this.nextCell(e,t,i):!i||null!=(l=this.getCellEditable(e,t))&&-1==["checkbox","check"].indexOf(l.type)?{index:e,colIndex:t}:this.nextCell(e,t,i)}prevCell(e,t,i){if((t-=1)<0)return null==(e=this.prevRow(e))?e:this.prevCell(e,this.columns.length,i);if(t<0)return null;var s=this.records[e].w2ui,l=this.columns[t];return s=s&&s.colspan&&!isNaN(s.colspan[l.field])?parseInt(s.colspan[l.field]):1,null==l?null:l&&l.hidden||0===s?this.prevCell(e,t,i):!i||null!=(l=this.getCellEditable(e,t))&&-1==["checkbox","check"].indexOf(l.type)?{index:e,colIndex:t}:this.prevCell(e,t,i)}nextRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return this.records.length-1;if(e+i<this.records.length&&0===s.length||0<s.length&&e<s[s.length-i]){if(e+=i,0<s.length)for(;!(s.includes(e)||e>this.records.length);)e+=i;var n=this.records[e].w2ui,a=this.columns[t];l=0===(n=n&&n.colspan&&null!=a&&!isNaN(n.colspan[a.field])?parseInt(n.colspan[a.field]):1)?this.nextRow(e,t,i):e}return l}prevRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return 0;if(0<=e-i&&0===s.length||0<s.length&&e>s[0]){if(e-=i,0<s.length)for(;!(s.includes(e)||e<0);)e-=i;var n=this.records[e].w2ui,a=this.columns[t];l=0===(n=n&&n.colspan&&null!=a&&!isNaN(n.colspan[a.field])?parseInt(n.colspan[a.field]):1)?this.prevRow(e,t,i):e}return l}selectionSave(){return this.last.saved_sel=this.getSelection(),this.last.saved_sel}selectionRestore(e){var t,i=Date.now(),s=(this.last.selection={indexes:[],columns:{}},this.last.selection),l=this.last.saved_sel;if(l)for(let e=0;e<l.length;e++)a.isPlainObject(l[e])?null!=(t=this.get(l[e].recid,!0))&&(-1==s.indexes.indexOf(t)&&s.indexes.push(t),s.columns[t]||(s.columns[t]=[]),s.columns[t].push(l[e].column)):null!=(t=this.get(l[e],!0))&&s.indexes.push(t);return delete this.last.saved_sel,!0!==e&&this.refresh(),Date.now()-i}message(e){return a.message({owner:this,box:this.box,after:".w2ui-grid-header"},e)}confirm(e){return a.confirm({owner:this,box:this.box,after:".w2ui-grid-header"},e)}},window.query=l,window.EditorWindowSidebar=Et,window.EditorWindowTopMenu=Dt,window.EditorWindowStatusBar=Mt,window.EditorWindow=Ot,window.DefaultStart='\n<div style = "width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center;">\n    <div style = "display:flex;justify-content:center;align-items:center;flex-direction:column;width:70ch">\n    <h1>Welcome to the Turnroot Editor!</h1>\n    <p style = "text-align:justify">Check out the <a href = "" style = "text-decoration:none;font-weight:bold;color:var(--slider-0);">Getting Started</a> guide to get familiar with Turnroot. Choose an editor from the sidebar to dismiss this message. If this is your first time starting Turnroot or you\'ve reset your project, you must start with your Project settings.</p>\n    <small><em>If you\'re already familiar with Turnroot, you can change the default homepage in the Settings menu.</em></small>\n</div>\n</div>\n',window.editsQueue={saved_at:Date.now(),queue:[]},window.updateQueue=(e,t,i)=>{let s=window.editsQueue.queue.find((i=>i.model===e&&i.method===t));s?s.body=i:window.editsQueue.queue.push({model:e,method:t,body:i})},window.sendQueue=async()=>{let e=window.editsQueue.saved_at;if(Lt=Date.now(),Lt-e<6e4)return window.window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:Ft,text:"Saving changes"}),void setTimeout((()=>{window.window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:Rt,text:"Changes saved"})}),500);window.window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:Ft,text:"Saving changes"});let t={actions:window.editsQueue.queue},i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},s=await fetch("/queue",i).catch((e=>console.error(e)));try{let e=await s.json();if("success"===e.status){window.editsQueue.saved_at=Date.now(),window.editsQueue.queue=[],jt=Date.now();let e=jt-Lt;e<500&&setTimeout((()=>{window.window.EditorWindowStatusBar.set("status-bar-autosave-status",{icon:Rt,text:"Changes saved"})}),500-e)}return e}catch(e){return"Error: invalid response "+e}}})();